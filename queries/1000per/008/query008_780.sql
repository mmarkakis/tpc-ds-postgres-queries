
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '46880','39258','47912','89461','39548','70927',
                          '39776','71092','50708','20438','63188',
                          '82356','50421','47727','15309','24071',
                          '30979','57285','43972','62361','12657',
                          '17039','56627','92471','10512','86116',
                          '50766','75539','32142','64427','13797',
                          '34643','49668','40055','36650','35239',
                          '83295','66312','35152','60889','48995',
                          '31307','63350','75516','17137','70632',
                          '15019','29812','15742','70725','38496',
                          '64113','55553','35534','36296','64143',
                          '85337','74961','65728','76740','73981',
                          '94225','54006','64293','28481','90866',
                          '43727','50948','14060','33264','72428',
                          '77503','80296','51538','26865','45742',
                          '73609','70344','78914','43672','78352',
                          '26507','54362','69964','10416','20730',
                          '79876','30619','97924','74137','43643',
                          '67103','16136','39678','38010','91604',
                          '19406','50349','99434','86817','44735',
                          '88592','48780','20984','82231','43938',
                          '39293','27481','89517','51720','43055',
                          '97998','40826','75925','13355','97127',
                          '81064','85546','39676','79729','58391',
                          '84846','57458','21651','40885','72736',
                          '61701','86310','62490','72928','36366',
                          '67373','39572','92708','80428','51870',
                          '49100','72845','84101','27018','55496',
                          '89578','70220','52020','22030','12500',
                          '53146','55722','61460','24899','91769',
                          '80801','74099','52597','69830','78673',
                          '80111','30058','97503','39058','78086',
                          '75503','88901','69147','37967','40348',
                          '69308','27040','81371','84605','67330',
                          '75800','22548','44508','91744','33566',
                          '25388','11454','69805','75448','77047',
                          '47733','35382','81654','51147','74416',
                          '91312','79742','59256','38057','41240',
                          '40111','44128','96131','21414','92898',
                          '81847','46797','15590','10159','98660',
                          '23499','12565','27918','34420','42811',
                          '38595','43149','78007','93180','66414',
                          '71284','41762','69366','88462','57037',
                          '69517','62793','81499','14943','25321',
                          '85040','42007','55064','58246','19136',
                          '33096','19262','38788','16874','95199',
                          '95723','81028','28892','90666','68140',
                          '20243','34928','59395','96142','82800',
                          '97454','87726','53243','46345','75690',
                          '53812','88881','74448','65954','60993',
                          '27555','46713','70913','62767','55207',
                          '46162','41865','38619','46175','80990',
                          '46226','64231','45226','40069','30658',
                          '26567','21520','84056','13821','79736',
                          '22433','36176','49059','72469','77205',
                          '26323','17991','45230','55738','93645',
                          '55405','18538','28161','37204','48698',
                          '77894','16776','70840','43465','93609',
                          '75297','98578','37660','64363','86093',
                          '37734','64312','55873','48160','42019',
                          '74774','54822','98473','15876','98435',
                          '80726','92692','82620','43850','46363',
                          '31690','36281','79506','97527','46826',
                          '89370','92670','28280','39405','97349',
                          '55111','31906','17788','80501','85946',
                          '65810','93021','62516','55666','84591',
                          '57230','64174','77427','68283','71541',
                          '46007','84020','50340','25297','79467',
                          '56828','19831','11007','95098','59381',
                          '76174','31189','26078','53236','37988',
                          '32424','58629','60649','56857','83003',
                          '75866','74463','91718','47505','40480',
                          '83703','37172','72460','40963','94891',
                          '15106','37095','23114','49921','68550',
                          '20641','13820','92689','77759','71773',
                          '80335','49782','81912','65825','34570',
                          '25608','77927','18747','50966','97308',
                          '38902','95090','49039','28897','24707',
                          '21179','11554','37359','41231','79429',
                          '64366','85549','64253','81720')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


