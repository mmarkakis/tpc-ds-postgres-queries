
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '46183','84911','24782','37076','31819','57084',
                          '27748','86933','51724','85692','59065',
                          '17038','54853','59370','54493','91151',
                          '64807','17051','59627','22047','99545',
                          '33745','15178','77581','12693','65323',
                          '77137','33810','18024','31255','86484',
                          '72457','64761','98288','88896','14101',
                          '93471','80668','99322','10827','57028',
                          '82001','32571','69633','33822','94132',
                          '64852','38322','99144','74674','49648',
                          '37371','24257','44826','38246','37137',
                          '81428','90245','52003','79886','45340',
                          '87949','37902','93452','24856','37593',
                          '22738','21961','75610','63754','37705',
                          '94338','65714','61536','14058','59306',
                          '30121','18253','62250','66552','49532',
                          '55931','36635','56622','97797','82416',
                          '47625','71989','29426','48229','37141',
                          '30209','91127','10220','58974','63111',
                          '46761','71930','65686','46803','31983',
                          '84195','60839','30964','48715','70820',
                          '61683','11343','13613','37081','46051',
                          '49023','31177','73425','56471','90276',
                          '51212','13851','24724','14726','49281',
                          '77496','19334','88768','86710','19232',
                          '14323','43060','98195','97883','79525',
                          '56254','48855','65515','60983','99149',
                          '26147','55362','14093','55674','57314',
                          '71913','46396','56920','48014','15023',
                          '23655','57987','79557','60931','32746',
                          '62007','12468','76323','31544','34981',
                          '36823','61477','29916','37472','11507',
                          '79048','34005','41055','46152','73115',
                          '40682','20158','28686','10183','72641',
                          '98843','62880','28803','74193','87508',
                          '32258','41276','50808','61740','16646',
                          '76715','41085','66572','12032','11911',
                          '10761','30769','50320','51150','40008',
                          '29853','84188','36223','66657','48727',
                          '10032','68536','59659','31795','51056',
                          '67420','32269','73846','58514','88859',
                          '77870','41313','91567','98099','74109',
                          '64412','92478','85486','38936','51379',
                          '45249','17229','57699','72639','44708',
                          '81543','76363','32245','11039','11293',
                          '98572','85095','87339','65769','49640',
                          '94403','56418','12398','56960','79633',
                          '16705','67990','34746','52137','90594',
                          '66461','27230','14649','35762','16471',
                          '90211','37359','92555','80040','66979',
                          '43918','65861','86797','96418','69948',
                          '45897','26378','80039','50001','23340',
                          '16086','31491','48437','95807','15854',
                          '36513','40790','64042','15306','59704',
                          '59725','22893','12530','42695','71373',
                          '49090','74694','27382','48033','34465',
                          '62303','96608','71230','22549','34587',
                          '68612','49475','21890','39645','55198',
                          '81779','78332','94845','82139','93719',
                          '55586','74961','93623','45792','55377',
                          '45574','78814','78435','36047','98124',
                          '57870','54344','68627','29056','15418',
                          '11295','15919','42648','19715','85351',
                          '48758','64638','24389','78291','20205',
                          '99350','58787','93686','27381','81342',
                          '22200','24078','49736','72224','82053',
                          '98272','77355','11046','53348','91271',
                          '43769','35609','64525','40033','96577',
                          '83558','79412','84518','24129','59866',
                          '61388','12058','59015','64673','54428',
                          '14028','33422','32748','19149','94528',
                          '25532','73908','51642','60155','35686',
                          '15874','36412','94700','67695','55430',
                          '56001','61998','73732','12340','60472',
                          '69132','70694','10735','48812','28857',
                          '55783','28626','14330','87384','28925',
                          '64441','77970','91771','54884','42284',
                          '51746','60685','43821','67831','25359',
                          '16359','44380','23476','10040','18406',
                          '37503','16603','70690','75843')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


