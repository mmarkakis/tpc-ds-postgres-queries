
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '55285','63056','52173','86530','70122','13194',
                          '98401','45489','36750','71118','31229',
                          '72431','82145','94940','52600','13730',
                          '26620','79655','49299','24951','48182',
                          '87831','71981','94676','35021','20622',
                          '81413','30479','18463','53836','47475',
                          '61396','56743','92960','56502','17786',
                          '46033','53435','35568','22689','32928',
                          '19700','20059','64296','34502','60471',
                          '38796','26719','64374','36996','35895',
                          '79543','22587','70265','98670','56756',
                          '43965','11359','93436','75610','95628',
                          '31272','49647','83725','77287','34357',
                          '30387','48436','43452','83179','68759',
                          '28868','78144','59057','84251','96149',
                          '21727','83998','70180','95611','82064',
                          '26145','59085','51536','37590','12525',
                          '73262','60888','85096','74579','98868',
                          '25351','26014','37171','16944','19187',
                          '57691','67372','70506','14063','26134',
                          '35234','65546','74664','14278','92638',
                          '99219','71260','26396','31563','25207',
                          '17165','72237','90648','38772','84594',
                          '40132','92489','63803','98509','56367',
                          '49423','24426','24135','94271','51725',
                          '10369','30668','55117','95650','78805',
                          '86038','45585','32521','72200','22073',
                          '68955','73920','87085','73366','87972',
                          '19379','31377','19531','42807','89595',
                          '85161','17005','87424','47930','65469',
                          '34223','64504','33622','98823','12513',
                          '40532','50500','63846','29855','19591',
                          '89228','87511','58352','77929','42323',
                          '26405','75472','26269','99352','92724',
                          '70234','37784','46961','25247','81584',
                          '92597','55192','80100','31385','14508',
                          '68990','21484','34192','56182','70389',
                          '80790','36748','78559','43751','56941',
                          '82369','82244','56279','95060','39145',
                          '93224','26725','59523','13786','20967',
                          '95877','13597','70714','20510','65027',
                          '83227','44572','84407','77444','29129',
                          '51663','50495','93382','92149','85291',
                          '28542','65255','68868','72145','31689',
                          '36850','76188','21274','79903','20683',
                          '57880','83505','36530','34634','47829',
                          '90592','93392','34766','67763','36676',
                          '93863','94806','30769','60333','95823',
                          '63093','60959','41260','89543','45671',
                          '93886','82333','89077','70162','41620',
                          '17875','17612','63101','95237','48461',
                          '45306','37983','63900','58675','34429',
                          '24198','87913','51682','86929','57396',
                          '88886','77376','40515','22979','95991',
                          '76286','96364','41172','53977','89278',
                          '87182','47825','86184','93840','27283',
                          '28085','85721','80841','35444','57318',
                          '16496','74900','54137','71137','84386',
                          '93267','19602','71722','42388','75321',
                          '10393','37812','36627','64216','80831',
                          '15102','79233','40703','58243','22476',
                          '86954','54717','45408','28011','39343',
                          '56498','60405','57309','33511','63561',
                          '70554','76356','55449','98483','46130',
                          '74660','46430','42103','35664','39602',
                          '27297','30395','19109','35632','15850',
                          '60411','11580','51189','12254','73251',
                          '64092','82657','25728','94959','91070',
                          '91371','11559','16739','26561','63064',
                          '92533','93334','73249','92426','57758',
                          '14236','60075','21809','89068','26838',
                          '46692','77233','21754','64009','11785',
                          '71181','14779','97687','46245','33770',
                          '48287','22834','90253','80827','94776',
                          '58527','94072','81317','28721','27149',
                          '68887','37543','83818','66380','52633',
                          '64424','57345','52935','66574','80791',
                          '30304','79704','49555','83322','22402',
                          '76510','57353','40694','78723','47209',
                          '96713','48870','20333','32588')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


