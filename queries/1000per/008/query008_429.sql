
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '36310','10783','64408','64902','11020','20388',
                          '72311','86789','15286','97958','54071',
                          '94796','79065','12788','86958','81150',
                          '30770','71319','79035','64523','85282',
                          '93090','14526','81011','41261','40844',
                          '85551','84475','62447','78822','47305',
                          '77572','19641','32541','62121','18378',
                          '25481','73081','31258','82258','82636',
                          '17268','18241','39318','30188','94678',
                          '64975','57195','22134','79199','32629',
                          '77462','81111','18168','63462','55770',
                          '68121','34948','80955','56900','23999',
                          '62423','13675','95801','22625','72781',
                          '51802','67094','80077','20334','26771',
                          '69760','23309','47167','25295','65241',
                          '54590','29486','87742','38489','49634',
                          '82687','97441','71899','93280','14461',
                          '68105','31172','37056','63909','85828',
                          '27329','38023','42966','47131','75105',
                          '38574','87140','81508','88478','43427',
                          '57126','95363','79391','91914','13519',
                          '82700','73960','65274','75624','84489',
                          '11311','25436','95995','74678','68614',
                          '23019','56903','47237','94354','40152',
                          '58455','61155','24585','17222','53551',
                          '78798','83050','60901','48320','87483',
                          '90596','78741','88061','51659','14754',
                          '40067','52716','69201','79033','33194',
                          '33968','55227','34686','21293','67762',
                          '69158','48099','41033','53749','45317',
                          '18657','77647','37477','71333','96900',
                          '67984','76230','24073','23436','62369',
                          '90604','79861','61856','88891','46116',
                          '66975','91358','40795','15288','39958',
                          '19968','55891','80824','84534','11756',
                          '18588','98150','89927','32797','10668',
                          '86065','31507','46552','88652','27030',
                          '29577','63626','30492','91595','93442',
                          '68497','36824','46604','52520','38446',
                          '97247','12307','62398','95342','30918',
                          '51880','39380','46516','38449','68874',
                          '50526','72680','23512','41086','79092',
                          '92577','31760','88692','25171','34160',
                          '48602','84733','69520','74425','83497',
                          '64220','82089','29594','73915','37584',
                          '17814','95002','39917','89491','60294',
                          '33474','34653','32000','18502','17782',
                          '83889','99758','37543','48648','60138',
                          '89220','27942','79255','46946','36680',
                          '84257','31843','16591','66787','40693',
                          '55316','91552','19795','38829','67948',
                          '77994','96877','80290','28573','55193',
                          '88338','43022','30940','35466','41187',
                          '37251','17078','37003','54408','50189',
                          '92771','38363','56024','73503','40944',
                          '47399','60603','64607','99536','70811',
                          '53379','11093','67768','27532','59939',
                          '87473','41390','62907','90610','95631',
                          '87390','91894','22029','50018','17365',
                          '66681','38141','81742','39203','61922',
                          '72589','95439','17568','15439','62750',
                          '81429','82005','10693','56831','10494',
                          '22547','53933','26187','81305','35403',
                          '56563','50630','33740','53237','95488',
                          '20737','15199','95199','64873','66340',
                          '51356','96505','57473','60324','88100',
                          '15712','39232','34108','34219','57854',
                          '66724','57378','80601','69509','95360',
                          '98735','65850','33486','22093','42083',
                          '66703','66936','36108','78316','39189',
                          '20717','26387','96139','93536','99199',
                          '48127','32250','48580','33404','20751',
                          '12140','54564','35415','49562','92194',
                          '34922','73438','47310','34206','65395',
                          '58537','46444','41753','48634','57653',
                          '51922','13261','87341','40777','98845',
                          '55390','34051','41226','71719','43573',
                          '20661','32404','14151','67468','29611',
                          '96101','15667','43155','68783','93463',
                          '48022','85255','94755','23384')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


