
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '97524','61199','40093','74652','71926','65878',
                          '72174','80068','74590','19021','90090',
                          '85650','25634','10316','51314','24085',
                          '82513','47722','88823','79836','48663',
                          '57467','62024','18195','88477','55256',
                          '68788','91046','24346','76988','64183',
                          '72883','61709','62669','99259','66741',
                          '15000','15520','38843','84038','78830',
                          '67410','81356','14695','82616','91612',
                          '78686','55799','24260','96260','71504',
                          '50101','46060','78593','33744','29546',
                          '63628','56017','14837','65821','37750',
                          '39073','62685','59058','62051','27951',
                          '18279','92569','37411','57394','34450',
                          '24953','60875','31369','51401','24786',
                          '62169','17198','40150','51285','81445',
                          '73752','24226','61595','58749','22163',
                          '49047','27519','19412','72586','58183',
                          '37804','16155','64339','68975','95054',
                          '26180','93766','49747','84275','71219',
                          '46362','45798','18559','22426','53692',
                          '24763','40968','79245','16664','48930',
                          '84442','10876','85060','93417','89275',
                          '24232','33250','40383','52370','26360',
                          '60416','85214','31252','46796','79054',
                          '84873','72605','66511','42076','84800',
                          '43969','61664','42657','83607','64455',
                          '25275','96150','86266','27674','14854',
                          '28538','11051','21796','37116','11515',
                          '68843','65633','78788','79627','34090',
                          '63208','39516','67501','92532','59977',
                          '24026','71263','48829','31769','36715',
                          '21393','68451','43416','96815','36881',
                          '69248','52740','72631','70488','55003',
                          '15984','30143','89528','73695','56474',
                          '31725','62547','40610','18441','15515',
                          '39097','88984','22089','37504','44194',
                          '98656','27089','56971','40397','30098',
                          '28078','68198','27620','20653','32579',
                          '15669','17923','76026','58953','12179',
                          '96286','18715','73672','70173','65996',
                          '68147','37476','19470','82102','99147',
                          '14914','47531','75838','24889','92090',
                          '32815','83836','12769','78469','98427',
                          '16109','35342','84646','30696','63136',
                          '92117','84137','46267','37478','22941',
                          '49153','30856','48951','24671','89267',
                          '79606','96958','76893','21346','75691',
                          '43382','33047','63964','97307','16497',
                          '42544','82161','41630','46360','72735',
                          '25237','23199','94172','48158','86955',
                          '53018','38403','78442','91381','69920',
                          '73274','11020','12485','72995','39479',
                          '25929','20446','62828','61249','97092',
                          '30195','93804','81500','99085','97329',
                          '33259','90828','95494','71401','62059',
                          '59992','49001','47975','55907','46009',
                          '27081','34119','20608','16700','61445',
                          '11092','20293','17618','85202','69049',
                          '16270','13091','97229','26961','60658',
                          '79047','96077','40228','97545','89593',
                          '22149','39989','50020','95604','13893',
                          '71587','98221','59114','91627','95006',
                          '62456','60216','84299','62221','48443',
                          '96271','37643','23151','29502','60233',
                          '13855','70845','61170','63918','66725',
                          '24555','44647','43814','80116','36399',
                          '14426','68911','84011','71544','15690',
                          '16883','92783','30875','73958','73196',
                          '29550','22837','11167','59634','17895',
                          '18774','59823','62886','17208','53459',
                          '51914','89963','47864','63262','30080',
                          '51158','59525','88937','75522','53179',
                          '11402','73563','30632','75732','38428',
                          '76455','98967','11185','77028','20137',
                          '72293','86090','18608','63804','34341',
                          '55405','23283','97002','85329','34462',
                          '98694','88065','56933','39065','53578',
                          '64228','47325','94730','82431','87877',
                          '87090','54094','12091','71213')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


