
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '92057','80361','59746','61516','57741','33254',
                          '79619','71521','41065','79590','78925',
                          '56545','32547','85428','13853','15330',
                          '77935','34934','54382','76248','34774',
                          '38618','54798','47892','26726','76143',
                          '10517','34045','13936','99817','21268',
                          '20957','15566','61006','21047','50870',
                          '39102','91831','84083','52693','77329',
                          '18394','68597','88100','20432','67275',
                          '77293','57703','50359','22996','67584',
                          '20134','74844','94491','64937','83412',
                          '95965','15207','64957','53120','67814',
                          '52176','45080','90659','29148','39804',
                          '51211','97836','71086','23953','68361',
                          '12038','30654','54221','72621','41052',
                          '63218','15567','61760','75473','51390',
                          '32623','40604','50836','82149','35651',
                          '58903','81784','26114','99617','80758',
                          '70752','19721','17025','91446','79394',
                          '63515','70488','84559','93362','17374',
                          '46610','78005','27503','44810','91352',
                          '39024','67120','56747','49500','56364',
                          '73605','91977','36555','68151','53698',
                          '84720','71019','91292','28522','11580',
                          '89531','66955','58675','33022','22427',
                          '48187','49136','18715','20108','49537',
                          '35110','66512','16040','26223','67511',
                          '36130','27572','92558','23309','36021',
                          '22032','52097','27265','52690','46514',
                          '58393','31306','98896','75266','40458',
                          '46914','83876','19244','95552','11730',
                          '74566','93402','25307','36601','98603',
                          '12592','92769','12821','93129','18007',
                          '42929','74660','71562','78801','63790',
                          '83800','79814','83476','90251','22955',
                          '61512','46058','51364','93330','65005',
                          '64490','26776','67700','22879','68941',
                          '74986','11582','57809','44111','50751',
                          '61353','59163','36138','79599','88254',
                          '12392','25921','65985','20164','75925',
                          '98913','25191','20200','56909','55282',
                          '63467','38998','20370','41466','80071',
                          '18105','28897','61661','64934','68539',
                          '68138','72819','96404','60093','82214',
                          '80112','70643','37882','34424','73550',
                          '26448','97715','82928','37499','72263',
                          '95132','89096','34969','23784','37523',
                          '87023','92412','80421','88635','29835',
                          '87762','19976','57952','63875','65239',
                          '72129','25030','51092','10341','68733',
                          '28086','43110','39130','89183','53367',
                          '99469','53047','32115','20213','30968',
                          '63886','24467','28901','90382','32942',
                          '58735','25044','82272','23087','60902',
                          '83243','47249','21943','93193','83345',
                          '53286','74589','63816','76831','63649',
                          '82932','96100','10374','92800','96875',
                          '41899','97942','46019','16240','18921',
                          '93318','43675','51779','83283','98377',
                          '25337','88381','31836','26598','47005',
                          '63319','47902','59110','92477','51942',
                          '90323','24799','30866','43974','88108',
                          '32237','90828','35008','63244','42831',
                          '75521','25275','10732','48379','48723',
                          '15252','82206','81738','64826','77353',
                          '82530','53353','58492','12822','93725',
                          '23063','41165','99851','94373','64308',
                          '36240','80425','60479','30520','64280',
                          '74612','78108','18178','60742','89671',
                          '21923','77442','44014','20210','76320',
                          '59898','89450','89310','26952','20452',
                          '98412','42655','43133','28892','28983',
                          '59270','20895','77472','42433','47792',
                          '16733','61172','30333','15278','98844',
                          '17191','29465','89449','76592','59032',
                          '52249','23302','73449','65384','53006',
                          '15605','50515','63880','39794','95081',
                          '95193','24372','35594','95160','13731',
                          '21958','35547','33740','78198','54012',
                          '48075','64119','89400','42757')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


