
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '37735','31949','94180','59458','38163','33091',
                          '58684','42088','91582','48449','21836',
                          '44656','13669','94151','46660','20166',
                          '51608','91442','31042','91415','40100',
                          '79354','73358','28757','21511','39481',
                          '95902','60825','79275','34921','68042',
                          '28957','86263','64838','71853','92040',
                          '13577','91561','75438','68547','37832',
                          '22118','94423','50827','53462','27113',
                          '57060','84248','90379','95848','79743',
                          '97261','84458','85621','71514','36154',
                          '91312','63754','19130','10285','49692',
                          '62219','80512','90350','73430','82127',
                          '14636','48814','53371','23869','21599',
                          '80641','27638','15837','38756','60011',
                          '57428','75871','50152','99413','84612',
                          '42875','78360','53143','77640','82381',
                          '77964','71497','99879','48437','36346',
                          '23212','43611','53239','96746','12026',
                          '42537','30029','83199','93694','97676',
                          '99873','68863','70139','49763','11214',
                          '86566','94782','33337','20464','10315',
                          '95221','87001','14213','76910','38732',
                          '13615','78585','58331','90814','27755',
                          '24102','80308','20583','23256','76018',
                          '21662','51605','50273','55135','87444',
                          '97082','97146','80647','68049','21786',
                          '11980','37833','34361','30802','56945',
                          '82799','44749','27923','22985','19796',
                          '24799','90576','95406','11780','95756',
                          '73578','21437','81951','81619','43445',
                          '42678','87905','49968','55335','12163',
                          '23722','77795','17185','82962','61903',
                          '47917','73044','20600','47317','92867',
                          '77007','73403','34901','64677','65037',
                          '10276','56684','40552','63696','95353',
                          '98881','33857','36636','92141','50065',
                          '18641','16334','80855','67369','10991',
                          '97546','41361','15236','61237','32005',
                          '67559','54112','35852','64823','54494',
                          '44034','64303','42634','19649','27897',
                          '11760','31074','93118','42387','43917',
                          '92615','82414','52075','63488','56819',
                          '15754','53115','31136','86669','22561',
                          '55750','86932','93538','53517','85013',
                          '86610','51861','58810','11708','75058',
                          '19027','14149','43551','41991','23836',
                          '60491','97387','12291','99830','40825',
                          '62506','11514','55282','81931','56471',
                          '41479','24977','20125','74292','58853',
                          '31906','32955','69659','95701','17003',
                          '93543','70559','42237','35778','63091',
                          '19214','47272','65020','36209','94335',
                          '91506','94527','74514','20457','18919',
                          '40702','24257','72281','21685','38433',
                          '83533','67296','23973','37791','65579',
                          '65518','82392','96686','85788','91623',
                          '14783','10651','97854','80856','95422',
                          '46337','89486','70165','38983','41793',
                          '49413','70407','55277','86779','13561',
                          '12134','49992','52606','17938','16517',
                          '39020','17603','56956','34789','34272',
                          '48178','53787','69119','43575','47714',
                          '17556','60590','36674','79450','18886',
                          '18743','52384','54772','89000','44391',
                          '97099','19041','48722','14977','64819',
                          '67313','41670','30119','55528','64433',
                          '20578','35782','22457','70402','34850',
                          '61310','70099','71395','73090','10983',
                          '52459','38249','94060','40419','82488',
                          '89358','75691','98363','38605','12021',
                          '31461','50177','39265','64531','19096',
                          '63815','49493','78986','71430','64633',
                          '48793','92059','68686','84158','49950',
                          '85926','89032','74417','61108','90158',
                          '34078','56192','46837','60057','80081',
                          '13095','25520','74214','56842','68979',
                          '16988','88464','46003','14897','98558',
                          '44904','96962','11058','70318','71390',
                          '98119','47684','82818','39856')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


