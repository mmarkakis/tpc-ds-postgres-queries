
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '62552','67694','31041','53813','80207','93334',
                          '37903','35165','98237','69432','29441',
                          '96038','15357','75761','98872','58983',
                          '86560','20290','74045','35026','88662',
                          '58239','15339','86596','25997','14876',
                          '21210','44377','10460','34242','68157',
                          '20819','61448','23924','12706','13234',
                          '65738','40583','66401','43914','22764',
                          '54930','37651','81462','12147','32760',
                          '53706','84002','20285','45778','24580',
                          '14305','55258','71532','37100','66733',
                          '39881','75868','22758','79043','14644',
                          '25226','83218','66707','84935','94008',
                          '87639','91962','24630','22838','37164',
                          '30376','79197','82838','31576','33332',
                          '51625','91681','98566','30291','41165',
                          '49357','45694','79249','76162','45798',
                          '49782','25720','55246','60988','38583',
                          '67261','88824','25635','99952','11203',
                          '70396','33711','38327','75140','90106',
                          '89290','29477','32460','75478','94745',
                          '17426','70874','13631','62101','41189',
                          '66905','30599','18563','28746','15913',
                          '37507','60799','57014','36091','90753',
                          '12000','41143','37594','89760','73544',
                          '83535','22977','88371','62790','61782',
                          '61660','53621','65941','41544','56455',
                          '23357','13426','77078','48606','27676',
                          '14010','60708','73996','30353','90031',
                          '86213','91617','31422','30269','26465',
                          '95897','13797','63257','26108','27649',
                          '10333','75727','94004','98635','33950',
                          '96959','79929','64486','68038','43102',
                          '21820','45230','52197','21948','86166',
                          '66244','34701','98605','94022','70310',
                          '35144','48090','85762','69002','87160',
                          '50693','69530','68472','35656','95751',
                          '50900','73894','68227','12921','84094',
                          '68430','19451','24114','48236','69697',
                          '16660','74779','13717','25123','69467',
                          '39125','85419','57636','74504','84253',
                          '55457','49138','47654','10452','38385',
                          '77739','41631','36775','22976','70030',
                          '84809','27060','50094','98973','70021',
                          '51260','53008','33190','41636','71233',
                          '99495','66459','72070','53880','78824',
                          '38671','76184','22669','98788','42748',
                          '24319','24966','56123','21215','24163',
                          '95077','51276','91544','64930','51770',
                          '92391','47451','92761','61806','19626',
                          '43766','58494','70317','88062','97692',
                          '59369','88894','74194','82204','35248',
                          '15801','95914','61104','71523','63897',
                          '97340','23202','88433','47010','36799',
                          '70236','54340','33132','92108','39878',
                          '71461','53872','67356','69673','15451',
                          '90055','98131','14742','53995','79881',
                          '65992','76737','15314','86259','72667',
                          '77053','80283','27926','23892','62726',
                          '76502','21852','39559','43844','14277',
                          '37565','97008','52999','57035','72838',
                          '68628','75414','73302','64321','89619',
                          '12316','60167','16200','36302','61403',
                          '41582','71573','90023','69965','78969',
                          '68353','71395','72607','81571','66868',
                          '43566','65113','70977','49972','36577',
                          '13258','85144','99932','67182','31326',
                          '51919','93294','24064','29828','58789',
                          '97865','20924','16040','38229','32349',
                          '29814','43201','49926','25152','19575',
                          '11560','47053','86029','84640','85003',
                          '42028','55809','56239','45557','56661',
                          '24328','10205','58152','63550','27866',
                          '27172','56082','79137','36964','29128',
                          '49614','27844','70604','46929','35657',
                          '87829','86793','40010','68289','12621',
                          '33787','63283','71052','58923','92397',
                          '82320','45402','70240','64906','86718',
                          '53219','86820','19574','13870','29625',
                          '53885','38700','26608','14625')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


