
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '62805','13578','17825','98683','40328','13208',
                          '89625','11951','94297','31569','88819',
                          '74549','16189','36222','37813','27380',
                          '33427','85313','29946','97530','16611',
                          '29174','30584','53506','72754','45145',
                          '94260','19708','31514','23914','64660',
                          '54198','99913','11008','84663','59341',
                          '44567','31826','50353','64499','64302',
                          '60284','93321','84824','68176','23955',
                          '28944','81173','90421','63094','70232',
                          '85944','21626','11950','67677','62671',
                          '55867','69650','24990','97119','84707',
                          '29738','93880','50706','86754','10768',
                          '17166','15521','16841','50265','71885',
                          '49887','16260','89446','89028','93033',
                          '83171','78005','58580','70972','34745',
                          '84471','60795','24513','30527','42372',
                          '77181','71318','79356','80759','94781',
                          '91872','30388','93282','83206','79817',
                          '92982','71454','52559','27683','38119',
                          '47523','11544','43993','89913','20636',
                          '57412','79573','11832','39641','84463',
                          '18843','46069','64728','87403','16533',
                          '58941','42755','61991','29124','97599',
                          '53476','72401','66778','84865','30272',
                          '94193','27206','72359','72501','11798',
                          '18989','12277','68196','59310','26096',
                          '41000','22551','37586','73869','50485',
                          '18533','40029','91102','52682','59460',
                          '47661','44727','96196','34484','83976',
                          '29107','61456','67583','16872','18047',
                          '87521','82769','51130','57438','49537',
                          '77433','23259','81708','77850','72389',
                          '16404','71330','45240','31871','35930',
                          '39090','65533','45095','22371','55309',
                          '66029','79790','73584','68036','74864',
                          '80164','20106','24002','63589','63013',
                          '36544','41159','64701','10164','83884',
                          '63149','59041','46156','51931','98192',
                          '34695','51426','33415','54439','39572',
                          '97262','24667','37297','68649','79160',
                          '93965','19855','26006','42758','95687',
                          '13929','11419','19125','80875','41419',
                          '36413','19514','65923','79061','38456',
                          '89314','79231','60209','82035','94024',
                          '16282','96706','57193','76014','15669',
                          '66907','36848','69946','98443','15160',
                          '75204','30317','37236','28093','16423',
                          '77265','19174','33938','54108','84196',
                          '41522','22939','75527','30420','24325',
                          '80774','99533','98499','39542','69733',
                          '67136','36049','22719','32974','25971',
                          '65004','91579','25139','47768','43829',
                          '16941','99087','58550','52156','91697',
                          '81480','59490','63387','77660','37892',
                          '77107','99314','77801','34853','52257',
                          '91880','73191','40775','45792','61488',
                          '24288','54969','57829','45411','43100',
                          '67024','65766','96070','90117','43184',
                          '21177','27346','70225','88882','45053',
                          '68512','11190','26859','98331','61634',
                          '12596','22340','53354','90010','49278',
                          '42843','84534','15415','52575','52321',
                          '84682','22227','36238','41627','82706',
                          '10910','80625','71727','20229','23466',
                          '85459','39698','14200','80874','99107',
                          '45261','69883','17281','22188','66724',
                          '49694','75952','60666','92493','57819',
                          '54683','71369','66536','78595','97806',
                          '50797','67476','24170','55743','10154',
                          '89817','78506','28651','96265','28762',
                          '76484','29629','90231','16147','12221',
                          '26332','27772','23800','77926','85343',
                          '71376','81825','87346','42090','27064',
                          '56516','50548','96448','36138','38367',
                          '63632','20142','70086','73069','14426',
                          '63263','86542','76173','11434','55640',
                          '94286','51017','17577','91097','11144',
                          '38444','25327','63953','79305','68517',
                          '92581','32576','19445','25739')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


