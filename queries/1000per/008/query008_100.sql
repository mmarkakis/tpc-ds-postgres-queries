
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '99753','36212','58670','50163','53584','16256',
                          '46732','70239','22209','66309','10750',
                          '58646','12318','16066','45862','87829',
                          '16364','44926','29197','41986','94896',
                          '87085','81747','25944','10420','83311',
                          '52223','78497','60379','31898','70573',
                          '46964','15972','20373','81461','30104',
                          '96499','57151','53941','99007','77961',
                          '19679','76376','34420','62745','69278',
                          '49419','20828','52909','13520','63282',
                          '28761','32591','55876','15566','52116',
                          '35416','70845','98458','87065','30992',
                          '57028','53984','87608','38695','52934',
                          '29471','54053','19672','76640','63985',
                          '79406','72942','24089','87971','48571',
                          '86251','68943','23281','80250','97844',
                          '93332','74612','66010','87657','65351',
                          '36707','33031','73985','77223','53847',
                          '55297','15576','77524','19926','13679',
                          '28054','74186','33693','43350','58308',
                          '51184','57339','82875','60514','43050',
                          '36207','41309','27796','63196','52965',
                          '96004','15657','58009','28907','16666',
                          '99742','97139','16113','75214','35923',
                          '58362','34399','56914','92220','29986',
                          '77820','23191','49245','66994','18372',
                          '48675','35993','36272','73462','40100',
                          '42605','94160','57815','83882','64844',
                          '22699','77642','10815','57695','86742',
                          '29923','75287','92243','79817','21252',
                          '61437','14958','91867','87001','83781',
                          '42820','68629','49900','53777','31731',
                          '89760','45589','24645','74411','38135',
                          '48332','30313','39805','85205','63974',
                          '74866','68276','84371','86510','17427',
                          '26489','54630','97111','32137','70589',
                          '52331','12111','74604','60334','78245',
                          '60637','30422','58013','57575','61908',
                          '61662','20925','65472','38168','70626',
                          '98015','51180','32119','81382','88933',
                          '26122','90296','13314','19643','11553',
                          '65753','52797','17471','32050','92343',
                          '87382','60442','20770','93263','33306',
                          '31308','25970','25982','98097','57338',
                          '70068','96460','92873','88681','70365',
                          '36574','19309','84418','90900','18583',
                          '77294','12834','60102','71731','82447',
                          '72742','72506','35072','99719','72216',
                          '37465','27109','57584','36268','49947',
                          '39257','90943','71804','18900','26143',
                          '84032','67540','61520','29283','69212',
                          '51771','93586','11156','99614','47864',
                          '92023','34625','59087','65917','47324',
                          '57983','72519','91747','71346','35840',
                          '12259','51091','98272','84890','18107',
                          '43144','87493','74129','40091','31322',
                          '37317','96679','48247','86367','18967',
                          '65744','82041','63419','32419','37882',
                          '23727','45736','35931','55682','77043',
                          '15876','85306','65500','50158','37446',
                          '13774','53687','69581','80662','33303',
                          '71268','28322','89318','65909','94569',
                          '89736','36244','38583','86794','28892',
                          '98122','27512','31010','44768','43555',
                          '98459','69248','22288','50204','31149',
                          '79134','53318','15152','53905','27543',
                          '35930','64145','40116','28611','88817',
                          '15601','89864','40693','99224','54349',
                          '61328','12162','21079','30959','97557',
                          '40684','45752','93431','32402','92708',
                          '23603','73685','67715','11132','30339',
                          '72386','84728','64077','63331','54139',
                          '34833','21884','27601','80808','20431',
                          '91531','35806','22023','69750','12617',
                          '92079','29476','24968','77239','74986',
                          '19007','52944','20917','95613','27711',
                          '79910','83143','93950','60255','96010',
                          '68856','14668','22296','75111','26488',
                          '88939','35969','34344','37490','23382',
                          '84537','82959','27443','57785')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


