
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '16381','32989','17110','73856','61038','71366',
                          '49170','28575','41791','39833','28724',
                          '81761','88605','78030','83095','86877',
                          '83261','73288','86119','25696','53480',
                          '94736','95878','85927','56536','50327',
                          '66203','71093','80097','58451','38908',
                          '85875','99670','25611','53145','39916',
                          '13776','35602','26429','17440','75951',
                          '30084','73456','54830','56800','63876',
                          '42532','75196','43964','58099','44487',
                          '69617','26142','68540','36267','95548',
                          '36067','32185','21828','68640','75907',
                          '28559','34825','74335','46823','16884',
                          '18458','77818','10200','72019','78325',
                          '97450','52391','97452','10948','16895',
                          '25794','83950','47158','26950','60332',
                          '93128','19481','85616','60343','80010',
                          '48704','46693','37000','42851','20980',
                          '21346','85205','55708','97670','87146',
                          '91587','77243','80761','98256','61610',
                          '28138','68790','99123','70767','59925',
                          '55421','23273','31087','53028','27201',
                          '85145','53950','11997','30482','10734',
                          '38113','61853','33867','94442','27210',
                          '90813','75176','31949','76497','83828',
                          '55984','22974','85784','71237','25605',
                          '29668','72025','98473','78156','11478',
                          '64975','98145','53749','27251','41154',
                          '16514','77878','70479','59732','55265',
                          '63436','26905','19948','54653','48010',
                          '94865','69950','65195','17585','87073',
                          '35293','53185','70955','38720','58754',
                          '21678','83118','15966','91319','21106',
                          '42917','82749','82261','83221','39977',
                          '46538','64969','10441','41040','73686',
                          '37956','68261','71669','87126','59399',
                          '18063','40954','39847','30116','12102',
                          '23274','29161','79392','48455','94699',
                          '48017','29322','78674','79773','38370',
                          '44396','27599','75649','37844','11928',
                          '18124','86469','76953','54679','55595',
                          '34971','52866','98736','83764','60628',
                          '19363','56569','90141','61126','51143',
                          '17609','33257','87346','85688','84828',
                          '27945','41582','91757','87227','14915',
                          '19321','49481','11941','64915','19331',
                          '42611','90782','92513','90035','93664',
                          '57527','30854','50817','72467','33625',
                          '48116','16686','76715','97252','86234',
                          '35739','67184','58311','61266','71813',
                          '23883','57325','20109','48419','32862',
                          '24350','90371','78924','44323','82260',
                          '82299','13698','62773','41701','28968',
                          '70419','95084','65619','27831','31124',
                          '63622','48695','45164','15223','29411',
                          '58112','72343','92688','83944','86156',
                          '94921','10472','87265','75628','10628',
                          '95762','16395','33939','87190','27263',
                          '42434','24139','82417','88806','44522',
                          '56403','76785','96177','83069','83739',
                          '39951','93195','61800','80508','73497',
                          '76043','92765','69687','94675','67610',
                          '84404','54726','84247','43484','78279',
                          '22163','42808','19897','59976','76289',
                          '11756','55186','68835','28218','55737',
                          '22317','10218','63624','41051','96072',
                          '53314','94622','31629','51267','24874',
                          '61295','76251','69593','74099','40741',
                          '44269','94424','33522','31383','13957',
                          '20025','68692','94791','42811','19622',
                          '55362','47433','70372','61437','24767',
                          '39419','53501','15817','99681','68419',
                          '50627','43602','64001','81513','27586',
                          '89414','61330','75725','35840','22067',
                          '72613','40619','38813','84378','28402',
                          '79137','14352','21309','55247','79259',
                          '66524','20730','37227','17084','77469',
                          '39489','97746','97169','70557','32693',
                          '93257','38146','72400','71556','89506',
                          '95220','25923','35057','55063')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


