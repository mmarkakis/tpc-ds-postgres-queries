
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '14127','16281','67602','52068','35969','39265',
                          '66860','64000','19690','98788','42570',
                          '55696','21383','84706','92577','53412',
                          '49928','47291','50939','13438','96889',
                          '85931','11958','40521','45603','81074',
                          '73022','21993','55294','53532','29650',
                          '43909','40750','91836','19129','98235',
                          '14117','83897','41129','90470','54233',
                          '33371','76782','80988','18736','12796',
                          '65743','37875','87805','70965','89906',
                          '66274','77607','71034','26880','35907',
                          '11659','92672','64763','21800','54823',
                          '40135','24502','23210','78954','20029',
                          '41220','83925','53290','21289','91841',
                          '26480','13291','39470','30801','20990',
                          '21028','70826','44539','98802','24594',
                          '73040','19478','99068','96326','49003',
                          '12388','84252','60872','97534','15487',
                          '11822','76208','79879','96165','82622',
                          '49848','67789','59095','10168','10768',
                          '61873','28832','95625','18159','13110',
                          '33725','71809','85262','56794','97189',
                          '60015','23730','19352','18592','52742',
                          '60992','90058','96247','26194','81163',
                          '99315','60911','42024','68978','17126',
                          '96315','60009','61045','74176','49923',
                          '43154','73278','91351','91783','18315',
                          '78594','38729','90296','66254','36549',
                          '95236','54066','68047','15412','52680',
                          '52578','77635','34247','87907','85104',
                          '23694','85162','75441','95618','44769',
                          '52848','35561','32925','30474','51831',
                          '61214','47052','66017','55020','77191',
                          '98153','79679','40325','54426','69141',
                          '45470','95039','68573','63007','84855',
                          '96003','62053','79569','89520','25017',
                          '80600','22729','85191','55028','56860',
                          '34654','81599','90861','79794','33617',
                          '28949','83613','43632','27750','88477',
                          '82345','41429','34421','16194','88680',
                          '28458','32277','35875','18808','92860',
                          '80402','17337','89373','36275','10055',
                          '68265','38275','42703','44417','75376',
                          '38224','68258','15438','17711','80107',
                          '78902','43475','84777','48189','23536',
                          '19892','58195','21937','47584','39483',
                          '18410','20796','15480','38262','48413',
                          '74793','79412','49189','20702','82798',
                          '79587','14052','96657','20619','87735',
                          '69522','54317','18374','46199','61100',
                          '89621','67909','56796','82506','31138',
                          '40777','65470','12430','66114','66077',
                          '29742','69152','98701','63409','53253',
                          '58916','89141','29317','18870','43899',
                          '39456','88172','28417','86371','68947',
                          '22609','10405','95849','20635','47127',
                          '94183','61309','53230','53647','48785',
                          '53844','30419','62732','70672','77625',
                          '51869','41882','83428','94254','96920',
                          '77312','43272','80412','78571','97428',
                          '76243','62129','32188','26713','75372',
                          '71007','98565','44684','85562','72440',
                          '97111','79601','85277','14316','68745',
                          '18789','34237','52148','30722','66776',
                          '15963','41299','54406','45770','81138',
                          '86540','45966','17806','47554','73576',
                          '20054','83536','67827','30930','95375',
                          '69638','47187','98440','78784','53511',
                          '92217','67283','77760','41456','43869',
                          '36433','17847','79486','32997','57796',
                          '70976','82040','10162','58352','97153',
                          '14203','31744','37755','60324','56513',
                          '27706','39225','28100','43068','84379',
                          '32572','92862','53661','36898','90715',
                          '89526','14735','44819','73827','32724',
                          '11296','30590','99794','72800','63645',
                          '13864','40604','31601','82627','23771',
                          '94441','43049','76218','39966','17617',
                          '16156','11531','45899','50702','80431',
                          '90509','91213','41532','28400')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


