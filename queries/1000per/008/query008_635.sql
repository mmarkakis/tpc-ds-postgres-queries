
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '56318','44470','27603','46072','70109','52246',
                          '75456','78840','52185','43650','36591',
                          '14967','63976','19622','52455','85252',
                          '96039','68072','69485','39137','11188',
                          '24600','18695','85495','80954','68909',
                          '33006','74560','63117','43596','17944',
                          '25354','59141','66827','51989','86407',
                          '52721','50888','41606','32680','60222',
                          '34681','78178','62361','97037','60095',
                          '14232','64033','45655','84211','48654',
                          '17812','72622','45512','30939','81330',
                          '72300','87650','90915','43076','35753',
                          '95914','30707','85617','86510','90369',
                          '10452','74556','66595','31930','34612',
                          '73445','83157','36126','27161','79430',
                          '10537','57757','80349','72208','23731',
                          '82003','49699','36452','51372','48636',
                          '46661','98114','60968','72775','92533',
                          '77678','39155','33670','34041','38576',
                          '15821','91315','22075','29642','16200',
                          '28277','31268','16149','88729','30412',
                          '33165','93097','87009','26981','64894',
                          '30169','64385','17506','66932','25400',
                          '43645','28421','15760','17573','80579',
                          '66557','49006','61093','13788','84009',
                          '83051','69904','64607','83616','83984',
                          '23763','47341','21240','20996','66366',
                          '45235','14026','25859','54349','21081',
                          '22799','80519','78422','55315','88710',
                          '14586','58153','37628','55948','80580',
                          '83804','61225','35413','85843','56850',
                          '70627','38222','55433','28296','62592',
                          '34671','18485','15204','95542','27276',
                          '74627','53557','49466','12800','85525',
                          '32734','74887','61955','52761','73971',
                          '87745','40993','26200','53047','67017',
                          '67716','27348','60523','73747','76775',
                          '97182','87792','27776','35919','25115',
                          '72115','64920','84913','67779','62686',
                          '24081','92497','27431','94542','52539',
                          '45165','27845','34137','91313','62528',
                          '87430','53848','57281','69687','16672',
                          '97848','92287','36134','26856','97623',
                          '23779','24729','78621','27541','23094',
                          '69850','85287','11464','54543','56660',
                          '34390','24608','45182','18591','38543',
                          '10259','78711','61224','79342','96540',
                          '48634','29459','49980','46136','91300',
                          '16552','90182','23367','38531','51684',
                          '11551','74444','30086','83333','76568',
                          '47143','21077','76471','28242','10212',
                          '24442','93238','35590','41914','94095',
                          '44186','97558','48122','19307','57519',
                          '26282','99992','12502','86741','76680',
                          '24867','93030','20430','37411','21725',
                          '10984','80974','31716','55958','65965',
                          '22527','14916','22929','61059','81327',
                          '16195','51634','60122','52038','23165',
                          '22743','92748','91875','31881','97386',
                          '83178','30658','82980','68605','70540',
                          '17237','61566','89920','29044','23501',
                          '44984','56680','30693','37667','82074',
                          '89769','38929','67469','46913','70172',
                          '29108','94586','87232','30300','57607',
                          '52384','25838','84066','47393','26153',
                          '64089','21658','41345','21375','39181',
                          '32470','57954','86468','86668','26111',
                          '32056','71848','19565','31661','27239',
                          '55064','43586','22474','21851','51858',
                          '88753','65571','45605','60030','71361',
                          '40628','96439','48138','52060','93273',
                          '10723','44635','98478','49870','12114',
                          '79769','62167','57694','83531','72068',
                          '61887','51177','32706','66949','32968',
                          '55634','58444','76536','89191','83276',
                          '89874','75789','24693','29425','91817',
                          '95404','57310','48875','94646','99892',
                          '16348','90359','57312','25051','16208',
                          '19607','24606','97269','56566','95304',
                          '67702','58877','15093','33187')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


