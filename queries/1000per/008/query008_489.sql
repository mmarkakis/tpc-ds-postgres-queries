
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '76295','35813','67442','91745','19775','82476',
                          '44098','74219','79581','92767','83831',
                          '88383','44264','70741','69069','65756',
                          '33755','65677','45245','56341','23067',
                          '32266','81225','45830','12975','71972',
                          '24784','32780','10336','54840','19791',
                          '63876','68194','59449','99869','71619',
                          '39601','92461','71556','42337','11823',
                          '61892','63836','79850','13895','79100',
                          '87151','85969','18263','30093','69968',
                          '11328','57820','10242','91391','34417',
                          '32972','29951','97326','79519','52899',
                          '72478','23252','93071','49975','12358',
                          '96920','71631','24060','39310','80142',
                          '43749','34892','35446','98472','11465',
                          '43408','41474','93484','74789','73858',
                          '30544','18979','24636','96930','53619',
                          '73636','22819','41946','69409','14142',
                          '77212','25734','21730','94740','19952',
                          '93857','28404','57163','53904','52141',
                          '17949','61947','67336','43935','83072',
                          '96903','18767','46701','68331','98419',
                          '31950','60544','42334','30726','63519',
                          '37657','79121','73262','99632','84167',
                          '92380','36122','91289','11290','89460',
                          '55227','76769','98573','73600','85683',
                          '93823','94424','34163','13991','26863',
                          '25739','21227','54324','13468','12140',
                          '36552','87552','29487','19241','56795',
                          '44837','31553','70266','58197','17007',
                          '68544','95990','33688','79242','87494',
                          '23325','81352','97909','70662','65201',
                          '57824','27552','82091','43350','55022',
                          '22598','41073','34491','14572','50759',
                          '10988','11749','36467','53474','46841',
                          '22778','88879','34768','13837','19351',
                          '39122','18011','89830','52212','66601',
                          '42528','12535','69981','39628','83369',
                          '65316','65864','35648','85324','92890',
                          '62857','17586','13261','32775','44067',
                          '81494','17217','56861','34089','49109',
                          '60357','39725','89621','22418','54311',
                          '63088','25654','97872','96721','37194',
                          '43880','98815','70246','77988','86594',
                          '69692','66199','55326','23873','59272',
                          '12854','99789','98303','76463','80249',
                          '77049','40425','71688','56998','30184',
                          '66333','12663','65907','60668','10703',
                          '36995','63133','32913','65725','35723',
                          '85358','32162','54051','28369','71079',
                          '56409','12113','49371','34323','13092',
                          '47345','18784','95666','35687','75823',
                          '85706','53829','21811','89806','26973',
                          '11598','69278','80165','85341','12222',
                          '25605','92154','39066','18373','48654',
                          '67994','90281','91628','48586','92434',
                          '60830','64957','71519','64755','78104',
                          '94460','15048','22663','22628','78487',
                          '16565','72626','23638','21416','27780',
                          '80208','89049','21401','67782','33693',
                          '19175','50446','35762','65361','62244',
                          '84213','77942','29347','18978','28188',
                          '36529','51505','14392','44233','25996',
                          '10029','35200','28638','45513','97620',
                          '49939','38295','25554','72753','38442',
                          '97391','63290','52843','16160','79936',
                          '13896','39754','72208','16388','66216',
                          '58432','56901','84832','71855','74681',
                          '92714','26805','82135','26272','42593',
                          '25740','86792','44938','10754','93580',
                          '78218','27466','71985','81512','52821',
                          '88782','84912','29648','82615','97287',
                          '30442','43773','41615','93804','86821',
                          '73069','85895','90710','51850','75413',
                          '39044','56474','83341','94248','19815',
                          '78202','21031','20582','64399','15859',
                          '16180','39899','12949','35463','53163',
                          '10973','87196','85423','11462','86019',
                          '90403','99932','83518','82460','26813',
                          '69596','96003','99856','73469')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


