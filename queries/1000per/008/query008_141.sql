
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '52469','98885','16112','73152','14725','43005',
                          '69653','25275','29327','49917','73496',
                          '48955','85019','34973','68580','26922',
                          '62851','40701','64073','81724','44801',
                          '43792','64787','99458','35228','19995',
                          '35086','95988','88652','23577','81407',
                          '22846','73183','45976','95664','25986',
                          '59220','62590','68101','82505','93751',
                          '57105','84658','15990','15997','71807',
                          '79789','97121','78911','71317','75260',
                          '25096','29997','82324','36625','68765',
                          '66403','98381','45875','97820','66236',
                          '41670','31079','33846','98398','99004',
                          '26495','93723','34908','22602','99966',
                          '21848','30617','18761','86255','79425',
                          '24404','55098','25627','28111','23520',
                          '73451','43315','79107','83312','50924',
                          '73879','43985','67211','55827','31643',
                          '14236','51637','92069','82688','51672',
                          '69098','87983','21660','25486','19256',
                          '50647','31199','38903','76316','65208',
                          '31279','38803','56179','41592','20586',
                          '25254','37394','49244','36683','41214',
                          '65586','83520','21775','42833','13990',
                          '99994','13722','83922','53623','87520',
                          '82589','64006','29552','82645','27940',
                          '81654','24617','18108','78138','88801',
                          '45581','44294','25829','28273','91535',
                          '19282','30788','77132','22373','29751',
                          '45753','71571','71110','36855','16748',
                          '12701','21333','94920','26751','31998',
                          '17076','13937','70578','41181','51803',
                          '49636','29246','91257','28067','20381',
                          '90077','34950','94761','32360','36296',
                          '58332','27385','67457','68282','94926',
                          '49042','18573','53710','69759','58346',
                          '47429','74554','50323','42611','88334',
                          '31421','93637','75690','61576','72089',
                          '73228','11889','78748','55606','92692',
                          '92842','49860','36959','55583','28019',
                          '69273','65295','93460','86109','63919',
                          '96363','22106','31826','20043','58724',
                          '24683','28729','36019','78867','27595',
                          '37974','34404','24595','97414','33151',
                          '96690','54207','21071','86679','92251',
                          '83669','74225','69915','75782','79629',
                          '87934','22335','64865','91759','70032',
                          '23299','87454','18857','31807','53069',
                          '17618','81091','14437','42277','79678',
                          '40320','91647','96191','92386','43870',
                          '36131','86590','83024','30036','76615',
                          '99886','35023','36531','70220','26045',
                          '92474','89951','20221','12586','92943',
                          '58914','18342','38913','11366','42137',
                          '95088','11937','28858','86461','96075',
                          '58073','52405','19061','77198','51848',
                          '76136','60674','69834','50426','40065',
                          '73054','39769','52017','20663','79170',
                          '76880','42580','47478','58947','56837',
                          '92690','26196','34907','39772','38131',
                          '83889','70562','88923','34789','40918',
                          '76974','74270','30155','95052','33746',
                          '88693','68044','16120','42156','80572',
                          '90889','46381','26366','50747','35107',
                          '20087','68819','34643','48223','99583',
                          '19630','24639','59115','75876','82379',
                          '56210','67546','15612','16952','63291',
                          '30732','31589','48185','88908','67250',
                          '78463','81578','54932','13078','80208',
                          '73238','65176','68024','88796','35347',
                          '42681','84604','66451','20855','15427',
                          '61113','11219','75405','89037','67376',
                          '50562','11481','56030','63060','76801',
                          '27036','48137','93372','60997','78528',
                          '55630','40374','64748','23978','27704',
                          '73900','51392','54095','37217','78391',
                          '65611','48051','97093','79005','98573',
                          '94701','95154','94905','57790','77740',
                          '62297','15027','57326','43047','69019',
                          '37731','84320','71821','39105')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


