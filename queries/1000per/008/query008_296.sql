
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '32558','12067','75838','96812','92135','65259',
                          '34374','31931','74418','52330','35671',
                          '46998','42214','99308','40762','72548',
                          '81186','13908','48585','80515','69430',
                          '68977','40267','45966','40305','69079',
                          '40860','53946','57621','95090','65706',
                          '68255','84901','80414','12359','84709',
                          '95987','95932','51756','66051','24606',
                          '39221','35499','91602','99661','46226',
                          '21547','83688','35615','33632','56065',
                          '59222','12497','55771','91162','16919',
                          '56463','67475','78362','71564','81704',
                          '22889','85567','64430','39340','12829',
                          '53666','27745','30927','46714','17082',
                          '35264','58196','35894','54348','51264',
                          '27217','57426','76430','87357','78735',
                          '46541','60046','15223','89507','56385',
                          '23382','96842','51842','41977','94996',
                          '40337','85530','22138','25775','79391',
                          '99819','62718','18376','35207','57142',
                          '75068','35792','91310','24138','50951',
                          '75037','41375','49637','36725','54805',
                          '70245','86403','99911','43476','61582',
                          '21523','63996','74137','42462','51549',
                          '43086','64609','26143','22233','16420',
                          '97197','46512','77097','88036','37197',
                          '60975','94506','88658','62453','12121',
                          '17083','84697','30800','56500','97022',
                          '75712','97489','54611','53840','94276',
                          '30090','55824','22070','82990','44931',
                          '69368','63161','38046','36841','87636',
                          '74026','25436','79011','47906','41841',
                          '55462','83549','62692','49561','45628',
                          '80457','61265','38577','77834','19144',
                          '28993','88592','84758','89643','79956',
                          '56341','93617','26656','66892','57663',
                          '58520','45372','30175','35012','93698',
                          '27294','86550','83900','41824','48928',
                          '39203','55115','69467','44832','54510',
                          '48849','44443','84406','16408','25861',
                          '50457','98707','24386','59118','33465',
                          '89550','49690','30210','37961','36566',
                          '93129','84204','95364','74138','41837',
                          '23427','85077','10824','46678','53274',
                          '14819','57059','82442','89155','42395',
                          '54594','55073','44757','11853','95722',
                          '87374','64239','82702','50572','74889',
                          '71485','64084','45032','29983','77880',
                          '78380','97778','88657','72901','51541',
                          '84912','41552','53193','80058','15684',
                          '81870','16257','97082','28214','28220',
                          '69308','32307','69154','85995','45119',
                          '90272','30529','62234','95101','56517',
                          '46200','21791','68477','29401','93340',
                          '87062','85535','73756','86383','65845',
                          '62072','66456','73659','27881','45993',
                          '20324','31862','50469','90872','54871',
                          '81267','78148','51472','13710','37023',
                          '64196','48202','23352','34241','81084',
                          '63522','96742','37573','38845','33423',
                          '22516','83895','32169','80504','68739',
                          '46655','46441','19394','79129','96306',
                          '85912','20450','51361','64253','87280',
                          '68073','69595','40388','67621','66239',
                          '25205','98020','33370','44644','37029',
                          '92236','66262','66829','35717','79689',
                          '49114','30493','90775','44386','62112',
                          '22286','18455','86139','38574','52913',
                          '79896','81775','47648','44433','40135',
                          '85410','47155','92052','89556','76919',
                          '10527','51173','24279','19822','92963',
                          '59537','89296','22924','29368','30618',
                          '42249','60212','99539','38356','45511',
                          '71941','44291','96163','43176','67826',
                          '24562','50764','88081','60391','61690',
                          '84363','31593','87161','16266','25210',
                          '72222','79012','57910','72851','43128',
                          '82173','54983','44206','89625','79167',
                          '56465','80954','11308','30993','66766',
                          '28039','96208','95988','52462')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


