
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '96062','26891','91418','64457','55277','67677',
                          '73118','92525','40821','25594','55799',
                          '55101','12815','16921','47826','49074',
                          '67446','52819','70505','91863','79806',
                          '16511','50550','77183','95766','71550',
                          '80516','58239','12866','78298','73940',
                          '11484','68467','46623','54634','86149',
                          '79030','79841','79390','50746','70454',
                          '10464','29864','71857','84381','79069',
                          '51919','19444','62605','90127','51938',
                          '75913','89827','24386','65587','39370',
                          '37618','43083','48983','85174','68078',
                          '61126','17216','84457','74760','72349',
                          '83876','83711','15410','60164','84997',
                          '66408','68702','17207','48566','81746',
                          '34891','82239','67029','14447','41667',
                          '72818','97800','66874','98926','18894',
                          '54435','42269','42263','68587','30132',
                          '58193','51198','96121','79860','56814',
                          '45687','39885','78484','31866','14985',
                          '66629','38896','14332','85852','26236',
                          '28447','74805','80713','36790','54150',
                          '30791','23200','87602','67103','88301',
                          '48499','26227','19854','73651','21627',
                          '21381','93803','50520','10795','42505',
                          '97720','25139','72621','14625','81093',
                          '60182','83983','22386','10867','31868',
                          '17020','44391','66515','90064','60630',
                          '25443','21546','44687','19179','13951',
                          '42219','84054','38049','67332','70456',
                          '33511','36449','81331','98393','72377',
                          '52385','53768','88937','33439','81077',
                          '79773','32491','82142','38335','93989',
                          '60482','14080','42195','83418','39183',
                          '74671','93481','99594','86690','80650',
                          '37755','33237','97150','19004','58714',
                          '47475','28177','35354','16150','83442',
                          '72150','70240','34982','70476','24937',
                          '38609','19559','93522','70850','26540',
                          '35152','43819','71604','64142','43073',
                          '27423','94772','57147','12598','29405',
                          '67456','18409','46221','16258','63170',
                          '59605','85692','76398','75342','29953',
                          '57071','67189','29884','72130','79692',
                          '38845','41128','80578','59857','32767',
                          '58599','89817','18328','86986','34410',
                          '30231','72721','60560','15812','22673',
                          '48046','11984','41698','55182','78189',
                          '29147','76827','74703','46836','85934',
                          '97968','56585','88550','41579','91501',
                          '56206','33364','72048','85048','10100',
                          '69353','31986','68773','95685','98370',
                          '97887','54089','95119','92452','77881',
                          '81175','92876','82625','77811','19792',
                          '79490','35057','39091','59253','53132',
                          '63201','95186','11796','80335','93590',
                          '12944','10724','63825','74005','19208',
                          '13564','67291','16836','83344','89899',
                          '19348','55967','33350','34391','51642',
                          '28264','16565','82342','99471','71052',
                          '45893','36842','60607','26299','34647',
                          '67526','23225','91393','42918','72420',
                          '32889','91684','75105','29718','14321',
                          '56608','86437','67645','54253','28233',
                          '92797','56947','56835','34828','19154',
                          '57791','95787','21469','70492','49976',
                          '12793','87586','49386','98819','97224',
                          '76572','65405','63425','71737','48382',
                          '86631','29956','35517','33087','53157',
                          '53494','85218','23492','53625','27240',
                          '70645','74517','91603','82325','52469',
                          '40046','19824','35552','40515','46293',
                          '74922','76653','67126','43185','65509',
                          '11115','84068','46818','75280','29409',
                          '42674','25154','13260','18460','57347',
                          '29849','88147','54065','69494','74852',
                          '53852','49469','58581','74084','86942',
                          '22429','73569','79048','28336','35139',
                          '80576','69122','13995','28622','40175',
                          '18261','67648','41922','53592')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


