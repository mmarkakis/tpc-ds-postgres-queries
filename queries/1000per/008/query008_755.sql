
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '21303','52649','17616','52489','74105','92668',
                          '22048','56847','32544','38669','95235',
                          '24580','58954','87482','31497','83919',
                          '23337','94989','60043','24873','78345',
                          '59381','29843','22638','95669','44165',
                          '36293','45406','19068','57221','68661',
                          '26771','39458','28809','55694','86779',
                          '98580','34130','36734','96309','24330',
                          '76776','62862','47211','96109','66931',
                          '53620','81742','28980','78964','61030',
                          '32499','20772','68734','11301','53825',
                          '22633','42735','69213','37572','38157',
                          '34990','50012','72069','91393','31520',
                          '80912','31290','38351','88832','84450',
                          '46974','49005','93567','44861','87465',
                          '46108','21871','97979','63600','60537',
                          '67315','41393','36257','34597','18110',
                          '43878','79607','50350','21791','49900',
                          '97457','98258','21006','35278','17126',
                          '44329','55816','57835','25597','32197',
                          '14179','78207','47508','88910','61270',
                          '75160','82783','77018','64922','87892',
                          '93010','66808','53720','19483','20065',
                          '80221','69141','40507','82536','90440',
                          '30104','76270','51837','62824','26059',
                          '47079','79140','16791','16207','48111',
                          '63788','38590','97658','41362','30695',
                          '48160','89474','18251','75739','39156',
                          '82402','60062','64225','49760','97962',
                          '26513','90154','62653','77960','49093',
                          '10699','59819','35367','90822','49936',
                          '60083','22313','84014','63052','31684',
                          '35604','26984','61131','57176','71673',
                          '17428','12784','80786','34951','84765',
                          '92743','68275','86104','21286','72365',
                          '21828','72759','39975','75810','93527',
                          '92391','78544','51329','87991','72036',
                          '55016','91734','68724','33895','36507',
                          '48099','14303','55069','72002','44070',
                          '75945','20132','48203','66635','15145',
                          '21716','29508','95716','81123','13351',
                          '98138','27182','62963','56249','65964',
                          '83962','11249','34328','89563','53598',
                          '12913','87442','35738','75131','35899',
                          '29059','90456','38651','89291','44859',
                          '36746','60598','17631','15824','90602',
                          '68341','97157','44655','31061','64035',
                          '30906','48468','38131','17924','58850',
                          '66905','13581','33560','14825','57489',
                          '46506','48508','97860','96735','14220',
                          '80397','83065','31140','37900','28559',
                          '15245','56531','96439','17035','75679',
                          '52187','93790','63760','70480','24072',
                          '31479','68671','20322','14776','81962',
                          '32434','71013','75580','21250','82420',
                          '89201','96674','17677','10046','31824',
                          '98430','73005','72118','68982','77303',
                          '51241','90497','28352','97322','37091',
                          '28573','36741','73098','23319','34314',
                          '73057','88154','74416','61861','69893',
                          '38695','91242','40537','56329','82000',
                          '98633','50640','42699','24712','91791',
                          '97361','29096','39915','71942','72167',
                          '71041','84301','63363','51665','73063',
                          '96219','84917','67620','76695','21670',
                          '35595','94119','78427','45259','20664',
                          '96378','93104','10409','99110','81959',
                          '22562','18037','76572','45434','96049',
                          '60090','49072','19249','26443','56788',
                          '55347','49881','90148','64358','54053',
                          '88713','36289','54723','44532','82320',
                          '92447','62981','69524','97117','38817',
                          '85790','58204','51218','97320','19492',
                          '26072','69380','16582','34466','61520',
                          '64834','83656','97712','44719','15112',
                          '88640','15253','13524','71750','76364',
                          '91171','98232','36329','59917','73542',
                          '27603','61910','10193','92680','32137',
                          '28653','53158','16246','86282','63807',
                          '73444','23145','44086','12040')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


