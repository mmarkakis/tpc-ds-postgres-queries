
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '50414','33069','82462','27024','58500','84538',
                          '69544','55614','27992','59785','56102',
                          '66624','46853','31894','90756','75785',
                          '73809','81253','55494','77932','32725',
                          '17068','41066','67155','76908','89624',
                          '34319','23373','59892','99636','59384',
                          '51841','16906','92731','12235','97779',
                          '84305','38359','42400','50168','72203',
                          '64464','73839','49088','44381','62660',
                          '33581','40567','71948','44390','76407',
                          '14205','54851','79963','37270','85754',
                          '22316','45634','80409','56046','63729',
                          '65599','79042','80840','41942','14224',
                          '85049','59772','55973','95086','45928',
                          '31374','84761','93130','77078','49177',
                          '20504','27880','92960','74287','91913',
                          '15519','94560','16939','38704','11226',
                          '11662','95087','73930','46686','43159',
                          '28476','60567','21397','91896','77471',
                          '22501','26852','33194','57991','42720',
                          '95749','37126','32317','67250','71182',
                          '75754','55161','14323','14256','81322',
                          '21579','81356','88394','48115','37007',
                          '63714','48965','30882','38840','24566',
                          '18619','44255','39817','26663','41563',
                          '90334','31730','61233','36732','25217',
                          '92385','35488','95005','93996','78625',
                          '20572','48250','12281','63237','90716',
                          '30159','68444','89595','81919','42253',
                          '64906','56318','60986','83705','12843',
                          '37654','20006','17171','25255','88958',
                          '57786','66709','31333','12981','13098',
                          '24594','53379','59984','41350','78195',
                          '75652','50812','25940','25788','55005',
                          '21853','57407','98438','75703','66197',
                          '56205','68818','80854','63843','30489',
                          '18728','59198','82932','33918','23104',
                          '31809','13579','18090','14890','10224',
                          '99806','82761','80616','64428','34446',
                          '81183','57615','43115','64975','48803',
                          '21528','58601','72349','21585','22275',
                          '77663','92976','92115','16868','89475',
                          '52069','65908','74572','85865','58539',
                          '54634','38921','14867','32767','13845',
                          '45247','62208','92730','17835','50583',
                          '59199','47493','19659','24265','26395',
                          '18248','99837','38380','41806','16792',
                          '31018','77843','74494','74962','50884',
                          '47859','98221','86034','52035','88009',
                          '77082','37753','91760','64908','73649',
                          '81444','73508','96741','51882','12320',
                          '16431','91959','39645','61322','71223',
                          '42534','30343','18352','19352','58202',
                          '94214','49924','86862','90938','27675',
                          '14651','93881','63672','49501','19765',
                          '85860','61354','13432','34809','78658',
                          '89850','86697','67730','36173','79680',
                          '97169','86344','56463','60649','79570',
                          '75459','89227','67126','15495','23554',
                          '73066','31116','16368','68754','89990',
                          '91066','30904','13883','53191','27746',
                          '61913','63770','35300','15975','31024',
                          '31817','38524','35799','53262','22181',
                          '60822','68388','49112','17135','20245',
                          '83712','68206','95215','52224','48107',
                          '56650','58660','92809','12524','56108',
                          '37514','52946','30944','80667','66154',
                          '54637','64803','88097','25843','19107',
                          '64774','93239','27316','11991','37844',
                          '82038','91973','69336','22445','65221',
                          '44409','74350','70663','77488','79407',
                          '56773','13547','93990','45633','47109',
                          '37511','33318','49977','82446','74544',
                          '67858','95285','85634','94873','98236',
                          '60743','34095','76346','14149','97205',
                          '54970','73977','51260','78298','83741',
                          '20105','14631','84592','25246','55933',
                          '61719','27529','58433','33539','35263',
                          '92891','71811','13199','58560','76667',
                          '35616','28413','18749','85783')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


