
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '63492','30009','52370','41488','82311','81144',
                          '23775','57104','66469','47394','98661',
                          '37600','94510','12782','43940','92166',
                          '22877','23462','92378','41384','31898',
                          '29917','54176','76818','29396','56839',
                          '64690','78496','69534','92025','20446',
                          '67812','19865','62575','91722','67422',
                          '27142','94055','77160','68120','27068',
                          '25115','30352','35091','62555','51612',
                          '68314','67839','20151','50749','41176',
                          '46446','40264','68057','22785','40794',
                          '14515','83692','67250','34725','63913',
                          '95812','61227','46822','80702','93118',
                          '43618','78967','31671','63898','31012',
                          '66901','35650','74426','33537','84105',
                          '94707','15271','47289','39071','59360',
                          '22831','62522','82550','96149','27155',
                          '98605','21345','84352','69092','15566',
                          '29465','13105','39894','93739','79489',
                          '63902','37680','80825','69473','57517',
                          '79571','71730','99161','98725','15972',
                          '93702','22428','33972','74203','61195',
                          '81423','73064','36006','17464','83005',
                          '92861','98308','22047','85651','90578',
                          '36047','35161','69308','19423','16554',
                          '39678','62554','85968','40633','31048',
                          '35140','22424','45441','83935','62950',
                          '17951','88869','39543','86449','52702',
                          '59076','16064','51482','42787','22311',
                          '40455','24632','70410','78201','30922',
                          '28137','21454','43121','37806','45366',
                          '77570','98870','94738','40573','13190',
                          '48873','78643','37191','96768','63222',
                          '60207','98990','81653','55867','32316',
                          '28969','44543','82726','35725','38381',
                          '41296','85313','55849','41101','27513',
                          '98198','60840','21395','73340','39944',
                          '41687','16851','98346','27453','28615',
                          '91259','35105','83909','47140','75668',
                          '75065','68378','48337','82239','81484',
                          '97186','15668','42792','76160','16413',
                          '10913','11657','32687','79863','16750',
                          '90685','85531','45106','44237','98086',
                          '46952','39725','79124','19146','75410',
                          '19131','43578','42643','45314','93929',
                          '82183','92919','38513','43324','66151',
                          '37797','89537','62214','29734','58889',
                          '22360','29246','34515','61616','25344',
                          '59552','41714','37985','59509','23324',
                          '98613','13316','95601','86503','54225',
                          '59423','31256','26524','28829','91678',
                          '66971','38136','91289','66097','64666',
                          '38289','56877','20772','35812','26883',
                          '45490','82645','17017','81028','46380',
                          '41832','15177','52726','77829','90872',
                          '98076','29398','10989','98154','18487',
                          '91587','23134','13969','33010','10748',
                          '93645','18108','28065','23420','95647',
                          '47262','85636','43538','83868','45101',
                          '35914','13278','80841','78754','18643',
                          '69929','84257','79716','28142','74192',
                          '85393','86950','26109','62897','22285',
                          '42176','51511','71815','35361','46601',
                          '31264','12538','54847','93099','21511',
                          '37757','29007','95982','41924','12052',
                          '61375','89171','20756','49997','39893',
                          '38861','96164','17713','58138','53352',
                          '48333','16754','15316','20784','75317',
                          '69365','86408','24015','43136','23036',
                          '83563','66323','14095','53728','91128',
                          '16439','38310','69083','82039','14677',
                          '41422','40290','32065','68376','34642',
                          '55126','89818','75575','69518','47930',
                          '78010','81054','25836','22950','64841',
                          '55571','44301','18396','69932','60459',
                          '88369','13518','39946','16080','32410',
                          '17084','65478','80459','35416','23441',
                          '99680','45480','61656','92969','19156',
                          '49727','47474','38003','65827','89695',
                          '25556','14837','19842','35506')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


