
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '55770','72705','87588','72369','17854','16216',
                          '88170','65957','87519','83386','22672',
                          '30904','41764','14848','48639','13223',
                          '35148','42382','42167','44899','53302',
                          '98148','91125','65869','42554','43880',
                          '84085','74620','55076','82476','58031',
                          '28074','48095','91440','93499','16714',
                          '41710','79246','13282','96308','55443',
                          '57995','38686','15773','16778','64807',
                          '81353','37123','86863','72545','45156',
                          '69526','17883','85678','67612','31679',
                          '68692','15004','64971','91492','61736',
                          '26668','84938','26117','24780','32604',
                          '83508','26340','29862','15790','48148',
                          '50110','10748','91523','53084','10966',
                          '65383','89348','79210','88643','49717',
                          '48444','43323','35182','27986','60041',
                          '71528','83160','23885','93231','31335',
                          '78179','34317','48943','15008','32667',
                          '72864','97070','77842','82947','81596',
                          '83021','46451','24776','52479','28093',
                          '53656','52689','21903','95190','52245',
                          '29336','43087','42802','73404','19360',
                          '54899','31895','28867','99458','89074',
                          '32449','79912','13480','91224','30693',
                          '27617','90040','36976','52705','37092',
                          '98082','47711','71011','56121','85435',
                          '59849','39804','85509','44515','91854',
                          '99620','33956','51261','40864','91229',
                          '37114','50561','46062','61081','88221',
                          '16164','15306','12337','14858','20537',
                          '35350','89926','29790','59577','34869',
                          '42878','90342','28335','69261','80731',
                          '70655','88940','64001','49967','44078',
                          '74636','88298','16713','37214','47776',
                          '67198','78027','95880','89126','80581',
                          '54353','14589','20219','61911','98078',
                          '90835','72045','70993','44378','84262',
                          '47852','50392','67668','10736','29392',
                          '28686','98144','53006','28766','68684',
                          '86649','94458','50370','94941','71761',
                          '22017','32615','37294','83628','98225',
                          '60225','53681','78062','38653','68079',
                          '43233','65636','37976','73906','19087',
                          '61102','32489','23819','75279','87503',
                          '67422','93172','18019','43578','29189',
                          '20044','29311','77371','76287','13381',
                          '22951','98384','52376','66289','14049',
                          '71427','53952','65328','17686','71211',
                          '91264','43173','84261','65145','68064',
                          '60350','80705','96786','12565','13094',
                          '80181','98167','94509','87851','93328',
                          '96254','85206','17566','66075','78163',
                          '95940','86777','28180','93253','55308',
                          '10113','18671','18836','23401','27318',
                          '21770','42972','58719','68036','88411',
                          '60521','97342','59294','54161','53013',
                          '96778','21371','74985','51974','47916',
                          '39590','48168','38863','98072','61476',
                          '94060','43977','67341','63256','78637',
                          '40572','68957','42716','23112','10407',
                          '85937','98601','25600','73261','48298',
                          '13889','51907','62956','39149','99534',
                          '21519','88988','86700','64231','44419',
                          '70376','92516','36921','17717','16771',
                          '52184','23878','11792','35822','92085',
                          '56167','67918','94669','84372','87864',
                          '56213','42931','58236','32393','86578',
                          '14901','94615','21674','56375','12667',
                          '44902','93468','95579','59915','77933',
                          '10291','70395','13374','44781','39891',
                          '38049','50330','23232','69736','88326',
                          '83481','17214','20286','58111','99952',
                          '72396','93715','92548','73521','18471',
                          '36881','19264','45756','94093','39879',
                          '36832','25484','41577','96604','99106',
                          '39736','84360','49139','58375','96948',
                          '55693','95835','38149','42781','69442',
                          '11334','26667','83756','52028','17822',
                          '79516','72828','30551','93788')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


