
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '92249','19928','71443','57691','59258','87694',
                          '53957','69098','46409','40301','47838',
                          '55939','20362','31594','83448','28858',
                          '55499','42440','22199','30433','67421',
                          '29349','12764','31544','43741','91767',
                          '90976','42016','53810','30132','81712',
                          '69650','66604','83023','79535','32970',
                          '35855','59570','90011','33923','40796',
                          '39548','61798','12963','90178','90757',
                          '13106','86691','37020','44312','76322',
                          '34194','13921','81419','55895','58561',
                          '88839','19595','85963','99693','87928',
                          '36125','79945','13455','76468','15423',
                          '11752','26658','83577','29147','90331',
                          '84171','61670','58409','28879','46549',
                          '26412','22266','30556','67863','34709',
                          '53068','14627','53231','75313','80933',
                          '62957','39594','61743','99889','28536',
                          '64142','37558','50457','60551','65726',
                          '14920','41774','92695','73771','59340',
                          '32932','26366','74276','19943','25246',
                          '37811','36271','24321','25511','58883',
                          '19170','68527','95281','52561','58021',
                          '42280','27076','18064','11200','58634',
                          '62089','72719','56504','46933','23594',
                          '20062','96470','58067','99810','10059',
                          '24110','66324','91949','87283','38527',
                          '20987','27120','61335','38030','60701',
                          '59064','78936','51666','21534','12129',
                          '43709','11838','34195','22195','62183',
                          '40002','26025','91103','93277','98660',
                          '66067','16986','40329','17597','73992',
                          '22314','37641','39088','94766','49303',
                          '31740','31157','31156','93318','84122',
                          '90723','50391','53233','14158','38867',
                          '42326','52803','38911','72404','53496',
                          '54749','87866','44151','72643','13372',
                          '35814','38975','61703','12319','85975',
                          '52113','77608','45681','67163','81088',
                          '79899','25400','73817','88633','65922',
                          '31931','89689','32225','48011','81572',
                          '33291','40761','17068','57473','94568',
                          '53997','23068','83188','96120','91090',
                          '39629','87207','70234','26235','71940',
                          '28019','59199','79735','10523','63775',
                          '17375','28213','71469','23047','42857',
                          '24947','69536','87883','12024','16158',
                          '97667','12493','79086','89252','73743',
                          '37821','90306','72999','37330','76234',
                          '70481','81038','32226','97490','58828',
                          '91788','79467','75607','31559','76065',
                          '62726','15546','95395','68816','91506',
                          '59768','76995','95673','45274','21969',
                          '49389','86528','47761','62176','66121',
                          '35862','31289','69829','25913','29464',
                          '70750','60330','75207','28206','80948',
                          '59516','97732','67879','53398','64340',
                          '89862','28965','84436','47141','34049',
                          '97372','27462','58016','33082','35348',
                          '11544','51069','22629','39593','87909',
                          '51756','15325','71956','62112','99031',
                          '52091','18710','10354','96606','64206',
                          '72010','20667','35001','42526','66980',
                          '69190','85292','87937','16850','90700',
                          '92456','80432','70952','74458','45974',
                          '15464','87482','24060','22443','42107',
                          '58678','78621','24724','84565','68661',
                          '31054','66198','13710','53235','38250',
                          '21361','52571','48507','77897','69722',
                          '32203','57547','77841','84548','66605',
                          '54404','57490','46962','48044','18837',
                          '20116','84400','43124','60609','19644',
                          '27663','92167','99937','38853','38675',
                          '48882','24768','23788','13434','18734',
                          '12552','16549','64911','77473','98473',
                          '25831','66638','27953','48090','70301',
                          '57047','43094','62975','95660','12529',
                          '93477','49835','24546','31815','50907',
                          '58925','85978','23635','26294','76980',
                          '47268','67280','41200','79975')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


