
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '65022','73106','89582','55109','72558','28356',
                          '92847','13861','66208','45690','18164',
                          '48834','99275','28154','89040','92678',
                          '35638','70725','20538','29989','12059',
                          '56638','77921','50090','47223','23711',
                          '79806','77820','42508','87758','89337',
                          '75834','21338','24168','20092','42409',
                          '98743','64871','70678','11387','23176',
                          '15488','96210','75249','83950','24400',
                          '49951','37619','46665','86387','83929',
                          '41012','16899','73966','14454','83614',
                          '99944','50169','72404','80635','28427',
                          '37778','66015','15328','78696','45691',
                          '75352','51477','72645','81283','94590',
                          '78310','43568','97240','46214','65673',
                          '89467','42337','79161','21674','25331',
                          '61866','50394','32047','35572','96773',
                          '40291','64047','67324','66447','92967',
                          '11443','32556','24333','20276','15181',
                          '36662','28362','46622','97609','97087',
                          '33944','26525','37534','11567','89462',
                          '22414','71808','25210','67355','11756',
                          '16811','14112','70536','12007','43023',
                          '61408','36327','73827','30115','66922',
                          '57218','21852','80600','33027','49163',
                          '53999','38002','95292','13752','27204',
                          '99129','17907','68507','17111','81336',
                          '26719','26157','47394','48499','96934',
                          '28655','70687','40133','45666','32323',
                          '14253','12958','24018','64758','59293',
                          '30842','24703','67076','98026','21571',
                          '89135','21610','12364','29946','44463',
                          '59639','29606','72193','49324','99807',
                          '28505','45154','91349','43618','78564',
                          '52417','46181','47784','98312','28305',
                          '99624','36019','85234','59879','40453',
                          '35537','90491','39081','72430','18009',
                          '80427','21176','90234','99591','73349',
                          '19377','65172','98362','52438','91770',
                          '99073','22201','20205','87075','11727',
                          '14196','56686','40494','73622','13544',
                          '13541','90624','50126','58438','79037',
                          '73264','84557','79398','18648','58533',
                          '37293','17397','95239','31041','97456',
                          '84375','35159','77219','86453','47617',
                          '15348','91684','62084','57476','81584',
                          '38584','77555','81273','81800','52133',
                          '25365','36971','91984','49702','27564',
                          '65485','30125','69491','99131','73012',
                          '86393','68818','10835','43680','15966',
                          '29252','89554','40842','81948','18769',
                          '95266','66028','53490','73322','11475',
                          '43170','66746','93410','83111','24382',
                          '34401','80407','40254','49682','87267',
                          '13056','20018','34411','65077','77426',
                          '31741','43105','67323','44355','30646',
                          '37824','54971','66285','41990','58352',
                          '87657','47594','38028','71730','92602',
                          '88301','48051','50231','96854','60262',
                          '38527','92650','91725','10324','79885',
                          '50974','13702','29690','89727','68724',
                          '46001','72134','14830','62376','62785',
                          '51678','23903','37076','20923','29537',
                          '93791','98267','29613','31475','32666',
                          '87485','69094','47549','48541','24030',
                          '17245','53115','61902','73792','25562',
                          '52215','98303','93405','23381','39769',
                          '70068','49515','90352','50283','28241',
                          '12919','82979','79109','14794','47343',
                          '65604','52815','18455','52505','63375',
                          '74011','87407','23232','31381','50509',
                          '61893','72041','16044','34413','68092',
                          '10391','85647','51454','32460','72984',
                          '39421','61319','37463','38374','47796',
                          '88294','79381','75209','90033','86215',
                          '39906','73202','80525','92100','41416',
                          '56410','25483','22610','26172','75324',
                          '14638','38624','10091','56407','66698',
                          '13559','88288','41036','32381','28284',
                          '83609','81190','23227','90538')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


