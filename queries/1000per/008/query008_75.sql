
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '13826','70644','71172','87968','20218','23808',
                          '88409','96179','13005','95734','86742',
                          '85792','62770','42024','45545','45078',
                          '10260','79642','85869','46245','98284',
                          '17453','16887','33245','20298','18310',
                          '16095','20796','47527','95868','75821',
                          '10551','62040','52701','45738','52073',
                          '26518','66462','10679','44028','21966',
                          '84014','31372','42839','19638','92012',
                          '80125','35700','69321','74654','13904',
                          '42404','18592','10018','83601','69322',
                          '76297','88270','80808','30853','27079',
                          '73212','83985','88009','92668','23950',
                          '37921','17731','61685','40517','42492',
                          '38503','97147','93911','69696','38768',
                          '71216','30275','61564','70336','70303',
                          '87643','20561','44544','68447','92905',
                          '15640','86968','34889','11017','39592',
                          '81771','52863','48172','51032','75483',
                          '82488','83768','37469','10614','99242',
                          '75965','81242','95493','57324','99529',
                          '87180','70519','73316','34288','11929',
                          '48140','97577','69874','71525','97923',
                          '89353','91960','56403','65205','48621',
                          '23252','91842','33635','50498','98158',
                          '13684','75622','39373','73488','78342',
                          '92832','88132','40919','52150','13776',
                          '18752','61408','87360','60970','99208',
                          '93121','83831','88022','93088','30390',
                          '51908','21654','69057','84901','87850',
                          '79163','68815','66457','64115','53485',
                          '98691','94538','24259','58422','49261',
                          '25890','33522','69266','64783','65168',
                          '62303','67203','78433','16750','61801',
                          '49092','64338','84792','29675','22930',
                          '47231','58184','26408','71268','47929',
                          '21253','43867','33262','43595','73505',
                          '21722','71765','58522','47601','14836',
                          '75540','58372','27028','14981','95357',
                          '91158','78292','46867','10677','22194',
                          '87782','16734','88608','62222','71227',
                          '90870','26929','45284','95777','52943',
                          '39090','86702','86825','73940','90894',
                          '71288','88450','38176','16763','62917',
                          '73248','66380','35023','47843','15480',
                          '79820','74927','41760','32366','36446',
                          '19157','19538','25744','44502','70736',
                          '78047','80575','27789','80514','60758',
                          '50347','85021','14068','17773','56580',
                          '16070','12865','36054','89274','34933',
                          '15684','79408','29735','15272','24368',
                          '11234','22050','52444','79319','68421',
                          '33639','33677','30108','89984','73025',
                          '24895','82509','52032','77455','43431',
                          '47136','88102','56751','30240','17690',
                          '88638','43032','29522','80280','35097',
                          '86369','56925','56517','50700','63795',
                          '36179','54921','50755','80882','58513',
                          '99431','97549','84834','98743','86715',
                          '27675','20768','22280','77085','14496',
                          '76090','45228','34657','84773','54201',
                          '25273','41727','93276','77219','61024',
                          '84735','74879','35208','38672','37854',
                          '23046','33829','60941','29467','19042',
                          '17264','19176','40831','51176','87412',
                          '36540','88392','75287','78471','96080',
                          '57336','35215','91254','82154','75372',
                          '72448','31449','42239','48009','70905',
                          '93207','82314','53432','18366','30279',
                          '89169','74271','52407','78787','71667',
                          '45529','38601','32982','97046','74368',
                          '38568','76194','43249','82583','98444',
                          '58359','52128','97844','16833','86168',
                          '79790','54440','55925','72608','35663',
                          '71738','24707','94167','78798','52181',
                          '12521','47647','34110','69378','86703',
                          '16790','93268','66360','15946','20473',
                          '56741','55301','80070','75491','77797',
                          '47842','30950','68404','92675','52454',
                          '69612','57201','36777','93235')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


