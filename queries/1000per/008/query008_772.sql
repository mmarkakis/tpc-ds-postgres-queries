
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '83676','86111','37619','12157','35851','24453',
                          '23687','27230','67483','48200','17021',
                          '74184','60549','60694','66731','63832',
                          '48196','37853','43118','75410','37771',
                          '77320','61285','26262','58708','55434',
                          '63304','38809','87091','96637','91173',
                          '23833','40909','77331','14347','98257',
                          '78666','94613','98090','26068','12383',
                          '17716','57204','17514','56553','57115',
                          '74758','73711','71785','80878','18897',
                          '62397','94477','22451','90082','22382',
                          '64907','63330','88609','90148','52516',
                          '26018','34884','74841','82247','15394',
                          '57608','33015','32379','86010','20142',
                          '53449','74382','49142','43950','42072',
                          '59297','50317','19204','75406','11109',
                          '32659','79992','28788','58600','56252',
                          '89618','49636','91192','98803','44358',
                          '19843','91405','11524','21183','11788',
                          '64393','94848','84332','25372','55224',
                          '50666','35677','82201','65917','66471',
                          '94755','70993','95518','65977','13364',
                          '54120','83742','81511','38900','43058',
                          '47635','52731','63225','35066','34367',
                          '69100','15558','77493','53501','73213',
                          '44774','39910','98384','28676','95535',
                          '83050','13730','25366','99772','78822',
                          '83906','10208','78493','37789','70213',
                          '47739','40541','27625','22274','34628',
                          '46859','24311','98507','77482','54906',
                          '16006','19245','96130','34455','68044',
                          '78768','59581','74920','79740','72769',
                          '83189','52692','37941','16274','61919',
                          '64087','77705','66161','37276','57471',
                          '52251','98249','61680','57795','35866',
                          '93294','38687','61372','89941','75783',
                          '97922','11837','19148','53113','66371',
                          '74662','19638','35809','95944','86517',
                          '18820','88949','97266','54214','38751',
                          '15054','61837','22152','98831','40307',
                          '32920','13003','15413','88038','99869',
                          '21160','24074','87493','99727','63146',
                          '68152','74916','51188','36589','19494',
                          '33998','18480','64967','80485','73850',
                          '70623','86856','98631','30199','52610',
                          '98710','51967','50049','12379','27588',
                          '80477','70695','10946','54138','89632',
                          '48438','29366','69166','13473','28566',
                          '89060','55210','39473','86082','91646',
                          '43342','70133','33355','90634','21609',
                          '71381','72770','27659','96915','31449',
                          '16737','81704','33321','71372','77165',
                          '28883','71705','99392','97333','59431',
                          '71149','78763','41399','61003','94731',
                          '27185','65856','58593','16294','76533',
                          '22953','61472','94756','45024','85938',
                          '86820','91887','20140','19631','64520',
                          '34662','18199','55360','38615','34574',
                          '91304','89924','83912','31201','84518',
                          '13239','46838','26835','42944','61555',
                          '99170','98048','41937','96987','53012',
                          '59540','27949','90624','81700','41576',
                          '68099','14710','49139','11898','19021',
                          '89483','68233','44437','98444','77232',
                          '95311','77820','93553','42679','40396',
                          '32747','52767','19620','74619','14826',
                          '77198','61107','36655','73788','51452',
                          '23658','22669','70679','47854','24543',
                          '56178','58597','76384','30644','90220',
                          '73117','99733','11490','67910','48619',
                          '40641','30884','29605','68551','17372',
                          '14416','84519','59342','16227','94387',
                          '13256','47568','62606','67333','86091',
                          '82295','42981','56505','50155','88320',
                          '19136','35235','28912','54609','12296',
                          '13450','24753','16264','16749','71318',
                          '86403','11920','37194','80176','43123',
                          '13018','22796','50410','70217','66831',
                          '55490','64202','77326','20610','45394',
                          '12633','69877','69769','64065')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


