
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '29883','94105','83987','98331','38627','31944',
                          '94423','91348','38875','99608','93786',
                          '60443','74478','91298','65048','97617',
                          '81522','78859','29795','48560','79903',
                          '99498','28021','70397','79783','73878',
                          '48161','56619','38930','69752','65882',
                          '89983','89498','44431','17467','24512',
                          '24969','86099','61185','32280','90747',
                          '90786','44450','88772','85634','30021',
                          '26581','89542','48847','87197','87250',
                          '57482','98046','27734','26936','91333',
                          '75522','99447','75675','15622','85904',
                          '85628','24048','96289','94372','86356',
                          '75781','91071','24888','93544','53775',
                          '81762','46763','16477','73026','98318',
                          '70614','92203','10533','68657','36102',
                          '79026','58398','91426','30913','38703',
                          '37051','14232','48292','46090','42312',
                          '79659','76712','67431','86609','87374',
                          '40985','66253','89532','98565','58545',
                          '85576','65680','51088','57242','16170',
                          '58192','11808','16003','22362','30185',
                          '39882','79770','18845','67014','85531',
                          '78635','74925','50802','68832','49756',
                          '67428','87221','49890','68608','59470',
                          '87249','99994','65209','76619','89878',
                          '83042','94034','95439','44715','94822',
                          '16857','38175','16005','85961','43010',
                          '17272','23623','25061','41903','58717',
                          '75931','82126','23045','17788','30610',
                          '11233','85221','58029','28433','17580',
                          '14498','16885','37193','18403','12175',
                          '25335','88747','78202','39140','42918',
                          '12150','25435','83055','36477','51167',
                          '63165','28936','63864','49904','28561',
                          '65709','57189','76909','53590','89012',
                          '50875','65939','82424','68395','67966',
                          '88057','17811','68422','44164','49855',
                          '26888','97416','36572','27873','94489',
                          '94140','61354','63813','19657','12864',
                          '48372','66834','59444','35901','68614',
                          '60112','25807','22111','12556','41742',
                          '89885','13245','58438','80678','92405',
                          '33027','68900','54588','49704','23862',
                          '53505','69735','49901','64057','94638',
                          '45689','14726','28722','81845','80868',
                          '37689','96269','94679','96839','50900',
                          '62217','25006','29233','94345','20650',
                          '22079','18842','14506','53152','61093',
                          '33977','73070','49740','70820','61873',
                          '83671','27686','50561','56454','66641',
                          '86109','76680','70925','40568','90230',
                          '78731','85912','82547','35083','68191',
                          '30651','84422','91794','34994','67574',
                          '38774','57124','73502','73100','40215',
                          '84592','45109','57087','61589','76761',
                          '15537','10760','87505','24024','24860',
                          '43126','78113','66504','23682','56740',
                          '93442','15881','23243','40001','61455',
                          '93107','54003','63267','19956','27141',
                          '93706','95355','29946','99758','70172',
                          '48250','85091','21225','68492','25842',
                          '24145','35442','44062','85195','96642',
                          '50744','88053','55398','54706','79395',
                          '54613','84844','62379','28991','79511',
                          '65641','37180','96160','31091','47275',
                          '95553','95101','68881','98201','42419',
                          '54881','62388','77111','95934','91178',
                          '92584','36107','11492','21453','31797',
                          '22031','38181','93996','53654','66579',
                          '36321','51232','87041','70867','22795',
                          '37429','45414','58754','43534','72680',
                          '18246','70575','61058','48457','61028',
                          '76639','52939','85603','34603','56959',
                          '64831','42609','37009','33604','87624',
                          '30038','69184','61233','80191','54766',
                          '80899','87454','86150','62661','53972',
                          '91472','13809','41662','48724','20546',
                          '95584','98422','64190','40577','40986',
                          '65026','94664','73684','21629')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


