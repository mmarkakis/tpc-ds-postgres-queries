
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '89188','49096','74921','23644','68142','65606',
                          '20474','47629','66746','65616','79922',
                          '71829','89100','86594','93417','71487',
                          '84535','36587','17488','12802','67185',
                          '98626','62798','31938','46730','10102',
                          '21457','26432','49195','71128','86281',
                          '29384','35044','95961','42884','26584',
                          '14831','16621','39011','91671','64964',
                          '34740','82508','60822','89917','14948',
                          '12731','88617','23233','58946','41231',
                          '23388','66828','96694','50193','43072',
                          '31230','72971','22889','55872','46731',
                          '80954','23448','29419','71268','63812',
                          '93551','28097','75738','60159','14685',
                          '52084','50910','77738','32752','43491',
                          '25054','57825','18610','18681','86492',
                          '80198','17293','67190','18595','58805',
                          '18131','36238','97711','77289','41274',
                          '77859','85274','30847','15686','99101',
                          '50730','77132','66451','75768','36554',
                          '26942','38117','34425','57554','13140',
                          '55774','32475','60340','62873','22252',
                          '69762','87651','52483','48805','23752',
                          '40766','69908','40859','96722','85125',
                          '89318','59545','54371','66615','30521',
                          '16233','24741','28479','75362','64714',
                          '41116','86077','74817','19335','22814',
                          '32695','86239','23139','23585','12366',
                          '24999','95290','66571','98388','89548',
                          '62664','29912','85772','15422','18771',
                          '98018','88091','17514','14550','92139',
                          '88533','58917','70744','87742','31698',
                          '22164','67824','51947','87859','23805',
                          '25953','61215','84602','76626','18539',
                          '96467','50798','77397','88967','93438',
                          '75557','30036','66062','28454','23057',
                          '72315','80501','57163','46243','31263',
                          '92658','26904','12210','42760','45166',
                          '61412','57284','26967','97839','88913',
                          '19159','23747','25947','71711','71850',
                          '91435','73149','87166','62870','46999',
                          '25877','75588','92854','22867','17313',
                          '81050','55384','52093','53047','45136',
                          '35646','52726','79463','44435','21825',
                          '50530','78845','11706','48787','63514',
                          '47153','60744','29566','65949','27184',
                          '30101','26795','73079','61064','29216',
                          '91031','38461','31320','28861','36076',
                          '61518','94602','46982','82846','54641',
                          '48323','71426','79227','68125','43368',
                          '52513','70149','62923','94024','20855',
                          '59692','87024','56149','72406','35583',
                          '67923','56957','33059','50179','15216',
                          '33196','87688','66798','67110','74960',
                          '14043','57806','98246','10631','46754',
                          '84373','38639','68800','82394','40713',
                          '65482','22908','15505','67239','31971',
                          '41711','49085','15066','24742','34796',
                          '93017','87019','49945','16966','70073',
                          '20907','90183','88057','74838','51725',
                          '32687','67525','22784','62283','87234',
                          '32642','17248','12463','26974','85832',
                          '59977','21766','25432','40796','89486',
                          '22599','22473','96065','92797','74391',
                          '72338','49953','78234','91753','74062',
                          '17870','46496','83046','32016','76800',
                          '88489','12949','67545','11171','87587',
                          '44666','14202','30921','37386','21360',
                          '66947','40184','51449','83165','12638',
                          '66000','50360','53670','13471','49756',
                          '90565','41862','29781','23443','66372',
                          '58432','82573','63284','99119','78865',
                          '42522','58712','26021','79532','32756',
                          '20898','78953','63382','31533','86242',
                          '26010','76756','32500','37689','84911',
                          '95628','54384','38825','85820','46478',
                          '53504','81936','32602','87069','33743',
                          '30626','66110','11919','81270','56072',
                          '51234','74519','83022','25925','17252',
                          '37938','19845','17188','52365')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


