
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '37178','30895','20602','10421','33406','56998',
                          '38510','76198','65519','76896','63434',
                          '62531','98665','45503','28652','37072',
                          '37621','76465','58192','30943','86963',
                          '78066','53748','46552','32338','41960',
                          '19433','53625','32339','46180','66776',
                          '92038','23170','93257','74461','30860',
                          '36051','65122','62878','48217','97791',
                          '90341','90060','49538','16419','84249',
                          '58634','69072','33235','43051','45076',
                          '81009','30252','23686','84386','61421',
                          '94258','14874','65745','54078','93963',
                          '86542','78498','16736','83550','84817',
                          '68564','79880','88711','24567','32280',
                          '27636','90696','34474','92647','10000',
                          '86996','82545','30022','39833','37095',
                          '72760','40420','60199','99910','97276',
                          '51079','76990','94358','65601','87046',
                          '52455','43251','65678','12224','32449',
                          '64429','85485','45155','15448','40469',
                          '20540','80049','79413','48642','26927',
                          '63939','19555','16222','59217','79082',
                          '30916','29238','46323','73353','42112',
                          '31833','59884','85615','57591','31267',
                          '34108','78520','93444','59747','41141',
                          '76204','75729','41115','98759','90120',
                          '74362','93525','95007','86533','38272',
                          '82856','97312','37803','74206','16285',
                          '45617','90244','13922','48949','46138',
                          '72764','14941','53811','50776','93654',
                          '12394','19170','49008','60668','43356',
                          '31454','53201','33376','56644','53211',
                          '42568','87852','12280','75863','87683',
                          '45421','52707','99801','73273','88681',
                          '84950','65151','69238','48800','58503',
                          '63675','77125','45945','55025','74453',
                          '98942','27331','48201','91456','11454',
                          '11633','29170','23298','42214','27981',
                          '46555','86382','69611','12426','59917',
                          '10238','41400','67853','24562','39989',
                          '25340','97787','10797','19831','45165',
                          '88002','40960','43380','41616','14347',
                          '56787','60596','15857','98263','82725',
                          '36424','48831','26773','79791','82085',
                          '30727','38171','53444','58527','51341',
                          '80686','72264','30621','92176','40981',
                          '43037','62441','79027','28378','12673',
                          '88834','36484','15723','11237','75557',
                          '40605','68586','61467','45631','32940',
                          '60069','59665','45303','59100','75501',
                          '10386','67862','95037','45704','60764',
                          '88845','40182','84642','40690','21276',
                          '57994','76293','20464','86086','64396',
                          '78116','43990','79966','50941','52357',
                          '54437','35597','73051','75283','18978',
                          '90214','56693','91883','34979','20642',
                          '46608','64140','94976','91985','70069',
                          '34319','80505','35699','81094','72936',
                          '15715','38907','85305','70440','44687',
                          '34445','39068','27404','85790','78884',
                          '51382','26103','35294','29825','58950',
                          '63404','22744','86713','47812','55049',
                          '55635','76018','64351','66175','29670',
                          '81825','73494','47599','53598','77629',
                          '81660','43400','63615','73313','70126',
                          '58497','24524','74644','56967','57268',
                          '53158','99084','90015','47073','22401',
                          '84024','35518','14034','90715','98009',
                          '53693','31505','94778','72067','42315',
                          '65872','11513','71839','10731','67738',
                          '52736','50766','14848','47862','12704',
                          '43464','36477','55613','70066','40729',
                          '79312','55911','22672','51131','61971',
                          '79149','82095','39242','74025','41292',
                          '59271','36460','23940','29976','44987',
                          '39140','10096','46715','65057','79440',
                          '72544','77825','80087','99997','15128',
                          '62810','55459','23212','40713','75063',
                          '94749','25476','62949','18556','84633',
                          '33951','36580','74835','63636')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


