
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '69924','49277','73865','70386','25227','56324',
                          '91505','50124','12472','59324','84216',
                          '59702','59837','79259','63527','80214',
                          '21623','89089','88764','71271','36515',
                          '38794','50447','37099','30821','38785',
                          '19202','16741','78913','97640','95244',
                          '56018','96666','40397','26101','74584',
                          '22310','17771','15444','11702','26341',
                          '16512','17153','22918','91740','16504',
                          '16777','40200','89759','53536','82876',
                          '76073','37956','59539','26297','58137',
                          '23072','70164','59322','48717','31946',
                          '32923','16525','25170','61404','20965',
                          '69449','34413','96534','55443','33159',
                          '53828','73301','81929','66160','81682',
                          '96768','81301','51686','21732','35918',
                          '45876','66669','65726','84689','24115',
                          '93619','22255','84401','63070','94700',
                          '97511','41139','63563','84400','92047',
                          '23208','21003','55840','23044','73691',
                          '37076','73763','79058','53299','28201',
                          '26802','83842','37096','82411','75173',
                          '20961','57174','13249','21910','22947',
                          '69850','81485','75689','41120','37805',
                          '91828','96971','11106','85318','39012',
                          '31724','31750','34359','75154','68272',
                          '36324','47372','55251','89431','36400',
                          '45500','25594','10131','61831','70283',
                          '16454','23005','68611','32233','33787',
                          '39276','85568','88279','47069','36520',
                          '94746','76418','49652','49829','33824',
                          '99286','10830','28900','71562','38839',
                          '67719','61355','36952','77467','14246',
                          '35741','73771','55541','62151','70065',
                          '28887','62659','97264','97623','55743',
                          '43666','55422','58636','65332','61462',
                          '87467','11827','84221','47759','51037',
                          '60197','51789','91381','73662','68718',
                          '68658','21267','57297','92569','17262',
                          '19695','75345','19355','21602','39087',
                          '15302','34167','24857','59052','42014',
                          '79403','44532','14488','75215','95257',
                          '59549','18447','23545','87230','93756',
                          '19566','39485','18195','17163','68293',
                          '48881','68754','96892','88662','28272',
                          '54405','49159','31103','91490','89991',
                          '30824','22779','94301','37873','31681',
                          '38985','52602','39751','45388','76221',
                          '83007','68626','38490','49421','18322',
                          '15831','46462','22997','85113','91817',
                          '40616','61108','92445','96352','52041',
                          '45930','91716','51117','47079','17216',
                          '23553','16619','17549','94246','90368',
                          '85498','18235','85124','67423','88718',
                          '27294','16248','89076','10323','47106',
                          '79407','40760','21857','63049','33997',
                          '46617','90457','67395','54934','23031',
                          '13647','60492','72971','53528','65061',
                          '83441','32969','83220','69956','38438',
                          '25928','69418','40733','43397','40427',
                          '97519','20984','59458','48819','11749',
                          '91269','77422','62305','75859','70714',
                          '48281','51954','68124','57208','89037',
                          '27718','56070','64430','28388','51036',
                          '80430','59982','86249','34599','79234',
                          '46371','37700','93802','99417','84081',
                          '48673','30393','80632','15267','74067',
                          '13368','18495','88921','23835','68613',
                          '93815','18172','50018','17089','29724',
                          '76701','23918','88935','96384','94524',
                          '31527','72281','29959','31017','47976',
                          '74377','95888','70349','69512','10616',
                          '62636','35122','75118','43628','22821',
                          '19786','80222','24176','49632','94939',
                          '23557','58573','62466','80398','57432',
                          '21953','37713','86270','87690','28483',
                          '47721','62571','26734','88025','12927',
                          '90857','90269','31804','78666','99318',
                          '84261','91644','93291','75655','97753',
                          '93766','14502','39447','93512')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


