
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '21886','22096','57959','54801','78446','61102',
                          '70869','30450','53546','64559','84092',
                          '77597','65269','19699','14377','47375',
                          '21128','69505','88002','47841','11306',
                          '60684','35388','33752','28825','76349',
                          '68691','33550','32733','59460','19433',
                          '17784','10130','50744','86512','22222',
                          '56276','13855','14048','34729','82388',
                          '21495','43056','94921','12807','93576',
                          '27721','52097','85061','20235','73734',
                          '24172','10560','61878','23617','81923',
                          '21391','80561','63182','59257','54258',
                          '52918','55347','78849','29229','21070',
                          '34249','16694','78838','98493','62417',
                          '71919','14115','89364','27564','28554',
                          '83430','50304','71671','12870','38133',
                          '76894','86684','49951','15641','20088',
                          '13663','37978','44262','97492','75559',
                          '59046','62403','22365','42041','92735',
                          '19273','55581','21162','79676','13095',
                          '81481','73888','59596','99908','89780',
                          '88748','65362','95887','20655','65108',
                          '47580','98420','15697','10982','72224',
                          '53943','54074','40225','54932','89743',
                          '90806','65371','83484','22811','54431',
                          '74209','15420','70820','94407','69676',
                          '70332','56189','41110','84540','60845',
                          '68311','47046','40175','31649','41152',
                          '80890','40654','23878','63123','13333',
                          '42072','58969','83426','71945','91351',
                          '61881','87966','40344','14833','52157',
                          '70718','84978','76522','41142','56148',
                          '35774','21396','24266','65735','14334',
                          '93663','64590','11909','64769','21395',
                          '57865','58163','73852','83512','20360',
                          '73335','26215','51507','63980','36236',
                          '53777','63038','27418','47493','48862',
                          '61096','99304','13608','61973','25144',
                          '50186','13255','27317','99728','99137',
                          '61252','62738','24271','86805','43198',
                          '16385','14964','58784','12765','40222',
                          '22846','76363','85931','60310','99338',
                          '13881','14994','99271','36052','38772',
                          '76964','56679','52153','76510','24865',
                          '52465','36586','62481','96520','12478',
                          '59438','28760','78630','21764','44247',
                          '28640','20074','83116','83578','91769',
                          '56724','44020','64791','61766','60144',
                          '66146','99179','17866','35014','60005',
                          '57925','24391','41505','29251','48954',
                          '85547','98524','71554','57767','13260',
                          '27080','62683','78333','82098','73434',
                          '15428','37878','33850','75614','68425',
                          '61622','11585','58067','67310','65396',
                          '77274','50921','16170','99604','28097',
                          '62731','82824','47441','75966','71274',
                          '93548','38370','49111','13992','49139',
                          '21588','35322','66039','81510','26912',
                          '93724','29476','23304','14413','50656',
                          '35370','35280','70924','85137','69831',
                          '59885','34228','28408','25175','29493',
                          '19237','41663','72125','87426','77082',
                          '33760','71503','34241','79633','33058',
                          '57365','71688','42050','40443','61502',
                          '91754','58200','82794','99279','48090',
                          '53013','79146','74777','86881','83816',
                          '13143','23917','94935','83328','57726',
                          '82102','56046','76279','53675','54678',
                          '42476','67024','21725','64156','82265',
                          '42948','73206','30972','45833','92331',
                          '76105','62994','75089','73997','60821',
                          '79188','33368','95215','92947','34847',
                          '18406','47041','28944','80776','24680',
                          '10338','15251','15555','59501','12534',
                          '20471','74487','62805','65512','87451',
                          '26457','81080','69412','20629','34815',
                          '89845','62974','43468','24828','23880',
                          '41355','63374','65350','35579','32006',
                          '50476','59315','36569','80061','68667',
                          '54822','28028','44486','67008')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


