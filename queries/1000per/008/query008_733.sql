
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '85648','75652','39686','61061','64947','35490',
                          '45470','95907','14408','94996','51814',
                          '11752','18876','13462','94275','87399',
                          '75152','94060','31437','21906','54239',
                          '89844','40119','22471','81978','78055',
                          '98105','15951','96317','33088','72744',
                          '54098','63236','74942','72181','92893',
                          '42684','90161','61529','97664','38232',
                          '36437','41760','50778','98288','32766',
                          '86949','49033','48614','57239','52204',
                          '77779','53125','70498','99774','61958',
                          '99786','45564','91389','39908','30688',
                          '80037','14425','49763','22116','98842',
                          '86601','22756','27830','33393','98221',
                          '60917','64125','43055','32569','82374',
                          '84520','21088','96749','14134','32502',
                          '74928','33615','66507','71882','52978',
                          '86117','37751','61896','66292','63468',
                          '87167','39634','93688','60935','13550',
                          '83625','83041','21361','92375','81116',
                          '49197','95694','18528','77907','96833',
                          '46499','34494','50124','23441','31743',
                          '40938','75562','80597','59583','57956',
                          '71047','49185','83746','41122','49867',
                          '23974','96693','44345','38499','48698',
                          '22121','77880','52696','52006','21124',
                          '77266','95857','73253','57805','11916',
                          '46028','67369','45603','24621','57371',
                          '14587','23486','63516','46839','84350',
                          '72039','92079','15860','41956','45156',
                          '12962','41461','88574','98736','36186',
                          '40273','72445','78173','33792','84853',
                          '46694','99960','60503','99434','62620',
                          '22589','15587','10287','66144','55313',
                          '98496','57165','87607','65681','36499',
                          '81730','66872','67042','88151','67106',
                          '77830','58139','43013','71397','58958',
                          '60506','96700','57611','55822','32359',
                          '37361','81479','49192','97878','29347',
                          '77086','37382','20928','61635','83653',
                          '43217','16868','94094','26634','67306',
                          '92886','53898','45941','17226','10678',
                          '34193','97282','54354','52141','76444',
                          '82531','11463','90794','86747','33852',
                          '77897','94705','57483','47981','82324',
                          '85143','61564','28127','66893','63981',
                          '18694','67026','64994','79155','46501',
                          '28730','37691','29702','55973','94864',
                          '93290','64175','27521','91188','19022',
                          '82252','75082','14914','24423','39265',
                          '94796','19683','68000','90641','40232',
                          '47128','85651','75686','36673','36911',
                          '52789','18092','18172','47057','47297',
                          '99968','69246','55283','86140','78280',
                          '60441','35161','88753','93978','73335',
                          '73751','37177','40191','67532','95479',
                          '25263','24018','24314','81455','59259',
                          '37539','26151','84238','53240','65536',
                          '78024','27296','54706','52983','95987',
                          '46217','87197','11956','78099','12230',
                          '29174','91779','95723','71454','44063',
                          '52628','83248','24041','45055','38021',
                          '35887','62056','20591','86822','84790',
                          '75638','62032','74765','82914','79285',
                          '38475','24892','62228','77824','24918',
                          '92636','54251','88287','20962','58425',
                          '88937','87787','80188','71399','43182',
                          '50485','67088','36281','56442','15149',
                          '65626','13226','45747','34938','92996',
                          '70588','95300','24052','38084','92097',
                          '46921','11144','85435','23176','27201',
                          '39699','67292','17704','93614','12953',
                          '65603','14714','99406','85119','38578',
                          '35553','86297','67998','96667','91108',
                          '41831','88552','59154','21496','16494',
                          '86523','52676','46135','51727','63953',
                          '89569','13426','83453','88564','24429',
                          '88761','61446','74301','47209','84169',
                          '10491','44364','39665','42957','26810',
                          '62460','46179','87079','90126')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


