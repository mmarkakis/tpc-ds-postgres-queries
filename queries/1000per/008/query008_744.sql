
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '23480','86053','45798','13228','29220','10420',
                          '10616','37754','14361','90393','19760',
                          '98982','51921','54012','20934','40089',
                          '36852','82383','91195','40431','64564',
                          '39875','95784','92978','56100','14295',
                          '21424','43585','47622','78640','32457',
                          '94090','70199','45545','74514','47623',
                          '60275','48755','75696','28964','93859',
                          '79373','12737','82268','92275','55012',
                          '31441','16693','48923','18596','40837',
                          '39192','34652','27999','88662','10503',
                          '84162','88327','94393','32428','12035',
                          '44504','10434','12372','63251','33629',
                          '82076','78956','19468','29677','71396',
                          '63163','43342','46845','78961','74184',
                          '82393','17000','36308','32560','34394',
                          '17939','65084','47560','54220','23968',
                          '50651','63823','38740','15909','41952',
                          '93984','58546','53126','46199','50722',
                          '91973','77036','87749','15652','70816',
                          '65142','16218','82705','53387','37526',
                          '63073','88657','65764','56996','91986',
                          '68247','63419','54141','32295','20401',
                          '44506','20522','20397','33231','34600',
                          '37829','63440','58678','51848','58779',
                          '18229','16947','54436','39598','36534',
                          '14838','53926','13849','94493','39533',
                          '89252','81353','48279','19516','73930',
                          '88479','68856','44411','57947','29904',
                          '85353','10154','68670','27061','44755',
                          '98545','36709','83311','89693','58576',
                          '91264','46543','81693','99000','87309',
                          '65280','41670','27972','83657','97272',
                          '66537','92773','61290','95557','97025',
                          '64318','37646','75961','69349','65136',
                          '65128','93870','75559','26611','52872',
                          '66927','49075','40868','84613','28595',
                          '38704','33045','99344','49477','46585',
                          '48564','37892','69456','33876','12104',
                          '65836','95494','96290','83137','60226',
                          '91412','18724','57787','67622','87517',
                          '91078','16902','60928','46725','34684',
                          '20121','63536','91211','81333','35399',
                          '93718','17781','59859','48056','39614',
                          '48539','79005','16726','22203','64867',
                          '78643','80578','44018','12492','80429',
                          '61178','73716','13723','14362','29655',
                          '71169','62958','23227','69549','84475',
                          '83766','95354','36306','96823','87723',
                          '23692','94721','43976','40074','68204',
                          '98724','73127','54773','18877','62339',
                          '36151','82842','12597','63982','70524',
                          '98621','56562','13075','38413','95323',
                          '69512','40121','86714','54450','35538',
                          '37023','34086','27279','44035','30000',
                          '32990','30446','45652','89878','18706',
                          '66661','32228','64835','90799','43606',
                          '75246','58322','64664','24710','77535',
                          '30911','96160','18248','59338','54535',
                          '81565','53765','14379','30576','31856',
                          '19423','79657','78926','97334','47439',
                          '11917','51636','10988','87156','20473',
                          '16480','76853','18158','12354','74794',
                          '70854','60120','24117','53202','94084',
                          '85568','35686','55998','62587','17775',
                          '92256','42370','81518','15311','72489',
                          '77141','85596','30487','24901','89987',
                          '97788','88685','10138','55579','92447',
                          '35441','36215','37552','44467','11274',
                          '95914','26668','41639','61571','94304',
                          '60013','89473','50159','21101','74745',
                          '44096','20204','66856','46602','10238',
                          '40397','48621','80607','91058','71394',
                          '21342','81409','90947','80077','34106',
                          '90007','73530','80861','46682','25281',
                          '22003','68082','97814','85720','26900',
                          '36453','21469','43674','29208','37537',
                          '32225','72703','94380','17263','20059',
                          '81622','25933','58636','74791','65110',
                          '91942','42693','80785','55492')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


