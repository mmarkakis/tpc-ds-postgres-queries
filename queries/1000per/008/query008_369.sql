
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '62079','21220','19579','21045','16238','12769',
                          '72749','62414','86290','16605','84515',
                          '70218','69282','27655','82798','73427',
                          '31447','99374','37505','65979','73230',
                          '74539','20585','78314','63479','54104',
                          '97963','63077','65549','18545','69651',
                          '64342','34025','57711','59090','15660',
                          '35786','78660','87921','94847','54619',
                          '23313','79075','63659','39855','45850',
                          '76733','95487','60226','87147','41541',
                          '62908','44744','91773','65608','14205',
                          '75777','51125','29224','76265','92662',
                          '88236','34472','59455','39112','68115',
                          '25100','28571','44347','27568','99742',
                          '53171','47785','40286','13883','50096',
                          '53839','59731','80756','46718','54073',
                          '66616','18413','68015','99628','25941',
                          '89126','97233','60936','41668','82289',
                          '40368','70944','87233','37833','41873',
                          '70450','73359','89185','16526','72854',
                          '75452','95417','19181','48539','92985',
                          '82359','38562','15493','40644','93047',
                          '23969','51543','37916','29732','93546',
                          '46172','99368','28288','56594','90603',
                          '91698','53546','71513','11660','31690',
                          '21877','34524','67147','55836','68593',
                          '63637','95640','83147','34254','25807',
                          '48025','29609','63820','57787','51398',
                          '57545','94695','62123','39355','86014',
                          '62045','31033','88733','16875','38716',
                          '71481','26474','72438','41345','71882',
                          '54961','18890','18554','68608','93234',
                          '55684','62465','58307','64203','55103',
                          '67288','38566','65556','52065','50134',
                          '58075','62545','91140','85451','61480',
                          '40975','20425','65065','34718','51488',
                          '57023','80679','17941','75781','35247',
                          '30184','18512','75094','31757','86778',
                          '43213','48807','36277','53011','94044',
                          '81748','58718','59318','27889','13696',
                          '95572','85001','78174','98040','98741',
                          '14740','18471','49651','34369','16826',
                          '40443','20888','37057','29476','57231',
                          '23919','10192','43021','92427','12585',
                          '92883','17271','93900','22332','68320',
                          '26288','81619','86972','28104','21713',
                          '27346','50073','29980','91186','24160',
                          '38561','19827','91548','59151','19937',
                          '36964','86783','21110','61332','10649',
                          '51677','54642','94099','89777','46064',
                          '81203','74399','17243','64885','73267',
                          '16288','58508','74239','47927','48562',
                          '26649','12583','76757','21524','96500',
                          '74613','77143','31244','70466','64186',
                          '52597','78109','50708','30123','42149',
                          '27854','54750','73885','77541','78577',
                          '35051','11387','21630','96630','37867',
                          '76778','19274','63683','19693','71458',
                          '97255','72127','10663','64675','30003',
                          '21100','62829','17144','32067','39870',
                          '37557','71110','82910','11876','26308',
                          '91423','84737','36303','58158','90119',
                          '13842','20638','64238','69905','75160',
                          '92458','90457','87328','88780','85102',
                          '90161','83018','93076','76447','60094',
                          '93904','16451','21445','35828','69720',
                          '27261','56360','51302','58994','86598',
                          '29813','67064','27988','58567','22305',
                          '39746','62927','80896','99708','58056',
                          '59340','41557','51582','16098','38689',
                          '30808','24165','74379','82329','83799',
                          '61533','51069','59913','82915','91550',
                          '23718','82005','17792','23043','14655',
                          '54565','97495','35271','79797','32516',
                          '23518','90888','62056','73843','37899',
                          '28987','89335','31311','22930','41582',
                          '75903','47874','54313','73940','13254',
                          '27390','75497','48120','86872','29831',
                          '98478','95326','79527','10389','68455',
                          '38925','25099','79810','89984')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


