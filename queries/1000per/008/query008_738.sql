
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '93591','28693','37584','78086','36791','54032',
                          '99928','70959','80945','70075','90122',
                          '85104','54436','37277','18020','19196',
                          '16358','11907','33992','31572','88293',
                          '60884','26457','43245','67864','77695',
                          '45608','24217','95951','87009','91328',
                          '10320','86672','58449','96840','72352',
                          '12675','14488','24510','12544','57068',
                          '27764','99483','78143','29331','81131',
                          '55796','40578','46855','68388','73659',
                          '87629','16244','39744','88481','81795',
                          '85677','53125','78957','21465','66342',
                          '36872','68228','56781','16411','82083',
                          '36918','12484','40573','65858','15415',
                          '58009','15245','16180','91252','70662',
                          '96307','96273','14937','86873','90324',
                          '42597','21489','66129','79704','58731',
                          '24444','47651','10032','51719','17745',
                          '64639','33400','47230','39806','15652',
                          '83068','83280','76847','90959','14185',
                          '98459','25324','89010','38457','54710',
                          '37471','65822','86321','27637','44810',
                          '62382','57994','92166','45878','87697',
                          '11350','29868','20758','60692','43853',
                          '17928','94131','97825','32656','18231',
                          '30351','51168','54549','45311','44589',
                          '87115','57540','33719','41366','18570',
                          '70220','96416','93696','84745','96731',
                          '49232','12428','50618','98436','58583',
                          '43084','61011','12112','68059','50546',
                          '54225','66919','17073','51493','67774',
                          '51569','60766','87661','38886','34115',
                          '89322','40200','89433','56036','25349',
                          '75019','26304','75545','50796','56608',
                          '48964','18724','99345','94368','62177',
                          '76849','69078','24472','37855','58857',
                          '42175','60294','74340','52987','11780',
                          '80814','29459','37197','25804','90408',
                          '19456','82826','80156','34812','20218',
                          '36177','64788','73363','12877','54753',
                          '65158','41467','72539','75121','79736',
                          '85091','42837','61256','85027','52784',
                          '45169','20348','45613','73463','54274',
                          '26433','35437','94393','26816','65705',
                          '60540','19093','78076','96955','56762',
                          '64478','23824','14665','90774','75336',
                          '34484','11002','77569','90237','28837',
                          '61520','28895','77182','43468','39116',
                          '85542','26347','78150','61146','57905',
                          '43720','48213','86002','86313','10617',
                          '70789','57170','16541','13578','79706',
                          '23898','36775','49272','77795','72149',
                          '50555','87195','28799','24224','21703',
                          '65916','35713','83158','54649','25177',
                          '86100','10027','87741','96886','62777',
                          '37662','95077','19353','65180','89996',
                          '37557','17065','58349','39448','83793',
                          '18955','50093','19942','17751','82174',
                          '93626','83729','97385','71819','34418',
                          '17099','94602','18503','55563','28077',
                          '39861','91086','82085','61353','15653',
                          '55427','67073','99636','67819','90343',
                          '80277','31727','53927','22543','34153',
                          '55852','50478','88996','27984','55099',
                          '51028','54074','65933','63399','23004',
                          '23029','56446','76284','88096','46729',
                          '72848','64601','20371','47238','97426',
                          '11032','11430','33996','74975','85727',
                          '92667','51975','59941','93069','84919',
                          '77139','19227','82532','87599','55575',
                          '92551','28381','44361','42435','46774',
                          '77868','71977','49716','11513','28119',
                          '28592','45563','52990','98685','97753',
                          '83237','36869','91851','84080','70343',
                          '47028','41649','32873','12205','20487',
                          '18496','54690','36246','99100','54144',
                          '30327','90404','63434','50668','92034',
                          '61086','58837','39750','34149','89441',
                          '58500','88828','73708','42853','21277',
                          '75213','62387','16364','15977')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


