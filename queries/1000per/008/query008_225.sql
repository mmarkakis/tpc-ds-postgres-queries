
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '53709','56397','21514','27747','29121','52124',
                          '70966','39426','89458','18821','47686',
                          '16242','50240','92466','43755','74959',
                          '90340','69552','93128','39996','84155',
                          '58998','22359','50472','12706','31451',
                          '85869','91647','10630','79385','83619',
                          '18872','43861','32729','37749','52972',
                          '75101','95717','41651','20382','21235',
                          '75298','11335','77394','90236','68427',
                          '46894','51801','49342','18854','99983',
                          '18385','19571','40742','54724','32306',
                          '73731','97207','73389','86331','59581',
                          '57870','89554','42786','60425','95589',
                          '65760','39845','76810','91431','93431',
                          '99651','11919','13339','95744','16716',
                          '52916','98225','83512','49083','22373',
                          '15091','91104','28909','81338','66935',
                          '45556','88760','32227','99529','75038',
                          '91096','22079','63748','33008','60628',
                          '82820','55284','65414','52285','65348',
                          '70903','57805','89593','76872','84975',
                          '93184','26910','95393','45003','12030',
                          '66648','82708','64769','43200','80244',
                          '16301','12208','68484','67033','74203',
                          '10497','34067','68769','81536','26698',
                          '96966','83933','30963','52074','66039',
                          '22871','20717','95908','28836','96456',
                          '68758','99192','19368','59515','41319',
                          '13717','27786','63660','75888','58928',
                          '48540','20430','17839','42808','21973',
                          '98658','61297','44746','57445','13143',
                          '41110','79405','39419','42743','90784',
                          '38645','45524','50558','13449','91148',
                          '96064','31977','73097','55752','42431',
                          '81427','99293','44144','69714','88689',
                          '87627','83482','68185','15000','59867',
                          '33719','13145','65788','74964','49996',
                          '92168','97906','31248','73834','19351',
                          '20559','76165','88734','86202','80840',
                          '47838','50944','36306','62508','62039',
                          '47778','53200','73509','30293','60395',
                          '40829','46451','88296','45895','25625',
                          '36103','94796','55286','11559','11395',
                          '50233','44908','16827','80088','38413',
                          '30917','20292','76543','48980','82482',
                          '69556','78279','31477','56601','84308',
                          '83440','59750','63144','45543','95203',
                          '80880','83496','64465','70936','87421',
                          '19666','74853','86926','51916','99701',
                          '46330','58812','54770','55556','36176',
                          '69631','27327','14583','44806','62522',
                          '18652','84988','44282','90661','22678',
                          '91476','40739','78140','13124','86719',
                          '91990','33817','55959','86843','71083',
                          '15258','33188','17160','52310','25547',
                          '85858','93145','69943','73600','60990',
                          '94654','76975','63629','46145','83965',
                          '96385','78322','91689','43364','80606',
                          '74933','90491','16766','78501','45170',
                          '65177','32069','30913','73653','30872',
                          '60172','86183','91399','20440','78946',
                          '60325','55635','66244','30909','18974',
                          '48642','41344','97733','32093','61134',
                          '43100','78398','62785','45387','83098',
                          '62422','52303','69269','54257','56931',
                          '75932','80158','13438','93568','75146',
                          '10552','94098','72024','89362','98761',
                          '29042','53821','12237','92107','87428',
                          '72808','22869','86718','68963','87002',
                          '47506','30320','27878','21039','25192',
                          '81179','52518','32786','19086','87083',
                          '63286','91599','47452','72006','39443',
                          '35616','37913','23874','77777','94450',
                          '88176','23962','13596','98971','79706',
                          '99521','94327','49784','48407','82358',
                          '64153','51249','78239','27226','24847',
                          '51779','43962','88727','93482','14751',
                          '39750','81199','36839','69469','33465',
                          '98942','12174','12661','88583','58955',
                          '86928','68698','31160','84096')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


