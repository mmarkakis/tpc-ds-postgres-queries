
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '86196','17850','37247','48291','97456','92559',
                          '57108','86098','24668','59382','86942',
                          '43795','61776','16599','78337','76825',
                          '76069','50663','38336','39772','71605',
                          '23080','94484','85283','59269','71972',
                          '95029','98381','82442','38133','24617',
                          '26170','27817','83361','79032','35511',
                          '97760','62044','52445','28511','77231',
                          '20743','93528','39118','61874','19736',
                          '84070','98332','39392','96238','53998',
                          '92275','94926','27042','69569','82524',
                          '43431','36773','17092','54154','53747',
                          '72839','45352','26524','20078','22605',
                          '95317','94845','77317','58519','84703',
                          '67299','69037','15102','54518','92788',
                          '49734','67334','11746','24173','18933',
                          '88921','85534','45698','56592','32333',
                          '86646','89717','36848','58938','79490',
                          '52934','94905','69828','27737','81889',
                          '68416','38530','40143','51575','60630',
                          '90769','24055','70287','96128','13916',
                          '46327','77605','73530','14393','90941',
                          '24744','86674','12597','71920','11122',
                          '73620','42798','83465','33461','27684',
                          '88213','35227','60751','62593','89029',
                          '83910','91075','97533','44444','94928',
                          '63467','92652','36957','40774','10101',
                          '95728','55029','42915','45701','12221',
                          '28399','27957','49793','72982','15653',
                          '45825','72919','78412','21941','69508',
                          '97792','57610','32524','25627','98968',
                          '59086','93678','35276','79932','73499',
                          '78513','15535','49882','31437','42498',
                          '89838','27156','55876','65780','50223',
                          '25120','48475','56612','94492','59026',
                          '40880','89547','46297','59445','45651',
                          '72103','17997','55115','50536','33258',
                          '88985','41357','72159','21574','15374',
                          '24882','25545','98190','37244','51024',
                          '12463','93138','74634','14739','71832',
                          '80057','48199','58748','75155','62775',
                          '65216','72972','81757','49373','51995',
                          '74481','39366','88866','46966','61243',
                          '99422','32103','85444','29256','28179',
                          '45443','24352','14024','31859','67968',
                          '27904','32646','17469','36334','53929',
                          '99934','50125','39702','43301','14116',
                          '55975','72984','85927','83391','83234',
                          '97124','22602','11125','21851','88826',
                          '47985','42580','44350','62687','78013',
                          '79332','45931','78600','35461','77713',
                          '63430','18731','76171','35525','38994',
                          '86597','86484','54431','40367','55696',
                          '12946','26384','87688','14894','12086',
                          '54627','84247','80919','11940','23662',
                          '25438','44454','90050','34286','91701',
                          '78011','62290','90131','92725','55597',
                          '64484','57730','32885','64869','86936',
                          '91637','37052','21542','51746','59954',
                          '12204','40292','84554','46348','31451',
                          '94393','11856','49982','58556','29391',
                          '17371','25122','99200','32863','78087',
                          '77857','64947','98493','26512','41468',
                          '27821','97520','18916','49333','14381',
                          '96223','84152','88047','61536','36313',
                          '20189','88342','62438','64749','74834',
                          '86569','92091','98048','27342','13137',
                          '64052','88568','15317','56226','22356',
                          '51257','99441','23118','98743','98622',
                          '61988','32132','15256','87705','83702',
                          '96446','64853','82584','46496','30275',
                          '45627','53192','11045','72124','97884',
                          '41956','87621','87948','80973','62307',
                          '44182','17867','73572','52691','50538',
                          '57450','89519','20226','88628','57575',
                          '67377','76907','38797','37143','82573',
                          '62207','42408','72771','83948','93489',
                          '81909','81821','67321','98715','48498',
                          '97189','43779','35646','46438','81226',
                          '78640','33270','73200','69615')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


