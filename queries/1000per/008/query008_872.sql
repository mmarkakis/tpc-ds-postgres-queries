
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '18212','81292','70488','54482','83001','95044',
                          '69416','56218','56018','15851','22240',
                          '38770','47042','50707','38677','40028',
                          '22106','22232','68749','75010','22864',
                          '66575','44619','46954','27311','89444',
                          '35002','28186','23100','66021','97597',
                          '90273','17459','37884','51830','66467',
                          '84389','23532','52269','92207','66644',
                          '11559','73681','15730','29542','67821',
                          '83942','49288','92639','92968','16892',
                          '11544','46190','90454','21379','68196',
                          '72376','93482','29723','46330','74412',
                          '37147','24322','62039','17359','42828',
                          '98478','49441','10135','28956','49303',
                          '37528','34325','96655','86187','41932',
                          '68823','12748','67547','95301','99514',
                          '45331','35099','91768','40642','54460',
                          '91471','17747','10179','51053','19479',
                          '55694','18548','45166','88020','19893',
                          '54968','49026','17408','31934','22186',
                          '14584','22048','70590','20138','84001',
                          '66530','50510','10428','38284','22579',
                          '91278','86523','46089','32445','55826',
                          '34755','31803','63401','43609','47666',
                          '81408','81669','34926','60699','59027',
                          '51086','92718','96902','84983','53850',
                          '72404','39470','70301','63941','97024',
                          '84805','14045','75840','34711','46595',
                          '73945','32277','23265','15291','82613',
                          '63815','64827','49338','99239','61829',
                          '17947','42136','75103','85278','81840',
                          '99960','89325','32917','53574','73593',
                          '58180','19399','38500','43488','81838',
                          '60739','76867','76461','39915','30480',
                          '66309','92487','67376','66064','47157',
                          '58960','54504','14055','64074','85329',
                          '67353','41414','73623','33377','71891',
                          '63546','87613','32506','54442','96336',
                          '74741','76232','35863','76928','59969',
                          '76170','51490','40446','18946','13728',
                          '33502','43778','77312','89090','28229',
                          '49168','81505','34859','46051','25931',
                          '78718','77708','82164','26036','93822',
                          '54717','21815','34857','56681','98974',
                          '74804','60132','13353','24865','42071',
                          '26881','18987','56346','67818','22247',
                          '92996','44227','33621','25488','41362',
                          '64109','34752','63506','83819','86283',
                          '42624','76983','35559','95530','51274',
                          '98526','34362','29492','86237','48827',
                          '24349','17566','66658','33122','74651',
                          '53886','54317','52416','75911','30645',
                          '60103','17027','85550','76520','40005',
                          '31832','36120','97660','44443','99616',
                          '32400','26523','17248','57855','88883',
                          '65939','84703','78045','19751','97779',
                          '29710','97633','84977','14151','65316',
                          '79987','19129','12269','65774','88534',
                          '91181','95578','64026','25169','95880',
                          '16044','77244','14358','22981','21315',
                          '13949','63975','57844','70873','76665',
                          '82256','53684','23770','84387','23748',
                          '97492','10914','77298','11455','85192',
                          '16375','83211','36568','26421','52422',
                          '71728','55987','98486','73221','58460',
                          '66150','61055','58642','59038','94614',
                          '47509','58430','66074','28146','91198',
                          '68760','14477','42886','86761','58189',
                          '75175','21374','32974','10025','76614',
                          '34829','13932','26109','72321','71545',
                          '13495','47644','48839','76882','52019',
                          '48312','61356','64278','88571','64185',
                          '18803','73978','27736','70013','31473',
                          '81641','79379','56232','16409','43087',
                          '12196','42179','95330','94055','66594',
                          '58570','94540','48903','15860','95957',
                          '13861','24699','67518','37530','87437',
                          '37400','98049','86051','78863','71826',
                          '82005','71729','41071','15770','24708',
                          '76965','70007','35935','71842')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


