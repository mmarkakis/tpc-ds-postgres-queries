
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '65037','91263','69542','51910','33753','42797',
                          '72758','54143','39694','95641','52001',
                          '55739','29993','93313','41664','98258',
                          '48844','10359','36025','33793','72512',
                          '82053','37786','77286','92938','24733',
                          '39411','56027','63487','53351','15820',
                          '55567','96976','35390','53605','94904',
                          '30091','81314','45361','90768','66551',
                          '79145','16414','68512','95615','90255',
                          '19181','17535','97933','15326','75803',
                          '10652','78683','17129','14703','84732',
                          '72678','37547','20995','90865','44897',
                          '11692','69901','35504','44918','68330',
                          '10958','17782','26437','97210','85264',
                          '82645','19185','94535','47471','33937',
                          '42532','23980','26664','10424','23879',
                          '33774','55547','45705','45175','41652',
                          '34972','73053','17728','64456','89880',
                          '50074','72712','35684','48976','92526',
                          '10267','29669','70102','72237','62623',
                          '72359','39350','92690','23966','83068',
                          '51008','38190','67594','47121','26944',
                          '73621','48729','63662','68095','66199',
                          '19639','90700','52587','14976','92007',
                          '35276','36352','15462','24275','41515',
                          '88097','52778','34265','68160','54215',
                          '64107','27479','98208','57344','21441',
                          '29932','25912','22572','90601','89427',
                          '37118','34147','63481','15844','95030',
                          '56380','82576','91304','87476','47201',
                          '87694','61316','48201','17285','71109',
                          '18176','65849','12991','98077','81541',
                          '69658','19609','76531','44166','53894',
                          '42278','36160','43479','58010','53730',
                          '55891','13576','86511','93027','79485',
                          '39135','58273','60130','45081','68013',
                          '72927','43220','73250','90971','34219',
                          '80159','93213','57783','47440','92779',
                          '44391','25451','36090','80234','43942',
                          '53592','85490','70798','24227','75771',
                          '16481','67128','51828','22784','53390',
                          '25950','35924','14110','14949','11779',
                          '11602','91542','70295','81624','90838',
                          '62890','28236','41061','24494','12191',
                          '60564','39508','84461','69316','35485',
                          '36314','31277','86354','15351','72801',
                          '53704','98839','19138','20149','14224',
                          '86742','66871','48813','69960','99471',
                          '84276','62454','31567','89205','73932',
                          '37025','76724','28794','65446','26070',
                          '78376','27473','14289','31844','44876',
                          '74730','13417','65334','41140','43886',
                          '42418','43674','76018','33661','19250',
                          '19771','97971','13662','39727','31852',
                          '65737','63137','73729','80960','73122',
                          '33348','22312','16208','99190','72021',
                          '63933','28473','73020','85094','11644',
                          '33172','85510','85791','64551','76244',
                          '43837','72450','39126','31141','45183',
                          '18447','49451','69636','73798','70570',
                          '67440','59359','29912','46846','68151',
                          '25762','64395','61936','74814','73189',
                          '58297','19761','92336','99458','34211',
                          '90926','38497','84921','37155','61563',
                          '17969','53559','64400','48803','31993',
                          '31129','58314','46344','84945','39150',
                          '16203','89789','90898','83356','72489',
                          '71054','47781','41427','18179','24287',
                          '30145','79787','72456','81387','99210',
                          '79567','22136','46182','15471','26499',
                          '85640','50799','70996','65447','57226',
                          '53655','67625','21785','58978','89417',
                          '43801','54061','42834','35164','38741',
                          '65914','76479','72479','71638','50072',
                          '60857','96171','92221','22667','40478',
                          '37362','85367','69103','58884','52665',
                          '66958','79119','52376','18027','77441',
                          '31514','50628','86052','83858','88112',
                          '51777','71242','17449','90731','38986',
                          '27209','55398','40226','26116')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


