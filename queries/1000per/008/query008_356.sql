
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '93145','93823','91981','83589','65220','13508',
                          '98363','67080','36009','62621','59008',
                          '98908','67478','97852','49751','54857',
                          '58048','27016','23136','13634','59654',
                          '31600','39580','13519','56746','22901',
                          '34804','28050','18708','58196','57978',
                          '18646','77640','81724','90291','41796',
                          '15249','39740','65442','72591','16005',
                          '78435','42303','55105','44091','19614',
                          '30719','15786','97923','12601','67550',
                          '91870','77148','17445','89905','64638',
                          '83944','57204','59785','79598','40444',
                          '65413','37507','87181','24666','72843',
                          '54509','48911','64118','38301','44615',
                          '60758','26821','67130','61919','66439',
                          '75426','87468','10096','82779','84834',
                          '74321','99243','27550','24034','41343',
                          '96300','14069','62508','76112','46518',
                          '44683','49595','45859','14514','92625',
                          '20416','53004','50898','18349','41278',
                          '15559','85687','26938','63315','82955',
                          '22637','23990','11800','66747','36469',
                          '87045','27742','69220','71331','27115',
                          '42280','68046','81930','11651','97388',
                          '72881','33496','74284','54012','28182',
                          '88238','15927','98381','83885','83084',
                          '33806','53213','82323','41124','69324',
                          '39900','14126','29567','98391','89179',
                          '50144','24122','96057','40212','67277',
                          '44040','45628','16971','78584','56290',
                          '24264','62685','46976','24755','34526',
                          '57376','80458','74920','99770','49811',
                          '56742','64384','54099','59817','32516',
                          '27740','81557','76590','97335','51843',
                          '36834','14816','27635','21574','76256',
                          '93593','16263','80561','14699','43990',
                          '59531','46708','97521','18679','35485',
                          '38507','66882','92676','59355','26817',
                          '55973','96979','83650','24032','31353',
                          '97800','39135','15741','79499','60987',
                          '12458','45753','91630','67056','45035',
                          '27937','20223','15285','48314','85715',
                          '87494','55092','38230','24592','36652',
                          '12067','88436','48292','24309','73620',
                          '28979','29735','81445','56358','64463',
                          '70608','62070','32794','11967','93224',
                          '27106','11196','14444','43573','62688',
                          '74209','63587','89013','20633','35977',
                          '73705','47510','96160','72292','81877',
                          '40099','94153','89062','44355','89557',
                          '97229','41502','84629','85315','65795',
                          '66666','59649','29037','70491','16078',
                          '94568','33013','56730','82283','50532',
                          '53565','82259','86236','31125','99457',
                          '31816','39468','92994','12595','67801',
                          '18098','40277','41577','56595','79147',
                          '66301','42290','94078','26232','62284',
                          '56402','69822','88285','31813','96931',
                          '85006','81095','64500','51991','47331',
                          '22609','33848','40900','90803','65484',
                          '22322','99900','53437','85495','32103',
                          '91375','28196','80378','62122','49821',
                          '13884','10716','28124','94138','78194',
                          '82424','86582','58704','92072','52894',
                          '95559','10559','89859','30461','45511',
                          '19199','97760','35093','69780','46501',
                          '68070','90081','20999','99550','76691',
                          '31267','44659','89077','48293','74263',
                          '25996','66841','78262','77932','79930',
                          '74572','42316','67695','73628','80285',
                          '88960','44553','66128','29417','82414',
                          '62106','60438','10895','96715','13051',
                          '66680','47862','46742','13697','45777',
                          '47670','13363','13756','50919','37687',
                          '37241','36586','68259','39144','95411',
                          '84042','74948','70092','77714','44704',
                          '98612','22666','30125','25312','22002',
                          '40721','58873','29663','28398','21196',
                          '72515','45745','14038','22821','51963',
                          '84788','29055','53114','92463')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


