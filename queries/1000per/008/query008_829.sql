
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '91817','61321','70350','95657','80185','85488',
                          '49972','38157','96629','78459','34524',
                          '31837','76007','78377','44088','18756',
                          '14373','99700','61493','16948','64680',
                          '40428','98492','75394','39949','40345',
                          '10982','18045','69364','62594','80911',
                          '53226','76611','36812','64546','53330',
                          '27669','74929','47574','69926','96572',
                          '93973','76024','62147','99939','88463',
                          '17288','82539','87374','85457','41995',
                          '45286','94715','80154','63184','99764',
                          '45165','48612','54758','33201','51680',
                          '53071','89264','48691','74678','47412',
                          '16354','94753','27184','86341','44665',
                          '24549','43596','93913','70674','73750',
                          '26501','77565','44527','74737','51519',
                          '98550','72997','80678','79048','66845',
                          '92915','65157','77473','54724','78451',
                          '95023','55250','54902','93409','89437',
                          '15356','98960','42097','44959','64772',
                          '80800','36174','12966','22050','88558',
                          '44968','85531','66363','46490','21169',
                          '94742','88935','80654','67678','67480',
                          '57376','36592','78404','82639','99403',
                          '46697','84281','52433','71248','14974',
                          '26586','23070','92104','82281','91916',
                          '13198','18639','70460','34443','30161',
                          '71723','81157','30175','69227','87527',
                          '87976','52322','16839','10616','52362',
                          '25298','31850','65831','52431','32804',
                          '27188','57216','35574','85738','85948',
                          '79275','92437','72846','71448','76255',
                          '50315','88954','83996','41840','64249',
                          '23249','31046','61359','73204','18656',
                          '83252','28013','37230','77741','51536',
                          '26658','90747','52961','56309','58523',
                          '58432','71883','20474','72881','75903',
                          '47851','17892','24337','55941','45409',
                          '53266','34415','10804','61431','51627',
                          '34947','37371','90101','40378','16377',
                          '25954','85470','70398','64836','87535',
                          '25838','74256','34049','77729','44818',
                          '75195','56177','22626','63369','81843',
                          '67251','19387','50071','92291','36569',
                          '27095','56779','70989','42955','63175',
                          '74369','14883','33680','24453','90589',
                          '19506','68768','96252','80142','83591',
                          '80148','66795','92427','32951','70131',
                          '15496','95211','35994','44367','54727',
                          '28782','37413','83183','50946','65611',
                          '58044','26619','44807','67935','25173',
                          '96804','12697','39689','53659','31691',
                          '12257','70982','62211','89870','45084',
                          '45434','84606','93714','13341','93235',
                          '40531','58941','99656','81486','47894',
                          '34382','38771','16863','68242','55601',
                          '41220','69257','14402','87401','80687',
                          '19036','63003','69561','66998','24524',
                          '10711','31314','29431','37553','15514',
                          '18601','86543','37157','77310','26602',
                          '25345','50482','62565','91661','19922',
                          '79982','18733','56774','39615','35266',
                          '77555','89577','96170','35049','53084',
                          '39913','34948','22592','75973','85186',
                          '95534','69484','22336','61328','45432',
                          '49000','88339','21129','83394','62737',
                          '74307','86498','48164','22502','32077',
                          '58186','42899','13052','10592','22415',
                          '64792','63301','15527','43848','31163',
                          '76642','96839','97804','73334','74288',
                          '55673','34120','39567','16958','56931',
                          '41272','98259','13654','94170','67769',
                          '10972','67296','18000','12064','78015',
                          '80723','77682','74950','44389','48498',
                          '97534','93524','41378','55214','65842',
                          '48439','64113','66423','88777','27953',
                          '14341','86866','44003','85046','36539',
                          '12755','27449','38991','44034','87335',
                          '57091','94668','37339','49389','15890',
                          '83219','53792','86793','27835')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


