
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '57141','32444','52307','67197','60967','82310',
                          '89718','94807','22192','80220','97539',
                          '65747','57650','83656','51067','38429',
                          '76905','73803','21912','31258','44095',
                          '65514','95481','20847','82761','42443',
                          '73371','20488','56918','68141','58337',
                          '63575','73303','37031','29011','46580',
                          '47773','63038','30282','99955','75138',
                          '57244','80881','65201','74096','44665',
                          '77814','68995','35013','34644','95944',
                          '82169','42429','65308','77639','25815',
                          '13604','63110','93007','81623','90001',
                          '32626','16156','77253','12270','89595',
                          '30654','96304','70849','25277','84962',
                          '69135','67164','44055','70359','34985',
                          '86411','73419','63367','21444','13902',
                          '55895','43606','58644','87012','32557',
                          '90382','10661','13278','22281','46839',
                          '87633','33926','16264','57130','49965',
                          '32658','66395','55717','55473','41486',
                          '44853','22271','13252','25156','14551',
                          '25006','41836','57467','10955','14273',
                          '87489','60423','74533','54303','62866',
                          '41807','14792','38488','53403','65104',
                          '97784','30418','85485','10582','82434',
                          '74931','73642','97276','74654','52146',
                          '88496','59673','99318','99497','95784',
                          '94587','85238','58790','16845','97630',
                          '32203','41878','62377','43260','33884',
                          '58354','40414','78896','18835','63849',
                          '53988','32928','68993','26689','63162',
                          '90079','86075','74652','95430','90448',
                          '58001','54207','20039','41911','44626',
                          '56535','16884','98543','12914','46071',
                          '36469','20300','71556','53657','77640',
                          '30496','68854','56353','99141','30558',
                          '69661','59166','42185','61157','76556',
                          '81110','27034','41366','27272','44026',
                          '11843','44223','53894','22151','98139',
                          '82775','14816','62437','29874','81428',
                          '70625','78621','37920','83441','42889',
                          '24378','83866','91446','25178','75640',
                          '92070','56175','22652','90125','47404',
                          '13028','62574','41094','29355','72905',
                          '72235','59341','55233','55008','28201',
                          '62601','22246','68876','69910','32688',
                          '70239','43039','31938','33404','77115',
                          '70435','77038','92470','41743','12393',
                          '75883','58499','69588','95438','55340',
                          '36229','81784','61961','97131','23925',
                          '94985','20788','38723','95748','56001',
                          '40510','60621','13771','46486','77661',
                          '65656','24315','37517','75448','65791',
                          '80889','48777','58139','61279','27083',
                          '52315','19516','59295','34407','58533',
                          '58329','96428','43640','82724','18784',
                          '40764','48778','21127','81507','34221',
                          '26767','42363','80630','40221','67914',
                          '56937','51989','22344','51642','37417',
                          '57313','74913','79229','70744','90117',
                          '68055','51788','62077','43657','14832',
                          '36427','86394','86639','78050','23773',
                          '79164','16913','64017','38575','95602',
                          '99830','52346','52840','89427','67175',
                          '51276','28085','25038','95032','61504',
                          '33482','17466','25704','75994','62393',
                          '35602','17273','75013','51182','99956',
                          '98073','11939','36580','40602','86770',
                          '61889','38815','33476','94730','52742',
                          '81717','54819','26931','48989','11995',
                          '74004','78367','86622','64600','69967',
                          '47679','99361','84006','43193','23075',
                          '91975','88606','10021','25246','48673',
                          '54043','68922','34768','60057','81642',
                          '87395','25278','87312','90078','68329',
                          '35173','11393','28083','54573','78525',
                          '25452','27320','52266','38235','68110',
                          '31247','27939','32866','38262','33107',
                          '62636','85544','95303','62278','59747',
                          '22505','87434','14683','10749')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


