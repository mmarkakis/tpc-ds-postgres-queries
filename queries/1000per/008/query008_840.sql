
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '87860','97220','56813','53215','62799','63997',
                          '87850','68414','21239','47663','55698',
                          '99816','13793','95175','20882','98995',
                          '84481','44309','48594','16648','20338',
                          '45886','12551','87159','44047','82696',
                          '47584','15843','79434','98548','22017',
                          '94788','14299','59164','47937','71550',
                          '62344','96271','42318','69156','66912',
                          '23651','41439','20699','89152','13809',
                          '80797','35060','89150','44686','94029',
                          '45103','49165','25404','66340','57499',
                          '28074','46693','77016','56730','91514',
                          '40360','46644','35548','59496','89396',
                          '59861','55700','37708','34603','52896',
                          '88667','55566','19166','59680','80262',
                          '60133','56958','58850','17612','17547',
                          '24572','45804','77292','65809','99383',
                          '88440','87425','18116','99160','89892',
                          '85193','94810','59053','14810','62278',
                          '33983','58538','49027','78083','21341',
                          '92320','77844','36477','59682','33839',
                          '29802','96013','76153','17140','35416',
                          '94626','95825','76892','78366','51087',
                          '92325','94614','12675','52762','86152',
                          '75755','93456','18182','71890','29246',
                          '18743','86836','37500','37409','72595',
                          '51255','75331','28222','12062','71736',
                          '39795','65403','83243','35849','20304',
                          '51950','36404','23727','98256','86794',
                          '72362','55746','14152','14965','80763',
                          '54474','51162','38904','80258','87445',
                          '96114','64530','90282','39999','76826',
                          '76804','17084','22565','55852','52536',
                          '55819','37770','26357','85689','86704',
                          '86264','44646','77515','76103','45093',
                          '54939','92885','43193','15132','91643',
                          '89373','95503','49384','85069','92285',
                          '78972','37459','14143','10128','76518',
                          '17756','63988','71210','90929','73053',
                          '55327','90205','10606','51267','65960',
                          '22654','95786','14284','67597','98956',
                          '25923','87535','37966','61192','72716',
                          '32314','58715','39806','92497','75990',
                          '31138','48684','60834','99576','13221',
                          '46581','44202','37494','30210','16299',
                          '36257','69285','50783','82106','33675',
                          '50122','43209','29856','96293','28481',
                          '11800','40694','81344','54991','45211',
                          '96887','78916','70023','71291','98200',
                          '49879','30638','12249','13173','67001',
                          '89798','44676','99157','39476','86033',
                          '29014','74189','32853','91489','28965',
                          '87952','37092','39734','80427','38701',
                          '73198','94530','39587','16373','82097',
                          '70188','60845','48068','69528','82915',
                          '75621','89899','14511','76926','65906',
                          '62895','55796','41966','94352','40399',
                          '14641','69834','39005','51911','38613',
                          '49093','42852','61720','77092','91740',
                          '19244','99599','97693','84946','43134',
                          '70527','68815','48759','86669','19980',
                          '88799','93621','85758','41679','21999',
                          '83034','40615','93561','63232','83374',
                          '82240','88279','83608','17004','14360',
                          '18938','55584','92022','14759','69599',
                          '59511','76318','71531','53325','55976',
                          '96306','59697','96261','94835','47466',
                          '30986','17091','87242','79453','80907',
                          '68671','99687','97537','43062','41356',
                          '52540','27859','37361','22219','73668',
                          '90389','86052','71411','14484','74437',
                          '60274','76340','62502','10023','30233',
                          '81086','99741','82743','46909','99106',
                          '17392','91682','92375','28820','93362',
                          '83819','18203','87608','93314','47186',
                          '49023','91242','28256','28425','70740',
                          '85207','67935','74859','82832','54544',
                          '65317','34564','11188','59780','99189',
                          '67195','65241','90151','84006','16329',
                          '51178','36905','77244','29028')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


