
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '24522','65641','64260','15287','15213','47158',
                          '38258','76265','54822','37811','74858',
                          '43670','49844','88766','15943','59586',
                          '78965','68911','49449','63763','61049',
                          '87552','30426','27888','63240','48589',
                          '56531','55316','36760','37479','75572',
                          '26263','66250','56762','57650','25847',
                          '14816','16761','75007','38240','49852',
                          '75944','99084','38750','66741','33641',
                          '17824','75112','29305','57319','25082',
                          '51528','43692','55241','59367','85516',
                          '65879','53614','97499','96235','90966',
                          '94317','51543','47817','59941','97744',
                          '27756','47291','17654','72963','42454',
                          '52672','24828','62191','46788','87076',
                          '82670','85447','96488','57508','34903',
                          '20853','30182','24457','24467','95741',
                          '26227','69891','27679','18071','24485',
                          '83541','84576','73227','69942','65256',
                          '48962','48749','71217','48608','83394',
                          '48289','88757','11071','79335','66734',
                          '95843','44795','32859','50877','51413',
                          '57438','47933','29066','79421','11993',
                          '15284','29728','56348','56817','14141',
                          '60231','65976','81637','69146','62842',
                          '52853','41898','14070','65508','45498',
                          '93063','21619','30551','78342','61057',
                          '37374','38413','73240','44302','88135',
                          '53518','83316','74415','82741','80902',
                          '23175','14354','41155','59519','25260',
                          '39614','69113','90721','56067','48696',
                          '73738','52502','22368','61693','88538',
                          '21869','17767','20132','49723','24651',
                          '70144','95791','38940','36069','15924',
                          '96197','51650','86151','45377','51283',
                          '48564','52159','63503','86480','49228',
                          '26841','12368','47967','26932','30113',
                          '22115','42232','89545','72259','15252',
                          '19936','92708','97686','66938','43921',
                          '24814','57834','34945','74367','61599',
                          '91075','78500','63883','72354','14189',
                          '77488','53195','65283','79680','74465',
                          '57838','31772','97375','47528','31299',
                          '42235','67752','81568','45947','40745',
                          '44380','56494','69098','53639','51210',
                          '47876','26556','16433','91628','99775',
                          '35753','26237','66707','39999','32546',
                          '12958','78191','23509','74406','92302',
                          '69817','70043','11385','73152','45732',
                          '17366','13070','26650','67610','61888',
                          '89727','29614','61594','33503','30150',
                          '91491','17041','91403','44459','62923',
                          '80830','39322','62223','99740','89351',
                          '72089','68681','74946','54611','92385',
                          '49053','87198','23847','16287','12488',
                          '94567','66827','54534','86945','97408',
                          '57775','23041','62062','21319','66738',
                          '11273','36703','45068','18635','60888',
                          '50340','42992','35697','30964','43729',
                          '44377','29060','61021','10115','61921',
                          '27478','16973','10732','64468','18835',
                          '89347','27910','37537','44287','28276',
                          '57085','59207','76292','84974','41233',
                          '65162','27972','55490','17941','76200',
                          '81046','77235','41267','37986','99979',
                          '52844','83169','96946','24351','40131',
                          '49140','36284','51422','64627','17500',
                          '42663','20153','26589','52503','50677',
                          '21362','37660','66479','32349','24768',
                          '30404','86432','68887','49062','67884',
                          '86368','13647','67962','52487','86146',
                          '57149','12791','66048','18471','34965',
                          '97975','72602','27375','58118','98443',
                          '37791','36301','70273','29783','26291',
                          '91732','70397','25054','45881','23827',
                          '91071','42300','83897','49511','29231',
                          '34230','71829','51558','48046','49906',
                          '80470','14739','72635','65676','26033',
                          '11829','65794','81992','32296','92281',
                          '13951','46981','48345','37614')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


