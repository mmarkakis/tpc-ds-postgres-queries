
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '91428','22820','20852','13185','75222','72034',
                          '60754','80739','68753','45073','31210',
                          '41613','99300','93939','49704','37289',
                          '77676','52233','17869','72592','87638',
                          '20428','60564','95084','82010','94731',
                          '63930','75526','16586','34299','81259',
                          '55729','18265','74009','65439','51594',
                          '97713','87231','94706','66262','90611',
                          '56421','96495','96424','29910','61291',
                          '82655','32972','12683','30618','43604',
                          '89507','49982','81561','76608','34516',
                          '36487','11886','99335','81471','61131',
                          '90283','65089','60475','96045','91794',
                          '65806','97261','33423','42958','74175',
                          '21982','45244','14023','51803','25807',
                          '26539','53551','52149','39281','16835',
                          '45291','88640','79124','45902','48504',
                          '24691','35506','62578','84849','61285',
                          '24256','21417','24530','45874','17400',
                          '30239','18592','65968','48899','97166',
                          '87045','25195','19668','86253','75557',
                          '72115','60499','99906','83194','77351',
                          '21328','26480','69082','75468','59789',
                          '78745','13939','48854','96577','40586',
                          '94018','97819','71825','86881','65600',
                          '72210','98055','18237','86449','78390',
                          '68707','59315','36485','15201','10009',
                          '29719','90802','64041','64815','71499',
                          '78234','54228','61644','79290','79853',
                          '34533','70735','94193','53694','41641',
                          '93173','26531','28988','12390','10819',
                          '42937','25039','99137','81372','15845',
                          '18162','35296','90236','62886','43237',
                          '69998','74536','97732','96607','75326',
                          '59938','24559','45697','38897','64567',
                          '55746','29195','23425','90438','87800',
                          '41388','62531','52878','57003','85666',
                          '59111','55301','86028','43341','87317',
                          '65967','24887','60712','59777','88265',
                          '15292','55977','55463','89534','61955',
                          '78207','74020','27654','36639','22801',
                          '76348','12527','89374','87851','61734',
                          '91912','23295','82474','20301','91728',
                          '44735','17597','88582','12297','16033',
                          '75311','81002','52468','14191','72288',
                          '62924','97923','94604','50289','10215',
                          '67286','27553','63468','24618','22315',
                          '24301','54767','68822','95234','90481',
                          '93349','23478','69928','82598','97205',
                          '93870','25566','76132','68481','94397',
                          '59913','27552','17898','43148','64167',
                          '58175','91317','40766','99542','93592',
                          '11513','83728','78257','88804','49491',
                          '69345','44741','26554','68516','53876',
                          '74357','80518','52924','72559','35155',
                          '94945','27096','13073','28807','59636',
                          '98700','58473','26068','45520','15517',
                          '13429','89682','48321','78809','44778',
                          '26750','92969','80337','64969','31964',
                          '42023','15402','43537','44288','56503',
                          '40457','74449','89582','16531','69439',
                          '15964','54098','72340','48953','58112',
                          '52937','25082','60988','76501','46847',
                          '48536','84902','50730','51200','59495',
                          '37024','74726','43288','76700','59307',
                          '21345','23076','28297','44148','80304',
                          '63290','93036','16661','40574','23887',
                          '28650','93991','70110','69401','92048',
                          '47626','52169','84216','78332','40533',
                          '76144','59571','16530','89774','22993',
                          '70338','80400','54571','37521','68911',
                          '33318','59970','17342','93020','35822',
                          '65309','89272','42738','66226','74920',
                          '61199','63193','76010','76606','71645',
                          '84598','45865','28778','85964','33127',
                          '56737','64049','36408','55430','24553',
                          '16371','30925','71595','60679','56375',
                          '18977','90761','61965','39365','51972',
                          '63308','93197','38088','20002','47681',
                          '84919','74554','96290','77374')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


