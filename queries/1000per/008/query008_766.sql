
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '54068','90787','63393','88861','79917','16827',
                          '81975','89676','10848','27455','59303',
                          '81480','95297','39821','20975','74207',
                          '37419','66161','46093','14480','95231',
                          '49712','71051','77630','91565','50180',
                          '32467','44293','14013','20326','89766',
                          '92264','13911','74578','59138','82502',
                          '91989','16622','66378','43531','22365',
                          '65150','81238','23556','62298','67756',
                          '98378','98985','39242','56266','28111',
                          '75024','13489','58899','13205','10307',
                          '45542','82230','99657','25626','59612',
                          '32647','85200','31389','53843','90629',
                          '56730','34317','87310','64158','38838',
                          '80051','87506','21133','77462','39200',
                          '68313','92531','28915','27082','78823',
                          '16799','24235','31846','92855','28526',
                          '58370','40832','37618','76655','40755',
                          '25990','44043','39409','39774','99828',
                          '97637','52669','87714','59942','56193',
                          '68513','69137','37838','89825','83607',
                          '41710','90369','87001','53453','65944',
                          '99183','67499','28275','85285','57313',
                          '35016','91622','50940','13891','79621',
                          '54646','46740','81884','33550','18449',
                          '55775','54240','39343','34092','11386',
                          '24609','56923','87066','40793','68658',
                          '59323','32966','97192','53393','66381',
                          '31522','89641','76054','11698','17815',
                          '18258','90550','88314','58756','58710',
                          '73134','56621','98687','19816','71022',
                          '77620','65138','58700','89915','26099',
                          '68835','72174','64188','94701','37505',
                          '94498','23207','95839','81564','36836',
                          '97097','73250','14279','74574','13087',
                          '67807','51162','92108','98741','73157',
                          '85459','66665','58648','15902','14300',
                          '35538','19669','82779','16586','33077',
                          '48206','90968','27875','45710','89699',
                          '62021','71591','92792','41670','79365',
                          '71198','51363','44096','67362','88242',
                          '84976','63122','28096','92861','76159',
                          '17430','72505','45319','35523','11343',
                          '15623','64692','64810','84978','16961',
                          '50658','42011','76666','41623','80099',
                          '16705','44427','97144','34928','67405',
                          '54588','72422','79703','42819','92083',
                          '65601','65616','62345','57494','92871',
                          '37996','74025','58959','16160','70660',
                          '78768','38422','97796','29965','15739',
                          '13539','77027','57761','49200','97857',
                          '18088','66504','67036','74106','60178',
                          '37698','47429','86045','77515','17163',
                          '20055','18298','17416','50716','46778',
                          '95973','14959','59291','45888','34962',
                          '28031','26049','46514','28001','85735',
                          '21791','40211','65591','55673','38586',
                          '10727','60286','29649','73407','33816',
                          '11008','74953','84385','37390','80373',
                          '73036','50124','27871','98858','60423',
                          '72711','52561','73008','75389','37469',
                          '84023','98657','35790','77640','22852',
                          '94835','17833','49083','62117','31138',
                          '11238','57831','77066','26411','18067',
                          '85616','12234','88677','20591','22891',
                          '67452','23766','50041','88115','25064',
                          '90598','90945','39749','60235','29225',
                          '61695','25106','86243','46242','31899',
                          '13525','35586','81675','44321','79090',
                          '83931','86634','16159','29892','11248',
                          '35212','43284','95040','19047','32279',
                          '30397','68257','40598','54702','57897',
                          '97308','33916','99007','39042','51636',
                          '82323','38065','24065','60897','69393',
                          '98601','95848','92400','11894','25784',
                          '32773','94124','42772','59337','77243',
                          '93019','72600','80777','71902','43208',
                          '70328','83694','84982','30115','91188',
                          '96655','83174','50737','26971','63620',
                          '86278','86268','25732','89590')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


