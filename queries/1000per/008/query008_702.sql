
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '33611','66503','69857','65749','75804','63111',
                          '85157','81350','74825','18391','81317',
                          '18614','26124','85717','41566','53565',
                          '20990','93695','98391','24125','46260',
                          '91016','56741','79986','27531','71399',
                          '30588','80672','82622','70459','19982',
                          '19893','45296','19095','96378','52566',
                          '66233','52852','64895','56443','96920',
                          '45029','82137','89453','89034','47598',
                          '82958','61181','96125','80414','82917',
                          '16918','53540','69404','59613','22722',
                          '68098','98995','78951','44378','49013',
                          '63985','31466','51316','60723','66046',
                          '46910','27645','33223','20880','58774',
                          '64499','24405','77942','89288','48008',
                          '10844','73306','66099','45373','48913',
                          '77565','59668','66392','73328','22987',
                          '32064','95526','85869','15843','22954',
                          '27106','30170','46759','46470','62887',
                          '64666','21515','72720','40909','88630',
                          '35354','66844','51729','39671','48905',
                          '90008','11187','86828','37296','23439',
                          '88642','70645','53636','53746','23791',
                          '15495','40332','92313','85654','37204',
                          '41255','30581','74352','64372','63491',
                          '60666','47500','45038','47374','56708',
                          '96823','33656','97731','21110','70188',
                          '70688','63187','44355','25547','47631',
                          '53750','18131','30180','12738','33298',
                          '45278','97965','44752','62344','37562',
                          '81814','49560','75603','87442','10405',
                          '44108','37447','97781','13640','70558',
                          '10865','61168','10793','77012','51372',
                          '49619','39284','61557','37929','20370',
                          '68293','86752','88375','73648','99144',
                          '24130','79713','36906','90499','17285',
                          '59231','48471','61786','93891','78292',
                          '55169','99574','12689','56944','57015',
                          '44711','98429','87019','84511','98746',
                          '37231','90206','79995','13367','68292',
                          '78047','93793','35355','94530','51194',
                          '75589','82034','98125','26301','19060',
                          '84176','32090','94781','10927','78439',
                          '18530','79413','28994','37631','20235',
                          '32624','61187','32342','24889','88597',
                          '78164','74707','97045','86018','25470',
                          '57677','86415','77197','66023','56045',
                          '29811','70868','40128','38488','73316',
                          '94246','49148','50815','69459','84565',
                          '67790','54001','86221','27674','58088',
                          '96187','38697','20119','19516','46313',
                          '71499','70118','11342','39211','58412',
                          '90363','88169','55916','28032','28581',
                          '46012','31010','43908','78684','59953',
                          '54194','53263','34735','91919','92074',
                          '93373','52937','50710','26374','56698',
                          '46184','85934','35579','50993','35140',
                          '73415','72946','41183','26621','79555',
                          '14247','33795','56089','78153','75798',
                          '17788','96556','86511','22453','40334',
                          '26307','23395','89146','89631','44848',
                          '17754','99132','64924','35939','39616',
                          '42204','68655','57798','85573','72479',
                          '48205','86419','87414','28499','80438',
                          '48718','75800','18380','33801','31246',
                          '13248','82081','59569','61651','41075',
                          '43384','77388','89099','57943','44806',
                          '37054','32868','83771','12949','23939',
                          '71073','90406','61061','51499','85136',
                          '81176','29736','62122','85483','55985',
                          '24073','86131','63316','58127','84404',
                          '97765','18938','44716','37722','99316',
                          '47138','98828','88994','37653','36975',
                          '16291','27748','68543','97895','44226',
                          '29599','79737','48632','54156','66529',
                          '47655','72873','85878','96065','15072',
                          '18498','38981','64327','60003','37177',
                          '76344','37467','94060','77244','60368',
                          '90379','52353','12923','26948','27178',
                          '84711','21229','41247','51138')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


