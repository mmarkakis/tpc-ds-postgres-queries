
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '18927','22667','17861','84558','58733','85895',
                          '67951','96181','48033','23662','48770',
                          '45077','19494','89546','40229','85530',
                          '78978','25008','83417','94952','60899',
                          '11100','45282','72650','29765','96606',
                          '62206','14766','83640','60350','75502',
                          '88831','69256','91124','94038','54559',
                          '14995','43198','38858','37184','69557',
                          '39512','91317','80079','33653','19312',
                          '99734','12754','62316','54261','89500',
                          '62522','46004','58424','92951','66176',
                          '49390','88346','77700','21766','43360',
                          '99556','62481','98021','69743','94913',
                          '46553','78122','85565','44612','97630',
                          '11629','90057','18385','32577','67508',
                          '88295','72913','24816','83322','72208',
                          '89350','50886','41980','81809','68816',
                          '15171','82277','45390','43676','73280',
                          '92544','80127','36854','38596','85537',
                          '51339','99446','52819','85781','84209',
                          '93809','76984','35560','98855','98463',
                          '27685','54674','47687','78596','23995',
                          '33045','68194','63103','67630','56956',
                          '84136','48542','69872','74322','99343',
                          '69907','12219','29482','82814','74712',
                          '89524','29420','40110','25747','48258',
                          '71354','96678','85915','24405','82411',
                          '84229','44590','86552','92655','28888',
                          '50559','90252','29170','30268','38562',
                          '24106','92494','71209','45271','38410',
                          '79851','17527','53462','72332','18625',
                          '63363','61336','64439','49050','74707',
                          '72031','34658','43366','34642','42667',
                          '88079','34545','20442','29251','47203',
                          '46784','74986','22578','60429','86981',
                          '37662','75505','17597','32013','87510',
                          '45625','54167','95843','83458','62054',
                          '43270','23208','21871','52743','65261',
                          '98514','85755','45828','87921','77495',
                          '13982','76779','13236','61904','44976',
                          '49513','82693','77293','66791','38930',
                          '12043','99401','61639','31516','71015',
                          '61945','40343','70763','28218','31111',
                          '31006','78595','64191','38587','74058',
                          '22990','23513','59846','28252','51823',
                          '37579','84137','49527','56602','71075',
                          '29725','99772','17324','89758','66592',
                          '85403','34059','16835','18968','60418',
                          '98338','12460','82767','99976','83311',
                          '13450','82762','86346','61583','72080',
                          '75446','38422','98900','48699','50192',
                          '53253','68802','13776','12623','72081',
                          '69002','72403','85579','97065','70406',
                          '30105','46538','29215','86023','70449',
                          '34120','97719','50332','34632','12634',
                          '31076','21153','14991','87342','45331',
                          '63048','31161','61371','23504','47937',
                          '48102','62787','42193','92507','89678',
                          '51093','60504','69817','43127','34640',
                          '21336','55576','80956','58730','44184',
                          '90479','30729','18714','59774','25769',
                          '73799','92279','28963','15691','18362',
                          '45757','36113','80494','98841','46131',
                          '98621','34008','84926','66695','13288',
                          '42738','36080','82099','21511','20108',
                          '85315','18131','50049','99541','74974',
                          '89991','12348','16127','45395','96998',
                          '97211','64402','43909','28687','32198',
                          '98190','21790','58157','27316','13586',
                          '41687','37542','99660','62929','10392',
                          '31814','96558','69708','43663','57139',
                          '45231','95517','82874','26952','71544',
                          '13357','86470','61878','77931','82753',
                          '92960','42530','89261','98676','41753',
                          '32964','98854','86386','49668','19054',
                          '93082','76871','75104','22486','10925',
                          '40971','34083','74760','12468','40309',
                          '99799','25097','13895','55444','40930',
                          '81803','91854','59405','45174','64615',
                          '53638','69390','47555','12533')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


