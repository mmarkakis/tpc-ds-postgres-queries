
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '41079','89134','88167','49342','10268','61894',
                          '54187','31902','57287','72461','30929',
                          '44055','63020','44625','27087','88995',
                          '14853','62613','15266','47404','78918',
                          '98699','56374','40655','21729','22951',
                          '25175','93474','57686','82323','14337',
                          '33137','22916','59617','63310','85735',
                          '11041','63606','74860','87972','57532',
                          '66560','67648','58101','89641','70375',
                          '77101','15752','19646','25093','52234',
                          '42285','45479','27948','53660','53268',
                          '87166','15310','69142','12862','78107',
                          '69404','56965','54896','88193','77040',
                          '47916','44954','53110','84114','81527',
                          '77833','84597','61241','80171','33440',
                          '64125','50433','66473','25190','56605',
                          '22940','42603','93971','51081','23848',
                          '81732','49276','34740','13234','44609',
                          '21989','57523','82342','82903','53902',
                          '46562','76437','31127','50970','91267',
                          '72324','84444','31768','30709','18597',
                          '24585','26477','95563','46391','84630',
                          '28450','24207','14663','65036','69526',
                          '55910','58552','19812','41202','75544',
                          '46159','19172','55510','65708','38242',
                          '69157','85862','32593','53831','63715',
                          '83203','35033','85331','61211','21316',
                          '14458','75096','89069','72231','81476',
                          '39456','71288','18787','69661','68828',
                          '40544','90004','73853','59487','35020',
                          '47262','78349','19968','76676','89374',
                          '45737','67379','85865','80072','20238',
                          '64380','85329','82788','97063','73024',
                          '50508','29945','44993','19958','21878',
                          '31757','20056','47678','89351','51066',
                          '18574','10593','50428','19808','68940',
                          '19126','31720','31977','65999','46982',
                          '25261','30078','62050','89359','58975',
                          '41759','33359','56790','91867','44251',
                          '87057','46868','37114','83769','81125',
                          '55557','73410','88981','81758','51148',
                          '81993','16090','26821','75354','67618',
                          '74878','38196','31823','91160','72453',
                          '21329','17104','61452','39670','70373',
                          '44491','26695','64814','32559','72585',
                          '84310','60574','76269','47204','54069',
                          '21750','36125','86694','63333','90641',
                          '37609','11025','18459','41586','51773',
                          '55030','79214','56598','15252','67635',
                          '15032','97132','99757','25191','30348',
                          '94183','17128','74286','84932','29314',
                          '57536','75676','88783','72861','18788',
                          '24306','69622','27105','25083','53795',
                          '75996','32541','99556','71493','87265',
                          '79451','89839','67850','11595','47937',
                          '50908','34650','59780','41068','27449',
                          '71743','35560','23341','94448','13820',
                          '56102','57050','37272','83627','63112',
                          '26685','34626','61207','25357','34531',
                          '28005','26506','56996','29689','15499',
                          '69516','22656','39143','94430','61919',
                          '83398','61602','91039','97194','76741',
                          '12481','91308','71212','66159','38309',
                          '25246','96364','64400','35145','70745',
                          '13374','79966','80154','35671','19491',
                          '80031','48223','62142','68880','94271',
                          '52748','94123','76283','86099','78277',
                          '53091','44303','58123','28608','89092',
                          '26163','69393','56715','81681','32427',
                          '47063','15824','30050','53494','94728',
                          '34830','54163','51617','21901','59026',
                          '57452','84649','41896','86049','93280',
                          '10404','52914','32689','99466','77409',
                          '39753','39451','73223','89458','57196',
                          '90189','98858','79698','77369','60473',
                          '83119','18766','31967','50520','39292',
                          '82441','64711','23473','33424','97450',
                          '20270','97513','54265','62335','64692',
                          '13963','39995','20338','75574','11011',
                          '57258','31780','83167','96650')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


