
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '94481','72494','44566','35666','23528','57860',
                          '84467','77429','34717','41956','35634',
                          '11450','13240','57501','33119','59120',
                          '93529','77470','50843','70427','97021',
                          '22109','31004','38949','33883','68906',
                          '24616','11277','87826','97813','14401',
                          '41481','49956','72177','50010','27797',
                          '51910','46613','81088','51196','51919',
                          '56073','57356','38079','17464','50726',
                          '51368','95783','28860','56360','66747',
                          '16513','75554','49452','70729','27855',
                          '80526','47637','82307','80041','94605',
                          '11123','22288','43493','12522','58895',
                          '23209','92167','32116','33897','84076',
                          '66907','84988','18880','55928','22687',
                          '64166','52865','72630','12909','24207',
                          '54006','68603','76931','62673','15760',
                          '99906','26933','69937','27228','79514',
                          '69604','72819','26227','96575','52996',
                          '14846','89743','17061','44268','73063',
                          '90303','76246','62254','90954','41090',
                          '31580','29702','14789','40338','99004',
                          '41093','11683','74881','94068','85545',
                          '13004','68500','62736','74928','40549',
                          '64834','73699','23722','31024','68296',
                          '78671','82187','20593','23471','83684',
                          '12658','49198','48069','50610','19042',
                          '42598','65327','12357','71555','17689',
                          '38741','41181','69339','86957','15426',
                          '98906','79588','59230','56571','73768',
                          '74543','68752','38052','42970','43892',
                          '33198','71807','92244','76097','95562',
                          '52343','70559','15845','94192','27116',
                          '74021','21061','69953','58000','98800',
                          '76794','41036','29494','46907','15435',
                          '97120','94778','23788','12352','33027',
                          '54365','92319','80552','11298','49097',
                          '13674','62969','87130','34126','78157',
                          '14373','39802','72375','65205','30627',
                          '78429','77585','13852','15333','63066',
                          '12125','15117','91619','33788','40358',
                          '63047','73098','95644','78502','90905',
                          '26333','51560','73990','56880','55713',
                          '16801','42230','30880','68565','80814',
                          '78567','59731','12219','59750','21749',
                          '12833','87328','62139','66334','68093',
                          '83859','42684','59460','78586','81267',
                          '44996','18679','12115','93193','15390',
                          '14969','99923','81193','14167','79777',
                          '83193','88392','64170','91627','25690',
                          '92001','83569','60921','19260','65758',
                          '14745','59147','96738','10656','75766',
                          '66005','54317','89979','61182','88198',
                          '35587','25266','74380','23037','27341',
                          '73748','33803','77890','87928','91436',
                          '49658','56967','85029','41584','25798',
                          '31518','30797','78342','60236','14816',
                          '30146','43470','16047','24652','44975',
                          '52602','73944','31992','92402','50980',
                          '32637','91573','64776','66147','49121',
                          '96108','91184','85426','73667','32529',
                          '83735','32862','27880','15136','90415',
                          '93885','13813','39158','68585','97003',
                          '65729','75779','95771','62627','24225',
                          '89498','71378','90929','70141','77265',
                          '60049','65411','84069','99611','46057',
                          '34636','19020','84310','96371','60753',
                          '26204','81872','64790','54695','60565',
                          '52294','24264','98900','83009','96234',
                          '32190','10196','38533','22129','75083',
                          '20659','18122','46997','40050','25003',
                          '54957','97329','91579','31777','17960',
                          '99866','56540','79475','12191','28215',
                          '46745','40193','10336','29268','13997',
                          '51374','90763','21814','44279','69854',
                          '10080','87326','28207','71726','66330',
                          '24739','50388','10662','78881','80816',
                          '12157','92199','23358','63575','23810',
                          '61580','42184','96999','97051','12900',
                          '93897','60606','25010','45544')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


