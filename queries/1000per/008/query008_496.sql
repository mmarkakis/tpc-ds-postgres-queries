
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '64295','45894','69894','63363','20862','34490',
                          '99022','19006','37243','90809','29837',
                          '69322','66002','35468','73183','10200',
                          '42461','67276','70231','16409','47165',
                          '13044','31646','93096','20735','69925',
                          '54111','82011','12602','91767','75744',
                          '34663','96589','16721','32006','75018',
                          '26809','27542','79891','15895','67102',
                          '36923','22625','74068','58749','76856',
                          '63054','51674','20322','27096','47621',
                          '92165','90353','18120','17812','80910',
                          '29758','71895','46450','42180','70907',
                          '28756','33198','41578','23759','19167',
                          '60053','85774','36317','94580','12530',
                          '72058','56490','29215','79171','13438',
                          '80958','98911','64708','74649','24229',
                          '37629','43188','59700','57711','17065',
                          '27464','55290','11683','50137','14905',
                          '35728','72718','76463','12973','82852',
                          '21594','95366','28650','77250','15098',
                          '52186','48011','20492','52081','91413',
                          '50923','83063','82409','89189','28115',
                          '90385','52952','77519','33520','48230',
                          '10003','98550','40773','35179','36165',
                          '72832','78013','39283','64731','72320',
                          '22570','81034','13346','60221','46749',
                          '70680','21615','26547','41537','87205',
                          '43839','63560','51783','48457','31194',
                          '23040','40764','14769','74552','81978',
                          '52741','64181','36296','77335','11769',
                          '42293','86706','17703','85936','82658',
                          '82907','24422','44413','53559','71674',
                          '19352','17305','96301','50316','15526',
                          '17540','52716','60646','53573','80278',
                          '85725','84808','10578','18141','12870',
                          '59013','94257','59189','47354','30437',
                          '82422','55241','74848','25485','26721',
                          '48610','77764','97172','24267','49984',
                          '68232','49406','49812','97702','19298',
                          '58434','80692','96257','29201','51114',
                          '32952','67615','52893','76571','72881',
                          '12031','99785','34070','29596','39351',
                          '58645','24722','67821','25108','47547',
                          '13182','14208','75022','25246','89167',
                          '17342','13531','14015','42042','39916',
                          '59294','93176','26807','34475','23786',
                          '94635','82143','15814','94002','52211',
                          '87284','18453','56226','11297','81964',
                          '69149','12848','13517','35145','38018',
                          '87344','21069','30735','62838','66204',
                          '47486','25259','60529','51748','51683',
                          '91495','54669','52443','32155','58987',
                          '14050','82921','22994','65276','48689',
                          '64726','76462','61725','39406','72839',
                          '81398','66614','59801','75295','20592',
                          '33730','96919','59306','13879','55534',
                          '99874','80035','53664','86789','58736',
                          '34512','64380','58264','51842','63728',
                          '23945','63261','86713','83913','20927',
                          '99633','28334','23419','75783','29185',
                          '35753','81111','79008','82708','90350',
                          '12020','24686','63505','73325','19045',
                          '21973','13980','61022','97966','14074',
                          '41631','44986','48955','57904','33597',
                          '44767','13470','49276','22350','75358',
                          '45057','23794','59691','85721','73745',
                          '92028','77282','13211','44254','15159',
                          '69711','26761','50202','31683','29180',
                          '47914','26742','71377','37377','44069',
                          '73464','64432','34485','91256','93043',
                          '80555','46402','94858','10349','62988',
                          '76654','24184','10901','18165','92713',
                          '65456','39798','34044','63399','52360',
                          '79820','44722','43609','23873','26939',
                          '72012','15831','21900','39505','50108',
                          '75151','17723','75954','28437','65036',
                          '39591','89112','85511','62760','28678',
                          '61280','39640','94088','33399','90961',
                          '51473','24682','65522','83388','41351',
                          '17745','92861','84116','66727')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


