
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '33154','10676','27743','45925','89820','38556',
                          '84536','51045','36322','89183','17407',
                          '29401','18007','61294','14758','28661',
                          '57668','29874','58393','71225','83017',
                          '54171','12874','42122','73282','80407',
                          '45885','12139','99791','53865','54699',
                          '69963','13335','98909','19373','53585',
                          '79172','25673','83200','37768','74571',
                          '72218','27902','57695','89012','76184',
                          '30704','16589','84544','85792','34955',
                          '46309','64767','96205','33323','33812',
                          '26047','87368','90161','81393','32888',
                          '78084','63907','10590','19161','23190',
                          '77870','19894','41039','42370','95180',
                          '83035','89105','97453','77565','28772',
                          '95119','74104','91595','32736','17011',
                          '20444','22398','32449','97651','46146',
                          '15760','92709','19260','96256','39334',
                          '13452','29688','99470','98644','95400',
                          '25021','89397','59194','38558','65635',
                          '95086','84072','40050','13174','37251',
                          '66882','14518','48938','93858','38273',
                          '93040','46352','71693','16071','54968',
                          '36420','42688','23443','18362','30817',
                          '48392','47654','58059','25894','90544',
                          '37523','62266','61305','87689','15157',
                          '94994','57070','66214','65645','29120',
                          '33757','55509','44543','36094','73791',
                          '52661','92094','37449','22167','27433',
                          '80121','82040','54562','48927','14817',
                          '57363','14887','53806','43201','39393',
                          '51649','98407','54217','97918','95438',
                          '76350','46605','87465','15018','59100',
                          '64912','66674','45353','56042','49172',
                          '94908','97178','48897','77872','46077',
                          '34336','41918','53141','92059','17648',
                          '13475','14814','20653','65374','97543',
                          '22559','34816','94128','44675','10920',
                          '72506','32159','92863','28357','33050',
                          '30857','78291','11021','63224','86755',
                          '65399','55255','55801','35375','64453',
                          '83974','83011','64010','59573','85367',
                          '53259','62770','47974','55647','82373',
                          '52795','28434','59212','77267','66155',
                          '23910','86383','37154','69258','71676',
                          '48902','81388','29816','83670','83158',
                          '16630','84172','49617','58572','49456',
                          '58837','45105','58997','79537','66734',
                          '96937','20904','25456','47067','14026',
                          '19636','70368','53564','27131','78898',
                          '30082','93652','98769','61999','83220',
                          '95795','43962','90325','14527','65701',
                          '74779','61628','53917','79873','20226',
                          '66293','19643','75667','53774','28633',
                          '91581','44117','39094','24274','43399',
                          '72753','71594','10233','11665','48627',
                          '23355','50029','92968','58335','96020',
                          '85972','83772','51154','71995','16812',
                          '91313','64935','17565','72928','36727',
                          '71606','91226','26834','37245','33021',
                          '64910','71139','88632','84409','50320',
                          '66356','99090','17499','32600','16998',
                          '53889','97691','42985','97370','38551',
                          '42141','41270','86865','52170','62081',
                          '81488','45708','29664','57673','57111',
                          '56327','31552','55295','24208','82701',
                          '77289','90230','87461','51868','17745',
                          '73759','41811','20884','69175','82585',
                          '41142','15304','23557','10342','47534',
                          '24644','47009','95540','48055','99944',
                          '49965','41459','23294','30127','53894',
                          '77497','29198','27999','75488','86236',
                          '77840','13000','76178','33904','61244',
                          '66143','14755','48968','46686','28641',
                          '71159','46742','46430','29105','90669',
                          '67383','65418','35105','58031','90086',
                          '15570','86421','61035','87482','33868',
                          '22150','89096','60371','77912','87778',
                          '27809','14126','50248','11442','26611',
                          '98436','94564','19091','94568')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


