
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '67014','82644','32212','50761','43819','25759',
                          '35897','33457','35258','69375','66743',
                          '96461','96456','19615','47339','70791',
                          '85037','84736','69714','47809','70947',
                          '26051','64235','73564','27420','27640',
                          '42612','28987','58616','44256','29623',
                          '72265','98068','86627','89974','69374',
                          '86228','41331','61675','89990','92117',
                          '18712','86001','77818','36392','12858',
                          '82018','20347','76963','77812','20368',
                          '66996','17177','36241','45520','48270',
                          '83006','95424','96783','24109','79310',
                          '73599','68759','48715','21834','48457',
                          '49126','73361','72448','55170','45219',
                          '83105','46955','37670','46044','97204',
                          '21685','44356','57485','98562','37776',
                          '49348','94951','87565','71583','96375',
                          '61771','14324','60291','42770','44591',
                          '87932','45101','46528','45214','10270',
                          '40654','34835','95106','93717','54613',
                          '29716','72038','90883','73602','70737',
                          '45411','75470','82054','47418','92459',
                          '25723','25696','86263','39114','86890',
                          '99933','88849','66918','71478','42152',
                          '82158','90381','40189','60235','40334',
                          '96293','40826','76484','63258','44811',
                          '16115','84828','64309','22633','61301',
                          '94472','40631','51637','98639','48901',
                          '55824','43195','94562','47487','23907',
                          '83143','90016','61000','19930','41915',
                          '80040','55443','47728','73431','32264',
                          '30530','96701','53783','68397','67578',
                          '39318','73472','57221','10367','88187',
                          '38848','24609','61849','19545','36388',
                          '22244','52941','30771','53933','72507',
                          '38206','85770','39872','28131','52845',
                          '84397','55246','63056','40301','38808',
                          '40484','69885','38401','75285','38633',
                          '52103','75852','37853','19193','45010',
                          '31903','95089','44569','63281','39219',
                          '82088','14705','66506','16436','33214',
                          '42178','97743','39000','33691','12664',
                          '46711','96723','29876','26791','31947',
                          '32084','18315','13126','48402','39074',
                          '27514','91853','44963','95949','32111',
                          '82880','15410','66945','80379','62146',
                          '41788','43920','74851','17673','67376',
                          '87661','42710','35128','54023','84006',
                          '78855','52518','89103','31134','63008',
                          '57095','34954','63084','90486','79834',
                          '87427','18524','64079','87322','30538',
                          '97317','88877','92617','46641','30317',
                          '89764','38137','93425','12180','34312',
                          '66101','89578','62621','42096','51648',
                          '64611','94459','76771','56940','76256',
                          '78697','48242','79518','30303','49111',
                          '60644','87837','94253','22236','37645',
                          '33724','56232','78632','99669','81775',
                          '92221','95601','45797','92501','15037',
                          '30448','27991','33896','32993','20287',
                          '14124','39497','97908','82292','69178',
                          '78298','94726','12264','11932','40687',
                          '69330','77682','99084','44004','55134',
                          '68841','17001','92893','31940','75455',
                          '69002','71594','22918','26961','10371',
                          '12387','94511','30778','69026','69787',
                          '38214','90686','55921','39590','18094',
                          '80908','16326','75014','89615','67749',
                          '40929','90854','34064','56695','94199',
                          '95502','49117','98786','10162','43396',
                          '75545','71683','88066','62726','30233',
                          '29395','43975','91873','67035','25981',
                          '59404','23458','14014','82636','99678',
                          '60875','75413','81861','74267','35002',
                          '60655','90371','22379','33564','85428',
                          '85848','61622','15861','20471','28729',
                          '77603','53863','11542','62296','79306',
                          '42350','76627','96219','26564','37182',
                          '49312','12005','68243','61333','67426',
                          '91880','61865','92922','48697')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


