
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '42263','11392','10532','99331','39578','34547',
                          '18988','85571','92222','87805','96794',
                          '59609','99642','30975','47315','81594',
                          '59643','72846','66968','23269','68292',
                          '78364','13247','18546','18944','67418',
                          '91078','53254','40839','88441','48348',
                          '58029','69626','32205','35117','61329',
                          '61362','87218','47563','29020','67208',
                          '23783','18801','30389','80527','97089',
                          '31886','40924','93161','11229','66455',
                          '26803','33257','37076','79170','27527',
                          '19740','79859','73448','46881','61269',
                          '48385','32262','64163','64387','45948',
                          '87101','24181','17038','72513','98554',
                          '74572','91558','13717','71851','61839',
                          '78376','92403','91971','98390','17401',
                          '42602','50809','25417','56777','44840',
                          '17679','61956','59813','11615','97964',
                          '85575','80058','22244','30189','21768',
                          '23336','26366','56691','78912','40324',
                          '30004','96670','93297','59082','56655',
                          '90057','90909','27571','32194','35574',
                          '46447','18644','91537','95576','60233',
                          '12058','51538','95104','41077','93919',
                          '99797','71382','94815','81600','57036',
                          '91749','54342','32831','41731','68131',
                          '39163','15746','39858','20113','28510',
                          '70603','91940','41915','90846','50367',
                          '31824','83431','58221','25972','88245',
                          '30200','40532','47875','97817','40173',
                          '11312','62714','42022','15290','56571',
                          '20244','19951','39520','44716','59088',
                          '66929','60467','88422','67682','71880',
                          '36574','12696','98110','94355','33345',
                          '39366','45307','54148','13641','68349',
                          '48202','44653','51387','63588','69349',
                          '71856','82611','18012','88509','41620',
                          '14448','39463','85525','93206','61536',
                          '90528','51064','88986','85621','76986',
                          '31732','73552','42993','52709','19334',
                          '63927','58601','96895','42018','44082',
                          '41403','77916','67258','25445','52209',
                          '72468','95239','94191','83477','98048',
                          '51354','37619','84063','86025','37494',
                          '21166','34548','54399','98170','60558',
                          '46113','29191','86566','91979','35922',
                          '33286','13788','26032','22783','49973',
                          '41335','59516','62926','63609','55420',
                          '39822','72805','65032','39841','80136',
                          '49665','54204','64247','41059','97969',
                          '13894','80105','50876','13405','42072',
                          '92807','89933','67360','41667','74409',
                          '90034','75747','23030','84888','74542',
                          '59844','13903','96086','86764','31874',
                          '68429','89250','13787','50632','28467',
                          '64126','30163','91096','97682','11647',
                          '61833','62766','48535','78183','26373',
                          '22752','50756','49890','41455','69984',
                          '43093','12102','45528','32010','18431',
                          '97528','69335','87577','44769','55040',
                          '58593','92194','17731','53319','54308',
                          '84721','33059','90757','74563','84855',
                          '89330','35123','45075','50319','85484',
                          '91473','74267','71128','71490','21506',
                          '37247','64992','86159','61198','57185',
                          '45408','32893','26063','76338','58943',
                          '83883','81137','11770','57446','70867',
                          '39478','94009','28918','30067','45436',
                          '11236','10408','30827','38961','23826',
                          '54341','79206','38344','33943','58906',
                          '65344','14941','31777','87233','94073',
                          '15471','92727','64645','25792','23016',
                          '21695','23034','98647','77248','69985',
                          '57777','69263','70024','53252','14513',
                          '85830','16857','44487','49156','72883',
                          '15918','52777','45243','17725','17734',
                          '13097','45989','88268','19582','93089',
                          '86296','57705','36070','71599','12880',
                          '53021','59942','44585','39503','17664',
                          '87547','99532','39443','35839')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


