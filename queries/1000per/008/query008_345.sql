
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '29228','66398','58973','35550','97069','37334',
                          '79052','45453','32241','53876','50434',
                          '30407','18866','93002','78649','95879',
                          '16075','52629','69567','94457','36922',
                          '75936','82960','91585','74860','67156',
                          '22811','81154','19931','51089','31931',
                          '92589','66157','86909','79143','60902',
                          '35906','82376','54833','39644','22338',
                          '80981','53488','38151','44247','49112',
                          '54904','45807','56284','38767','87308',
                          '95485','29486','12773','40769','75095',
                          '55294','81549','80874','76184','59676',
                          '98799','14251','50957','60260','51946',
                          '74246','43388','80082','22158','90051',
                          '30039','25110','99521','66260','34384',
                          '81954','63691','45943','41982','93136',
                          '33897','52275','77762','86783','68490',
                          '60633','36656','36817','12985','33456',
                          '11779','33071','29172','53429','57526',
                          '32638','80881','82545','58289','67034',
                          '34599','14134','10057','33185','41663',
                          '38459','45425','69593','48380','28603',
                          '28925','26132','60917','64225','87840',
                          '92257','34012','58046','98378','13644',
                          '53804','50980','73000','87052','48951',
                          '80024','82297','40572','26888','96521',
                          '83359','25217','27118','88513','92767',
                          '51537','72918','71437','62673','19866',
                          '23714','31294','42435','71516','25860',
                          '25378','28506','65210','78844','45889',
                          '85630','32902','95353','77556','90814',
                          '89879','42489','86837','95889','51728',
                          '68780','64471','72049','52861','21715',
                          '55900','26109','65353','92984','86961',
                          '11627','41679','35681','89090','73894',
                          '56161','97245','15752','75497','40086',
                          '77920','29357','59613','34837','75279',
                          '65826','98119','29164','91051','21919',
                          '60644','67427','92153','11731','25118',
                          '43715','44554','72107','32075','53771',
                          '91442','38437','72475','46252','24554',
                          '40734','10404','39879','18297','81115',
                          '69379','20143','99648','51538','19232',
                          '91636','98579','55743','72593','11749',
                          '17770','20201','16537','44582','91072',
                          '46433','29213','88483','52703','84360',
                          '56747','82767','23585','91697','76817',
                          '54320','69562','61833','91507','37885',
                          '14635','47628','61721','43576','70894',
                          '28989','74969','27988','33386','57002',
                          '58294','83124','88369','55542','35279',
                          '85060','44337','64170','33806','94673',
                          '65980','16242','89096','19214','44740',
                          '70362','99137','66096','67488','94653',
                          '89845','80835','39065','74346','96321',
                          '99083','21739','77947','25420','61812',
                          '96424','11812','62971','48873','28887',
                          '50416','70869','92159','90824','95580',
                          '20528','40282','82245','38564','34203',
                          '74564','33245','34625','37019','67946',
                          '41912','49647','22382','28362','40949',
                          '28317','16539','84563','72044','41798',
                          '89443','68133','11140','96887','17391',
                          '11706','76121','19365','50301','42272',
                          '44035','52335','55242','62589','19778',
                          '68235','92853','58288','40608','88443',
                          '37197','56111','90880','90430','87269',
                          '39970','16917','45416','13195','85646',
                          '23641','70965','25809','69423','31473',
                          '51558','46164','73783','39507','13138',
                          '27554','92114','13096','71296','11929',
                          '18759','10249','69740','49414','24748',
                          '12828','78105','68956','63376','95522',
                          '32942','12009','51438','12742','32091',
                          '98004','38220','96057','49996','10353',
                          '29554','30771','34647','11229','21005',
                          '10559','85637','89675','10322','22695',
                          '29184','19371','28280','54625','15101',
                          '88766','99006','49231','99987','30500',
                          '84613','45406','40467','23119')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


