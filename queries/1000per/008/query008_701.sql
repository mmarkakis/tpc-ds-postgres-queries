
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '12376','43065','14617','84151','47732','14294',
                          '91175','16499','78940','12147','70293',
                          '39786','30036','54018','71548','76856',
                          '65429','63016','82759','96365','66749',
                          '42270','55534','11613','15075','13047',
                          '69286','73544','85229','97673','13257',
                          '78459','35151','86716','47047','59131',
                          '42567','25603','51934','45261','21237',
                          '44905','59289','80998','18159','33519',
                          '80895','42637','66154','50847','29128',
                          '39505','60065','18308','85897','35240',
                          '30922','61610','53611','60085','43458',
                          '49230','56739','44441','47412','99859',
                          '81318','44611','13229','12548','75909',
                          '83700','44028','42296','73548','76087',
                          '54508','76516','69399','32852','32679',
                          '71902','97274','73127','95878','27473',
                          '26625','11292','51264','61593','81722',
                          '25222','35728','54408','77747','35217',
                          '84601','11526','74585','59555','41497',
                          '52904','98462','88817','91387','40793',
                          '26343','73186','34627','13772','14257',
                          '37807','32867','42850','72205','23616',
                          '60664','71400','87533','73889','41721',
                          '69179','75004','80152','78962','88940',
                          '43412','49657','44044','40239','36758',
                          '52762','13862','15215','99844','55956',
                          '38604','74217','51733','17370','70943',
                          '79331','45077','67713','97525','79008',
                          '57899','51186','98883','29107','95256',
                          '44479','10705','89925','63072','52409',
                          '85288','12829','72737','59914','38753',
                          '40658','91690','22747','96020','19537',
                          '28004','90600','54648','28065','64737',
                          '72141','41545','78428','66594','85962',
                          '19277','60717','37080','42463','35999',
                          '15736','88772','42044','63666','74621',
                          '53206','36110','85912','70066','89037',
                          '21747','83892','17834','40667','14187',
                          '51782','14756','64722','84222','38758',
                          '68417','67512','99075','98731','42200',
                          '75431','98679','97497','15798','34238',
                          '63757','24706','75129','56797','98288',
                          '98774','18092','31599','95037','33971',
                          '58523','21095','91781','22429','86642',
                          '84193','29728','76907','26563','16798',
                          '15096','76285','72419','56470','88784',
                          '96442','82607','21198','35091','52735',
                          '10903','56724','67130','82831','82272',
                          '44469','27303','43375','68089','86333',
                          '69440','84405','42021','45139','53422',
                          '56472','97114','41987','77864','23575',
                          '20236','14352','29490','12092','91992',
                          '45093','86910','14499','30437','78535',
                          '12131','39440','29057','86700','98132',
                          '23839','82181','95041','42839','99280',
                          '16749','30853','17753','25978','75169',
                          '10328','62577','78978','26361','92425',
                          '95333','38956','76299','79597','29464',
                          '51344','12650','56341','74873','65791',
                          '96141','96521','44645','80409','45286',
                          '93872','52657','29395','77204','77834',
                          '98034','13160','98875','65448','64561',
                          '16446','70927','47841','41375','45408',
                          '97321','55632','31213','85391','66321',
                          '71514','81827','26524','70997','60298',
                          '14618','61635','26600','89698','29481',
                          '28586','49708','53428','31165','43865',
                          '32141','30399','57131','76536','81195',
                          '76534','98905','88536','38170','40575',
                          '19363','17631','60918','51254','52328',
                          '58953','33851','86302','22106','95184',
                          '82458','21878','14596','98271','35707',
                          '86899','35673','98186','94211','85509',
                          '68739','54254','63611','57104','94686',
                          '53813','65375','84294','85586','16384',
                          '50537','83579','64085','80565','33002',
                          '35411','67820','91083','43205','23022',
                          '57446','66361','72731','86049','69551',
                          '43781','62727','76390','30763')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


