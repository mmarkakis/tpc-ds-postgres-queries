
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '53323','99011','24076','53531','24593','43011',
                          '94510','27853','59132','39264','28736',
                          '80666','67308','18724','67117','14790',
                          '62206','60862','66274','60068','88420',
                          '11574','17862','86497','89784','45716',
                          '59161','31308','58773','70762','22335',
                          '99799','58135','72131','35672','54649',
                          '63509','10872','51286','55416','87569',
                          '74669','72443','46244','61200','68102',
                          '89448','64522','95401','15956','14264',
                          '55626','80740','31366','52010','94858',
                          '99551','41336','76095','52962','26219',
                          '17691','91033','23653','36920','21789',
                          '12305','57805','82457','78768','89202',
                          '63349','60846','67665','94823','18494',
                          '61051','62183','71075','13011','39765',
                          '17287','13597','10981','28491','37524',
                          '68531','64560','12026','51099','50446',
                          '23894','98113','18675','67979','68183',
                          '87573','95131','57559','41070','95174',
                          '44095','47318','65034','69726','26756',
                          '58390','64396','85772','62014','12259',
                          '42788','29605','14560','83496','43863',
                          '39586','68492','91874','60257','77722',
                          '83941','32374','97222','77471','41916',
                          '39836','30706','98191','28576','51364',
                          '13600','65016','94604','99441','45808',
                          '29581','37387','85080','70432','10414',
                          '96857','77012','15200','45407','72480',
                          '24422','95213','55142','53239','81070',
                          '58388','96104','77698','63910','75898',
                          '83630','31115','11139','50589','24588',
                          '24670','17885','71418','39732','52375',
                          '93013','81025','90249','56870','19734',
                          '26980','97177','68753','10639','72390',
                          '79952','71348','29443','92334','46535',
                          '82312','90277','70620','42637','61943',
                          '87820','65731','84955','89910','36947',
                          '88719','19716','85466','25734','67848',
                          '18208','83729','34811','97574','61719',
                          '35190','26649','22460','76215','43537',
                          '99487','29091','95280','41825','58785',
                          '23315','30384','70870','44229','19821',
                          '49975','17375','91298','75694','28345',
                          '13001','67967','89921','23145','89203',
                          '88852','30331','78923','33443','42826',
                          '73500','10844','94611','71020','44746',
                          '69287','17887','22482','74375','64542',
                          '59022','12943','52648','77453','27073',
                          '54178','29692','52234','36123','61632',
                          '96946','25521','75207','79863','58122',
                          '83185','90174','19509','25909','72674',
                          '34844','82839','89762','38168','29381',
                          '99890','25587','34307','83407','42434',
                          '52634','71170','40787','17750','57498',
                          '76464','56186','30304','64672','72374',
                          '40049','74747','58478','94131','38849',
                          '86988','72654','55540','43697','28504',
                          '22703','32648','97764','53245','43124',
                          '70673','16601','80468','29372','66210',
                          '31906','18887','87498','17303','64477',
                          '84648','11121','63438','41710','69396',
                          '72140','50978','49249','71162','98906',
                          '93931','13695','33780','27681','20041',
                          '72774','27234','22010','34439','27501',
                          '48364','97086','24622','98531','23333',
                          '10354','11710','14691','39225','14949',
                          '31010','39288','21213','31997','47715',
                          '87055','86590','42223','88787','64390',
                          '32920','76285','31265','14491','37448',
                          '96501','36936','37097','60690','14233',
                          '47075','67165','54166','35298','36717',
                          '86784','31908','41325','41858','69473',
                          '23569','91164','47978','98616','88950',
                          '78413','26944','71467','63318','31156',
                          '19375','55528','85979','12843','50334',
                          '53999','52418','31529','92209','22228',
                          '99058','30450','67321','67818','80429',
                          '38908','55343','57218','61682','49651',
                          '79909','43106','10302','20817')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


