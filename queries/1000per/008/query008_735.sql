
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '50490','47816','58004','37185','62290','13345',
                          '65097','88547','50089','72256','68621',
                          '29599','66841','59194','77462','13527',
                          '97379','66489','57758','94427','16535',
                          '54913','62284','44379','98043','20687',
                          '32693','61713','38735','66786','25815',
                          '55651','83187','25548','61261','73449',
                          '50630','14656','15182','83237','14676',
                          '14749','60356','87483','71027','48452',
                          '69628','10368','47813','80626','20263',
                          '82632','94205','56231','69608','94516',
                          '78309','20735','73180','73616','60600',
                          '31134','25250','64399','31257','99591',
                          '15725','22495','34354','79110','48035',
                          '44701','43165','20942','83383','12131',
                          '80624','47043','76572','27701','28184',
                          '32404','61981','25507','27542','88023',
                          '71139','82887','69007','51905','96413',
                          '32220','57812','11179','99830','38665',
                          '39364','81705','94446','84524','46777',
                          '15264','48137','99675','53347','58979',
                          '59152','66806','55170','61169','56943',
                          '52495','83739','21503','37402','40767',
                          '48313','93630','48853','27033','27736',
                          '12694','13812','25662','18223','85560',
                          '11929','31831','74457','78273','16797',
                          '38988','16484','26943','15849','73757',
                          '60931','16624','37907','84531','95682',
                          '69545','11145','98523','64914','78208',
                          '71804','54234','36212','83450','82135',
                          '57456','76975','24316','54736','12965',
                          '75444','38529','53865','14270','69047',
                          '67320','20348','60925','56721','22961',
                          '97234','57431','62424','12224','94003',
                          '95957','52891','65868','60184','20058',
                          '85244','92832','46379','17100','58667',
                          '62616','23725','89377','46930','95384',
                          '55610','40745','69072','74965','37597',
                          '63641','58709','80269','59319','19861',
                          '52480','48344','79833','30235','15141',
                          '41201','54504','12236','48442','78097',
                          '30397','28004','45887','65034','77887',
                          '48131','15504','12347','26262','21036',
                          '44504','96622','64277','22496','46900',
                          '52159','89402','21871','98058','83480',
                          '31379','28086','28801','43773','69308',
                          '74706','53031','96057','86608','97221',
                          '51119','56567','67067','27043','57955',
                          '19452','78936','84385','18160','22847',
                          '82456','66080','89515','79511','88063',
                          '33900','63705','98285','85711','71758',
                          '50949','12167','81233','70832','51743',
                          '59167','72753','17038','85823','90830',
                          '89525','88413','66303','99356','16489',
                          '71995','94209','81537','28743','60824',
                          '42124','18963','48856','60877','92010',
                          '89031','40712','31695','62825','54475',
                          '42335','68917','22549','44207','68097',
                          '98338','47031','76739','60541','97091',
                          '34085','85034','88207','92311','17359',
                          '55448','52797','74546','44789','38369',
                          '73872','96784','59879','84537','84196',
                          '69508','46466','18266','13722','36448',
                          '48289','46377','89774','68057','34458',
                          '72390','61277','79487','67499','26473',
                          '55172','34540','57134','97293','49317',
                          '11249','63410','43695','53208','65012',
                          '68382','19602','41309','54365','88446',
                          '98313','87814','87552','77931','32998',
                          '49494','23610','56318','75666','10224',
                          '71708','97401','18523','59342','13025',
                          '48166','89897','28216','32855','21540',
                          '88722','38597','40930','41611','76013',
                          '84192','66025','69783','15683','49655',
                          '86153','25338','69753','49617','97127',
                          '16350','17659','47985','38751','88179',
                          '37870','90410','26549','51072','60097',
                          '43332','68852','55013','53756','53166',
                          '29071','51250','42607','45717','81302',
                          '93000','57617','14391','32898')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


