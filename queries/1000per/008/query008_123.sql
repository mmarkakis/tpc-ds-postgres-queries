
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '93440','26326','63955','10345','17110','81732',
                          '56541','24975','45600','30641','93289',
                          '78292','71640','58506','14508','74617',
                          '35920','93437','53507','75188','45008',
                          '75784','32911','44902','93529','21920',
                          '87063','62902','58165','51852','61023',
                          '45940','40355','24882','41394','34808',
                          '36268','51075','30090','41257','68373',
                          '60120','76838','14372','11909','85650',
                          '28161','27080','30190','71577','90336',
                          '47910','42485','53079','78682','51210',
                          '87137','93327','60230','44233','93225',
                          '50613','34721','34380','95554','30663',
                          '47287','72108','34863','84791','78955',
                          '66777','63740','32797','54570','39533',
                          '94310','87999','47014','44653','35571',
                          '96112','25751','86971','78740','74570',
                          '27068','15084','38814','58584','63825',
                          '86469','84967','74455','67026','57160',
                          '59546','19469','53847','66294','71335',
                          '16352','23026','46542','27599','48040',
                          '11249','99489','19038','32564','62070',
                          '32659','97826','62666','17209','21378',
                          '74324','97780','37306','32192','30058',
                          '13129','66859','82276','43930','49120',
                          '18889','86410','59693','70964','43131',
                          '84103','94385','36788','48943','70898',
                          '52140','97601','18241','72029','68096',
                          '71692','60217','68779','26492','87134',
                          '21113','73548','40412','95548','25129',
                          '33509','21565','26276','36202','88900',
                          '84292','81974','72734','20976','83108',
                          '21067','26968','64058','67511','43808',
                          '27820','67989','27667','45559','66801',
                          '67236','72018','13401','63585','19911',
                          '66228','11919','99208','47856','65589',
                          '57157','92145','59406','49420','51574',
                          '47419','75783','16655','29049','16122',
                          '85078','83749','62639','54029','52445',
                          '63011','85740','23035','89763','42641',
                          '13066','12660','82652','16824','84616',
                          '69871','73810','18245','68153','26175',
                          '64387','20914','56497','74795','48266',
                          '89771','15348','61134','51315','21954',
                          '66272','22076','77696','21826','43574',
                          '60253','72056','36168','56152','11414',
                          '66500','68174','44452','67755','37129',
                          '79617','31420','50611','31267','85596',
                          '23962','46366','16242','94830','16132',
                          '11916','50833','53102','93888','57436',
                          '77781','28459','77584','33498','34725',
                          '26380','66551','53060','42279','57853',
                          '18180','55470','50278','81235','51692',
                          '29738','20565','86926','23363','45186',
                          '74784','59532','44905','40172','70400',
                          '37740','56393','27195','11013','70834',
                          '43476','90422','97497','41276','33362',
                          '61542','17765','26687','46605','69796',
                          '72043','85993','92628','74802','73182',
                          '82217','92190','91922','28330','50588',
                          '25194','38972','24435','96038','50253',
                          '41834','49018','69520','44971','31370',
                          '59263','20249','51673','95729','60726',
                          '49809','47631','93563','59415','79921',
                          '46002','98258','90980','55278','22675',
                          '83809','43212','48771','35551','62249',
                          '76874','19410','20350','97615','91973',
                          '89347','68323','95780','17688','60818',
                          '92136','38251','93344','92119','42824',
                          '80535','88424','79508','98714','24941',
                          '17049','38417','71421','48764','70495',
                          '59409','22754','28303','99308','18531',
                          '38768','65666','61934','32855','14191',
                          '53938','36146','81208','53440','12726',
                          '62259','16818','92012','57366','85563',
                          '60478','70804','65481','84653','18809',
                          '95144','68485','37485','13404','30245',
                          '88245','58876','19775','31515','31665',
                          '83769','69676','70775','39782','49633',
                          '85377','41856','45264','93342')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


