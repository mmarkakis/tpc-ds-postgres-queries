
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '47814','85253','64695','88610','44362','64352',
                          '51571','11947','91213','12106','34919',
                          '14738','46187','52192','48932','70257',
                          '19758','16471','89885','11837','78575',
                          '54620','62504','23727','54411','34833',
                          '85960','13592','40275','67468','80650',
                          '14792','46049','91663','93750','35468',
                          '29982','30939','85906','17804','63998',
                          '99210','79005','56756','50700','99403',
                          '11110','33230','83755','30350','14296',
                          '40555','17056','87812','11025','38428',
                          '94295','36036','29195','29685','43058',
                          '75399','63808','47202','45911','79130',
                          '37327','32262','30591','50714','10534',
                          '91823','18533','71512','42554','29272',
                          '40509','22879','65070','47113','14735',
                          '63137','69824','98699','60417','35090',
                          '62817','80369','78582','31962','96112',
                          '93906','74003','61309','75655','88791',
                          '55883','90152','22704','42891','73736',
                          '84959','91730','40582','45804','17494',
                          '24680','39703','34605','43125','63250',
                          '65500','36624','84480','80723','24754',
                          '54111','46279','47672','13429','95919',
                          '68585','27161','57180','82191','18704',
                          '50350','29800','29575','14647','63889',
                          '89238','98778','18014','54704','36878',
                          '85856','83706','48964','39539','47152',
                          '82814','86826','82374','99311','65283',
                          '69368','32910','65831','26230','90968',
                          '17400','33764','88768','56542','27808',
                          '40472','80118','26249','50017','68989',
                          '99035','42402','81158','31473','66049',
                          '67692','71221','90744','28417','15610',
                          '67760','27177','97256','21710','82128',
                          '34915','14763','22738','95782','43166',
                          '63930','40332','58348','28783','90927',
                          '66334','49980','97578','59257','99334',
                          '78028','94860','55023','40457','14218',
                          '43950','12819','93808','75471','37192',
                          '35592','88376','32542','15977','54367',
                          '85399','24793','68451','18404','36287',
                          '15837','79605','28486','77305','25386',
                          '84691','20589','51562','91380','72914',
                          '96972','96663','77755','61049','42267',
                          '85963','53833','21315','55399','32399',
                          '99937','62143','55725','12693','47366',
                          '69713','14876','47203','14728','56298',
                          '43057','53893','16294','67230','50608',
                          '70642','25316','84835','27434','63168',
                          '37220','95040','89153','21969','67632',
                          '23762','81088','62726','35364','28668',
                          '71806','83570','39989','90353','27255',
                          '59782','76906','52604','49356','87094',
                          '98882','42695','98641','29337','31921',
                          '21940','53250','27959','54157','93697',
                          '27816','29887','67448','81444','26761',
                          '60310','57084','19700','10898','87001',
                          '85553','41953','32835','39973','33784',
                          '79396','70389','30944','53308','22487',
                          '56210','92852','46975','35947','49599',
                          '58802','60631','28002','20129','83089',
                          '20535','35237','20648','89121','80850',
                          '48660','69438','13920','60469','20188',
                          '65777','41065','43242','43421','26875',
                          '47025','89224','23747','43697','13481',
                          '66654','65821','61141','76871','71419',
                          '54789','12977','56716','83630','70677',
                          '55071','78785','63475','14906','87229',
                          '89337','67799','84588','45080','14788',
                          '98224','68054','18660','22267','75754',
                          '38206','11682','69200','25168','41465',
                          '17677','21734','83933','73378','19834',
                          '15307','30973','62338','43838','55430',
                          '33692','60607','53904','35354','75083',
                          '62806','88059','29162','67720','86765',
                          '23823','70112','45047','75913','70548',
                          '32967','40607','85080','80671','42511',
                          '46787','66406','83422','35228','90369',
                          '99087','51334','60271','62235')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


