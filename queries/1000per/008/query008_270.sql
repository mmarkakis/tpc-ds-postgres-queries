
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '83763','77959','51257','12901','31768','14944',
                          '41658','86562','19431','25358','94458',
                          '26611','73453','79692','72449','18771',
                          '12673','98834','37123','97890','96474',
                          '97580','84090','74550','89377','89550',
                          '58418','12669','69449','72301','54356',
                          '52391','85978','51598','99899','46714',
                          '21039','90829','32758','73519','58816',
                          '90281','38077','24295','21757','87139',
                          '15656','95962','93019','77509','49926',
                          '94419','47752','76632','83570','17416',
                          '14881','29569','62422','53032','96343',
                          '91341','38319','68188','12274','18619',
                          '77315','18392','96381','41966','42798',
                          '19057','15370','87828','30852','40789',
                          '67017','33213','59897','44708','98035',
                          '73166','55383','24624','13888','50108',
                          '80855','88560','32220','85441','12154',
                          '60817','67596','88545','55118','27795',
                          '67817','43699','57370','32091','79571',
                          '78631','13314','32022','28076','28992',
                          '84714','81982','16989','31709','15354',
                          '76797','79596','71631','48221','38829',
                          '64142','56250','76963','96849','25967',
                          '76763','93053','51737','68342','98192',
                          '61371','67522','74346','67715','20362',
                          '27908','27964','47304','60182','39787',
                          '53569','16819','89358','68943','39267',
                          '81659','16741','71875','38461','24822',
                          '85591','20504','36969','14082','37714',
                          '94143','99648','33299','30118','23926',
                          '72010','44653','97404','48967','84980',
                          '18199','25203','28473','13245','54852',
                          '73221','96858','44062','59787','51226',
                          '77501','58776','57090','48100','61804',
                          '94741','34123','99258','61719','94868',
                          '41873','43395','52920','66523','47225',
                          '56069','88266','68057','65788','94677',
                          '42245','14620','11820','43964','45616',
                          '58714','31771','39086','99924','12010',
                          '58314','28089','70820','65460','80582',
                          '90130','84897','10069','52461','61383',
                          '74641','58868','83397','96978','88600',
                          '90392','91900','31038','18078','92523',
                          '24035','16350','77499','61656','26970',
                          '16702','81147','75819','92622','38151',
                          '74741','27802','37781','37079','59195',
                          '96077','75290','74841','62688','46688',
                          '31964','50353','22431','23351','19714',
                          '76161','70247','47378','45968','30056',
                          '76137','78283','43535','16674','89016',
                          '51528','30057','80097','65133','12882',
                          '85859','96525','83720','86906','45491',
                          '36719','67776','40201','75472','95731',
                          '41469','76535','73928','94972','31531',
                          '76889','60714','57369','15343','14846',
                          '58032','93065','15106','12609','64499',
                          '30467','81646','93329','42567','35069',
                          '54484','33405','69644','45708','21323',
                          '68897','56939','75986','41685','59721',
                          '75789','67492','45110','16619','70258',
                          '94045','95152','52540','50698','96285',
                          '90857','94406','90146','58804','11317',
                          '99594','32629','43092','79147','49912',
                          '62647','48497','48205','51014','43066',
                          '45944','85998','28244','32146','56892',
                          '73080','71342','67441','83202','25769',
                          '18243','11304','75329','76266','80860',
                          '76551','73289','48931','42330','89421',
                          '85304','87967','69586','94291','35047',
                          '53235','23018','60881','11004','20419',
                          '66521','51793','94565','64734','20183',
                          '69846','23219','44211','56796','34183',
                          '47784','69638','84841','45703','67820',
                          '30173','13636','51249','30175','38116',
                          '62065','62696','89672','48554','96082',
                          '38601','93935','96138','94870','40370',
                          '69149','96806','38291','37841','37353',
                          '37808','14887','39414','82924','76469',
                          '38593','25365','89309','12550')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


