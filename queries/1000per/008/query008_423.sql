
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '31366','62877','39790','60988','80131','20824',
                          '44983','48470','13967','78818','51123',
                          '80341','22342','59434','76811','25698',
                          '97512','29620','80946','13941','22863',
                          '15249','90634','46014','33247','85237',
                          '28587','97565','44828','71852','53083',
                          '98184','77353','76502','42426','10747',
                          '93124','19291','88194','89446','95444',
                          '53172','81313','86969','74427','97298',
                          '29532','81169','67823','65038','26126',
                          '78603','41935','76606','24432','85942',
                          '61500','59325','92493','41220','96871',
                          '24684','56665','32263','32043','86025',
                          '47678','63062','40699','75036','95439',
                          '39442','21896','61945','82487','39647',
                          '20162','13521','57134','29036','45589',
                          '11922','82162','44032','77978','34452',
                          '35048','59857','66070','20889','11907',
                          '91059','88895','81187','30425','96988',
                          '51085','27198','85233','96422','58550',
                          '21314','16476','36398','63297','12619',
                          '99558','56659','75107','12617','68588',
                          '23399','84060','33335','41255','25012',
                          '25302','35360','10171','91616','40775',
                          '32360','30945','71803','65977','18195',
                          '12629','66725','43866','84702','56997',
                          '40250','34649','74863','37585','74333',
                          '37016','30507','59020','80204','32064',
                          '75665','15903','53341','90839','33626',
                          '84568','96185','83626','85736','97434',
                          '83951','47954','55583','82410','41827',
                          '82971','40772','51278','30930','26543',
                          '89085','79738','53340','48098','71609',
                          '48861','24848','62408','45381','63855',
                          '18178','94868','72581','44727','90010',
                          '77535','51507','24605','25686','16082',
                          '52150','59604','52069','20992','98157',
                          '60119','87754','78606','88171','26227',
                          '59748','48039','98052','62803','32115',
                          '17054','59156','58246','35682','84641',
                          '47204','41317','64253','88926','46593',
                          '98597','25205','65703','96086','64336',
                          '92043','68669','91175','81171','60748',
                          '57876','83829','81637','60186','18197',
                          '50019','30431','37118','67482','64608',
                          '84249','27986','68764','70926','89458',
                          '81199','69822','32895','55932','22691',
                          '50485','67988','49636','76367','69570',
                          '74745','99285','12716','44953','50376',
                          '37668','29430','46309','62722','25258',
                          '80061','12277','53434','79609','14027',
                          '14609','29458','93871','99425','77572',
                          '95935','63045','82482','15296','72795',
                          '75317','37889','54360','87932','27959',
                          '93801','71266','63302','14514','94825',
                          '27510','81995','93359','27252','69560',
                          '89540','75491','25612','48152','88870',
                          '39601','53121','71905','62231','13212',
                          '29072','37616','81900','44271','62899',
                          '75934','10023','78573','81415','42340',
                          '73502','98960','65864','84911','99078',
                          '87575','13704','36122','87837','37168',
                          '98029','17863','22216','89630','28631',
                          '39162','92688','16092','79616','96575',
                          '13977','44667','77946','45311','67232',
                          '29202','76507','42913','30093','72117',
                          '12736','63686','48265','47838','17496',
                          '87336','12035','99296','50361','28963',
                          '56517','74176','65355','12133','65955',
                          '14107','67759','64871','64498','52549',
                          '92230','80845','63883','79605','81170',
                          '49367','69794','39010','95773','24990',
                          '48633','21973','30667','43035','96000',
                          '13377','10162','80257','25876','21337',
                          '47202','19881','60959','38911','80914',
                          '46669','30120','77147','51166','33529',
                          '57684','83197','69699','57691','74877',
                          '61665','38433','65807','72461','47156',
                          '80651','41031','93916','21682','74946',
                          '65571','62265','12062','49940')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


