
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '20671','26256','31534','24891','73680','36398',
                          '29017','17610','54749','36110','12712',
                          '46361','23952','89349','16046','43906',
                          '17676','42108','59842','24794','25405',
                          '56093','52821','38823','91439','39601',
                          '33907','62490','89660','80664','96517',
                          '46553','68503','88867','37956','64067',
                          '80607','73712','40328','88973','46844',
                          '66461','75161','10511','22131','44015',
                          '76159','29044','20014','86735','34084',
                          '85070','96403','30619','80557','71801',
                          '26520','65407','99602','58842','18128',
                          '18022','26570','30947','85402','64334',
                          '86298','37342','21929','69629','67975',
                          '62791','28422','43019','37375','12435',
                          '61904','63327','24185','89435','87672',
                          '31111','30114','43157','57268','86169',
                          '87844','40945','87524','43437','75187',
                          '38721','35452','45164','81665','86873',
                          '48519','76380','81189','81880','30024',
                          '31358','87903','87366','72602','53740',
                          '25707','14959','52470','43746','55204',
                          '31353','84544','28388','34339','91072',
                          '23830','94372','80841','67959','23070',
                          '65474','75452','66433','22850','11172',
                          '67014','67060','38526','15491','29825',
                          '20532','29434','72039','45327','16526',
                          '71794','79211','79801','37927','11973',
                          '98042','13759','67143','66549','73193',
                          '66681','21975','37159','51559','50165',
                          '25068','20547','62673','48491','75124',
                          '73284','63398','64098','13734','72515',
                          '92211','89632','14235','83039','39541',
                          '83680','89910','32581','82919','73719',
                          '56179','14154','27545','28133','80160',
                          '70746','37853','72354','22715','34580',
                          '29503','25781','45209','61661','52688',
                          '19690','59217','69285','34292','48195',
                          '85810','27238','71816','32833','11776',
                          '78409','88291','43288','22098','47857',
                          '11315','38454','33493','52051','60387',
                          '89579','61242','98320','79841','81640',
                          '71131','40059','62375','53135','99143',
                          '19108','92203','61159','15873','38536',
                          '81732','67991','68741','23470','66944',
                          '69000','71866','51909','22093','52651',
                          '52952','73757','12119','54920','25022',
                          '32256','29077','51971','23005','25567',
                          '24097','76940','65047','51791','35073',
                          '68299','90537','23870','28476','78186',
                          '23088','85220','40459','47225','95716',
                          '14470','59214','89541','37863','59890',
                          '11063','58775','74818','96140','82955',
                          '36858','41001','76119','68891','18941',
                          '64058','17390','79203','92507','58322',
                          '58238','37552','26519','41483','24893',
                          '18711','66417','45812','41324','75924',
                          '39216','60330','75386','57838','26831',
                          '99869','88697','52766','17839','57051',
                          '79097','34356','68553','60544','57723',
                          '92778','18898','36964','10539','30406',
                          '98656','98147','96638','43692','20083',
                          '81343','95217','80696','55506','89879',
                          '48358','30484','23576','88588','61461',
                          '38227','17706','35916','37311','94073',
                          '98507','89475','52100','73604','85451',
                          '54822','87259','13783','48447','21906',
                          '20260','31404','47765','13003','52586',
                          '41058','47794','40646','43542','87019',
                          '13456','91345','23646','26078','89131',
                          '20587','12962','43134','48344','23396',
                          '19777','18188','97667','34935','55090',
                          '24731','94608','50473','10821','32053',
                          '93200','65097','21717','93906','83717',
                          '47876','79900','13299','69947','70493',
                          '92066','15591','47034','56726','25922',
                          '91200','88800','99013','35190','85913',
                          '16076','50291','87749','61809','62687',
                          '64068','90145','52120','11159','67420',
                          '90254','44711','10565','95527')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


