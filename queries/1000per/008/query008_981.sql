
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '53925','86121','99726','58117','95594','58127',
                          '81499','69025','82303','99885','34091',
                          '65480','52163','50707','52878','96051',
                          '66407','28567','75953','39003','93229',
                          '77063','24593','73234','65207','40313',
                          '57910','39166','57535','72844','71499',
                          '88670','52347','52956','74047','11027',
                          '60945','51512','75617','65749','79535',
                          '51686','38782','25585','95563','94760',
                          '96933','33832','34607','51219','26871',
                          '10442','87345','16028','25124','48871',
                          '60829','65553','91510','91157','50765',
                          '11677','42727','84579','56116','92107',
                          '54561','22937','84298','24173','29392',
                          '14530','72812','36700','56288','33952',
                          '12166','46648','70351','64234','54370',
                          '93850','66071','73941','92835','12579',
                          '95249','39587','70879','20797','12389',
                          '15858','12191','53150','56620','62841',
                          '63471','44328','63951','73980','24360',
                          '33631','86829','69209','94368','33941',
                          '62018','70808','10682','39828','68590',
                          '49501','88878','83130','76593','52010',
                          '40365','92888','26492','68623','45908',
                          '77924','38646','47742','86210','79390',
                          '43435','25086','92680','35695','69855',
                          '64946','96331','56385','20131','60537',
                          '73847','88001','74034','37081','22745',
                          '60371','10900','25258','95458','81800',
                          '56893','79586','74325','28547','55033',
                          '26779','69415','47272','80480','75909',
                          '81041','16021','73675','86266','71346',
                          '89154','22520','90558','70836','20480',
                          '76966','54498','14001','31088','73127',
                          '46559','95260','29849','64589','41267',
                          '21008','83707','83608','18700','31521',
                          '42176','27657','79702','80712','36164',
                          '15934','61750','58521','68820','85004',
                          '21351','63402','10307','52134','13390',
                          '43348','52950','87008','12196','29939',
                          '42864','98181','78298','43035','46172',
                          '32500','28744','95687','94850','46905',
                          '61880','68497','53055','62873','46441',
                          '69573','70887','38087','13494','32930',
                          '65115','46806','92811','43052','92930',
                          '36620','20218','19578','86664','33029',
                          '95613','47322','13193','72289','70534',
                          '10351','38844','85061','25687','36247',
                          '23893','57016','10324','20950','34116',
                          '68858','72310','50655','82872','24166',
                          '40018','68045','25033','77101','25870',
                          '50453','51076','60508','36868','41295',
                          '54166','54763','88025','23000','24417',
                          '76563','47216','35885','34338','41306',
                          '38633','44442','53070','70075','86322',
                          '54953','88241','44262','69121','10488',
                          '98319','74558','36448','61769','23473',
                          '83505','25154','37173','51841','83921',
                          '91685','50157','12621','97509','74220',
                          '78023','93695','31961','59995','79024',
                          '70936','68081','93089','69919','51317',
                          '39222','26477','50384','42626','53764',
                          '90815','31098','93418','73963','82441',
                          '83923','14903','11758','20597','27188',
                          '18516','74337','64367','35740','49555',
                          '59099','17185','93954','54327','12954',
                          '47437','96905','36990','28445','54946',
                          '95996','38456','86962','46557','43601',
                          '64682','69409','31643','29633','38673',
                          '66657','43272','90227','27662','63470',
                          '30269','16880','59122','43543','41355',
                          '94523','64003','65578','30659','78241',
                          '88526','87310','41326','99673','27806',
                          '16468','20554','68965','59207','83361',
                          '64603','28940','14955','35074','31279',
                          '40842','71122','75835','56269','39189',
                          '64565','61519','71238','79256','71993',
                          '55168','98772','18718','74415','11600',
                          '11034','85383','24119','84068','26933',
                          '92611','84480','93601','39847')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


