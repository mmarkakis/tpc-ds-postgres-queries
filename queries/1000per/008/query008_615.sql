
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '88981','77732','37380','90056','56632','44486',
                          '30092','53336','38483','66167','38058',
                          '18127','92143','22841','60729','15320',
                          '56714','62491','98768','70074','57606',
                          '37412','14880','75061','30857','50273',
                          '14265','52267','98630','24103','35983',
                          '74463','85970','34701','19755','54468',
                          '39931','95393','80220','74997','82516',
                          '63747','72821','70639','98314','17500',
                          '92101','63715','32828','42674','53642',
                          '44937','95308','43792','82560','28467',
                          '41303','54755','44487','80631','99007',
                          '29188','97188','59290','73102','10329',
                          '59468','14294','93525','84860','25810',
                          '85694','14953','49860','66000','79783',
                          '92728','88092','88915','24338','51331',
                          '59010','96388','27320','63068','85652',
                          '71809','44093','99510','54019','54434',
                          '89169','45965','35659','65724','31455',
                          '69331','58910','63034','52358','91085',
                          '12260','80512','80415','93185','87709',
                          '19719','86151','56013','53813','65515',
                          '57531','49152','82532','46661','55848',
                          '32280','88172','63654','42529','74837',
                          '95475','26995','70125','95775','55707',
                          '50340','20894','81612','24948','69859',
                          '64602','76613','78237','79905','65375',
                          '62778','76977','34842','25498','62261',
                          '17443','22058','54204','40919','70923',
                          '28492','86776','89726','75870','21001',
                          '51509','39896','87639','95738','26621',
                          '90749','70315','84977','82911','67053',
                          '99998','27088','25744','89736','12282',
                          '92164','73974','38358','14810','73743',
                          '96260','18266','72603','89406','98609',
                          '59944','23162','87994','65835','50937',
                          '57360','53816','63951','59673','44652',
                          '63596','24639','96116','56779','56139',
                          '99440','89131','63427','95816','15567',
                          '64670','10363','81736','18065','27585',
                          '41152','30747','96398','20948','16932',
                          '63888','79032','43416','57822','21437',
                          '79435','91852','58549','52218','55264',
                          '95742','26062','94420','27267','30929',
                          '57290','65217','56973','32802','36414',
                          '86541','57765','97897','18170','34514',
                          '39483','43231','15635','24964','44147',
                          '47649','21271','56276','24234','84660',
                          '51618','12814','17680','52098','10668',
                          '82517','36067','74730','45646','52417',
                          '16030','98072','44881','22765','33131',
                          '98748','90420','99638','26706','92538',
                          '58466','48523','98984','40360','63228',
                          '10817','60616','90706','40041','12817',
                          '39777','97990','40138','33854','47904',
                          '94451','18348','52920','99115','89860',
                          '28631','17406','48451','56516','74295',
                          '99930','94383','68432','19306','29230',
                          '13697','84552','89182','34814','95841',
                          '17414','29699','19155','93986','99275',
                          '38950','37037','35843','97683','61414',
                          '47320','72400','99094','57565','11306',
                          '77712','15975','77430','47545','80525',
                          '59403','99639','79582','63288','21056',
                          '81608','41279','57384','23817','69042',
                          '24399','61988','13366','76384','87211',
                          '15902','17186','84209','94762','63677',
                          '32044','55009','95948','27573','72749',
                          '95887','65652','14857','21382','38991',
                          '30077','38917','88427','36400','26102',
                          '42182','87088','59796','81286','21501',
                          '57340','82498','55479','11682','10971',
                          '79918','90087','44592','46612','75644',
                          '85805','44558','38166','90513','28746',
                          '58527','38449','89089','92019','50810',
                          '45653','13561','54027','75575','32483',
                          '47213','37994','15909','93090','88051',
                          '65540','54430','69154','50746','80962',
                          '19405','20927','46695','64793','86690',
                          '97976','54705','10400','95471')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


