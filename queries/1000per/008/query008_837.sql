
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '94805','64543','65251','44257','66612','46600',
                          '73585','92344','14070','13479','46315',
                          '41909','81548','82259','47465','44739',
                          '98316','31075','61434','53246','74291',
                          '49076','87077','49963','61242','97541',
                          '13362','68048','32186','62450','98597',
                          '77578','37963','40723','39161','37649',
                          '26015','70171','29665','34619','59842',
                          '30738','75122','59709','89751','78926',
                          '53531','69610','27349','57911','65029',
                          '54277','12374','45683','48274','93872',
                          '84252','18073','71794','72126','54847',
                          '38627','33768','42294','99266','34102',
                          '15942','51618','52195','45232','86962',
                          '23401','51935','62539','27331','79654',
                          '42211','46443','73658','86171','58761',
                          '75377','90833','32305','41005','59230',
                          '83560','95481','17854','78521','35710',
                          '44950','54149','26712','22837','49176',
                          '42482','10623','30333','24302','21690',
                          '84124','96061','71879','65994','80445',
                          '26203','45367','16247','11497','57856',
                          '39838','31996','15188','85810','95206',
                          '71623','16046','50913','42891','59592',
                          '10907','73498','37296','67707','46604',
                          '18275','50479','33738','59341','52583',
                          '68940','30166','42794','91805','53598',
                          '81370','15014','47742','20304','27438',
                          '42327','62477','60852','66488','84319',
                          '64689','53412','72921','50472','55633',
                          '71177','47123','95269','97080','46337',
                          '21386','87706','79731','99668','25911',
                          '64351','92021','60884','19887','59464',
                          '72841','79266','67997','29356','80848',
                          '70619','37759','73001','30407','27611',
                          '81390','19026','14034','47219','12353',
                          '88468','70537','30191','76880','69683',
                          '87714','96631','59445','44417','64441',
                          '94339','48194','98654','21105','94020',
                          '38277','50711','87661','10193','24370',
                          '62827','87679','91875','21995','12022',
                          '22534','14642','29860','43890','85380',
                          '52410','35450','68135','12005','80057',
                          '28369','51734','40262','79909','37279',
                          '15294','37633','11491','82105','97711',
                          '71964','57587','67124','29116','70526',
                          '11804','55392','27621','18476','67426',
                          '80460','79152','80129','88288','17142',
                          '14491','79601','94539','89743','32745',
                          '75308','83439','49995','23462','29240',
                          '69017','50650','79926','70499','63857',
                          '48696','56093','70398','19018','64178',
                          '91395','50382','49361','43623','76453',
                          '35346','31853','17224','71019','60770',
                          '16639','67422','37453','46644','36073',
                          '64061','75614','70773','55982','47312',
                          '43759','51429','94882','80472','65769',
                          '96652','48640','89675','59557','81685',
                          '73452','19657','80816','71317','27175',
                          '14899','23670','53174','41717','74368',
                          '89656','80401','48935','48842','23141',
                          '71635','50801','49890','55344','69630',
                          '38897','56382','36134','46275','32460',
                          '38319','86900','37781','54497','84131',
                          '90243','30833','89023','53967','56607',
                          '98756','79842','66350','58407','79086',
                          '92189','85360','61890','38525','13096',
                          '40645','75246','57070','46462','78955',
                          '93438','89959','38426','31327','92496',
                          '89070','51711','43989','17303','53300',
                          '76704','61392','69293','88783','74463',
                          '26799','67111','59252','51815','12254',
                          '24851','70174','75143','55882','21630',
                          '85176','95338','82425','45318','91092',
                          '85407','78168','21903','29996','60920',
                          '21651','17028','93889','90072','24964',
                          '91974','63174','56390','63110','37028',
                          '71735','46170','56527','71213','60424',
                          '35943','26420','96929','53095','76749',
                          '43043','10849','20545','75324')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


