
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '74657','78678','71892','94572','29024','10942',
                          '55709','59755','36842','24999','60515',
                          '95057','69696','11102','99268','48043',
                          '85267','87378','48391','55238','94854',
                          '50201','29409','84992','18267','18501',
                          '77306','33141','66927','22239','36950',
                          '57227','71770','98002','99845','32668',
                          '41774','29892','46756','86622','75471',
                          '90538','17494','81078','12927','96151',
                          '31794','25125','97735','51750','58985',
                          '18499','64765','64711','80568','12938',
                          '50056','75377','12371','83473','63037',
                          '68264','62691','88675','37378','20478',
                          '54781','51569','39329','94256','92267',
                          '49854','49145','23587','64357','84696',
                          '17014','83644','66802','84493','46153',
                          '76733','42561','57371','89806','45168',
                          '70018','53534','24914','96662','31947',
                          '24231','40010','64642','59892','75152',
                          '80426','93450','77563','39554','54438',
                          '78315','82532','54413','31673','45350',
                          '95232','88769','56920','39305','89285',
                          '14262','87420','28203','18793','48321',
                          '47459','96815','14616','10527','74537',
                          '11299','68879','94359','82592','13624',
                          '16102','64728','84634','18295','48888',
                          '96010','81090','22951','80500','12212',
                          '60026','19126','68193','34864','63914',
                          '44472','78545','57750','34754','49544',
                          '77219','94173','78562','88000','77796',
                          '63980','48688','59116','28393','72843',
                          '38125','93379','24210','72639','37677',
                          '67722','64187','98890','51980','77332',
                          '36262','25017','98352','40561','93115',
                          '16063','55659','39021','50050','11306',
                          '12416','82037','21585','50609','75549',
                          '51856','41825','62162','74401','69297',
                          '68580','11320','90887','10751','41661',
                          '56509','47735','66765','33388','58083',
                          '89683','93437','77042','42205','19811',
                          '26284','14640','29084','95439','90424',
                          '57668','14645','52689','52228','63671',
                          '59661','26820','70432','93436','21521',
                          '73165','57002','91062','79528','80462',
                          '17516','86153','14565','79646','14368',
                          '46784','86563','52708','11354','73881',
                          '98805','36515','20054','77392','28700',
                          '77469','21108','97895','63232','80038',
                          '96317','94100','14485','86922','91646',
                          '96733','79508','78263','94687','70178',
                          '41460','48174','30487','99586','37809',
                          '95809','46850','32035','32273','54818',
                          '20275','19554','97505','42722','40805',
                          '96498','45065','13778','56608','42931',
                          '57062','38595','84254','37902','24928',
                          '40992','27717','44058','10932','62149',
                          '44134','97090','88068','54492','25297',
                          '11988','84927','81354','14277','74103',
                          '92722','30430','60054','10553','51609',
                          '15178','18288','37699','19622','10556',
                          '70392','89222','95618','29364','93007',
                          '56025','95345','93712','27032','57661',
                          '33479','68319','22656','54431','67234',
                          '55664','92831','63635','72895','29401',
                          '24202','32763','99172','84622','96770',
                          '77411','16569','94654','84233','62081',
                          '26082','79498','54284','95878','64788',
                          '42416','96739','94061','86642','31814',
                          '58595','59492','50597','37542','94070',
                          '61106','74849','44567','24610','21968',
                          '19375','20362','46212','36459','54421',
                          '32694','72529','80285','27557','87718',
                          '26559','74500','78946','66328','62156',
                          '80491','96531','42380','44802','71168',
                          '83435','99673','66446','60521','18081',
                          '35762','54787','83055','98010','55808',
                          '60640','72902','26209','25335','57040',
                          '92920','55637','19064','24509','53782',
                          '94766','61393','91600','23474','56575',
                          '12055','58577','57104','37415')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


