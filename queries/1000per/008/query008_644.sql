
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '63139','94007','98555','66447','58449','47656',
                          '23228','34351','80014','77780','44235',
                          '46038','29910','82575','16596','42810',
                          '30162','97778','59152','80524','69123',
                          '96483','78181','82696','33036','74608',
                          '34300','12640','49158','58377','63441',
                          '75876','24799','75198','18453','64284',
                          '70534','81531','84932','73686','46688',
                          '31695','39225','69710','55603','79122',
                          '26140','62820','93998','55213','10551',
                          '18395','39335','56825','46180','53005',
                          '33797','68737','85471','34527','88312',
                          '98067','56476','19045','97745','43678',
                          '38180','97433','88742','50136','80537',
                          '72730','53086','30495','57178','86738',
                          '91123','47668','75185','76275','41636',
                          '38549','85612','12558','34902','40453',
                          '96115','66275','94984','61968','14615',
                          '65752','22050','18176','24009','61570',
                          '59850','22728','21077','18313','51913',
                          '33032','80528','97424','25022','59101',
                          '74875','10835','40323','10682','33049',
                          '30408','34357','68935','88437','64200',
                          '38379','45610','41944','22819','24391',
                          '58268','57007','51524','40533','13282',
                          '96276','80562','74566','15666','79397',
                          '37626','97884','42284','59194','54001',
                          '74134','38754','50693','20433','17574',
                          '71320','53526','82289','62964','74869',
                          '65696','47848','39157','47096','32370',
                          '42177','77748','84896','76458','38232',
                          '70500','89190','49190','89623','32492',
                          '20556','58529','51619','88730','47303',
                          '48037','18426','14699','40159','55278',
                          '23265','74034','26543','32009','43289',
                          '41168','99481','37723','80200','51848',
                          '78098','70490','39676','88361','80286',
                          '31494','20924','39719','26896','68404',
                          '99719','96021','59245','37639','69106',
                          '23390','51133','32544','86450','31133',
                          '68866','80721','60200','88498','28384',
                          '70625','57960','69595','16002','91141',
                          '90735','22001','36936','54000','25589',
                          '47741','94048','87456','63982','55323',
                          '27861','53588','71234','96030','85009',
                          '80751','32434','92277','68473','78519',
                          '57662','48368','64306','34116','19434',
                          '64494','23906','83896','57304','64156',
                          '85344','77716','58246','87253','91133',
                          '56152','75387','27391','43430','83395',
                          '10675','24293','36666','51884','93817',
                          '60634','44290','40608','53825','67620',
                          '12701','78860','93154','98816','44500',
                          '92567','89330','42264','95987','83370',
                          '71744','20171','54789','60329','65979',
                          '22662','50080','44897','96616','74603',
                          '19747','37063','77108','19083','63983',
                          '40687','87419','71232','19950','98369',
                          '88160','29170','53151','40343','77165',
                          '73526','27678','91519','80881','15529',
                          '96841','96774','81327','40870','33209',
                          '27655','53507','20022','59813','74267',
                          '84701','88150','16942','71784','17782',
                          '78718','56719','50649','41252','25427',
                          '54621','66929','80074','39999','21304',
                          '93164','58544','71032','47664','96044',
                          '92333','32893','93236','60656','18533',
                          '92517','82422','82385','87348','80442',
                          '65840','97458','62505','90670','32768',
                          '22423','42940','68205','24904','49560',
                          '43810','66503','76025','14480','40398',
                          '48497','66830','84811','18184','42831',
                          '90513','29737','19701','90285','36953',
                          '12171','80505','29250','35417','95191',
                          '26258','33628','84751','85850','91806',
                          '47208','25253','22544','90971','17363',
                          '20449','85955','19016','73113','69035',
                          '28646','10532','61291','88327','50549',
                          '82196','82560','37832','17841','28496',
                          '75506','54313','17404','41050')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


