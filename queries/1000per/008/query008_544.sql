
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '46799','60752','88335','85209','31396','17835',
                          '89938','72893','68802','19097','82909',
                          '55404','35962','56548','55068','50089',
                          '21003','43290','87834','10976','17624',
                          '90703','18580','38230','44358','64040',
                          '84087','75808','81141','78064','28179',
                          '68680','16979','73835','92331','76255',
                          '14097','92538','88193','29566','22668',
                          '37365','85581','72114','64801','49864',
                          '72172','33740','78813','79108','57690',
                          '53802','44091','88021','91588','35614',
                          '81947','38422','38925','64605','25186',
                          '92949','16792','44043','24600','53054',
                          '64316','21247','66456','62386','26346',
                          '19575','98085','19303','48265','16746',
                          '73299','15454','95389','43101','70215',
                          '89551','82564','93083','95089','94783',
                          '95810','57588','99964','38655','41900',
                          '55229','74488','35650','79863','67971',
                          '61644','37741','30421','14670','13402',
                          '64603','16635','30631','56398','90182',
                          '11650','60568','59220','36237','12869',
                          '47527','80624','27407','96280','46390',
                          '51177','59304','47964','33777','83363',
                          '24953','84515','36881','54183','51736',
                          '96614','44452','98778','17598','14470',
                          '45422','72626','47600','20494','53063',
                          '84272','81608','78322','63846','80911',
                          '44300','24798','37276','15681','94696',
                          '13122','65667','41974','42495','34616',
                          '94477','88041','97530','10997','33536',
                          '27953','66286','54501','49915','64607',
                          '32285','35829','74303','30635','82364',
                          '12533','18235','60902','41162','42043',
                          '76646','30435','31031','72220','14597',
                          '92593','54442','24376','35636','40785',
                          '63338','79202','87023','49851','29424',
                          '45980','12054','45760','64204','56760',
                          '98329','41574','99546','77711','13745',
                          '50173','29093','63433','38737','35299',
                          '84198','79975','10617','72583','18561',
                          '63939','85547','94008','95195','68445',
                          '16079','75913','54634','13802','12184',
                          '80525','43242','29965','93346','30459',
                          '69514','37309','16906','12949','13094',
                          '54792','52438','45829','42332','22767',
                          '28789','53113','38453','21907','89032',
                          '78694','70805','96853','94612','63273',
                          '73615','43631','99217','15690','86570',
                          '42922','35234','78902','63875','92076',
                          '52221','59153','96562','35992','28030',
                          '69534','57287','68069','17821','44953',
                          '17230','54062','27520','21231','55678',
                          '27575','34696','30518','18247','94063',
                          '93421','99898','26968','50735','93062',
                          '44812','73880','53399','12937','86048',
                          '18286','66014','57826','34508','72253',
                          '84157','82543','28611','65560','45293',
                          '90208','28090','75367','62488','81680',
                          '61854','69930','23314','73476','99615',
                          '39490','37321','92221','54898','55431',
                          '23832','79864','82342','40737','22269',
                          '87705','13727','78250','94291','85185',
                          '99925','32824','72334','18494','37765',
                          '36819','94643','21236','58960','43126',
                          '26559','12254','33161','45360','74671',
                          '42460','55106','92856','25260','64529',
                          '97492','51727','13604','16795','66880',
                          '48424','76122','25224','16212','32306',
                          '90100','19282','33215','25829','72100',
                          '49392','69815','72549','30268','28208',
                          '32056','56916','99799','59002','24154',
                          '94555','37339','31645','65625','69204',
                          '41493','90195','13548','30710','57590',
                          '16685','25434','10627','70618','99792',
                          '23343','17826','31229','59397','23392',
                          '17641','11416','13481','99396','52954',
                          '95104','93933','94865','89886','23816',
                          '39026','12182','58745','49459','28108',
                          '66237','62695','44423','30085')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


