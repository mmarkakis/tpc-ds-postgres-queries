
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '54757','66723','27651','59870','86837','46657',
                          '68239','43907','85201','54298','19459',
                          '33579','86635','22039','55730','29540',
                          '94609','83341','44913','16505','25237',
                          '68807','77455','21748','49674','53685',
                          '87571','82964','85458','83446','31223',
                          '12886','94539','56354','18997','92263',
                          '33923','29835','47926','85365','46484',
                          '21837','79587','88775','62478','83689',
                          '30645','84526','45847','96265','58828',
                          '79708','12323','92270','27240','29769',
                          '12216','87357','68747','87164','59452',
                          '27444','84358','24082','31337','63754',
                          '82590','42635','59221','15207','98072',
                          '66116','86615','56860','18417','88815',
                          '62651','22794','99265','48617','68008',
                          '28666','90035','51587','95789','47304',
                          '54247','72119','15255','50346','61291',
                          '80047','80490','75965','54937','24604',
                          '49594','34952','25864','50082','29788',
                          '87891','20918','15337','44676','78586',
                          '82418','87897','77364','44168','27208',
                          '63026','62905','63307','77403','67889',
                          '26420','94217','92413','19957','13074',
                          '74211','97078','58670','74167','51026',
                          '41259','38663','82677','21786','97253',
                          '60130','21543','12354','83766','14033',
                          '44166','68402','26236','43187','47803',
                          '44896','63390','55718','85436','24474',
                          '85143','60969','41924','66485','73370',
                          '41525','37426','18715','87411','19011',
                          '21499','70754','41937','38793','66127',
                          '93494','64158','14851','89634','55989',
                          '20787','70786','39033','51465','95155',
                          '58500','17579','50132','25225','88712',
                          '57885','68423','49743','35611','82041',
                          '84863','74773','60387','78696','64654',
                          '72849','36251','56234','16492','95623',
                          '82320','97785','41271','40552','75328',
                          '77680','95282','98623','39075','53674',
                          '67569','29429','34333','17488','12913',
                          '50669','66779','20288','66383','62816',
                          '56063','98894','79988','36198','74683',
                          '80796','76480','34644','37373','77535',
                          '22310','57450','28003','32205','85058',
                          '65915','40328','60872','42758','74396',
                          '33942','98877','52926','62333','13913',
                          '96039','83203','32010','77252','90106',
                          '23378','39627','77969','97169','85101',
                          '27171','86015','54034','56782','48031',
                          '98470','81430','71547','51660','57742',
                          '10026','41365','41367','94291','75100',
                          '48962','85266','37552','74650','81438',
                          '78841','26218','31147','93655','51799',
                          '90185','82963','49039','56672','73881',
                          '86052','16285','47115','65419','43853',
                          '15776','42916','93678','61181','78215',
                          '38539','34434','20478','47631','45133',
                          '62753','88331','20924','35980','76534',
                          '44217','19059','90559','71267','64041',
                          '72631','71714','96255','55431','42594',
                          '17689','34904','88693','69915','76514',
                          '37180','77991','15290','53195','32799',
                          '72114','69883','28419','94701','34506',
                          '74498','12520','73009','97273','39119',
                          '84948','20677','65319','88121','37053',
                          '48020','81468','88687','40369','88996',
                          '96224','79212','25671','67675','22582',
                          '57108','42719','72177','19111','78682',
                          '69184','28896','58195','90771','54996',
                          '49202','72062','99767','16291','41808',
                          '68689','13268','54602','57544','85233',
                          '48890','78576','83938','80059','71697',
                          '37628','40616','56448','21989','72422',
                          '75733','16504','57831','41829','96104',
                          '19333','95593','58129','14456','24484',
                          '41083','54256','64296','45666','33760',
                          '27951','21093','56185','29297','56191',
                          '97837','25332','60751','40520','75224',
                          '13486','12267','18063','79671')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


