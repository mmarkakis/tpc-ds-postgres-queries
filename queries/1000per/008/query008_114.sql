
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '79501','88153','54395','40060','75164','91373',
                          '16258','56187','49932','87737','47627',
                          '31190','66301','34403','66650','85504',
                          '93119','82900','27009','20749','87067',
                          '98260','65751','57535','26932','32569',
                          '47366','18726','48165','38295','39588',
                          '39796','70042','75026','57776','83521',
                          '73351','94904','66460','18092','81452',
                          '94180','96491','96492','65946','24556',
                          '35684','96108','99835','46965','71567',
                          '81563','28203','58312','53635','61833',
                          '66552','82837','36516','81509','99240',
                          '71819','46436','68274','96901','64384',
                          '76946','15363','37859','91500','43763',
                          '85846','49998','92223','14069','26666',
                          '16797','69316','55183','86177','50723',
                          '72894','66617','20100','91641','92083',
                          '13283','32260','51273','66219','54521',
                          '69399','28990','98154','35313','73004',
                          '27679','71648','47774','29105','83286',
                          '96371','61019','47474','45019','92974',
                          '76021','37469','15113','14227','52426',
                          '33942','96176','24482','75628','59213',
                          '27822','26421','98441','36917','65573',
                          '15049','33199','20713','29259','67543',
                          '99008','17761','38783','93097','24257',
                          '23993','95542','93683','44177','71411',
                          '21761','30645','47030','26847','18629',
                          '77789','81750','38463','14816','34857',
                          '58483','39453','70638','38522','45517',
                          '43000','99788','79104','95949','73572',
                          '79045','14772','12086','25886','48754',
                          '71949','76717','57807','31241','30156',
                          '52264','79671','57368','41284','21741',
                          '64723','96260','88062','31908','74046',
                          '52768','29951','79940','19195','78794',
                          '28872','58862','30648','28944','68468',
                          '30692','75033','20084','24458','80286',
                          '25096','20331','34334','50120','78207',
                          '21048','42498','31674','98317','53395',
                          '18020','34080','74274','78136','96756',
                          '36595','68581','75101','82328','53011',
                          '88001','24686','87817','89279','98993',
                          '73870','40377','84195','27591','13870',
                          '81846','13776','42564','77686','17225',
                          '86131','41145','33900','69649','65972',
                          '96500','81611','93898','79611','53664',
                          '27523','81436','44551','58121','76232',
                          '49586','69017','14462','44498','86801',
                          '29649','38471','20451','12896','76718',
                          '78890','72732','94615','74743','92526',
                          '78843','23282','50564','90962','32804',
                          '82489','25500','93566','73030','91197',
                          '24289','27737','30026','67728','48626',
                          '94281','35125','17823','29220','89231',
                          '70572','37664','66640','42483','59127',
                          '27989','26703','75152','63268','81239',
                          '71722','25217','23655','12323','91774',
                          '39993','92549','56298','61805','55762',
                          '33780','44821','68512','24264','76413',
                          '71905','93422','24426','15377','93553',
                          '43007','90860','91543','38877','34187',
                          '36503','26623','24768','62149','31295',
                          '56795','89362','19048','66934','82573',
                          '21012','56946','23708','96360','22964',
                          '83657','10307','67392','90830','16142',
                          '78856','66502','26752','97754','54620',
                          '97138','57632','94201','99114','58186',
                          '47507','98232','56383','58003','68967',
                          '18056','60830','10479','82784','98621',
                          '88677','91192','74062','51540','80716',
                          '64152','58513','37653','11400','85895',
                          '76701','89656','49800','85305','11295',
                          '23156','94000','54386','16453','99426',
                          '90518','26406','48245','62187','72389',
                          '91824','68460','78917','67758','76839',
                          '96813','50035','62132','93991','37375',
                          '20972','19629','78630','41513','18009',
                          '41964','28471','21547','29808','23042',
                          '90864','55313','29827','23434')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


