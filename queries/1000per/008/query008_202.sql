
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '87491','31939','65092','67876','90646','72283',
                          '45115','14316','57717','96336','19588',
                          '81723','48484','42633','23400','26403',
                          '90876','73000','64014','36372','86249',
                          '21996','20360','81585','60515','56093',
                          '24355','83940','94799','85542','68267',
                          '42286','22940','32457','49564','81659',
                          '86295','91278','27407','56506','73527',
                          '26484','83313','58554','35397','42474',
                          '77157','74901','85867','99523','29696',
                          '42168','70718','49856','33664','53851',
                          '22556','69753','59955','83645','38345',
                          '29730','87683','64888','95939','85054',
                          '27569','36055','52173','72659','37856',
                          '96507','71206','26926','48032','69833',
                          '21868','47478','50826','76749','52313',
                          '82735','89404','44126','23708','31066',
                          '56067','64796','66880','86931','21057',
                          '28627','46076','63565','87968','39862',
                          '44197','48083','27495','17942','37664',
                          '93678','36457','83497','78477','85552',
                          '89424','69918','34830','48589','54202',
                          '22285','35785','69102','82033','62939',
                          '64772','72374','15595','86952','94833',
                          '91306','97817','49653','59525','69482',
                          '71723','48929','59445','96823','40625',
                          '39754','36554','62475','31141','86360',
                          '30554','81077','29621','87468','56441',
                          '59359','98887','84963','84525','18260',
                          '81983','79419','37313','68305','20763',
                          '51641','64248','50373','80718','82498',
                          '73015','82169','25838','10331','40151',
                          '65993','77187','60163','17067','20859',
                          '96389','67224','49982','55002','64216',
                          '40490','98786','53596','41583','25026',
                          '83882','99233','95712','41260','95566',
                          '49525','82098','85380','60072','12661',
                          '91510','29433','24063','29362','27426',
                          '83552','55183','21505','48954','95214',
                          '80801','71203','62597','79141','70427',
                          '16510','70955','81566','62485','37940',
                          '29449','56192','13702','87804','71558',
                          '42185','77606','73347','77022','78380',
                          '28432','38825','54493','14547','72129',
                          '73439','28583','18990','76224','67095',
                          '11558','10672','34692','70603','78603',
                          '38579','46778','80477','83658','81277',
                          '93610','37713','82234','19109','94607',
                          '45233','10870','52562','94522','39885',
                          '21947','80408','29148','45469','89094',
                          '16003','89660','98289','45475','59570',
                          '78903','31241','18800','91002','23208',
                          '40440','98711','58685','84216','96736',
                          '88398','55359','77411','46313','65126',
                          '30102','78287','14931','28621','28312',
                          '28594','13770','60366','53929','27499',
                          '18983','88532','68804','46960','69378',
                          '76220','74366','12844','29785','60687',
                          '24331','43977','13868','85656','65433',
                          '60015','66378','75493','30758','43857',
                          '10277','75875','77020','19463','36959',
                          '18689','79920','12156','65691','56981',
                          '25433','50297','55732','84745','65041',
                          '35381','53830','58208','54894','47127',
                          '85107','26642','45543','76711','75739',
                          '26033','32430','37319','85571','58561',
                          '89910','93362','98640','94283','14787',
                          '29594','26852','75301','44147','40985',
                          '59015','66571','28729','27072','77955',
                          '76249','28399','13304','30731','51582',
                          '12806','88415','81096','88922','37492',
                          '36748','23090','96645','45618','52731',
                          '53968','22792','68034','35958','68326',
                          '97349','28238','94420','76840','74217',
                          '46496','43937','73414','81114','50133',
                          '27580','32538','56558','24054','45157',
                          '58917','60442','99935','93934','26602',
                          '34164','27295','53027','35603','94669',
                          '32858','53063','92515','35602','62854',
                          '48696','45496','42917','61159')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


