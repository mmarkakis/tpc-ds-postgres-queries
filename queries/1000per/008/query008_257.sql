
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '51013','98160','89123','59713','37604','70493',
                          '20844','34190','59533','77517','83708',
                          '61810','12284','40552','25300','20848',
                          '13651','89026','84033','31200','14569',
                          '43704','56779','84865','50905','13479',
                          '65342','96270','43838','98325','35460',
                          '55116','97021','37526','77689','35420',
                          '17633','57294','38174','33172','23609',
                          '66208','18027','72028','22264','77551',
                          '22379','77411','68158','14287','94483',
                          '50445','99542','40488','63280','49928',
                          '87614','67719','46998','14190','24250',
                          '63033','99794','25378','53152','95978',
                          '89208','14402','98787','39551','48404',
                          '76372','74007','47441','62255','16153',
                          '26994','54757','45908','23181','13099',
                          '61889','47996','53227','69051','31099',
                          '38883','48003','21989','86063','73808',
                          '23314','17101','15873','66798','53675',
                          '19754','70683','99982','62663','95088',
                          '25594','34421','94526','79891','31202',
                          '57319','73733','95834','40511','88224',
                          '89783','15604','20360','39686','55644',
                          '67387','94201','17920','22010','65196',
                          '71895','21462','50600','89568','15883',
                          '69412','94080','70589','25160','84434',
                          '38614','21361','84039','56446','85849',
                          '98038','20276','47574','71704','91308',
                          '62179','20363','94421','88320','36426',
                          '80978','11138','87555','67417','69584',
                          '18217','71891','64586','30466','25701',
                          '26752','38674','26109','55945','64533',
                          '85527','96871','91432','36951','38127',
                          '75539','36327','28333','84360','64424',
                          '27400','89973','77427','47951','43348',
                          '56548','91761','47093','80019','80748',
                          '83717','81800','34698','98554','54733',
                          '88741','43121','95878','38771','34963',
                          '69354','75686','87367','80102','40517',
                          '94346','74633','79446','11989','79038',
                          '53293','62284','40624','85424','39945',
                          '70511','39536','12877','76820','59562',
                          '20207','46420','58917','72955','48366',
                          '65709','31809','39486','86495','93083',
                          '53841','23660','60884','35094','75735',
                          '59479','75573','43499','58034','33607',
                          '39167','99544','14910','13709','79305',
                          '18239','72855','44253','93754','74459',
                          '83505','23536','97574','68747','27149',
                          '45397','81517','10428','57439','99411',
                          '82332','73021','93232','48036','87180',
                          '61451','36584','99890','90536','18620',
                          '39931','92903','54894','88027','18346',
                          '39050','31198','88217','10844','16529',
                          '85591','96629','55521','12407','87800',
                          '68305','58406','22294','83330','31549',
                          '34967','28743','77468','89052','37312',
                          '41071','10503','81441','60040','25024',
                          '42754','14335','38290','98520','45863',
                          '63671','30159','85897','37602','30131',
                          '44084','34914','44312','47106','36415',
                          '60261','26211','36052','19438','28522',
                          '96658','92045','74467','66146','18698',
                          '45892','81052','64023','42628','87297',
                          '15426','77987','76889','79613','54930',
                          '52345','82749','83150','88009','36187',
                          '82599','71439','82833','24521','96782',
                          '52380','24868','40162','22008','28710',
                          '21019','68531','13400','76473','92504',
                          '79361','19136','51673','57719','49410',
                          '85816','62377','74745','31966','14121',
                          '83721','43786','34704','55800','14578',
                          '63964','78265','92873','48523','24920',
                          '30242','38153','64812','35233','60799',
                          '10659','69848','77087','53477','71394',
                          '92836','91216','24397','83985','49551',
                          '56740','16289','91552','67291','80072',
                          '88537','29635','21093','64134','28397',
                          '83810','43738','33092','38286','22880',
                          '13610','28772','25581','32086')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


