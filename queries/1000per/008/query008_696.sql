
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '31107','86230','54337','32035','60870','30187',
                          '85585','22618','12131','61200','64183',
                          '71216','21288','20187','11289','29441',
                          '25088','88067','79372','58704','59572',
                          '54889','34968','80756','40662','48837',
                          '57967','55139','65531','20670','12639',
                          '94533','89472','35617','62919','61477',
                          '49268','62155','86255','76208','71781',
                          '89519','19843','63854','86374','53374',
                          '55388','29012','99107','40720','15602',
                          '63122','24104','18333','76912','67189',
                          '98090','19869','57009','18822','27408',
                          '35027','75135','27493','80446','22226',
                          '22136','19825','11823','81314','88630',
                          '89053','31684','83309','37277','71058',
                          '63285','41256','10211','17623','70488',
                          '18444','16552','81885','43403','99936',
                          '39185','17099','61632','57159','13200',
                          '24101','99881','31261','44574','57030',
                          '40337','25565','38076','65998','35934',
                          '52963','20001','20054','30375','97561',
                          '99946','40563','52684','64435','45060',
                          '55572','54277','73869','97086','85187',
                          '53242','85540','34768','18315','51407',
                          '39298','33453','37186','31255','62561',
                          '60728','19288','39021','15365','19910',
                          '65201','14718','78237','60930','17963',
                          '64689','18106','94884','38474','20620',
                          '79792','80180','20777','23200','52623',
                          '94079','26343','11695','98395','40972',
                          '42602','89916','98571','12170','97182',
                          '76881','76366','79239','14961','17859',
                          '73047','27529','27787','46363','14949',
                          '12360','69283','41491','69998','24916',
                          '26991','43183','58180','13446','67229',
                          '50086','28917','76395','53023','64551',
                          '92096','64352','22533','75662','72489',
                          '90907','19858','96525','12487','46912',
                          '18927','74327','55970','44395','59456',
                          '72117','12383','19484','14485','77959',
                          '58069','66360','26178','11971','35225',
                          '95295','89362','17728','66840','93442',
                          '32638','76390','74911','15804','55919',
                          '49921','80546','28542','70355','63105',
                          '68511','28822','32326','66115','67060',
                          '84467','21694','32253','43235','90382',
                          '51947','60150','47321','43995','74065',
                          '79900','69243','74570','68377','85140',
                          '78396','54177','94953','12716','86995',
                          '42621','46626','53575','69257','50492',
                          '25445','70549','92772','84361','54376',
                          '79573','34022','41619','63254','86447',
                          '97628','64317','62985','83505','25614',
                          '77783','90293','78233','83089','90432',
                          '62183','88498','11597','83604','19499',
                          '28138','82993','20721','28793','21007',
                          '84844','53375','68589','71793','11167',
                          '40638','99730','76243','91845','95214',
                          '78998','92669','80281','46334','85898',
                          '13492','91413','62876','93723','55599',
                          '94395','66713','70562','59445','92456',
                          '28496','27153','45503','30119','55799',
                          '57796','65657','91435','71963','81247',
                          '31084','99251','77575','74432','89782',
                          '89292','75278','54571','60204','67671',
                          '46787','75573','28837','88328','84072',
                          '92823','24344','94867','96063','25343',
                          '59480','71548','36838','18210','25975',
                          '62785','82377','49768','96277','69145',
                          '99766','52660','72338','90569','34146',
                          '10020','23972','54101','34472','86066',
                          '18351','42437','70616','75682','80476',
                          '57396','27273','31372','41067','62496',
                          '72111','33519','67517','43152','91403',
                          '29181','87226','73972','68249','26563',
                          '90532','11836','77034','38388','31884',
                          '99697','94098','59817','90788','32170',
                          '16980','10931','37835','10095','26382',
                          '63836','46328','52315','50545','31461',
                          '33669','86060','97135','35393')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


