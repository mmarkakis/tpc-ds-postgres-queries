
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '36586','33567','70250','29943','87882','38118',
                          '33903','15784','87757','66178','34015',
                          '56639','20391','65759','58835','85653',
                          '47287','97590','26105','93874','96521',
                          '80881','41733','70289','84098','20052',
                          '34611','14594','67865','30195','42922',
                          '69918','34134','44396','59696','60135',
                          '50603','57856','71978','94330','81946',
                          '84920','42339','43341','45829','36714',
                          '17745','12965','84355','16178','10014',
                          '30690','92851','13819','67088','64317',
                          '86209','25724','40736','38141','31547',
                          '93186','99043','45621','27871','71906',
                          '11646','17726','46557','91577','67332',
                          '46534','98056','81867','40607','98154',
                          '77023','82129','96622','48166','17611',
                          '71343','19774','37426','54208','86828',
                          '30846','84659','32123','29573','76397',
                          '36304','71503','13307','18984','88522',
                          '21147','83840','82692','40189','22303',
                          '89303','17187','27193','78263','57459',
                          '87270','29831','87772','77462','76232',
                          '42049','60742','98952','60254','61334',
                          '40834','68039','87815','27837','79894',
                          '41385','43473','63131','34641','32731',
                          '55553','93585','35898','31114','49938',
                          '31468','74474','16935','68605','24296',
                          '75577','74821','47400','76258','66368',
                          '27165','15181','55262','38658','19519',
                          '85906','99905','49305','89521','54722',
                          '50538','24658','18635','80724','84748',
                          '41851','48952','39655','15678','69792',
                          '53929','33592','76845','20650','97502',
                          '92601','92386','33487','77629','79038',
                          '47195','28427','27270','83409','80627',
                          '40251','48161','61790','73853','17712',
                          '12937','98773','38137','82795','77695',
                          '91850','72735','65060','47103','33954',
                          '69585','58137','80282','14255','25121',
                          '16505','11848','37225','45323','11692',
                          '70287','62187','75823','76882','73149',
                          '71362','44596','23123','60805','71887',
                          '19453','86191','13555','26337','74116',
                          '31170','47037','99257','65298','73154',
                          '22257','96391','13440','71750','52299',
                          '20734','72673','42292','35075','93376',
                          '83279','46893','38847','52246','73009',
                          '10114','91836','69200','61899','46716',
                          '95925','35967','82148','14075','51696',
                          '76734','38621','36671','66319','88524',
                          '84059','80138','94958','33810','94306',
                          '22878','94086','94261','30543','22828',
                          '98503','38655','61167','67762','63253',
                          '46568','37997','28397','48334','65617',
                          '60641','18306','31663','82080','88431',
                          '81019','37829','38288','80057','56819',
                          '92286','46373','47394','56961','50381',
                          '69144','59396','70354','96701','88766',
                          '79741','34486','52324','44412','37889',
                          '12774','57427','62214','26795','19928',
                          '32537','61685','64762','40111','85633',
                          '15354','83866','15425','64207','74826',
                          '65811','74487','66310','25647','92226',
                          '79646','21969','18460','98384','63944',
                          '93538','89514','11956','65432','11910',
                          '17866','10559','38786','41354','30062',
                          '70247','46491','40855','44464','59311',
                          '10525','73783','22605','27671','72295',
                          '13700','21031','31324','19627','96399',
                          '59076','80181','34011','61372','67040',
                          '99584','42363','49952','57685','65866',
                          '59286','23507','30473','78409','46822',
                          '42490','23821','67773','60906','27302',
                          '78616','99693','91318','81119','33024',
                          '39808','21559','11897','86597','82870',
                          '72335','76758','52499','43660','34127',
                          '23379','78918','33505','89301','55350',
                          '37536','53283','32295','81077','34072',
                          '40560','56333','57310','23041','59523',
                          '87360','77860','51979','61422')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


