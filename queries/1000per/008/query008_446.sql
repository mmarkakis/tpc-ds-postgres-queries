
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '94836','93144','89767','64511','40413','49153',
                          '26397','85311','57007','81973','73499',
                          '73355','16449','74368','86578','77623',
                          '74066','42364','34718','96072','40088',
                          '32551','74962','83281','30134','36094',
                          '56587','27430','76887','68906','68621',
                          '44118','99504','78729','64757','74608',
                          '74819','46739','82594','23134','14190',
                          '98037','55726','82436','48809','26867',
                          '58331','59022','85280','41363','10186',
                          '93676','83403','47874','76156','49097',
                          '90479','47322','48304','79130','10195',
                          '58831','80705','36321','77333','37660',
                          '15506','27195','12698','73727','63865',
                          '96447','31863','84929','67505','33783',
                          '48472','26078','24582','94596','31525',
                          '41530','97815','92251','52465','17719',
                          '52182','10699','45878','39091','55478',
                          '23092','19283','78347','11387','21193',
                          '46166','64440','35501','74512','53558',
                          '20548','96133','13560','11625','19037',
                          '23507','53764','99391','26720','61533',
                          '31789','80774','82782','74099','31238',
                          '89454','69947','19249','52375','15554',
                          '44195','18316','88992','59945','44089',
                          '65129','85813','22124','36200','73168',
                          '66551','22120','32810','96017','53306',
                          '15827','33402','14428','79385','41904',
                          '17153','77520','90589','20655','79836',
                          '81938','28545','73099','43577','22036',
                          '86570','90774','24820','18052','60120',
                          '39389','95287','97039','78962','64578',
                          '34975','39749','30510','19866','83632',
                          '42118','42790','40402','32091','93341',
                          '15068','80279','90603','71885','93766',
                          '44506','46246','98911','58334','64135',
                          '91774','72854','72125','42184','55250',
                          '75315','80471','87887','27834','78386',
                          '96156','45537','78563','34100','49029',
                          '11742','26513','56686','90990','45717',
                          '15682','59931','25954','29656','88545',
                          '59319','55296','52532','35461','72601',
                          '81400','82865','82502','30117','71350',
                          '40908','52464','27343','22442','66160',
                          '55153','20802','56564','45643','48351',
                          '12628','99981','15920','45098','27851',
                          '65031','39599','37894','26170','72786',
                          '22864','66235','33540','12221','39593',
                          '48922','23760','83272','80709','43387',
                          '57820','36834','18131','74948','40362',
                          '98454','53138','68108','97103','15396',
                          '83364','37755','98748','67847','13161',
                          '90017','56142','33495','76515','68040',
                          '13737','77557','72364','88815','18233',
                          '25115','82774','30180','51101','96614',
                          '93678','17312','20692','69278','23404',
                          '53157','70477','84283','15209','72452',
                          '27230','51913','68726','41977','70306',
                          '20499','56313','57566','13090','97067',
                          '27748','14265','53829','37575','60491',
                          '67294','79858','72421','59704','34098',
                          '92276','28526','88242','16003','55248',
                          '95459','18965','38338','93847','89075',
                          '45056','93478','97423','50685','37885',
                          '20812','64477','67940','28425','86631',
                          '50746','26511','51933','13682','85026',
                          '10601','49607','65264','41768','81523',
                          '19251','27979','49031','45803','51905',
                          '67865','75990','62857','19833','88937',
                          '45214','29977','17246','16840','65932',
                          '31228','15064','17305','63851','49964',
                          '40548','67445','93080','59507','18750',
                          '18822','88377','79266','98962','85697',
                          '81764','26880','45887','95699','41380',
                          '29168','33795','85830','11363','47084',
                          '40795','46868','88373','23934','12622',
                          '97625','87762','13233','47129','38026',
                          '72759','93685','54965','12358','98289',
                          '41948','42358','14755','59280','37682',
                          '86322','32692','73786','43840')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


