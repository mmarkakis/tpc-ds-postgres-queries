
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '29903','33265','80218','61722','77805','89696',
                          '77278','64478','61193','31836','41033',
                          '31349','63715','71268','99728','53260',
                          '13862','82156','36282','99942','98733',
                          '93524','44318','91512','88627','67846',
                          '58324','42843','41634','61922','30451',
                          '12093','10726','46400','51927','65964',
                          '49391','26037','41967','12955','26301',
                          '99204','48066','95404','49969','84041',
                          '52252','38451','67757','66957','39225',
                          '62115','54098','73329','94308','95714',
                          '57376','42743','50546','24963','33953',
                          '89071','48707','77799','96421','93078',
                          '17348','68719','14996','15430','42261',
                          '39770','93598','30297','82570','29231',
                          '52281','43602','98304','36559','84431',
                          '86587','59317','62382','17474','73130',
                          '31458','54060','26311','15198','55651',
                          '25606','85167','30800','47755','28339',
                          '35399','23425','25176','43743','46258',
                          '37684','11461','71579','33007','85835',
                          '52922','18093','55310','87440','62924',
                          '20799','19983','43607','28537','66422',
                          '23477','57038','27796','23169','73074',
                          '73367','50373','74890','52872','45815',
                          '39300','71833','38305','53623','11083',
                          '88323','43787','80878','11135','31631',
                          '82545','34698','54257','18824','49422',
                          '60035','31509','20452','63922','97747',
                          '90442','18640','57197','17689','61082',
                          '84471','47107','45114','58988','25375',
                          '32759','10904','51894','97586','58769',
                          '31248','11260','80149','23672','57689',
                          '10286','47141','51218','74776','80212',
                          '16311','87266','40059','36736','60790',
                          '56015','94396','83210','48955','82909',
                          '10629','88785','10310','98647','28216',
                          '39648','41585','90787','51212','87054',
                          '80455','34554','38780','89078','97491',
                          '11263','66272','24253','90183','12797',
                          '85462','92492','14446','70976','46817',
                          '40603','44016','92657','97530','52978',
                          '40512','45263','83571','53985','36072',
                          '83015','83234','79026','74403','67091',
                          '39935','30484','65979','54334','40818',
                          '98859','11873','44509','67732','92366',
                          '95679','98452','80273','26120','87941',
                          '48248','83298','62351','18800','96813',
                          '95556','69963','49385','16135','29244',
                          '61306','48232','40513','64404','57273',
                          '49445','75694','45695','84062','94627',
                          '70132','46103','50014','15312','44012',
                          '90898','96808','16207','73945','80280',
                          '88954','57571','80051','71639','70964',
                          '77693','30887','75460','43055','21304',
                          '68449','72225','55458','12394','60915',
                          '61661','63467','18194','85731','83958',
                          '92409','48206','27336','29228','25312',
                          '77103','41127','26542','28740','14570',
                          '60420','81035','73182','61754','24950',
                          '35922','59828','27131','42145','96932',
                          '65192','88797','97256','94868','57637',
                          '68330','50700','40261','10757','88379',
                          '29945','11451','20296','84696','37625',
                          '88343','85675','60786','66558','12331',
                          '82036','88832','31721','21902','67496',
                          '97116','51675','43643','81137','52353',
                          '94069','58749','82075','92543','19344',
                          '53392','83531','63252','63327','48971',
                          '21227','74160','40730','12593','17412',
                          '29328','48856','91090','19989','72940',
                          '55664','29066','93115','35764','46565',
                          '44448','79074','97555','91308','28228',
                          '81809','47730','20014','23709','61192',
                          '66484','91173','77739','53018','19563',
                          '36784','34106','93360','66344','96899',
                          '17835','83294','30059','61137','32425',
                          '11877','81793','20575','89053','14342',
                          '52439','32954','17468','90749','18490',
                          '84597','37032','97464','79171')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


