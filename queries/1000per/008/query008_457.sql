
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '21027','19680','32739','48196','25341','66489',
                          '49543','63336','90782','90584','16837',
                          '94510','84943','79273','59287','70123',
                          '92903','86408','95902','77109','97100',
                          '44935','51987','67718','14555','19425',
                          '39516','29440','94151','85127','38754',
                          '94965','23697','84778','35802','56011',
                          '39575','47598','54509','16316','55147',
                          '37236','86321','72601','60539','45398',
                          '79355','54640','37370','11128','57106',
                          '12321','92617','37827','94113','45478',
                          '82834','66636','46893','35349','46138',
                          '25827','54675','80755','21813','44175',
                          '58356','10709','83648','63662','67661',
                          '66868','79743','29941','78846','16576',
                          '27026','61056','99406','33622','57082',
                          '39074','38088','97513','56489','34058',
                          '65367','94850','57102','47308','59972',
                          '86204','66928','52243','77329','24643',
                          '48391','66306','52450','44452','69057',
                          '35826','78385','75260','32233','57072',
                          '98160','27752','53474','88915','59381',
                          '87230','28026','66467','90210','49345',
                          '23044','84894','96330','26222','28880',
                          '69235','11274','92074','36591','49229',
                          '82252','49298','92045','41509','31210',
                          '63386','19556','16771','38424','36452',
                          '16620','51120','50511','46584','27499',
                          '74489','42822','66876','84517','58099',
                          '34692','12743','99865','48226','14053',
                          '20406','45518','88030','86320','90664',
                          '77794','79767','38728','89270','58269',
                          '73219','90569','35283','69609','76763',
                          '86265','78223','54876','73243','37639',
                          '55759','61689','73087','36966','88171',
                          '42367','31559','71198','87986','74197',
                          '32930','69106','78665','84338','31502',
                          '34170','96716','94463','27737','45379',
                          '56699','25058','46955','73526','39902',
                          '21146','10948','46707','19689','39759',
                          '66871','83670','60121','25084','52685',
                          '31455','66200','37474','17408','93270',
                          '77348','39334','90732','58263','11998',
                          '72576','81670','91636','29728','55592',
                          '41925','46212','95057','62522','58663',
                          '47666','90127','81528','44495','11119',
                          '50070','49367','31475','80378','39596',
                          '51707','48399','67241','16388','28000',
                          '76698','36962','47208','44567','65479',
                          '29147','46326','33726','21109','47258',
                          '67836','38524','15753','15577','96965',
                          '73851','65539','60994','86464','30597',
                          '50740','32243','95956','84187','95025',
                          '68507','15514','11183','18973','21576',
                          '97211','93414','33664','22947','34875',
                          '69320','83053','81046','67477','76678',
                          '36028','61220','46112','37409','81703',
                          '41908','20037','97439','99704','12418',
                          '16847','12536','71401','99345','64531',
                          '19007','63123','18041','16452','52246',
                          '85197','16588','41879','95060','90186',
                          '58170','78184','16126','55311','78097',
                          '50021','21140','52118','10052','30219',
                          '34249','88623','11102','90353','55265',
                          '33758','45491','13470','86573','75153',
                          '56944','35390','27035','20192','79092',
                          '93156','28568','63946','55779','72164',
                          '61620','48008','56936','63747','18736',
                          '41828','41808','26921','41334','36793',
                          '75422','38090','78387','84101','57786',
                          '70075','87094','67133','72862','66215',
                          '53410','95820','85402','15609','89634',
                          '33514','22939','30125','45936','58942',
                          '45641','91081','19417','26659','67259',
                          '33243','15160','51745','59849','19765',
                          '55702','92730','10055','35361','68856',
                          '46865','83635','28482','60271','85689',
                          '49030','85772','29323','93811','72467',
                          '45712','16688','33890','94361','38817',
                          '36492','80634','27075','90530')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


