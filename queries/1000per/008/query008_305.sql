
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '81862','41715','46404','44722','47923','86730',
                          '19157','44878','51987','35706','15060',
                          '22766','21430','64727','28183','92204',
                          '42595','35475','59113','48850','31083',
                          '15378','37006','70182','50956','13514',
                          '88493','41805','64860','60858','62998',
                          '84811','79164','83835','43220','25444',
                          '33409','94622','36097','81871','62326',
                          '60596','34863','81857','51999','37466',
                          '77211','10243','85963','44488','74678',
                          '71516','43034','12553','39329','65869',
                          '36358','91129','66971','19378','44973',
                          '46150','63315','21951','98666','64081',
                          '89821','84258','40917','25524','59852',
                          '34450','65935','99818','33090','11723',
                          '24003','51442','46765','92467','96575',
                          '17487','57988','15115','62197','66735',
                          '31305','45859','63466','83424','56361',
                          '26586','46169','66843','76495','31567',
                          '95404','25812','92794','82223','91012',
                          '72460','79389','79541','29269','59552',
                          '99293','95761','52210','73970','10247',
                          '38128','82045','20180','81940','77095',
                          '30986','45758','72061','28037','43018',
                          '16989','78356','46916','37902','92334',
                          '68076','47533','65360','82329','87841',
                          '49610','43503','40546','92429','49368',
                          '24678','75774','90193','91179','84461',
                          '53082','21034','33639','13221','85739',
                          '59918','61605','73436','25722','10965',
                          '23015','34196','16842','86461','52155',
                          '29878','86546','84216','81259','75482',
                          '92362','10933','30141','16589','16841',
                          '58793','81722','88545','78174','35073',
                          '94729','94318','58836','93314','48890',
                          '98037','70617','40160','95670','20809',
                          '17030','76604','99941','51540','37385',
                          '52510','43044','64614','53972','61914',
                          '60337','38570','82597','76707','34870',
                          '60485','33967','19505','93393','87877',
                          '71519','41831','43426','24523','14523',
                          '93380','40059','87287','22583','39096',
                          '51776','50137','27808','60161','69159',
                          '24531','58804','69333','40821','34109',
                          '13513','80948','75310','97036','58681',
                          '31421','19014','87883','77037','41209',
                          '69980','83419','10904','93653','81024',
                          '28059','98318','46059','43918','15383',
                          '54822','53453','24645','76275','45918',
                          '97422','48617','82567','46815','18843',
                          '58861','22391','17690','24002','34881',
                          '36989','65586','31441','54183','19860',
                          '40750','70749','80419','69653','61210',
                          '30919','84037','55869','84045','88818',
                          '49614','30778','92627','83517','69553',
                          '47259','35467','75524','92660','75927',
                          '71115','23435','72186','36676','59997',
                          '14251','10711','69361','50375','18629',
                          '57932','99366','59324','55538','87345',
                          '80472','47969','46155','91491','91170',
                          '25842','43786','72093','61496','24472',
                          '85769','50469','46431','81431','29311',
                          '87605','43127','85478','26027','21444',
                          '70360','26187','72940','15511','40614',
                          '35009','25913','22235','28651','50778',
                          '91398','58305','13920','84466','78151',
                          '34625','87915','26379','45935','86328',
                          '94908','68015','53341','98573','66352',
                          '61805','13932','21845','54648','39601',
                          '98706','85378','10488','82536','71372',
                          '36338','86330','10941','45392','66680',
                          '98358','18316','87173','67503','35709',
                          '66474','91363','89088','33797','20277',
                          '54751','68199','53444','96877','64387',
                          '98059','77437','88600','17214','80184',
                          '36717','29453','46959','90066','53604',
                          '82955','72925','82880','25103','71638',
                          '28832','31252','88998','90674','98916',
                          '85449','43876','13208','68935','84774',
                          '27313','40940','16561','88541')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


