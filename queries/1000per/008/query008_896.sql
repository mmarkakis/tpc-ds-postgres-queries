
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '94897','48198','61104','99176','39416','52825',
                          '15663','80084','24876','56857','86286',
                          '71968','94630','50268','34072','32240',
                          '66557','23116','86718','38092','50167',
                          '88137','66466','87039','30383','74700',
                          '15489','96663','47103','46440','99602',
                          '72356','81334','31010','21306','42348',
                          '46541','47371','91485','31827','75216',
                          '28554','95460','36263','15803','14061',
                          '37741','92345','38396','60551','17899',
                          '89847','90201','83190','99388','23025',
                          '16449','58286','23754','69653','56465',
                          '47515','16696','24054','51469','93528',
                          '20493','70101','75133','62794','88538',
                          '46289','41444','16814','88224','63477',
                          '98801','46591','55116','47099','36984',
                          '46046','42441','37359','76181','44994',
                          '76600','12055','62164','91552','34568',
                          '65681','86313','29318','65323','95284',
                          '31722','70883','83905','13143','24744',
                          '78404','55998','23996','97130','29074',
                          '16065','21220','50139','80253','60025',
                          '74176','52375','79189','55178','17068',
                          '49867','56518','25046','10847','46039',
                          '83391','10623','16495','61760','19692',
                          '19893','45561','36448','51475','47055',
                          '31166','38032','80911','80230','91376',
                          '12250','92517','71759','71215','25883',
                          '40012','61790','62041','96539','37998',
                          '83293','53285','34973','95585','27888',
                          '34189','16271','22136','42467','43590',
                          '18902','21820','81778','80741','46525',
                          '93171','76568','31501','27829','77623',
                          '81241','38440','56369','61997','50276',
                          '64824','25330','20847','84523','38694',
                          '97208','40130','11679','52685','53817',
                          '14690','41428','95345','25392','18568',
                          '19587','54171','71485','10686','75292',
                          '98530','61944','75297','43535','11970',
                          '27502','88381','31224','20555','69890',
                          '90002','71566','38292','98039','20936',
                          '47249','20172','82869','67098','87264',
                          '97773','68199','99477','48273','56905',
                          '99364','98884','74952','87447','93373',
                          '27598','52880','80440','35536','24277',
                          '73409','16951','24658','80645','69598',
                          '55295','16337','57553','69894','32421',
                          '66838','46409','69896','77985','44493',
                          '95144','58790','65076','66812','78865',
                          '61219','56536','72686','82960','95184',
                          '70491','84230','80251','12603','57244',
                          '68878','49580','84194','23398','16716',
                          '89358','23560','25607','89735','38670',
                          '69521','97274','78836','58274','12965',
                          '53343','47462','20623','77014','60351',
                          '43364','89265','62190','61076','55270',
                          '98528','73088','74903','41056','14545',
                          '15043','85975','90501','12641','14026',
                          '52809','62019','36049','53210','51212',
                          '60600','80744','94186','87814','87387',
                          '88948','14848','20510','40377','49898',
                          '18541','56944','72658','21007','30275',
                          '74375','19745','25537','89301','85279',
                          '70717','14839','69208','44953','81725',
                          '21689','34107','37775','80768','64526',
                          '90741','68616','24152','66586','86659',
                          '28483','12337','79198','45867','67386',
                          '81036','25335','27024','28116','51252',
                          '42778','73318','23366','81867','99047',
                          '74629','51895','49928','14173','66198',
                          '78126','92400','60883','32834','21372',
                          '62069','14734','72272','20177','46799',
                          '32364','44797','78173','47221','50204',
                          '36773','29466','84761','11079','18768',
                          '70608','54337','82990','55530','53242',
                          '35841','76829','81013','94423','59442',
                          '53809','51649','71099','70685','48458',
                          '91185','74891','10081','89661','49059',
                          '91560','10134','67981','70436','39610',
                          '36791','26031','18773','56491')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


