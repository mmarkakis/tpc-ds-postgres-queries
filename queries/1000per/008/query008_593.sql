
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '95640','29846','93382','31078','39667','29857',
                          '71077','22634','21041','72320','94668',
                          '25065','35592','71556','36488','75285',
                          '49015','13714','47174','82243','68884',
                          '47807','34413','55041','42231','19908',
                          '15733','37570','54367','84912','54797',
                          '19481','50058','75616','61964','14715',
                          '32774','96378','16849','22346','89088',
                          '13213','73800','72064','99327','52204',
                          '60081','17197','43817','85436','12151',
                          '31343','20689','91667','17000','32134',
                          '61286','94828','78631','93058','49332',
                          '77677','68394','36763','74575','66336',
                          '42598','80508','73634','26713','44532',
                          '51966','18158','60602','81161','80782',
                          '89547','49448','67206','27256','59809',
                          '57271','71936','22077','93007','72572',
                          '58582','49346','95190','29994','91243',
                          '72083','37503','86642','21851','36108',
                          '60870','92921','15462','14559','18677',
                          '51553','29922','27885','16293','30372',
                          '17186','71916','14558','72790','27311',
                          '84851','65802','55806','61669','21022',
                          '30065','63777','30927','77560','24864',
                          '71024','31137','43152','14680','57488',
                          '60449','82956','45203','87736','63586',
                          '44298','26238','86095','25747','41393',
                          '32863','75296','42537','37218','15330',
                          '98491','30143','83203','60756','43491',
                          '11936','62279','81124','41817','37734',
                          '55483','89588','67494','38338','55764',
                          '33118','82479','58528','23787','14126',
                          '11370','80561','45691','22677','14965',
                          '25364','93443','76676','14417','39835',
                          '41784','28126','81872','98651','56363',
                          '65514','66869','19540','37610','16460',
                          '67646','77384','85142','35028','43027',
                          '88374','94427','68082','20341','26671',
                          '18327','67638','12354','74149','75992',
                          '14319','79231','67336','65104','46855',
                          '95485','74347','54155','20905','69918',
                          '52783','96657','35547','21697','37318',
                          '18631','95882','21143','16683','18338',
                          '17631','78678','43188','87951','40596',
                          '65089','80768','66741','55382','33120',
                          '97698','79760','18026','48964','81357',
                          '53669','23940','75708','23890','40289',
                          '81999','95514','67384','63606','42531',
                          '76573','87583','33832','54116','64242',
                          '17309','30449','87844','76338','79206',
                          '46962','73313','11440','94374','91790',
                          '84813','26316','18844','33086','73877',
                          '49224','74473','78904','99629','71016',
                          '50890','56273','84542','19616','48787',
                          '73831','80595','51708','89072','12771',
                          '81910','98336','11988','30741','81893',
                          '53336','40792','94776','87743','32528',
                          '69712','70622','95987','93757','78370',
                          '10410','70665','41583','81184','47787',
                          '34743','37465','80835','35271','20554',
                          '36410','62742','38898','97605','35041',
                          '86017','38852','40572','43984','27248',
                          '69262','28499','31609','72577','68536',
                          '60838','97978','40451','71584','41854',
                          '54224','45909','44972','79109','27219',
                          '20895','23950','62107','91304','95183',
                          '47140','37892','65164','86154','11788',
                          '77267','13506','19104','67184','69177',
                          '64046','95734','30719','51604','35623',
                          '52387','87225','17317','24772','25080',
                          '73914','18533','65224','47311','88285',
                          '43004','36988','49585','76847','12097',
                          '49768','80898','19190','23616','23578',
                          '27407','27653','23799','87217','39685',
                          '78828','38675','78420','36734','63399',
                          '49662','63386','99132','95438','90481',
                          '48618','91895','37019','13266','80102',
                          '81040','18420','67024','15098','85203',
                          '65042','28793','97689','35965','90447',
                          '37616','96771','45603','50679')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


