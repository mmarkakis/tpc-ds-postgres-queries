
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '56168','90251','65748','25080','75390','55453',
                          '88019','67129','45862','40876','89548',
                          '11334','26168','10800','64415','81630',
                          '47162','16146','21745','49216','70721',
                          '84557','35951','36885','54119','63113',
                          '83671','91523','59350','55023','25358',
                          '70289','90500','54175','11270','78082',
                          '22079','44278','20684','57002','33127',
                          '93880','10600','31605','10268','28946',
                          '78147','67582','29510','48827','31801',
                          '75791','36056','29251','26474','28369',
                          '24161','59292','81086','55426','89996',
                          '62515','51339','39921','69164','72050',
                          '74795','80111','80235','88324','72196',
                          '96437','27211','17240','66970','19265',
                          '93364','71436','57937','94259','68683',
                          '90871','11412','64342','32736','43582',
                          '13005','78061','31821','86523','74268',
                          '59669','22024','29784','32134','67325',
                          '93171','21914','67823','42022','15588',
                          '69267','10037','57127','67588','87920',
                          '92700','22597','27726','11411','72580',
                          '93869','87455','72865','68991','26255',
                          '57184','52903','98501','17007','28221',
                          '54683','93802','95366','12012','74862',
                          '63136','87772','36300','72735','14656',
                          '75760','13245','77889','36686','68109',
                          '70881','90596','54770','90389','28058',
                          '88559','74379','86228','43123','43973',
                          '24154','47226','73400','18456','46364',
                          '61846','59679','91029','32469','98201',
                          '40723','80757','73025','95362','40794',
                          '98403','88998','84973','20019','83596',
                          '16671','94630','33757','39863','95167',
                          '63866','58580','33181','12776','96506',
                          '71513','28881','67722','74946','22708',
                          '27070','56000','10855','90987','75990',
                          '45966','59052','66337','45021','83478',
                          '98778','61257','66623','25831','33586',
                          '23408','42924','95395','90387','54486',
                          '60388','38434','91393','46095','99477',
                          '79386','44353','65421','32924','42145',
                          '16988','39451','67319','64028','16681',
                          '25046','95648','66870','51020','39951',
                          '47765','36157','88691','65517','30049',
                          '28552','74177','58714','25819','14574',
                          '39948','34759','63249','25581','38933',
                          '27704','63210','91987','28270','82850',
                          '30968','35663','27175','44154','89517',
                          '51132','56099','67974','88568','87290',
                          '10010','81592','59304','98608','15788',
                          '26239','27957','20206','96306','73058',
                          '66450','42265','33619','82274','16849',
                          '75083','63702','25734','95738','78927',
                          '10462','40919','51544','18918','37055',
                          '76389','65145','50900','59020','81150',
                          '72245','91933','32891','13891','93746',
                          '97259','61625','49942','98509','96340',
                          '32223','87357','91022','67212','23415',
                          '25772','57547','15989','88513','88573',
                          '10893','19590','68146','59498','60795',
                          '37019','68149','39116','93118','54732',
                          '65878','31310','18930','84389','81170',
                          '77118','45097','43329','35304','78302',
                          '62623','61590','43070','60912','63900',
                          '73828','24567','45246','96335','90377',
                          '63344','77529','14637','36965','43588',
                          '88276','18197','38916','80604','72672',
                          '79365','11962','11960','14209','69269',
                          '41434','99356','44114','58063','93787',
                          '58661','70850','69373','99500','28781',
                          '81719','82394','75211','48573','95519',
                          '96365','46089','61701','34526','33025',
                          '99243','88214','86370','62524','12376',
                          '32043','74543','14785','47350','27162',
                          '86963','13670','43277','80347','78173',
                          '71632','48624','57790','22530','64626',
                          '89861','99142','15496','13438','29019',
                          '55396','16865','20584','38265','65003',
                          '52545','73390','90059','15459')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


