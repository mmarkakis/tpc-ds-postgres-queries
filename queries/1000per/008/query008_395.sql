
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '62695','73751','55388','25104','64220','57314',
                          '76997','40263','37247','71094','42227',
                          '84557','40109','62921','31097','32290',
                          '90646','70415','53132','91433','60748',
                          '33709','86686','57531','68872','66423',
                          '92046','15544','39286','72565','73392',
                          '35287','56592','97217','31067','97532',
                          '94158','94395','48862','93679','78914',
                          '36120','27393','80730','43451','76762',
                          '38984','71811','71952','83885','41220',
                          '79167','53129','81081','90854','84452',
                          '81145','10712','12100','62633','82144',
                          '20498','16353','87722','18429','87239',
                          '11456','64191','55920','20312','63282',
                          '10909','61062','81603','53417','64470',
                          '81974','22877','57718','97214','14025',
                          '10197','89787','56807','17186','18096',
                          '89540','66039','39605','95189','86870',
                          '70770','34604','79597','49870','90445',
                          '63548','62845','12990','30156','52418',
                          '97128','35032','70169','24491','67275',
                          '53229','81680','41034','94094','21626',
                          '38076','39509','76172','45899','79288',
                          '12380','90471','28034','68908','40209',
                          '89959','25306','87615','65375','23824',
                          '54998','73931','14641','49285','35697',
                          '81851','69413','28299','61939','60112',
                          '75692','31522','44538','71532','78865',
                          '59498','19841','86208','22666','53489',
                          '19125','22907','50589','64658','20284',
                          '86000','46418','43560','51814','83050',
                          '44552','71526','24688','91717','26910',
                          '46513','59411','92302','65250','43935',
                          '31211','87867','28270','61328','38099',
                          '61128','47057','92750','96774','68987',
                          '74653','93984','92018','65935','82243',
                          '29779','30890','65058','25961','41240',
                          '39517','90198','87047','28316','35149',
                          '38292','36586','89040','54025','26124',
                          '76487','39447','53040','19553','31936',
                          '94253','55548','77253','15947','29925',
                          '85343','99716','12776','52043','24884',
                          '82620','35364','40536','74254','42267',
                          '75897','28705','25356','16511','68784',
                          '57452','69423','13685','26396','71593',
                          '55228','73674','78260','23050','80938',
                          '53694','94697','99002','27204','26815',
                          '28504','80877','16686','51906','61389',
                          '44319','41428','88165','15404','46338',
                          '41434','87024','81068','31350','15473',
                          '91794','69774','68702','33005','77813',
                          '94991','92434','69840','13249','69066',
                          '13805','12112','36238','63824','64578',
                          '74111','41176','27847','12911','83606',
                          '32407','19516','14300','55804','89883',
                          '57824','24486','65797','65332','80064',
                          '30643','67749','93781','81628','34466',
                          '84889','64389','80338','14153','94616',
                          '50039','79699','35177','43662','37050',
                          '29900','32372','85110','56266','20840',
                          '69601','81751','17761','15567','11540',
                          '52369','77868','30749','16266','68005',
                          '61568','32355','12936','49193','31143',
                          '70164','85342','69283','57355','49003',
                          '88007','29618','31524','39720','91326',
                          '62654','69996','57112','47435','43897',
                          '41782','91991','61557','35208','35757',
                          '81343','95547','42807','52545','35614',
                          '70105','16495','32401','71086','17604',
                          '13246','10925','67443','49903','97310',
                          '63647','42278','43281','42365','75181',
                          '50294','30746','13122','66540','76085',
                          '64336','10717','33687','56061','39267',
                          '80640','56432','86396','78289','43591',
                          '18868','99936','62204','72097','63839',
                          '11178','37071','14760','86603','31790',
                          '99035','42622','87009','71985','61890',
                          '87504','26822','95721','84007','28475',
                          '73184','81905','60463','37115','42880',
                          '39123','59816','59885','76260')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


