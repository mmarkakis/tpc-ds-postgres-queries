
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '94113','55120','33912','55077','96689','60705',
                          '74589','11590','25712','10859','80232',
                          '62097','55651','29117','88083','58471',
                          '28990','31193','17722','49825','54716',
                          '73970','17895','39308','58010','85445',
                          '81367','54050','24248','90593','25966',
                          '90720','99546','56965','58240','89392',
                          '64579','83287','70258','45422','20461',
                          '32838','40185','14643','45513','23883',
                          '89455','79913','83416','28770','46639',
                          '87315','30997','94769','76984','20890',
                          '93362','15893','72644','94547','66577',
                          '95754','62189','26186','73415','75724',
                          '92400','70772','11221','30441','18479',
                          '80953','27231','59886','16995','91986',
                          '70568','59964','46698','87740','23377',
                          '58134','68279','39292','22866','90331',
                          '45533','19092','95862','90574','29026',
                          '92335','30209','87476','22857','89237',
                          '34319','28750','40245','15058','75360',
                          '91222','69841','86130','14660','27685',
                          '58847','61985','17647','16818','34282',
                          '13479','90067','74484','82332','79685',
                          '65564','15509','59330','67730','34221',
                          '39010','95965','69228','34372','82782',
                          '36882','16549','24463','40650','17450',
                          '74169','68732','62607','41662','91103',
                          '48257','33089','56234','83326','80955',
                          '56611','42888','61257','21965','46812',
                          '70570','50400','86535','26109','89965',
                          '27781','59649','16522','63235','95403',
                          '13882','89313','66260','44141','21006',
                          '39391','32399','63256','34152','70022',
                          '38603','59128','65592','69855','50727',
                          '79181','60010','54785','48801','21273',
                          '22477','63251','46144','56328','63600',
                          '43988','15127','92762','16573','91069',
                          '17107','95273','25776','44228','46033',
                          '87117','12556','81173','91619','15172',
                          '34393','27619','33660','95697','10214',
                          '20438','87824','59083','69564','18285',
                          '39091','86807','78048','31109','29533',
                          '32804','59333','72811','29225','66014',
                          '17099','96780','44150','61788','75449',
                          '52806','61194','26919','63702','76867',
                          '10722','14270','15605','21297','22271',
                          '73413','94076','61893','13239','58602',
                          '60656','64501','90845','76532','85122',
                          '30394','91259','76901','71168','20167',
                          '84779','75028','57512','88340','85785',
                          '74953','77038','88331','57515','44211',
                          '35355','86890','80053','64756','46163',
                          '81400','34017','56322','57010','85584',
                          '65865','98475','97682','77635','56157',
                          '78442','15944','57605','79767','23923',
                          '62757','57090','25846','73066','64263',
                          '30764','47057','86729','92245','58639',
                          '85004','20968','75887','19509','22951',
                          '48741','71749','14962','11682','19403',
                          '14113','58380','73253','69201','20697',
                          '26142','71038','67782','64912','78197',
                          '68581','46455','66679','30485','86512',
                          '65689','20629','46347','30022','69460',
                          '42194','53305','82313','78587','69209',
                          '68061','84687','52326','79203','77040',
                          '46132','72116','74020','38701','86572',
                          '26635','43711','78537','96526','87861',
                          '65108','22405','28188','73306','29784',
                          '99683','74543','10622','85592','36436',
                          '28856','46706','75906','18758','30468',
                          '88537','92083','85345','99705','35152',
                          '55809','29888','27591','66541','29087',
                          '38044','99685','89086','70055','10246',
                          '33753','34279','93813','48658','29351',
                          '36981','68845','48952','35860','16469',
                          '50963','39922','25255','68799','90747',
                          '52603','32190','25052','53389','17559',
                          '39744','46478','45206','91044','75646',
                          '17642','92034','56072','33512','80147',
                          '95225','93559','18652','51694')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


