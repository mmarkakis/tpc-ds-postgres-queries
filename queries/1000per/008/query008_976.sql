
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '27374','87584','98190','44836','37171','68445',
                          '33926','31168','39793','55272','65073',
                          '23043','23595','63479','98720','40272',
                          '83340','92871','30009','72500','21958',
                          '68400','30058','21795','82503','36583',
                          '85919','34949','95019','58025','52218',
                          '92403','46336','23428','65420','25362',
                          '42514','77882','24266','78541','56429',
                          '95096','74201','41360','38903','54224',
                          '51053','35459','21719','57731','56724',
                          '75761','52969','61340','86486','19980',
                          '83909','53390','71488','72639','58776',
                          '50121','20188','98971','18648','41859',
                          '96307','31034','22274','66904','64674',
                          '64001','72441','67947','76740','99698',
                          '71602','24088','61169','41585','68742',
                          '33665','78727','61509','53210','10069',
                          '82212','44106','69160','51894','77921',
                          '17233','10871','37474','38851','52953',
                          '44142','95608','13321','32532','58153',
                          '70865','99323','38696','71950','69059',
                          '68917','76338','23060','85026','62081',
                          '10099','70602','68899','30286','60780',
                          '10713','39419','68168','23877','63206',
                          '53095','90768','79185','78701','30082',
                          '56668','67709','62036','41665','12480',
                          '39735','23549','63304','58686','31072',
                          '87186','68276','18062','65393','47524',
                          '38424','73284','22199','54096','79220',
                          '43132','56062','51121','48277','35790',
                          '87290','62020','30930','47678','18770',
                          '29521','18293','56522','56898','54750',
                          '46195','40555','26829','48237','33949',
                          '48266','89941','55836','40332','13766',
                          '96571','38437','92077','41280','39946',
                          '66364','92720','14192','72549','63586',
                          '68516','58426','42360','37625','79520',
                          '63031','18025','70026','61560','65371',
                          '78250','24572','62535','23447','59333',
                          '27819','65139','53481','32855','60058',
                          '95772','18136','56400','46907','83877',
                          '38938','48445','10621','83294','60342',
                          '68363','67879','42946','11534','91893',
                          '34259','71559','96004','70752','14513',
                          '37067','21844','92457','99250','42762',
                          '65896','77586','76440','48152','18942',
                          '99069','55739','94887','65454','68477',
                          '94787','48174','60317','19434','63532',
                          '22799','87726','46379','68204','88332',
                          '86953','48246','29150','68379','74853',
                          '43504','82079','35267','31084','29361',
                          '27369','17451','21982','73019','90515',
                          '45035','36184','19918','90003','88403',
                          '38427','33272','80060','22568','53102',
                          '35890','60789','32712','39126','62115',
                          '88546','99642','85670','19507','41320',
                          '68106','87304','26064','95638','58548',
                          '43541','55095','24554','63824','74791',
                          '68456','33143','18896','93400','26345',
                          '47101','34566','41086','97321','50463',
                          '11914','30911','56174','21523','30516',
                          '59946','36486','73580','82008','68243',
                          '65244','97130','38486','71837','79653',
                          '16519','23859','69721','28660','15078',
                          '33182','37445','44108','66875','74081',
                          '14198','15269','14607','22679','24357',
                          '57045','98358','46852','15939','75072',
                          '84484','57594','37547','76554','83665',
                          '57382','38384','26180','27520','62215',
                          '21710','83006','64812','93172','34644',
                          '69550','40738','73130','34606','19926',
                          '27346','15647','56316','84547','30780',
                          '54344','60915','61385','46616','75316',
                          '88904','61836','17692','24555','52270',
                          '20379','91966','97507','88528','20039',
                          '33077','24824','20036','32820','87977',
                          '90037','62080','99478','33519','67519',
                          '46424','20859','99318','67255','76727',
                          '30089','82165','47605','25152','12201',
                          '89636','39210','74157','34119')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


