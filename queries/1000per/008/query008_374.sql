
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '32830','15194','79643','14350','89324','44694',
                          '24169','87098','13257','35614','50711',
                          '71041','85750','33569','45237','67689',
                          '58974','93357','38745','32952','63743',
                          '29618','74814','46461','74487','83332',
                          '56414','37936','39067','36461','22098',
                          '24170','94944','88734','52048','52801',
                          '92970','83110','99639','38617','62923',
                          '97146','86314','91756','41897','72933',
                          '34138','74702','45362','30865','77387',
                          '98952','41657','55186','83712','67826',
                          '21521','37968','28398','83494','62654',
                          '90109','22791','33445','88017','18633',
                          '94779','38382','26267','71782','25550',
                          '22121','87954','97808','56877','90874',
                          '38687','34391','86173','59955','91590',
                          '40780','39666','87358','37815','52088',
                          '95040','86609','61153','87963','10340',
                          '14907','30202','66969','65813','10584',
                          '54753','62194','28408','44991','43810',
                          '10451','92968','15170','22341','62477',
                          '29163','25984','75318','31307','11943',
                          '39391','70751','79725','59648','86117',
                          '98442','50537','37218','54066','73554',
                          '49907','94313','29421','68600','37976',
                          '55872','21042','35986','93805','94091',
                          '40026','72349','30611','69466','71586',
                          '45375','24801','24182','26238','34121',
                          '77513','28423','37864','27685','78810',
                          '23615','50668','95069','79354','48652',
                          '52459','78541','89432','32787','92811',
                          '78422','91725','25961','98792','79206',
                          '92371','68613','20478','38906','51180',
                          '54410','98373','52990','50621','40111',
                          '33500','10912','49618','20690','88180',
                          '96497','20035','50528','34382','97047',
                          '42426','12655','28141','34211','48107',
                          '64670','51514','92628','86095','82953',
                          '84129','82119','52665','19970','50880',
                          '26881','88275','65478','98935','70569',
                          '88608','43891','58930','59777','49495',
                          '89131','42944','55411','75887','88556',
                          '76974','67473','26653','62176','48036',
                          '10180','63011','39445','26753','70660',
                          '76571','70491','92530','35822','42603',
                          '89708','27799','82654','43309','57766',
                          '22854','13601','91241','38281','12591',
                          '15464','41299','32385','83975','28879',
                          '66257','74032','42335','95484','39853',
                          '31798','71257','76112','15560','42244',
                          '12071','81788','40286','88297','22547',
                          '89810','20472','56816','80576','20556',
                          '23438','35767','76438','54601','13099',
                          '23589','47663','66908','33049','12573',
                          '77730','71444','25886','65125','48857',
                          '15672','50236','68499','14085','12663',
                          '88835','82945','19899','89798','51349',
                          '44789','33608','57178','64885','21931',
                          '70285','95508','91497','14080','25288',
                          '15479','48842','66587','51913','89149',
                          '62737','68759','95636','70638','78555',
                          '72055','97848','69633','12092','33853',
                          '21405','87256','96313','13476','25596',
                          '41099','70865','69199','83646','63803',
                          '61587','87065','85999','50554','11392',
                          '84317','34060','56963','80978','82596',
                          '40865','74980','37029','29402','26096',
                          '54882','95575','82777','68665','62083',
                          '90373','40417','46071','21060','27707',
                          '19599','42637','27396','21284','70218',
                          '39822','52180','64348','14121','59020',
                          '33486','79841','56529','92125','61210',
                          '76782','70413','88812','85269','58718',
                          '84702','56195','83182','77415','79025',
                          '51211','31059','38054','94188','46552',
                          '53984','17562','13813','77551','91350',
                          '52054','10230','90977','61138','71115',
                          '48224','80574','63084','25043','75585',
                          '60143','78135','48624','64548','73854',
                          '16560','88047','15689','64021')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


