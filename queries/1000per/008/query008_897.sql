
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '63474','17663','80930','94019','52468','93349',
                          '53003','91258','37170','16549','65307',
                          '75068','96948','78807','24856','81243',
                          '72174','20682','17732','69061','56016',
                          '52019','23157','65977','72984','59225',
                          '98099','82293','49480','84163','21164',
                          '82491','12252','76779','81114','78893',
                          '81905','25441','80549','12549','37178',
                          '82381','57802','25672','66882','93577',
                          '81385','70879','11448','43411','53086',
                          '25330','24802','99931','65342','82192',
                          '40666','38132','81529','19497','26621',
                          '35159','37571','29834','64008','13386',
                          '13012','61987','17152','25128','62488',
                          '95513','54156','24417','36981','56815',
                          '30216','39368','41860','16121','20346',
                          '70269','69527','49522','64418','17150',
                          '94661','46988','52201','85135','46508',
                          '12090','15027','79316','95491','11694',
                          '70210','88721','31413','22780','25347',
                          '81566','87476','24527','20377','19018',
                          '45445','83277','21177','68147','61644',
                          '84396','99513','26098','32772','35753',
                          '60511','30030','85684','15319','66125',
                          '95584','35485','50624','47402','31373',
                          '65423','28293','33076','65985','25449',
                          '75871','87138','49071','90584','18314',
                          '53817','30932','15371','21070','41131',
                          '12010','71764','76688','74989','44678',
                          '70140','49339','96621','56963','77725',
                          '50736','70346','27916','35079','31013',
                          '93928','77613','60501','71200','58660',
                          '23494','81245','57247','64402','48520',
                          '30649','20054','22114','22193','46145',
                          '68418','85208','93862','92258','64217',
                          '22673','22916','89880','78910','99692',
                          '81267','37753','70732','54885','23112',
                          '46852','99913','58397','33452','27202',
                          '11564','15350','28111','10300','31072',
                          '14618','41149','81401','51159','14596',
                          '56529','36925','41102','69220','68702',
                          '22831','15093','99729','65268','11702',
                          '40154','90055','65778','27402','91692',
                          '34674','41403','18530','39550','63617',
                          '76135','96550','27673','62131','24115',
                          '91928','47727','86509','48634','91591',
                          '19320','97699','55699','41462','19643',
                          '19385','35434','64294','99357','48264',
                          '24257','93334','21484','45504','11367',
                          '37329','61379','52949','33070','88540',
                          '14919','60600','57476','94481','74585',
                          '87050','23558','31396','85419','19038',
                          '87287','80159','84169','50503','69680',
                          '11122','84436','25071','48017','91755',
                          '71087','63163','53463','96887','59188',
                          '63344','78907','99388','88236','26073',
                          '93082','95930','83136','28819','31262',
                          '12340','32635','66420','46230','43441',
                          '88676','19461','86922','93584','81814',
                          '97589','84813','62925','16699','37394',
                          '80122','83740','40063','52369','56146',
                          '21536','20196','73620','26327','56751',
                          '31917','27240','18633','43832','86364',
                          '13552','50720','28983','39832','25387',
                          '16153','30844','41162','99775','50644',
                          '65562','34930','40209','24826','56917',
                          '14470','49405','94272','28100','54218',
                          '36950','41518','90505','25609','67278',
                          '10104','37290','58688','35893','86302',
                          '77992','39956','37059','32222','38430',
                          '34039','64451','83245','24730','89200',
                          '16629','69868','69099','33549','61779',
                          '62260','77866','58908','87917','91612',
                          '96426','71213','78566','83366','44419',
                          '46124','52696','70711','37428','76167',
                          '80509','90917','68552','35831','43797',
                          '86350','48840','90782','46668','65933',
                          '22422','23452','59663','69147','79776',
                          '55707','22456','36351','54537','32402',
                          '15587','36565','38600','54208')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


