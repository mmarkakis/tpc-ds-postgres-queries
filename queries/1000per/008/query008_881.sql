
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '25427','61673','69232','99682','87610','18402',
                          '48660','42918','59441','21666','17682',
                          '32606','43973','90734','42687','29352',
                          '30355','68325','39951','69234','43989',
                          '54760','77662','21050','36616','42370',
                          '12148','24992','31118','39560','19308',
                          '97429','62845','80856','52257','83325',
                          '75191','91893','45809','44358','49653',
                          '19745','97936','71655','87789','90529',
                          '94259','68604','94935','92990','63249',
                          '42902','15029','50214','58377','90736',
                          '84122','87320','47990','26383','36923',
                          '39647','59123','99277','63195','17666',
                          '25028','95317','35905','19826','35293',
                          '72867','56752','26978','66115','37253',
                          '95840','14808','44201','88761','80370',
                          '57511','89990','49542','10552','98305',
                          '42569','68200','62959','41650','12717',
                          '47195','63957','81505','80916','82803',
                          '76548','49631','42434','80219','66561',
                          '61994','56817','68617','27749','46885',
                          '43033','90445','34125','42962','82979',
                          '96731','93907','56634','89163','47880',
                          '38593','81269','93655','40408','54102',
                          '64240','98047','81628','43026','46235',
                          '45438','68923','89256','53537','86090',
                          '77104','86608','37765','64921','88624',
                          '83694','90981','56068','41765','77112',
                          '88938','14964','63863','48717','10475',
                          '15627','50378','46769','85074','53844',
                          '48249','84688','44074','68566','20623',
                          '24369','97151','27801','72310','63521',
                          '89242','10782','12173','96336','23451',
                          '55986','35625','69580','63894','13877',
                          '64489','89434','69543','62503','96812',
                          '34572','96317','40595','83467','91791',
                          '87120','80855','69928','51967','38329',
                          '59992','54273','69051','25718','71396',
                          '49305','83790','45143','18608','23592',
                          '68513','58860','17139','64020','44819',
                          '30967','48242','14914','88836','41497',
                          '23256','15740','82719','85624','48948',
                          '40984','18376','13344','62586','79484',
                          '19187','18700','68743','33647','19183',
                          '25852','39273','37150','88711','67569',
                          '96441','20851','92500','69898','84398',
                          '73496','36174','62402','92578','58016',
                          '12611','83375','77603','49174','99443',
                          '66121','42615','88683','86482','23165',
                          '32317','15432','20503','89072','41117',
                          '34707','90718','99700','90604','92664',
                          '12971','75428','52536','50847','91244',
                          '15257','41333','15267','76226','53158',
                          '82738','65045','46153','94993','13707',
                          '68274','19669','73473','46265','38347',
                          '75461','81450','74615','16189','87533',
                          '56074','31308','26864','44873','15512',
                          '98074','74937','11702','63488','29095',
                          '47910','34343','16359','98522','94756',
                          '60740','67794','81388','12477','26391',
                          '30396','76911','98659','67412','94300',
                          '24615','30385','50794','43481','48545',
                          '34664','93776','51954','75093','89533',
                          '64994','60934','66901','22840','59091',
                          '58063','61828','68855','63615','94059',
                          '93336','27990','93652','50636','86240',
                          '63694','92839','79214','83334','52996',
                          '16757','94044','69847','80703','74027',
                          '28407','19403','11537','25841','71960',
                          '96853','12812','20153','50653','38180',
                          '61317','83748','41742','56681','34530',
                          '72100','11499','55322','92992','89258',
                          '97882','42319','16187','47203','14325',
                          '14575','55431','36275','98810','49741',
                          '29115','60927','67680','88767','20873',
                          '32793','36585','84167','28958','45891',
                          '46448','21750','53989','64344','59594',
                          '59596','87316','23791','31094','36716',
                          '87025','67433','90740','99081','74245',
                          '88530','25650','66845','68390')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


