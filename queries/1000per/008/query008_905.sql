
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '53038','24146','37803','59712','89028','41943',
                          '57291','56992','76721','87143','44977',
                          '21557','79791','59636','68122','89354',
                          '83055','10189','95472','55216','59358',
                          '26812','23102','10428','54769','78159',
                          '75756','48464','38618','73379','41466',
                          '50342','21911','71884','34086','28155',
                          '72135','78739','88125','22537','32861',
                          '90976','62522','12811','59478','12297',
                          '27730','11027','24549','49376','26088',
                          '73897','64066','91641','80458','38956',
                          '35275','75540','71554','14658','94316',
                          '16465','78835','28411','56858','43661',
                          '45640','38780','15125','82936','14845',
                          '38734','51269','96481','69434','68237',
                          '52335','23300','75520','72275','46741',
                          '71092','43723','66450','25891','98161',
                          '24252','52221','29943','93780','58429',
                          '38277','32822','31735','46872','82897',
                          '63763','96137','94940','45780','70306',
                          '34937','49904','42108','64937','26120',
                          '34105','83533','77387','72515','35425',
                          '56153','16231','32813','97977','95944',
                          '59819','45590','38812','95737','65575',
                          '39734','95608','38098','84187','84136',
                          '56351','13147','52134','15384','18025',
                          '39010','92052','62884','23729','22364',
                          '54253','51633','82534','21727','93265',
                          '31830','46882','70704','98443','79820',
                          '93199','78871','70049','57325','36156',
                          '58403','22951','43988','32363','21714',
                          '43561','53876','86830','68214','52889',
                          '90875','70566','23672','65358','19158',
                          '51219','45183','39699','42152','95179',
                          '38519','48621','59618','55993','14440',
                          '57744','10571','43540','50613','64840',
                          '38181','72556','81617','48039','50364',
                          '77756','74787','12939','44982','52125',
                          '46116','37395','78297','64582','39954',
                          '48557','42512','90335','20747','30438',
                          '91137','69518','37669','78198','21437',
                          '49037','80050','15768','43207','25590',
                          '49721','79426','47627','23054','29081',
                          '35250','62577','38158','33971','43102',
                          '67227','34585','73184','12620','41952',
                          '33154','24769','49591','93732','88075',
                          '92603','94145','71268','61480','23641',
                          '28062','39980','68898','20941','62788',
                          '17817','82174','60014','48597','26756',
                          '32332','95438','96477','96310','38397',
                          '50807','99750','70332','86007','73564',
                          '53456','99022','50638','92527','42334',
                          '44882','56357','42180','19178','25425',
                          '52730','21220','32248','29958','89332',
                          '74638','24183','76074','74066','49466',
                          '37276','13933','93739','98129','45525',
                          '77528','50753','75813','31183','79298',
                          '36522','87578','66218','34426','85670',
                          '86001','59662','48061','39460','50833',
                          '22350','61999','60542','48674','58114',
                          '40434','90364','11085','33186','26190',
                          '18085','65170','53494','84226','53177',
                          '81401','53833','49885','19655','65974',
                          '90692','73078','54564','89034','29717',
                          '85192','25520','90330','54705','41915',
                          '40853','33450','50997','54912','82496',
                          '15457','23901','16463','37059','22607',
                          '36773','35763','34162','87337','17318',
                          '93247','13975','99548','46752','12650',
                          '69076','75330','97377','30242','50403',
                          '89867','44974','32114','45170','13403',
                          '27792','99198','44236','91295','55145',
                          '57015','88531','45317','53415','90447',
                          '51789','52835','29083','69591','55071',
                          '52537','80519','67024','51682','30788',
                          '52743','82660','79495','88073','30848',
                          '25123','22133','84105','15371','93448',
                          '69140','11525','87795','36353','66021',
                          '61607','30239','35489','62893','72666',
                          '51509','47467','29282','49080')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


