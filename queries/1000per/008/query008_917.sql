
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '63555','81459','28426','88863','23973','44742',
                          '18996','14868','83769','20957','46005',
                          '97450','78077','91368','18610','64131',
                          '72893','68842','13414','52715','23001',
                          '39145','96789','90592','92822','25033',
                          '64292','18162','96134','14575','31083',
                          '74995','68539','55067','11835','61634',
                          '34463','61790','26037','89397','65148',
                          '59217','60880','65990','59828','58480',
                          '74020','84503','69249','12608','39258',
                          '23170','99805','84311','67351','33018',
                          '24805','34693','11161','59139','18291',
                          '52972','65714','61884','38805','98873',
                          '73187','84703','11972','31057','56182',
                          '41158','56398','29014','27178','87347',
                          '49712','85670','49786','37405','83665',
                          '50656','35350','84774','30815','64783',
                          '77294','52138','26566','67253','63897',
                          '66307','82433','57087','69625','90065',
                          '29929','20762','38068','31541','96626',
                          '34765','24749','43707','56298','13911',
                          '81369','57818','12450','23395','98083',
                          '93209','28129','18182','80004','51099',
                          '25576','95603','28312','82334','49001',
                          '89745','28982','38213','92765','63478',
                          '51988','79266','61874','43603','50737',
                          '60541','14427','49845','41138','80516',
                          '64072','37522','13582','93252','65830',
                          '43330','23440','16516','90643','21161',
                          '61065','44254','76788','86637','63421',
                          '12977','50289','21645','83995','77213',
                          '31214','64399','75947','86332','76631',
                          '59163','57724','49389','19692','10249',
                          '52366','17415','69184','29856','68576',
                          '77953','74235','74195','12769','63729',
                          '13055','86144','30112','27649','95772',
                          '93682','75658','27403','18414','91196',
                          '99818','14010','53776','39017','17853',
                          '37837','45586','14127','40597','79022',
                          '77155','74783','15493','61621','99730',
                          '99227','87302','77790','72346','68516',
                          '47743','46511','39840','23929','12811',
                          '97880','42463','23397','38065','51482',
                          '29252','38310','49110','95324','58121',
                          '83212','80056','61728','44864','14450',
                          '11895','19854','34118','66500','26687',
                          '91935','51036','64169','84302','94174',
                          '84289','78206','99557','63534','79146',
                          '32972','99324','50985','15646','14482',
                          '20628','57094','96812','21538','63857',
                          '46746','61827','71673','63899','19098',
                          '64184','18830','11037','19963','76580',
                          '37144','27320','89724','32927','63329',
                          '67084','50476','57408','72860','34661',
                          '42524','58305','55581','76940','44024',
                          '50549','76774','32475','98775','97254',
                          '55994','27169','25137','43866','42709',
                          '34174','22139','67805','69273','80308',
                          '23296','65760','82820','26833','59818',
                          '31798','17860','46052','51442','39635',
                          '60413','57234','85939','68711','94270',
                          '85481','48406','88572','26389','57546',
                          '99369','58248','32300','60412','20607',
                          '62904','45025','21912','16179','36568',
                          '57083','95979','41389','97749','76182',
                          '85669','17303','78352','70069','46886',
                          '99803','25251','58598','99901','55980',
                          '16926','92139','41523','43594','44061',
                          '29279','66677','45735','82674','54484',
                          '58620','67693','72698','84998','43327',
                          '68013','73750','68797','26307','64490',
                          '24611','70838','78712','95120','28266',
                          '85266','43869','62763','96268','45331',
                          '56564','13376','25964','27189','76783',
                          '14315','81495','13654','23077','23772',
                          '29307','56601','63956','93609','19312',
                          '40266','32848','90131','40482','14991',
                          '70675','89067','54119','21483','68887',
                          '74258','40315','96133','32341','78913',
                          '62903','23377','28368','53065')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


