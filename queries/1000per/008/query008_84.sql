
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '25988','63668','81265','54008','44759','85677',
                          '45078','29603','50500','96306','68944',
                          '35878','44019','11430','83910','70605',
                          '18333','35900','37918','10504','26972',
                          '68264','28065','41963','66602','53085',
                          '35236','49246','66200','82201','72386',
                          '98801','36489','33346','70695','95266',
                          '69218','75444','94414','90294','84380',
                          '33189','46430','94067','89009','34363',
                          '90298','48653','76294','40284','94691',
                          '98850','70594','10999','91183','21368',
                          '28034','64956','64074','15089','80945',
                          '18437','64016','88706','89773','52284',
                          '79905','59456','48386','66180','74233',
                          '69062','42183','23608','58292','84193',
                          '95856','91915','67349','13821','89844',
                          '74738','27670','19829','73939','57546',
                          '70269','63893','26984','17377','94706',
                          '65535','53839','83978','69471','86045',
                          '79003','37093','73524','16197','73897',
                          '98045','18611','37638','56470','20371',
                          '61474','36423','12959','23286','28760',
                          '22784','85563','58983','70838','54510',
                          '76776','48587','20985','84168','20939',
                          '51768','43503','40926','60387','83317',
                          '11469','87037','82473','86911','94241',
                          '50114','93184','36768','23629','64343',
                          '62649','33862','59727','78089','47317',
                          '85860','35364','23225','57874','50667',
                          '50617','65105','71597','96712','48293',
                          '80662','55263','66946','33447','79223',
                          '15834','41507','88319','56878','18857',
                          '35570','99634','87054','37596','23037',
                          '85090','42719','85200','23691','47981',
                          '45708','34955','24468','73961','69649',
                          '50986','39068','41734','57512','98495',
                          '91487','54969','17515','44485','29165',
                          '12479','11222','66804','77189','50293',
                          '81175','47187','14369','78345','35727',
                          '22089','64422','24054','81637','58730',
                          '38225','77771','10037','47190','47592',
                          '56110','37827','50792','72589','33993',
                          '44109','24930','80747','15219','31557',
                          '37480','49224','97308','39653','11969',
                          '84724','95171','33437','37255','92782',
                          '23944','71377','63989','49135','63852',
                          '53360','61733','95543','73539','32512',
                          '67780','93436','28829','69396','22964',
                          '50183','19106','36232','23135','76612',
                          '43034','40025','82360','78265','30178',
                          '79789','78946','97880','43852','58062',
                          '95717','56501','93902','35756','35921',
                          '77994','15533','73260','24510','46172',
                          '60070','85995','74190','92397','20607',
                          '66768','26455','21148','39857','54053',
                          '61212','11575','29383','58174','95464',
                          '92674','64953','74723','29283','38841',
                          '18987','47024','12152','89795','76246',
                          '27507','69871','37171','51416','69689',
                          '37672','80529','40228','21591','75621',
                          '41614','73252','40599','19773','26744',
                          '47262','70971','83254','27430','29269',
                          '28334','64884','24724','29592','97076',
                          '66355','54681','76975','50554','16345',
                          '54416','50067','41598','82514','21706',
                          '47922','50946','53603','16048','35327',
                          '82936','25368','62588','65053','55891',
                          '18625','34437','24345','56560','28171',
                          '40136','34382','90096','70117','86429',
                          '24204','58998','45731','51109','41913',
                          '44782','87065','78381','65598','90576',
                          '89212','83399','30248','91660','54017',
                          '44042','68702','71367','66257','93350',
                          '18982','79089','54331','18617','63247',
                          '40287','23248','60290','57399','48538',
                          '17787','99445','98968','30628','27882',
                          '40481','54439','80752','81854','96812',
                          '51404','57385','71246','48131','77970',
                          '17124','17813','86398','81277','44290',
                          '36731','84365','87299','82279')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


