
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '49786','71513','41890','61376','10897','44921',
                          '37750','35962','17315','42304','16938',
                          '89285','37042','46623','90169','50390',
                          '95529','84921','56755','52387','13708',
                          '54831','58967','96683','91365','20683',
                          '65503','58576','97506','22671','57133',
                          '63678','16762','36863','13152','38685',
                          '63038','55053','87699','58423','51400',
                          '92865','96983','81002','30249','34101',
                          '28765','85405','55257','45847','38638',
                          '99950','34064','74937','73292','60791',
                          '74188','33599','74267','52939','26167',
                          '20387','14285','56737','33003','98752',
                          '18256','76744','75688','73324','96200',
                          '42226','66895','51653','79957','21256',
                          '13354','81577','23542','47366','37608',
                          '23155','34431','98481','97171','69779',
                          '22557','97495','42392','13602','73026',
                          '78457','48831','71068','64353','73583',
                          '45009','62428','29462','32668','48088',
                          '58529','51062','28875','93146','93589',
                          '13783','97842','41300','70078','79447',
                          '76979','17648','90940','81889','47564',
                          '67967','70149','65394','10512','14896',
                          '35071','95133','50961','93469','12644',
                          '69654','49679','52105','52885','84453',
                          '94100','52379','28805','48564','94905',
                          '35360','87545','57119','63228','45160',
                          '85672','64495','50963','41975','94310',
                          '37653','27460','60045','16868','84124',
                          '90920','20829','19788','16292','99542',
                          '38206','33839','87800','79380','12978',
                          '86235','41512','57484','59798','40097',
                          '54141','91976','96022','26086','80946',
                          '94882','53701','92110','91787','38663',
                          '45326','46622','96632','85252','14911',
                          '92835','75899','67651','40656','89616',
                          '84230','42205','13505','91946','79298',
                          '76000','28137','11611','25677','22008',
                          '12325','13164','51038','52555','98051',
                          '12098','64573','31512','70924','61375',
                          '98456','17620','81979','47486','76424',
                          '34265','62102','18562','74320','91480',
                          '96584','87128','35332','73423','65281',
                          '84601','60616','46298','75371','28126',
                          '89954','39188','80286','50584','61884',
                          '77026','41314','78894','72790','61771',
                          '39190','93303','31089','10542','12499',
                          '67269','45466','64571','88811','42390',
                          '88921','81323','24138','49926','89429',
                          '51662','58095','15856','81764','43538',
                          '65846','36223','44496','61294','41860',
                          '14319','62207','17908','44942','43600',
                          '22980','30370','74681','29465','67003',
                          '68896','44997','88393','53795','79382',
                          '58382','80694','10563','30233','65851',
                          '34406','79563','38684','99207','80899',
                          '47530','33023','20555','88098','16153',
                          '20699','47786','13027','30519','40704',
                          '73995','41436','89823','11650','65900',
                          '32014','85908','57529','80307','72064',
                          '13781','39651','81119','91283','17251',
                          '25064','50988','79712','39656','58799',
                          '33351','12564','83903','24890','74230',
                          '78663','66504','76959','31639','44111',
                          '40618','31076','39829','81513','88209',
                          '19352','33495','67970','66943','68079',
                          '21815','11580','97655','81345','33339',
                          '22267','92667','84349','29711','53502',
                          '35598','64503','39787','81618','96668',
                          '50172','68821','63533','70280','54635',
                          '97128','86155','48930','10174','46822',
                          '60582','78314','73154','26791','66804',
                          '74236','12687','85277','32756','94008',
                          '86888','18978','15569','92828','22279',
                          '57636','15537','74192','11818','66909',
                          '29677','94515','84240','49548','67771',
                          '34147','78027','44586','98459','83583',
                          '77730','88992','80627','41459','87260',
                          '65547','80906','70139','60463')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


