
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '23820','78762','21483','97889','41979','73070',
                          '60446','77709','80444','40800','70233',
                          '96666','59812','74574','57091','80055',
                          '93064','70722','80428','56309','51659',
                          '85047','75344','62625','98212','34391',
                          '31733','66008','82659','55681','60100',
                          '91080','90846','90097','52993','34520',
                          '73858','13598','86468','83212','44081',
                          '77778','20902','35987','78822','84081',
                          '70617','68816','64681','23635','20302',
                          '67931','80420','20406','19326','68662',
                          '70119','76697','14012','20116','95166',
                          '33984','34725','95711','84582','42688',
                          '62650','72185','55775','86025','27405',
                          '51769','15471','81372','98508','68177',
                          '71117','91127','81753','37637','28732',
                          '23531','35232','46612','50283','87544',
                          '56053','44633','81951','19178','36510',
                          '57690','18706','32538','77839','22401',
                          '28856','74970','37161','57961','37619',
                          '58522','66594','32650','44475','18301',
                          '15269','60986','64547','77585','88010',
                          '70007','48640','16786','20985','46299',
                          '36347','80289','74187','96311','63840',
                          '52906','41410','33281','95663','22482',
                          '38206','95151','36636','28935','12908',
                          '42125','23802','97384','87132','63092',
                          '87932','94562','79681','20613','23024',
                          '46052','61423','58830','65784','45992',
                          '16020','70775','51440','70394','53380',
                          '14602','51261','37068','87415','78205',
                          '90063','68318','76037','45079','58312',
                          '21535','30399','18024','85207','44825',
                          '65945','20856','50414','10865','93225',
                          '91701','85321','32516','66791','77185',
                          '85037','51673','85659','89758','75587',
                          '35844','54121','52633','78008','96848',
                          '84941','63452','43147','18371','18239',
                          '15888','81329','99571','78405','94347',
                          '77480','26235','12647','90423','48210',
                          '27097','83835','98343','65190','47495',
                          '61787','68438','80733','72459','42052',
                          '90720','17735','77298','22545','46033',
                          '94335','95900','22107','22005','61650',
                          '48596','97678','36458','49927','40748',
                          '74568','75518','14979','42076','19531',
                          '18238','89562','18814','27747','56251',
                          '88534','75146','43695','11261','96535',
                          '92340','61293','79781','29548','82306',
                          '81354','14162','23791','82162','75952',
                          '49279','63223','94147','74075','42727',
                          '32960','31143','92045','24607','21300',
                          '26183','29595','80454','78106','92030',
                          '57059','25484','38661','67172','70514',
                          '88023','19179','19722','52170','91596',
                          '71248','74364','51910','64174','70527',
                          '17746','52994','52753','23590','53546',
                          '95436','48418','46364','80838','65646',
                          '41452','56148','33973','33655','35241',
                          '71535','45202','41643','50929','90090',
                          '57925','88879','57454','14204','59446',
                          '82725','27321','54504','42771','73134',
                          '69277','78359','63407','39706','31232',
                          '59395','50070','27704','50512','23282',
                          '63740','22297','57326','88001','80726',
                          '41808','73867','68465','66253','25520',
                          '90536','56624','37511','41780','62090',
                          '29564','62669','53388','72669','85136',
                          '10701','75191','25996','63526','64230',
                          '19387','16029','42633','36816','11914',
                          '17292','60465','28744','43014','63418',
                          '29923','60653','12939','74975','52344',
                          '16802','89532','53977','34020','58886',
                          '66790','92330','24885','56648','22538',
                          '26197','94786','21502','15300','28621',
                          '91718','80686','34372','39422','48764',
                          '44916','25611','51203','15759','33904',
                          '97326','58207','58798','67182','21423',
                          '47402','60436','28651','91106','63464',
                          '22474','33043','57109','69719')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


