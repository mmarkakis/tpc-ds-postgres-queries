
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '61049','97417','40423','19831','14648','75435',
                          '30929','67207','19930','55171','86430',
                          '64946','57254','36549','93989','95380',
                          '50980','71723','27447','26392','87401',
                          '47424','44561','11181','76810','35043',
                          '30931','11892','79471','49656','33839',
                          '16949','72260','96125','21851','35963',
                          '17242','97280','77067','98904','86860',
                          '57668','18687','33201','59364','94720',
                          '30110','55370','76876','17409','85809',
                          '99015','46789','34576','61620','58930',
                          '57069','17997','55455','37566','35828',
                          '27082','19853','77963','71284','12971',
                          '52147','89500','76906','66119','59507',
                          '57660','41313','90939','23614','87547',
                          '61931','30967','91878','79371','46650',
                          '49085','51122','52741','38031','86846',
                          '84854','63369','75765','92956','94061',
                          '69707','74265','53038','67771','96850',
                          '70806','88833','82434','55135','38959',
                          '79077','82670','76399','49836','58677',
                          '60503','58526','67910','64503','92046',
                          '35341','37800','42525','65142','63218',
                          '39332','42772','20904','16808','14130',
                          '37211','76777','45181','38740','57503',
                          '50577','85658','59043','70108','51707',
                          '91085','10066','44713','26299','11747',
                          '12147','41330','35405','61271','57958',
                          '49103','65969','10845','64304','21497',
                          '51119','12964','90348','35415','16748',
                          '98756','77546','86639','93032','63175',
                          '23474','67418','47931','14386','42953',
                          '23191','40330','39041','55386','22769',
                          '79183','86163','14159','45374','72871',
                          '35597','44809','79102','51729','40952',
                          '81224','64873','81343','69820','58206',
                          '60987','92506','19683','71507','81243',
                          '26179','98468','45198','36967','70803',
                          '99694','49027','44182','79361','39309',
                          '40651','63296','47541','81582','56721',
                          '41629','59566','92662','13722','75776',
                          '64278','66927','61265','60164','34571',
                          '79865','34760','66050','15023','98503',
                          '44949','16789','53591','36408','70432',
                          '15422','85137','43908','87461','87827',
                          '92819','65587','29541','38589','97456',
                          '29691','43532','29352','86825','35677',
                          '14105','13802','48322','54342','63286',
                          '65318','24584','33349','36589','14606',
                          '15659','95188','94472','22792','53985',
                          '64701','76984','35170','35549','47126',
                          '78320','11807','68033','20943','62247',
                          '53104','86281','88170','39760','20167',
                          '61073','23469','69543','10297','97237',
                          '25012','45500','91752','69161','95942',
                          '49900','86059','32863','93600','94827',
                          '14212','55261','95444','89218','13157',
                          '23076','32388','99321','31969','34112',
                          '97690','52652','90582','31269','28014',
                          '75209','57788','16161','85790','62044',
                          '42084','18397','14788','62157','32328',
                          '57117','27948','52585','13873','87792',
                          '29154','47302','63623','70628','40986',
                          '92572','80270','49337','12936','29255',
                          '14471','49151','24487','49020','97964',
                          '32089','24287','35648','72294','78187',
                          '41600','28769','97173','51470','91737',
                          '93200','72863','91665','68824','35047',
                          '61984','58946','37715','56860','62986',
                          '47405','13025','89012','67141','56209',
                          '75361','67077','32333','97342','20533',
                          '36592','41767','40830','19072','94412',
                          '69774','18721','10495','74976','44287',
                          '70868','55250','38947','98991','16983',
                          '58717','40193','52445','60054','90457',
                          '35729','43768','74541','81984','84790',
                          '18540','63710','80582','71265','97283',
                          '61876','13745','85369','88618','84185',
                          '88200','27882','90756','68158','47291',
                          '38912','62711','91023','86369')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


