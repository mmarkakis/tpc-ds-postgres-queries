
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '27220','14882','63390','99546','26868','75282',
                          '16638','64192','88140','94844','59660',
                          '74962','86125','10111','20388','75186',
                          '87400','69677','35695','44425','54256',
                          '36354','24365','27502','26257','18603',
                          '31559','32993','46920','49910','93841',
                          '97972','86315','50188','86111','73994',
                          '44147','83564','34196','60710','72588',
                          '94791','46375','31366','17342','87156',
                          '99738','88066','11771','74048','61221',
                          '86761','79430','77712','79574','73560',
                          '71170','96447','44241','79250','48652',
                          '53242','90806','89837','96115','83427',
                          '47270','85521','56466','77045','21716',
                          '94626','87493','28256','89272','70195',
                          '79379','30835','35901','65701','19453',
                          '18384','61966','76170','92893','73789',
                          '65562','39010','46613','87027','79919',
                          '60479','63640','64516','82148','24739',
                          '69202','50342','51371','58290','31363',
                          '66869','57555','51057','40699','91781',
                          '27146','43273','66733','86074','15276',
                          '31415','92972','80987','52372','68876',
                          '77865','18140','87597','43570','14867',
                          '68336','30549','47092','20750','51894',
                          '97312','55349','64981','25437','31041',
                          '17432','43368','20198','32716','58683',
                          '61787','97136','59317','87879','29657',
                          '16434','77455','71971','25681','33959',
                          '28377','75677','38458','21151','19098',
                          '96616','54795','10948','50667','74708',
                          '21763','14010','76379','34033','56009',
                          '94759','49208','65469','71998','69495',
                          '61816','50583','17072','30240','38092',
                          '49873','10363','62424','37775','24815',
                          '86204','66961','22981','32552','37547',
                          '94876','70141','28282','98183','37694',
                          '13440','68562','88455','71220','25732',
                          '62481','18694','30216','24108','94088',
                          '30459','53753','72015','48514','47618',
                          '34832','69981','14644','22298','65456',
                          '71448','86312','15315','71365','60202',
                          '77410','65495','65653','98824','15541',
                          '66321','44035','64988','69688','25206',
                          '16931','22331','73359','81889','11178',
                          '99155','65825','67389','64605','78212',
                          '15472','71514','54111','84717','63855',
                          '94913','17495','26195','39531','23525',
                          '16273','81736','96871','72229','75925',
                          '75440','69997','78378','69198','86322',
                          '86751','88114','20795','70760','48913',
                          '53484','57998','19381','91668','88758',
                          '59613','59559','77770','54550','68514',
                          '24951','75052','13616','67491','81773',
                          '37244','75076','57090','52956','59162',
                          '54858','85846','63300','23972','72727',
                          '51399','17425','31151','61390','19910',
                          '82239','42456','61661','45263','47762',
                          '35586','13397','23892','78904','35109',
                          '61553','62366','97863','53682','37996',
                          '13035','86806','70813','94884','23156',
                          '13479','55337','19543','66495','31575',
                          '83731','48438','42940','45712','82526',
                          '64749','26797','52850','41688','56124',
                          '51977','85762','93420','69460','70236',
                          '99465','53240','84102','14919','34335',
                          '14020','77015','94705','43085','31411',
                          '55109','64154','65304','41966','33678',
                          '12057','64631','43824','88519','83749',
                          '29915','87610','93192','58317','50604',
                          '20822','59801','60610','19926','43592',
                          '47041','74029','38867','31812','61311',
                          '50132','82099','83820','47697','82607',
                          '56431','77925','77352','48707','58217',
                          '51321','64010','60793','97098','51705',
                          '63466','99519','39712','47336','73462',
                          '59739','41128','80252','16940','65638',
                          '99390','93469','87813','61573','15351',
                          '99955','81042','98084','18160','92792',
                          '67721','95666','67251','99350')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


