
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '65169','15516','24900','58925','96036','52643',
                          '19441','18220','46758','47218','98602',
                          '83728','45976','32614','86260','31950',
                          '15253','28694','25320','51816','91549',
                          '20209','88368','91434','53053','54307',
                          '77698','22872','53034','59326','19821',
                          '54389','25145','96702','49328','14919',
                          '40435','56870','80115','60238','95880',
                          '52310','93262','73020','98387','18177',
                          '46741','37106','61855','43723','14241',
                          '57280','69330','20085','87305','76169',
                          '19556','51534','22642','91597','49569',
                          '14863','10351','74129','17853','43160',
                          '31887','35319','89983','29504','58327',
                          '88257','24984','61444','37089','66509',
                          '38174','60951','23933','12725','24292',
                          '64215','51301','57252','62456','72747',
                          '69820','27178','61543','78329','25367',
                          '98108','21141','86076','39210','33440',
                          '30261','89919','15606','23769','90382',
                          '29539','67535','74001','87825','74906',
                          '92417','14267','16841','20770','89639',
                          '68955','39848','24210','64404','13227',
                          '69889','47314','64478','79308','69812',
                          '39945','26809','72348','29299','66287',
                          '17017','63195','47767','63962','27220',
                          '89133','48024','49254','51729','18366',
                          '84361','84333','18411','96212','34624',
                          '64187','32872','13026','75846','64873',
                          '69300','65850','50271','25982','92803',
                          '79775','50751','27926','62489','97628',
                          '54247','26685','84720','18821','46118',
                          '68842','54233','92860','60164','58485',
                          '76979','24469','75721','16703','59093',
                          '49961','24646','36993','94129','43628',
                          '41850','24406','80575','98134','92767',
                          '92170','20796','83220','37170','57887',
                          '50324','89444','68162','20116','53050',
                          '55959','60436','53181','55246','14373',
                          '53143','46215','15314','87776','98228',
                          '47832','95745','24041','52053','58827',
                          '33924','28461','75947','45400','54695',
                          '69342','67350','56424','24310','86792',
                          '83673','51607','55882','57083','73197',
                          '78369','62221','86858','27554','92434',
                          '32477','97553','80281','20453','69331',
                          '17795','35012','35502','44277','72427',
                          '87863','18516','72401','29710','27328',
                          '54806','42124','59229','71542','27410',
                          '43309','49245','69322','52899','57909',
                          '34003','46306','64790','89704','76077',
                          '32778','18567','94321','88567','14936',
                          '60742','63679','90714','36861','60314',
                          '39610','24092','24978','96040','66792',
                          '43045','16494','37876','58074','49081',
                          '87323','23252','57982','62368','96265',
                          '60752','87783','56140','99512','92922',
                          '25578','64499','68537','39026','93606',
                          '23605','46778','39081','49251','73775',
                          '85502','53928','45081','32569','24402',
                          '97296','53337','89572','64746','88800',
                          '36763','65675','61550','12727','57715',
                          '25060','95903','12519','16912','57213',
                          '90862','92086','11337','30607','81769',
                          '49354','75795','50792','30764','28512',
                          '78415','42968','88663','69970','72641',
                          '50189','96102','92947','31696','72730',
                          '65089','59760','81868','50517','58698',
                          '23389','79999','15774','69214','90540',
                          '53190','19617','39860','98827','29713',
                          '62040','12090','98590','76410','99369',
                          '33477','35125','35366','26592','16188',
                          '44190','70716','81106','36597','55385',
                          '66599','49416','99760','99576','96997',
                          '77989','30980','61291','78271','19563',
                          '50979','24841','94361','87013','71233',
                          '67114','35632','47195','27637','94732',
                          '83149','33010','12465','46983','89256',
                          '81436','61573','96693','21897','40122',
                          '62951','19567','13124','34364')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


