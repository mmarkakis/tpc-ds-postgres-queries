
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '40736','94891','33554','54618','78147','74772',
                          '11481','31227','52911','38934','50366',
                          '82702','49894','51979','44872','18672',
                          '25062','54833','72840','74314','34426',
                          '68634','45466','85267','38507','44336',
                          '65985','39534','12670','89566','91075',
                          '29174','63207','87819','47667','95501',
                          '95688','57715','51372','15571','37629',
                          '13740','14747','70066','56323','85337',
                          '74816','59955','82132','60664','27330',
                          '55406','90284','95915','82192','58076',
                          '39551','79339','20639','30628','20343',
                          '35343','38356','48046','16758','48754',
                          '91472','16735','99578','85184','20222',
                          '20383','21692','16974','42084','87108',
                          '72022','93544','49742','61291','61978',
                          '91555','26170','40541','29672','19446',
                          '83460','76608','61948','45135','72323',
                          '15204','71107','17851','83312','68465',
                          '13462','46282','11130','57072','51040',
                          '32387','82296','33752','54437','99061',
                          '64017','51531','60030','53949','65990',
                          '27516','99084','72944','98615','66631',
                          '36873','72923','78056','26510','20551',
                          '92200','67178','56600','17712','15721',
                          '96586','76778','42420','35578','20811',
                          '53853','41381','38090','74545','43323',
                          '61997','31260','53275','40361','92037',
                          '65529','83979','25431','31943','20966',
                          '27908','22413','83988','61871','93911',
                          '64595','26747','42251','30051','96753',
                          '57863','21944','29741','71381','38495',
                          '84571','79503','51454','33494','20712',
                          '44076','87867','65053','80759','15909',
                          '44797','96249','96404','36678','61892',
                          '44400','24642','46616','44885','31615',
                          '28739','34040','31023','74007','85554',
                          '89239','64296','63095','54205','11120',
                          '51909','52319','19189','55361','85212',
                          '55383','85225','44121','55001','12485',
                          '60783','39302','56655','11405','19214',
                          '61802','71137','36575','89145','30402',
                          '89808','19281','77069','30979','91738',
                          '82974','33895','61002','33445','37666',
                          '87991','89841','64844','68577','95202',
                          '44537','12499','65883','70926','10536',
                          '47627','24841','14626','33328','64456',
                          '73170','18938','36008','93800','33755',
                          '24979','46906','74584','19807','14314',
                          '55746','57829','66287','50329','67525',
                          '89999','69593','19301','15681','89978',
                          '39025','78377','11932','63698','47755',
                          '31610','47777','41536','49810','67676',
                          '15908','71303','85850','98159','33395',
                          '46810','99968','31665','47900','36000',
                          '68548','47074','83279','12360','36629',
                          '94730','57740','80600','80725','44932',
                          '61755','32052','87398','14609','64633',
                          '49846','54165','47219','98405','24606',
                          '94772','51252','31404','69388','60646',
                          '22570','56244','28711','44108','93136',
                          '28526','30634','45397','50866','80749',
                          '99079','42472','72289','28611','21814',
                          '77776','25437','11187','75886','88543',
                          '40931','29554','79874','96377','72842',
                          '56022','15114','88857','43874','19108',
                          '49394','27320','62192','73393','28886',
                          '90976','36162','43884','16300','17074',
                          '21592','80085','82310','37630','30110',
                          '28394','18622','51288','87149','39704',
                          '38139','73779','27289','57562','71818',
                          '66034','46898','21517','40500','66214',
                          '65954','49452','58457','31506','51290',
                          '77825','56938','26616','50840','76625',
                          '58689','89089','10326','62873','42658',
                          '35685','10329','28875','82549','29326',
                          '68269','16489','57555','42036','76247',
                          '90946','52679','96110','66389','85489',
                          '18351','29076','71718','68063','18006',
                          '88550','13980','16947','98085')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


