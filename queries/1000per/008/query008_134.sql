
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '55537','46851','17706','85415','35963','70832',
                          '50765','95303','54812','71105','96195',
                          '67806','60648','45779','88680','19164',
                          '95130','86033','76537','36362','39283',
                          '66753','89309','38464','99732','94354',
                          '75178','22313','89251','41214','38325',
                          '54447','73258','59331','77700','70955',
                          '47532','98780','43074','67682','36851',
                          '87761','94724','34596','66114','54415',
                          '91106','61151','66249','98133','78203',
                          '26099','70942','26820','32504','31580',
                          '97257','81815','23740','39364','90786',
                          '14511','52198','83742','80560','56159',
                          '81143','56182','38218','77553','56996',
                          '63122','45539','74992','18994','93571',
                          '31591','60772','45822','89485','96557',
                          '19114','97464','48633','97839','62306',
                          '18052','79100','40429','45398','91521',
                          '38482','90772','64053','75384','35577',
                          '49487','96480','40687','18135','92322',
                          '72723','12912','28433','68221','37792',
                          '79668','86743','90101','63220','29208',
                          '18225','12006','27971','61516','43604',
                          '92853','80273','67774','45628','18798',
                          '82586','75377','28554','26360','11254',
                          '88002','72464','75871','24606','15485',
                          '12065','56154','68412','60694','94528',
                          '20263','60353','16996','25429','31592',
                          '41750','12153','12034','88092','82920',
                          '11478','33603','40993','29436','15584',
                          '88498','99324','86741','25125','81276',
                          '41603','21696','81251','26232','46723',
                          '30680','60178','80111','89625','10185',
                          '29323','22382','28803','21305','77166',
                          '76098','78562','60454','30150','18365',
                          '69918','79331','32938','87682','19843',
                          '43886','90554','62979','10226','17556',
                          '80992','99970','75901','59097','45861',
                          '67005','22631','57980','62821','98750',
                          '83466','73081','40006','84744','22260',
                          '91069','24536','21079','51024','16399',
                          '99656','95879','42669','14424','38102',
                          '45878','91353','13479','13585','23991',
                          '41390','77696','25371','84532','81938',
                          '26800','82401','46793','10164','42281',
                          '95362','81298','10651','72105','51961',
                          '45121','91575','26480','46184','34537',
                          '80406','95345','38752','38369','16332',
                          '87692','31484','85843','99492','24323',
                          '93843','66924','70193','97880','46183',
                          '21673','16746','96953','43933','24379',
                          '85977','58961','47770','84748','86946',
                          '17804','82943','25156','79887','62353',
                          '27590','20297','21962','63130','89174',
                          '63680','59604','38754','84816','95137',
                          '86010','16960','78540','73518','23931',
                          '29621','60153','26936','92774','95592',
                          '76813','98092','10315','26230','33339',
                          '30683','97584','82134','31498','19195',
                          '81016','40660','82873','87860','32659',
                          '33718','62882','59915','12606','53026',
                          '44694','42082','18033','22097','20357',
                          '33957','71153','90482','17508','34716',
                          '66722','57379','43631','92526','66667',
                          '37442','87614','14230','37944','66980',
                          '28149','54946','71581','72834','97214',
                          '13663','52595','36088','78457','95450',
                          '48000','46158','16050','18125','12783',
                          '20513','58118','55781','22353','18247',
                          '38346','85423','35416','50400','48520',
                          '25785','89243','40219','69548','64044',
                          '71771','53197','88907','23446','73305',
                          '84258','61010','87593','52121','97630',
                          '11165','57839','99726','91894','90730',
                          '82520','22852','52758','10915','20970',
                          '59567','23550','99007','94707','25119',
                          '84196','84604','40116','89274','43091',
                          '50044','42548','19425','70100','99665',
                          '76545','95199','33563','47199','46593',
                          '58709','92611','73417','46370')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


