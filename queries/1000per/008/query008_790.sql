
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '27786','79074','75791','95711','77980','98481',
                          '78310','67483','16298','37322','94377',
                          '49707','93408','41818','57462','16208',
                          '35839','16265','53520','94951','38919',
                          '88562','23869','25260','87756','40604',
                          '92193','92119','20042','37339','19681',
                          '85873','95373','91499','81962','32800',
                          '67641','79081','51521','43663','69520',
                          '93291','93172','27751','71480','44541',
                          '15858','29571','52377','54914','83459',
                          '69850','44182','23319','94172','67492',
                          '73091','30388','34834','48186','51263',
                          '29423','41857','49942','70415','68857',
                          '40454','40407','54213','41484','16865',
                          '91233','87067','31894','35923','35930',
                          '57947','50379','47921','77713','28536',
                          '12085','55543','86802','85524','12452',
                          '31509','26412','43282','13760','53801',
                          '60682','19331','83836','51775','11663',
                          '78992','15732','48192','49669','19261',
                          '78391','69200','64996','86492','23571',
                          '69047','18349','47114','95159','11777',
                          '19639','97845','89821','91041','87722',
                          '56731','19877','14621','43845','36288',
                          '61097','50518','26904','12287','78878',
                          '55817','24097','40460','41800','27966',
                          '94454','41378','22379','19043','25362',
                          '91059','54541','13065','32494','13000',
                          '99802','53765','96862','85068','40915',
                          '30815','77808','81944','50947','84927',
                          '27295','46660','19929','55532','15679',
                          '98258','33391','78279','90580','83565',
                          '59202','77190','16611','28029','51470',
                          '21805','14873','99077','75976','60728',
                          '23962','88531','94772','24216','54769',
                          '21458','15974','83636','73579','31318',
                          '59471','54155','32601','29154','34673',
                          '12320','20467','46514','62731','29944',
                          '30943','82782','59540','19279','69637',
                          '74347','52111','66437','17177','56494',
                          '47381','51613','88084','65257','84443',
                          '80349','47634','95701','85372','98712',
                          '40957','21808','88122','91983','15806',
                          '31075','43020','51095','69959','34262',
                          '13599','40633','60558','61792','39404',
                          '34369','52833','88417','48693','65103',
                          '71453','78361','17675','97308','15837',
                          '70916','15011','47319','69403','71133',
                          '83186','12129','52224','14977','46179',
                          '58453','33143','67129','71049','86374',
                          '14512','39395','30574','91801','76529',
                          '19698','32359','74355','25168','21255',
                          '47922','46167','83213','70021','82272',
                          '56906','29332','50739','60818','56540',
                          '81225','16728','62172','55179','45672',
                          '14563','50384','96502','17408','86898',
                          '95184','95331','66290','72407','91597',
                          '95621','62785','67396','10078','27921',
                          '88312','79817','43484','25629','49492',
                          '68654','39962','61275','67775','59165',
                          '28899','90109','59246','32424','76073',
                          '10885','22909','60904','70056','58668',
                          '59700','28342','55480','28482','59083',
                          '51537','42169','28813','13617','39639',
                          '74680','82258','14581','93883','55006',
                          '76854','29040','90939','56427','64452',
                          '42744','98420','59691','47241','25917',
                          '90650','83578','21350','23998','58568',
                          '84528','45490','91943','26879','57250',
                          '79603','32691','27449','26986','10712',
                          '61008','52157','28484','88224','13611',
                          '12371','81870','61457','86008','77848',
                          '93283','22947','35978','70945','63394',
                          '13726','37389','36719','29731','78445',
                          '57129','21705','39103','12729','12507',
                          '48110','95518','73837','56265','27590',
                          '90108','17630','83274','54634','85025',
                          '37688','15996','90483','79376','88412',
                          '21158','19138','17897','97379','16513',
                          '95397','18856','35982','38882')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


