
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '85180','57920','25188','43109','94884','26534',
                          '88978','17513','88876','56115','72685',
                          '88358','53878','20909','52025','61226',
                          '53153','83803','95652','48168','39885',
                          '78899','69559','64000','69691','19669',
                          '10547','69764','97289','84788','65145',
                          '41213','89806','11949','11118','60744',
                          '13206','37203','82576','28146','33609',
                          '11907','16649','14610','29582','46685',
                          '99303','52511','24606','17723','76116',
                          '17541','32914','74423','52905','43757',
                          '70244','14428','60851','38450','61669',
                          '46958','63645','41532','44076','14369',
                          '42145','26652','84921','94737','33036',
                          '27079','53044','63084','80827','35916',
                          '35334','44434','14695','10600','47202',
                          '82954','34778','53482','51996','89000',
                          '92546','57414','26752','70425','84274',
                          '86579','18868','21829','47994','38195',
                          '47669','85255','18418','31664','99939',
                          '57441','82970','38066','88495','70023',
                          '25347','82426','36766','51877','56070',
                          '66438','72498','11553','88457','76820',
                          '80868','52405','55116','99349','22016',
                          '16286','37096','59052','97011','80051',
                          '89653','33987','89751','14550','58881',
                          '97607','19752','98219','87015','37251',
                          '78061','25216','98997','55277','49145',
                          '41055','98541','43241','58504','62292',
                          '86086','49278','16582','15023','67812',
                          '57115','81499','62418','22615','91691',
                          '74021','29071','82766','39779','43393',
                          '19830','67780','94028','35573','38973',
                          '27023','82861','27358','74844','48433',
                          '66284','43780','17902','16400','82361',
                          '83060','54801','96662','84294','95865',
                          '71029','22195','46079','74216','61634',
                          '34961','72267','62646','53564','77016',
                          '15804','95539','42847','31192','50939',
                          '64989','41388','46416','13979','51341',
                          '35996','83417','41262','54703','16407',
                          '38242','24955','59481','96365','38553',
                          '31008','43434','34438','33067','87402',
                          '66712','19136','36194','84637','60126',
                          '59827','64061','71807','54385','37462',
                          '80632','17686','51985','44306','55152',
                          '63827','56838','75299','80653','51781',
                          '84601','10818','44212','35245','19609',
                          '36501','81837','35015','89454','20308',
                          '78746','77683','22166','69792','17024',
                          '58920','49287','65661','78019','50299',
                          '69788','17310','81152','36588','64467',
                          '23959','56073','31458','63762','92349',
                          '89883','70970','64766','59299','64759',
                          '84890','26792','45908','25697','30897',
                          '40116','44295','74607','74549','66979',
                          '40721','43184','72091','93847','19748',
                          '95236','76479','91026','45443','47055',
                          '98247','44356','40321','71462','23292',
                          '64849','22972','65775','13145','57298',
                          '42609','45687','98064','86694','32682',
                          '75476','33119','70432','67192','14066',
                          '96714','12521','95531','16120','67890',
                          '32817','56369','43915','55273','78096',
                          '23331','13280','20150','35023','30875',
                          '79547','31266','74741','56829','71279',
                          '99039','23878','30735','91762','60938',
                          '39714','55054','90754','56870','19270',
                          '94990','64403','86865','53320','12321',
                          '77247','23764','83365','41982','55814',
                          '34188','67222','12904','11772','17910',
                          '64224','15467','31218','93953','22557',
                          '47256','50774','57801','25365','55526',
                          '96288','99768','63705','59591','39273',
                          '96740','74173','78847','43894','84051',
                          '72163','28668','11077','88861','63594',
                          '50266','95387','30972','91631','47754',
                          '20757','38429','44588','74439','26740',
                          '66656','45009','45821','34348','83556',
                          '44402','54598','39980','70360')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


