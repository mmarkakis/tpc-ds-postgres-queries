
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '34394','10510','35336','25385','58674','34928',
                          '79002','51900','35220','79428','39162',
                          '32471','16407','56386','70172','11012',
                          '29757','97983','74062','89136','60190',
                          '45125','19152','72064','51946','43367',
                          '16981','66584','93440','56183','17316',
                          '28724','55379','82620','57380','60773',
                          '22324','32072','19611','43016','41498',
                          '11424','97633','20125','59770','27268',
                          '62048','96576','32500','23511','34994',
                          '63784','56616','90412','12847','81543',
                          '87783','84866','34502','81160','41091',
                          '22489','53119','99880','76066','96615',
                          '21304','83711','38921','13570','14385',
                          '30954','26655','18342','22810','91367',
                          '93597','98628','95529','38350','71478',
                          '28744','71039','23651','11619','34177',
                          '12557','40049','35089','48216','79716',
                          '64957','21141','31323','16839','67456',
                          '73933','82379','64190','39749','73578',
                          '15524','34400','96947','95863','71291',
                          '70553','20550','75213','29327','81015',
                          '68347','93207','89799','98297','33728',
                          '33820','74063','98586','62411','36256',
                          '25182','16117','73890','28662','23755',
                          '17950','49243','23686','20549','15783',
                          '35937','34467','79191','55850','67877',
                          '78755','93845','80035','55178','40478',
                          '77540','60541','11856','64445','67048',
                          '48767','97193','73930','49410','97424',
                          '98249','92180','81537','62635','29047',
                          '25189','83378','96574','98757','20400',
                          '67939','62143','82825','29878','54594',
                          '98937','73591','38714','82671','86822',
                          '70743','44425','91694','95699','36597',
                          '31790','25628','50667','40824','21308',
                          '72795','62366','41424','38512','21971',
                          '67132','92004','59707','24787','60205',
                          '73129','74355','58017','15923','36085',
                          '98104','97405','94494','95302','60916',
                          '32800','67733','69411','93298','53939',
                          '53925','47458','81029','78332','81737',
                          '42472','37929','56401','60531','36162',
                          '93726','10382','55757','32586','88980',
                          '88269','55378','82853','78709','33353',
                          '31996','78101','86377','70186','24708',
                          '46190','81390','34584','49107','56265',
                          '17759','33088','53450','72481','86624',
                          '86537','61191','27540','61395','12160',
                          '32094','69070','11296','38327','28669',
                          '12309','69806','27930','48633','76734',
                          '71276','42061','97778','16291','87770',
                          '60266','87422','97078','19923','77452',
                          '59581','43466','89243','72246','43028',
                          '52073','79766','25018','27969','82050',
                          '40837','18464','26937','24072','78481',
                          '12505','72941','54761','88247','23947',
                          '25489','55686','83208','97682','44803',
                          '13003','60111','97708','46053','34541',
                          '86574','24252','36865','13841','54516',
                          '11773','56381','88569','95892','52451',
                          '57553','19289','20716','48098','16635',
                          '32604','40275','33302','41408','65956',
                          '99483','36475','89602','44273','84629',
                          '69688','43027','59259','15415','61779',
                          '69038','53445','25187','94350','50339',
                          '12684','58463','96099','18421','64120',
                          '75102','70771','25073','85922','75144',
                          '78621','20511','51168','62477','33987',
                          '57805','94612','68134','84231','45652',
                          '33718','20739','29662','86332','96163',
                          '43521','32028','97146','35564','64931',
                          '72822','83511','13477','80687','80982',
                          '14551','60682','25349','72879','47490',
                          '91232','23554','96426','54493','86025',
                          '37276','38068','12950','34079','32229',
                          '93142','57412','21101','50285','26521',
                          '14797','53300','29539','22445','17946',
                          '22150','77629','98892','44544','95740',
                          '19742','83627','90597','60431')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


