
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '63106','89011','16608','41146','36649','45433',
                          '39325','84944','11166','10298','45728',
                          '13143','26408','99837','45475','57052',
                          '16284','34878','63214','38517','10926',
                          '37493','35170','25737','52091','61701',
                          '51331','93150','25162','62630','49147',
                          '78218','55735','16472','41124','25946',
                          '18646','31928','89574','83462','69443',
                          '76030','16759','25710','33235','65220',
                          '27262','65575','38451','22136','92250',
                          '69316','16116','94259','75009','84873',
                          '69230','27099','97513','39753','26272',
                          '81981','13585','92192','36100','40569',
                          '98206','60882','48181','54591','81669',
                          '52669','64015','50866','19510','79383',
                          '85642','31860','10963','45067','74381',
                          '95491','36573','83699','26969','87960',
                          '16660','93981','15527','55792','38402',
                          '28488','52024','77103','44226','21238',
                          '33983','71967','50850','80804','26922',
                          '57329','64462','21139','20955','93389',
                          '10368','49309','53779','38904','64505',
                          '74249','74608','52228','79975','43717',
                          '25413','93860','41628','53130','33557',
                          '19050','38341','24300','48197','76223',
                          '88868','83878','57894','90419','82202',
                          '68986','36542','84773','52478','84438',
                          '61173','97112','46695','11791','92709',
                          '88556','59612','10262','22324','78559',
                          '56898','31085','36175','90879','89391',
                          '60145','76129','59273','25120','79311',
                          '96813','86402','23394','21045','72812',
                          '37724','94959','62310','70443','85318',
                          '51614','27059','13999','43698','26047',
                          '87964','27269','65399','24011','66108',
                          '19300','30435','11813','29495','25487',
                          '24199','95584','90271','55191','14714',
                          '18269','49203','42925','96382','40366',
                          '14745','43949','71812','61191','14685',
                          '33842','79852','97127','15681','53359',
                          '25843','13360','77988','67991','25763',
                          '67479','84522','91054','54836','58358',
                          '18023','49666','66318','88089','28254',
                          '77982','78460','98773','11033','60859',
                          '45207','98384','50916','47206','91989',
                          '92098','80557','78251','79938','21358',
                          '51699','35961','60045','78678','24885',
                          '63540','63337','77485','95480','38481',
                          '62964','86526','55208','32106','45965',
                          '35474','41578','42145','85704','60129',
                          '91288','92733','38838','15787','30099',
                          '38660','78310','26697','95603','31566',
                          '55128','59186','67413','12185','21570',
                          '90683','41356','74262','22155','59902',
                          '80903','26208','24835','86214','96059',
                          '55724','81711','25344','72825','71377',
                          '95705','12914','61441','84698','94737',
                          '99766','96899','76166','89224','65054',
                          '86755','54723','32465','44608','31653',
                          '31694','22925','15255','78776','33219',
                          '37469','75813','39248','85002','89220',
                          '97018','60649','36232','92942','97932',
                          '70995','47704','97722','66777','79387',
                          '60594','29312','92596','16339','23156',
                          '11371','26304','71468','61077','63023',
                          '23249','78573','80709','95266','35375',
                          '65040','28496','28411','78349','78093',
                          '65282','58784','92763','16826','57474',
                          '31417','89023','54229','14638','78339',
                          '91704','51569','78848','21967','60993',
                          '81319','57060','58071','67337','30422',
                          '75126','26649','31285','15933','46460',
                          '60353','24478','73466','98927','56061',
                          '52224','33373','86796','35282','64481',
                          '67444','51010','48368','72542','57693',
                          '80241','65706','16901','38207','95799',
                          '61876','65123','79889','27770','86249',
                          '28752','75482','43622','16379','99088',
                          '16842','53062','41076','27594','61347',
                          '60012','27556','18088','14733')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


