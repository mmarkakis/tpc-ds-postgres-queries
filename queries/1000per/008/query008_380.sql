
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '49038','36488','54016','21091','19123','38785',
                          '34536','24504','36114','19167','65898',
                          '34162','60322','10939','89816','23805',
                          '45322','61918','46788','47542','12520',
                          '72562','17964','78516','70271','49235',
                          '62812','54169','11259','23795','88326',
                          '74138','49605','56724','21838','34617',
                          '36738','16185','72579','56094','48809',
                          '55372','45414','93136','31494','58858',
                          '26938','16841','34669','34601','93595',
                          '83480','14194','32704','41494','53864',
                          '34508','48546','19844','77153','19413',
                          '62317','96159','44077','81889','46546',
                          '66704','39572','65266','12076','40214',
                          '25879','68712','66828','55466','23091',
                          '72927','92819','59002','20622','79471',
                          '73970','16138','55256','35253','76086',
                          '54323','46251','99920','85595','62368',
                          '18037','29474','46164','68453','62999',
                          '81222','72234','39703','12838','21227',
                          '87730','70265','62142','59300','73671',
                          '91725','24544','32486','54647','25956',
                          '96368','84629','49137','96513','39091',
                          '31541','24977','51290','67001','24842',
                          '16399','70224','72376','93017','10491',
                          '39411','30476','40395','39562','12353',
                          '60937','77907','85502','32974','78036',
                          '73004','49271','80890','55139','88745',
                          '46015','35967','93543','70128','87584',
                          '63235','75025','13432','96017','93788',
                          '69225','42581','97893','99430','42716',
                          '83886','74402','28505','77896','73149',
                          '35543','33776','22528','93665','92587',
                          '20309','50103','44323','95826','53487',
                          '60628','52899','53394','52542','85256',
                          '16787','97579','59020','90505','82899',
                          '50506','18393','24284','24468','96525',
                          '50654','37181','61354','29393','35259',
                          '60133','28872','95913','10765','88523',
                          '34906','63665','64876','61260','35512',
                          '88827','78910','76311','78014','73911',
                          '27815','88970','13982','74687','14957',
                          '84844','91399','66228','62898','50991',
                          '19396','91342','20137','84093','61110',
                          '23693','64435','77376','52203','76775',
                          '42053','36990','57757','29786','70923',
                          '84217','34311','87334','68627','30309',
                          '71810','29125','74123','85931','98281',
                          '48218','59086','23392','47023','72784',
                          '36498','85743','71584','88592','51942',
                          '63769','18288','87608','89186','14455',
                          '23098','26486','62436','29192','62366',
                          '98246','14402','63928','66426','35856',
                          '42459','60160','15782','51877','13824',
                          '12551','78711','67198','39723','91993',
                          '33154','28886','12217','80417','63673',
                          '95688','48565','63480','26931','66833',
                          '59428','36847','61365','87284','63722',
                          '51293','61595','77255','49439','13585',
                          '45418','69197','30023','83249','51317',
                          '63924','58461','33090','62357','76895',
                          '72628','71345','65899','80676','13651',
                          '71226','60025','67373','58515','71677',
                          '56986','23937','30906','49001','21584',
                          '58145','43892','78362','98812','30267',
                          '98235','51276','76909','27248','12021',
                          '27084','88883','66362','56352','12575',
                          '31446','50530','47998','86296','60207',
                          '98818','83315','71025','68616','92635',
                          '76595','48901','39883','61263','75220',
                          '47658','82724','58400','42880','31808',
                          '33777','32360','74782','91883','34960',
                          '65420','84947','24551','50494','76092',
                          '41841','89058','33082','51212','37183',
                          '23011','61351','13367','15183','16844',
                          '41371','24078','10695','78309','12724',
                          '49250','71956','96236','50657','60126',
                          '98550','22198','18598','85227','28581',
                          '70490','73002','97355','55428','86652',
                          '29184','11235','28845','83118')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


