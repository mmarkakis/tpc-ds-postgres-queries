
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '90373','86284','32460','84892','51476','38322',
                          '74521','49199','13197','11232','94856',
                          '58829','78325','40426','82465','90259',
                          '86130','80754','31550','28111','58549',
                          '58907','30861','36719','32368','91827',
                          '76827','69359','77438','89059','74316',
                          '90710','41187','76971','63499','36396',
                          '39405','26971','31426','94698','92397',
                          '46718','42531','65608','14275','22224',
                          '22766','45768','23685','33169','56796',
                          '59439','52070','99445','60378','67298',
                          '92581','74421','36228','99992','18834',
                          '34173','71185','38691','85238','27580',
                          '56993','52635','32315','74032','16525',
                          '18236','91127','26398','29561','43369',
                          '97336','60644','93691','15912','90444',
                          '42175','51759','10424','62977','63380',
                          '41067','42866','74216','12374','50903',
                          '98116','23693','34287','70506','75066',
                          '40695','23805','41626','60830','53826',
                          '90228','21471','36442','96149','90040',
                          '23021','96476','24480','72034','28013',
                          '86561','54654','82985','88068','85848',
                          '89983','67024','30500','53102','39009',
                          '73383','46165','53511','78109','29439',
                          '11207','27857','18682','14605','52434',
                          '41597','41787','61151','82613','11612',
                          '87669','87578','35946','90311','32939',
                          '15460','51059','18027','73969','29568',
                          '97329','86305','55054','24154','90135',
                          '67102','41521','51721','85299','39253',
                          '24103','89730','82730','25292','63496',
                          '92854','33774','25177','91642','30252',
                          '91455','98684','12284','90339','98117',
                          '15214','99054','17596','33217','28510',
                          '63458','79142','76102','40306','84848',
                          '69326','13336','43913','23765','75878',
                          '38541','54938','25787','91641','60350',
                          '83142','19617','70856','61849','44894',
                          '35127','43323','83183','97440','11134',
                          '58894','41441','86817','77366','24759',
                          '41763','15816','98101','26941','21032',
                          '20891','75494','45020','35770','33386',
                          '47857','83852','51683','40808','30321',
                          '46982','38121','39297','26429','77170',
                          '81371','67776','21143','48025','43603',
                          '92450','63754','54146','54506','83766',
                          '88178','46329','15268','29340','59931',
                          '72777','33782','48219','81690','81717',
                          '63961','27880','80835','61610','63877',
                          '85422','46654','26825','22396','90425',
                          '84441','52917','81053','95677','88744',
                          '18789','61686','84982','17125','85726',
                          '33748','78655','52589','85417','61250',
                          '13441','67462','75647','30918','37543',
                          '68971','99751','75118','16070','75300',
                          '71537','74763','38873','28288','36621',
                          '61340','73678','98125','80589','98260',
                          '31735','20174','74299','13680','99961',
                          '18338','39872','20444','38255','36981',
                          '70504','33923','81896','24102','37830',
                          '40136','92789','49722','12917','78731',
                          '19902','60434','67837','81964','79711',
                          '42044','31789','67665','46478','35664',
                          '92258','77098','92836','25558','89213',
                          '47488','47162','26448','63870','50910',
                          '26223','12746','93157','22901','15822',
                          '51899','81658','87956','19175','12839',
                          '52450','29137','93775','84587','87655',
                          '33675','66936','89257','64524','62688',
                          '77347','44339','71868','27761','55405',
                          '78687','69497','32051','77204','42292',
                          '40005','51918','64488','50170','47590',
                          '20870','56931','86137','60747','83119',
                          '46928','91512','27299','32600','89153',
                          '80925','35114','21899','66529','11108',
                          '29855','26701','81330','50383','56715',
                          '65580','43530','64130','95162','22724',
                          '18979','34027','49411','92250','41146',
                          '89322','30387','90727','24844')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


