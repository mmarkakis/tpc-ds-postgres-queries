
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '60587','75203','74515','78809','89319','61851',
                          '94083','11739','56103','36666','86278',
                          '54630','45548','57444','59854','80264',
                          '44347','69837','26221','73051','18040',
                          '82070','87226','12074','80118','63270',
                          '86474','97594','35914','28670','19396',
                          '79438','85280','17080','76868','64510',
                          '11446','43270','10099','13699','30167',
                          '36681','73328','41679','98966','18305',
                          '44679','41825','14420','68891','46539',
                          '99805','47146','69269','82415','36607',
                          '85987','49421','62019','18880','10376',
                          '91097','22718','76143','28819','39410',
                          '52696','31092','84288','55989','24498',
                          '87415','75051','99439','81306','74304',
                          '63991','31819','63532','77241','46634',
                          '39551','65632','33959','98257','91088',
                          '80537','71385','77771','19513','86113',
                          '73249','47229','40027','22994','92935',
                          '29977','14860','28296','66510','63566',
                          '47075','73354','21266','82819','86471',
                          '37908','35880','99332','88730','50436',
                          '90384','77747','49319','58507','62099',
                          '66344','36672','93030','95571','37649',
                          '44999','26676','61416','11263','95674',
                          '86076','89309','13022','79529','31142',
                          '35140','81380','29351','52800','40301',
                          '76436','90920','40757','24682','51622',
                          '40957','41799','99074','14219','85211',
                          '13545','62420','20887','19790','59802',
                          '58380','26424','80261','75250','75884',
                          '87949','24373','84564','32670','90386',
                          '87176','29576','20838','74880','54532',
                          '88580','81957','96065','41292','10248',
                          '13567','94878','33550','33364','27812',
                          '64603','88030','94007','16069','15687',
                          '65756','28361','82647','70499','68762',
                          '84902','33610','36158','88232','50084',
                          '32068','72154','93931','38519','94533',
                          '71960','37079','46260','59866','94486',
                          '75581','79237','20313','60044','84597',
                          '22922','71144','65475','72640','79471',
                          '29992','48637','12542','77606','14025',
                          '99196','15272','97393','28864','36873',
                          '86054','27381','94489','43818','41552',
                          '93923','56082','23376','11244','37921',
                          '82206','61698','98155','32858','26899',
                          '29454','91915','30111','51823','70668',
                          '52043','21937','20405','38656','14495',
                          '90063','64870','93073','50122','28047',
                          '95778','44013','40672','73115','85658',
                          '66656','28263','56746','48659','21275',
                          '62174','56293','46424','40029','12852',
                          '56885','14691','58982','12268','32510',
                          '38520','59418','62100','52176','71778',
                          '60938','14362','51167','74461','90391',
                          '76261','59710','49097','32023','26672',
                          '44578','60401','97210','21551','59150',
                          '11463','58684','13163','98512','54154',
                          '43954','59909','42152','25103','39649',
                          '97536','34050','59233','81898','82721',
                          '85780','94356','10063','83646','81291',
                          '12668','54386','42359','53473','20508',
                          '79208','97558','65168','57135','10338',
                          '17906','32161','36570','93784','53195',
                          '27662','74951','56179','34100','16009',
                          '33583','81826','91903','90464','97335',
                          '54998','90822','34874','46257','41289',
                          '84368','38538','24746','84953','78562',
                          '70304','42044','39332','30632','38296',
                          '76370','10959','33280','22113','56638',
                          '87310','56143','49179','37689','45676',
                          '36115','12651','87345','13905','14231',
                          '72947','87878','99837','82640','16943',
                          '67932','65625','80480','70415','38665',
                          '25577','46858','27658','49268','44274',
                          '87102','77522','20237','65640','70086',
                          '34585','21380','82875','23897','15080',
                          '74518','50731','80249','60132','61202',
                          '17775','79247','22466','11726')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


