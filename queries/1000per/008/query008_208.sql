
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '58008','39548','79115','37980','36993','21082',
                          '40409','57937','78353','17829','67943',
                          '55209','24728','28933','14917','42577',
                          '54434','16716','85990','73318','35853',
                          '61290','11321','57237','58415','70848',
                          '42345','77115','60780','92632','46166',
                          '71947','48620','85772','82549','16685',
                          '54079','33265','61854','87658','35732',
                          '21828','29973','38423','80352','46220',
                          '68167','73333','60750','43772','26257',
                          '36870','79630','41708','35620','59052',
                          '16569','35283','24705','55970','68883',
                          '73061','31241','41061','19501','48981',
                          '26446','32633','18665','37735','39973',
                          '39270','50401','97192','83623','14519',
                          '87188','91115','74707','38451','97682',
                          '68294','59969','33507','37012','45644',
                          '22831','77127','35297','37135','16421',
                          '45812','46559','52914','44303','30914',
                          '39927','62416','12588','86406','22761',
                          '70658','34466','12750','36980','15068',
                          '71877','44761','45498','22664','37650',
                          '67531','34530','34539','28457','51155',
                          '79717','22629','47336','56426','82800',
                          '85778','95066','50327','29305','69382',
                          '81965','88466','32818','24386','14647',
                          '32946','14496','37717','30050','73925',
                          '20371','13300','65220','59615','29754',
                          '71422','27038','91174','52667','87292',
                          '81081','60936','30980','41175','37972',
                          '42005','18960','80644','41517','58275',
                          '19791','19966','30828','76058','18182',
                          '83585','57541','81015','83912','15913',
                          '20701','32806','54972','41534','89441',
                          '56974','13903','34174','72002','60236',
                          '55311','61717','59190','83985','29084',
                          '83877','84177','94188','11982','93691',
                          '55378','94079','97091','49246','16471',
                          '60813','53950','96416','90642','37355',
                          '37553','59055','53107','94939','43386',
                          '76646','61989','79588','66083','94038',
                          '31070','17179','59772','15242','23066',
                          '67807','72399','31749','88948','52821',
                          '46818','81861','71551','54123','74544',
                          '46782','87141','89494','17726','49759',
                          '43641','80973','74047','77075','62407',
                          '96761','97242','84289','29602','90127',
                          '78775','28928','18723','87758','37001',
                          '36389','33919','62495','31607','57000',
                          '13233','35029','49349','17528','87941',
                          '77265','16077','15381','49223','69308',
                          '18114','57132','32970','52593','81681',
                          '51797','45072','42939','21750','80452',
                          '41999','38489','70584','76544','27371',
                          '31587','55021','46237','46179','36415',
                          '69449','82978','97713','97755','32449',
                          '34321','35456','14781','56332','25939',
                          '77331','58021','13976','99342','52423',
                          '95918','78609','60137','58962','86424',
                          '87269','40588','58485','94991','53642',
                          '63628','98166','13187','14569','40575',
                          '82847','56500','24967','50695','80460',
                          '18006','77179','75244','49253','62109',
                          '63411','73547','19665','31356','96914',
                          '39175','95457','49751','29803','30681',
                          '17800','63838','98448','44643','97130',
                          '23685','13656','16017','96926','77094',
                          '11906','82178','75808','73344','15903',
                          '25382','36969','13362','37744','12513',
                          '87234','15671','64101','78751','45660',
                          '87325','23230','44029','22367','23581',
                          '87604','49051','78678','62648','42912',
                          '60219','89020','16055','43165','51017',
                          '93586','57883','91573','44499','67041',
                          '90349','92255','88486','46897','62849',
                          '85638','46759','33238','64500','74616',
                          '54118','31900','53394','90565','45538',
                          '39568','62140','21097','79777','76337',
                          '17199','44307','68054','47948','91380',
                          '90473','36000','35232','47469')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


