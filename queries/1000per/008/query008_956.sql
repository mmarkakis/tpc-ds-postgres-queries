
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '44189','41127','96714','46018','58451','40709',
                          '84917','12222','28053','73718','87680',
                          '44323','75169','19974','25516','70635',
                          '69323','53267','80746','71525','30692',
                          '23260','56996','14760','40565','51842',
                          '35799','63565','70852','29478','97962',
                          '58663','53262','62833','25898','41040',
                          '42807','47268','39364','51247','69430',
                          '97127','25790','56985','38152','17952',
                          '88718','39152','89281','51368','10566',
                          '95917','74044','54142','85371','53602',
                          '76835','39167','29105','27857','40903',
                          '32737','67544','87734','10379','92925',
                          '30252','60382','78074','38701','62923',
                          '91770','35739','27307','31109','89014',
                          '92843','95607','48887','15059','25895',
                          '63915','20847','97207','77898','16931',
                          '28494','51122','46264','79529','31881',
                          '48032','92630','44098','49563','43610',
                          '75212','56766','65952','79158','24184',
                          '41072','72308','52461','95787','89778',
                          '39063','91642','26447','16939','37310',
                          '93207','96195','90468','84967','55837',
                          '47712','27915','46838','19677','19822',
                          '50120','54887','41425','16114','41014',
                          '63961','38525','24218','80467','55563',
                          '24769','76372','16149','56993','60678',
                          '85220','78166','45069','44763','43254',
                          '20321','76407','99884','75819','22087',
                          '13363','99597','19957','44397','36634',
                          '75747','93135','64630','52320','88856',
                          '44068','33673','47115','98048','61053',
                          '97186','75221','94644','33577','29115',
                          '18422','29394','73753','91682','87198',
                          '47913','67080','45583','13156','31529',
                          '29369','50019','95591','64907','40829',
                          '42099','44653','35881','50674','78767',
                          '37195','69857','76453','79878','40875',
                          '54850','84929','15123','63590','27925',
                          '30118','12080','66221','36148','82245',
                          '82368','85821','91407','81976','80395',
                          '73479','96903','52884','51157','14011',
                          '33496','15631','94254','87534','89356',
                          '35316','42521','12958','47137','80204',
                          '72158','78224','63775','78560','65199',
                          '78667','72735','13293','98674','79455',
                          '94370','20857','47710','58395','45669',
                          '91696','51109','17693','13025','33751',
                          '62591','16521','67579','78217','69083',
                          '12730','29041','19518','31616','92601',
                          '91875','47348','77406','34053','41216',
                          '16646','82512','80643','38513','34183',
                          '88412','51758','60574','32214','24672',
                          '41898','49123','39459','82503','64798',
                          '62538','33122','58759','19213','72619',
                          '86346','29620','53876','57243','35608',
                          '84474','40164','43992','60777','53251',
                          '76670','17865','45312','98806','19376',
                          '71111','36825','73028','26642','37946',
                          '31462','21741','37904','36036','14043',
                          '76395','14412','19765','20159','94015',
                          '23760','74754','57584','67249','96140',
                          '59066','52135','81991','87027','45982',
                          '13076','67996','32760','17478','26258',
                          '12922','71603','67605','43090','99606',
                          '16589','62090','80247','46271','85002',
                          '37168','57849','30204','73444','52105',
                          '12243','27526','25180','76964','34483',
                          '78715','14749','95052','67248','11534',
                          '33592','11879','21054','62225','44879',
                          '11197','41885','61965','78606','31678',
                          '83216','43839','57135','21722','92103',
                          '30507','73355','98544','55954','87213',
                          '41571','75922','75064','85032','66691',
                          '49306','63654','38422','25746','26732',
                          '23269','90454','57569','20826','55308',
                          '37368','27142','47114','41747','14776',
                          '52806','92617','79914','59275','20455',
                          '79448','72283','23651','78643','57527',
                          '51701','14253','61699','63462')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


