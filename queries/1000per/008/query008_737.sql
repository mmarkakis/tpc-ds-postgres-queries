
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '44078','16075','98851','90423','74296','71586',
                          '66633','33938','71729','42698','50430',
                          '44794','25569','92775','86193','54491',
                          '98878','62130','65665','32667','45098',
                          '89448','62348','20661','45552','22035',
                          '25776','78328','28980','14005','28438',
                          '38159','84897','12157','62518','76667',
                          '83370','37907','10740','20232','19388',
                          '41522','25707','41325','49705','82096',
                          '22903','75561','14370','27160','15165',
                          '53913','80563','75046','62465','12438',
                          '49694','48516','15447','62626','71799',
                          '62512','35820','13945','40201','81550',
                          '16408','32714','28920','64603','73330',
                          '58285','59645','86886','86962','44618',
                          '85771','64705','82701','74682','58750',
                          '25915','53561','56530','77975','46496',
                          '40037','60930','53501','84054','58364',
                          '82572','53616','16463','91880','80537',
                          '10271','92180','23998','21033','48757',
                          '74698','47909','59802','63405','50619',
                          '97048','39464','93303','17641','65615',
                          '48774','65977','23723','83869','34238',
                          '40191','41847','53604','11993','64454',
                          '54587','64051','16291','27786','18958',
                          '44464','10870','64339','35823','48299',
                          '56523','30935','63570','27529','18440',
                          '39068','97160','45716','51398','72800',
                          '42968','86256','69636','53573','51057',
                          '16305','65792','44092','79874','90485',
                          '16799','42374','85554','92842','22956',
                          '40013','65971','47873','55655','73268',
                          '28994','82663','64903','25222','31538',
                          '38444','77744','14023','49577','44925',
                          '55802','52824','92044','48726','82217',
                          '37759','39054','56233','98982','85606',
                          '84813','98288','23190','71826','27893',
                          '69174','30088','72634','91618','43204',
                          '96022','21628','35190','78827','91193',
                          '29387','59818','42201','69657','17704',
                          '90644','58385','92657','85333','60657',
                          '15801','68060','11207','70638','59295',
                          '61370','16248','74348','21784','11675',
                          '27347','14221','72520','34788','69649',
                          '13294','73025','19914','56839','51910',
                          '19098','42346','83589','77641','38772',
                          '22411','93332','22785','62729','79738',
                          '64204','72017','24796','24879','32506',
                          '19258','74217','91509','42126','78525',
                          '83918','97445','16613','54721','74795',
                          '48380','58640','68278','92052','86345',
                          '84360','67175','67176','76890','17046',
                          '57481','80583','17356','50067','47545',
                          '64834','46621','32938','45892','24248',
                          '70293','39991','50575','95124','43205',
                          '94799','46331','23524','57315','97119',
                          '65974','80902','19108','43636','70495',
                          '37219','39819','68082','26454','90668',
                          '52604','68589','54802','79766','35590',
                          '59072','33250','98019','99481','70141',
                          '99725','89513','43989','77705','10265',
                          '83130','53615','14716','76881','41248',
                          '69262','63787','33533','20513','70942',
                          '82251','17149','83664','71370','45277',
                          '72683','68162','73656','33180','51149',
                          '38785','80464','51544','21004','10956',
                          '81705','42876','29383','47040','37767',
                          '36609','57356','67489','21375','17247',
                          '79022','46622','63772','93920','46269',
                          '22989','68019','53471','13353','27963',
                          '69547','20195','72899','13357','35508',
                          '21159','56194','40304','89358','40125',
                          '12700','74005','42907','68432','28042',
                          '48764','82210','32619','20355','18981',
                          '17022','42110','83314','76572','32129',
                          '35373','82036','57567','20785','19081',
                          '31559','49086','19165','28600','61967',
                          '92722','33816','88767','29394','16367',
                          '32181','49997','18438','99986','76176',
                          '26102','99068','94587','86988')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


