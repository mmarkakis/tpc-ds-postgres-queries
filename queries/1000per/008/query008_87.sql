
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '64907','39091','38480','81237','89019','68065',
                          '13396','27849','14521','76221','39469',
                          '61186','82509','45564','11571','80571',
                          '43243','69225','62187','91084','65003',
                          '75691','49866','66018','25493','32573',
                          '65074','18011','64174','20390','20721',
                          '64596','54593','84060','61895','91617',
                          '42759','75172','35536','35506','43580',
                          '59870','72182','81034','89260','69246',
                          '46691','26067','86250','95566','54499',
                          '71086','95850','53002','51594','36392',
                          '22971','13419','86407','79946','18586',
                          '18072','14680','91321','37442','65127',
                          '26818','76398','70683','61939','76700',
                          '59246','67717','89892','24295','64433',
                          '74679','83777','20484','49763','40146',
                          '70248','28619','30100','40758','47977',
                          '74909','95199','27992','50547','64674',
                          '11578','35504','24587','87053','27971',
                          '21103','66077','94673','48266','69433',
                          '51043','31583','28433','64808','37908',
                          '72564','81550','42263','34589','90089',
                          '60577','70814','62743','70624','54721',
                          '96275','50616','79571','33866','12125',
                          '80466','24207','49053','10187','65290',
                          '70038','12679','60015','85766','64171',
                          '31373','19437','92372','69781','58751',
                          '18435','26469','54442','16009','36257',
                          '75376','81146','58710','55972','51031',
                          '13265','29940','31252','91786','40412',
                          '50092','47694','99719','20253','70618',
                          '75912','35692','53005','94593','18646',
                          '39451','91327','31690','22361','71367',
                          '56885','75005','24027','59493','11959',
                          '39684','88719','24810','90426','27822',
                          '66113','57154','21434','25424','86170',
                          '80879','74888','38679','66193','91028',
                          '82020','27371','70590','81692','47883',
                          '13584','65099','62615','38909','94506',
                          '28160','38886','69111','86659','22088',
                          '83437','54020','17406','64272','15346',
                          '78789','33810','63071','40837','69914',
                          '75096','71226','47066','26442','19966',
                          '53697','40089','19035','67326','83163',
                          '84550','24310','45873','18931','71786',
                          '35853','84905','19464','30202','60737',
                          '86956','42688','77758','30936','21300',
                          '56371','28595','44733','98174','90748',
                          '73759','52309','46565','99095','98093',
                          '29971','86989','60248','94959','53332',
                          '48906','88289','24877','63477','88263',
                          '36492','36716','55419','81069','29734',
                          '80368','35272','48282','57751','30796',
                          '48726','32862','34608','27434','17348',
                          '79383','19818','26536','38579','96453',
                          '28564','24502','72135','39072','10035',
                          '37756','74917','77772','15871','82404',
                          '43268','60743','15360','84611','68855',
                          '23450','32555','11965','39183','35495',
                          '43796','62109','82087','37188','85479',
                          '53591','18541','26565','19752','96684',
                          '14312','79387','71275','92627','36423',
                          '38898','24835','91835','59012','63579',
                          '59404','69130','99155','63700','99296',
                          '70098','14027','55537','43719','43561',
                          '42228','40182','44719','55905','33161',
                          '45754','51013','91723','35589','49786',
                          '80452','59660','44582','53936','70202',
                          '28993','39260','88441','84160','88523',
                          '16186','26529','10445','51406','88550',
                          '54867','26278','37330','76685','75965',
                          '11941','24861','85754','38608','68607',
                          '95243','40816','65885','89908','61842',
                          '63103','65243','51817','66747','82449',
                          '86404','87037','22134','18488','26948',
                          '30185','68213','16952','53730','27775',
                          '47791','44042','50997','90477','74008',
                          '22521','89904','60682','34132','91223',
                          '36145','51305','78772','98623','74138',
                          '72347','69422','18545','78701')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


