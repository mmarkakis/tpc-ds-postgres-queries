
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '81076','43487','37245','13873','90578','35067',
                          '80084','78754','13976','67779','53352',
                          '59497','10503','81011','83277','65287',
                          '11940','35059','74598','19125','19410',
                          '15358','14773','72225','70891','74125',
                          '72699','82427','68561','55125','20092',
                          '98219','48641','46055','91560','20713',
                          '75340','92973','71412','62620','30911',
                          '15692','52047','81654','91280','35021',
                          '74244','23383','40361','87118','85357',
                          '28423','33274','98322','89416','87833',
                          '89110','50664','30800','94879','68142',
                          '26454','66228','88264','82190','94263',
                          '75136','61495','26860','28118','80251',
                          '25608','68973','60074','44268','21025',
                          '44526','36666','78616','12051','59476',
                          '55207','93007','16570','62844','56859',
                          '84414','29215','17376','34040','43017',
                          '11970','88425','27219','22378','92348',
                          '21002','15734','68610','12747','20865',
                          '86477','36858','70067','28576','75659',
                          '88144','86988','27173','30158','54571',
                          '57899','91055','42558','64502','30620',
                          '38981','60572','70314','12021','47075',
                          '81185','21538','21865','72916','40278',
                          '49972','72109','13542','63420','77176',
                          '76298','79713','48126','74014','62072',
                          '67090','49727','12840','62975','79327',
                          '53258','36015','67237','81906','93520',
                          '21419','19880','92337','66894','89458',
                          '56521','61420','72774','82564','56764',
                          '39139','92708','97764','44418','41812',
                          '24791','73905','21459','54822','60880',
                          '57429','81404','30178','96133','88748',
                          '26030','90476','16153','77471','53440',
                          '86244','62706','97100','80295','40229',
                          '41183','73286','10966','33117','53362',
                          '29665','21312','58361','53728','86464',
                          '62953','81675','84127','56524','65015',
                          '34805','72389','20644','71229','41390',
                          '98911','11193','68728','97433','11724',
                          '43852','78152','93568','10123','11065',
                          '23180','27461','69030','96688','41236',
                          '15880','88176','37558','40489','49668',
                          '31386','20778','38884','26145','36035',
                          '34344','62243','22426','41045','76717',
                          '45231','47216','78237','67437','59148',
                          '32773','63804','60462','46028','59922',
                          '34715','13416','52863','54221','13709',
                          '58267','81453','25042','34201','33249',
                          '62439','89822','66773','63019','43464',
                          '33258','29113','98501','65071','15203',
                          '14933','86534','57471','13196','19346',
                          '75025','81602','57910','41765','92025',
                          '25555','69315','43879','35305','61115',
                          '76655','60026','22565','67304','27916',
                          '83273','74299','78729','47458','78926',
                          '30623','51248','32164','90557','17181',
                          '55785','12147','24451','60460','80867',
                          '64284','90923','55018','46357','43751',
                          '23172','40247','32150','17586','35040',
                          '79950','23325','23551','59619','14727',
                          '64845','89106','92561','10212','12475',
                          '42463','91314','95231','87245','90134',
                          '59502','62339','19482','60363','25672',
                          '19893','88878','26065','66185','87415',
                          '66575','83307','46898','53092','14922',
                          '36171','10589','31217','93212','69718',
                          '19977','53333','48598','50508','11312',
                          '16090','92213','48750','90671','12036',
                          '38927','13910','80895','74197','66338',
                          '27835','15668','58965','69189','49839',
                          '43291','55750','58445','65760','85827',
                          '19520','83299','33738','73115','10704',
                          '55647','60948','70547','39174','47052',
                          '39978','12632','50796','81294','36346',
                          '65207','42351','95096','81280','91964',
                          '78595','62494','69702','58425','57985',
                          '61251','59039','23761','47196','76223',
                          '28463','25291','69468','15102')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


