
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '41881','20395','81519','87646','52901','10427',
                          '65832','47644','34525','31420','82342',
                          '13055','84309','18577','39645','57444',
                          '58557','55337','35025','63449','82357',
                          '26797','97602','76144','30614','13161',
                          '11453','27322','14382','69739','21735',
                          '39826','76417','49386','11029','74536',
                          '23864','40212','96961','55502','25997',
                          '97416','81916','87842','98355','69118',
                          '14025','55136','84086','50025','82526',
                          '18614','31412','23752','23252','32559',
                          '29127','40683','48626','67812','42770',
                          '38770','35589','90258','80353','45191',
                          '22279','98993','24450','27240','91725',
                          '76630','74054','84160','78796','64381',
                          '41869','47961','38340','79721','64427',
                          '67259','89645','72351','29252','89521',
                          '86449','88309','44629','24857','17628',
                          '34202','81332','46806','78940','51077',
                          '78694','26842','93444','50536','18023',
                          '70380','70894','38859','50634','57812',
                          '79283','39270','49220','54510','78263',
                          '83604','11139','99534','97260','94109',
                          '81466','92877','66940','43613','56689',
                          '14951','56451','81600','67321','81438',
                          '30251','54263','30644','93216','10565',
                          '81182','68791','35665','51744','72407',
                          '67623','74725','84762','22589','51709',
                          '68895','36121','12767','26937','35183',
                          '51949','58648','92103','25617','22481',
                          '37282','33799','45088','23089','21720',
                          '17552','40623','69745','54537','87232',
                          '84852','18745','44272','23902','17110',
                          '58224','44785','62330','64722','86381',
                          '49184','90047','60173','18195','33316',
                          '43436','31473','19282','80876','18914',
                          '68391','75212','62267','41759','59406',
                          '20827','79437','91248','48225','48716',
                          '26255','91250','35990','63560','50283',
                          '65380','86300','15789','77638','21156',
                          '54514','15159','13471','94430','14073',
                          '88693','35975','15034','13326','34771',
                          '66790','62435','52083','14144','17590',
                          '76839','89622','72942','38893','58101',
                          '14744','45703','85682','83263','88968',
                          '52627','47520','63332','62805','10127',
                          '20443','36170','59636','13000','49283',
                          '47108','42093','77582','47525','55620',
                          '13798','68951','80308','42000','15271',
                          '31129','15016','45092','76504','79589',
                          '35188','65587','14094','71481','75303',
                          '64010','10382','64434','66608','24269',
                          '85369','91700','60909','87453','20573',
                          '78562','44674','70329','12971','65725',
                          '76840','71325','29499','94069','42035',
                          '74285','49164','61335','25832','34628',
                          '91573','68096','80664','95318','52913',
                          '27911','68057','26713','46480','95588',
                          '52234','14746','62742','36189','37070',
                          '70746','65656','10759','37011','54311',
                          '36745','89051','78640','51858','12545',
                          '85975','40139','16589','48466','29632',
                          '68259','82777','62349','33686','11190',
                          '76669','63633','10923','97315','59403',
                          '29043','59436','69771','96994','56936',
                          '71409','70807','97801','51209','47899',
                          '38646','27968','76992','59349','11846',
                          '26584','96919','43943','46541','10398',
                          '32076','65183','58267','54587','49757',
                          '62781','55614','25392','68757','98316',
                          '60397','93326','34174','18977','43003',
                          '36609','60177','98107','16997','70234',
                          '10652','90023','82891','75780','10046',
                          '23242','40872','54851','45490','87105',
                          '48761','89551','74784','96006','16229',
                          '68036','25840','27073','55585','82788',
                          '40325','76948','10746','56381','89187',
                          '35401','46330','34750','78114','37085',
                          '86623','70970','18663','14466','69846',
                          '85548','25331','85112','81911')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


