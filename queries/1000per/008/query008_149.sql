
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '99799','15101','52487','19535','63646','82555',
                          '78730','72667','20709','31656','43030',
                          '36357','24233','24470','10546','45289',
                          '57560','11785','98663','95780','22679',
                          '77883','87029','24515','80660','39998',
                          '95429','46715','85441','23289','77402',
                          '64974','74668','42800','71470','37448',
                          '74275','91770','38448','62634','72583',
                          '49456','57994','49144','44941','97488',
                          '82320','19767','30501','49225','61901',
                          '86781','89756','98561','80435','85169',
                          '20194','96288','91195','47401','11456',
                          '49249','94043','30782','75164','49596',
                          '61404','32640','70567','87942','26496',
                          '82112','79973','24329','56789','33630',
                          '83044','76936','79066','39272','69839',
                          '72618','30139','72740','58643','57494',
                          '70842','92959','38778','71003','62801',
                          '11271','62636','49682','81074','45064',
                          '56489','50565','34101','90094','91615',
                          '97930','90791','20580','67963','20688',
                          '82661','92200','75877','16091','47248',
                          '27743','97954','11929','53392','41329',
                          '57631','73893','39136','25354','53337',
                          '98900','50566','89265','58323','42436',
                          '15865','77671','35359','89507','48860',
                          '21570','62686','73221','70691','10439',
                          '26662','88767','61323','99761','37247',
                          '86247','62757','70059','75892','96962',
                          '37423','67818','83974','30229','13261',
                          '16574','76656','96162','16785','43650',
                          '85132','97236','46698','94196','15197',
                          '55731','50721','50533','99709','39599',
                          '96774','98169','93019','72719','11599',
                          '37212','68148','87585','59479','42080',
                          '83312','82487','67629','16677','58084',
                          '38747','61134','43744','82986','63944',
                          '37060','15687','91012','66698','98017',
                          '21085','83673','63603','67986','43411',
                          '50842','55278','39098','41098','42667',
                          '56986','70074','78618','79348','21645',
                          '78368','65515','97444','29655','98073',
                          '86659','28469','85421','40208','91443',
                          '28549','48448','29165','68587','88792',
                          '15872','88123','56217','88046','62115',
                          '62652','91095','20878','27466','37523',
                          '83880','56065','74135','43795','96427',
                          '27097','82664','55804','13866','59715',
                          '42190','40148','41972','29119','62746',
                          '39341','87010','13027','17859','15156',
                          '53519','18447','17365','67409','83175',
                          '99860','27020','16844','58220','21623',
                          '76868','97559','10018','34201','73848',
                          '55245','84708','79261','34494','30365',
                          '80296','78247','49721','18236','68404',
                          '75006','36387','36494','51353','66446',
                          '56445','64717','96707','22730','27223',
                          '65733','25099','85623','59513','54307',
                          '93970','69260','33902','17584','29443',
                          '29210','44213','43335','82011','29973',
                          '40129','87269','51086','24805','92299',
                          '82697','12131','40687','77244','38314',
                          '12077','84933','15856','67702','98533',
                          '45282','73273','61155','68755','72073',
                          '71766','95813','17605','38429','21251',
                          '13631','91392','23705','76843','28501',
                          '80538','37522','60808','31908','95733',
                          '15584','84054','63081','67530','75680',
                          '81863','72763','58969','83023','94970',
                          '29880','73375','40625','57118','44527',
                          '45373','78024','58049','91055','51440',
                          '91512','63424','63645','91602','76999',
                          '53578','81262','16566','20296','14222',
                          '63199','26047','15601','65582','86124',
                          '90498','95512','92245','36960','40874',
                          '63045','60504','26067','46792','51955',
                          '48873','54431','54926','55462','19871',
                          '50400','51342','64604','79711','77302',
                          '11230','48832','90397','86982','43118',
                          '13153','26696','94211','97813')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


