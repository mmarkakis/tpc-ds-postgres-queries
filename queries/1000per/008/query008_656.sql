
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '25929','35811','42694','85582','32991','88280',
                          '53938','30539','15920','83433','18147',
                          '55911','24857','12487','43850','36608',
                          '71025','29497','90295','58485','58351',
                          '83069','45985','43835','25047','71860',
                          '13647','59469','96077','82715','31962',
                          '44070','36439','57444','25938','97262',
                          '93385','96561','75909','66728','20175',
                          '80760','37356','35000','33131','53594',
                          '59836','23019','14518','12910','15452',
                          '11671','54544','11213','68779','67627',
                          '35974','38314','52317','18883','10858',
                          '89857','71166','93085','22202','70204',
                          '71114','33179','73503','43707','11379',
                          '24271','33778','97236','61742','48179',
                          '12290','97163','79696','70572','49592',
                          '99375','67426','12524','33697','79673',
                          '40975','75120','84572','99804','88725',
                          '86577','19998','74675','98244','89150',
                          '66356','72180','26349','59554','92976',
                          '42126','31047','61702','96997','43487',
                          '86666','41533','59414','69169','45084',
                          '32762','14482','30877','41584','40746',
                          '64436','92303','96454','52485','55431',
                          '25287','90547','67602','47168','27830',
                          '59199','56484','42539','68269','26448',
                          '82386','66053','54880','88204','37455',
                          '59252','14823','36495','33049','32137',
                          '34388','56482','65050','55552','89123',
                          '97955','29196','29054','61642','32632',
                          '53002','99325','81665','84318','22094',
                          '80443','23138','86250','94674','56335',
                          '28671','78188','62115','37021','30320',
                          '86773','36064','78592','72603','92787',
                          '83682','27433','27836','45788','73719',
                          '35501','16812','60377','49292','84772',
                          '40349','47583','36992','63638','11576',
                          '59992','24529','40188','75091','77859',
                          '18710','67858','69862','57822','40538',
                          '24823','13554','19909','43966','47037',
                          '34265','73029','46229','65600','34527',
                          '70706','40846','75368','40290','72753',
                          '63237','86520','50931','93535','81440',
                          '78153','38733','21285','11707','71786',
                          '96579','69730','87518','42120','73590',
                          '11063','80017','55746','66497','80990',
                          '56722','70941','96658','29841','73773',
                          '13324','36644','48767','42392','75899',
                          '16757','25480','27105','76791','57926',
                          '10518','96243','75371','11727','69581',
                          '10202','12352','62234','15141','49407',
                          '34515','78543','72133','71492','88646',
                          '61669','50781','28985','99963','91059',
                          '42397','45502','94047','37285','77389',
                          '37102','61007','32310','31814','35490',
                          '21499','92777','26041','77436','26530',
                          '48701','99114','32660','89410','96763',
                          '32235','82835','55652','33189','79548',
                          '85205','31279','55487','14193','90111',
                          '94306','30992','54423','10210','65128',
                          '56758','76249','40185','74221','81221',
                          '52423','58136','93978','90962','37644',
                          '37737','93007','17818','92461','46867',
                          '76131','36886','68613','10784','44888',
                          '15858','59224','66395','59267','13412',
                          '26647','48583','64122','48372','38975',
                          '64053','71291','78115','49522','39872',
                          '11810','24368','19207','35686','74362',
                          '90934','36806','25720','94058','70384',
                          '27089','53317','89003','71093','80583',
                          '51934','99033','12331','59995','91712',
                          '28426','40969','15606','17984','11446',
                          '99480','68658','32937','37953','45655',
                          '49924','74792','14602','24295','39569',
                          '64439','30776','16036','93844','37838',
                          '67274','80452','43460','42589','79231',
                          '43333','28246','89780','63693','68481',
                          '90893','99137','62022','89161','25096',
                          '16432','90245','78753','78817','68260',
                          '96818','44344','38528','84226')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


