
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '65236','44497','24449','61043','32157','84997',
                          '25640','52902','34901','66217','96820',
                          '26499','75876','61330','91754','99704',
                          '82875','93383','28657','96175','68154',
                          '55456','42809','24926','71469','72905',
                          '54951','61908','25598','83690','99639',
                          '54678','22201','84197','41431','11666',
                          '33164','89306','42545','78567','76559',
                          '61137','17058','48863','21179','26887',
                          '15058','58545','50311','70750','90755',
                          '71036','60955','58793','78182','81335',
                          '50412','45516','39005','70383','88924',
                          '25008','16963','59569','49389','17897',
                          '48854','49445','18913','81568','30042',
                          '71770','24047','81055','56418','93735',
                          '98570','62468','83593','95131','77504',
                          '97130','82202','88856','35136','76211',
                          '74487','49055','67933','37224','72202',
                          '31495','13749','35739','43801','70816',
                          '19811','32629','87036','99907','71455',
                          '72093','84349','56110','27790','62321',
                          '80073','79770','18895','91017','88009',
                          '46283','58675','96570','38010','78396',
                          '39399','97410','11942','42896','85557',
                          '57617','75614','91722','67771','43362',
                          '98946','27836','58579','78088','43080',
                          '26202','83470','98486','40017','70603',
                          '37720','35064','79111','31820','44080',
                          '79762','95057','95643','12359','46719',
                          '81416','84750','98556','51658','58361',
                          '29213','66858','77095','49032','28376',
                          '25784','99839','39075','11614','79795',
                          '69338','43219','58621','50236','96351',
                          '15836','61854','67253','40199','24812',
                          '33001','66909','23038','21889','28520',
                          '57507','21869','29301','87613','15956',
                          '33395','40600','93544','38688','45723',
                          '64732','12644','50489','18150','85074',
                          '65513','94800','24053','25674','42193',
                          '26934','10855','26821','75640','86086',
                          '19492','88298','90462','94104','34671',
                          '81983','86580','60285','82749','61745',
                          '21706','99090','91376','95668','21900',
                          '78919','32826','16601','66566','91827',
                          '63124','34313','84588','26450','50032',
                          '59237','36614','98995','51325','21265',
                          '63279','20734','37598','80396','80454',
                          '19034','93368','76252','79801','57105',
                          '80476','67408','30047','38735','56978',
                          '69282','81386','89340','36672','96421',
                          '85189','31164','61514','40977','27864',
                          '72719','94320','13583','77056','35140',
                          '48755','70096','71544','80390','47967',
                          '23134','15851','60103','86158','54801',
                          '85602','46736','75672','77659','17206',
                          '36322','67946','43021','15384','39120',
                          '47882','86523','74836','87497','75641',
                          '84027','69203','91426','82344','91458',
                          '34707','94722','39941','76940','68392',
                          '84698','74556','35298','81966','71367',
                          '76936','23662','93571','91339','82356',
                          '43686','75945','59214','26078','59620',
                          '48352','87744','94284','67617','57675',
                          '81467','63997','28409','85699','77103',
                          '88006','59254','23570','43141','81880',
                          '47540','95238','40629','21495','62940',
                          '87735','42345','74756','64643','67523',
                          '45035','96344','95047','27403','10587',
                          '82405','14760','56061','20359','33887',
                          '77540','66404','95406','54612','93105',
                          '85747','43539','84495','32588','46242',
                          '26468','95412','80572','18179','12219',
                          '68144','12951','67854','12680','29648',
                          '25894','12856','69410','67505','40246',
                          '56647','49236','60261','28784','80100',
                          '52911','71258','29351','24322','26269',
                          '26223','70217','68304','11021','71868',
                          '13280','10124','92234','53813','36485',
                          '77975','27816','71785','43725','60789',
                          '24848','77700','81987','47813')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


