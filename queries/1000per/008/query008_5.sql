
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '82912','16429','56372','94900','62843','98356',
                          '52140','91472','15284','30074','93060',
                          '87466','18023','12326','44629','72686',
                          '65854','17347','98884','94591','57710',
                          '74359','36064','15618','60047','83880',
                          '82758','48091','26772','32314','20650',
                          '23630','46805','13250','58970','87436',
                          '47667','37587','18693','59634','42981',
                          '84376','96058','21067','27798','14989',
                          '43259','24113','59807','61526','94954',
                          '78396','86864','76708','43124','17625',
                          '92671','46759','49146','66589','44376',
                          '79907','36181','96595','94595','30916',
                          '53727','73961','10742','36464','93749',
                          '74952','74791','59319','40362','88948',
                          '34103','44473','20557','39900','63196',
                          '23003','95474','84162','15186','16107',
                          '14725','24701','18388','89640','91829',
                          '83071','15027','61070','48078','10778',
                          '32885','55230','63841','68671','74466',
                          '33073','14604','66268','20819','96366',
                          '42451','27427','67755','61001','59395',
                          '25784','68106','36351','15724','31556',
                          '67270','83617','46640','30862','39269',
                          '44761','48968','77105','37871','20427',
                          '45744','65622','50828','91024','27516',
                          '40940','57469','24886','23441','84768',
                          '88601','15790','24862','38732','42379',
                          '15695','82454','79895','67554','10635',
                          '12145','40628','19386','29665','81476',
                          '60866','95975','30130','31535','37504',
                          '29499','25361','37631','54841','91571',
                          '25560','53494','81936','82095','21287',
                          '80936','51321','47181','24783','62263',
                          '20208','55880','46400','36050','59418',
                          '65971','61720','51511','76912','63529',
                          '94232','79488','62294','79472','21223',
                          '76802','34750','58792','78745','39187',
                          '20338','95230','63343','67667','63893',
                          '17279','15233','97222','90855','49321',
                          '25027','23130','40088','36066','59264',
                          '16862','55611','16079','15729','72696',
                          '77750','81369','19667','36334','99062',
                          '62644','30761','58447','20290','41781',
                          '39154','62125','31985','79985','41220',
                          '76500','24620','66099','21170','69063',
                          '75880','99776','10598','34081','35502',
                          '66895','35976','73763','87439','10843',
                          '39478','66252','33453','83542','12158',
                          '39735','11020','16094','64529','99318',
                          '27585','92693','60404','79506','82771',
                          '24642','53279','30009','44667','15445',
                          '79761','60182','27949','61864','17804',
                          '60952','72053','50534','57020','83098',
                          '71902','67843','36673','62298','45404',
                          '33046','85908','46923','50477','63165',
                          '84028','96235','12060','11599','83010',
                          '83255','97492','76842','33951','59429',
                          '89494','93219','15474','19054','32108',
                          '50555','37995','70185','19168','74455',
                          '46667','76431','94222','11697','38850',
                          '39162','53248','10579','74858','87860',
                          '48585','56050','25216','86584','54729',
                          '25416','88992','78126','64505','91520',
                          '10180','65006','74577','94312','53340',
                          '78341','84242','43333','37864','92080',
                          '68430','86211','94781','15901','27464',
                          '61649','84182','23261','28413','75217',
                          '44022','45930','70846','29107','91783',
                          '42754','84393','16174','32053','88758',
                          '40832','64059','22961','88379','66734',
                          '22304','18788','75385','37435','42427',
                          '10585','81738','18047','70152','48840',
                          '78295','84844','36923','45111','44709',
                          '57834','22783','18441','51641','56713',
                          '25706','13654','86335','58366','13245',
                          '56269','41052','75674','85272','82342',
                          '92694','42295','50147','44504','24644',
                          '32011','71053','30631','26418','46781',
                          '37768','10116','91468','95133')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


