
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '12113','17701','65154','14167','54781','29983',
                          '50464','90212','97047','68318','68009',
                          '22298','43504','62504','19332','33577',
                          '16181','35860','57147','82213','83178',
                          '69299','90535','79752','39750','89359',
                          '26119','99487','23989','45520','80317',
                          '88670','70172','38877','50539','97337',
                          '63559','88459','32931','85098','22982',
                          '96419','65071','30856','50935','27877',
                          '25669','53317','43917','22043','24199',
                          '37338','57973','35433','30336','86072',
                          '28119','18756','74492','16881','60516',
                          '12221','67943','85614','63045','58107',
                          '63752','75967','79649','19602','29703',
                          '82450','45489','13351','53609','23565',
                          '61813','98152','77746','58510','77504',
                          '11182','26478','77696','58970','91726',
                          '85745','71998','23447','52879','22831',
                          '89926','21041','65239','62884','95543',
                          '12844','47478','29547','84182','83526',
                          '95771','31807','72934','65137','16187',
                          '46769','61634','78592','53685','47445',
                          '50367','34129','95318','94735','30492',
                          '22862','83586','11250','78581','48939',
                          '64906','87459','47059','12146','87917',
                          '53863','93092','21586','54461','63171',
                          '68459','18554','53333','95358','27610',
                          '95275','64952','73309','26718','41340',
                          '45770','44321','35110','31845','27643',
                          '80067','63852','53753','86368','49701',
                          '11805','74159','34590','54040','32593',
                          '38077','49564','64601','40575','65797',
                          '73687','63736','38731','24593','49405',
                          '64176','43849','97828','58556','62615',
                          '13916','94543','80480','31042','25150',
                          '56661','96602','41430','92648','69024',
                          '44949','75128','70603','43152','10623',
                          '66302','55242','31489','32178','62049',
                          '79224','37851','16243','30444','19961',
                          '22381','38015','97400','26054','76117',
                          '24226','28199','72699','96063','47991',
                          '13196','71558','81338','66197','65421',
                          '16782','70921','35224','12081','40246',
                          '21855','53431','22469','43682','76377',
                          '68709','20182','45696','39866','78533',
                          '83483','53877','37556','36489','85857',
                          '62119','43588','40685','10494','85197',
                          '80985','40656','78389','76120','58414',
                          '74439','51112','64702','28624','29258',
                          '23957','92437','53911','89776','51579',
                          '38081','39779','46866','29461','61945',
                          '87011','59748','62199','34835','56442',
                          '76620','40986','11161','98087','61814',
                          '56450','67259','78355','33695','80765',
                          '79083','19870','72399','96840','64637',
                          '19894','57826','81280','19576','80270',
                          '69276','50248','36828','68182','44083',
                          '61032','22291','34466','90912','83714',
                          '12061','47378','88762','56266','93886',
                          '70276','90041','34435','42110','83341',
                          '47037','46188','53226','74141','73633',
                          '76716','90624','88266','79154','57793',
                          '30957','25846','48498','82696','53336',
                          '52328','84924','45344','42132','79568',
                          '91033','58598','24433','85008','15900',
                          '15789','18129','16421','33357','37408',
                          '18598','78981','26562','44087','31195',
                          '11530','79452','72893','99979','55443',
                          '99554','54024','73839','59413','36423',
                          '81123','27228','96284','94249','76361',
                          '87684','12708','35091','36119','91991',
                          '26547','10945','35083','80896','48306',
                          '54118','26679','73753','78611','87435',
                          '95035','38062','69640','14736','47425',
                          '44798','21191','49429','59317','80268',
                          '39629','13302','53577','93526','14188',
                          '79318','87099','16096','63411','40197',
                          '43967','66224','64187','71428','69762',
                          '89042','25925','70591','34406','41353',
                          '48584','21627','96837','37298')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


