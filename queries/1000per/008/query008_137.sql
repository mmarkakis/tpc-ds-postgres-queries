
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '77383','26993','93483','36717','68773','54862',
                          '15031','23817','73815','29002','79095',
                          '77329','85155','58682','10366','89344',
                          '90770','80136','70648','94867','95618',
                          '74247','72105','41830','35224','72338',
                          '44935','12577','47481','80997','63520',
                          '15437','67690','92115','17782','66800',
                          '82277','36776','51535','29978','35154',
                          '47012','79611','84397','53077','64105',
                          '71806','17346','14297','88009','39183',
                          '99638','17597','46638','38755','72608',
                          '33599','66012','67790','91751','24886',
                          '66705','35984','39650','18033','87357',
                          '54839','25789','26118','36481','84414',
                          '15962','35876','94071','44756','79261',
                          '97495','36269','51667','74222','73150',
                          '46641','77938','70385','79824','53826',
                          '40499','43522','76147','61753','78509',
                          '98323','67852','44923','80063','97939',
                          '19950','17167','76160','71942','68261',
                          '71324','19978','14722','74735','81170',
                          '75221','17039','61057','96460','15647',
                          '22573','73408','55407','19599','56858',
                          '54333','47142','59914','66876','17935',
                          '52555','53285','44223','57205','90990',
                          '88499','31664','40872','20242','84326',
                          '65056','61467','53539','64082','93004',
                          '80938','15084','90285','56998','70684',
                          '42701','74517','52166','90680','16007',
                          '66916','31582','50754','60149','95754',
                          '92839','65844','78841','79172','19846',
                          '18009','16382','82463','53785','91159',
                          '82285','54623','75649','83706','67553',
                          '31406','31016','21867','40345','67102',
                          '56000','50561','76686','58891','14000',
                          '64582','93462','82504','51953','88732',
                          '65676','85228','38334','13294','26526',
                          '36234','66911','12841','91781','65178',
                          '70970','64272','40142','45972','76801',
                          '31414','98861','93309','28308','73098',
                          '14427','43592','43933','65260','42810',
                          '97783','20656','27249','33915','29195',
                          '46235','36522','52472','85916','62283',
                          '41978','38802','95029','23167','38703',
                          '16458','29336','27000','24363','67297',
                          '90116','12357','39274','64832','10216',
                          '74707','76626','37224','17407','95561',
                          '88436','76511','20840','22835','24819',
                          '28105','23658','77120','88609','66286',
                          '26858','53447','14593','46240','12791',
                          '15586','76135','46802','31570','46324',
                          '70707','29056','51190','53890','42347',
                          '23140','64724','17777','97941','92608',
                          '19185','93786','74560','66005','15540',
                          '43930','71003','54662','93959','58635',
                          '69474','52360','61926','72897','40496',
                          '52039','18813','76022','76869','66490',
                          '82818','59706','12279','94079','58556',
                          '88823','18765','45519','64477','18173',
                          '67806','91824','81185','80941','44047',
                          '54660','76103','87184','66543','16009',
                          '11162','58558','45648','63890','36307',
                          '18971','11252','42059','87126','87064',
                          '17110','19361','25551','35706','25293',
                          '51588','36595','63662','84599','53527',
                          '31528','81717','57344','45294','97025',
                          '31355','66700','16337','48537','13007',
                          '27928','76403','11343','21556','47354',
                          '77860','90333','10826','28828','30207',
                          '94420','40704','71353','70727','32496',
                          '84193','63121','50006','67986','85640',
                          '53858','88738','86094','74597','74752',
                          '81538','62309','53952','43388','72545',
                          '41145','64609','77201','47065','35678',
                          '95758','20096','77119','69246','62272',
                          '18833','48900','94876','15125','99664',
                          '57474','47064','25312','81006','22584',
                          '48837','70007','28197','43651','20265',
                          '45082','57578','47344','54671','20830',
                          '42608','54615','58604','55505')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


