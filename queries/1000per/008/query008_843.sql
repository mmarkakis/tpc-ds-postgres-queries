
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '41131','22710','60017','75481','34297','83732',
                          '70907','32431','78130','82660','74868',
                          '90712','58764','11137','11470','10540',
                          '45847','99021','14954','76657','78296',
                          '27082','85163','79424','85564','85225',
                          '94513','91550','54314','48112','66785',
                          '93079','86033','58021','74450','56294',
                          '32355','93373','29593','59817','14289',
                          '97074','19472','34954','75396','95683',
                          '71561','97609','62682','51649','13727',
                          '91737','53457','19310','87814','48576',
                          '84268','26721','41947','90795','30080',
                          '55683','70396','65399','48758','79406',
                          '55065','38157','89324','81643','48499',
                          '86978','28912','74044','63131','42405',
                          '18506','45581','54649','18812','11462',
                          '96488','80929','36986','17691','99737',
                          '30310','59223','33926','70970','77336',
                          '75209','40824','99563','93547','86109',
                          '44727','94644','72414','55671','49484',
                          '84479','40032','89301','85474','94012',
                          '91597','79991','79673','92264','31965',
                          '15921','61474','65314','76038','14339',
                          '34989','62361','82027','91064','60799',
                          '99175','27182','68557','50209','68975',
                          '18392','83786','86602','99198','16504',
                          '66454','50755','35849','14687','36751',
                          '58814','92733','76219','32173','16582',
                          '20621','63838','67371','37364','78083',
                          '41086','81793','46101','60511','92561',
                          '31987','87795','52144','99556','85189',
                          '59516','87454','31157','88610','39728',
                          '65490','60405','32964','11656','25387',
                          '26938','67936','79885','15966','75358',
                          '48678','14703','73206','65597','68811',
                          '81638','48659','60354','79741','39771',
                          '83314','35319','55611','21711','92541',
                          '89463','88884','88004','88497','90748',
                          '82711','50367','32644','64212','86069',
                          '51181','45848','12167','60826','66767',
                          '33799','69547','25240','47174','90477',
                          '30484','98208','63305','14304','30635',
                          '16160','39953','89765','58570','40024',
                          '61923','85689','79840','28241','21270',
                          '39243','24617','23397','66714','80354',
                          '43458','76071','80753','42367','25248',
                          '87778','22865','59660','99705','86580',
                          '74384','62265','64209','22499','75278',
                          '91952','99094','79290','55360','62653',
                          '95295','30126','33039','10591','91162',
                          '19961','77498','94955','68727','72936',
                          '83692','68592','15362','23483','27041',
                          '39341','89063','17549','75217','20350',
                          '14915','72155','73787','39210','24914',
                          '72999','83004','33842','80136','91787',
                          '26570','47404','40557','78814','23989',
                          '83150','56455','88367','86098','93601',
                          '88950','48560','15467','41512','48062',
                          '60997','55938','48834','22863','43839',
                          '19178','91254','75187','15958','82927',
                          '91957','21056','93809','36858','35366',
                          '85563','99232','98838','78912','66927',
                          '20495','50032','97205','70416','46167',
                          '80822','86404','34546','97417','34496',
                          '25639','80010','57276','52278','92783',
                          '99137','42954','31840','32679','68689',
                          '24409','47811','69076','41800','83672',
                          '77341','42890','44830','96725','80766',
                          '70119','51819','24900','24774','83992',
                          '84006','49504','11062','29958','59765',
                          '65959','95866','68030','15378','85230',
                          '93578','55181','31017','17759','31305',
                          '98865','70474','56687','81334','27886',
                          '59300','96107','77724','21131','68729',
                          '14504','89908','74316','25257','10073',
                          '83017','81575','50168','12222','67330',
                          '83978','69384','66874','85869','32921',
                          '81472','73861','88313','60708','24465',
                          '84545','31768','87851','84401','93962',
                          '71318','72506','48644','53025')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


