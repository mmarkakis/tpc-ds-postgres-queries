
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '56833','75490','86341','68716','96869','41346',
                          '53792','65924','27182','61384','84950',
                          '32338','28351','15206','91476','90423',
                          '75667','12119','25177','10062','51076',
                          '68936','58010','57265','27205','79906',
                          '70610','43273','72733','10712','14647',
                          '55510','89530','81965','38490','71837',
                          '41148','38914','88191','93662','64944',
                          '81479','44837','14461','67471','78791',
                          '67861','62988','28327','20949','24670',
                          '75729','48756','67647','59419','26108',
                          '68439','54644','74562','72241','54176',
                          '80684','59206','50446','50514','33837',
                          '60678','92956','12236','87521','48550',
                          '23946','70630','38393','76885','63569',
                          '97978','55513','17406','19306','40069',
                          '41331','46764','91906','64972','70736',
                          '90460','18215','80776','28365','14643',
                          '62246','89080','82802','41064','25385',
                          '74882','23876','33043','12969','68224',
                          '84354','38531','62467','33609','26152',
                          '91726','54742','50513','41269','73271',
                          '44512','53483','15534','86997','40418',
                          '30617','42442','74672','35996','77554',
                          '67030','46011','64450','69902','42527',
                          '37164','47692','25438','36219','41868',
                          '61305','29525','37358','69914','76930',
                          '38445','61170','99029','21254','58269',
                          '46162','94508','30835','28761','31914',
                          '44848','53906','26561','24162','69435',
                          '93907','72080','63910','73899','92498',
                          '45455','64707','54136','22876','85834',
                          '90394','24593','99185','99999','32144',
                          '43206','31261','57255','29911','35562',
                          '49401','27620','28508','17807','98223',
                          '49594','76157','47956','64936','40738',
                          '98863','19494','27014','21394','12309',
                          '85005','81509','29066','80464','74410',
                          '17630','87727','33439','23001','42798',
                          '93816','89434','43737','27190','58323',
                          '66034','22899','79614','49527','11408',
                          '53194','81199','85606','46543','19477',
                          '43427','13293','31202','19377','61485',
                          '21873','17938','12714','19539','72865',
                          '93847','57631','64327','10641','35495',
                          '92660','28277','44236','39376','34823',
                          '71027','80830','66089','51853','58304',
                          '41599','68514','58429','83541','99651',
                          '85465','52039','76991','57292','36813',
                          '52204','25209','39203','56359','90795',
                          '51867','35574','51015','40497','71908',
                          '95013','50829','86987','13637','17730',
                          '63296','85760','57122','53134','23995',
                          '98794','88631','64319','96246','92324',
                          '97037','13537','74123','70800','42787',
                          '10991','56115','85072','15314','13563',
                          '83611','44549','67364','32553','54876',
                          '56607','12662','38219','32906','21721',
                          '57033','62274','48341','23863','12247',
                          '87992','28466','37184','45308','46548',
                          '13837','14321','26661','47217','26275',
                          '31737','43390','21132','58217','25275',
                          '31467','82891','95959','30406','59019',
                          '54615','67047','81956','76887','47794',
                          '42033','18533','39308','69707','60715',
                          '91690','74643','98701','79887','61610',
                          '66722','86471','64381','51591','65918',
                          '69444','67965','58629','95661','29100',
                          '78948','20134','71615','69038','18230',
                          '23410','75286','50641','50347','68061',
                          '44678','68330','10429','21909','82377',
                          '23544','38910','89709','33779','79078',
                          '83372','77477','81997','20268','98163',
                          '97395','95628','36047','20791','96509',
                          '26968','37217','55278','78695','88108',
                          '68444','91849','11417','63737','89444',
                          '26483','41704','98913','59061','64245',
                          '14117','96036','13009','54827','57601',
                          '91277','22702','72637','71738','41574',
                          '43009','85930','76878','34507')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


