
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '12075','30636','96088','31999','41553','32171',
                          '72861','43475','28778','85527','88197',
                          '61737','77930','69740','45026','89696',
                          '29516','80251','12362','18868','48588',
                          '49829','37126','73992','25621','35599',
                          '51885','55231','81305','85674','45323',
                          '18160','46591','80479','93054','32209',
                          '21066','69132','53289','42580','68614',
                          '61035','23191','18862','61005','99023',
                          '36964','97974','57348','68969','34506',
                          '58394','86272','57569','93844','76706',
                          '82425','75301','95982','15739','37561',
                          '96798','54846','24812','22165','47063',
                          '75684','28837','34181','14928','97217',
                          '79052','58372','68795','11691','53809',
                          '58547','88074','52367','97443','60896',
                          '36090','12005','84536','59970','70882',
                          '89769','57355','23351','76945','99894',
                          '82707','31092','79392','43845','88405',
                          '30971','51606','45010','92206','47845',
                          '86061','25791','43609','81763','40523',
                          '50010','12557','93486','90267','36148',
                          '19470','79764','93703','52819','58815',
                          '75932','39457','43727','34744','58900',
                          '57430','30150','70902','95413','81031',
                          '51390','40533','55078','84558','79409',
                          '78417','82836','37518','66508','65607',
                          '44569','86190','40859','21800','74944',
                          '66092','75469','63586','23855','77235',
                          '42334','48952','50199','39566','37359',
                          '32089','25522','84727','37640','67705',
                          '51756','69079','32339','92296','71760',
                          '95849','36169','67761','21980','13236',
                          '48081','45127','84868','88928','43948',
                          '24695','90696','95538','56928','29180',
                          '99308','60989','58762','23688','41498',
                          '30852','45474','96216','70064','66322',
                          '58076','61804','85255','11009','71026',
                          '95088','19427','95534','81535','63136',
                          '95031','54279','80668','98963','50507',
                          '55201','90147','37710','99473','71807',
                          '61355','97754','38470','38688','22448',
                          '51031','95097','69937','44751','80345',
                          '48608','58719','38035','12600','21961',
                          '48730','47712','45826','73290','48285',
                          '32753','66376','69672','60661','41176',
                          '89416','21124','30891','19346','77275',
                          '79628','48668','38926','73660','90391',
                          '29197','51443','62922','39264','51981',
                          '63371','45580','92478','37644','27633',
                          '92918','98791','53985','50491','27876',
                          '18885','64743','66697','76586','14357',
                          '11684','12523','14185','96918','69243',
                          '53416','65013','99860','91970','84381',
                          '97274','78388','66773','93471','83659',
                          '77847','93320','14687','33646','65213',
                          '38547','31538','36951','68418','45105',
                          '87647','78660','90350','70646','86445',
                          '19027','74269','47021','71560','53790',
                          '71654','49772','68006','73646','25858',
                          '98959','22933','48091','18439','60931',
                          '84837','56611','38495','62055','90974',
                          '32238','72845','28356','85865','95650',
                          '48901','15402','27567','52053','35382',
                          '36961','78837','31849','30499','32344',
                          '16580','89396','26148','50591','69695',
                          '22415','41617','80512','72518','95367',
                          '36208','54138','13483','68407','20112',
                          '90720','46246','47754','17911','85053',
                          '80851','73486','22420','70384','83130',
                          '68247','58326','85409','35322','17338',
                          '27217','17261','71189','46223','94010',
                          '53283','21979','63781','54739','36624',
                          '57846','79359','73880','84996','48452',
                          '21394','40935','92648','13833','70191',
                          '15887','81873','86362','46724','49490',
                          '39435','83572','63559','69296','41401',
                          '26107','29755','85099','36986','21422',
                          '79271','40238','22300','70894','76108',
                          '12815','16973','75591','88312')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


