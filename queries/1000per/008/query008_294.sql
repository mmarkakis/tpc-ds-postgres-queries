
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '50319','61150','32657','12827','94805','50142',
                          '82207','16710','50250','75501','18912',
                          '56105','21318','59599','44903','38993',
                          '95680','15830','51565','70000','94130',
                          '12556','65301','81763','65469','57206',
                          '29526','39035','43089','52458','18713',
                          '45342','51348','97829','72022','40110',
                          '89729','35978','45367','44755','79936',
                          '98282','66983','67644','16908','39504',
                          '31891','90626','95685','48540','52035',
                          '99088','73726','64858','35304','73234',
                          '97086','90248','17527','98497','67343',
                          '52303','30375','16779','52430','34930',
                          '10364','59089','19466','60627','46668',
                          '77440','94281','33481','60285','65334',
                          '25104','27189','31031','89803','20819',
                          '80706','77520','33308','45505','36753',
                          '44768','91106','35414','20133','11335',
                          '61317','33058','99614','23415','63936',
                          '30094','98447','34776','13263','57432',
                          '63947','31636','77018','76777','93425',
                          '26513','98768','15668','19816','38875',
                          '43957','13438','41975','29889','84759',
                          '35305','63945','50731','27799','87214',
                          '49892','79533','68621','12429','36251',
                          '18501','27515','61182','16402','71184',
                          '42772','47871','33770','83220','41197',
                          '75168','33647','93410','69647','58413',
                          '22294','16419','56681','63435','36652',
                          '60016','76042','65208','43696','19678',
                          '31348','23813','20950','41098','26627',
                          '11614','46712','46349','81656','99784',
                          '55686','53852','81053','70525','88071',
                          '90178','35099','77855','24792','17935',
                          '66140','37626','41979','90616','34047',
                          '34673','14921','51067','31737','17293',
                          '84219','96312','16118','31068','46080',
                          '90674','32290','52599','33573','92910',
                          '43596','34704','90919','37914','76730',
                          '64704','18288','24393','84245','29380',
                          '25063','39600','29084','48785','23501',
                          '28863','65511','26337','89099','21002',
                          '43953','14546','46888','60177','99815',
                          '43122','86498','67480','14672','57381',
                          '30230','77185','25966','12259','52918',
                          '93761','36881','88932','26171','81262',
                          '18435','20278','61632','28840','65265',
                          '44130','87175','31413','13084','36096',
                          '56898','79969','63977','59261','63128',
                          '50179','40515','17941','23871','85024',
                          '47484','42786','12928','56539','40902',
                          '79632','63034','31282','13538','67494',
                          '95838','78834','94913','11591','17803',
                          '67612','63270','17787','73353','20113',
                          '22204','91478','85931','99513','53490',
                          '65065','62189','97499','61011','34434',
                          '14755','73400','64754','65502','83531',
                          '65751','61036','69404','11580','96761',
                          '92620','71564','24659','65584','42576',
                          '75066','64016','41849','32550','88016',
                          '64811','40263','20474','86581','83008',
                          '20969','23335','74432','98437','48934',
                          '85611','28618','77260','50129','67689',
                          '93277','42875','37177','29360','33902',
                          '96669','31675','44576','68887','13398',
                          '46346','21450','53182','65002','59169',
                          '57593','68230','26284','61639','14359',
                          '42356','30191','67164','17284','62873',
                          '78342','80528','84175','67447','36127',
                          '64958','89362','92645','57177','70623',
                          '20331','11440','76368','21257','60419',
                          '70987','48886','34891','85771','66951',
                          '46257','14352','41113','40464','45905',
                          '57975','13516','85651','71197','80424',
                          '79359','81263','45044','97352','53178',
                          '26211','19558','90100','54154','44281',
                          '23013','67084','35142','45804','41305',
                          '86134','92999','64770','55020','92498',
                          '98237','19343','42064','61883','26228',
                          '71370','13467','21108','27751')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


