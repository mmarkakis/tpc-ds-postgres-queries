
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '20444','27253','61264','35124','25917','28028',
                          '89633','10189','72707','14019','62206',
                          '24563','52806','21870','21270','71737',
                          '11665','35291','92437','63466','50639',
                          '23724','30030','61031','75525','93645',
                          '54206','33399','90004','49636','76322',
                          '32985','88431','21556','15071','75607',
                          '20285','34499','56465','29280','41197',
                          '18894','92744','33267','58101','54270',
                          '31779','31017','16605','21714','23389',
                          '61097','41458','22945','17594','30782',
                          '58137','68091','11059','94406','51791',
                          '46977','61368','52487','28718','27202',
                          '17001','61636','87792','87964','37473',
                          '88132','96364','32773','39699','23762',
                          '54891','23938','98261','70942','26885',
                          '41448','80574','78808','69778','60014',
                          '71974','77855','90925','87218','34402',
                          '88026','44666','22900','73045','66238',
                          '61403','44077','85594','55973','71301',
                          '63557','61864','48615','11017','53777',
                          '57235','82295','13037','11695','19590',
                          '35981','21068','80462','64506','13290',
                          '76897','56399','67438','96976','16625',
                          '57487','36829','29000','48826','41265',
                          '14026','67222','22369','10770','68993',
                          '79857','19601','97256','54220','69393',
                          '94231','25738','75690','84837','50318',
                          '34254','95865','76657','82432','36130',
                          '92934','72600','57612','95528','20221',
                          '89960','71936','36030','32054','46957',
                          '82841','53323','86306','62012','74865',
                          '64078','19433','70511','67015','29909',
                          '23375','49761','43810','70758','29905',
                          '52933','54497','81364','34997','20236',
                          '71715','78932','43247','97121','42541',
                          '11080','76017','44470','15042','88078',
                          '64287','37060','63309','64746','24472',
                          '83271','92027','77278','42992','55940',
                          '46694','75964','78744','68774','43343',
                          '29955','94985','62620','36691','44578',
                          '11528','70005','55360','82250','36067',
                          '78474','34914','51137','59103','75009',
                          '57160','83728','71466','96861','44094',
                          '72330','96386','78371','23036','13180',
                          '32359','29942','17151','28109','37866',
                          '92918','51234','23832','13304','81921',
                          '38530','74213','46398','20562','59727',
                          '17833','48057','64759','34085','72833',
                          '42998','67757','48577','41820','56340',
                          '64709','35370','38304','10081','22037',
                          '95930','78013','86613','96065','43462',
                          '21686','37033','51118','96481','43847',
                          '42880','19080','34423','20839','21136',
                          '34348','88880','43713','15037','79350',
                          '50585','25656','85865','76381','75499',
                          '42384','61304','98672','24139','41052',
                          '98987','10824','74800','73321','71497',
                          '35245','74690','78301','86224','22003',
                          '94940','46757','10363','59415','34781',
                          '83736','92876','35252','46646','72388',
                          '58150','17750','46284','93100','50194',
                          '56117','25871','78953','41027','40755',
                          '35050','13253','28883','36976','33369',
                          '83423','85766','40657','85918','97947',
                          '96855','41013','67197','23965','89971',
                          '49830','93036','73550','18782','30625',
                          '74387','20678','50541','72769','37148',
                          '73735','46824','79479','71174','80717',
                          '62939','99885','96706','90582','41361',
                          '54104','45338','50092','96569','38298',
                          '15512','64952','90198','39485','27590',
                          '49607','80442','45554','21802','27957',
                          '30220','57421','72649','40656','41343',
                          '50291','64242','73593','47035','42347',
                          '74046','11256','27865','75965','92387',
                          '83032','68038','28254','95609','54508',
                          '23030','83801','27319','49133','48759',
                          '79633','72652','36912','31993','45075',
                          '58134','58512','81785','82818')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


