
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '87250','50477','43164','71136','57993','45857',
                          '62153','77112','36470','10273','96414',
                          '90656','86859','31111','58653','63718',
                          '78404','25995','98275','20563','68858',
                          '14050','15464','24319','92139','73502',
                          '19183','44542','49710','90734','89486',
                          '41506','80018','84637','75093','18815',
                          '18946','57358','75957','68355','75989',
                          '76186','87221','21432','65766','33109',
                          '39518','44469','21745','30236','87514',
                          '83183','82085','15187','50158','58127',
                          '34123','78419','62511','53752','72621',
                          '71563','45780','77970','32641','77748',
                          '89174','44775','93956','43783','53700',
                          '15056','99683','34128','89746','56278',
                          '37980','44652','49921','40385','22401',
                          '19642','98110','46935','45696','43483',
                          '58471','18481','47792','35078','14148',
                          '45502','13653','74759','54681','92901',
                          '97663','17365','14337','14016','33293',
                          '47713','65423','96016','50570','35249',
                          '39249','46985','46565','66527','33828',
                          '83390','83350','12398','22921','36449',
                          '34936','78709','82867','35780','29038',
                          '83666','26938','82525','33098','83615',
                          '79959','59784','36511','83247','86100',
                          '46947','84438','68366','51436','73033',
                          '30097','62472','43575','94976','89345',
                          '44328','57467','20628','68904','23253',
                          '57980','63175','58899','24858','81933',
                          '40556','81529','79844','78476','62176',
                          '76775','66699','69169','48765','92684',
                          '60640','42908','55542','66231','20096',
                          '96110','93118','64090','84651','72619',
                          '62567','17813','36789','37627','85151',
                          '38422','96071','49479','28775','62904',
                          '60943','85816','82840','15244','63298',
                          '14732','60317','31103','63308','79928',
                          '50609','95287','79183','71009','65409',
                          '94722','75574','82622','81857','24572',
                          '72656','27582','46093','41135','27292',
                          '96300','89288','66451','94631','43714',
                          '88130','11304','53373','52650','95522',
                          '90676','14841','12627','90043','78944',
                          '57425','63749','70747','39465','37660',
                          '58340','79899','81820','84946','51387',
                          '95955','26372','16422','22465','65220',
                          '47330','45178','50998','19689','31761',
                          '90649','22771','63421','48242','38888',
                          '37423','23593','55455','52628','73252',
                          '98016','63686','21846','14282','46585',
                          '50614','60075','15822','24450','14071',
                          '64415','20418','60418','95605','97808',
                          '50316','97483','75472','54635','93263',
                          '37344','19574','34115','99977','98297',
                          '58126','40471','65519','21837','51159',
                          '36564','74671','44792','44758','92926',
                          '61078','24076','80752','38600','61147',
                          '52332','39824','91367','90276','14243',
                          '71745','39086','81045','95455','93505',
                          '43518','60792','13709','28270','78881',
                          '44204','30413','74963','13602','91074',
                          '13286','98418','81060','11493','52915',
                          '14259','73820','83693','72286','65457',
                          '65687','81088','46308','54439','20566',
                          '58262','78841','31262','91430','39883',
                          '10608','22933','52190','84358','98631',
                          '16000','59390','12221','61991','46198',
                          '41642','66670','49785','74205','53695',
                          '75668','67520','66870','31323','42899',
                          '61048','45452','31573','59510','49984',
                          '77187','72568','49705','97402','90020',
                          '46452','82778','35652','89228','68072',
                          '13047','50275','28850','53434','31054',
                          '92176','46086','37831','86724','37881',
                          '94106','66937','33825','31493','48863',
                          '97252','85750','65307','38044','23849',
                          '45976','51308','86676','29335','42234',
                          '49431','46179','60093','90853','48629',
                          '69778','24445','26748','54729')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


