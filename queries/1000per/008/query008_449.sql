
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '68022','61440','81405','54566','62582','56389',
                          '87251','26146','66144','73221','79999',
                          '90810','19532','59871','55672','81893',
                          '76915','11241','75697','35390','79526',
                          '84789','15906','45550','47794','15966',
                          '33192','57558','94598','40202','51776',
                          '90682','40524','39186','34631','27999',
                          '99789','55279','73074','47029','66304',
                          '58159','81705','42339','98183','77815',
                          '91195','41687','56668','99875','15591',
                          '92480','84466','98684','43000','88216',
                          '30062','96172','61109','57734','40928',
                          '65718','46285','76590','17092','82230',
                          '78947','52718','30281','39268','58236',
                          '11993','39555','63589','66395','75699',
                          '15229','66164','93770','60215','75514',
                          '57582','81855','86316','67648','70037',
                          '56015','95350','93407','81527','21446',
                          '48956','35930','89557','84941','66181',
                          '49322','53378','29997','61141','52388',
                          '79168','11052','62654','70399','34348',
                          '39113','17708','50504','43699','28974',
                          '43931','61619','68140','98272','62861',
                          '49847','36799','45693','27177','23532',
                          '60862','11634','88778','72728','64252',
                          '23583','32655','61179','42816','10175',
                          '31311','86395','12045','68398','60102',
                          '50599','96223','79013','53388','38604',
                          '92291','98153','52852','79725','75592',
                          '71044','18697','80595','83316','22608',
                          '60854','26987','57757','36104','81619',
                          '85562','13607','99630','31581','25868',
                          '14345','60421','53436','87260','91950',
                          '79495','50406','93394','95999','50589',
                          '22928','77510','71114','57093','16805',
                          '81431','17428','12996','62891','58005',
                          '54832','93468','71617','82745','90160',
                          '65336','40213','34080','13065','41251',
                          '43777','68154','87620','87826','38518',
                          '40904','82317','43843','90602','67897',
                          '29378','49651','25543','88187','69623',
                          '97670','55913','95189','74805','42134',
                          '86841','26398','22283','82883','67560',
                          '68622','89296','81436','47156','42105',
                          '15484','13931','60436','68861','57970',
                          '97144','44184','28058','83183','15716',
                          '47726','42394','53398','82115','23394',
                          '71756','42435','94211','24266','51349',
                          '97488','52026','31994','28320','20823',
                          '23519','95262','75529','51270','28493',
                          '20803','79246','43538','72242','22600',
                          '75236','52211','92676','77514','56812',
                          '22849','85643','52744','42565','99614',
                          '38774','52290','33165','33350','72390',
                          '89989','38411','22342','52619','31518',
                          '32433','21732','96477','87653','96369',
                          '42862','21973','63985','63470','86939',
                          '23076','38721','54776','95541','74608',
                          '80676','73230','64599','76387','56538',
                          '16545','14363','83707','56964','43571',
                          '84121','74354','63794','38850','20549',
                          '79159','76072','33267','56114','89441',
                          '98428','90363','52201','75777','88800',
                          '82044','37342','76385','67220','79867',
                          '32458','46515','13174','28494','96189',
                          '96476','48177','32956','38549','40409',
                          '28809','65956','23785','62827','62090',
                          '92353','87116','63779','84676','77136',
                          '82948','49100','63662','24927','71813',
                          '28053','19973','36243','61112','14332',
                          '45356','20171','58023','10722','49182',
                          '81184','95404','93938','82656','56262',
                          '76091','17978','99447','72001','48340',
                          '59300','64145','23071','98660','10235',
                          '92284','30103','80527','43611','78826',
                          '59447','18326','71003','27054','88352',
                          '42544','55303','58502','32131','25051',
                          '84173','90213','55539','42598','89702',
                          '29268','74621','31790','64962','11102',
                          '50997','28129','90502','23770')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


