
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '38916','27051','19118','56570','24245','80441',
                          '68703','63638','27074','62709','56068',
                          '47505','35359','90378','32828','68250',
                          '71679','92046','92474','84460','27599',
                          '16670','60007','84485','40602','49527',
                          '41100','12563','65395','11692','42457',
                          '60949','79307','73819','79821','81481',
                          '25531','31081','52946','67362','19377',
                          '11583','46076','52099','62884','26447',
                          '28890','29619','25748','77222','89329',
                          '78174','45572','26504','13928','86163',
                          '17775','89605','30561','12926','12140',
                          '52324','98521','58064','98781','34726',
                          '61406','24581','50817','36792','90682',
                          '43126','42668','58657','45678','33735',
                          '90445','94544','89295','48860','63606',
                          '21862','65937','83771','55744','53966',
                          '19709','21675','28781','37602','40914',
                          '44375','14649','53240','62356','36936',
                          '96596','99729','79778','97074','48736',
                          '44965','60218','18138','64638','79559',
                          '20138','77779','43542','19733','84896',
                          '31457','86961','26330','79632','62316',
                          '13049','93193','60427','40777','68548',
                          '13368','22265','43781','52120','18126',
                          '47751','53175','25700','64168','94682',
                          '49621','89076','91541','78230','14665',
                          '38039','33078','43853','89851','16089',
                          '29119','46457','68441','40993','94159',
                          '13249','91667','44551','29794','94586',
                          '36487','27812','14250','55074','37256',
                          '76695','23097','42590','31949','70611',
                          '95654','54189','56042','17519','35905',
                          '82177','18612','38455','30570','51196',
                          '89094','96160','57315','41640','72737',
                          '49851','52618','67238','50184','46764',
                          '54372','16363','54883','27588','88466',
                          '54399','46517','23996','12456','88520',
                          '87487','26939','66149','62628','70632',
                          '24302','97628','33142','41865','89381',
                          '74951','58401','91247','72669','50549',
                          '54085','11221','30571','58595','74359',
                          '24703','13370','64513','73570','83562',
                          '42939','62715','28800','25043','50162',
                          '18476','93646','58733','61415','11575',
                          '30369','62212','53741','99461','99807',
                          '57696','20255','47454','97918','85355',
                          '90575','31350','64118','67959','38681',
                          '63158','78305','76416','86229','72379',
                          '75092','14115','38931','28319','52523',
                          '42822','95638','56373','69168','49828',
                          '12994','48719','46163','91492','63669',
                          '53685','24822','87221','85304','69630',
                          '73035','12771','73793','58515','83568',
                          '31378','37632','40484','84988','60946',
                          '83659','43718','25950','58520','48439',
                          '26776','68460','55373','66112','98388',
                          '87083','91848','16499','27502','37184',
                          '29576','24452','75721','65865','62525',
                          '26608','26782','34667','53198','59153',
                          '40183','20525','45576','72181','68885',
                          '57911','30514','95556','49963','39048',
                          '46634','45391','17357','94451','84264',
                          '42236','14960','74321','71997','99961',
                          '64904','96787','14065','81600','78018',
                          '97192','53811','66367','67827','83882',
                          '83064','21742','43630','13795','27687',
                          '29982','71560','91486','46161','86725',
                          '60672','27194','31865','91014','76722',
                          '77404','22937','85701','68313','41377',
                          '84111','57927','94163','57064','30046',
                          '93952','39491','35021','53436','19391',
                          '37552','40424','64350','85933','47133',
                          '76247','61855','60810','73168','99062',
                          '64646','67398','10510','72032','41938',
                          '69352','38319','81739','43435','68939',
                          '81009','90458','62191','45511','21606',
                          '78273','36447','87520','64793','19142',
                          '91872','73459','88929','26351','64135',
                          '78523','89056','22025','30134')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


