
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '89732','82953','14856','92214','28537','85708',
                          '51542','87470','43603','57274','85321',
                          '83701','31692','88354','69094','90307',
                          '54813','18401','10431','52333','70333',
                          '20325','29176','17495','57289','38031',
                          '34932','27641','96538','61390','23144',
                          '81963','31883','11201','61640','80369',
                          '67647','79731','92474','67959','67092',
                          '17697','50459','24923','95582','58805',
                          '28040','47848','45940','28374','72493',
                          '76054','70346','19789','48364','99542',
                          '12824','62475','83481','53408','50005',
                          '74435','83704','26072','86850','92715',
                          '58534','37396','73174','23240','79558',
                          '78691','63337','47286','43391','33182',
                          '71088','92036','54900','19611','58717',
                          '61880','25111','84426','10894','98653',
                          '24062','21004','71438','38051','78331',
                          '32562','34728','81473','71101','99554',
                          '25431','99769','88319','78317','90478',
                          '49711','88869','65493','34562','45943',
                          '22743','14717','86839','55812','44778',
                          '72211','72251','82376','39077','30968',
                          '57640','47401','38218','36394','91509',
                          '22696','59925','25927','67628','90248',
                          '31678','46381','52329','10326','20691',
                          '18689','34680','47628','87629','69370',
                          '87680','41064','13990','41264','26188',
                          '77699','30435','88028','40513','65163',
                          '27921','70856','73747','78009','14246',
                          '15121','64308','45124','42449','64291',
                          '79114','87007','95854','78143','36310',
                          '98889','25219','61110','10059','50752',
                          '35766','65479','33356','67693','96734',
                          '78294','51574','43079','52220','91929',
                          '33519','88044','69337','37725','98395',
                          '63428','58841','73201','32928','84400',
                          '65529','63096','19185','87064','53595',
                          '44550','14086','60227','65015','13004',
                          '42364','83367','12401','37290','71316',
                          '27789','65498','69212','76854','91608',
                          '15237','84790','43933','86082','64016',
                          '40143','41671','92160','94826','96958',
                          '50525','27104','18206','36077','49965',
                          '34152','61274','50486','17126','58019',
                          '53588','71597','52898','89882','81136',
                          '50025','93446','73435','76867','52878',
                          '77404','80234','76207','92569','37944',
                          '83923','73267','41397','47483','38093',
                          '71980','88323','82484','89896','64270',
                          '64329','83315','88519','23198','69266',
                          '97412','93848','64236','23465','61107',
                          '13087','59099','57810','16032','16461',
                          '34030','95098','75511','36424','88231',
                          '37707','24620','94863','90727','37870',
                          '46136','45675','85109','90743','94246',
                          '17814','82374','84815','50989','51402',
                          '95289','27461','60774','54797','51128',
                          '26885','96159','58839','32702','13305',
                          '35525','60235','60219','25990','74898',
                          '45885','36804','52495','58860','12027',
                          '30341','81922','44668','39508','38866',
                          '22756','89155','88865','30917','12539',
                          '76945','59466','54483','73341','34679',
                          '69111','69020','14916','24365','20157',
                          '27302','77524','25152','64021','71565',
                          '57265','10136','52909','76620','87312',
                          '47993','58555','92856','89627','54005',
                          '14028','61829','36471','18654','94949',
                          '80499','90623','18261','61135','47249',
                          '19792','30439','80072','50532','44558',
                          '55278','97313','59299','67489','67773',
                          '45544','49204','86190','41318','82513',
                          '88939','76257','28952','43108','56293',
                          '53558','36534','58048','61202','68597',
                          '76621','35339','31530','67995','75422',
                          '38836','55652','36610','83743','72545',
                          '27436','10246','15254','87695','99757',
                          '54275','76424','46766','11302','52159',
                          '82401','96258','43805','84005')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


