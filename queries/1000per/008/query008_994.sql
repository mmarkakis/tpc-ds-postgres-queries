
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '18485','20221','79753','66345','45045','71449',
                          '72609','70238','98677','82398','86109',
                          '39178','11248','87245','30548','29799',
                          '96696','92811','46249','15201','42268',
                          '84436','83235','79702','43558','12569',
                          '94264','45261','62990','25296','87679',
                          '90663','44070','77286','75027','87956',
                          '73238','19189','92454','22060','46475',
                          '79807','19705','48764','95584','45298',
                          '77957','56853','38562','30893','89181',
                          '88671','16650','26239','56738','92111',
                          '55763','37457','90402','23252','55340',
                          '99360','61110','90443','53100','34505',
                          '17725','97433','44097','37845','58511',
                          '29548','90106','71750','83415','33536',
                          '64090','39053','83698','45268','25751',
                          '35178','75566','39248','53313','61800',
                          '86906','19149','35923','18793','11475',
                          '55017','11032','53686','17750','75074',
                          '26803','38217','64937','91354','87938',
                          '16755','34279','47871','39633','55197',
                          '87357','27335','35159','12572','37199',
                          '52995','84009','42215','74925','37539',
                          '90071','40148','26933','41892','19317',
                          '77941','10403','43093','26586','78871',
                          '69586','22671','44100','37368','22354',
                          '92750','18399','95664','60826','88008',
                          '35117','46113','93346','71152','61304',
                          '18396','83383','52455','98645','77820',
                          '92701','64405','36129','17628','79325',
                          '92442','10013','51921','34619','64534',
                          '42336','86760','29572','41226','20174',
                          '95944','41052','99383','62157','86850',
                          '40029','20331','22062','17871','29637',
                          '81673','74431','30064','43662','66078',
                          '73744','99374','76250','36303','38705',
                          '47612','76557','61605','13337','42803',
                          '61933','81275','72040','92846','51582',
                          '82788','54101','85917','97066','22473',
                          '20520','27604','29696','50866','12538',
                          '69002','81508','86639','65386','14027',
                          '38619','79850','24010','68204','69299',
                          '94584','94873','46826','52260','86142',
                          '75382','33330','66181','14735','87051',
                          '86069','14773','60251','16727','55648',
                          '69423','34469','60348','86358','29618',
                          '70977','99880','56929','81941','43231',
                          '95987','44406','62542','65113','89676',
                          '68749','35176','58538','88594','61687',
                          '10838','97703','74964','60901','34818',
                          '64433','83172','94090','93064','14035',
                          '75306','70370','60035','90102','89618',
                          '98955','50367','11895','66771','83335',
                          '15047','84024','80805','71706','77347',
                          '83203','61883','13352','83605','73381',
                          '95422','51755','59696','49476','46636',
                          '14641','72315','34837','45800','25769',
                          '52281','31541','29500','65242','42685',
                          '85019','48509','27222','95019','34004',
                          '26036','66792','60165','73305','31909',
                          '38404','23453','30640','76740','30753',
                          '13398','13213','55732','35030','31809',
                          '22507','24077','97899','45902','81559',
                          '44074','73597','30759','18253','10984',
                          '99254','34104','55237','49444','94977',
                          '19023','73317','72376','67244','73348',
                          '69691','84776','97309','94288','31482',
                          '40261','29809','58404','62427','20512',
                          '92602','42867','23480','46817','32468',
                          '73196','58797','23520','60847','18490',
                          '58733','52512','65024','84331','92682',
                          '77897','53043','45246','23901','11191',
                          '48659','53321','22944','98160','63884',
                          '76593','11658','49486','54073','14810',
                          '30032','52663','43104','48105','92344',
                          '62261','29081','32344','10865','17692',
                          '62766','66589','25260','18351','92366',
                          '79908','55637','35899','74769','36265',
                          '24730','39294','57086','57514','58306',
                          '75105','11035','17281','68173')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


