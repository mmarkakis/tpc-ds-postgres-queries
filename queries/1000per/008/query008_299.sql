
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '46074','84660','88316','37400','16610','19439',
                          '94692','17633','69748','21196','62190',
                          '89297','90843','88599','75465','24245',
                          '64018','96841','28461','80544','99290',
                          '35294','93377','59665','64613','27414',
                          '72587','84382','89883','54365','23516',
                          '36865','73067','80196','11162','81047',
                          '59627','47786','43203','83469','11195',
                          '42955','33111','36170','54623','92250',
                          '16664','46766','21077','99305','52487',
                          '40646','47623','41637','99616','39991',
                          '62733','65401','83046','73557','90609',
                          '56870','59979','41635','91289','65110',
                          '48205','26040','97002','92101','78209',
                          '23064','70912','15742','29828','91536',
                          '75395','84240','50696','83039','96099',
                          '71605','68734','35029','94912','81916',
                          '11532','87211','78343','62879','26831',
                          '47438','18723','83665','26185','46543',
                          '25078','87611','29308','41645','84905',
                          '18433','95422','69076','63188','20972',
                          '99000','38084','70540','84676','82503',
                          '11059','96143','56934','79003','13219',
                          '22545','49394','89486','27976','68519',
                          '17536','19981','15606','21830','76954',
                          '26114','15392','63422','62878','81643',
                          '61342','54747','86418','92021','71433',
                          '72458','79472','80554','26694','27574',
                          '37889','88003','72992','41001','51153',
                          '69399','46681','83935','66640','63691',
                          '77783','15070','44665','13231','90707',
                          '39317','28683','36795','35068','73031',
                          '68077','79591','67858','35615','63561',
                          '78972','60632','68331','95731','90593',
                          '74825','76460','70418','57883','28722',
                          '53349','61714','38289','41338','89188',
                          '66496','31720','76380','73270','66521',
                          '13116','50022','65510','56245','80422',
                          '23504','43907','28176','56192','35922',
                          '64932','27381','32196','42588','52112',
                          '46896','66428','61609','18022','24297',
                          '38012','66979','41717','78014','72685',
                          '49610','17173','50414','69234','42586',
                          '80841','65654','10626','68001','99716',
                          '12384','74435','34674','43699','34530',
                          '88243','78036','44100','92198','77062',
                          '48095','36845','26678','18018','64459',
                          '30016','41861','11183','64982','88601',
                          '19848','32617','65777','24133','61695',
                          '51557','57979','35609','55931','39556',
                          '36186','33364','56184','29272','35351',
                          '87522','88195','65355','49493','48562',
                          '42848','32355','77029','91260','25401',
                          '47718','54272','90922','72812','97110',
                          '21953','55066','42193','34913','56707',
                          '40421','98281','49307','14192','31188',
                          '83828','24977','13189','41863','85342',
                          '20574','87345','11909','46973','40072',
                          '40662','77421','50216','60502','92931',
                          '94532','58737','40043','95550','13077',
                          '62829','89414','73334','75746','22946',
                          '53734','12442','13641','58631','96437',
                          '70926','24989','44890','42010','52062',
                          '57645','18750','27770','18374','34718',
                          '81712','70773','10648','67394','64050',
                          '43446','80722','90981','77138','96637',
                          '62129','17073','77186','19686','10655',
                          '62019','55531','36743','86825','78911',
                          '56645','33014','33098','50478','31740',
                          '53064','27175','26421','31151','36460',
                          '86261','35716','76707','96858','15152',
                          '80826','92040','45707','76074','49172',
                          '75177','76890','18850','82294','66718',
                          '19623','71287','19229','67203','94440',
                          '93645','74335','92470','45537','20192',
                          '98678','74127','45954','84105','98685',
                          '11599','88147','27061','65160','48079',
                          '53645','68287','47421','94397','77211',
                          '23260','72368','15480','71311','64382',
                          '27228','36514','20665','52912')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


