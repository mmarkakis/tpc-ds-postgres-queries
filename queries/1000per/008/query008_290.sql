
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '39594','92788','17644','96406','81081','11787',
                          '65763','52364','29423','74645','79869',
                          '99890','65421','73086','31486','35394',
                          '70632','86157','69332','55899','54697',
                          '93132','60374','63952','60874','26560',
                          '38351','37490','76250','83168','49995',
                          '37248','94314','89131','29150','68385',
                          '63913','63816','11349','33433','62286',
                          '86031','45591','68701','81759','73810',
                          '51356','82881','92149','30938','49652',
                          '30123','88839','38815','28078','60102',
                          '69542','80230','66859','98700','13586',
                          '17956','44876','81941','93682','19435',
                          '65647','73295','93479','16177','57282',
                          '78091','29453','15693','67507','22390',
                          '41834','64069','50572','31962','51442',
                          '16305','38061','64835','59573','27318',
                          '30961','72512','39578','72998','63118',
                          '79897','67403','12242','61304','30586',
                          '20973','66379','58824','45438','72070',
                          '98216','42143','79126','94601','78802',
                          '18045','63873','73310','32700','91563',
                          '14332','48959','36698','31354','31907',
                          '62406','45280','20372','64452','58722',
                          '83174','70719','53685','36108','81586',
                          '43201','21448','28906','88158','50671',
                          '48409','75896','34847','46373','21321',
                          '36232','31577','59028','39434','68492',
                          '67220','78926','17485','93351','47175',
                          '21297','75827','97187','66784','42183',
                          '71958','85187','46770','37430','71670',
                          '40830','51108','98034','29295','89431',
                          '24127','93357','40944','60736','89577',
                          '40659','78056','28084','28934','59649',
                          '15879','49452','59431','11531','17565',
                          '69383','13800','29191','13935','51237',
                          '60993','40871','65653','73165','92970',
                          '51264','18828','61710','20177','80404',
                          '88567','81232','94878','18104','37013',
                          '90174','23929','94004','77556','26122',
                          '98552','19527','47899','69018','83300',
                          '77242','39154','52188','66807','13647',
                          '87037','88765','69805','48290','42906',
                          '54099','29673','84850','89444','65826',
                          '89692','75143','54536','60920','45498',
                          '77360','50627','32487','66503','61365',
                          '77411','61335','91505','65703','91262',
                          '22095','14459','60723','38466','51935',
                          '37567','49899','34932','68035','24097',
                          '31419','49289','47105','58621','48456',
                          '16424','81853','80342','27271','34665',
                          '44997','61733','28319','54153','73657',
                          '75419','87248','36359','72116','29605',
                          '20241','62350','63320','88637','40126',
                          '76459','91332','40953','23807','90591',
                          '66350','77162','67798','22701','39400',
                          '87460','82513','13018','47489','34065',
                          '55602','69340','37516','51185','36029',
                          '89021','32793','26246','65609','53373',
                          '70718','59816','82346','16207','92177',
                          '51336','80029','94817','70868','69138',
                          '61026','34810','74619','91749','23356',
                          '76969','49960','39453','44596','53937',
                          '29776','69665','41359','72739','89580',
                          '69773','65676','31259','86228','25804',
                          '82110','52273','73704','36532','57364',
                          '52940','30378','44995','70702','42884',
                          '49848','78692','53235','48356','57100',
                          '36013','85465','57343','32818','21521',
                          '88421','87880','12368','99276','51298',
                          '41161','64050','22914','23051','69042',
                          '89423','13441','94070','52192','98576',
                          '48476','96678','26823','40353','22620',
                          '40375','81184','36325','44062','61018',
                          '45859','99558','47011','51341','39105',
                          '84017','86339','57491','99789','56958',
                          '48990','21856','30096','26899','59722',
                          '74878','39271','61125','49530','21579',
                          '75837','29542','77954','93740','72832',
                          '39365','12930','60012','30708')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


