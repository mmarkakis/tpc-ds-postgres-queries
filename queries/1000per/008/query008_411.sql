
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '40313','16767','39505','19146','16710','97290',
                          '62540','98307','29470','36227','56510',
                          '92214','61024','91259','20692','49833',
                          '44357','89114','87962','55373','58949',
                          '22237','20823','73576','56476','91643',
                          '50274','60910','33697','23240','48498',
                          '14931','56135','20678','40265','48133',
                          '34386','58575','71843','87676','42530',
                          '51428','18396','92370','67380','59933',
                          '30257','81434','37518','40967','26448',
                          '39331','46602','21047','19958','60072',
                          '19080','66419','80735','90691','31255',
                          '65339','95476','90751','18596','75359',
                          '94466','10341','72369','10209','11172',
                          '34243','99235','38519','12479','21820',
                          '35171','75350','47503','75036','29216',
                          '88213','56948','20702','79720','29761',
                          '88605','35229','48895','33258','70368',
                          '37530','50509','59772','71982','72077',
                          '98487','72256','50307','72716','66937',
                          '83136','37694','22154','73522','72301',
                          '88020','71616','23986','64169','60261',
                          '37773','91792','88662','81498','96505',
                          '22765','86074','84824','10574','10787',
                          '39623','70654','22482','53837','13778',
                          '18814','19682','10485','65809','99799',
                          '83125','45873','35415','36270','85752',
                          '73400','66696','59532','78652','58655',
                          '47041','13098','42714','83334','51163',
                          '97015','70265','76446','27219','35912',
                          '76374','53984','39740','80090','50598',
                          '72711','32021','91170','93128','83375',
                          '57662','32178','24179','39745','74438',
                          '46284','71761','47531','24047','28448',
                          '92005','62169','20569','89112','12402',
                          '78546','19822','61274','81320','21154',
                          '86270','73806','50521','74643','19833',
                          '63501','13697','90250','65009','35667',
                          '51861','94225','65043','38581','55329',
                          '72627','80388','81023','71525','42225',
                          '49736','93350','37975','90165','18581',
                          '68599','14268','89029','95141','26972',
                          '71470','11586','34851','93566','54397',
                          '71466','35915','65708','33203','35968',
                          '60097','35007','51324','66444','65403',
                          '58958','54573','62706','24596','84534',
                          '91065','99731','84906','89319','92039',
                          '72195','11567','13402','97019','27478',
                          '90151','66857','34748','49145','40820',
                          '24221','96703','35076','11785','26921',
                          '75543','78342','31565','60522','56486',
                          '93951','47173','49411','55161','18679',
                          '86803','88877','67450','89023','69209',
                          '90773','81619','32070','36209','27149',
                          '68464','12766','38326','44135','71528',
                          '62654','69606','60267','90119','53791',
                          '11087','40019','36441','22343','61951',
                          '97358','32219','59823','56187','91572',
                          '12230','59367','98330','21391','46034',
                          '12662','31609','75049','86738','35112',
                          '86956','65712','93476','44059','12878',
                          '51930','17593','25835','25117','88809',
                          '89931','87475','70094','95525','38737',
                          '14761','62061','37020','49253','40957',
                          '74322','15513','89883','47653','42416',
                          '16475','76053','89232','16560','65059',
                          '91690','56290','40587','72205','97923',
                          '13254','57131','70282','51575','41111',
                          '58835','71196','93098','89746','39233',
                          '54249','75668','19993','59814','83542',
                          '51824','13261','60537','78658','48504',
                          '38852','78645','71887','77356','38386',
                          '34416','89466','19573','45720','34961',
                          '87212','32002','77189','89991','65595',
                          '11514','84291','39216','99879','49248',
                          '51111','68408','46233','95488','13655',
                          '14110','58957','36141','15007','19757',
                          '61542','14523','45164','18496','81732',
                          '74255','69992','74906','81936','81380',
                          '48081','88059','52215','84928')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


