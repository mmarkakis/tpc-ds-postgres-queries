
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '35004','59557','12397','26724','95851','84960',
                          '29802','93558','79968','48759','71779',
                          '59857','48658','12537','94879','99501',
                          '70116','20796','39424','13981','50006',
                          '33776','36327','60192','82560','32787',
                          '96776','70928','77386','96064','20088',
                          '78944','66468','29641','84147','64682',
                          '60362','34366','65503','47631','95025',
                          '83781','67183','50704','47786','50476',
                          '98348','22127','62630','16225','38276',
                          '55499','72355','27216','61498','86930',
                          '35097','10984','58309','81635','71505',
                          '62378','40601','87336','68100','44488',
                          '74634','62103','25338','23852','68828',
                          '63855','73363','55573','39272','55361',
                          '18859','63408','15283','58967','11644',
                          '47330','85708','83500','50867','35843',
                          '66710','29661','43761','99716','47654',
                          '14141','50615','35753','45163','69477',
                          '78870','54340','71072','73887','98489',
                          '36643','64482','99280','39586','73072',
                          '25733','90037','96294','82363','86558',
                          '50543','83552','53144','14372','37150',
                          '56833','83017','22947','50894','34858',
                          '81676','54976','59170','20056','88578',
                          '35612','89619','29883','55975','65363',
                          '59893','35937','45222','21113','67130',
                          '94742','56880','50802','68331','60918',
                          '88135','72647','26845','14362','49295',
                          '14296','76091','74079','81909','12177',
                          '84464','42553','15653','58219','97423',
                          '61606','45103','63090','28560','84290',
                          '25062','98828','96284','50535','76421',
                          '51407','22979','14164','40699','68334',
                          '40614','13463','94696','11851','31457',
                          '41423','38653','83279','10524','77293',
                          '37430','78415','21279','75514','60237',
                          '71790','58023','47807','22019','43453',
                          '25915','11748','71925','47915','65492',
                          '93880','93223','78910','94564','38282',
                          '98463','56708','21495','64388','31491',
                          '81838','15516','21763','31323','15224',
                          '84807','62909','98252','50798','84773',
                          '48915','12658','45784','45456','28176',
                          '55551','49257','38865','28393','86618',
                          '87324','76833','67297','21802','12445',
                          '39238','14545','10330','39118','19098',
                          '56437','62305','15784','57665','33157',
                          '18778','15768','64248','33490','93907',
                          '22154','15390','39031','29927','23612',
                          '82722','35526','33567','35592','72172',
                          '58180','29527','20948','19436','95658',
                          '60668','15710','24362','12734','43601',
                          '41919','18617','44774','91510','51590',
                          '56648','32642','98860','79102','46758',
                          '48079','65178','94778','84081','91833',
                          '46093','34976','30947','63298','45035',
                          '64324','82729','95472','16016','98659',
                          '10892','95303','78174','74892','52798',
                          '94930','76929','57129','52190','75146',
                          '70948','55570','33287','28934','26911',
                          '18246','34531','96668','42215','40446',
                          '23387','13824','99690','40584','82275',
                          '49566','88391','38178','37979','12944',
                          '77664','55117','84246','90457','16653',
                          '32447','59585','59250','22408','62531',
                          '84360','66232','28848','36668','30600',
                          '81757','31513','68591','93249','52491',
                          '88956','43065','45752','86879','58702',
                          '53809','90857','82531','79236','33251',
                          '14161','21547','22509','92517','14900',
                          '22847','35003','13046','52548','11014',
                          '58780','96278','91205','61062','18522',
                          '71291','71202','82228','80599','79232',
                          '93891','60976','17495','57914','96908',
                          '29923','37893','30905','69798','52888',
                          '77358','17076','69453','25495','58001',
                          '26698','65447','38453','15855','89359',
                          '42882','77939','51809','54957','75161',
                          '90734','88549','74545','83941')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


