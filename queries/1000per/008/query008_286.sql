
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '61214','93014','55350','20276','89181','28111',
                          '75211','44657','51729','91639','89764',
                          '76079','30453','57219','15859','60800',
                          '90500','19424','55814','38938','54177',
                          '97110','45990','96146','44321','59048',
                          '93507','26598','28406','96411','30734',
                          '17657','69105','58843','67828','22910',
                          '23387','78139','17967','30091','33520',
                          '21711','18493','24169','72177','15838',
                          '11052','82388','48785','42627','12610',
                          '69514','85439','31136','38251','44978',
                          '26810','27374','50387','31186','91946',
                          '70238','85396','39341','66982','74451',
                          '11278','84029','53685','29297','41896',
                          '54992','12988','59477','95089','68180',
                          '55525','49341','65337','92083','58458',
                          '24573','36159','23351','27248','56072',
                          '45656','97594','45336','42426','70204',
                          '75339','86035','54587','77281','73524',
                          '32371','13460','36558','87706','90221',
                          '41639','39666','80906','52539','41576',
                          '36001','14532','92370','84335','96650',
                          '36772','74423','92262','85960','22731',
                          '96925','15195','58138','79226','88312',
                          '37897','47823','12223','16288','27520',
                          '84985','58774','15770','25856','40524',
                          '80366','55918','61990','56867','16370',
                          '84614','43476','25991','79503','66416',
                          '64039','97084','21741','20624','73296',
                          '45449','90278','14183','69665','76640',
                          '97351','40035','77843','58035','16141',
                          '45930','32465','88834','89802','95247',
                          '87879','83191','25699','94137','49648',
                          '50927','19287','20760','92028','11969',
                          '53593','41413','70308','46820','70568',
                          '92394','42547','32931','86823','53028',
                          '66496','21956','61117','50411','60218',
                          '11471','71857','89338','84120','61255',
                          '73080','38295','93398','41550','87532',
                          '16403','65251','87921','57266','55531',
                          '27788','59841','78096','76566','47763',
                          '63855','27820','80259','59376','48844',
                          '91028','59095','31981','84378','92417',
                          '29651','43920','45012','16522','40205',
                          '38708','79056','53278','75195','69437',
                          '76335','60565','87589','94739','84219',
                          '54313','33040','25117','86358','71665',
                          '95143','51951','89586','13472','67259',
                          '78320','21928','73757','91309','56044',
                          '24000','87271','71982','59611','89656',
                          '53911','91649','21114','29437','45434',
                          '92658','45290','69499','60246','72106',
                          '56355','45088','96812','25263','70778',
                          '58210','12035','97135','34459','67232',
                          '18252','45361','66499','88802','77832',
                          '75513','22761','21361','36822','28661',
                          '66923','89392','97950','40190','99963',
                          '71453','93615','22728','10542','58643',
                          '47219','11518','69125','86321','41476',
                          '31673','54607','56041','83042','87623',
                          '92632','79887','36605','56496','53846',
                          '32730','73965','66979','45817','17139',
                          '47641','23916','99729','68219','35255',
                          '11715','31797','54932','69541','17051',
                          '92661','40770','41116','36077','66241',
                          '44039','32835','48072','10658','33161',
                          '61595','28082','52655','22051','89588',
                          '54905','92800','47944','93565','77462',
                          '75600','18754','68717','66434','64056',
                          '66474','33421','89657','98368','83029',
                          '88895','83462','40353','45627','42951',
                          '58434','82822','38067','44046','12645',
                          '51535','91479','13935','79687','49775',
                          '72122','98268','91073','86587','18300',
                          '18372','53810','31392','64248','25147',
                          '26842','26503','43066','98941','60935',
                          '40312','22117','48266','91783','43093',
                          '19739','36626','14385','99078','61100',
                          '54520','72880','93913','19319','71742',
                          '83521','12889','71386','22309')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


