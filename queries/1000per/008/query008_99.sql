
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '54007','94588','89866','51778','52042','15318',
                          '49140','10866','90704','86676','27830',
                          '53995','49550','16457','73794','70832',
                          '68607','84754','91214','61728','23780',
                          '26554','20956','70291','77031','57403',
                          '25128','88570','91152','93092','40984',
                          '70547','33657','75372','19521','96047',
                          '40214','66702','35021','15602','99809',
                          '57758','63248','13927','17572','67840',
                          '55613','40012','45836','57373','69960',
                          '86115','23765','59963','45951','67267',
                          '20734','51100','92609','47628','40044',
                          '57869','56848','86702','86747','12136',
                          '64287','15895','81960','81410','62854',
                          '68115','35332','63506','14488','15633',
                          '84655','59121','57914','84390','23849',
                          '19878','74339','34495','18510','42082',
                          '77799','54977','25716','76482','82748',
                          '64404','11444','29281','30122','82092',
                          '93445','42228','66992','37219','73710',
                          '54300','63241','20439','35683','91597',
                          '29559','45841','62521','96765','71581',
                          '19626','15310','93585','82186','79363',
                          '84476','30125','49090','98218','34493',
                          '41770','22181','98303','87045','42263',
                          '28087','24281','91707','92702','55026',
                          '44475','75092','19512','52523','76969',
                          '19887','29315','91774','39522','23965',
                          '82747','47886','34365','95615','79297',
                          '39824','75262','24190','43200','39800',
                          '32775','69013','37923','81321','46832',
                          '72612','72477','77208','26283','12443',
                          '84873','95952','26552','83981','88366',
                          '48602','49377','57007','44942','77245',
                          '14283','67448','76011','84120','22473',
                          '99737','61040','57254','21159','82290',
                          '91677','40394','81419','65788','62049',
                          '98876','44600','38001','42832','98735',
                          '61074','37729','31150','45845','57441',
                          '51004','96708','33974','81165','82481',
                          '52058','65656','63377','85018','71031',
                          '71133','15978','26928','30306','68556',
                          '47275','47118','81656','12285','85966',
                          '36469','79253','51150','55636','14328',
                          '25531','62434','96908','21313','23810',
                          '56000','29064','92789','60659','95037',
                          '66002','42570','66719','93499','39562',
                          '41573','10887','52384','88942','95670',
                          '53047','51628','47589','45307','71460',
                          '31253','80590','70754','48056','60782',
                          '24485','22298','67823','99457','60607',
                          '40020','26139','76038','84339','50231',
                          '55705','61377','24451','27302','14437',
                          '84017','88176','39091','37791','15899',
                          '57698','62510','67089','48325','26366',
                          '26767','24189','48470','93736','77160',
                          '30154','77006','75778','17009','45651',
                          '96982','20667','66874','54235','16943',
                          '60118','97203','46754','97711','10864',
                          '14687','36037','67757','75355','61937',
                          '69166','48861','73406','79345','24444',
                          '66615','56516','51918','42423','30905',
                          '96757','99940','77773','14720','87059',
                          '37383','76452','31091','42807','16198',
                          '63629','13656','65691','36972','95265',
                          '22318','50924','45402','69934','13134',
                          '47682','16186','26955','30138','89585',
                          '57345','27050','33769','13238','13396',
                          '85651','87212','38070','67244','12823',
                          '30594','21047','49524','71052','45947',
                          '52681','39574','76280','52884','42519',
                          '66866','70032','70784','20694','65301',
                          '33078','99131','28041','80920','53555',
                          '34803','56569','62706','88388','74164',
                          '79978','43140','27294','97964','51675',
                          '62112','46101','53832','31796','27741',
                          '39236','44036','79901','89694','34916',
                          '85894','70568','30572','80931','21618',
                          '32708','96109','95521','64049','10335',
                          '30535','59382','84334','76465')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


