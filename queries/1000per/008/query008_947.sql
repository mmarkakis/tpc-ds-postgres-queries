
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '37562','53582','82676','57783','31870','26295',
                          '54617','54915','41122','25820','77828',
                          '82135','26428','92753','79649','86807',
                          '85215','17555','12244','63856','28111',
                          '97012','78774','81844','79750','74876',
                          '11474','99818','21753','69309','84185',
                          '44586','72723','55961','38031','74105',
                          '64442','52281','29060','75823','16730',
                          '23536','65889','87401','91437','39228',
                          '24017','41569','73423','70657','74997',
                          '65408','33937','83596','49816','36729',
                          '47614','49030','43466','59558','82345',
                          '42782','43181','37461','61666','68676',
                          '21258','19320','19337','17269','77038',
                          '64565','42962','84805','13008','49186',
                          '19799','36623','14772','55024','16995',
                          '99131','38670','59358','55148','20247',
                          '60145','19468','60023','72011','28096',
                          '61554','11262','81331','58733','38374',
                          '18463','93179','21914','11195','13863',
                          '62785','50313','73964','70797','94985',
                          '60862','25364','83052','35343','11079',
                          '61732','72317','48177','27318','70892',
                          '77736','24319','21684','80326','58035',
                          '27618','86514','80118','20981','10149',
                          '39942','69114','66199','93379','40351',
                          '65401','75496','11430','52841','16165',
                          '82926','37488','30155','39050','96548',
                          '81058','67320','80169','42214','15675',
                          '83863','49556','20718','56999','83525',
                          '43035','26910','73967','16333','40710',
                          '78501','43948','70879','32621','99675',
                          '69368','25431','31073','98036','91995',
                          '24107','97382','85853','57953','10069',
                          '80358','54746','95047','56279','13964',
                          '99273','91067','63224','27432','90876',
                          '11116','45919','52615','73257','42840',
                          '86281','54869','89508','66768','57322',
                          '44451','27617','73271','90710','51484',
                          '52794','25736','74803','81582','95917',
                          '85909','26659','86887','26766','22849',
                          '52906','90320','53001','87668','74851',
                          '23266','10209','54026','69054','53934',
                          '50418','35007','30771','63125','45536',
                          '87503','45218','26779','96001','51956',
                          '73085','41994','94471','98955','91502',
                          '68151','56579','62498','63709','70025',
                          '62555','83680','70444','28874','27529',
                          '91601','81033','98158','55887','47078',
                          '56388','11399','32168','73508','33887',
                          '31927','39933','62569','15979','20941',
                          '46638','58344','65331','99799','10435',
                          '93790','96569','21191','35243','34597',
                          '98843','88904','82693','34398','71474',
                          '27499','22163','34981','92618','71906',
                          '65570','19914','69453','38473','29815',
                          '33798','51195','21667','70302','89729',
                          '75992','79673','95851','28046','75811',
                          '69909','97108','83201','61752','41112',
                          '38595','66457','68729','24374','62791',
                          '14936','99667','25366','82962','79902',
                          '79565','68314','55110','92776','18923',
                          '62349','94109','77017','57013','72040',
                          '45365','22885','62862','21593','24790',
                          '13584','15575','54969','47574','51078',
                          '33031','88772','98624','17949','48132',
                          '70182','84218','74796','47560','71613',
                          '23110','27538','12868','48605','39501',
                          '79240','54589','22552','18904','11034',
                          '68085','18760','28929','12043','57072',
                          '11129','28013','21439','71145','86226',
                          '44995','70384','61556','63912','90805',
                          '87399','18769','78302','31700','54970',
                          '48329','93429','71495','32744','35178',
                          '15624','53060','76542','99594','45078',
                          '10923','52210','55990','37781','64172',
                          '58099','72773','63430','59115','62261',
                          '74184','27824','92459','58181','92667',
                          '73475','92972','39070','36374','97856',
                          '82186','13012','23305','65552')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


