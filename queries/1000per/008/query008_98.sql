
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '22888','98101','84089','70677','22407','94070',
                          '20977','76393','74710','82097','79596',
                          '71734','59103','52019','51156','82036',
                          '49122','44077','18542','79396','48569',
                          '66015','79406','83911','66118','89249',
                          '71824','84242','91412','31408','74929',
                          '72390','37809','83015','15801','59034',
                          '92898','38713','54597','82243','26401',
                          '84565','39917','45371','23351','70724',
                          '23836','60612','61260','27692','34923',
                          '97153','56819','13500','67946','34319',
                          '81672','94299','83843','59133','16266',
                          '89661','28984','49789','21547','73148',
                          '49130','70016','13561','62777','69253',
                          '53269','24395','81639','21018','67414',
                          '84966','35947','17143','88357','93594',
                          '87689','26385','38584','86013','20781',
                          '49436','63260','54613','71966','59509',
                          '74880','99959','53592','19351','53336',
                          '40592','94683','33750','78224','16861',
                          '81617','28255','22999','88126','66494',
                          '30692','11734','97950','62929','32743',
                          '45310','83963','20853','79014','84393',
                          '66506','58923','66390','70527','92316',
                          '94650','54524','91455','53598','46905',
                          '63966','84457','41244','65312','80460',
                          '40725','85152','18917','79810','73807',
                          '20268','42266','84349','29802','34048',
                          '65159','96995','47726','11646','21691',
                          '50625','69660','19488','49277','52779',
                          '43122','72448','35189','69424','85630',
                          '34886','95022','49323','17155','38697',
                          '44167','89591','94792','38081','74552',
                          '51168','31387','28855','55100','32659',
                          '32489','52253','50230','52038','96281',
                          '40971','48213','53590','91325','85210',
                          '71481','28223','19960','49469','85849',
                          '62956','11357','87006','14651','90822',
                          '56601','47381','43662','76955','11681',
                          '79206','76689','54538','69775','24765',
                          '92335','63204','94817','83374','24543',
                          '23931','48002','40210','52298','39774',
                          '50824','98045','13742','55954','95952',
                          '78248','64895','52361','36778','59260',
                          '28639','39513','94770','94591','66404',
                          '19841','21085','21804','42243','51234',
                          '62397','94262','13552','33764','96269',
                          '89778','17066','65058','41752','45629',
                          '97240','15032','50783','85543','80952',
                          '73734','76911','49905','44783','96038',
                          '64070','69702','58756','49579','99457',
                          '74804','19831','27129','30341','54895',
                          '19678','93395','41026','37675','64579',
                          '91493','25346','40506','49966','48335',
                          '27856','21745','27056','31386','11380',
                          '62182','86465','18194','74434','25069',
                          '33121','58184','23260','90635','38676',
                          '32941','99459','20740','44487','27731',
                          '91113','35190','84436','30468','16008',
                          '28559','73584','22923','88954','35018',
                          '82726','44426','90357','96958','33958',
                          '48996','80190','42216','77649','33153',
                          '40190','81699','29460','24010','52666',
                          '50321','65683','22354','64317','70791',
                          '21961','62917','12806','33801','43759',
                          '89756','77090','11198','44247','39866',
                          '33669','13008','74085','79980','74113',
                          '89153','93350','91908','67997','40149',
                          '86565','76670','40547','91747','46387',
                          '86542','96749','10473','97074','24478',
                          '21306','65518','55803','92328','68256',
                          '56009','62665','26540','41015','89184',
                          '96679','63269','11182','66119','90883',
                          '80429','72598','36191','34971','93092',
                          '96627','60516','23507','69047','52568',
                          '57243','36253','47798','98664','58964',
                          '13838','89971','90067','79040','13776',
                          '93188','95260','60087','66216','86069',
                          '46143','49662','19228','49059','90929',
                          '86102','72201','10569','15080')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


