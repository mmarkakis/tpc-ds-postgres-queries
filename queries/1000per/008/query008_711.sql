
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '87174','72495','22772','90659','76147','97626',
                          '63608','92344','30372','12758','62302',
                          '38451','38712','95490','28057','96846',
                          '54612','24333','13186','65320','99980',
                          '24472','89326','10972','59075','94971',
                          '35924','62303','83391','95000','26332',
                          '10468','66547','81277','78951','44730',
                          '45897','19848','28504','89053','52939',
                          '70889','12415','38427','98361','83635',
                          '10922','74554','95076','66826','29014',
                          '43844','66211','19108','10806','92920',
                          '50193','59006','97979','25366','62080',
                          '71653','73493','26771','47007','72525',
                          '96541','52817','80373','31519','74111',
                          '99790','43841','34461','30440','11176',
                          '88838','12494','91062','15058','51661',
                          '24389','71455','46479','89928','55805',
                          '44796','62252','96370','33498','21158',
                          '15073','29306','70707','29627','71583',
                          '20582','24617','72921','74224','37740',
                          '75316','40567','24604','98895','18017',
                          '37662','34472','34611','13753','32991',
                          '50185','43300','66943','78008','89200',
                          '66806','25906','18622','59997','84235',
                          '42973','40441','56169','94532','83458',
                          '83074','36444','64328','74459','76105',
                          '81692','36077','64036','74575','92019',
                          '40225','27807','14945','17402','13695',
                          '77540','75550','62178','93024','55409',
                          '35001','10028','38506','42558','31454',
                          '64161','90842','50540','71794','93504',
                          '68060','12597','22646','35982','52063',
                          '32126','37229','37938','25669','33679',
                          '74838','15325','47983','78583','40128',
                          '81240','63494','41551','19416','39301',
                          '82742','20875','22542','19824','58189',
                          '93144','78671','16685','13280','74819',
                          '18193','94189','56283','86822','78630',
                          '19596','61089','34393','33238','94447',
                          '59855','44067','97496','39994','43786',
                          '20026','41083','56311','41738','58287',
                          '25757','80014','24847','40184','61259',
                          '22531','64240','31624','57766','35221',
                          '63672','29750','48030','83052','47350',
                          '85197','60453','85378','72716','76698',
                          '71476','91133','51358','84003','63586',
                          '98777','37942','28104','44606','73930',
                          '10647','99202','56453','44427','26597',
                          '72714','38818','14896','84533','49231',
                          '68759','94388','33689','49951','34239',
                          '92607','76836','64193','24633','46632',
                          '47173','20145','60514','28858','70200',
                          '61469','67629','20739','62315','14210',
                          '12882','22291','47436','72091','36332',
                          '81995','20072','31785','23573','28243',
                          '97334','93508','85291','65262','86361',
                          '48366','77312','13398','17865','51601',
                          '28717','20069','40116','36680','95217',
                          '88869','29979','57925','17300','77306',
                          '18947','97314','66513','86941','91915',
                          '67260','84954','68930','71302','23547',
                          '95055','64743','95428','42916','47401',
                          '38956','69931','44440','43923','14158',
                          '55528','76475','84437','35809','36568',
                          '32590','73568','15191','67786','14338',
                          '42806','60613','31251','99256','16995',
                          '58470','56669','50026','64701','58681',
                          '58406','25777','33115','56035','58990',
                          '91220','20315','85542','34449','40562',
                          '76001','59379','78664','88075','90127',
                          '73403','93969','34538','28660','35527',
                          '35488','41823','53802','86119','81040',
                          '48658','41064','45966','97420','30944',
                          '67994','92855','50317','58361','14069',
                          '23501','68367','84682','91238','87148',
                          '53263','24765','33536','60132','40577',
                          '38693','49763','25091','66789','46813',
                          '36763','33722','21812','21719','31955',
                          '88453','60617','97220','76502','29870',
                          '25257','56933','24885','90493')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


