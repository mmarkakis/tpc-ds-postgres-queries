
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '23505','27651','90687','71631','50132','80791',
                          '59183','64341','91031','21666','19635',
                          '41271','89537','39675','68289','73868',
                          '51498','79622','61327','36236','56396',
                          '65260','93541','95351','33840','85658',
                          '26420','72649','44832','45686','88086',
                          '65482','95114','28584','56108','36561',
                          '95250','40911','95481','40407','97917',
                          '46516','50958','94749','33243','72890',
                          '19282','60114','82728','17825','79311',
                          '61591','21824','17251','48445','82159',
                          '85207','19451','39154','20139','72548',
                          '99253','56472','24154','62284','17413',
                          '76927','10965','38188','98906','62537',
                          '31686','76706','60256','71132','48753',
                          '63571','74297','18952','80453','89803',
                          '88287','93639','16250','77603','15201',
                          '61995','77139','27095','70164','96766',
                          '56042','17408','25718','43958','98173',
                          '75488','69627','50626','59091','92676',
                          '73308','77082','56007','78114','95802',
                          '62786','46451','53813','35157','31602',
                          '91155','69282','38484','17052','83548',
                          '32909','27311','55344','73370','64511',
                          '24766','47960','93424','81236','26400',
                          '20277','75541','39755','55090','47019',
                          '85980','61178','97964','21293','21098',
                          '46371','31790','41813','37450','63651',
                          '33607','74170','30172','42165','85104',
                          '25772','17389','60947','60216','44867',
                          '90166','35237','37696','57433','36396',
                          '37837','99766','81868','44720','11858',
                          '92072','50993','43325','15064','79033',
                          '74984','51481','61241','38618','97803',
                          '70332','77467','45115','40593','64057',
                          '81913','29530','13675','89649','88603',
                          '34913','26093','69550','81802','25013',
                          '61019','74509','94156','43554','29709',
                          '41852','72558','55822','41636','64037',
                          '36642','85775','42680','60763','66946',
                          '40606','73410','35403','87011','11871',
                          '68460','22722','26101','52853','84099',
                          '78024','79483','54034','67423','99015',
                          '78660','20642','12360','50431','54406',
                          '55988','90480','53564','81725','90020',
                          '42204','69218','30775','40779','96351',
                          '16425','51853','79136','52544','14509',
                          '47280','44596','39601','89496','58115',
                          '31168','67733','21022','48722','46729',
                          '48857','18974','83408','65257','21674',
                          '79734','43008','86762','12279','76143',
                          '71667','46440','29495','57255','75190',
                          '92264','38436','37434','98024','99842',
                          '60283','93953','10163','66164','72789',
                          '62011','19250','26899','33941','70540',
                          '64580','21714','93574','86998','80339',
                          '69082','91487','71919','63302','89787',
                          '64528','20105','46814','49259','69498',
                          '51901','44843','77411','87239','31998',
                          '97198','64586','16198','21571','17587',
                          '51688','15587','59550','92828','16383',
                          '29694','66998','24291','21532','31250',
                          '14488','48963','20870','67597','37428',
                          '17124','17619','51319','54573','54172',
                          '86785','87678','25979','71046','70751',
                          '75835','81013','58045','69075','78485',
                          '18074','78947','98831','78000','45301',
                          '99354','54303','36609','44565','35131',
                          '88950','14090','12073','32748','53134',
                          '74320','59470','21966','95620','38658',
                          '51361','32264','27283','50905','20748',
                          '61510','28286','57445','87983','73448',
                          '30223','79588','39564','53878','46069',
                          '76589','16904','19362','62988','61103',
                          '44722','13410','76000','94373','17437',
                          '99420','56700','73089','79012','73594',
                          '96073','94141','67288','40565','61521',
                          '58209','65917','44507','97252','62211',
                          '52476','80176','49422','57737','52487',
                          '55524','73424','14791','82414')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


