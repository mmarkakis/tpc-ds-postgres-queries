
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '65125','76885','30732','46366','15956','40541',
                          '20747','92862','94885','51402','56688',
                          '86127','37072','29829','33154','68779',
                          '85766','88963','15445','57387','84566',
                          '53275','61164','83447','47583','43931',
                          '44013','67309','20872','12505','50566',
                          '84150','92640','29988','48740','82363',
                          '90198','63253','54116','67885','92107',
                          '98900','79035','54508','62864','75648',
                          '28115','18785','77993','73632','99246',
                          '39708','33321','33265','63300','34967',
                          '54906','31351','52655','33914','91874',
                          '13799','59308','24812','40743','77119',
                          '37127','19799','24900','11069','74399',
                          '98342','28391','51065','73214','49101',
                          '97143','84637','10890','78846','95544',
                          '39308','89936','64158','79648','54087',
                          '70380','80114','19060','39100','46460',
                          '35201','18335','13613','25038','66623',
                          '50676','54665','70611','47966','40044',
                          '82420','10897','79977','14195','94989',
                          '53377','90658','99262','32325','88605',
                          '14493','56907','65541','38778','21207',
                          '42484','30231','28332','28213','40068',
                          '15028','60117','39462','70126','55315',
                          '92361','55857','75418','14882','63281',
                          '25363','10879','31993','77690','11036',
                          '85955','21182','90874','22029','48366',
                          '58333','55364','70390','74371','61581',
                          '30730','22402','12390','91050','69431',
                          '46645','11812','37326','49679','48791',
                          '87002','42489','93684','73221','70419',
                          '38916','36928','43676','67726','11326',
                          '95904','45447','50906','30861','27886',
                          '76274','19802','39382','41881','99572',
                          '99154','75955','52238','71664','67993',
                          '11295','19368','46479','88122','76524',
                          '64861','88502','24419','46718','54281',
                          '36296','39694','75093','36440','35628',
                          '46049','13801','90634','94778','69244',
                          '62832','77891','85533','31216','43324',
                          '88224','71463','20663','56904','50678',
                          '62343','91228','26034','52022','22930',
                          '34549','63582','48373','56217','34274',
                          '26008','83238','60144','74010','63700',
                          '93984','84298','79766','64308','78770',
                          '58144','39012','48705','27383','70355',
                          '44179','80697','76648','27187','74256',
                          '86714','22875','24023','19925','16818',
                          '13637','97311','54392','41381','97175',
                          '37791','66696','53601','33459','66982',
                          '51417','95024','63366','64431','38901',
                          '31228','17724','80489','67701','96286',
                          '49176','82262','38252','52735','47197',
                          '13702','17756','26789','38038','80580',
                          '18390','44303','78951','73334','31852',
                          '75262','72236','44157','23182','44268',
                          '73394','28299','27155','21705','40678',
                          '18611','44091','30177','92452','99062',
                          '90520','82928','34697','42914','10774',
                          '24942','49145','25442','75781','96508',
                          '92355','53859','59433','62427','54936',
                          '44874','88174','53404','33844','69926',
                          '29941','13471','86454','87948','53681',
                          '95640','36729','55405','68452','81390',
                          '94290','55439','61174','58341','40407',
                          '40165','18918','75734','50890','46909',
                          '81167','98281','58377','73588','89687',
                          '42724','56465','75115','22673','43973',
                          '88790','55891','92914','25609','30476',
                          '79036','65632','44501','47053','61837',
                          '65629','57981','27834','61647','61176',
                          '43369','96832','90875','40693','90076',
                          '10646','36380','84131','22553','20525',
                          '89265','26616','26260','56883','88664',
                          '79149','47694','51694','17420','32372',
                          '79965','54904','50532','42080','72172',
                          '79353','40636','63993','94832','53838',
                          '53912','59759','14495','56620','41469',
                          '81029','43703','60770','45020')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


