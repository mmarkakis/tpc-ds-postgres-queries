
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '10265','65077','18363','50702','75295','41628',
                          '20329','53216','11614','41747','37266',
                          '32969','46999','26203','89110','51528',
                          '42837','82390','66354','65080','24201',
                          '30561','12084','95045','15424','13975',
                          '87197','95098','66352','47878','97817',
                          '21335','46803','36390','82736','84406',
                          '83524','48820','61811','41115','64876',
                          '58867','67818','26077','71130','93514',
                          '29530','60542','19442','92404','81080',
                          '45887','99645','87195','90162','35097',
                          '12576','64905','56026','46498','42410',
                          '44790','47356','32664','36372','93470',
                          '70624','58298','22028','57618','93718',
                          '24040','43391','89365','20264','87374',
                          '44586','41702','56444','42604','21614',
                          '34524','80037','79074','86362','15629',
                          '69697','77670','34072','59817','58170',
                          '97270','37600','97098','67454','71402',
                          '42121','97785','27976','14641','10703',
                          '19207','44061','65987','41142','65984',
                          '33166','77444','19512','32127','76551',
                          '79531','68195','95953','54577','22118',
                          '31380','60260','85097','67075','28370',
                          '76003','41379','12206','82488','32996',
                          '80431','22053','90423','98393','96232',
                          '33863','83945','74185','40836','55916',
                          '53536','70169','36767','52058','11463',
                          '25774','32520','19061','32298','77900',
                          '36472','15115','34402','78962','56717',
                          '65249','40880','93693','85361','87090',
                          '76688','20469','58306','70119','45639',
                          '72839','32837','23426','19437','71528',
                          '44850','28883','31320','60642','95308',
                          '37197','64409','24181','31702','95491',
                          '88990','73757','44080','33252','22691',
                          '69614','39010','84874','13033','62769',
                          '98100','39418','30708','85585','35085',
                          '69148','88364','94690','18234','51098',
                          '61037','97003','77309','91338','63123',
                          '90371','59912','91722','44830','42261',
                          '47668','37006','74721','11951','60147',
                          '55729','56029','87092','32019','12151',
                          '62917','70817','97046','54245','90132',
                          '53039','50870','14244','49240','19735',
                          '98279','11231','42382','84043','25022',
                          '83490','63608','26072','41218','22867',
                          '35534','91480','57934','18393','17351',
                          '79221','10253','41730','73612','63605',
                          '24154','64117','83274','29558','54692',
                          '68120','73847','64936','91252','11302',
                          '62503','20013','13376','73966','46268',
                          '41073','10353','84080','34146','57914',
                          '61249','67038','61084','19056','48101',
                          '21402','42803','19096','94534','21801',
                          '83149','92435','37361','84464','33806',
                          '10496','59159','97756','41208','66137',
                          '30631','73658','53604','88987','61985',
                          '98769','23810','82826','27866','59021',
                          '22675','79659','97512','76679','86559',
                          '53840','17441','65879','26453','14730',
                          '30435','53338','82042','80953','98006',
                          '67000','23706','60770','74326','53326',
                          '63612','38031','56840','26178','47831',
                          '85548','66623','84660','10151','75082',
                          '65601','23207','86744','28739','26695',
                          '67829','12426','51934','63162','19413',
                          '16243','93854','81847','17316','70179',
                          '85399','77179','57109','97051','22678',
                          '40866','90706','78494','70524','20396',
                          '75515','97886','33394','96369','47977',
                          '57235','95272','23577','35357','27321',
                          '68124','83669','95213','46316','64424',
                          '71137','38132','37154','79189','35561',
                          '81115','28741','84547','83541','19549',
                          '73258','79660','51887','75178','17410',
                          '41348','63875','61439','42110','90459',
                          '36751','22321','24316','55467','76862',
                          '75248','25240','28694','64763','58237',
                          '97727','99404','97280','87007')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


