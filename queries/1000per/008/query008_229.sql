
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '44434','73509','54240','96507','10507','10473',
                          '52072','15925','85050','60241','21225',
                          '23720','33022','72676','83349','63037',
                          '91615','54673','21077','86240','70104',
                          '60755','65551','23403','70941','67368',
                          '37776','74222','47067','38657','74794',
                          '37180','64481','90818','47194','21241',
                          '16478','42449','21599','38201','35609',
                          '74874','29414','17062','59830','90960',
                          '67672','63549','24662','55599','19279',
                          '60180','21939','63987','37966','92833',
                          '78324','70402','61821','73496','78538',
                          '42324','12192','32601','60852','94693',
                          '34626','22232','20781','26517','20996',
                          '21476','69399','61279','85852','26581',
                          '91957','73620','98449','65552','74290',
                          '63982','11126','31998','56286','43352',
                          '99095','53895','46973','11791','73847',
                          '10705','69311','32263','39417','68828',
                          '42406','46372','67299','75116','11621',
                          '15646','51608','69438','21753','40917',
                          '19367','18507','66856','14944','41502',
                          '78143','53506','70331','34203','10467',
                          '95374','15068','70258','48800','50933',
                          '36517','76841','38097','81081','56204',
                          '24898','59298','56762','80017','65793',
                          '85074','35166','25871','63410','61689',
                          '46255','52791','30460','83252','93471',
                          '78770','57660','55440','93563','26886',
                          '42385','33652','93155','48267','53888',
                          '34846','69649','49996','60296','77087',
                          '85026','47353','82386','31712','42509',
                          '74546','81104','62917','25808','84848',
                          '61025','88445','16327','17013','50276',
                          '24109','72797','42044','31827','94249',
                          '95325','37857','11381','92793','67385',
                          '60543','94911','84692','55925','48542',
                          '67128','34018','24946','23560','73667',
                          '27984','69067','13325','80624','82700',
                          '20550','67612','85524','60578','74133',
                          '34932','53035','66518','79493','78799',
                          '81542','56745','22752','96074','43790',
                          '36457','43781','60861','56005','28256',
                          '27303','50542','89785','96209','70407',
                          '45859','69791','81159','71192','98574',
                          '93101','48772','44173','35283','65092',
                          '75461','76112','46814','16886','79479',
                          '74993','56177','49226','74232','87497',
                          '74335','18159','32503','98150','52466',
                          '22347','73100','20601','84777','61683',
                          '82349','87150','56948','11529','43628',
                          '25604','54468','88766','62210','24877',
                          '97734','11315','79332','49597','84795',
                          '84433','89094','76711','58117','88006',
                          '57472','76572','36049','58382','75104',
                          '73952','61410','92352','65356','34570',
                          '41312','82561','96231','91011','44579',
                          '67857','88857','67411','14633','68458',
                          '57277','11005','37259','65937','63101',
                          '86903','90254','29068','49977','25298',
                          '49817','27972','89687','11571','16764',
                          '31865','47920','82789','18068','97148',
                          '30109','13519','31258','71450','39110',
                          '49149','17343','98107','90130','21862',
                          '27302','77057','70791','36444','85228',
                          '10636','52402','41069','85735','57663',
                          '91738','20788','14367','27854','61087',
                          '12979','71654','99199','74161','82511',
                          '70704','70732','84521','51482','94069',
                          '55758','19464','78527','30381','45432',
                          '57263','56698','69402','23646','20952',
                          '45878','29847','77524','42591','68430',
                          '31511','87162','13481','26728','91729',
                          '98877','75936','41442','99950','70598',
                          '86575','66522','58244','62544','89385',
                          '27652','91312','54531','93316','14860',
                          '56726','54956','38941','74735','40682',
                          '95403','64376','54960','10864','66181',
                          '50031','63588','98260','72732','60227',
                          '78186','22949','52529','44306')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


