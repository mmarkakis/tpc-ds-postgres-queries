
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '51399','55009','74577','26908','79301','98986',
                          '15702','29273','93703','16235','60853',
                          '27636','48573','90378','10940','96426',
                          '64645','39626','55895','52276','17459',
                          '52016','49407','47380','63895','80733',
                          '60270','66900','39766','60834','84586',
                          '16946','50298','27683','49473','99016',
                          '44717','35065','63101','81850','86572',
                          '52676','26710','16595','29805','29863',
                          '99974','25694','64982','78898','51909',
                          '50660','10180','54136','43240','61113',
                          '68667','35450','91005','23043','12975',
                          '17164','30405','92701','31002','60493',
                          '45575','21829','17811','84821','97404',
                          '56762','64469','48931','42473','36680',
                          '78128','68225','38388','80308','10823',
                          '47632','51663','68703','32477','74695',
                          '16841','33011','45216','41934','95861',
                          '99346','49800','46295','86358','64685',
                          '76222','63597','46475','76055','70975',
                          '85248','70767','33130','79289','97340',
                          '27770','91048','27225','47541','66988',
                          '42337','33285','17238','59509','40140',
                          '61371','24335','80582','20947','33646',
                          '53511','44987','57380','48251','99792',
                          '29100','15557','24170','79564','15636',
                          '68447','27506','26072','46506','18486',
                          '91356','10470','32962','80668','73472',
                          '85974','82964','55146','26719','27153',
                          '60350','16315','54913','94725','50940',
                          '43728','15716','25259','26668','68090',
                          '64653','74798','95629','98818','26540',
                          '36519','57022','62328','92256','20229',
                          '57110','76103','31069','95346','15696',
                          '21276','75334','87726','66343','57603',
                          '30666','52005','75611','17913','82525',
                          '12775','27858','85694','25735','66765',
                          '82751','52735','95082','93971','52131',
                          '69424','14647','87052','78693','71617',
                          '73416','62667','29364','29940','82004',
                          '70300','81025','51135','94509','92612',
                          '34669','56492','48871','99213','45501',
                          '64911','54383','12810','34590','72034',
                          '51247','59181','62307','76768','10348',
                          '70429','19298','47066','21028','91450',
                          '57831','81491','87809','62757','70758',
                          '96488','47639','67289','78795','98092',
                          '78402','27786','83727','59118','64884',
                          '17529','76497','20243','69708','88345',
                          '32671','67048','16066','17509','81955',
                          '51179','57366','57142','18457','55736',
                          '13290','60265','48274','79034','13439',
                          '60172','17746','16020','80115','78643',
                          '28270','54334','22251','43753','10696',
                          '14976','62489','99796','95079','12430',
                          '19172','16059','48782','55252','15798',
                          '10047','18073','95652','81445','26259',
                          '23990','75208','52293','69237','57839',
                          '84467','19226','85534','97118','19211',
                          '64341','41700','69316','59003','54087',
                          '91408','31000','93645','11556','90375',
                          '19472','49649','62952','65647','12488',
                          '43992','73019','96819','96390','27616',
                          '93814','72117','46471','56145','85709',
                          '56975','41559','78133','26618','84947',
                          '74404','13378','72680','46616','65979',
                          '55500','29099','91362','81843','18160',
                          '97105','30238','58779','43122','43081',
                          '37302','15004','77522','89085','77291',
                          '32471','53466','23047','54622','77198',
                          '77311','34554','65134','91668','64712',
                          '32565','30836','77376','20202','69368',
                          '79081','96268','74937','81059','81738',
                          '60566','41438','51664','57180','25614',
                          '69660','75092','36693','30373','13414',
                          '91987','77765','80182','84694','32248',
                          '69543','31885','40959','39137','79600',
                          '84404','19141','75837','93183','26323',
                          '11943','86132','12840','23498','96161',
                          '60404','73645','82297','77580')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


