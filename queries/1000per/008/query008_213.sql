
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '33397','32135','40522','36092','84998','53947',
                          '52897','59871','18471','83342','41607',
                          '16826','55122','67680','35549','22567',
                          '49346','20784','25262','19796','14815',
                          '83960','93360','94748','63348','76744',
                          '45595','56298','95833','28427','80055',
                          '28224','55700','87562','91206','85255',
                          '93815','62815','93917','43499','78631',
                          '51974','90570','91260','39307','89762',
                          '67661','15419','86701','99494','93480',
                          '21872','19692','60713','35340','63794',
                          '83893','38344','54782','81259','89952',
                          '31447','29085','28169','67410','92381',
                          '17543','78261','57958','41117','56580',
                          '97427','87015','48273','13610','65679',
                          '70100','25565','27418','30631','16110',
                          '34266','47397','28465','91026','73238',
                          '92330','57766','33910','78019','75162',
                          '43187','29976','52669','59106','10748',
                          '46510','98156','63911','61455','15677',
                          '98671','43739','75728','98886','88078',
                          '18985','71349','62850','28632','60103',
                          '97966','20337','25494','13546','14974',
                          '18088','90978','90130','74457','78444',
                          '15059','94684','18894','30711','91706',
                          '38694','40423','93783','87246','24173',
                          '20248','49357','42087','70178','46065',
                          '12276','38539','78443','50609','18129',
                          '61499','72039','48177','10867','11249',
                          '99427','43392','83603','35539','26604',
                          '57710','60241','96679','23692','31494',
                          '21918','27206','72935','83344','92597',
                          '50246','25801','53404','43207','70686',
                          '59744','96830','70905','46473','88403',
                          '99560','15776','86729','39493','75605',
                          '60523','17924','90568','70468','78874',
                          '89958','36690','23115','65768','80617',
                          '48202','31378','12369','32036','68495',
                          '99742','11595','29184','46663','25141',
                          '22967','98075','25259','45678','62741',
                          '14026','36185','89050','38411','91959',
                          '59625','59279','18357','70944','40453',
                          '77910','65637','95265','50475','17536',
                          '14424','27827','15020','85919','60017',
                          '76867','97621','40654','18759','34358',
                          '70999','64019','61784','75741','99351',
                          '95641','58896','48517','26197','64246',
                          '50948','22583','29099','57871','34194',
                          '36230','81514','62592','66929','35358',
                          '65867','78516','97070','23802','54908',
                          '42452','88293','36376','31610','26746',
                          '48819','38748','20586','96718','52722',
                          '20116','85299','54011','42979','94707',
                          '20111','68593','76596','74739','99564',
                          '73959','46309','45929','50964','72035',
                          '14671','79589','42485','32139','72085',
                          '93764','44247','14792','60682','50784',
                          '73213','32322','19045','56827','10799',
                          '39398','16088','47167','17022','24709',
                          '48571','79214','42125','25130','14928',
                          '17319','11453','57752','56314','85751',
                          '50194','83262','39174','28667','71605',
                          '53405','58043','26689','34118','30362',
                          '93509','63179','22215','99391','20180',
                          '58034','59273','21161','10216','88382',
                          '75257','43208','25093','49061','66553',
                          '43944','37840','79183','24093','38848',
                          '14035','38265','56249','49001','67355',
                          '51376','95181','79316','77037','40673',
                          '83382','22445','77525','30141','51847',
                          '78953','19906','79567','65152','47870',
                          '83862','12284','57359','81031','34098',
                          '89490','83466','51729','32318','12543',
                          '38726','34684','49464','76983','41676',
                          '76795','85025','40199','61035','20563',
                          '14006','76063','20305','30832','44809',
                          '31371','83916','79854','57584','95327',
                          '56695','29206','19229','31981','51363',
                          '11771','31647','85086','62365','72979',
                          '15521','45474','59880','56644')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


