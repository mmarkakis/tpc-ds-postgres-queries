
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '36736','35674','66981','44107','61629','88281',
                          '44087','69787','65775','26658','66719',
                          '88296','50711','22461','90669','73414',
                          '65312','81324','46699','90191','14305',
                          '87007','11571','35175','88299','39955',
                          '45014','24019','44153','36893','53872',
                          '64281','26015','14625','16519','33603',
                          '23010','88771','15138','27301','94577',
                          '41085','30948','19971','64934','87420',
                          '12793','65398','78306','80872','97838',
                          '95445','33098','18710','90181','20394',
                          '62621','23541','36741','16221','43816',
                          '20696','54948','69827','66307','68211',
                          '60871','43181','29917','45892','65438',
                          '55081','50596','55028','68928','42609',
                          '83484','51164','27936','80019','48580',
                          '31586','26140','58354','89226','64107',
                          '48132','65330','46178','29100','38167',
                          '31655','43585','76117','64948','49375',
                          '35997','63508','91211','30053','83271',
                          '79013','36430','42243','87972','75003',
                          '33451','70055','31230','61233','56714',
                          '70430','96049','86971','54113','59856',
                          '19585','39843','98470','89529','98043',
                          '66474','46182','99764','33341','74633',
                          '36617','84281','90216','80131','51734',
                          '64463','51891','82205','73945','46601',
                          '28547','51826','39369','28568','21573',
                          '32285','14963','71491','75809','15763',
                          '31594','40757','86518','14676','64908',
                          '30365','10905','57089','77968','53313',
                          '48425','25273','70888','10815','42174',
                          '49896','54683','59318','69367','83968',
                          '24027','17195','41524','53952','35629',
                          '59487','81159','49660','85173','85120',
                          '36896','83971','86883','40553','64394',
                          '67668','99243','90208','56530','77412',
                          '80288','99908','11833','30387','79621',
                          '13900','27693','59090','32022','67672',
                          '20091','98512','72502','70785','45050',
                          '55058','60245','22376','69366','87156',
                          '64950','17502','30884','65423','57379',
                          '78045','29543','48196','83402','30189',
                          '53822','65663','24666','43253','45914',
                          '21519','23821','45937','33177','13018',
                          '49848','74010','94430','52807','88452',
                          '13815','30146','25318','91530','70629',
                          '69093','54049','45490','92843','45924',
                          '99200','55140','19828','67420','73999',
                          '55503','50580','57721','83583','73348',
                          '19137','17560','52593','73426','46438',
                          '96142','44391','22481','13489','40097',
                          '92129','81201','27949','17160','70251',
                          '38715','18846','45065','95139','98359',
                          '83005','15865','45352','69469','76556',
                          '75531','21296','37465','85797','26491',
                          '98837','15979','20506','78571','47569',
                          '99210','85755','13862','13161','51746',
                          '29854','21904','45125','89352','77815',
                          '59253','92562','71767','41843','68841',
                          '94461','53922','59618','13223','91881',
                          '16350','87206','58430','71996','97219',
                          '34479','21299','28203','25179','46859',
                          '20583','64986','21322','88109','28201',
                          '99275','50819','61119','15787','59706',
                          '71076','13582','35190','37136','76614',
                          '58263','54313','20741','90137','99120',
                          '70827','34878','62159','58207','22896',
                          '68307','35595','82864','12786','27524',
                          '78805','71006','54379','95043','11320',
                          '16447','53374','88775','88637','94091',
                          '92657','45036','78296','74314','25717',
                          '58796','89364','37740','54480','53666',
                          '95549','46675','82652','62501','54099',
                          '18508','89523','94450','45104','74980',
                          '35436','54832','59450','73315','65417',
                          '92257','64907','90201','25517','20361',
                          '16664','72223','13686','79324','39533',
                          '66644','79010','60690','78319','89236',
                          '36747','24281','71192','28911')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


