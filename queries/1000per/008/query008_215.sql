
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '24530','70824','68110','70081','53844','51498',
                          '87414','76516','86209','23276','44762',
                          '33867','72911','12967','10146','64194',
                          '65030','67071','79611','42408','63657',
                          '40143','60069','50645','63145','84939',
                          '10507','91980','66549','77754','23643',
                          '33091','44015','56049','31151','26478',
                          '77274','69114','32907','70366','75346',
                          '84510','87031','46537','38874','52023',
                          '26630','35726','77354','69871','48715',
                          '46445','41122','90448','20246','11072',
                          '21867','11102','72673','54402','35077',
                          '23346','74335','67749','33296','12770',
                          '55870','79842','30365','91614','16279',
                          '46543','93983','90259','16102','79314',
                          '58718','47902','51090','79685','92515',
                          '18487','34286','93738','61455','78567',
                          '42670','60511','45376','25844','14902',
                          '51739','87828','48687','19136','55226',
                          '45331','28496','46059','56444','32769',
                          '79811','98058','69919','21217','85778',
                          '42064','45609','45552','29724','14462',
                          '17444','10416','39274','50533','56034',
                          '17528','76575','86124','59753','37467',
                          '39273','96710','67867','22820','74229',
                          '75189','13438','69831','78613','98418',
                          '50611','83999','72650','10385','35012',
                          '86429','50568','35649','54129','63063',
                          '67528','18160','47415','85207','65408',
                          '39245','48880','88591','75752','91499',
                          '20389','47601','55622','13822','13897',
                          '76041','62606','98888','54388','78309',
                          '63777','17221','95812','45893','81216',
                          '98906','52033','54033','65849','93223',
                          '18287','95928','79655','47636','54432',
                          '92541','27376','38469','46638','46447',
                          '15864','72367','55384','97600','77571',
                          '33422','53121','94093','80248','34565',
                          '25439','57963','26493','24509','48485',
                          '87264','10875','65597','77585','73936',
                          '32853','86794','39453','59505','68261',
                          '92132','76541','57720','69799','62185',
                          '66859','59531','74874','29218','48391',
                          '11500','23752','36573','39832','33178',
                          '28927','12931','11701','85734','90059',
                          '15166','22899','37958','45296','26098',
                          '34566','75762','55179','58154','65146',
                          '10754','99252','83779','72523','87912',
                          '33790','81116','61417','88764','36199',
                          '27657','68099','68055','26029','29471',
                          '15208','25059','17453','89045','52160',
                          '32661','41718','94100','73599','81647',
                          '35986','59791','87396','92383','92543',
                          '77223','23875','58346','25937','26663',
                          '20795','43107','92714','66886','52907',
                          '92202','44870','75949','87585','32599',
                          '22373','94514','54461','70304','28737',
                          '57899','67432','53723','98216','71331',
                          '40763','86779','37998','95896','56868',
                          '68024','51667','62078','10838','48218',
                          '40736','25377','84390','44328','63018',
                          '40625','25457','71494','94637','88404',
                          '97232','21526','46578','16318','18985',
                          '16025','50732','17941','36265','94067',
                          '37383','83357','59653','64120','74299',
                          '89227','87886','72010','75743','51374',
                          '67176','30232','51796','72326','98118',
                          '99060','22154','75443','20944','15031',
                          '45122','12786','77640','54823','42815',
                          '96882','25678','92979','57830','34619',
                          '48767','17869','16566','15081','77965',
                          '16736','28059','81535','43502','96814',
                          '48198','55152','34872','88206','11346',
                          '59840','58927','73740','72312','77815',
                          '53181','16610','15554','36992','90404',
                          '85585','75721','80205','11886','38983',
                          '58764','65356','58608','73519','82239',
                          '15645','79189','47545','21094','98183',
                          '58221','74960','80781','99842','30236',
                          '75427','73326','59477','17276')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


