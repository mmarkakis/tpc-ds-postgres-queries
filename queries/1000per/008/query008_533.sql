
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '21563','39860','86774','90883','12135','43489',
                          '22990','55102','83463','18260','29347',
                          '47424','71530','70489','55471','94616',
                          '42903','54039','37976','13897','22286',
                          '50601','28343','49543','66582','25379',
                          '23187','24700','25268','44101','83977',
                          '62332','89626','78380','76881','49578',
                          '35055','26702','80170','47617','90678',
                          '80068','16699','65029','32458','89612',
                          '86804','59436','45721','45765','86619',
                          '37081','58283','27942','10389','31934',
                          '85701','66240','28829','61417','15319',
                          '76087','59964','75761','95753','48218',
                          '38691','60616','18226','75066','77147',
                          '12224','37357','37150','83864','84486',
                          '64617','28636','27324','69142','25676',
                          '25717','33697','74435','81650','40984',
                          '16665','79306','44127','34482','88209',
                          '79695','17757','75958','24692','36575',
                          '56980','79427','60369','20552','87874',
                          '47109','86719','35372','57735','13388',
                          '59338','29134','88837','95368','21721',
                          '68864','30572','59752','31240','39402',
                          '53093','37311','81664','69114','55620',
                          '20400','55859','97328','55161','53683',
                          '83111','50223','84630','30132','76161',
                          '64973','28407','30422','78431','64799',
                          '43358','83181','46130','52749','57991',
                          '42527','23494','38959','36041','74282',
                          '39973','47727','48036','70659','60309',
                          '14431','47119','15959','36559','76425',
                          '40714','19415','42612','13509','96437',
                          '28487','72336','48920','53551','42287',
                          '64289','70520','10238','61599','49764',
                          '45842','20942','31618','96485','90504',
                          '52485','93061','12157','42290','45343',
                          '42907','34442','81463','90535','36773',
                          '77034','48519','33869','57511','62997',
                          '68298','32846','19717','96151','15818',
                          '62724','83572','14385','69294','45188',
                          '91941','20727','53603','76421','37579',
                          '87692','55132','19877','48147','98121',
                          '78189','41984','25855','46665','75182',
                          '26171','15651','45131','72143','61386',
                          '55773','30183','52767','48824','70939',
                          '11448','45052','82352','89050','36400',
                          '67830','15813','18617','62207','67466',
                          '69940','65085','77669','96133','32089',
                          '97197','44820','77906','63892','24667',
                          '44351','40261','23858','69219','56083',
                          '79369','38669','79010','77786','12597',
                          '93930','75147','80760','14202','85285',
                          '30993','97691','52206','15647','22258',
                          '30928','97280','55280','87147','73693',
                          '30661','84716','79383','83914','16129',
                          '27903','35442','85945','77091','44757',
                          '86856','59408','79374','80163','23457',
                          '63541','79858','24411','25618','17551',
                          '95001','17530','71045','48964','82543',
                          '95594','76951','68197','99562','36049',
                          '31016','51900','58502','96221','61125',
                          '55688','28744','77907','80673','40601',
                          '96592','35865','15757','86542','25705',
                          '29140','75054','22442','92919','28581',
                          '46372','88542','47036','22060','92312',
                          '78168','50863','40022','57776','71388',
                          '38554','62276','78251','18042','35257',
                          '81052','57146','55339','23755','13753',
                          '93755','81351','13457','93030','59278',
                          '60628','26753','70641','42009','70424',
                          '80921','42388','39754','20009','19079',
                          '57816','41070','78852','90266','52154',
                          '83031','68949','18853','94946','92998',
                          '47163','47078','37126','50854','19943',
                          '86371','82469','13667','29828','78392',
                          '46515','94225','25957','59046','47034',
                          '16095','75119','69368','37124','70306',
                          '13772','74428','70743','47162','29869',
                          '99682','55584','44539','23614','88861',
                          '30967','45337','52536','47149')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


