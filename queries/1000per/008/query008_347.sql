
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '23658','19925','32376','83832','65294','85456',
                          '48708','18188','46187','15231','66323',
                          '77871','30603','75636','32485','40634',
                          '41462','34886','10990','31650','69342',
                          '70964','54025','28104','70124','40391',
                          '60087','71024','78001','10027','10670',
                          '46798','22661','81617','67722','48700',
                          '13124','24283','92098','40347','14159',
                          '61889','83821','31841','20174','94415',
                          '35856','68928','61929','61377','72123',
                          '57473','82493','64883','57226','16612',
                          '28374','19092','67514','84455','52435',
                          '39716','26956','21474','59701','65887',
                          '68032','88444','97685','33972','75443',
                          '68545','96691','36712','54850','86580',
                          '17898','90374','50994','19831','30013',
                          '37535','83034','51693','72318','19741',
                          '86167','87911','33893','76524','45257',
                          '59347','85488','89150','61418','93224',
                          '93099','56593','31724','50336','49927',
                          '17556','93107','97063','35352','55710',
                          '13230','33541','39964','21088','32438',
                          '29377','54969','71803','71056','38060',
                          '46434','64641','96896','99979','68560',
                          '90715','28514','45553','98059','74835',
                          '57280','79710','47737','43347','27169',
                          '38468','70297','15732','58612','13812',
                          '33059','19880','81934','72330','82407',
                          '27755','33124','52684','11285','49273',
                          '33881','82546','81939','36695','91972',
                          '22595','19835','50055','19912','44254',
                          '15773','37962','88987','88566','58851',
                          '41444','87799','43403','31510','34438',
                          '75963','40481','88970','50691','34376',
                          '75524','13140','65256','88330','32440',
                          '10772','73039','64338','16866','18291',
                          '55019','73913','46051','25774','23950',
                          '15788','25555','57079','87494','73199',
                          '16530','41968','81465','16666','73207',
                          '13863','11113','47029','13263','25136',
                          '27633','61545','22392','82310','85024',
                          '46832','86528','39341','92761','30040',
                          '86292','95827','73497','63944','82237',
                          '78315','86181','94189','84949','73201',
                          '36036','33339','89727','54463','60011',
                          '20387','83528','13369','49811','71563',
                          '14082','63043','81408','78796','39342',
                          '20567','96741','28253','89620','55937',
                          '63126','73621','19854','70483','57840',
                          '11744','30733','63635','14304','20102',
                          '67545','67954','66669','72052','47062',
                          '59010','65215','17670','52044','71914',
                          '54272','38414','17181','33135','41723',
                          '74137','77393','73641','31253','20515',
                          '96946','79690','38585','53008','49988',
                          '25684','34994','47231','78208','17519',
                          '27253','17911','79827','96134','54026',
                          '28581','17953','85628','57718','79461',
                          '51583','69840','65088','62490','26304',
                          '93112','88666','87282','56478','33019',
                          '95825','41756','59957','36260','11343',
                          '91948','81861','66638','70317','61227',
                          '67998','39500','82874','76724','90228',
                          '93006','56731','52381','56927','81386',
                          '70598','10485','58913','67292','71938',
                          '36413','42768','22564','36875','49641',
                          '41411','39886','22252','84460','21824',
                          '50195','70012','29609','66443','51560',
                          '41131','19703','29672','18860','37567',
                          '57546','76452','35079','52677','16832',
                          '75915','10863','41728','87507','86186',
                          '83769','40619','48542','87843','91453',
                          '84412','18788','47050','83520','94612',
                          '16160','92227','87244','20164','90654',
                          '33213','76061','95386','51428','46284',
                          '44428','99410','16264','70610','77499',
                          '84649','12488','54448','77830','22896',
                          '18648','20623','28018','93508','31660',
                          '39799','33538','52177','31568','70760',
                          '57485','66167','73515','75713')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


