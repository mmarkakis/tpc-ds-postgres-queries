
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '39695','67048','16040','41054','23304','58619',
                          '36178','36929','23548','61598','29440',
                          '32460','29802','87777','32328','89263',
                          '92176','46672','75271','74667','49473',
                          '76662','36348','93175','22313','61933',
                          '85831','62602','50415','89129','28352',
                          '60409','34173','69003','75243','48807',
                          '41605','76516','36145','60813','20348',
                          '84357','60208','41794','73033','87702',
                          '28988','28075','10758','50853','78226',
                          '88925','41965','87960','94660','17913',
                          '83839','46275','29743','24916','91448',
                          '26823','95313','15296','41469','51330',
                          '90977','59743','40940','15937','84801',
                          '27152','87895','25545','60448','27624',
                          '81939','80850','99047','27952','14379',
                          '21955','48922','95461','67120','14297',
                          '75816','49564','14596','29111','47480',
                          '22334','80575','51121','87102','32896',
                          '40809','82464','80148','68936','19790',
                          '10992','69133','94018','95046','81781',
                          '48135','59712','32439','49558','36318',
                          '44551','17441','56775','44990','40237',
                          '84892','49310','35256','85793','87551',
                          '41652','29918','26160','91386','92561',
                          '39231','20941','73947','19076','70425',
                          '68004','13447','78367','55898','54470',
                          '12068','64507','97441','94077','86082',
                          '64415','38383','95183','24052','40791',
                          '80144','59700','16071','96371','15021',
                          '30466','49666','17504','39571','49910',
                          '37965','74159','54580','36612','80496',
                          '29867','72406','30098','12535','17859',
                          '79448','20159','11215','42088','13992',
                          '81093','36390','31593','43198','11077',
                          '84436','41923','53831','27264','35315',
                          '99780','50401','47249','65988','29317',
                          '60929','11843','55360','73861','74265',
                          '85964','61900','81541','63154','67129',
                          '99674','80946','11170','67269','71487',
                          '58155','25505','35095','94020','33933',
                          '76388','29210','83614','39822','15683',
                          '41130','34294','11760','71754','48719',
                          '28402','22957','58085','53597','84245',
                          '43728','31063','44833','14254','83085',
                          '97026','77946','56431','65521','95929',
                          '37041','83568','34718','90748','10002',
                          '15641','29715','49349','75245','54996',
                          '36292','51675','16802','86130','80255',
                          '68629','54529','60187','94820','47782',
                          '14764','61324','74937','65586','33327',
                          '60499','10187','52248','20793','82144',
                          '99007','14970','31092','43305','66789',
                          '51484','59465','43134','88669','67957',
                          '18680','63831','73230','68947','14817',
                          '94121','30957','11397','59301','48542',
                          '47433','43453','95378','17010','88326',
                          '45711','16719','61707','69834','34991',
                          '73750','89698','52577','58058','89791',
                          '11237','67221','62371','88508','75621',
                          '12998','77629','42905','70033','60664',
                          '63500','43741','90276','57556','42301',
                          '82625','89186','20320','72925','33895',
                          '72049','20948','48267','65296','70367',
                          '57140','36028','48311','30347','59923',
                          '11810','98292','48906','82783','20869',
                          '36739','94030','29290','66843','38259',
                          '88815','56029','51154','25542','14370',
                          '56558','43495','16384','99836','28573',
                          '55655','63602','31035','40509','20763',
                          '11295','18736','91049','86109','41535',
                          '77261','22932','22292','28578','38726',
                          '31752','27160','90337','11891','74490',
                          '24144','84834','66379','43478','70971',
                          '23872','87450','99214','19926','91618',
                          '22252','88194','14962','47471','52957',
                          '71153','59993','98460','52971','73805',
                          '25188','74730','87403','88024','52581',
                          '70100','74069','93886','55792','45562',
                          '88528','72578','20237','79688')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


