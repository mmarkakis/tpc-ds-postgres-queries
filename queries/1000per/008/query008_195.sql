
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '75045','31338','93057','42573','58602','29068',
                          '29888','22698','81823','68254','58883',
                          '78832','27300','44680','30878','89204',
                          '90653','73103','47759','75188','83148',
                          '71435','33830','43119','21250','25466',
                          '62653','19833','96741','37512','40231',
                          '99537','32394','72433','23208','45335',
                          '36338','86888','18948','90198','28383',
                          '30837','35475','35553','35739','96140',
                          '40042','84536','21269','51051','64334',
                          '62036','41422','65567','83697','70425',
                          '57321','20366','92195','68863','61474',
                          '29829','47611','41317','96474','21464',
                          '11258','24876','87132','58667','18203',
                          '18420','22556','24785','54972','10880',
                          '77257','55291','49406','35924','11936',
                          '56556','13967','25409','13538','68044',
                          '25746','27244','31471','41907','80129',
                          '12216','27908','95278','83793','60460',
                          '74436','36419','11978','94947','23370',
                          '77212','25661','46261','88729','74455',
                          '92862','19725','29703','85589','43540',
                          '47821','62903','31824','37472','91339',
                          '59123','14798','91846','64414','12683',
                          '21392','77969','62641','54659','14503',
                          '75335','28113','41901','87102','58273',
                          '90911','31767','47396','91466','55260',
                          '17904','96473','96141','24684','15384',
                          '78868','84974','57117','84236','43499',
                          '89697','17845','10703','38378','58276',
                          '29288','15079','97563','64673','74858',
                          '54342','41125','92145','89476','54648',
                          '91553','95620','48748','27306','12293',
                          '26937','90390','81620','97523','49876',
                          '97921','33853','34536','61170','22338',
                          '86078','63789','77429','27243','92436',
                          '61608','86195','90128','95881','39656',
                          '57700','73406','40266','62512','75990',
                          '24247','52476','14317','43478','24398',
                          '26347','47713','65259','13303','77305',
                          '49058','87662','55065','95839','91203',
                          '44829','19808','90059','11240','93059',
                          '21660','85770','29742','61466','99086',
                          '22403','81670','28149','80037','99232',
                          '14338','94635','52382','53539','15612',
                          '30080','29365','45797','18825','94064',
                          '77752','30824','22365','93087','89583',
                          '82111','61937','48387','42712','93511',
                          '81346','56817','61847','97954','32121',
                          '49816','39050','11951','54592','25926',
                          '23527','11540','73056','61491','21438',
                          '24737','45182','84212','89258','19151',
                          '57593','58216','80172','63309','71337',
                          '27634','23980','10704','89524','46873',
                          '33832','23544','80345','22060','91349',
                          '48994','37931','22931','33846','79327',
                          '78100','73852','51644','47121','54541',
                          '43608','51658','65827','32770','68005',
                          '43273','43240','64013','87014','31295',
                          '25598','13563','12915','90510','13569',
                          '93482','10341','86833','72168','94619',
                          '20634','52003','18680','40937','12031',
                          '81744','25335','97331','14414','15223',
                          '36044','90706','35153','48187','92478',
                          '44540','52345','24032','51527','58964',
                          '24377','56098','59591','44515','91831',
                          '39770','84125','30993','30298','50485',
                          '60861','84591','91857','23913','45065',
                          '17420','32267','65355','96877','79162',
                          '81070','45730','53334','90978','54816',
                          '94033','13308','40435','16088','74721',
                          '31030','21913','79063','83422','74061',
                          '94060','21689','75317','19362','79509',
                          '94495','93552','64858','25358','39740',
                          '19868','83014','47327','21428','50712',
                          '39387','20422','16758','39939','80068',
                          '85591','56466','74782','72853','24009',
                          '49837','66207','74187','56804','30064',
                          '58466','54800','12942','20923','19527',
                          '98523','35565','80473','43718')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


