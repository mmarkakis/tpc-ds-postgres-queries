
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '64451','12184','64731','38771','75526','68619',
                          '77069','29120','38262','62005','98670',
                          '57889','15087','11872','54341','58810',
                          '95928','40361','26583','83367','79404',
                          '21154','51514','45770','81561','37288',
                          '36021','18032','79513','42872','11146',
                          '72251','21544','20546','97049','66713',
                          '36682','54220','24295','79849','33870',
                          '93572','78559','80214','69922','35553',
                          '20807','14771','32313','43179','35021',
                          '13531','26966','75341','30247','97679',
                          '99694','35556','37598','38105','83041',
                          '63667','49952','62296','63329','93299',
                          '18650','86212','73352','57782','81374',
                          '96522','32531','49184','79158','72475',
                          '70093','13425','77792','92704','98984',
                          '47646','78056','44899','79246','24241',
                          '74809','82772','37514','24677','46773',
                          '18386','99215','73009','41156','36997',
                          '47044','13130','82189','59311','55445',
                          '52384','20596','99208','25496','22594',
                          '25800','11714','33086','56830','18802',
                          '85574','54704','75186','78281','30674',
                          '19152','36523','56129','53056','43233',
                          '90549','76488','96058','11391','86853',
                          '62484','71029','77697','14183','10870',
                          '48945','44024','94172','79041','56057',
                          '59560','92483','99247','82219','42190',
                          '67989','41538','33546','36786','33344',
                          '66025','42117','13159','40311','74258',
                          '27945','99009','11994','69842','93179',
                          '18162','60640','42462','20264','86078',
                          '73162','22935','54706','44457','91725',
                          '78200','15081','13515','11860','97353',
                          '40788','47049','71678','84195','94945',
                          '75806','15316','91112','41305','26180',
                          '67507','38116','95608','25838','95613',
                          '30166','32993','86662','86734','29371',
                          '55121','47187','26375','52861','19185',
                          '73128','69240','83590','78201','47483',
                          '87067','74004','92430','57482','20920',
                          '57532','34938','93434','15175','50259',
                          '35485','19607','76862','18331','33287',
                          '90243','29407','29784','86167','98630',
                          '18255','13958','22290','65194','78181',
                          '71000','62092','93291','57155','46704',
                          '51979','89302','49074','42798','82549',
                          '25990','87871','54172','25557','68211',
                          '92657','20195','40251','55136','98250',
                          '44961','61341','12996','91564','92054',
                          '98568','69860','79405','43701','10886',
                          '45965','34833','71769','45293','71912',
                          '24816','22550','17449','75056','42647',
                          '15072','76608','80246','45539','20268',
                          '82722','62739','28686','77028','51346',
                          '18412','24538','74763','12057','23895',
                          '45843','37256','97028','60355','76282',
                          '70506','43365','63958','14217','43324',
                          '94133','82100','76634','70474','49597',
                          '99253','56916','57517','11993','77439',
                          '80315','14377','14559','22220','39647',
                          '47370','93727','51539','88694','28149',
                          '94940','68707','57555','24430','64686',
                          '74635','29409','75940','11979','82704',
                          '78976','15265','72532','78546','30589',
                          '26098','20378','69242','26797','65491',
                          '76451','30476','46113','71162','28330',
                          '34095','89770','25727','73130','62763',
                          '32970','16923','80450','32525','75285',
                          '12802','39880','85398','54628','90924',
                          '56366','40771','24957','82071','17319',
                          '60561','18501','26014','34958','24719',
                          '35780','18922','97265','17676','54457',
                          '21171','35414','16429','77450','45072',
                          '36184','34557','81448','60808','42708',
                          '70327','55887','83435','24672','54483',
                          '40614','27396','96098','73064','53774',
                          '51928','94789','46625','42572','17622',
                          '52485','23332','65910','43127','25910',
                          '31948','42011','43203','23002')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


