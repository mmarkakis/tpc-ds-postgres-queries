
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '15488','24341','94548','45785','38624','71008',
                          '84379','94218','81250','65175','74313',
                          '93132','59868','22262','92300','67608',
                          '13776','61301','22326','30869','51421',
                          '45326','73078','87121','18276','92742',
                          '92963','16756','63074','32237','38384',
                          '85223','18914','65164','63135','66135',
                          '86851','67576','47738','46254','97200',
                          '52853','49518','22364','21442','42313',
                          '42996','11746','62237','41256','23720',
                          '36990','39728','50869','72930','83078',
                          '33716','69285','93144','28219','36032',
                          '25633','92739','89198','23031','88519',
                          '44666','40900','84531','89989','96711',
                          '12788','11069','97373','80169','31013',
                          '67407','68899','62524','16731','87942',
                          '94329','91552','32683','65635','75963',
                          '21417','32023','49905','62038','52068',
                          '27394','83065','84890','86465','11216',
                          '59318','67783','64312','37152','91579',
                          '97907','99877','46691','96534','12704',
                          '29125','20334','77303','74836','54234',
                          '80318','85118','75515','37505','24624',
                          '96929','18840','66120','62716','32736',
                          '82143','65506','52008','35233','22155',
                          '92489','22382','71399','38397','40344',
                          '38527','24273','59914','48289','27255',
                          '59721','34891','76576','19042','99961',
                          '27868','61493','59167','57558','97073',
                          '16413','96724','53128','36874','10489',
                          '68571','58763','38885','75140','31931',
                          '45676','49414','70091','57694','55727',
                          '75131','66227','44090','90072','75351',
                          '21078','29172','77225','27591','93585',
                          '96321','26629','30154','45656','49107',
                          '12958','79708','25359','26846','30921',
                          '69255','41461','70894','84846','56072',
                          '75127','71763','56128','52222','97450',
                          '66035','68172','12059','93118','94386',
                          '10987','40965','70546','35195','93694',
                          '58717','16008','94529','58875','45985',
                          '68833','26599','74038','59288','94417',
                          '44855','86722','10339','99063','46931',
                          '28536','17445','55971','45440','28277',
                          '81421','86639','74796','32429','92514',
                          '53429','10887','14318','97085','48381',
                          '73893','65207','72114','67176','94632',
                          '39766','57480','66339','30686','92959',
                          '67282','88133','57934','58644','63775',
                          '90708','20982','95758','60498','71269',
                          '17523','38380','81962','81019','84640',
                          '97324','35069','60597','17040','15213',
                          '47661','48422','39458','72059','84538',
                          '12986','59028','79841','45488','89870',
                          '70630','11134','30799','75742','49109',
                          '91013','24013','70216','48456','98398',
                          '34071','27835','24326','92141','12451',
                          '19954','54285','67561','33938','38074',
                          '83898','81395','23940','81290','66364',
                          '56388','49519','97045','13992','37470',
                          '47449','84495','47359','84932','18314',
                          '55365','94418','70410','58553','31311',
                          '73113','38494','52464','15901','27508',
                          '24234','10207','37858','47203','37562',
                          '69572','20022','36527','30227','73555',
                          '78955','82502','92297','33777','23810',
                          '79168','39094','17015','29664','41081',
                          '28610','82934','31111','77449','55120',
                          '93009','60905','92385','68769','47124',
                          '66618','86372','91301','13103','46211',
                          '81172','45816','97929','60672','32343',
                          '15492','63403','28325','94362','15292',
                          '17732','28838','61463','90213','35135',
                          '12653','61820','49403','73543','99403',
                          '57572','60490','86829','96160','10592',
                          '19358','73679','79937','54878','55197',
                          '33147','78343','15548','67049','24292',
                          '33046','34441','41767','80330','53660',
                          '37715','68782','82904','42817','79134',
                          '82175','52034','10171','32858')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


