
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '71487','95012','60615','95459','16384','51755',
                          '18846','26113','57367','35413','99385',
                          '63032','99923','80345','59031','12372',
                          '86270','49710','75218','30553','58357',
                          '29481','24328','87787','85679','83195',
                          '43382','58036','21764','43214','52718',
                          '80062','56366','49102','36358','87468',
                          '89431','81296','76387','31651','29536',
                          '37425','78944','93365','69059','98075',
                          '77080','52058','14161','70632','55376',
                          '39681','56242','78184','40977','22889',
                          '99324','29899','20234','66528','43767',
                          '14091','28478','51996','66618','47566',
                          '47683','25624','76782','59062','13280',
                          '48432','45570','64260','20641','54168',
                          '72869','24214','17016','68722','64732',
                          '27922','19359','40505','78368','97837',
                          '76275','45432','77791','68219','57751',
                          '41207','97900','87508','12848','33157',
                          '47046','78658','43213','42244','31774',
                          '57175','25483','20416','58780','80157',
                          '62954','10453','76072','64656','27688',
                          '57278','50259','40370','23164','45290',
                          '85571','88998','93756','49475','52991',
                          '66043','75645','97315','53789','84307',
                          '54697','22983','10950','59737','25644',
                          '28616','46721','58182','72724','19117',
                          '19292','43859','97568','43173','87314',
                          '65238','24582','71698','57934','72840',
                          '70210','27692','87830','13079','45313',
                          '99027','89729','74867','23368','56331',
                          '34804','19755','14883','34499','46865',
                          '32229','24239','99133','98796','51575',
                          '87284','58028','99014','79275','22529',
                          '89727','73417','51222','74022','81636',
                          '47700','58127','57213','67746','61148',
                          '71963','28795','27296','74801','38996',
                          '11394','29783','66578','68660','83154',
                          '73767','98470','84683','62156','77353',
                          '57211','65931','62900','59605','20184',
                          '78936','58455','14988','56802','28420',
                          '94480','44562','23189','17471','56394',
                          '23117','82849','89902','60690','64299',
                          '66844','77871','50302','47657','75903',
                          '87149','23997','23478','81320','92834',
                          '60473','61642','22742','74769','60868',
                          '71821','13463','69075','32288','43305',
                          '64179','28959','36268','11344','16582',
                          '36016','85526','66014','76011','44245',
                          '38337','90595','71120','39419','96312',
                          '11989','32599','83478','47331','35465',
                          '13648','84932','21286','51960','89942',
                          '93494','87437','47964','16139','39688',
                          '42499','38305','66054','80346','45575',
                          '53147','46837','84231','42691','77052',
                          '25082','37644','89637','76040','45158',
                          '41920','89714','29596','10489','22688',
                          '60623','36445','18854','29952','56835',
                          '94336','62277','77578','93904','71251',
                          '69906','49038','24834','81958','71639',
                          '55782','46256','46188','64542','22546',
                          '27869','19611','41302','27746','92414',
                          '15858','30767','82478','31639','91594',
                          '18573','31312','66283','64391','55008',
                          '20527','25105','24868','94619','37852',
                          '82042','34238','39680','82679','64678',
                          '86996','55651','97748','43167','12829',
                          '82611','18154','64858','53210','53484',
                          '75001','57053','28465','36489','56906',
                          '32950','54423','87377','72787','73151',
                          '40216','56110','67685','45688','70975',
                          '47406','38875','92734','51035','77925',
                          '83140','88406','60041','78674','19227',
                          '33782','62507','84103','75448','61285',
                          '66806','74844','20478','52736','34071',
                          '61242','82177','26439','15935','37437',
                          '34106','90562','71845','69104','83931',
                          '91980','69676','17177','95579','24539',
                          '87369','17286','32298','28712','27819',
                          '19179','62347','24171','34801')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


