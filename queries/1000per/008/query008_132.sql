
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '37952','25559','57037','22327','48795','73952',
                          '55253','87867','87856','46773','12466',
                          '81379','24422','13929','15483','52554',
                          '70442','43591','49005','52035','69247',
                          '76370','30497','78193','93070','67535',
                          '31074','77467','45965','18332','55527',
                          '49034','18018','10406','42498','79016',
                          '87026','76028','87945','74272','69012',
                          '28774','50263','47892','88192','72128',
                          '13801','74871','22157','70117','57475',
                          '91530','60020','98669','14305','39538',
                          '62847','82138','64075','63742','11829',
                          '31420','49096','37777','51160','68849',
                          '93811','73482','68927','69633','87900',
                          '17264','11865','99171','94922','51468',
                          '15532','86865','54345','26848','67148',
                          '26233','51063','27280','55846','27048',
                          '39567','55595','83890','27262','52377',
                          '89929','39520','21776','92778','24685',
                          '21006','93040','90430','45757','53601',
                          '49158','61906','14145','24799','27872',
                          '50946','54035','63573','59363','89747',
                          '12616','16568','70379','69891','81299',
                          '11897','13227','92295','36522','16317',
                          '32624','87388','97813','81447','17835',
                          '11125','53445','35869','48128','92433',
                          '34501','20105','56835','45686','33802',
                          '22985','34734','61446','44319','40725',
                          '44695','70042','71214','76333','69219',
                          '56613','34712','19695','13742','34495',
                          '67975','53969','60476','98647','44693',
                          '45023','40339','22582','76903','66191',
                          '95351','81200','88737','46329','75257',
                          '12632','21438','45962','85780','28118',
                          '74106','38776','59665','77926','44993',
                          '10927','96285','44705','72517','82723',
                          '29416','63983','93422','56478','13922',
                          '78543','28215','35760','56748','69625',
                          '87197','93257','34992','63895','49463',
                          '54314','12302','59121','18582','77070',
                          '16505','94432','94415','15713','11095',
                          '17868','58139','48560','49256','42593',
                          '33605','85680','64471','27097','80115',
                          '40723','83637','11911','74753','39609',
                          '59914','54806','56304','26244','77033',
                          '67282','50423','96858','99214','95794',
                          '42882','28311','67399','79344','30226',
                          '81269','54059','18550','55672','56449',
                          '70398','65030','39213','40850','37290',
                          '42047','40416','56515','34006','43775',
                          '20401','93906','80896','21183','53920',
                          '87376','90912','80132','43874','76074',
                          '35157','54842','24069','87132','30774',
                          '74963','40035','14841','33774','70737',
                          '27507','72464','60367','81115','67613',
                          '21271','16861','34796','58413','43140',
                          '37151','17361','73341','87769','40187',
                          '54105','84866','14336','75043','98435',
                          '19353','24581','10357','31373','50081',
                          '95890','99363','90010','11922','67353',
                          '58715','16307','57998','90031','18161',
                          '16629','46167','24231','62038','77602',
                          '60192','77298','37702','26486','42255',
                          '61119','51531','83766','64835','19106',
                          '52096','77306','75292','52529','38835',
                          '45548','73430','78341','78311','65652',
                          '92649','77239','52980','17706','29052',
                          '97961','54092','87377','59961','55622',
                          '81591','52634','83718','20265','30643',
                          '81769','33185','36315','41080','36419',
                          '25590','66130','53602','44946','28095',
                          '99017','73604','48816','88870','14237',
                          '94526','46753','43595','52390','88380',
                          '85983','84150','16382','23343','95742',
                          '76523','91755','41836','88428','33427',
                          '27597','71707','50901','97002','25364',
                          '27142','69779','37368','17732','17344',
                          '36268','12633','82953','39118','64464',
                          '33113','70681','43573','31619','81540',
                          '40595','37258','35303','26170')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


