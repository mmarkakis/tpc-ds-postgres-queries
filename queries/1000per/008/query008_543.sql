
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '63062','41127','88871','26373','71641','85369',
                          '66426','43800','38857','22338','16258',
                          '65448','96777','67505','25210','29244',
                          '92338','44475','99024','68962','14609',
                          '34175','12933','98539','10978','83159',
                          '33406','48842','78104','97595','92713',
                          '73153','16540','73161','78371','17088',
                          '63813','48050','35333','71850','62320',
                          '25205','85031','73212','49956','68774',
                          '68545','98613','75353','64631','31156',
                          '83434','78419','58275','16070','32415',
                          '87577','98992','48302','68843','84723',
                          '80277','79294','53025','14276','81568',
                          '96407','81239','75521','59941','66996',
                          '49505','76513','84008','52851','60718',
                          '47374','75781','27646','77099','57617',
                          '55731','73985','70168','28457','46034',
                          '22848','94193','76955','28893','44930',
                          '68134','89235','43755','11769','31060',
                          '27483','37011','79186','40081','28487',
                          '76613','37646','44027','86932','59133',
                          '12638','74098','31948','32743','99046',
                          '43298','72921','74391','97064','33357',
                          '52153','67004','48210','87410','18229',
                          '24600','83592','78136','49634','15090',
                          '63828','73609','17302','61153','86921',
                          '34454','26809','21417','16292','82929',
                          '18801','38674','72955','84062','50958',
                          '51152','73965','64842','78610','50080',
                          '74964','57180','39937','34330','95991',
                          '18723','26233','47627','95878','19413',
                          '64882','98695','59918','88585','60440',
                          '93760','14983','68678','46827','28183',
                          '58581','24889','50300','51873','48376',
                          '22329','59650','57474','91479','85122',
                          '57972','47009','86275','77921','24263',
                          '66299','70159','25932','37574','51592',
                          '17290','89283','27750','85900','12944',
                          '25439','54976','50540','95901','23727',
                          '11833','85163','67753','60640','27147',
                          '47223','34398','36515','71389','36636',
                          '17615','51240','34888','98455','84517',
                          '65102','53595','51055','45189','76368',
                          '35303','51358','85360','58136','38798',
                          '45832','65471','32890','82249','89187',
                          '26096','73837','24210','82404','96568',
                          '72912','89161','47730','38802','84384',
                          '84509','91458','72244','72635','45192',
                          '42351','53432','82624','80102','86356',
                          '24299','64413','89026','32249','76403',
                          '88569','69888','43487','52770','12354',
                          '32691','85478','34084','94612','42820',
                          '49851','54726','10916','37560','21078',
                          '13473','51443','89596','77275','18813',
                          '24660','32067','28670','66127','68521',
                          '89927','98317','71746','56037','97246',
                          '61854','32084','28812','43222','46390',
                          '15957','50695','95505','91606','80631',
                          '15315','41851','52326','80193','77242',
                          '45007','53649','20166','18556','13682',
                          '57550','58963','64066','29480','92433',
                          '49226','36542','22008','82254','72276',
                          '18112','54210','88962','25544','93943',
                          '28844','69789','78876','88195','63348',
                          '83092','42881','31351','82656','51019',
                          '24553','13452','95116','50558','89600',
                          '17506','13532','74830','73641','80016',
                          '77071','30570','70565','43628','97421',
                          '14744','38936','46053','21063','50625',
                          '11335','59994','43191','58640','38001',
                          '40276','99259','76573','77114','56780',
                          '85178','32498','54891','36393','20615',
                          '32895','52002','90041','61465','23004',
                          '93538','56479','54427','41839','28310',
                          '23967','14467','53085','86813','21320',
                          '77472','59720','70311','21622','89084',
                          '41900','36161','63756','75336','61646',
                          '86370','97130','86990','95746','76146',
                          '51593','52911','89288','18991','27756',
                          '74856','21596','25764','64748')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


