
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '56353','95850','22882','91817','80306','12524',
                          '40941','44060','34817','33901','73914',
                          '11720','88880','22673','70394','48019',
                          '86327','40461','65388','45087','96876',
                          '91907','21120','86501','50972','67593',
                          '78465','74973','38921','20162','62969',
                          '71350','42759','98974','66333','51621',
                          '58136','83463','94324','76498','59454',
                          '31193','31160','41537','75845','33559',
                          '83388','59089','56778','71736','16847',
                          '87978','15657','87033','25388','68142',
                          '95355','24809','83076','16396','51164',
                          '78081','84194','31785','55889','44524',
                          '29640','88636','19730','34320','62561',
                          '93669','45421','45625','99613','75406',
                          '80090','43161','19672','16510','50216',
                          '95360','37407','80860','45346','54227',
                          '62206','97072','43918','80352','70069',
                          '13735','10469','23487','12724','37508',
                          '13258','83512','66625','38416','34586',
                          '61746','87196','16072','14851','59440',
                          '54219','57019','35370','47711','43602',
                          '73407','73601','35182','16256','34034',
                          '77298','53429','48200','80407','42042',
                          '99394','81129','40212','58828','66737',
                          '26326','60385','95347','43741','19020',
                          '51108','24316','70543','80056','33129',
                          '63275','29929','70393','18732','25702',
                          '96299','23790','65717','11885','62159',
                          '32762','76274','53353','19509','84584',
                          '73889','22069','34401','75524','14086',
                          '37577','26107','63668','10252','24444',
                          '15757','83830','59999','86475','26430',
                          '13353','45070','77445','40289','44579',
                          '83737','80521','97108','88455','96978',
                          '98956','78419','61505','68240','39413',
                          '71898','41534','30851','40282','92842',
                          '96029','62509','99979','68275','45821',
                          '56207','53698','24667','59812','89035',
                          '60030','75470','68794','54205','19291',
                          '87167','77084','98218','92722','86173',
                          '45971','63661','60451','56245','58340',
                          '26134','44531','36601','38937','85390',
                          '27567','57029','80235','91779','55411',
                          '24130','89468','80703','59646','72991',
                          '57239','17016','10396','84369','68832',
                          '99054','10354','25426','64182','93788',
                          '85687','46814','38679','43306','97477',
                          '78562','57925','33898','45116','49819',
                          '31219','23093','54963','29924','97424',
                          '53915','75213','72697','10625','63561',
                          '74618','20919','19577','98045','65496',
                          '33833','33012','70145','21678','52801',
                          '12980','22019','26623','69842','99726',
                          '83986','78773','34542','33284','37369',
                          '62394','29083','72281','10858','44806',
                          '12568','76129','48539','89938','60998',
                          '95310','62756','43548','18699','53891',
                          '60158','95914','40528','26575','25541',
                          '93014','84039','52829','57822','41675',
                          '97702','87182','94027','84687','40943',
                          '60542','47168','22478','37672','34416',
                          '78254','47161','79112','11543','45048',
                          '89593','23649','81835','47775','71728',
                          '35533','91429','34589','97353','87378',
                          '89710','43733','37014','90847','76253',
                          '81620','16492','38619','50989','91712',
                          '91342','99150','59393','81315','95213',
                          '44279','74593','52481','15521','62782',
                          '66019','86039','27266','46057','15328',
                          '39080','44141','95739','77400','50983',
                          '46818','78084','73736','30281','81571',
                          '55426','50571','92484','80635','89091',
                          '54273','98217','46507','87102','27676',
                          '42864','84347','71576','33228','39536',
                          '69805','81709','81091','78699','69798',
                          '17233','34504','20100','31758','40306',
                          '65365','34716','17664','19247','23567',
                          '97209','42589','99533','91796','26329',
                          '29778','67548','71690','79798')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


