
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '22139','19765','25683','70059','50291','30384',
                          '56465','66420','92476','78681','60383',
                          '32073','55931','99425','82660','34480',
                          '73107','83187','92930','45278','13245',
                          '42491','64547','58890','77306','41848',
                          '83971','62765','48232','19445','77557',
                          '39124','31708','62378','73834','59547',
                          '95325','59368','55056','82357','54305',
                          '98837','88935','35429','93771','34607',
                          '26681','85418','41113','90675','67917',
                          '39844','64360','35648','21212','17224',
                          '93625','42908','12222','43725','52878',
                          '94492','89279','86489','81430','11148',
                          '81041','62287','29840','37873','85229',
                          '40324','20551','17177','10621','57891',
                          '68060','98040','10953','85929','95136',
                          '33946','44345','55451','30657','52362',
                          '61709','68868','21927','75836','17687',
                          '55956','20512','46276','60700','19616',
                          '38493','25252','46638','99921','46100',
                          '78390','24061','69004','71211','40626',
                          '26701','10732','19544','26851','75420',
                          '10721','46089','64191','63414','90776',
                          '71686','16769','75526','18479','59765',
                          '53520','43814','72650','67531','56851',
                          '36961','31764','30997','30186','57985',
                          '76724','65670','67020','65963','49645',
                          '76521','54498','23557','44854','19722',
                          '86961','70381','75196','38779','52235',
                          '46890','34869','80806','74008','38926',
                          '47557','38016','50396','70406','73262',
                          '59635','37536','38889','28858','94140',
                          '60236','52627','79227','29448','50495',
                          '88772','86343','68059','25616','95611',
                          '50913','49366','73189','98213','61122',
                          '95627','88461','55750','79650','52065',
                          '56959','89291','96681','36985','32032',
                          '68705','61430','19885','11356','72015',
                          '12131','42641','69722','23271','89906',
                          '99207','71546','86569','51291','14495',
                          '96011','77120','92486','75617','54398',
                          '40909','35140','50410','42606','68588',
                          '70800','50646','93328','83145','99580',
                          '33168','45039','45053','66122','66079',
                          '79786','33700','89980','98301','13325',
                          '78679','84415','93678','96035','98556',
                          '49927','43550','68237','99663','46299',
                          '22449','95833','77342','53390','74717',
                          '18565','25493','60830','97696','98240',
                          '61332','99941','59045','25774','75677',
                          '27191','50028','42607','18687','14620',
                          '36044','50660','27424','87650','44224',
                          '63204','18375','39987','48682','74149',
                          '36668','76377','76012','53806','89828',
                          '18515','48330','85828','43055','32500',
                          '62902','42146','89375','25256','10008',
                          '48963','20306','73965','98282','98041',
                          '53073','99701','55732','38925','81876',
                          '19632','14581','59846','78219','46559',
                          '48525','55638','88266','37456','50487',
                          '99889','11093','20097','35032','87101',
                          '98441','96216','70890','61614','49188',
                          '30136','20218','77598','83211','51052',
                          '47354','85086','89228','10568','94388',
                          '57126','21383','54016','24381','43002',
                          '53726','90454','64645','70763','95561',
                          '81504','23489','93642','86533','47535',
                          '75107','89009','36263','82634','54951',
                          '36290','33889','90117','10165','44906',
                          '32981','93026','21170','44249','45327',
                          '26073','59486','30609','48265','73655',
                          '40806','20065','40332','63820','68114',
                          '36462','71957','75549','70620','15127',
                          '17449','49278','93954','71177','46932',
                          '45774','64028','10699','12003','67582',
                          '10903','61405','57509','78868','46216',
                          '80343','78004','48939','46578','56532',
                          '88007','63732','35492','30055','95657',
                          '85744','59348','21380','42987','12953',
                          '96766','50235','75724','49082')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


