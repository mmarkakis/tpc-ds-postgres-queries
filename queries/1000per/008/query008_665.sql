
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '38395','44443','60239','98499','33448','65157',
                          '68583','30125','14145','83547','20660',
                          '16404','74632','13478','48424','62856',
                          '59140','79170','37351','92906','48086',
                          '89818','59030','87577','13461','99536',
                          '83388','15372','43202','46124','44676',
                          '91897','63111','11144','81685','86123',
                          '64950','21282','65856','60295','40434',
                          '61203','26215','41782','16954','20780',
                          '45750','43960','46105','97840','23775',
                          '15038','62557','99000','24589','97442',
                          '93868','92017','41213','59985','33725',
                          '16573','98746','41424','58500','46199',
                          '78520','73103','86119','30121','41084',
                          '58731','27211','26888','88869','29890',
                          '76544','78951','39432','19903','80410',
                          '28491','93929','85148','16311','70018',
                          '41953','11530','94727','53590','13431',
                          '52660','33292','19166','81820','20909',
                          '11924','25415','50607','45238','82145',
                          '24928','81294','66779','46235','14257',
                          '27256','76909','82056','16974','60158',
                          '68674','65011','24461','96584','23785',
                          '90709','69989','64373','94985','31746',
                          '63890','36238','58833','76872','41145',
                          '57218','80314','47888','62077','80798',
                          '76764','22018','57554','63601','92105',
                          '35070','62820','77317','36663','74360',
                          '35756','98546','53822','84601','44958',
                          '14263','48590','85000','17693','84000',
                          '18859','15596','88876','32661','99593',
                          '24046','12693','51548','75003','96408',
                          '34641','50598','37017','66876','98860',
                          '56202','28571','24307','67204','35959',
                          '21561','49925','31833','70916','86773',
                          '31945','30469','71201','23879','70807',
                          '79110','83041','11106','11832','60962',
                          '13488','67730','16806','97037','56506',
                          '60969','32044','82251','60128','72378',
                          '79264','78077','80669','50475','19447',
                          '51054','90917','79092','59616','34970',
                          '93455','82493','29158','73338','53231',
                          '68633','19047','69563','23882','62716',
                          '96346','96971','35730','96053','73218',
                          '36590','73490','14889','29572','64619',
                          '67775','88682','37885','41613','80465',
                          '62054','31179','92285','53708','97889',
                          '30775','59377','87063','54383','77562',
                          '90953','70721','96284','76537','56469',
                          '55584','27062','41124','30794','16131',
                          '73131','81278','86522','80290','22363',
                          '77903','79714','25410','48533','15916',
                          '90554','50972','30040','99972','71439',
                          '51549','40838','43079','53438','73394',
                          '96664','53979','92219','29356','72677',
                          '76505','92648','46066','30452','71308',
                          '41513','77682','55687','62791','48383',
                          '91544','16518','49893','36096','89469',
                          '78158','57850','80677','95411','97549',
                          '80860','85208','75877','60861','78590',
                          '97827','92726','15603','94478','67810',
                          '34616','43880','75947','78385','72061',
                          '37314','24264','21803','51811','69305',
                          '11392','37203','17384','67558','43402',
                          '31639','84383','55305','56812','14221',
                          '94919','29972','68801','67287','10067',
                          '61073','96085','82701','57867','75848',
                          '58066','82486','29498','83027','18255',
                          '83243','42365','55574','12694','18494',
                          '51676','27738','58314','47954','16039',
                          '95593','92476','85216','49556','50736',
                          '96406','92903','82737','31672','36721',
                          '19040','46980','90999','75500','52982',
                          '48855','74327','79111','72965','60547',
                          '21014','76438','57469','45302','32505',
                          '13230','93433','23922','71982','13867',
                          '67176','69888','70797','27960','57396',
                          '70652','84183','98661','45644','27927',
                          '98340','80466','25554','38838','17805',
                          '18065','21171','57990','60145')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


