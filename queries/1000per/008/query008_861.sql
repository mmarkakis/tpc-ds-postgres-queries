
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '78014','67702','53547','64931','94964','86594',
                          '87184','55796','53749','66886','92300',
                          '79699','16520','75719','41200','55325',
                          '76389','75460','88416','29157','44742',
                          '52606','52502','77903','13227','46432',
                          '78745','26755','13260','69917','33859',
                          '54886','92600','29254','71800','26965',
                          '67367','45006','39342','67071','10807',
                          '71500','75210','98907','24708','67982',
                          '42825','81031','47885','42836','13215',
                          '43783','56613','65542','43624','85169',
                          '81628','13319','64274','45041','33808',
                          '67974','81483','53754','66732','13685',
                          '82890','65957','42062','92265','40523',
                          '17421','79485','14437','73682','74707',
                          '23268','77819','96703','33988','61464',
                          '95014','29536','82404','29493','15758',
                          '28850','30279','41289','95404','67920',
                          '62038','27032','59453','12854','91915',
                          '44085','44173','16412','65873','80816',
                          '66966','97723','17518','77617','74422',
                          '37217','20425','17490','76949','53801',
                          '33914','75533','32551','38290','73433',
                          '78353','93169','89271','51682','22915',
                          '31532','63718','83623','88418','90431',
                          '26069','91186','21707','84607','34346',
                          '24695','83572','81126','92888','80291',
                          '30609','81592','88802','34359','51385',
                          '86933','65817','82221','39378','36023',
                          '54305','49649','84357','12276','47915',
                          '93334','31247','69391','79242','55986',
                          '37769','94978','98334','60083','97545',
                          '34851','18502','64158','28462','13976',
                          '20799','95859','47600','13931','45864',
                          '24427','36699','99891','32638','29461',
                          '56224','78776','89457','42545','46816',
                          '51914','11638','50705','55947','95991',
                          '32087','86515','60266','58904','54691',
                          '61337','58046','56816','63220','62838',
                          '62024','34154','21928','84130','59471',
                          '15457','75611','50250','34761','95783',
                          '96819','99980','47495','59464','93374',
                          '93461','90492','15999','59936','26698',
                          '54660','98481','24370','34332','75781',
                          '97439','16477','61523','22757','85174',
                          '45681','86560','11006','93432','89348',
                          '15111','69604','73778','75039','52491',
                          '54777','55210','11908','99796','29785',
                          '76095','98011','31509','34921','95523',
                          '89162','39196','92652','49874','74855',
                          '60438','71992','33652','55842','43264',
                          '23607','11307','41204','79227','45975',
                          '62218','20093','72081','27632','32930',
                          '90399','78710','36842','77065','17457',
                          '52943','40033','79995','40449','33020',
                          '69876','49587','48236','43801','47464',
                          '43705','60442','74950','20141','13526',
                          '13510','22381','13848','72281','23121',
                          '96735','33210','83625','47768','89684',
                          '84976','12099','56881','90738','50952',
                          '75023','64570','43267','97082','97725',
                          '30313','71532','59614','23935','51304',
                          '51620','39107','16679','86742','55227',
                          '59599','59519','64535','30334','16750',
                          '29950','76613','81680','82658','78181',
                          '87506','18466','44200','42641','68099',
                          '67947','82510','38713','68828','24492',
                          '36784','69195','39882','64625','32748',
                          '66789','21126','70191','87752','11266',
                          '83088','92754','62495','11576','20207',
                          '98407','50162','54798','85583','67795',
                          '81445','71931','12050','17690','44837',
                          '14730','22664','97845','10522','51625',
                          '95994','62238','58635','45341','42744',
                          '27466','54016','11042','91063','90432',
                          '49137','89098','36205','88095','66460',
                          '49558','65800','30522','79519','26173',
                          '80828','31364','70173','32310','44858',
                          '64322','49667','83830','38986','50901',
                          '69400','97028','91197','33371')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


