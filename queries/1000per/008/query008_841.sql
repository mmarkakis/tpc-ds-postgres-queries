
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '32909','15564','93374','64957','17000','20496',
                          '65811','25078','47243','14991','62476',
                          '35524','39788','65917','99979','47318',
                          '81295','10944','64829','22783','68037',
                          '57959','72290','48533','84170','32079',
                          '10726','22655','69664','54539','41966',
                          '56724','57987','51729','69503','23545',
                          '43019','23118','31377','98345','38746',
                          '87419','99055','89183','43074','84326',
                          '84986','52547','25419','23350','50112',
                          '50626','79322','34569','49384','26563',
                          '40513','95945','45791','46257','12754',
                          '80730','88787','13182','14616','76557',
                          '71871','31004','23614','75013','65166',
                          '98834','33595','24754','92507','20687',
                          '66496','26762','70986','44323','11925',
                          '42262','81946','69467','67706','84248',
                          '34013','91468','94420','41507','40409',
                          '15687','15974','73213','97089','98239',
                          '56433','71238','46309','93382','42216',
                          '47638','14469','43057','65757','10946',
                          '10901','77688','52624','51691','73593',
                          '41664','15880','87597','44036','78971',
                          '72961','69614','97225','19422','50840',
                          '60983','29047','25735','85993','38388',
                          '50424','44963','21111','80068','24635',
                          '14232','57771','59710','35592','32023',
                          '26617','27039','91039','81370','69686',
                          '77710','93814','94783','56858','84403',
                          '35870','88553','29906','67892','43545',
                          '16741','36330','23699','19531','97867',
                          '53461','55215','87601','89203','27807',
                          '93503','17487','46885','80055','67711',
                          '26189','21107','39006','94012','76826',
                          '53062','98107','12726','92818','16727',
                          '43954','87436','59009','97287','70720',
                          '60145','17712','74970','43962','43334',
                          '91335','26130','53711','96070','57764',
                          '61176','67882','20826','34563','16460',
                          '81552','32635','37256','41784','53578',
                          '43518','47737','54890','71837','17915',
                          '71544','95720','64343','52679','19067',
                          '74837','90647','81635','76236','96489',
                          '13827','54904','86902','28441','90025',
                          '34614','88869','48981','36027','38446',
                          '44311','87620','28679','68544','88104',
                          '85221','52266','46070','48614','23461',
                          '66392','99136','70677','62473','76406',
                          '79575','15330','41111','15329','98143',
                          '50527','18619','84592','27048','90682',
                          '21783','26671','26125','51651','79261',
                          '21430','62501','78663','77022','33094',
                          '41087','34739','77317','47124','38449',
                          '55633','83966','26777','92390','99639',
                          '53565','45958','70425','44755','66125',
                          '82861','47733','68231','13285','75469',
                          '51578','43063','70393','18759','60431',
                          '56500','86012','99605','54932','25114',
                          '84160','44932','73894','26299','66172',
                          '86522','18066','47729','38462','63175',
                          '86075','14078','36227','25534','56465',
                          '52558','89373','46768','52320','61639',
                          '83682','20595','10774','10617','30055',
                          '88855','50399','93625','58781','10053',
                          '59124','27722','41738','25061','53448',
                          '52456','64628','45363','75211','74069',
                          '45801','88411','70666','27263','88583',
                          '72448','61940','63753','54194','83471',
                          '65982','82223','29810','22387','13465',
                          '11553','82249','95602','44322','74301',
                          '65393','66412','70163','90662','84772',
                          '16372','63777','39468','99174','84764',
                          '94334','87207','87184','17897','43888',
                          '62919','49685','50532','32487','98544',
                          '33223','83279','94957','70129','59052',
                          '19869','51131','12263','93841','61860',
                          '38850','41315','31581','55606','45959',
                          '75333','60776','29794','58444','42192',
                          '99386','46302','74810','83849','33703',
                          '89052','30970','64398','91303')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


