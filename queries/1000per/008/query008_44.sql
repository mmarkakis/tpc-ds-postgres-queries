
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '72069','52593','37688','16795','56240','75117',
                          '89918','26434','57525','72667','42560',
                          '46243','11185','41668','22732','34905',
                          '98581','80268','39482','99312','29647',
                          '40007','29221','78031','85266','43032',
                          '87976','54909','76925','91135','93756',
                          '28862','68998','42483','46701','45034',
                          '14794','16854','69575','67734','42830',
                          '28626','64382','41454','40624','92024',
                          '33800','24027','58920','97347','10579',
                          '23322','67488','11169','76253','31062',
                          '66533','47195','14945','45854','67122',
                          '88693','95739','39388','42571','44446',
                          '76711','84074','42381','90113','47172',
                          '68905','85370','43674','80873','25979',
                          '68896','31421','84095','86856','23018',
                          '84603','49184','61249','78622','94050',
                          '67883','51052','88845','32971','94744',
                          '92832','45831','42455','79767','19815',
                          '30761','96876','46057','81033','68672',
                          '64954','77253','81228','63273','52875',
                          '45361','84253','48206','51955','57497',
                          '18334','43682','82046','74137','16839',
                          '52755','99777','85098','54211','33103',
                          '87237','81672','32028','66572','28994',
                          '93861','10196','43876','33784','97028',
                          '83103','70399','64372','92976','40422',
                          '81577','40719','38479','24777','72610',
                          '86996','81599','50017','59632','83581',
                          '75791','11431','35181','93409','61879',
                          '41119','83198','65491','31289','22410',
                          '68538','14721','12582','97937','82029',
                          '93163','94697','89736','60179','64989',
                          '56004','79821','49891','98816','37863',
                          '19199','33289','98524','82600','84798',
                          '72011','56051','46336','61500','30394',
                          '78812','75169','53310','70229','16941',
                          '21018','12523','25655','46192','78434',
                          '75020','96714','70477','68003','22865',
                          '72627','36618','29320','28489','43665',
                          '75241','72203','78353','73803','88550',
                          '88848','28913','94280','40122','30356',
                          '18851','97227','37761','16162','75930',
                          '71504','43485','89580','47402','65619',
                          '97116','32932','84126','55597','92397',
                          '73422','59183','51362','82143','56009',
                          '64195','60514','33058','62630','75083',
                          '33926','84702','34539','13756','40760',
                          '93125','31969','73052','10391','11981',
                          '48372','29971','60546','91650','42465',
                          '54160','39018','29000','85354','59805',
                          '26297','14982','11676','72004','16693',
                          '15295','43480','14605','31296','75922',
                          '60868','96129','11800','47034','60529',
                          '96319','97877','72809','61930','48616',
                          '97666','95020','37697','91203','53728',
                          '69862','76014','76840','31599','82843',
                          '90548','56533','82108','70722','41268',
                          '72634','24377','75393','62060','62481',
                          '41571','96125','31360','38698','23558',
                          '20925','67522','43541','91620','41462',
                          '76580','44773','81350','18194','62098',
                          '52010','88252','55235','51475','27973',
                          '44083','36683','93184','51410','95222',
                          '90814','70023','54814','77191','73665',
                          '89022','56319','77238','98558','97104',
                          '56829','92578','38800','38824','84384',
                          '42289','37713','29202','52963','15743',
                          '41085','26939','10341','91547','95828',
                          '40181','50195','30736','90625','88480',
                          '85129','85511','80334','68737','22474',
                          '28705','77767','14329','94508','10622',
                          '22494','55644','60977','86799','49429',
                          '53006','39863','80960','76384','19268',
                          '33176','43977','83317','99206','83531',
                          '23892','40898','15065','27064','99404',
                          '31813','94478','34727','58562','43748',
                          '60955','45969','85349','15982','99846',
                          '79721','10637','39896','57180','62290',
                          '85194','43898','10325','79691')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


