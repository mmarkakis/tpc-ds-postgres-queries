
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '98211','45714','33255','73420','28793','21800',
                          '30571','82125','54822','78661','97031',
                          '46976','76365','56052','13370','71585',
                          '26429','20302','16638','64554','87086',
                          '49852','39302','39147','29476','96283',
                          '36856','46572','21959','87036','45117',
                          '85266','62913','28889','21191','15157',
                          '84551','20464','89430','85084','31820',
                          '67711','30218','73260','93781','49370',
                          '38892','95145','86052','53056','69417',
                          '48512','60821','18180','90517','89819',
                          '64995','22287','51695','13836','44203',
                          '47396','50259','74903','19778','78407',
                          '91421','73563','93576','27524','76683',
                          '92294','43602','12306','30295','38978',
                          '88019','11351','77149','27073','14105',
                          '20622','82243','71831','68243','85460',
                          '15783','54858','80103','80277','59932',
                          '86116','39948','85328','60106','20407',
                          '51364','35272','40593','20459','76590',
                          '72088','11099','62836','52899','86580',
                          '55091','64434','96545','94647','19840',
                          '51066','64258','10411','46780','20270',
                          '81701','56732','56267','18238','35370',
                          '29893','59146','27181','47231','80954',
                          '83073','93042','93715','38960','76881',
                          '49993','93759','65434','87651','36342',
                          '52787','75812','75589','36393','59122',
                          '86917','42614','56822','83300','47601',
                          '41122','63991','36155','80193','24239',
                          '60406','46110','60763','27527','86348',
                          '54819','71795','12024','71066','89412',
                          '52920','70328','39874','89791','85377',
                          '71472','86419','26539','94911','99210',
                          '85255','41353','19641','48946','98536',
                          '33925','87985','19536','30530','31244',
                          '36908','32589','60336','71557','33886',
                          '45766','98860','40537','33202','65086',
                          '35955','77744','45871','57080','87735',
                          '88215','29412','16641','57659','17443',
                          '45500','67769','88858','49145','55805',
                          '15048','11049','90726','43854','95613',
                          '94319','99257','90904','66349','33236',
                          '84835','99037','63047','19391','50348',
                          '87366','23087','29779','76279','28413',
                          '77098','82326','84080','83045','14586',
                          '98092','97515','73795','79094','20593',
                          '61543','60420','23555','53870','93990',
                          '40294','24485','68453','74909','69701',
                          '94856','58069','34607','16374','82363',
                          '80363','19208','67025','92534','91371',
                          '25647','25796','48382','67506','50391',
                          '68177','73812','14966','89562','77832',
                          '34541','35830','96629','91947','89283',
                          '74862','78292','32570','98979','75948',
                          '72623','46660','66029','57278','80637',
                          '96506','54387','80325','54970','46427',
                          '91209','80321','19445','21139','55475',
                          '35406','90930','82950','34783','56328',
                          '28663','79404','27116','80977','63687',
                          '36611','55767','82651','38723','68762',
                          '16691','22812','62503','98115','72921',
                          '13475','93456','46766','11590','23842',
                          '43523','63277','74675','44455','76175',
                          '34784','39050','12284','82979','50334',
                          '67147','96532','89104','32518','35892',
                          '71215','34073','10007','44517','38564',
                          '28455','77958','24712','32987','61567',
                          '41492','77249','43794','76902','15858',
                          '98249','27320','68770','42220','32184',
                          '52019','55857','98583','17373','83820',
                          '36268','61151','23269','31777','72628',
                          '97205','59202','68075','41628','45897',
                          '83066','30622','40390','23338','29634',
                          '43371','45664','89570','65279','26349',
                          '54460','61098','35160','63268','77333',
                          '97435','79985','20442','49688','55706',
                          '55526','16390','34840','72439','30096',
                          '17769','68738','90698','17798','90038',
                          '38642','98239','56733','56877')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


