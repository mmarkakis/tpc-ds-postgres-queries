
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '61008','34713','54295','54641','16872','35690',
                          '97150','11170','28697','99058','62666',
                          '71101','82842','13521','21990','30601',
                          '12025','99251','46016','13198','12269',
                          '82655','79569','36243','49265','44054',
                          '48865','66626','98823','49782','92974',
                          '42831','30186','30769','80287','29361',
                          '30437','49568','36620','74701','18080',
                          '10194','15991','62283','64021','76856',
                          '60171','71958','35087','46961','57605',
                          '71455','96708','47434','71529','79932',
                          '61304','16145','59004','54530','16000',
                          '32431','76457','58547','84904','75427',
                          '66777','27533','72852','17224','49127',
                          '79918','39092','48292','74440','14316',
                          '70049','95082','87028','36135','84046',
                          '25379','55525','49788','25399','66170',
                          '88366','55181','46063','57702','31353',
                          '50994','45315','84821','39267','82572',
                          '27832','35948','91084','39932','98264',
                          '57592','62574','98931','25258','64454',
                          '76115','81894','90565','35466','19880',
                          '59977','56974','91141','73481','84973',
                          '38911','99699','79540','76740','12548',
                          '16164','16622','82016','35830','19000',
                          '36990','92469','71829','31440','56093',
                          '22915','62148','96517','18697','41926',
                          '72102','54879','25986','74902','22420',
                          '13070','37093','16571','16726','11669',
                          '26758','79837','86937','69851','40691',
                          '63772','55454','15678','16541','40593',
                          '44363','24283','44712','13720','15486',
                          '28784','16428','72199','88295','70957',
                          '94075','31847','20538','31384','67808',
                          '97351','74076','52254','24692','91094',
                          '71894','96380','48695','97582','32919',
                          '14415','53907','55042','90064','51547',
                          '76509','43230','91152','39149','10366',
                          '77928','10606','53977','46022','16720',
                          '77901','68037','37131','76397','99826',
                          '56331','47492','96166','56000','61475',
                          '94080','15733','33474','84082','56226',
                          '86825','14733','39977','40508','88749',
                          '98269','26049','80381','65416','44957',
                          '99668','75646','86151','32162','88524',
                          '95546','58878','11574','70661','51813',
                          '18637','32743','63962','16569','10219',
                          '92711','98730','83026','63453','19417',
                          '65835','91756','91942','95983','67935',
                          '95048','72686','94791','58471','47233',
                          '17824','50512','19412','91254','95736',
                          '25175','51405','91841','56019','11834',
                          '56013','33490','27668','25112','67632',
                          '27321','59304','59284','10954','86712',
                          '94004','26058','72865','83947','64964',
                          '56160','43907','16030','14468','30276',
                          '81788','24955','28192','61162','29203',
                          '13921','51224','23667','63096','35745',
                          '97414','92911','98951','72171','91241',
                          '82324','55416','40411','62335','97135',
                          '57307','23550','54364','52405','43683',
                          '11701','31454','90579','12123','15748',
                          '10348','67840','50896','34112','67852',
                          '81810','29720','67168','85508','63676',
                          '91384','96980','35674','26628','45950',
                          '14596','76808','66610','53613','88348',
                          '49860','88715','40945','50910','29883',
                          '22021','98557','89031','19409','61394',
                          '82748','51265','63282','90342','89265',
                          '95896','87205','86258','64145','56354',
                          '63451','77071','60770','11611','98411',
                          '85878','58475','60078','48526','50345',
                          '46272','50974','58403','15789','77094',
                          '42572','32701','58011','47330','79136',
                          '83867','41197','17974','99650','94299',
                          '35826','56120','98485','83487','14608',
                          '54821','14456','24193','67773','66827',
                          '93977','55255','48759','88997','26151',
                          '11798','91051','46081','90711','85470',
                          '53333','73904','39641','56898')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


