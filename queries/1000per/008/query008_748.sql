
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '13370','54139','77296','65229','93232','86787',
                          '61568','66565','71850','81035','68146',
                          '78838','79897','34863','41644','84801',
                          '25787','51274','71895','19459','93973',
                          '41068','54311','75281','85876','86706',
                          '94259','55435','46531','41323','18805',
                          '79560','78057','76076','41695','92436',
                          '84731','11901','79638','16107','47941',
                          '59550','99880','96576','94299','34773',
                          '44987','22870','57536','19129','45149',
                          '33550','73301','44418','68097','29348',
                          '80666','44549','21358','24741','14236',
                          '65420','85554','99828','83182','17008',
                          '85596','55780','65753','19365','36962',
                          '61862','61995','83772','27572','89135',
                          '68490','72103','65731','78946','82831',
                          '58600','56072','46892','37947','15696',
                          '77604','48848','67325','28865','99460',
                          '34314','64204','14396','40177','96078',
                          '37075','21778','27029','32605','92253',
                          '41461','77653','82701','29334','10406',
                          '69574','39997','22565','74851','73723',
                          '73850','24617','53007','43178','76131',
                          '51371','17014','34553','34831','25129',
                          '54258','89034','59853','97812','10877',
                          '67431','88614','66644','49806','91418',
                          '69688','73884','60326','49721','48970',
                          '70650','37399','83223','25276','83120',
                          '12194','95431','90717','15749','12651',
                          '50669','78144','97445','47678','31038',
                          '24145','47054','70971','99439','83358',
                          '96152','84886','55584','48833','67815',
                          '17168','42455','39242','76727','45387',
                          '48977','63008','44696','75401','63154',
                          '32747','18553','80507','71298','10611',
                          '47330','52509','74590','42265','95241',
                          '71047','64697','72852','65193','91807',
                          '66077','23755','24148','30808','87029',
                          '29487','64841','40223','56916','63296',
                          '97756','65334','84515','22944','14166',
                          '30644','21073','25799','69769','95193',
                          '76892','55022','26013','83225','92966',
                          '20497','89803','19889','13850','16574',
                          '67638','17118','41690','95889','39577',
                          '68182','55478','30870','71413','89159',
                          '36267','23393','18722','11526','78250',
                          '15944','75433','11388','33787','15386',
                          '44645','56253','40412','60516','25974',
                          '51506','76093','79151','54191','19664',
                          '53056','41018','98678','63739','66655',
                          '96105','16702','95904','86578','90471',
                          '95295','43618','38066','73988','82209',
                          '28250','93615','72517','88655','33654',
                          '50015','66436','34231','51243','28425',
                          '33109','60839','82406','28761','79266',
                          '86788','13987','55279','23261','87950',
                          '70898','23759','93518','46079','92671',
                          '36830','47671','97933','44802','27811',
                          '13258','37928','64402','14481','90967',
                          '41477','53916','82050','17694','24603',
                          '89860','47727','69482','85661','98259',
                          '45315','77630','63499','61207','41446',
                          '74069','98298','49904','30063','93693',
                          '79065','61961','31424','63258','40100',
                          '17908','77279','82596','65545','91933',
                          '85614','84763','51025','91827','43794',
                          '62139','46495','30282','71166','83306',
                          '81481','49943','67442','79411','97904',
                          '84991','82312','50899','72727','69538',
                          '15104','24121','93277','92187','69142',
                          '48237','90830','43180','12725','62868',
                          '65189','96684','37802','84690','86280',
                          '75356','57697','75975','86320','58140',
                          '17160','90409','62357','28931','60663',
                          '18370','98186','65116','82464','96956',
                          '93293','57857','22066','74472','44328',
                          '31126','26223','88114','81708','21191',
                          '85108','12543','90585','57925','25931',
                          '59927','13351','42130','31796','20080',
                          '47897','68840','17903','47125')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


