
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '27257','65675','46311','33662','27901','73550',
                          '98271','96057','78331','62233','35051',
                          '75592','89075','67870','97665','88794',
                          '20776','17281','93344','10730','20155',
                          '18050','58964','86806','12667','54916',
                          '19301','35564','42386','63238','63361',
                          '26684','28240','67144','23020','58304',
                          '26803','86559','43952','20443','76511',
                          '26433','59546','77627','34662','19809',
                          '33640','86241','75611','38542','25471',
                          '68153','13041','31670','47112','58850',
                          '93490','99454','65904','90462','69920',
                          '65176','12884','93905','41214','64774',
                          '57863','60562','72620','55767','27392',
                          '86656','42126','20215','75573','89597',
                          '29567','58965','29512','45121','86371',
                          '48128','74916','68628','21846','53471',
                          '76387','85490','86296','28805','60089',
                          '51955','27628','29264','76172','61211',
                          '52937','73646','81934','63449','10654',
                          '17617','60134','95724','11510','69970',
                          '77617','54571','65379','98279','73165',
                          '67446','57324','77085','84877','26019',
                          '79078','12374','90579','97021','10718',
                          '11821','13033','70379','24134','53807',
                          '73004','90877','87195','45565','90801',
                          '27166','25963','49759','93459','28774',
                          '78377','84879','92986','53866','75977',
                          '53810','12842','42908','27394','15730',
                          '29966','39900','43023','29288','75629',
                          '77703','86828','23928','24706','21866',
                          '93022','71368','79494','45079','71369',
                          '81628','46111','91734','53617','72826',
                          '86111','88877','44065','92773','48520',
                          '64406','10770','64323','35358','77932',
                          '13912','67696','28497','67796','53283',
                          '30262','87841','56157','71807','26263',
                          '90212','19930','86579','78661','55681',
                          '67838','64559','47581','22854','59988',
                          '40496','12581','17066','11129','58882',
                          '84505','62522','27131','46151','28887',
                          '70288','30032','95092','69661','26950',
                          '86826','79179','87729','10238','93984',
                          '87063','77388','69044','61209','23959',
                          '32175','34976','89518','73572','29482',
                          '30656','41432','92427','38765','64226',
                          '69990','47072','38744','38658','74888',
                          '92045','43185','86589','71630','33887',
                          '74346','56680','51079','18846','29605',
                          '90960','94048','47067','18509','57205',
                          '91433','99288','92858','61029','15446',
                          '47369','12686','10090','13089','39377',
                          '21802','56952','68506','76656','41393',
                          '93175','75862','89813','48090','29296',
                          '36658','18133','92293','48460','24409',
                          '59956','78952','21961','55348','11426',
                          '64365','71138','97879','89894','56599',
                          '61907','77527','10712','85386','98791',
                          '92873','95877','34477','78474','39607',
                          '95266','10387','28462','63308','10183',
                          '84232','89442','97707','56191','38890',
                          '82907','66082','32487','71797','32153',
                          '87017','24242','46893','74793','51057',
                          '19394','54625','30232','94108','52411',
                          '18381','77373','23964','34414','15133',
                          '68034','10131','60878','94328','50218',
                          '24382','31494','12229','58559','28555',
                          '56585','66498','25230','94452','38993',
                          '65174','63306','72974','18744','89562',
                          '42504','38026','41705','15922','75702',
                          '63890','49588','97185','95170','99600',
                          '73354','12170','30069','31377','76245',
                          '73621','37588','22754','50907','19561',
                          '17375','65836','17090','83945','10805',
                          '56153','72610','41072','18158','13686',
                          '75998','43565','97186','75538','16846',
                          '33326','74956','50867','18735','41321',
                          '70778','97699','97757','57619','30834',
                          '35454','35467','52713','70858','58688',
                          '51873','84067','11406','89062')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


