
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '13026','67850','19526','29025','78095','98402',
                          '70817','59855','62089','83179','47579',
                          '98246','44027','98465','10239','83816',
                          '62506','15044','25933','78746','80599',
                          '49230','55955','74604','91797','33912',
                          '23762','68451','79014','52869','15801',
                          '48506','31502','25269','91748','67374',
                          '78674','22165','54039','43135','79551',
                          '45029','87625','48862','53601','44065',
                          '77394','69709','57953','92796','95308',
                          '98062','87202','21840','49775','62832',
                          '67347','31342','88472','41373','83649',
                          '30762','79543','50658','97155','56799',
                          '96978','40269','66147','63758','23918',
                          '87605','79251','32378','83862','51038',
                          '83721','78453','47040','36599','74256',
                          '65088','61806','85627','90088','32387',
                          '62170','92728','14397','81307','93369',
                          '96971','62559','75635','12007','21971',
                          '96546','74713','29898','93268','81579',
                          '61272','70160','20703','23905','45036',
                          '83095','20168','62472','67981','35296',
                          '96325','20212','78444','55059','72202',
                          '75232','64114','54103','45968','23432',
                          '54249','21333','68340','11206','82813',
                          '92284','92624','47817','10923','57083',
                          '84995','16976','88383','52116','22098',
                          '97059','58980','15710','89380','84029',
                          '36198','87941','27243','77163','38678',
                          '33957','29520','85728','32810','24266',
                          '39561','37793','64279','29932','12904',
                          '57971','58545','45356','11723','85803',
                          '89672','45917','28174','39035','85078',
                          '23251','51286','92943','46215','50462',
                          '80218','63339','48900','83896','70043',
                          '20029','40290','43153','83856','45532',
                          '13431','87946','25811','38129','21508',
                          '50426','90292','49606','57951','35682',
                          '48335','80386','76846','68724','11627',
                          '72826','82135','60908','68150','50088',
                          '73726','23884','75174','97139','88938',
                          '60092','51012','89205','57604','60310',
                          '65162','44965','62988','17155','53974',
                          '42838','27176','45832','52429','90861',
                          '71576','89968','45038','46898','23332',
                          '97160','70865','90855','30029','89275',
                          '43096','42971','71167','13978','91812',
                          '52359','96170','97914','66686','54822',
                          '50987','97658','83129','51678','25743',
                          '74369','96015','19431','53448','59241',
                          '72858','65542','91980','97421','44357',
                          '91761','10122','17054','49196','63094',
                          '27816','21620','33447','70504','58448',
                          '88694','30139','83906','62306','49413',
                          '48905','64254','96850','49444','60849',
                          '21856','58620','29996','57610','94767',
                          '63810','84031','50397','86826','58764',
                          '68294','43079','25838','57236','16316',
                          '55869','89369','83826','37744','53527',
                          '43244','44823','70761','38923','84586',
                          '40332','23913','60458','64924','38928',
                          '44315','37153','91610','66657','23425',
                          '79110','28294','83264','36321','18065',
                          '12737','51947','99189','93278','27726',
                          '35564','38717','45179','78428','21709',
                          '53737','45584','38471','19990','77336',
                          '48023','23586','24375','19583','87529',
                          '72827','72216','53056','43060','41366',
                          '90548','59322','65326','39932','41501',
                          '24526','25220','96731','34590','94278',
                          '39592','87133','38387','57726','46556',
                          '41560','45661','42662','97373','93379',
                          '35864','66720','19452','60655','71096',
                          '51639','46905','78735','71350','12798',
                          '65316','13000','19163','67149','65384',
                          '20229','90332','89061','18697','93890',
                          '48399','91190','99639','90246','56250',
                          '52268','78392','45506','89984','97363',
                          '34238','96674','52083','33290','68797',
                          '77728','25112','94371','25772')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


