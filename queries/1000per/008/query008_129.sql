
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '72956','86026','96052','78464','24663','98395',
                          '76385','68831','63508','37541','63649',
                          '51029','84897','96439','64230','67659',
                          '35945','28813','64592','56055','46204',
                          '32347','42012','44792','34301','37504',
                          '53931','25292','49889','99391','41872',
                          '12466','16240','83178','91948','87778',
                          '85499','12820','96044','37915','89143',
                          '97746','30958','95211','23197','85924',
                          '38003','73104','60092','31865','11740',
                          '77677','46934','52505','10794','13225',
                          '72622','30196','56382','51722','18610',
                          '83108','29693','42878','77942','35819',
                          '79744','65208','33691','66550','79736',
                          '64378','78491','85379','73172','87485',
                          '11307','40132','89201','72182','27599',
                          '22396','85401','46352','30813','96864',
                          '53738','66667','61746','81999','36586',
                          '17125','16631','78805','47359','59439',
                          '42069','93385','76834','20039','15936',
                          '62828','11185','39448','88898','63391',
                          '99753','85041','85960','52259','29369',
                          '64408','64727','53974','10567','92470',
                          '52789','12124','84472','50624','44370',
                          '26876','87974','76407','56319','94272',
                          '13656','37657','42226','77788','43244',
                          '59746','86356','33623','49601','84057',
                          '29738','89879','68707','86800','76748',
                          '86762','13373','90359','72479','52171',
                          '83365','89546','69566','76883','32814',
                          '90388','24127','92155','35214','65326',
                          '83972','33314','53773','93991','26868',
                          '67005','63276','38040','87119','41568',
                          '15014','31915','35518','40382','90612',
                          '78458','84336','19606','15462','88308',
                          '34267','21166','94830','48080','57878',
                          '86719','25598','66435','54848','97274',
                          '39329','97226','16447','96131','90085',
                          '66151','50758','73796','94734','28578',
                          '58823','17062','21372','51857','92899',
                          '80978','75836','31090','98052','70163',
                          '25515','45905','57570','46940','81954',
                          '76425','54632','35095','18958','48557',
                          '48462','78646','96304','75347','75139',
                          '42826','63210','78098','93307','15461',
                          '61258','86287','87451','38893','68165',
                          '85422','33325','37616','21012','17962',
                          '64872','46531','34168','78244','17714',
                          '16847','64643','94477','34622','84621',
                          '68994','44372','12539','76348','88395',
                          '20661','58177','56413','48777','64349',
                          '66054','42793','35148','11865','21231',
                          '96829','59208','16739','53797','29900',
                          '22970','58010','63048','51264','14218',
                          '79303','22947','74926','74059','65142',
                          '14654','33180','56434','59107','79185',
                          '94223','10430','84718','78417','25069',
                          '60624','31434','68983','10577','70119',
                          '79337','91862','22176','23642','77273',
                          '47683','67333','56587','90980','30079',
                          '87246','71041','33447','88604','41484',
                          '29012','91936','64368','39906','23621',
                          '22029','44811','84967','84851','18450',
                          '67491','13602','27253','33402','65897',
                          '97399','56222','89990','42245','15579',
                          '51949','85636','85755','91032','82697',
                          '48392','11959','76552','99650','65050',
                          '72971','58125','67269','81131','59181',
                          '55612','55979','62047','95342','22494',
                          '58557','77128','88263','53577','72635',
                          '26503','91405','60920','21673','30603',
                          '57990','75088','99878','89077','53053',
                          '46188','16522','25875','55975','80146',
                          '65771','82336','24128','59675','93737',
                          '67164','82610','35892','99641','69749',
                          '34683','16142','47095','28734','98615',
                          '70695','13375','55423','80549','80124',
                          '72445','41039','32689','49839','41591',
                          '98479','52529','67019','62439','26031',
                          '94873','36598','53719','71780')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


