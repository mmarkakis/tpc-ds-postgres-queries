
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '31767','97489','71745','27523','26788','97986',
                          '96656','80653','97844','44709','47997',
                          '61706','54145','66520','33229','58341',
                          '29892','67901','42968','28891','33189',
                          '46560','88313','99684','43764','54787',
                          '25197','25584','14392','19339','12974',
                          '12402','84309','60226','46150','21701',
                          '44669','89468','20225','40078','84191',
                          '87985','97164','32159','59977','60175',
                          '67779','98313','74031','65592','52647',
                          '63288','10067','23937','97827','40065',
                          '17400','77257','62125','76244','45302',
                          '23409','45758','37936','86490','96987',
                          '56015','71671','40923','61316','77989',
                          '64679','91854','65141','51345','81952',
                          '39873','25163','40447','73458','63327',
                          '67190','89306','86156','81296','75476',
                          '85523','56070','64088','13890','70283',
                          '12997','93697','17512','71828','51180',
                          '83650','62744','22003','14811','10459',
                          '59496','81720','59455','56165','69465',
                          '52749','84461','28453','27671','62610',
                          '49992','34415','71429','69362','21037',
                          '95369','53135','99338','40634','90492',
                          '84647','44986','92388','90913','67055',
                          '14379','33284','38546','57413','41254',
                          '94472','54761','50581','28670','76684',
                          '34373','15374','77497','28014','43784',
                          '22136','48011','13917','95339','98176',
                          '84089','54662','23212','36315','37597',
                          '88137','42117','20878','43920','93254',
                          '28274','31404','54255','16604','71798',
                          '30995','55253','67929','26272','28765',
                          '78379','95272','56390','92693','38574',
                          '34868','83995','32766','55372','84893',
                          '35233','32557','64909','20283','94856',
                          '11457','94158','72581','13123','90134',
                          '75314','21020','33995','48925','77043',
                          '86941','85956','63115','86862','25315',
                          '32905','67880','22609','57867','31774',
                          '52747','35206','92118','72183','33802',
                          '28094','57584','68969','18288','58823',
                          '74781','97004','87113','54702','89945',
                          '36499','31113','23071','78451','40964',
                          '92573','14039','59423','79569','82063',
                          '32849','35489','59819','94485','61229',
                          '83426','88511','38664','46921','41630',
                          '67831','22767','74574','11379','10949',
                          '10378','10432','80483','26186','58955',
                          '20641','42615','54060','21526','63848',
                          '97012','74741','63694','24721','36852',
                          '61790','78570','80393','17522','96686',
                          '68704','84830','17297','20755','60046',
                          '50999','20415','85746','32852','54704',
                          '31290','61887','32009','94439','38047',
                          '48381','82050','77343','84891','54581',
                          '11512','72944','37502','28588','56445',
                          '26623','51334','63121','33508','93744',
                          '99241','20006','54818','73189','44001',
                          '88286','64074','92653','76364','83987',
                          '40872','59776','57771','41478','71964',
                          '64456','73637','66515','79366','21898',
                          '67387','89672','18119','84320','74015',
                          '34056','85635','12547','67353','42277',
                          '21317','68053','24631','20511','81250',
                          '60855','27548','23688','38570','65130',
                          '22380','93926','78932','10107','22038',
                          '49948','44806','99725','49373','81433',
                          '75622','15635','43702','93090','25521',
                          '98231','47422','29403','40005','89802',
                          '79593','31011','79439','26067','22366',
                          '47877','70752','73432','66106','90455',
                          '82894','54758','74820','90886','42502',
                          '74700','61869','28298','13866','33024',
                          '59133','87601','78239','60281','46832',
                          '12557','12735','12024','17273','41075',
                          '32135','56218','27882','53998','17722',
                          '11241','44531','63668','63442','81566',
                          '63040','68257','25637','57785','24177',
                          '76658','16861','59812','67431')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


