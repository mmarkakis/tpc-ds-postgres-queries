
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '98651','44332','11317','26892','40420','71956',
                          '64507','92671','92597','50363','97126',
                          '24969','70456','40591','81241','90725',
                          '50223','66858','41646','62909','88541',
                          '50535','12065','70537','82938','31686',
                          '89331','28286','26419','35736','12139',
                          '74731','55142','12009','85336','85750',
                          '96035','51185','83529','86995','86276',
                          '98593','64176','97372','18020','77972',
                          '80560','47074','61714','56607','49630',
                          '81131','45474','88549','27345','81867',
                          '82811','42261','18539','60137','23836',
                          '52572','18300','71596','12827','19566',
                          '68462','41507','58011','50305','36668',
                          '60326','31585','16045','47380','76396',
                          '35084','69137','93161','46399','66460',
                          '56467','22394','14677','56882','21388',
                          '17328','82905','24426','32354','98435',
                          '31416','34524','92762','75147','91751',
                          '21405','10091','30957','17269','58402',
                          '73913','67248','66220','32821','49793',
                          '92737','37488','33202','36378','17347',
                          '99760','71760','37654','87407','24182',
                          '81710','28834','13517','75986','66365',
                          '18422','41116','21043','32725','56076',
                          '29723','12920','98138','42714','54786',
                          '13911','27955','80575','13209','63679',
                          '55147','95100','11774','96982','61955',
                          '87671','53340','62693','18879','26532',
                          '32783','92785','21457','49073','63878',
                          '52994','62595','30915','24168','26874',
                          '13441','57062','97519','58888','15839',
                          '74428','68922','55996','58309','72337',
                          '56232','94261','79433','20657','46739',
                          '39118','46094','48778','59436','48164',
                          '98144','21270','62288','31896','72822',
                          '35569','25833','68015','30849','41485',
                          '13351','76105','81821','10523','41077',
                          '85337','16446','86545','65854','12805',
                          '43950','42962','95717','45139','32384',
                          '73448','18833','89570','29574','19002',
                          '16908','60332','79083','32656','90267',
                          '99480','22841','79194','73451','32075',
                          '81519','79822','95558','28289','44811',
                          '88025','88668','93609','27701','65207',
                          '10635','72168','76675','59678','69894',
                          '91056','97671','46090','42903','35177',
                          '93313','25823','12234','83512','44474',
                          '66483','20186','52747','58878','77833',
                          '73397','37669','25278','84794','32643',
                          '50457','78465','83551','72521','18041',
                          '91966','23652','65269','23236','66258',
                          '65307','68437','33556','67440','35229',
                          '74619','86855','13594','49511','65560',
                          '55540','20285','56332','15424','94476',
                          '34549','50925','24188','56765','15401',
                          '49538','55431','97558','25303','18799',
                          '93569','67633','97296','11368','42428',
                          '79028','68161','30180','87054','61163',
                          '21014','33850','85762','83248','23945',
                          '77107','83468','22538','99097','39677',
                          '13119','38616','61465','57804','23175',
                          '38362','34618','14575','29475','86787',
                          '21512','25687','29109','64788','88645',
                          '37480','33523','59358','95340','11921',
                          '79361','86827','26663','87519','69197',
                          '85070','43677','44226','48119','78329',
                          '85746','29229','23568','19371','68434',
                          '42110','47853','30321','67718','61298',
                          '93662','70124','36558','78176','93476',
                          '88802','71908','94795','81712','70641',
                          '19627','35220','21093','78048','20386',
                          '80353','82754','89356','36468','25876',
                          '55456','76669','19436','18455','87856',
                          '50339','94815','98778','79168','33662',
                          '71393','80100','69985','28822','19369',
                          '66035','19447','95188','72235','86311',
                          '74041','79252','27810','54511','96576',
                          '77022','34658','36548','14518','23100',
                          '93433','69499','17152','20044')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


