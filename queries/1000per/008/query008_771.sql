
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '10926','42182','60017','88126','73970','63344',
                          '13017','83503','45296','51952','28096',
                          '58633','25493','74675','91607','29464',
                          '51936','37953','46450','92735','16754',
                          '38833','56865','78526','28055','30747',
                          '15169','13365','81411','58919','56016',
                          '42445','30967','90418','65720','93893',
                          '28926','11062','56752','66723','52584',
                          '43520','85844','84321','92458','87181',
                          '57007','98915','76276','46505','43114',
                          '27202','68320','73828','73719','29194',
                          '96739','98719','10413','76808','79395',
                          '93264','68016','50842','69740','55270',
                          '61881','30325','83356','63244','20765',
                          '73163','11331','51304','21840','15977',
                          '53909','47381','94889','54183','51039',
                          '21256','73230','54624','25737','83705',
                          '66325','97410','60505','97967','44327',
                          '62342','17555','22393','40702','41763',
                          '90900','41735','73538','76771','54006',
                          '96217','13442','12267','16286','46258',
                          '41706','73827','21310','90372','37030',
                          '23658','63482','33592','68576','27755',
                          '23666','23656','49893','98219','44763',
                          '38231','24152','54172','32311','77483',
                          '27398','82316','20244','27003','90435',
                          '57987','97853','78258','17738','67939',
                          '80736','39323','95258','43257','17653',
                          '91327','55438','38248','85620','25239',
                          '67954','36662','22337','66664','71029',
                          '10491','66295','82731','44066','40065',
                          '95041','86722','67850','54067','51466',
                          '89665','11598','21621','21890','11125',
                          '72883','36540','23491','39999','95841',
                          '70604','75612','35818','38106','45288',
                          '11753','51457','13904','31210','11012',
                          '45718','15936','10956','13196','72612',
                          '94061','67880','66829','17523','98427',
                          '73729','95828','96350','32151','91874',
                          '82793','55028','81981','66869','55096',
                          '90578','45218','65414','59499','40905',
                          '27393','44035','51614','22449','12174',
                          '70567','64435','83334','28188','69358',
                          '21269','75488','15785','56841','82048',
                          '52379','45467','95092','44638','25537',
                          '12711','50357','24166','40812','79559',
                          '58221','34763','78770','46051','19610',
                          '34021','46185','72806','54644','80586',
                          '91096','18671','62173','66236','36073',
                          '74285','41605','88204','19698','15031',
                          '89447','55572','63882','14418','84403',
                          '65948','13770','41114','63596','91837',
                          '32565','33732','21726','32815','45478',
                          '20083','87048','39118','65188','51472',
                          '62804','82893','66511','18242','98400',
                          '33518','52034','36501','64031','65712',
                          '84040','66273','96934','32696','15837',
                          '96016','22023','78547','60666','93265',
                          '29156','57443','50874','88827','50502',
                          '24732','28404','99824','54539','79875',
                          '36622','11455','77540','90068','13528',
                          '77521','80011','60411','82842','83741',
                          '98317','70671','80634','54412','82848',
                          '19744','90367','88958','99222','44146',
                          '20797','59905','25873','12096','92409',
                          '93042','62820','89489','13220','59220',
                          '95345','92231','85116','52166','20880',
                          '31253','62911','11607','78536','92058',
                          '57686','27821','24778','29060','95148',
                          '16832','76151','79447','84562','63959',
                          '90489','22310','72246','72823','11951',
                          '17768','84729','21154','57408','13524',
                          '25884','43217','79228','77693','33664',
                          '66951','94910','10803','90603','75882',
                          '70696','85059','17974','27959','64118',
                          '12036','34264','14443','23390','62862',
                          '10619','75184','19065','88613','21562',
                          '42566','19281','84984','22709','87112',
                          '14396','68058','10577','88925','14826',
                          '57975','27631','60264','24595')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


