
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '30561','97823','11766','24654','79955','20137',
                          '86596','60219','62865','29846','63210',
                          '76755','17931','35844','72135','48711',
                          '82816','76306','52963','34665','17534',
                          '59414','44176','56402','49206','96796',
                          '24659','34885','56893','45557','87209',
                          '41671','98017','98522','69618','56090',
                          '12833','95925','88302','27314','37482',
                          '89517','67011','31025','62591','42266',
                          '98284','21376','22263','68548','78110',
                          '49482','31320','78977','15215','35278',
                          '32409','52708','25024','27220','43030',
                          '75611','63647','12357','37302','36767',
                          '51196','22513','74732','89476','84399',
                          '41979','33003','15090','69260','58404',
                          '22751','34939','75013','74102','44932',
                          '87180','52671','27745','34262','56222',
                          '65575','62583','47170','23145','51738',
                          '96289','43825','53555','84621','49050',
                          '99533','55567','19665','91932','39985',
                          '28808','63495','95722','28019','12041',
                          '81428','59688','28841','41864','44335',
                          '33033','98917','31665','12847','69983',
                          '45669','48684','26285','85682','70514',
                          '60175','34226','59449','38386','56862',
                          '99314','29488','48891','72487','52726',
                          '79497','14993','98273','22990','44520',
                          '55192','75692','15109','23644','91321',
                          '65456','77577','88713','76801','32226',
                          '93932','22115','65394','41669','47709',
                          '35879','32374','95567','14398','28217',
                          '22415','45690','34792','28119','73550',
                          '61191','96884','22183','65714','70603',
                          '60495','38435','43574','12150','72564',
                          '45157','43788','88434','86950','31716',
                          '73111','21862','11598','61635','11758',
                          '30303','11276','90095','41205','48758',
                          '59110','91900','84147','76940','83414',
                          '95670','58251','52670','31572','32988',
                          '56340','71290','99431','63264','72592',
                          '46610','88299','43173','96663','23457',
                          '90591','59972','47757','40661','12047',
                          '54572','98104','35457','20923','15893',
                          '74105','36378','88100','66432','66583',
                          '15136','86162','52216','38592','82639',
                          '87415','48470','39980','66506','65359',
                          '77571','74280','31780','85724','48623',
                          '67492','73466','80141','77554','92193',
                          '69263','70408','90964','54241','24945',
                          '63388','38007','31223','71084','26334',
                          '51301','83220','20423','13759','26630',
                          '56730','49870','62652','87081','80740',
                          '35053','48134','70723','46040','10526',
                          '66151','36192','66178','28660','20872',
                          '40176','94008','81624','59034','28941',
                          '37179','95685','89479','66717','33726',
                          '45464','71361','34568','97096','72402',
                          '52242','64401','92542','76574','88997',
                          '11999','32964','52961','66421','59896',
                          '55837','46475','42934','48497','74106',
                          '58406','60441','20384','77320','44268',
                          '80835','14189','31386','15227','43500',
                          '30743','65053','72044','93663','57348',
                          '18593','51430','77532','31567','97325',
                          '59750','59713','80555','31672','66796',
                          '15324','14038','39479','40302','72933',
                          '28399','30739','32366','56716','22007',
                          '28795','52863','55769','65649','17124',
                          '92473','71627','19507','15484','39641',
                          '87050','70808','81679','21222','72638',
                          '95300','54455','67588','53181','24261',
                          '25696','75953','39556','57397','84044',
                          '20674','49550','59006','77406','25575',
                          '96602','60540','65772','16325','33802',
                          '70928','91061','87211','75491','69124',
                          '80247','36244','25551','92864','73707',
                          '52698','38695','55257','43443','99290',
                          '34248','62704','33260','60572','77604',
                          '12571','86729','27940','28667','64875',
                          '80635','58462','30335','58778')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


