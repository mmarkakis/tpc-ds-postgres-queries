
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '86349','14129','81203','95965','65992','54613',
                          '20782','24071','82556','33069','40451',
                          '48958','40156','59117','20318','22147',
                          '73091','98243','54389','21643','62718',
                          '68827','77654','31220','73745','83451',
                          '45482','21470','16559','50709','48307',
                          '26313','32771','35811','23741','88074',
                          '93729','51486','47356','44791','73772',
                          '61060','74920','70184','98673','77427',
                          '42827','91890','74921','35522','14372',
                          '82984','30075','45559','19066','27945',
                          '72656','31117','75306','81860','95843',
                          '53076','79838','83664','42141','51351',
                          '73009','29207','51873','56271','90085',
                          '73938','22067','54157','84329','41557',
                          '81415','34170','65177','45902','39327',
                          '55588','72220','19075','41933','11567',
                          '42616','70770','97694','94871','99861',
                          '72850','67808','70211','93521','27035',
                          '21077','57879','14931','91551','73468',
                          '73628','29471','51400','14946','43659',
                          '33353','15766','94176','38345','44937',
                          '92724','33680','21661','71197','44982',
                          '99302','66194','50832','90982','22337',
                          '29285','40669','95970','38100','43565',
                          '94648','83043','55168','24046','32973',
                          '58295','83972','27463','12710','63273',
                          '56634','18620','65829','20715','87552',
                          '75686','25961','11810','21403','63694',
                          '62069','77391','82385','24966','51523',
                          '40426','43119','36494','81097','16247',
                          '74720','94809','95591','79256','70023',
                          '46626','29151','78404','46575','70360',
                          '67073','94265','73132','16547','25938',
                          '69009','81998','78570','69317','29713',
                          '40021','51075','73432','10471','45384',
                          '67736','16774','71165','86276','96098',
                          '80820','31289','70330','51562','83799',
                          '58460','92191','75928','40520','74498',
                          '10678','79504','29442','86302','34807',
                          '84182','54777','57460','78604','80468',
                          '93416','24729','82248','76727','56707',
                          '36771','21067','32034','83919','48244',
                          '34490','53893','76565','48376','51259',
                          '14432','52017','27595','75950','74085',
                          '35920','52196','39783','62236','59897',
                          '20434','86665','92402','25063','34208',
                          '48320','17987','75259','65735','95552',
                          '15302','11255','29272','26483','40560',
                          '55247','22344','18336','93181','78052',
                          '44688','79447','70634','20466','50636',
                          '48709','41971','10610','21914','36950',
                          '39453','72184','10508','20945','57917',
                          '75201','98238','21572','45782','61391',
                          '36140','75948','99839','50128','47864',
                          '91509','81087','72027','57728','82985',
                          '12680','24957','48267','63460','51971',
                          '55614','58017','95180','13260','12589',
                          '89255','10006','21414','77005','97172',
                          '27416','82596','54782','10784','58067',
                          '55212','92857','44188','74543','72627',
                          '41418','81848','74727','67926','55957',
                          '91819','85179','60242','68882','36308',
                          '68464','69393','38415','59695','86917',
                          '40433','87933','80849','21638','68159',
                          '68286','27870','30718','25967','95165',
                          '55394','28644','79444','16313','39123',
                          '16514','62031','76717','97555','26041',
                          '39921','82280','66771','83247','48784',
                          '21573','26905','22951','61787','82279',
                          '20744','52179','82967','53510','49179',
                          '25058','79660','86273','57768','83831',
                          '65704','18621','72544','13687','33016',
                          '33535','50434','20635','39264','22793',
                          '53806','53343','34448','33570','85518',
                          '61061','31223','65103','75831','80464',
                          '38517','40396','69289','75453','23335',
                          '57176','29228','33979','82632','14997',
                          '44414','32592','56968','14252','98511',
                          '40283','36043','25477','99479')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


