
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '79248','89825','72489','71627','44133','61202',
                          '60735','90894','89245','16622','68897',
                          '34309','87848','30624','15023','81346',
                          '79969','48426','87087','78959','40635',
                          '80274','75816','92874','14894','32554',
                          '45846','51314','87280','64660','40597',
                          '45471','95829','60361','94402','90239',
                          '97969','10495','86065','73184','64494',
                          '81153','95079','39947','39077','73987',
                          '88234','60510','11596','51128','88674',
                          '75276','17021','84445','38513','63628',
                          '95459','16048','18892','80506','86576',
                          '43069','93725','30090','87346','31230',
                          '51094','13863','41689','57075','32124',
                          '99786','37339','82948','32975','75095',
                          '70104','18753','63817','91143','76402',
                          '60496','68816','56083','10696','25233',
                          '44508','85700','51275','76125','94464',
                          '54949','55751','56090','38614','96114',
                          '52102','85247','37927','14969','53899',
                          '77865','49090','87593','29510','80289',
                          '94251','44550','63016','60075','54844',
                          '17850','25528','32805','67967','16074',
                          '60940','14467','10602','60150','89839',
                          '47101','64302','59303','39823','20013',
                          '14229','92248','89032','98887','41661',
                          '86978','88016','75740','83072','42916',
                          '68154','55847','64700','59624','51826',
                          '24390','40149','59899','53897','81237',
                          '88822','65234','64840','91242','17552',
                          '33583','33160','54475','26054','90382',
                          '97568','27268','57799','90325','89349',
                          '91091','52342','93264','37009','17075',
                          '11819','63313','18507','81596','63495',
                          '24161','49901','73142','27831','71737',
                          '27874','49867','77741','20809','84382',
                          '96542','25897','45936','49639','90988',
                          '99466','38877','32266','73575','13352',
                          '83888','60777','33732','14547','42835',
                          '30841','10402','36002','54097','15941',
                          '87559','49612','30095','19230','35497',
                          '39397','27123','71671','64843','17262',
                          '20558','92504','81974','94020','38595',
                          '41363','34045','80310','10379','83527',
                          '56215','66382','72636','64738','93164',
                          '60170','80611','84498','69416','70978',
                          '12819','99348','68274','49703','42233',
                          '93907','25220','23434','60458','69977',
                          '70169','11400','74820','41101','41378',
                          '89910','42903','33250','29375','66070',
                          '93015','28824','87934','95680','94604',
                          '21361','79401','37084','99655','83025',
                          '68753','38031','99586','55712','66696',
                          '60161','58600','51005','97737','62698',
                          '65197','88343','20994','46417','75622',
                          '81232','42023','20011','88171','75739',
                          '31699','88781','79399','40898','63604',
                          '31656','42896','39711','35924','44976',
                          '96884','75331','32633','47731','10609',
                          '36179','10515','38798','90494','73695',
                          '42096','44749','87004','76950','47227',
                          '53404','55573','97844','50304','28900',
                          '20192','68340','33553','46406','86763',
                          '27577','87424','99289','41222','72420',
                          '34932','48156','13440','69225','51528',
                          '94444','68335','10021','50421','70986',
                          '68392','49719','20314','84909','40915',
                          '17578','60398','29339','62055','27686',
                          '55060','31181','97361','97629','36364',
                          '47223','79407','50689','35190','40270',
                          '50715','20672','55766','28418','69216',
                          '45313','87296','64698','35707','28634',
                          '36925','18675','44958','76614','51160',
                          '57748','35104','93012','51378','75744',
                          '72816','66963','72549','79906','71370',
                          '70382','44277','29154','83299','66738',
                          '49400','96782','18422','62033','31177',
                          '21955','55966','86237','85071','85063',
                          '94166','19934','98213','46322','76262',
                          '95166','30409','26261','91485')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


