
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '36972','15079','19105','68238','36697','31094',
                          '19071','49203','42406','24651','58864',
                          '81908','74083','40246','64112','36283',
                          '39136','76732','48691','99576','59556',
                          '79786','39297','45836','45065','31854',
                          '24845','21648','74720','32683','69474',
                          '97889','29313','29307','80667','31229',
                          '61397','90882','87370','16512','32945',
                          '94633','55389','33971','42176','87389',
                          '64879','19408','26527','77918','49535',
                          '26300','58368','66498','85624','12919',
                          '12530','10146','24325','67248','96279',
                          '34128','55511','85871','28190','76422',
                          '42354','87407','45356','50123','15375',
                          '37386','86595','80840','63912','34193',
                          '69645','22679','37812','64444','31295',
                          '13346','68056','71419','21317','30873',
                          '29728','95050','33617','52260','61084',
                          '17387','30983','11729','49044','59904',
                          '36522','20595','56995','37764','88614',
                          '56194','31150','98156','57169','32133',
                          '78536','38656','68843','21577','85969',
                          '50374','60761','26478','44480','24579',
                          '27417','59957','66518','75475','41884',
                          '48761','98377','94490','56337','35922',
                          '56394','98613','97007','76266','49955',
                          '98441','77730','78935','42109','60453',
                          '28876','19095','83158','15580','30204',
                          '88775','63711','54392','98772','94253',
                          '23122','98308','19077','43687','60752',
                          '29976','81983','92700','79248','95092',
                          '49377','30682','30439','46453','12937',
                          '89704','29140','11494','97086','98806',
                          '64501','72356','73448','18146','46204',
                          '25964','93059','22494','97709','41427',
                          '51303','44060','45635','25925','18959',
                          '76391','34719','92065','49324','57752',
                          '70561','42767','39232','42635','76933',
                          '40150','85755','97615','92018','47483',
                          '92788','43027','85345','65583','19238',
                          '33819','85151','20784','93537','51336',
                          '95332','92319','24962','92188','65430',
                          '92862','51847','65772','85611','44879',
                          '52029','26285','81653','58993','52897',
                          '54916','29410','69569','14110','22517',
                          '31096','12542','57273','25538','74994',
                          '10937','59109','61592','63338','90925',
                          '25472','42770','68554','39645','62161',
                          '64230','56748','66018','67454','33720',
                          '19993','70886','36022','32886','99510',
                          '39780','37210','91318','20512','92580',
                          '20282','94390','15851','49355','62572',
                          '72392','85281','69534','44711','45389',
                          '98492','30555','31362','85638','51762',
                          '15888','62620','19450','68929','24343',
                          '23939','15158','11505','82174','18117',
                          '22709','45690','60613','67687','42405',
                          '60240','26246','74787','67851','35545',
                          '62300','51638','42101','72982','28528',
                          '82186','27335','73006','18060','74226',
                          '43700','26340','47223','76450','58181',
                          '95497','93831','89968','73705','42420',
                          '78554','16478','88659','55187','99269',
                          '67943','77798','17308','82615','18325',
                          '58641','39097','36927','19514','53611',
                          '12730','50222','30695','49646','43472',
                          '75122','86623','46318','10744','35293',
                          '38108','24745','31322','68574','44074',
                          '86877','67738','38433','84130','27783',
                          '53792','13303','22965','11793','54580',
                          '29733','29736','27636','52334','69753',
                          '17788','98269','49725','28951','82602',
                          '72450','92705','10446','55753','19144',
                          '72711','92552','84199','44500','32116',
                          '89853','67438','76345','90685','79020',
                          '95921','22976','27374','41867','59545',
                          '82579','14372','20951','79981','92224',
                          '20358','89408','86043','38627','40250',
                          '76068','92774','66382','77417','13453',
                          '27487','54594','39520','26194')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


