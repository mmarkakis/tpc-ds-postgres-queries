
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '72786','11220','16591','83744','58174','30821',
                          '25567','33719','13291','58772','84181',
                          '39440','68757','60138','20975','41017',
                          '86169','21164','69524','27222','36811',
                          '18450','79107','34146','28395','42855',
                          '23075','39814','13313','95187','31346',
                          '11815','81718','46023','59245','87518',
                          '53845','91712','40887','37397','53307',
                          '36208','41359','25847','55561','13268',
                          '98754','56068','60200','79505','43094',
                          '46619','69926','52658','82214','53367',
                          '15102','82693','57336','20176','84764',
                          '93171','22949','48427','59154','69555',
                          '24122','44666','55602','37635','75548',
                          '67762','79254','63402','33239','62245',
                          '84151','48086','35867','99575','65011',
                          '82711','12349','96178','36998','73259',
                          '20232','29139','83353','70775','52938',
                          '13414','61375','19348','51463','69979',
                          '42845','57953','91963','74533','11521',
                          '66773','72199','82353','69997','70726',
                          '70049','17848','23967','73654','46032',
                          '61660','52902','58952','57911','96464',
                          '59349','90422','57654','50452','47426',
                          '35775','62647','19010','32619','47556',
                          '65347','43997','63059','37713','95263',
                          '79539','91205','54161','24532','86196',
                          '98874','90338','52724','35432','39108',
                          '43936','74766','77778','98989','68378',
                          '50801','14838','68638','74583','84327',
                          '26384','76387','33579','53828','73904',
                          '88149','96198','33445','60848','77139',
                          '96327','46580','31563','70670','20649',
                          '53359','88268','99886','77447','42170',
                          '46644','51859','75154','58079','86226',
                          '74958','44468','26685','38212','23854',
                          '15550','43759','47798','95714','34833',
                          '58942','56763','35496','29850','14131',
                          '36848','82236','60666','23230','74459',
                          '43919','50297','22320','96058','20482',
                          '81002','48512','44501','56275','35069',
                          '88572','37735','71188','98453','92660',
                          '56206','81685','57161','40888','17826',
                          '70075','35530','59072','63907','14377',
                          '63776','96487','61624','51957','98267',
                          '16654','71227','34345','45921','67411',
                          '65298','78662','83149','80800','69535',
                          '53010','62713','68688','76873','49761',
                          '42435','87242','50773','78247','34089',
                          '38454','63749','77321','43509','88481',
                          '56523','43764','66889','63566','85827',
                          '78214','39030','15397','87210','80040',
                          '64678','68945','88141','70848','65205',
                          '24889','14403','25785','55190','27418',
                          '28959','95621','76606','41543','50470',
                          '59206','71712','76758','64450','96843',
                          '66442','71496','43410','21328','87191',
                          '41420','62820','71095','66186','69244',
                          '57957','29127','32622','54577','59233',
                          '65548','97046','75233','15926','14706',
                          '44906','38834','46374','80798','73739',
                          '92326','27895','31838','76403','35498',
                          '63322','94122','41604','98720','50770',
                          '99729','93671','82911','59865','43586',
                          '77047','81134','34841','56738','64466',
                          '72926','16146','15575','41057','11337',
                          '16941','35609','11318','48787','87181',
                          '65178','80508','49534','88259','61168',
                          '54713','35490','70148','44241','47193',
                          '31885','11016','29070','82529','18979',
                          '23135','55100','69770','19866','28857',
                          '97560','80052','20197','84436','54931',
                          '53353','86758','69487','30241','40775',
                          '67719','54008','33075','15674','98774',
                          '10054','65593','58611','49278','62686',
                          '31523','25329','20338','89700','57475',
                          '42939','97710','93623','20102','66322',
                          '39695','80595','41109','87815','51713',
                          '64527','84595','77499','46085','87090',
                          '66169','13768','70272','69787')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


