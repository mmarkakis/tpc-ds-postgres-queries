
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '11869','30437','19968','96652','39254','25514',
                          '33458','71811','87278','75164','54182',
                          '26894','85350','70259','64241','63449',
                          '56978','54241','48999','47428','70144',
                          '41411','56357','32735','93222','87604',
                          '46963','97985','38831','27442','24903',
                          '84866','82543','71409','73558','95819',
                          '99986','48136','23540','98019','93553',
                          '37820','71297','21785','50646','14298',
                          '62592','33886','44315','26105','76118',
                          '37007','81457','46786','68778','51852',
                          '50186','65952','57808','87821','91605',
                          '44495','75098','31356','24273','19673',
                          '76232','26833','69438','28665','78398',
                          '48685','58241','82768','24082','47166',
                          '21369','80714','37286','38461','80747',
                          '53867','15994','81771','68859','31332',
                          '81513','85837','88356','30305','87813',
                          '74643','26887','92703','29482','27492',
                          '99927','20755','41228','39261','61824',
                          '76713','71990','13170','12657','82662',
                          '14599','90381','57731','95389','31813',
                          '76564','39614','94350','83733','62147',
                          '93884','16998','51584','83893','15145',
                          '11538','44932','98457','88789','51886',
                          '27914','65304','94076','37456','59782',
                          '43646','75062','75636','22113','59116',
                          '30492','64004','42527','30652','79149',
                          '30307','72922','71942','55116','65601',
                          '58917','29017','97300','92252','56958',
                          '51398','56276','64173','43534','27632',
                          '85250','14644','63379','55321','81077',
                          '76832','82807','58097','59008','38738',
                          '77503','83710','21532','84045','24922',
                          '34398','16808','91658','75317','78598',
                          '36164','52886','53481','13014','18591',
                          '11656','92248','32612','45022','95585',
                          '32142','76922','14014','91209','22911',
                          '39558','73115','18569','65340','77065',
                          '59482','33362','54131','16863','36711',
                          '25234','63491','43641','96683','80052',
                          '12529','47585','93658','45234','80859',
                          '71734','47986','41885','20946','83651',
                          '91082','39071','78906','72894','48114',
                          '87346','37269','32947','44555','90673',
                          '97020','25059','60981','89785','37825',
                          '30837','51554','22093','80542','98181',
                          '53913','18127','42883','40245','65675',
                          '33023','20627','50599','41463','99694',
                          '33539','70724','95301','52464','42370',
                          '81235','42033','98058','52793','46354',
                          '21818','16165','81052','88718','33984',
                          '55759','68669','28313','27271','78178',
                          '49476','84393','22697','13881','92888',
                          '51925','52083','50945','53902','64717',
                          '38955','87059','85969','90079','31005',
                          '55667','56510','65056','20267','26065',
                          '77848','23724','89436','14832','50937',
                          '51913','48666','50508','90792','77058',
                          '72840','10424','89485','44270','58858',
                          '10659','54751','73133','13024','30364',
                          '45424','44617','29812','14315','56376',
                          '42017','13748','50183','72702','62566',
                          '88275','94955','22049','32064','71338',
                          '44565','45912','90894','97838','20592',
                          '38074','55336','30012','72591','16798',
                          '47153','96848','59178','86427','66113',
                          '95379','35407','81382','74254','49527',
                          '76227','25650','92172','52359','30512',
                          '47043','40333','94160','59853','47533',
                          '85727','63487','92870','75211','76532',
                          '12171','66290','27274','36443','22898',
                          '50754','89860','82629','55283','71508',
                          '88563','84163','71548','24528','11099',
                          '49158','25570','18330','98225','85804',
                          '83275','12937','48862','83896','11823',
                          '72537','86503','66465','60814','34103',
                          '57475','63731','21355','34698','45312',
                          '38888','41590','70830','43016','35172',
                          '23579','56997','11827','47800')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


