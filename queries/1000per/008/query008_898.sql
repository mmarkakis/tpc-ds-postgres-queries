
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '20189','42160','76135','76096','47909','59611',
                          '34018','15097','63022','14083','22478',
                          '96770','49089','24617','62941','43630',
                          '23763','74777','66179','59497','25845',
                          '94597','88625','12265','92685','14271',
                          '44525','89160','45029','58875','10301',
                          '49237','85204','54617','18934','32020',
                          '57975','85331','49042','96669','82852',
                          '32672','91714','75622','98542','13349',
                          '52381','93799','92850','45996','31440',
                          '91190','29948','69046','24015','89383',
                          '82900','54917','83361','62486','65244',
                          '57236','32072','37220','47144','13019',
                          '35526','26126','84769','12182','65785',
                          '62700','17823','17674','27414','13848',
                          '94414','94269','44459','38207','85187',
                          '74672','14814','87325','52332','50289',
                          '45367','90542','75403','40401','39314',
                          '92936','28034','69172','63312','55413',
                          '54002','81898','36075','45490','72436',
                          '16239','17597','84005','78269','12901',
                          '44208','48311','45252','60328','52038',
                          '78541','19090','54199','72623','83269',
                          '40468','95226','26377','50690','64807',
                          '75159','63550','53144','31696','44318',
                          '31297','91467','42588','42675','60875',
                          '31234','35950','98439','35443','64563',
                          '55286','41211','59491','74529','10728',
                          '61265','47751','68316','54227','16660',
                          '70832','18031','41496','20934','81204',
                          '57342','59424','65023','48645','20435',
                          '89006','78001','51462','75781','81889',
                          '81743','96599','75828','99502','62879',
                          '70473','75453','95896','58498','67690',
                          '59092','29347','49108','32873','32409',
                          '54509','66478','47852','25019','11075',
                          '95297','59970','60547','29832','84778',
                          '12962','77625','98037','46002','85773',
                          '43794','10659','80128','37898','70440',
                          '92629','26746','26665','54747','89622',
                          '90373','62763','35638','60412','49700',
                          '33486','87892','80090','77006','65163',
                          '17870','56603','60978','16646','74255',
                          '69859','81318','23451','81754','11395',
                          '66458','53787','92413','85524','25184',
                          '82071','55343','40315','11784','43972',
                          '68431','17993','90936','98517','36321',
                          '16107','28030','79021','78446','53925',
                          '99107','96317','91080','78122','36382',
                          '53240','10864','19742','70992','91483',
                          '99379','73092','29030','54354','53796',
                          '85528','55509','98927','30542','29584',
                          '32172','23005','68987','47486','70890',
                          '61377','32203','54116','37946','51108',
                          '79639','19995','66734','88153','11124',
                          '94384','21969','67958','33911','53065',
                          '12300','86896','95494','67555','15186',
                          '68040','87813','17481','54016','83702',
                          '13328','48358','40616','84610','62623',
                          '61486','55267','10134','78693','87865',
                          '77308','48489','44330','56171','79753',
                          '58228','25508','94811','59230','84053',
                          '58620','46046','30772','57077','93145',
                          '74482','42862','50629','84254','55377',
                          '56492','48400','73061','78068','41209',
                          '97109','16993','46296','29722','40520',
                          '39649','47872','60996','46143','43214',
                          '22616','45984','50399','10077','16820',
                          '10612','26900','82454','57264','44136',
                          '16538','92561','86024','80178','75674',
                          '24729','75517','93562','44455','13020',
                          '82228','48984','84857','79737','20283',
                          '83948','32441','11649','76484','41886',
                          '69475','73691','28091','49824','95670',
                          '63024','40292','18996','98975','91670',
                          '54266','50741','57696','13370','36400',
                          '31754','78018','94407','29644','17121',
                          '91572','10442','49223','70629','97410',
                          '21195','52786','86151','46275','55483',
                          '23109','94565','68541','35565')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


