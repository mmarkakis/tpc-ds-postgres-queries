
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '21989','57115','91005','99087','99668','96673',
                          '11413','84989','37115','16468','35280',
                          '71084','91989','38340','26124','18516',
                          '32061','64723','75147','26242','34680',
                          '14758','29643','52581','38678','47737',
                          '52821','94081','40457','41718','56732',
                          '72976','30096','98974','50629','19378',
                          '78397','97739','82680','84484','12565',
                          '90859','11954','79916','72180','91022',
                          '25752','36666','48058','30444','89048',
                          '51063','59669','94413','47133','21453',
                          '64656','84451','54602','85787','71622',
                          '94496','72991','20117','53745','17962',
                          '48667','99264','49407','30784','63045',
                          '33437','61128','69802','40887','58603',
                          '44138','20626','85121','11695','32727',
                          '29883','81929','89566','31673','12729',
                          '59971','73822','25970','78355','30222',
                          '67093','59972','94954','80582','48274',
                          '54140','14725','50203','36660','16767',
                          '97602','43983','19957','58385','55447',
                          '71184','27813','59263','58365','20553',
                          '62201','53692','80792','38391','62200',
                          '85030','59033','46001','71173','81977',
                          '76563','52944','30513','10917','46678',
                          '31437','81432','34145','41938','59602',
                          '18430','58794','59015','96075','87468',
                          '27784','47792','71841','43446','72696',
                          '59360','33082','60719','27667','83118',
                          '22556','91120','14066','37695','33163',
                          '63488','59657','11270','38072','88262',
                          '72796','66746','22004','10019','30132',
                          '40232','81196','31262','22795','43566',
                          '58843','40832','53923','18679','64946',
                          '21098','94457','37233','57926','72878',
                          '60034','77762','92597','79518','83711',
                          '64500','83410','46346','36410','69517',
                          '10603','30702','72579','65810','76602',
                          '99241','47501','93282','77173','97512',
                          '68276','51103','38542','11426','91644',
                          '85203','36499','60150','25564','96115',
                          '38016','91529','81745','75494','71605',
                          '30372','50872','77703','72435','76372',
                          '27298','51959','43091','48071','89160',
                          '54494','94811','66483','32553','93392',
                          '62453','67586','72534','18235','49592',
                          '93257','35969','69678','13637','94966',
                          '55217','89416','40251','44587','79685',
                          '14532','88665','68120','91802','45628',
                          '22329','55596','84380','56606','77810',
                          '21795','38466','73174','82411','21484',
                          '55703','67899','72746','60189','63731',
                          '66927','13980','38401','21370','21089',
                          '42464','75712','18702','74065','11228',
                          '67472','69927','49293','99183','85814',
                          '93939','18313','33263','65099','12605',
                          '44820','57287','86408','48467','18124',
                          '30772','94643','82857','10507','60315',
                          '11527','30303','61273','47650','43220',
                          '94846','57103','73550','11952','54439',
                          '76732','49260','49746','25984','64770',
                          '70156','10210','85739','75031','43285',
                          '17922','65888','66837','65450','62886',
                          '56481','13793','62310','58813','75280',
                          '29909','79089','14029','15738','43579',
                          '98409','47345','39078','17194','86775',
                          '34924','48913','58557','40977','79161',
                          '33510','36190','75480','93374','65985',
                          '94775','89134','26933','29258','19111',
                          '57928','44513','29290','58503','64519',
                          '31809','90157','45491','41032','45284',
                          '72544','59675','87054','44965','75610',
                          '97010','80708','37961','67673','16676',
                          '86847','40401','14378','58398','48744',
                          '90160','65524','37225','39966','83268',
                          '54077','96959','88948','68112','32759',
                          '22394','26714','92112','32485','74219',
                          '89577','31494','15268','24846','20566',
                          '53027','70509','98829','60101','91255',
                          '93335','27677','15799','72870')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


