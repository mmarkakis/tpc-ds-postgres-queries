
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '16092','46813','16940','77959','58614','42566',
                          '47729','97213','71575','61944','26713',
                          '84140','53603','82100','94783','76210',
                          '42267','33534','81890','19182','91993',
                          '28993','87113','91222','77895','40488',
                          '22447','12949','15178','85965','11840',
                          '46729','39255','34644','57159','49458',
                          '78077','89426','18946','50065','15114',
                          '53622','27196','49038','45086','18878',
                          '43507','90043','76583','32029','24968',
                          '45312','37661','75412','57673','86330',
                          '33674','89429','67223','14508','79761',
                          '11151','90840','76637','99475','86177',
                          '46365','92415','61261','38613','98508',
                          '65114','32434','75989','25959','35204',
                          '45543','44594','39770','13789','49696',
                          '87464','99137','49366','50163','12145',
                          '14213','39991','86804','10993','42918',
                          '70242','53092','16044','70374','45703',
                          '88759','87478','62786','79253','53333',
                          '30262','24249','75879','64578','70023',
                          '51215','41332','26986','51772','94871',
                          '66333','82078','93904','68154','49755',
                          '60721','94470','14819','77375','20670',
                          '42974','92208','52230','91221','64019',
                          '31027','26134','10981','34975','51404',
                          '70542','10664','82634','50763','41248',
                          '92373','86368','57878','25907','14963',
                          '16657','48440','63904','35566','45119',
                          '37068','78530','24591','82133','13491',
                          '91015','12890','87518','86297','40383',
                          '51041','87438','56256','80639','17488',
                          '44378','75658','22081','17279','54319',
                          '26896','34480','33198','63603','14273',
                          '72819','19554','78626','91807','93873',
                          '22728','66097','98975','14721','37628',
                          '59989','79501','93582','93880','17676',
                          '24638','72816','56258','38680','50097',
                          '23323','48744','74593','46280','56547',
                          '24499','38696','25955','10026','76205',
                          '62186','15172','20695','73525','55161',
                          '19826','82483','96358','92672','37829',
                          '45499','54068','86120','43547','55677',
                          '78878','25106','83740','43012','11852',
                          '10624','91184','96469','25486','33145',
                          '56357','58439','25679','75997','78134',
                          '75843','99936','19372','88379','81780',
                          '23956','76486','21405','22753','76075',
                          '76443','47195','59901','23581','90752',
                          '54586','49894','53053','73903','35134',
                          '78609','81715','71699','83803','65909',
                          '66442','10437','93401','15628','62899',
                          '79123','80766','40098','16996','17040',
                          '55491','45049','32697','95128','28719',
                          '55194','17065','86984','59477','82808',
                          '30603','33018','46173','10857','93787',
                          '82182','24567','91083','95822','31852',
                          '53717','33996','60295','11744','89649',
                          '42154','87469','95102','76801','71539',
                          '47877','77725','55966','10586','39852',
                          '50685','45247','31427','38060','90600',
                          '72942','57049','71656','78754','26001',
                          '92194','97190','35141','60622','35409',
                          '38562','65969','55009','39109','51045',
                          '67557','48974','24244','65738','23657',
                          '10557','43502','47096','97195','96882',
                          '95769','41310','19101','65052','13484',
                          '19223','95750','51808','11885','44459',
                          '77311','48643','80246','24230','24966',
                          '53691','67832','22746','52861','50693',
                          '76068','86282','74981','58216','46095',
                          '62969','29027','90921','71703','14446',
                          '48455','81844','45148','27592','87276',
                          '18868','68993','30568','49525','88869',
                          '24398','54199','94875','16612','20678',
                          '75619','47160','32241','56505','96086',
                          '94766','58618','27681','77984','35889',
                          '97847','82893','10478','46777','75553',
                          '57999','31995','67031','98838','29688',
                          '29733','24134','30206','64700')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


