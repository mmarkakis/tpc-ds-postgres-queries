
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '69719','22016','99851','32323','47520','41231',
                          '13162','83474','74645','45091','11344',
                          '84748','39911','93589','85762','31884',
                          '14400','14007','68614','98855','19791',
                          '94352','59368','81109','21081','27973',
                          '41783','64908','88459','50840','63652',
                          '77779','48332','52593','42191','37308',
                          '14513','17825','73105','63640','41228',
                          '22287','58714','88380','96838','67535',
                          '23806','67308','99920','92548','64381',
                          '61370','87474','90853','46840','41353',
                          '87194','78994','81902','99122','80932',
                          '15445','62701','67086','63667','85400',
                          '36264','61258','50181','22167','16683',
                          '13640','98477','80929','34201','70531',
                          '29907','60510','93037','38178','76760',
                          '79484','75478','85911','34978','10490',
                          '18864','66085','56126','54686','79905',
                          '77846','65472','32490','65669','80846',
                          '90282','87744','51792','31996','48809',
                          '93432','55477','92934','48469','60221',
                          '34615','73973','88740','23591','76017',
                          '74891','53639','66914','38011','15723',
                          '54345','10446','34087','46977','14834',
                          '16242','42412','61081','10218','14714',
                          '88590','93602','94814','74275','93309',
                          '79941','10853','48607','60484','24465',
                          '37747','67404','97460','56955','32309',
                          '97609','55437','96323','59318','48675',
                          '92612','40320','26188','89481','96609',
                          '42947','71577','26261','79739','46663',
                          '63349','43189','13472','64322','62174',
                          '92992','35245','66688','74945','28911',
                          '87699','41667','33383','53788','51746',
                          '54989','89618','49888','55909','94042',
                          '74963','38612','41283','59619','98018',
                          '51499','96138','73356','49738','98957',
                          '11337','42400','56679','82734','91620',
                          '87057','81818','77908','87126','22913',
                          '16772','32370','32641','45761','68439',
                          '24854','62577','65723','74702','36364',
                          '49591','27042','88006','16688','86595',
                          '33497','20172','59002','57050','69849',
                          '44290','25306','85318','98270','66177',
                          '57342','31834','62318','75011','40794',
                          '95612','33407','40481','95114','17162',
                          '32020','11231','26595','79326','42048',
                          '44716','17003','85450','92361','45523',
                          '58604','26060','82494','35808','92527',
                          '71740','82616','92239','41330','21752',
                          '38335','19234','86403','74969','98037',
                          '70858','88809','73202','51642','93426',
                          '19376','79630','57377','38487','64801',
                          '32405','52162','34010','66258','10388',
                          '51572','24234','19782','45413','81207',
                          '47597','85991','19468','95186','15705',
                          '48214','52590','58841','30641','91486',
                          '35198','12900','83528','86461','44424',
                          '13849','78611','14832','33677','96224',
                          '53674','10460','64511','36069','76823',
                          '49632','68278','80136','57814','84671',
                          '88873','95167','80831','57189','75730',
                          '31446','64542','21046','19028','75181',
                          '14675','13861','55112','20594','77939',
                          '88115','32575','98942','34517','25984',
                          '75806','86377','19732','65672','31339',
                          '58464','44218','40317','21819','38510',
                          '55990','68007','20375','70712','43095',
                          '23417','85338','18437','54435','89207',
                          '41123','56292','89722','52782','33011',
                          '48926','46143','85442','80621','12701',
                          '13390','71216','58810','83352','30344',
                          '43542','88176','15463','86878','90271',
                          '98828','26619','35751','15981','73509',
                          '72804','30825','76825','41477','30309',
                          '64659','14437','79260','61663','34934',
                          '23046','94637','96944','85374','45467',
                          '48522','93730','27507','22040','69418',
                          '83796','20514','12828','47712','92099',
                          '25281','58849','96173','91840')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


