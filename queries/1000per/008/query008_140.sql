
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '71233','30809','61865','34946','93474','36534',
                          '97314','41670','24310','22191','99897',
                          '33443','74647','63366','20061','50441',
                          '10354','92993','76558','90147','47077',
                          '51924','98006','12307','78639','59363',
                          '80271','95828','59676','54531','88685',
                          '53768','47308','48037','81284','34891',
                          '64881','25571','45231','84502','22078',
                          '71574','73965','51039','48425','67590',
                          '63047','29531','13141','16070','20322',
                          '95657','35459','40481','20905','18397',
                          '70101','24149','81070','49645','50727',
                          '94982','21379','11119','19739','28995',
                          '38539','72490','77934','79730','44114',
                          '44765','32265','81386','74199','55605',
                          '87407','44126','52591','90030','68394',
                          '85413','21443','79255','15764','19857',
                          '72510','12785','26827','89236','63459',
                          '65695','67517','62174','71822','85369',
                          '19576','93228','64676','35544','85191',
                          '39531','73550','47094','75170','35987',
                          '69425','22329','93826','24286','71952',
                          '85518','19011','23413','77842','24588',
                          '82602','93672','81350','17056','24103',
                          '58324','63432','44159','92437','38116',
                          '27663','34237','99979','54991','13154',
                          '11980','44933','56462','32438','69354',
                          '57411','20432','41596','89738','73448',
                          '18487','67294','65920','33462','90953',
                          '43786','78761','23143','91258','14532',
                          '47640','15952','28455','15801','58152',
                          '33930','99969','14832','51691','30495',
                          '36159','66766','75282','39333','46777',
                          '14930','19792','78615','69782','33601',
                          '90053','14804','39996','95728','58339',
                          '73942','53637','20314','63942','42248',
                          '29168','87238','54853','35150','31120',
                          '53741','32433','73567','25540','44091',
                          '12893','79935','91218','42127','75420',
                          '44626','30672','48554','89161','65340',
                          '47752','65231','49703','57091','21593',
                          '66174','76756','51016','70780','82063',
                          '49689','85015','94748','26815','45722',
                          '35732','32706','45552','69895','23604',
                          '57949','23930','33420','94694','11543',
                          '31677','81945','79226','86418','66239',
                          '66023','48333','13170','16797','90464',
                          '10430','83557','24582','92394','14043',
                          '73025','38253','68726','99945','50530',
                          '42800','39798','97630','19881','45888',
                          '63768','42329','91157','61035','93796',
                          '36271','91578','32276','64219','79236',
                          '22740','16717','71283','14249','51032',
                          '16870','57512','56053','50411','93518',
                          '28157','92805','76345','69225','37830',
                          '66031','61547','14546','37914','41930',
                          '81318','25033','12481','85495','58251',
                          '48119','87187','29066','97245','70379',
                          '32821','81645','17005','57968','15828',
                          '58711','96418','84452','94702','99494',
                          '41845','96496','64141','69452','56904',
                          '83200','21797','81525','53892','39666',
                          '54358','83973','28907','25511','83991',
                          '69691','30150','84738','82122','14891',
                          '53728','22821','56124','43460','72978',
                          '35118','81591','16335','34475','60840',
                          '68051','63180','28839','50981','92272',
                          '55872','97000','14691','69060','54842',
                          '63310','69298','29031','55603','95411',
                          '99815','45931','49560','46541','37418',
                          '96898','87674','93471','72321','53272',
                          '64153','59680','70077','74425','92686',
                          '88023','31299','95593','18073','20452',
                          '57846','28754','84154','19406','27540',
                          '10128','93689','50393','55586','91830',
                          '77545','35506','69739','10712','44344',
                          '51450','50693','44463','96846','21707',
                          '81983','46152','50216','27809','11017',
                          '30926','40085','53269','21203','97830',
                          '63283','56868','60849','60730')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


