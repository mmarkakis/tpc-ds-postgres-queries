
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '59390','38395','89074','42506','63255','87576',
                          '68167','68878','79625','51202','56697',
                          '36019','93952','36919','54175','98316',
                          '80584','58942','65497','97997','76004',
                          '70700','94513','45935','94088','57250',
                          '36818','18428','71271','95400','23181',
                          '58303','40703','31321','16392','44076',
                          '67250','93875','53475','34868','52396',
                          '90221','52353','20434','12622','67830',
                          '74031','72767','90194','59648','69356',
                          '35697','83958','14130','24889','66249',
                          '49980','61230','18820','64344','30206',
                          '42267','95895','68569','74587','77674',
                          '17627','63798','63890','45754','95599',
                          '61206','85997','68241','15483','92290',
                          '75054','61910','80744','96722','25711',
                          '40672','14458','28922','62560','16288',
                          '49751','11676','48155','69787','86071',
                          '75170','13537','52594','89627','20037',
                          '67233','35369','36071','32382','85927',
                          '16248','94709','59572','89127','38221',
                          '19457','77242','58171','19731','86480',
                          '61325','79417','50546','79976','67790',
                          '44366','62522','33270','78554','79319',
                          '65378','47358','58535','38595','57888',
                          '98945','98570','22238','23219','88283',
                          '26463','22419','21259','21332','12841',
                          '93186','93036','54257','93914','64015',
                          '68825','41952','42312','86609','85941',
                          '66459','90013','53128','59394','57031',
                          '89296','97865','74505','76120','22704',
                          '94789','62842','91994','81901','44268',
                          '42535','86766','28165','49205','63860',
                          '61199','11486','41490','14230','18755',
                          '63342','36482','59598','69452','63764',
                          '56374','12020','24776','75506','15530',
                          '17901','84639','38906','21776','49637',
                          '48971','20477','39344','24301','71263',
                          '74949','90632','50224','45560','91802',
                          '78732','35269','81109','69416','82666',
                          '13952','46274','61575','72326','96707',
                          '86150','52304','56686','99874','54345',
                          '32396','43563','54138','59006','32842',
                          '18338','86511','27721','95526','90580',
                          '77926','19065','66849','65221','55145',
                          '62090','88816','90121','23734','12442',
                          '75301','23423','26910','26329','49282',
                          '69790','37598','94663','53989','46251',
                          '85285','84670','14965','74798','49033',
                          '16506','15620','88373','62292','61774',
                          '65983','11121','68605','33457','24077',
                          '39537','62353','43192','86964','24296',
                          '17846','62173','75012','26120','55989',
                          '20561','11511','89857','57890','77089',
                          '32752','46770','46738','50119','89073',
                          '80953','85225','28644','34027','29909',
                          '13932','71021','13616','28690','17598',
                          '16095','13211','17298','67011','50126',
                          '68984','84992','10057','43935','33199',
                          '52274','36907','87920','50742','13626',
                          '68329','65652','59138','88421','31327',
                          '11049','35886','84617','15190','88422',
                          '56217','46109','48334','52875','54957',
                          '91315','46940','52294','38096','23538',
                          '39753','14432','36381','74644','15769',
                          '29119','35342','22188','90876','66037',
                          '67392','48994','69659','56182','83858',
                          '96930','93461','54018','14025','83006',
                          '93792','65348','62777','42917','68573',
                          '65765','14262','15213','16974','62163',
                          '20226','42337','27237','63109','72161',
                          '12932','71197','56286','44598','77523',
                          '85463','75035','93809','29028','96057',
                          '98894','21609','21957','16770','23803',
                          '18488','73636','42568','77228','57591',
                          '95736','77435','64206','52779','79703',
                          '77788','76575','97653','42426','55384',
                          '94590','45047','70326','93092','15158',
                          '64543','79512','94099','26788','70350',
                          '22991','75352','11980','95563')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


