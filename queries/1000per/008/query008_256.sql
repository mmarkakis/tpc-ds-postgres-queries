
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '35844','20939','78527','71620','29981','98753',
                          '90806','39871','58701','37111','32702',
                          '86372','85321','59262','75699','63662',
                          '73081','79949','33485','22630','42773',
                          '79449','27371','30631','58858','47494',
                          '64896','67066','93651','50984','31752',
                          '23136','92131','59967','97465','80306',
                          '12679','13392','39450','52638','79627',
                          '48451','47813','98228','73549','37077',
                          '51944','42430','87163','72247','33107',
                          '92590','22397','37280','83421','30666',
                          '58762','23084','89139','60948','93546',
                          '21518','81562','66233','86651','40983',
                          '39008','66518','47034','42288','93625',
                          '95431','61502','55349','63326','15131',
                          '41875','34670','85108','48738','95482',
                          '77070','87176','24891','91941','10230',
                          '71623','89517','12404','29087','47525',
                          '16128','65319','72394','63734','91156',
                          '89344','89362','14134','62562','31043',
                          '30784','66132','62305','89777','34893',
                          '25314','64365','15535','56120','44887',
                          '84486','81781','46368','66495','17009',
                          '31361','94039','33139','38057','73633',
                          '13293','43981','59718','45614','49318',
                          '97674','34435','63103','33613','98127',
                          '18160','40270','16574','26586','26484',
                          '22804','38126','32751','45280','45974',
                          '88025','28375','86884','80505','82270',
                          '42298','51822','89438','18708','55027',
                          '64614','15423','68978','42777','22219',
                          '57929','58714','67060','86849','98801',
                          '75071','82062','85645','47982','18057',
                          '39171','77175','66444','23376','60392',
                          '46372','96367','78405','78024','74524',
                          '58958','47215','36616','83239','70993',
                          '53234','72320','22841','95801','90359',
                          '73084','42498','31266','64179','64191',
                          '71804','33627','89676','83778','19903',
                          '12887','79026','14342','29565','91828',
                          '77750','26429','90374','73534','77614',
                          '93599','36102','50031','77336','11331',
                          '54709','11652','21318','33948','33131',
                          '74556','25414','41544','17262','71119',
                          '70078','49561','90995','39439','41628',
                          '25640','37105','55106','28633','65300',
                          '87263','34018','40028','46404','50403',
                          '84019','23856','10048','23157','27148',
                          '88735','19924','81905','18155','78790',
                          '65052','32117','17002','31298','79969',
                          '42136','49777','61949','75520','54897',
                          '78017','43904','62570','88194','89178',
                          '28985','69798','83160','14672','71195',
                          '21883','38090','87101','72359','10546',
                          '89323','72442','79625','73393','61638',
                          '61729','98848','17459','31314','81672',
                          '74657','66776','55576','25879','78547',
                          '20637','36199','32617','41683','86525',
                          '13108','19276','44795','92780','25143',
                          '65222','87507','16087','77309','17661',
                          '61981','34985','15330','86102','74755',
                          '16940','70528','54051','88695','38614',
                          '12189','54628','65285','63437','49307',
                          '57853','67015','89665','62073','24880',
                          '87592','58165','53991','39976','94489',
                          '27211','70388','62404','10544','68049',
                          '99663','50860','39716','37554','29825',
                          '51143','10281','53047','17587','31448',
                          '51930','16411','21502','69073','38322',
                          '53333','72880','19772','87289','79244',
                          '92141','74458','92000','54767','67624',
                          '32728','82385','88423','47602','99024',
                          '19835','92824','31880','92559','29569',
                          '12197','59916','10317','15273','30365',
                          '26147','71610','35108','16672','16328',
                          '31778','56014','16939','99796','81677',
                          '53533','56523','90019','49703','57084',
                          '62373','78513','69683','77984','37645',
                          '57719','24019','90529','19927','53247',
                          '58196','96804','48977','71652')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


