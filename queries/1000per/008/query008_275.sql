
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '45611','68483','46486','88845','26387','94017',
                          '26972','56931','62419','32830','21055',
                          '76200','69886','85103','56397','40306',
                          '63494','41869','90806','76620','98999',
                          '44373','94634','31791','62067','68601',
                          '24192','19506','32526','86273','57740',
                          '74116','79172','43665','79497','97972',
                          '92576','22527','23842','93289','45393',
                          '42294','19441','44213','10501','82091',
                          '47414','18493','66938','96096','72427',
                          '30673','12742','77946','55426','41492',
                          '10793','56595','76644','77025','63152',
                          '72198','75896','72478','92363','24249',
                          '24914','81379','28714','66264','85953',
                          '70800','41192','35044','74395','42983',
                          '57808','37940','82721','31122','82232',
                          '38616','60331','95653','69543','57968',
                          '77983','67382','97490','88394','24664',
                          '94546','64258','39763','63138','76948',
                          '71534','73832','51236','59198','36574',
                          '10191','83063','25616','77285','48791',
                          '88313','23074','57898','81057','88239',
                          '84112','74967','98813','84135','18945',
                          '95852','78479','26241','19725','91774',
                          '15773','61450','55367','94452','43574',
                          '93860','65639','89315','84142','14604',
                          '80671','43866','55652','63521','97050',
                          '50568','34234','68997','41572','56509',
                          '71413','62929','80024','90621','97969',
                          '66084','72357','24554','99447','13417',
                          '30254','52616','72578','12610','17265',
                          '68706','93467','94044','73778','48053',
                          '25551','97554','78360','83529','28995',
                          '37925','83605','45467','52510','14183',
                          '79119','25302','66438','87378','86897',
                          '15881','11013','45387','48362','98526',
                          '49736','68673','20326','70360','21879',
                          '64306','85607','87146','73258','29517',
                          '17356','65038','43774','52980','38157',
                          '80367','49207','21921','26793','90682',
                          '75819','58801','91292','91074','50688',
                          '11946','81571','74770','79925','95735',
                          '39544','52654','99684','11194','66292',
                          '75223','25577','43035','63676','96482',
                          '56144','33963','16331','63454','28370',
                          '42114','49697','60217','57318','36084',
                          '81367','48000','57264','63089','66560',
                          '17456','91743','66988','36363','87930',
                          '89594','73652','97399','85652','77636',
                          '96156','23405','85587','73716','63093',
                          '72199','69290','73800','91755','82546',
                          '71190','10356','31535','29380','17803',
                          '11447','84257','11732','75904','62374',
                          '60066','35551','28713','54883','55994',
                          '50439','25486','88387','58850','17445',
                          '54147','45015','81345','40441','93789',
                          '74511','16494','44878','31834','72205',
                          '48043','21526','96433','76661','83100',
                          '95516','57293','15193','50143','95055',
                          '63985','75150','85091','57392','32325',
                          '76833','51780','15057','88997','26558',
                          '31252','69962','76198','96029','17037',
                          '29949','94503','37650','89998','44511',
                          '84264','15516','28778','68659','47406',
                          '32971','78847','70384','88965','11261',
                          '75980','49384','25408','41274','83486',
                          '70652','61869','48038','12846','51207',
                          '65025','37985','48007','91377','89357',
                          '20651','72642','55980','54587','96078',
                          '85717','51649','99841','42359','99002',
                          '75630','27510','12345','88290','78863',
                          '69985','78976','57365','23733','82894',
                          '35682','30207','75032','63296','81470',
                          '56230','75239','89101','19775','96381',
                          '49292','85328','89319','66428','23503',
                          '84869','45063','27865','97424','14009',
                          '38279','59127','47545','62660','25276',
                          '95723','92346','40107','45040','16947',
                          '69259','21186','41689','16206','49065',
                          '26934','32141','59304','17252')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


