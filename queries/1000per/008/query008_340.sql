
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '93380','94016','34651','33133','24487','79981',
                          '81470','39484','70785','25700','97746',
                          '77360','13722','56289','62404','75966',
                          '18862','34519','81286','70251','96842',
                          '47921','21967','28343','28538','54666',
                          '96155','74915','67171','90580','39412',
                          '68510','32361','59006','46045','46807',
                          '18779','93440','34646','63481','43044',
                          '64364','19509','52714','48260','87854',
                          '79848','88365','26605','40180','27227',
                          '57877','11894','21909','65774','78964',
                          '23559','66017','93903','50756','26760',
                          '60051','65612','13333','60709','28621',
                          '63564','11173','35166','82361','30713',
                          '18373','91544','85132','77721','74336',
                          '92818','28447','34446','28426','39091',
                          '26866','89055','20820','65433','32029',
                          '97967','68001','84671','32591','18395',
                          '82896','11929','27064','45569','65219',
                          '71465','12644','68396','48775','48627',
                          '51885','49217','12885','84073','51896',
                          '79766','27198','55968','14328','77904',
                          '48195','49926','47508','35716','15061',
                          '92159','18774','80740','70103','92727',
                          '17478','42035','20436','43903','35052',
                          '41148','78550','68365','28800','67679',
                          '15200','22730','91788','35349','37761',
                          '43478','30081','56018','46006','58252',
                          '18281','92486','67466','46734','88116',
                          '39527','64502','99181','75888','91871',
                          '75997','24212','60901','83483','32468',
                          '99428','19119','28564','97545','46480',
                          '72590','98758','34471','24679','91617',
                          '69357','62968','11189','71707','46381',
                          '49096','43395','59141','61981','61206',
                          '82989','67347','49626','29758','59206',
                          '20332','15381','13795','15171','75035',
                          '25631','50060','99811','61058','99861',
                          '36107','72346','18052','42142','97467',
                          '52299','96268','76592','60461','78929',
                          '75113','38544','16245','20425','24557',
                          '25404','66522','83376','25092','49941',
                          '91094','53857','97167','60116','43231',
                          '30593','12259','68828','11028','46411',
                          '25807','42047','14539','15548','73616',
                          '85412','53059','42515','72254','83591',
                          '32301','93029','38676','22207','48761',
                          '96386','45029','24593','74542','69493',
                          '70567','94846','77070','74549','29102',
                          '35199','77409','64594','13528','69187',
                          '25393','76336','28067','24631','90333',
                          '41518','96247','24161','36570','45281',
                          '44843','34203','50241','64145','43464',
                          '73770','10673','10894','22647','79508',
                          '10219','99523','21574','75365','11193',
                          '11930','25197','82146','30891','86293',
                          '77273','65924','99040','69216','33600',
                          '29565','23100','77171','75008','32061',
                          '39325','14770','45199','11745','61023',
                          '87804','28372','42725','98425','15305',
                          '19244','23996','82217','37109','11315',
                          '61245','40005','88241','75015','87141',
                          '47249','83867','73369','25751','79015',
                          '98360','82267','14902','18462','79712',
                          '82417','27428','41175','36105','52525',
                          '39491','74628','18319','45221','47455',
                          '83798','38379','32070','77716','20356',
                          '79243','26129','70475','90334','71744',
                          '60675','46519','45531','57510','29861',
                          '13813','64240','70670','62602','22638',
                          '28953','43671','45449','12025','18714',
                          '65748','39925','43255','62830','34889',
                          '37944','75762','46470','76071','76947',
                          '82164','66562','94617','61127','25507',
                          '93295','76055','92448','79197','36063',
                          '41045','76367','39004','23938','61100',
                          '12168','15438','49724','24605','10611',
                          '12753','74250','72380','53584','86093',
                          '54097','19921','91482','21395','65583',
                          '43868','87951','96724','36192')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


