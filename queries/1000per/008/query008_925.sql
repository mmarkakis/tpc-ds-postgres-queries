
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '23874','20548','48197','55944','49281','30315',
                          '58024','40784','35949','53797','71464',
                          '61203','58430','88654','51954','17834',
                          '24501','69858','42387','69670','52790',
                          '42980','45673','16314','70193','83180',
                          '47356','78578','94924','76133','57011',
                          '72614','53991','11760','36159','71953',
                          '78207','88971','21880','59749','47244',
                          '64602','97745','40825','55409','11445',
                          '60305','26629','92649','64164','62469',
                          '78807','29544','74573','22440','27720',
                          '54352','60732','44170','59624','38392',
                          '26725','27225','77309','84388','90648',
                          '21692','69334','70443','68306','45951',
                          '15879','55444','26919','66613','92816',
                          '60243','55601','84137','39808','18995',
                          '59077','75658','95663','27567','86443',
                          '57289','12710','24192','56520','67710',
                          '81245','29064','61032','95008','82903',
                          '63519','42048','34187','41425','63588',
                          '95241','86245','24499','12136','40797',
                          '40072','61902','29523','93761','53367',
                          '26505','88798','70782','80430','84085',
                          '25343','61646','94919','34139','78746',
                          '70703','89601','87946','71259','61075',
                          '44957','38567','69163','48282','32482',
                          '10701','93688','32484','20719','26738',
                          '62956','56272','83290','80525','16847',
                          '84713','19522','50752','36477','59002',
                          '74684','86746','57183','21836','95308',
                          '56916','37640','48355','45651','31737',
                          '94796','39375','47802','32454','79896',
                          '91498','72238','91872','19226','80999',
                          '16842','32831','31278','45329','56874',
                          '40450','52207','45775','85962','41776',
                          '14532','48671','66016','59880','27428',
                          '89277','38490','49728','71957','91781',
                          '30216','19017','63604','46321','28347',
                          '75153','22496','48735','65288','14255',
                          '52027','33024','21785','41069','66826',
                          '95104','57710','86739','70817','15590',
                          '59862','70774','72129','89855','72147',
                          '37784','58678','60908','15680','89532',
                          '30539','65313','58562','96755','40107',
                          '68996','96231','75065','91977','41552',
                          '50620','95950','10328','61536','43573',
                          '91980','89705','74459','42228','93514',
                          '79932','61832','63442','64585','91927',
                          '29159','49754','96903','72584','53900',
                          '31631','69285','50955','10139','13852',
                          '45678','88959','29091','98213','56151',
                          '96282','94606','70971','51280','36707',
                          '31126','97275','69713','20348','96991',
                          '24167','86646','70675','32443','75867',
                          '89707','44810','87523','57528','30866',
                          '16232','68153','22679','88024','79886',
                          '77345','57189','84607','30131','37987',
                          '12645','47696','27647','41829','92085',
                          '87280','63554','88823','51199','76585',
                          '51583','18856','56585','66883','32024',
                          '22159','55494','74907','28658','26585',
                          '78859','67360','44368','36265','71522',
                          '24240','68022','54770','90135','79196',
                          '64950','28412','20599','98969','54995',
                          '48225','30911','69677','17170','61781',
                          '87583','34847','74271','40264','20400',
                          '25708','27739','98082','22383','46084',
                          '47659','99283','15953','53067','17532',
                          '99733','37330','81406','45605','42251',
                          '64169','22097','23356','32283','29180',
                          '38612','88945','26949','99995','64640',
                          '46838','98570','76161','58576','89814',
                          '98703','73140','53860','69124','82953',
                          '43928','62170','99761','85122','34399',
                          '29732','22509','56922','32835','59813',
                          '86828','78779','37321','34708','10010',
                          '82197','23848','90416','41886','17331',
                          '23941','68838','50363','20868','19547',
                          '74532','33880','60825','11140','74409',
                          '62909','47937','95359','42014')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


