
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '54434','63278','57096','42771','46456','84636',
                          '30228','92770','12040','71676','60482',
                          '64828','77120','16212','74168','72663',
                          '28394','63950','47878','73851','23511',
                          '93208','68238','33527','75000','28657',
                          '83498','45202','46462','15954','56855',
                          '94687','23582','64490','44229','58611',
                          '10271','23109','15862','68423','76760',
                          '90116','55802','60209','79065','33298',
                          '41935','59945','32803','54671','27497',
                          '24027','20217','49043','26281','46438',
                          '78787','30258','65242','25093','92813',
                          '32713','84789','57022','24442','36129',
                          '16820','81825','20945','26804','47054',
                          '68419','39189','35263','31713','94309',
                          '92475','81169','49709','10980','62168',
                          '83967','79837','49918','45298','69854',
                          '14445','70737','64075','39421','71363',
                          '93366','59513','96842','22585','31921',
                          '73032','53382','78543','25140','44655',
                          '33337','19663','20022','41671','90101',
                          '46075','53891','15932','61073','70038',
                          '76019','26082','63010','14049','67544',
                          '87326','88541','81477','16109','82461',
                          '81123','94427','30500','29902','76133',
                          '93153','35248','69158','80944','36058',
                          '94453','80477','99703','16352','38999',
                          '81868','10934','45853','52453','81273',
                          '21281','76257','32763','27160','13281',
                          '24672','92372','19836','17815','39665',
                          '81445','49712','46301','29335','11784',
                          '66995','13834','77709','89430','58747',
                          '13839','28803','29633','61362','90154',
                          '96960','89681','13539','40100','94449',
                          '77152','33844','69368','84878','17147',
                          '12654','66837','82007','55837','85418',
                          '56124','75973','74827','56080','45546',
                          '81520','55771','67810','25967','76906',
                          '60581','38231','52154','95544','60077',
                          '18079','37312','88193','18389','59990',
                          '37415','68540','14339','44887','55569',
                          '77934','83403','56411','42882','14538',
                          '32031','67113','84755','67951','81590',
                          '73168','80061','48299','45216','10736',
                          '35304','73877','68783','52875','35863',
                          '94339','10876','52855','32585','51575',
                          '83567','12121','10448','43082','92857',
                          '55523','33730','45286','49140','56805',
                          '73704','59859','17925','71486','75969',
                          '21636','94391','27315','68196','67062',
                          '26614','92070','64876','79121','66901',
                          '11341','58857','38751','24694','69712',
                          '34030','30300','26876','63496','23430',
                          '63896','43470','50499','85183','39791',
                          '17806','31751','56638','29426','74496',
                          '97475','21114','67388','36823','87876',
                          '62953','58063','52413','55339','16397',
                          '18889','37966','85420','27489','44625',
                          '42929','86938','17264','26844','50281',
                          '42593','14333','38963','88951','28131',
                          '62498','89704','87432','70819','21593',
                          '65649','54334','97987','70247','32527',
                          '90168','25761','89898','89208','84302',
                          '89335','81659','13188','31187','26228',
                          '57884','48999','27283','92944','38604',
                          '56961','15528','17292','30924','55284',
                          '84642','79732','52792','57439','12770',
                          '25939','71357','20111','71347','70172',
                          '72105','24638','14283','90002','56814',
                          '37330','55745','12885','33735','18794',
                          '55054','46838','86448','97658','17956',
                          '29615','33305','20985','78517','80203',
                          '99954','12862','81001','22028','22315',
                          '35459','45812','80683','89270','92536',
                          '94718','25040','86538','46143','23605',
                          '77643','75231','23758','72900','56385',
                          '18873','34136','18735','12504','26234',
                          '27472','29407','31868','27063','38744',
                          '98335','93369','54656','76127','80722',
                          '48306','55444','45991','55329')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


