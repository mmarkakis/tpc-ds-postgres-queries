
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '18946','60357','20040','98561','83360','44371',
                          '87310','38584','78274','34337','89848',
                          '72686','15087','91329','20762','17090',
                          '73844','48861','79160','16009','80588',
                          '21742','83588','75769','24440','89052',
                          '18516','71118','18767','43567','15542',
                          '21305','38018','15068','63628','21711',
                          '92970','32484','16433','37081','95476',
                          '99934','57907','65620','84502','17899',
                          '25667','61424','38291','59262','23232',
                          '39427','49306','90553','43179','53155',
                          '40406','11018','10058','15757','35595',
                          '93515','50405','18356','98197','89640',
                          '46695','56937','47413','53104','49130',
                          '83577','46439','24067','12968','82224',
                          '50156','25319','13289','56722','68796',
                          '95681','99303','31185','88485','32437',
                          '78951','61631','12838','83054','35250',
                          '99353','46631','45002','35182','50522',
                          '84986','39704','34234','68568','12040',
                          '45267','37898','57650','17903','54241',
                          '99596','59497','79908','16711','92622',
                          '72105','29927','22885','39574','37814',
                          '29899','31393','36908','37243','82088',
                          '33909','77297','41810','85514','87332',
                          '14243','24020','44284','83148','95327',
                          '88081','53085','20390','18724','63418',
                          '92080','82359','50799','23272','88575',
                          '49814','22414','63188','38366','68032',
                          '48320','91712','36062','96129','81349',
                          '79037','96787','63735','62358','69465',
                          '27111','57874','80637','80783','64294',
                          '92988','46393','93642','53920','78525',
                          '57670','38191','49381','70153','19069',
                          '92686','88648','10502','14789','38528',
                          '81289','54316','45625','43076','18906',
                          '95363','54282','50270','87237','72816',
                          '14611','13440','67264','35306','28285',
                          '46324','88875','85573','15725','70846',
                          '91685','92120','90456','40715','92480',
                          '82115','84967','70984','99034','36387',
                          '79868','36166','41928','40484','50047',
                          '81270','65721','88712','41808','77022',
                          '44494','22991','17876','97966','33440',
                          '67083','86652','16481','97611','57725',
                          '88212','65503','84425','37712','62726',
                          '47199','34812','61423','43436','81007',
                          '31527','56769','20428','62230','54156',
                          '89649','80437','79076','95682','11073',
                          '75892','11804','43158','94890','75006',
                          '32895','94553','35883','96577','27426',
                          '94538','47695','39191','32377','63499',
                          '91623','65195','90535','89560','74141',
                          '40291','72263','99893','30392','68819',
                          '56170','23360','39308','68686','85407',
                          '64010','75286','39899','80661','50169',
                          '81027','95041','14854','77413','66068',
                          '73622','63886','36603','17904','97900',
                          '58126','37354','93712','51785','47183',
                          '49353','88198','92348','13649','97943',
                          '97609','71539','73292','27149','20834',
                          '19402','61341','37357','92205','47874',
                          '12772','95441','86299','94856','85730',
                          '69009','74549','52215','78285','53861',
                          '89666','35129','29013','40006','34227',
                          '72829','74866','66912','32011','30387',
                          '77831','86548','28140','98605','74270',
                          '40881','96460','12261','51956','19456',
                          '44081','24907','18571','77448','62567',
                          '64179','98720','29877','37280','73955',
                          '85251','77142','12710','10294','11008',
                          '54310','53845','36608','18219','50761',
                          '83189','74723','94787','72894','74806',
                          '25179','73264','35401','50614','77149',
                          '70146','12378','84510','58784','53052',
                          '17688','17409','55033','53138','31697',
                          '76222','68630','63067','13393','33772',
                          '39194','67106','99382','73681','42399',
                          '90677','48947','49743','79622','89776',
                          '30165','12764','72025','88818')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


