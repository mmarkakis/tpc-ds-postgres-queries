
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '96231','68929','57763','54111','12767','91021',
                          '72186','53690','43568','26247','72570',
                          '54085','46244','77601','68385','37419',
                          '21832','73870','95576','21050','75969',
                          '19339','97443','37340','61632','88484',
                          '84655','84479','51664','96584','28818',
                          '98045','15778','46509','69352','56600',
                          '21226','72809','90256','32533','84448',
                          '37828','13250','14565','34160','51327',
                          '54527','83905','61488','73694','89105',
                          '89769','73519','69015','80751','47534',
                          '99190','52539','76505','33492','60399',
                          '86509','36433','79510','78473','95188',
                          '92965','90645','67233','48410','82461',
                          '38758','76020','22700','46278','10450',
                          '20746','32031','94399','96663','47526',
                          '83382','71365','67947','11135','32095',
                          '77255','38970','26549','64440','95083',
                          '47693','16225','48571','38264','11006',
                          '94055','71371','22633','83892','83949',
                          '30861','26812','22429','84087','25905',
                          '59416','86058','91662','18268','66910',
                          '31598','86658','25267','88073','98015',
                          '55717','48978','13969','48174','39813',
                          '33404','27935','43840','11901','30807',
                          '43827','98983','82409','21342','54203',
                          '71191','39474','43913','63108','15485',
                          '60797','94682','78555','59771','52381',
                          '18787','65253','76537','26385','42373',
                          '97135','49129','73200','48086','33857',
                          '23324','55520','54323','27303','93060',
                          '56821','57639','62715','18227','43209',
                          '52805','29357','82486','22226','54580',
                          '45936','29462','57914','90206','99735',
                          '13557','19395','16270','15042','22946',
                          '51924','28919','48633','66513','53315',
                          '69946','35686','10794','59412','28951',
                          '16583','22216','65103','21500','21672',
                          '61294','37210','17439','26560','57244',
                          '47577','47803','16978','46455','28572',
                          '97488','81043','28972','34730','99343',
                          '81214','98171','30229','75102','33180',
                          '54228','38946','68723','39705','25258',
                          '36817','18008','61832','46268','26788',
                          '85517','31866','56719','60712','53142',
                          '83780','20495','80106','44025','84611',
                          '44895','62806','84868','89016','71081',
                          '24399','53383','85960','53667','24799',
                          '56621','26684','47630','26331','75182',
                          '91810','89073','28938','25010','28008',
                          '48965','16384','92265','26127','32692',
                          '78058','27567','20978','95159','73911',
                          '18673','72873','28928','89951','36108',
                          '73392','23007','54300','71439','91898',
                          '27899','72862','45720','40376','57685',
                          '65236','84574','33570','39267','33064',
                          '37516','56629','53681','90807','92993',
                          '72205','36782','78454','39122','26334',
                          '73607','55513','34456','60118','25977',
                          '46592','32402','56128','97220','77809',
                          '62013','47054','19129','91145','20699',
                          '97696','28028','16922','85966','10666',
                          '30824','56736','58664','40102','82698',
                          '35049','40434','56808','69494','39594',
                          '43551','72464','80142','19258','94607',
                          '80091','71273','29079','60435','19670',
                          '54968','30525','81792','72681','15578',
                          '92775','75215','52486','58375','47995',
                          '47586','46488','49351','96402','73536',
                          '79501','75921','28331','39587','19669',
                          '70312','64171','50505','55466','48246',
                          '95061','23950','47922','14783','54685',
                          '81199','94365','86447','12647','46135',
                          '52355','94641','71552','86655','80416',
                          '57548','95121','67522','37295','88286',
                          '98930','96848','65913','52292','10014',
                          '66293','36196','96023','69585','97213',
                          '66616','67635','23493','95082','16554',
                          '12965','64024','73745','96670','96138',
                          '91606','64997','83548','30016')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


