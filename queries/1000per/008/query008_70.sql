
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '76721','51325','59947','53704','27151','58526',
                          '74415','35049','10419','35893','35889',
                          '80170','40835','28375','79710','82130',
                          '85075','15969','84734','69930','61466',
                          '24264','68693','77529','19146','46034',
                          '44407','65951','96727','94084','31990',
                          '66769','61077','24523','36173','67180',
                          '77817','94823','40920','44168','89944',
                          '15272','99557','52776','43108','37498',
                          '53051','94095','19756','46503','67556',
                          '88130','50006','28657','20766','41752',
                          '26008','38421','15951','21022','50747',
                          '50388','24251','98811','40386','26624',
                          '15285','65245','99882','56460','13986',
                          '79244','34369','15357','71241','68990',
                          '54945','53166','10450','99785','75731',
                          '79384','12718','35041','52320','77481',
                          '76114','68109','65629','57901','64516',
                          '20515','60654','90928','70329','76720',
                          '11769','44324','54557','49633','87369',
                          '69137','93477','38934','39703','56261',
                          '83905','11046','19113','26430','46616',
                          '42311','46294','27765','56207','98163',
                          '64331','52845','56900','21158','90440',
                          '54433','45973','44861','40387','42614',
                          '70726','94224','43687','90400','31518',
                          '50610','37917','14966','19496','49590',
                          '53517','18690','93634','60839','68048',
                          '32192','83677','99086','26814','69666',
                          '88207','99311','64251','26136','25644',
                          '47188','14582','94527','69932','39187',
                          '89916','36261','34720','10496','52929',
                          '55813','35710','79725','94062','54734',
                          '27326','67425','41715','36867','61914',
                          '48683','90961','12874','10541','44637',
                          '63705','92029','78804','55470','71769',
                          '30892','13808','59733','99229','37577',
                          '47242','14431','38144','74818','43127',
                          '34764','22892','96292','23873','52502',
                          '90764','91579','67166','43041','64234',
                          '90854','22840','14331','46570','27873',
                          '20978','80082','34540','70230','86947',
                          '67554','89351','84407','64092','50500',
                          '71356','62670','18223','20082','66484',
                          '46308','44994','64595','11528','40943',
                          '22293','94378','89279','94532','35883',
                          '21514','63042','87658','57749','85024',
                          '29192','38407','19540','84380','23307',
                          '65210','41834','15845','12033','68400',
                          '74639','23978','50435','33690','63994',
                          '33747','53208','31454','80797','20807',
                          '76548','96918','36258','90592','40342',
                          '29750','97668','64686','68378','34392',
                          '38268','55445','23193','73124','10166',
                          '37349','29238','29557','14116','39280',
                          '81982','76266','30250','56981','57527',
                          '78778','64285','60019','83674','60802',
                          '34621','34345','74219','55732','96337',
                          '65507','85200','12873','54662','93712',
                          '65858','47253','64305','92083','95734',
                          '46015','49594','88916','31411','49469',
                          '60950','69255','12237','30469','42002',
                          '23143','38036','27673','85496','19369',
                          '93667','76170','94178','89533','52156',
                          '35555','43604','37717','71735','50404',
                          '56854','82595','41534','47086','40695',
                          '83712','33930','49626','51303','65878',
                          '13391','58113','25102','92473','77014',
                          '30264','68609','27954','66776','91231',
                          '38508','48258','92208','67002','26781',
                          '71599','77107','29656','67064','24433',
                          '41339','66030','79780','97880','62604',
                          '61107','40366','21226','57619','99431',
                          '63251','58756','73823','46260','72566',
                          '32092','60976','96992','52767','46078',
                          '13919','68976','45235','84301','68411',
                          '58169','94509','74891','32046','90686',
                          '11103','74110','92926','51415','70324',
                          '49644','81542','39832','41688','14367',
                          '36763','31244','65849','97060')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


