
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '26335','31841','46445','30232','34189','70792',
                          '85653','83037','52692','69603','36731',
                          '90916','48174','97057','87369','87391',
                          '10148','94882','17704','92664','75814',
                          '28738','29542','50483','42095','48449',
                          '47638','10508','34866','81845','54511',
                          '45394','87006','99332','85293','33880',
                          '85096','67480','14963','11070','16792',
                          '81639','85219','84596','93133','62445',
                          '48787','81556','36444','56465','73493',
                          '32406','61248','96993','62159','36568',
                          '43844','50017','62778','48607','83055',
                          '48319','44543','69246','81709','63472',
                          '15111','42812','90712','12733','86688',
                          '15285','93461','61628','97423','62752',
                          '73552','71632','94379','11340','79222',
                          '76878','48420','79431','61383','13776',
                          '17100','51681','19442','10614','36829',
                          '70883','93887','62856','91526','86254',
                          '90874','19060','98547','91185','40478',
                          '92658','23299','46077','40501','29343',
                          '62457','32466','89993','19929','30196',
                          '90419','52709','11389','48884','55076',
                          '94407','61239','53675','17028','73262',
                          '77288','64903','59154','63031','41391',
                          '32094','25467','29658','14506','17989',
                          '75005','30041','28516','14709','42448',
                          '27787','34980','35841','68844','40545',
                          '36103','92244','18873','81543','18282',
                          '92780','83415','31982','49122','62158',
                          '65851','32140','61743','74487','24794',
                          '14651','21982','57646','74174','58845',
                          '14150','16914','51280','98195','69994',
                          '50526','65185','69848','49946','70391',
                          '29008','52230','70822','79839','55807',
                          '65866','49538','50666','15568','74243',
                          '15416','47381','72499','65661','75133',
                          '36226','62779','53661','10082','21938',
                          '19706','37172','65366','18094','40531',
                          '15102','33526','76397','79714','87108',
                          '60029','15055','13969','87554','35622',
                          '38455','86793','80984','89828','23059',
                          '86012','25683','75111','63210','12319',
                          '46655','48792','44213','56790','12190',
                          '87071','10607','34638','78058','49846',
                          '70996','79035','38728','21809','41202',
                          '55444','52624','76992','26496','40194',
                          '99672','57508','39939','96285','35329',
                          '28671','80778','53048','12606','86645',
                          '50219','11746','15997','71469','67648',
                          '76746','51434','80993','76375','47985',
                          '44651','28319','49441','64927','63458',
                          '43284','89317','69340','63521','10856',
                          '55543','62179','14406','10351','56885',
                          '27213','34791','95161','32023','95400',
                          '27769','95600','60487','68608','49418',
                          '74563','98277','76003','89302','41484',
                          '55714','47127','60465','91357','45252',
                          '19286','39018','78263','34184','89003',
                          '72177','40769','76241','88782','39727',
                          '74591','40695','73577','49473','22900',
                          '30224','45072','91411','65720','16213',
                          '80153','40282','14019','46817','71664',
                          '89512','67114','54193','91447','92637',
                          '85308','34777','86966','41784','31017',
                          '90259','77206','46266','27629','64332',
                          '84721','36620','68576','22812','72677',
                          '40799','26509','62972','39226','55085',
                          '25264','55981','86405','57932','18332',
                          '10826','39048','86900','69762','51284',
                          '75167','99453','88738','23911','21375',
                          '88863','98055','92795','35834','83131',
                          '85232','30511','63205','29302','44515',
                          '68153','39065','18215','87757','19085',
                          '73891','74408','79774','37835','42066',
                          '93532','80118','32937','26943','23759',
                          '97262','62362','47189','65804','88853',
                          '65312','11776','49161','10799','80870',
                          '38531','16766','15614','34427','46109',
                          '68180','70470','71030','34674')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


