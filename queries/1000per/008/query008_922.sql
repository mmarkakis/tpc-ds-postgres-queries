
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '94902','20445','11156','99850','32108','85362',
                          '63198','68724','28621','98111','61369',
                          '64368','42828','65052','78574','71173',
                          '98602','24393','70274','38080','69784',
                          '51963','86115','51164','40089','62380',
                          '90994','46123','98384','36547','35450',
                          '22358','37608','17701','36239','66752',
                          '49431','42220','87871','73080','58779',
                          '24935','70181','13983','28103','69985',
                          '47130','97057','13164','32680','69427',
                          '82111','48537','38790','61384','73741',
                          '87595','33289','79663','98475','35766',
                          '23207','92606','51574','18585','68750',
                          '98521','45169','55782','10360','19744',
                          '29332','76172','80938','59777','10501',
                          '97225','84978','42334','91861','60631',
                          '24402','10396','61515','37445','88396',
                          '51782','54909','18849','73334','29195',
                          '76056','75026','76709','82482','60282',
                          '27816','44779','17521','30620','66343',
                          '59621','30580','72518','29288','83236',
                          '56099','86626','90159','96330','11937',
                          '20424','19478','52020','49367','60269',
                          '37183','68490','94134','94499','90737',
                          '99686','79875','79426','38020','45354',
                          '28181','47921','51371','15221','78032',
                          '94946','81175','13046','28848','26861',
                          '81658','42404','17165','23285','70945',
                          '80971','39452','36675','22408','53524',
                          '93899','11676','24847','81341','13397',
                          '61031','29092','20225','32715','81694',
                          '55960','86979','70016','54406','76652',
                          '11700','39620','26268','25001','77279',
                          '22212','95731','59473','57937','98276',
                          '35594','19354','52640','28523','17041',
                          '20886','14008','57697','11381','72022',
                          '42081','82764','83211','63476','13108',
                          '15164','97247','17472','75828','36335',
                          '32310','28775','37170','87180','76032',
                          '61058','97401','92059','23568','53975',
                          '86969','71718','72049','39278','30144',
                          '43388','70207','42581','76841','75857',
                          '82125','32609','37570','23724','94242',
                          '90272','87713','91131','30153','83918',
                          '69075','67278','57050','22960','90851',
                          '81125','25356','56776','79674','57046',
                          '72588','65447','83171','28159','40538',
                          '73435','80746','14393','64607','49142',
                          '64220','35714','35478','72794','61336',
                          '61255','23734','92354','28555','97567',
                          '35570','58599','97868','70169','29257',
                          '97693','14138','82340','10229','38607',
                          '57415','82104','30787','10033','85235',
                          '97630','19522','70770','76310','92711',
                          '84715','90945','84291','98374','12351',
                          '28749','82842','73278','76482','99455',
                          '12479','65928','96985','13952','52357',
                          '79539','90928','87330','95495','55741',
                          '63886','22849','56961','96758','50916',
                          '66098','61118','98032','32146','12985',
                          '35445','98577','65394','18489','57935',
                          '23862','68847','69954','36681','10887',
                          '21097','13161','59233','99049','87956',
                          '91606','80077','65966','62213','20708',
                          '94365','54774','53077','59347','52359',
                          '96974','12052','48106','80641','52614',
                          '72363','12533','72872','74496','79970',
                          '43068','35420','62175','64396','56849',
                          '15008','83316','47049','79695','86413',
                          '69361','78223','96553','72632','31552',
                          '55172','97754','92116','50952','28952',
                          '89962','99492','24416','15041','89614',
                          '69563','37427','80870','29242','64954',
                          '51495','16401','27018','67651','13401',
                          '54114','43278','66658','91761','40567',
                          '54934','50442','27416','25158','30762',
                          '61827','37303','84631','16900','52940',
                          '59013','90434','39466','95824','46969',
                          '28838','33361','17076','36322','21639',
                          '90638','37587','16296','57625')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


