
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '81851','56860','63023','83610','73043','48628',
                          '86202','16335','10590','19205','94836',
                          '65374','74700','15488','62889','95573',
                          '74839','46434','93350','32078','40848',
                          '76796','58223','63389','39684','33048',
                          '80008','50758','94650','35659','61393',
                          '36169','12583','72290','94012','25116',
                          '69047','57643','53682','85043','91834',
                          '74383','85194','33440','90824','61092',
                          '37101','49920','49494','75564','48054',
                          '55592','70148','25342','67357','35339',
                          '26852','70464','52040','84356','91940',
                          '45693','71470','78957','51582','29182',
                          '34178','90594','72919','11771','54921',
                          '44364','44474','38965','24472','13667',
                          '47570','57618','56520','21925','70471',
                          '17776','58878','59590','41085','47935',
                          '46459','57935','50166','14588','36275',
                          '52969','58070','98619','48324','36618',
                          '75463','61383','57411','41244','63194',
                          '77496','19784','70503','58968','39025',
                          '92931','72493','27497','77423','43164',
                          '82466','22179','99966','85309','64836',
                          '94730','26929','11660','20793','51188',
                          '94352','61419','51574','93222','83713',
                          '43598','18797','95011','69362','65074',
                          '86561','64184','50343','36864','77049',
                          '31021','20259','18109','29860','88268',
                          '53445','19273','64001','32457','88010',
                          '81752','62891','51888','36822','47705',
                          '96374','77920','66886','53927','44246',
                          '72050','79194','35274','53494','28310',
                          '84066','53347','37710','69627','63395',
                          '42725','34457','52905','33629','30521',
                          '98780','50602','81005','68523','20964',
                          '39049','66560','56366','21004','96114',
                          '87792','64672','56639','16932','42808',
                          '29124','76467','76202','67510','40049',
                          '21130','54185','66947','88833','41049',
                          '72553','42360','13335','15867','63595',
                          '13585','10592','99935','21673','95912',
                          '49971','42086','24950','11920','69009',
                          '23115','67319','45346','57238','13411',
                          '66139','64011','70552','82882','12091',
                          '91794','82401','86237','57386','27348',
                          '69618','49244','67310','73417','56930',
                          '62193','24793','11048','76125','44476',
                          '96391','99977','20038','18623','60259',
                          '13434','77225','69181','33034','12008',
                          '36123','91055','44582','28757','67217',
                          '12503','14868','96585','95373','66992',
                          '95775','56111','43203','67902','41539',
                          '68407','45361','51085','59453','55090',
                          '64684','66386','14100','39162','68606',
                          '28797','89212','66663','65161','87777',
                          '64213','60917','79997','75077','45251',
                          '33107','92002','27736','31679','64464',
                          '92772','71892','81766','31031','53390',
                          '59897','77027','58382','16467','39836',
                          '77987','78574','58934','29518','45381',
                          '37283','98903','68541','39659','65473',
                          '88555','87611','79769','16802','26726',
                          '47955','44497','94823','27917','72148',
                          '29658','65774','10966','24694','89740',
                          '74693','66153','61578','83734','33243',
                          '12534','20926','43407','39690','30415',
                          '28844','90350','66802','54079','28145',
                          '85089','97105','50555','96362','11706',
                          '15584','97589','64007','79688','70408',
                          '46117','68983','48654','32172','78101',
                          '30897','93715','86294','89916','38938',
                          '54440','56727','97408','68236','70395',
                          '96153','68399','56214','56899','37328',
                          '25983','98666','79264','57343','27901',
                          '25352','83847','97207','38972','90831',
                          '88135','34944','38108','15110','33169',
                          '64538','81887','75619','24106','85709',
                          '33352','75580','70870','67385','85778',
                          '41024','69270','52949','55162','11362',
                          '98668','79552','87521','46376')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


