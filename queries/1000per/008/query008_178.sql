
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '15932','79118','43853','19158','30824','31627',
                          '82869','21515','32588','54288','34400',
                          '68394','53974','33326','13678','55943',
                          '17579','67301','76616','36614','95737',
                          '88430','27950','24269','38707','51568',
                          '12649','70828','30288','62978','17429',
                          '46568','82369','78002','17358','30392',
                          '48754','85126','92849','85831','41814',
                          '64562','69199','22796','90867','68509',
                          '66662','46608','11072','92626','28036',
                          '21585','87819','15069','32216','99500',
                          '74496','28810','39488','24463','30355',
                          '70368','58140','57176','24211','34039',
                          '64677','38994','98409','39223','64248',
                          '85121','98934','69824','69417','96619',
                          '25905','66613','81488','80208','40164',
                          '48773','93893','82928','94167','28529',
                          '89422','26407','90522','83198','26766',
                          '31235','69201','53857','89441','92037',
                          '92982','41700','20547','36628','41370',
                          '87451','65558','14944','82636','96861',
                          '58361','51559','88526','38166','62014',
                          '45605','60717','68737','41118','19648',
                          '11278','48778','58771','67661','21212',
                          '65535','92680','71414','63859','86735',
                          '84238','76787','15272','14651','30913',
                          '34058','57940','24409','67217','43095',
                          '57650','33491','78401','99195','88307',
                          '74143','60539','23444','92442','15604',
                          '94466','76556','72163','14973','21166',
                          '77560','76225','62977','78009','34834',
                          '56747','43103','73104','34100','32203',
                          '92589','16832','85672','84420','22784',
                          '69450','55844','81659','99150','19302',
                          '44472','11250','68571','57535','39587',
                          '38072','89034','92719','45914','81577',
                          '97317','60816','81025','48834','99077',
                          '68740','83255','73910','74960','50106',
                          '68520','81198','68738','72349','90163',
                          '83699','79802','99186','86903','20166',
                          '97863','73014','56453','27144','83923',
                          '86711','24670','30456','64929','39249',
                          '10379','35880','33854','50433','64360',
                          '97919','11905','44964','50411','88793',
                          '56649','83022','56167','66326','10648',
                          '34453','28165','66108','81977','20595',
                          '74773','83187','78681','50004','33911',
                          '35959','96836','15176','51207','51664',
                          '52260','91624','81420','73031','12877',
                          '57841','24066','49796','77727','84056',
                          '78280','22324','61618','33341','38971',
                          '91641','39894','40279','41300','36195',
                          '91273','16749','89770','89775','92984',
                          '28280','77287','74711','68262','21939',
                          '99739','79443','66990','81760','93511',
                          '31081','13833','67567','69018','46852',
                          '83749','70742','63179','34962','91826',
                          '82544','97083','41538','52297','21780',
                          '78573','50258','46193','89626','83908',
                          '79399','79967','59406','18424','68010',
                          '46850','24291','62229','42670','10021',
                          '20099','42975','54668','40821','21492',
                          '91985','25319','67181','97834','98596',
                          '76958','25806','19823','97308','10667',
                          '67637','36751','39492','23228','83498',
                          '33567','20423','21567','79199','46594',
                          '52132','18765','60445','74011','81467',
                          '49702','28864','48481','47184','81753',
                          '87241','29906','61478','11348','61272',
                          '35415','46499','81120','20435','57097',
                          '48980','55995','16220','56176','44494',
                          '85726','51339','18482','64259','99614',
                          '44742','85373','25920','96045','88512',
                          '40446','81118','92523','90005','76374',
                          '72120','72463','82361','39824','98214',
                          '79905','52218','56745','65769','65137',
                          '40966','61219','61743','43780','60425',
                          '60950','89176','75249','70123','58891',
                          '44768','52558','89157','53940','69440',
                          '25358','99577','45109','43395')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


