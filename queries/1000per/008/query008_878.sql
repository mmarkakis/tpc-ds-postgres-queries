
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '96848','99446','86120','57378','40383','62960',
                          '30321','34412','97364','89347','66514',
                          '30079','92981','89114','97073','82427',
                          '66102','94605','23599','25178','46054',
                          '77580','85552','18577','64932','29693',
                          '97984','21478','54760','75188','89217',
                          '77502','35385','91975','69150','47209',
                          '63104','71030','57247','66555','58290',
                          '94905','74933','40467','87113','19569',
                          '39402','11196','98338','43229','32918',
                          '37506','25394','89368','21213','13744',
                          '91910','29259','23729','18352','42975',
                          '30954','46691','56730','96969','52623',
                          '92724','31764','72329','58471','64671',
                          '13781','37861','34174','60574','43988',
                          '64989','43392','53024','90878','70815',
                          '57000','36528','78663','21551','17608',
                          '64764','90150','53204','35772','98475',
                          '57670','62177','69151','22463','62288',
                          '41265','29226','60265','88169','10951',
                          '96759','22745','32531','78101','56810',
                          '10453','82360','45632','74529','73833',
                          '35065','63140','24084','11184','77162',
                          '76217','72685','46476','70243','31740',
                          '67707','81339','75627','57278','88928',
                          '87449','73115','14829','21469','51336',
                          '82631','22703','15096','18206','60748',
                          '33991','54369','38409','13839','76685',
                          '86637','15138','67959','69448','85025',
                          '11533','74347','77104','75233','57508',
                          '96368','42860','78178','80099','55215',
                          '36688','52087','45625','88920','44524',
                          '99539','59849','34888','80601','52951',
                          '30652','16187','56562','24177','43120',
                          '54898','84206','54197','67605','81878',
                          '62569','42156','24873','13313','96714',
                          '74851','30001','22377','49366','55928',
                          '20147','26025','46915','70121','57170',
                          '35153','96358','74697','79941','36573',
                          '31355','36487','51965','63978','39823',
                          '31662','30842','22170','29699','14176',
                          '68225','98583','65868','30118','75820',
                          '21682','71204','65082','77399','22708',
                          '39608','72742','95348','90841','36963',
                          '37465','18552','52138','93991','94110',
                          '29461','66061','93574','75776','97027',
                          '55610','30311','33334','30494','37958',
                          '89195','12321','45096','59971','47593',
                          '99193','10691','39252','73104','44108',
                          '31204','46104','41227','38884','47348',
                          '29879','23835','81334','19671','88987',
                          '28025','73186','63212','28802','96885',
                          '80837','25118','43285','61121','36120',
                          '81187','84876','59810','80296','36228',
                          '86065','85290','77130','29965','51357',
                          '79777','91147','62631','60502','55465',
                          '38382','65822','31311','45095','51078',
                          '46021','30047','41801','16005','69548',
                          '28389','12018','36810','68258','59651',
                          '27990','72232','68764','58915','41633',
                          '14063','49792','77971','85599','69302',
                          '18754','95480','93795','24559','66764',
                          '53547','31429','60663','55266','80989',
                          '88460','54989','35860','64346','29336',
                          '99460','21002','43345','99412','78219',
                          '51049','56866','85733','84621','16813',
                          '63677','27567','83140','83896','99994',
                          '34854','88160','34616','10089','23136',
                          '47843','85978','34168','28166','43660',
                          '66087','45373','21178','25389','79227',
                          '80781','97169','63066','47340','51026',
                          '94978','16251','18379','71429','75055',
                          '85250','63842','50413','93878','74620',
                          '34001','14898','33275','57546','68567',
                          '72184','67195','34184','85713','93600',
                          '29139','52779','13012','12301','80389',
                          '70738','63634','62534','46750','45430',
                          '37512','98503','79975','57889','74292',
                          '22822','67354','32156','17014','63400',
                          '12174','48553','19832','94419')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


