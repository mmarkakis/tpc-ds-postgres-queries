
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '50300','83313','51331','40930','46937','25401',
                          '60407','49709','59115','37111','55990',
                          '26409','83004','81953','33852','34874',
                          '14191','15896','73673','64598','85029',
                          '31003','66770','88971','10755','93404',
                          '71726','71149','22529','16007','79692',
                          '78905','29830','73720','55212','21892',
                          '43452','21103','58970','22857','20387',
                          '32179','55419','20378','55722','64056',
                          '55331','12478','82212','34385','32669',
                          '77207','30574','25277','41055','19518',
                          '88984','30470','90438','86555','90825',
                          '12413','43660','88729','95057','59071',
                          '16307','75079','57772','50553','36586',
                          '25595','72477','71267','31628','87662',
                          '13045','51472','99200','17196','80186',
                          '85884','41891','85196','54835','23574',
                          '41989','14376','92261','80601','11993',
                          '35404','42872','83658','71129','51296',
                          '74264','24470','12662','43519','36107',
                          '95698','54041','31440','99668','53209',
                          '61559','87513','24127','86356','21049',
                          '77345','21677','56458','41697','44215',
                          '60075','76954','10442','82751','98436',
                          '13951','63867','45936','85851','82590',
                          '38435','57756','36506','25933','75223',
                          '63804','19106','18834','89095','72485',
                          '79127','89391','94879','99915','93932',
                          '75204','75281','50387','13515','41534',
                          '46165','28561','96583','35929','95088',
                          '36932','42570','84981','55976','81808',
                          '74937','36259','53722','40458','16924',
                          '57900','70716','57889','21607','63484',
                          '32580','47003','48953','65719','54047',
                          '39713','19398','41195','83701','65369',
                          '59624','16461','46162','99505','11076',
                          '58242','78098','49687','17498','34025',
                          '59642','74747','42060','76587','93091',
                          '98196','29114','11761','87141','44655',
                          '14095','77481','79348','12232','70205',
                          '53366','60298','53681','59882','78296',
                          '56702','55696','56753','90360','46244',
                          '42277','14018','32152','26406','77733',
                          '66749','33307','53711','52678','63960',
                          '33617','92686','89942','63901','52574',
                          '99810','38355','50976','75341','16628',
                          '54152','86257','80265','32678','35400',
                          '52262','59636','32199','77946','54329',
                          '48615','89730','87306','63303','21775',
                          '24358','97957','23406','87432','27843',
                          '47980','57448','40592','41263','13665',
                          '31419','11290','84154','38106','96504',
                          '74702','60138','60258','16114','87072',
                          '15321','65496','48132','90998','68256',
                          '53744','30318','39069','14093','78413',
                          '50028','29897','21656','70010','69375',
                          '99704','31470','71776','36007','46935',
                          '97747','68227','72731','83081','67657',
                          '97923','13014','85950','29846','10148',
                          '42582','31074','86921','88142','41661',
                          '92415','89146','89060','26012','48434',
                          '60159','35079','44525','23042','52663',
                          '58882','98671','90043','34125','88340',
                          '70906','14092','93613','67410','77521',
                          '49330','37731','47910','61864','63897',
                          '81785','56164','43280','39929','55937',
                          '98534','86509','18423','24796','12074',
                          '39265','81104','67583','68778','58448',
                          '89842','19683','84233','88291','98390',
                          '35977','62335','30692','90802','48965',
                          '85094','21187','12647','90297','36387',
                          '83597','89253','21238','70520','54445',
                          '39633','16180','86073','30263','20740',
                          '63821','29614','39777','66628','76765',
                          '34344','57170','19008','63388','19829',
                          '44966','21812','82437','57905','21067',
                          '71249','79218','63346','89534','43302',
                          '21257','28358','40287','48585','50500',
                          '98017','41643','28696','60576','41292',
                          '54882','84885','93147','35168')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


