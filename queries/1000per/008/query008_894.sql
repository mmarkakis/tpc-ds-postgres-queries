
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '36069','68387','16934','72618','43739','31426',
                          '19202','43787','23724','73385','10688',
                          '75773','28242','37329','32621','69450',
                          '91215','34713','23831','23624','17576',
                          '26751','80735','29188','97378','42783',
                          '40134','70567','30514','22714','34357',
                          '35311','79392','70968','48288','98816',
                          '10080','46918','39504','30771','10974',
                          '85821','32233','47644','87579','55895',
                          '20326','30836','95458','64802','97835',
                          '12108','33365','13551','79949','39544',
                          '94296','63060','11626','68614','99345',
                          '69883','30943','70464','74394','70798',
                          '41096','52664','90922','25603','44109',
                          '67810','83096','52966','47492','54793',
                          '17686','29281','16231','62155','10064',
                          '61750','44488','71977','92095','79881',
                          '29617','44692','10439','70904','37210',
                          '41740','97218','69831','62974','34138',
                          '29093','30238','51954','69410','52735',
                          '58779','35041','69798','15209','13451',
                          '78565','75440','92079','55013','39309',
                          '85155','87275','95680','20547','29860',
                          '63304','90448','54165','56421','16379',
                          '91339','80489','78993','66467','53315',
                          '45236','15395','46845','89603','96948',
                          '87345','86639','39493','10361','21809',
                          '92158','53578','62258','68572','57841',
                          '24816','55024','67293','36214','42954',
                          '79709','65883','93680','74624','42622',
                          '93561','90051','57237','44674','50544',
                          '73128','32004','48001','50156','71711',
                          '22965','91977','37348','90885','32119',
                          '61542','14202','28898','43548','97430',
                          '89467','20501','31529','94759','79815',
                          '29833','28673','77751','64751','57638',
                          '46634','59979','37829','68073','71843',
                          '26331','41905','85139','61952','43305',
                          '47895','37516','67871','55916','38808',
                          '23854','35543','96349','23144','14771',
                          '26837','40440','54564','94199','60774',
                          '80985','30607','56411','34237','49490',
                          '37344','30479','88356','72365','21375',
                          '34478','33016','74410','35591','61850',
                          '17777','20959','67877','87647','62398',
                          '14323','79406','11639','24918','34483',
                          '54991','93871','41356','35351','44879',
                          '83267','34573','76581','82193','77085',
                          '15337','97862','41382','99757','62191',
                          '15280','73320','54773','98228','81732',
                          '89316','20967','26162','46282','17353',
                          '25017','80438','92070','55037','23723',
                          '80648','24128','77994','24943','95891',
                          '83272','56846','17037','95519','87399',
                          '30769','18993','83624','40993','63097',
                          '66849','75468','83295','40697','84616',
                          '19832','83337','54505','20788','41263',
                          '28180','14451','52573','16172','25133',
                          '30920','81107','12839','35692','93159',
                          '39797','53294','89388','62407','34871',
                          '35676','57189','57623','67177','45502',
                          '72797','21034','50043','27479','55553',
                          '99893','14239','68236','40803','82414',
                          '89022','14089','55082','46194','53083',
                          '38988','92675','42248','44414','76451',
                          '52123','98991','69867','34638','23879',
                          '88223','94530','80507','15676','32144',
                          '56685','34310','32088','66651','96551',
                          '68463','12944','52493','39491','70181',
                          '11658','94067','76359','45218','97869',
                          '15795','64843','74648','52503','36587',
                          '76335','14435','10068','90215','45194',
                          '98553','50578','24043','97887','74383',
                          '37817','61962','99180','28953','82303',
                          '10521','73676','34466','77729','17613',
                          '90436','34548','65550','60945','23684',
                          '21653','35984','42624','66578','24351',
                          '37450','45806','66711','71873','32191',
                          '70093','27280','57419','89939','81225',
                          '73578','60953','89996','14310')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


