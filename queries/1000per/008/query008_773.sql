
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '24537','83855','31583','82988','91050','38218',
                          '57401','25481','59235','96993','95096',
                          '74627','72488','20677','21239','28950',
                          '97938','17374','92776','74535','76395',
                          '36274','85514','93109','89029','39033',
                          '66061','16564','26111','65608','50941',
                          '31381','59556','60257','84680','38562',
                          '16703','82886','78740','50663','33589',
                          '36413','40506','71613','59248','99170',
                          '53290','19082','48157','73087','43013',
                          '80460','20985','64094','24571','85158',
                          '67527','35310','67989','20532','61058',
                          '68126','71342','41468','96620','16438',
                          '28029','91429','74162','31438','68625',
                          '54966','62657','78331','19237','50812',
                          '61717','12761','27950','43802','83005',
                          '86640','96004','71428','75718','43437',
                          '22845','13042','44700','47586','63963',
                          '68556','34368','53116','74363','13662',
                          '42729','19749','19016','32142','71186',
                          '51750','59108','75548','78183','28909',
                          '54536','11973','88061','30052','94013',
                          '62529','63914','20402','84743','71007',
                          '76820','77921','69046','75422','80678',
                          '18692','89415','50999','46480','95007',
                          '53585','12624','82818','46586','93491',
                          '28359','32400','53301','97087','24397',
                          '34136','59459','39409','36412','67247',
                          '83122','79121','49265','66905','39300',
                          '28181','83478','66724','75035','37056',
                          '15641','68283','39854','35623','46592',
                          '37458','99550','57074','95550','74211',
                          '99892','88693','56626','33494','31321',
                          '22616','66078','79512','36416','90173',
                          '17671','31407','33002','25893','23946',
                          '59185','47821','72941','12206','55259',
                          '11302','25451','14921','56800','22749',
                          '46325','89156','36406','89013','17060',
                          '85654','26449','43038','17385','78991',
                          '67637','22383','21980','79406','55909',
                          '72507','52331','29242','43727','30521',
                          '35918','96974','53643','69541','46424',
                          '54978','62292','42904','41878','15579',
                          '59357','74652','62896','94157','20043',
                          '61544','89304','74126','67822','55627',
                          '58303','54139','16930','28451','42533',
                          '48789','88350','76497','57453','29801',
                          '53542','16138','45480','57667','21973',
                          '70574','55035','90098','83785','68624',
                          '19175','60693','43914','43977','51402',
                          '13653','98270','62667','63658','95791',
                          '37779','16505','43135','39749','46935',
                          '35661','55508','98596','88779','11180',
                          '29071','79440','22494','37881','85965',
                          '31589','17297','96083','58550','19852',
                          '35522','70301','19993','80634','98936',
                          '52686','43443','56940','74620','87768',
                          '80890','44098','31489','64568','10396',
                          '89505','56988','41398','21402','39607',
                          '51802','54440','78783','28235','84181',
                          '25985','19250','72727','98755','76356',
                          '38842','36073','68141','35061','99189',
                          '34861','25563','59559','46242','19444',
                          '70437','69386','32317','54287','10423',
                          '19001','92706','60512','33606','37043',
                          '85298','89305','25219','51668','26460',
                          '60547','45970','30481','27717','78659',
                          '87363','19193','71184','67070','79716',
                          '93279','18796','59200','84164','96462',
                          '44227','63164','99941','76814','97293',
                          '63066','13406','63426','15640','49992',
                          '63865','98813','39546','34457','58241',
                          '65558','35343','15270','59145','76350',
                          '26085','91123','21395','53130','90303',
                          '80349','47940','49392','80418','17873',
                          '51446','90119','23184','73485','67833',
                          '48767','74179','92506','34147','76939',
                          '85059','24373','90003','21137','42687',
                          '27176','97478','41764','75762','59661',
                          '88380','99094','56045','92983')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


