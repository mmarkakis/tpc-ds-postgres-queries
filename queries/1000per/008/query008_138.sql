
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '59669','23461','19187','92588','94956','39482',
                          '73532','17528','26793','23917','31407',
                          '71791','49330','45084','52607','92956',
                          '95570','50186','18403','75845','21937',
                          '26818','84854','93179','21380','13866',
                          '34734','39007','29573','69389','61799',
                          '61857','50673','48370','82435','40192',
                          '89170','17939','67970','68341','23400',
                          '42989','92854','22274','43911','29432',
                          '73852','40405','27035','89600','31870',
                          '33881','75281','19866','73181','38814',
                          '66442','16590','19858','73300','77393',
                          '76460','85094','58736','39028','53474',
                          '34747','28518','50212','26424','79986',
                          '87253','49441','24080','82374','22093',
                          '43206','73107','32323','26776','85795',
                          '43277','91734','25506','60953','53571',
                          '13414','55609','64198','96226','49772',
                          '49809','14250','18657','45729','46455',
                          '61829','11084','76401','80711','44129',
                          '11552','67048','95859','43895','20625',
                          '30125','41544','96746','25694','86418',
                          '77073','66695','67924','47261','12237',
                          '72518','40496','41433','43874','13473',
                          '84887','79107','84465','98789','62561',
                          '97527','84390','81588','16936','36072',
                          '35010','87176','27365','60225','50692',
                          '25235','19149','83786','80541','63018',
                          '22944','51151','54989','31625','70369',
                          '68770','26619','89488','80442','12128',
                          '90403','78952','41745','66030','25169',
                          '17859','34791','56372','28346','26251',
                          '37230','11216','48963','26861','86114',
                          '77431','92638','44939','74788','54375',
                          '23970','31892','21231','79597','88828',
                          '37669','73877','38026','68316','31655',
                          '35217','62648','28744','10109','41901',
                          '35950','86083','86227','51593','84858',
                          '36286','70652','80762','27622','34643',
                          '51063','82900','74661','44848','83095',
                          '63840','23085','97984','58553','72205',
                          '57927','75385','89797','15688','19738',
                          '31253','54169','33186','45874','34007',
                          '81780','63547','56282','45139','61056',
                          '36123','20345','50255','59593','14524',
                          '30670','17449','99846','63398','31543',
                          '67734','55507','77268','20319','72167',
                          '62580','76747','73192','33539','64896',
                          '23580','63623','94929','28686','40670',
                          '62759','45648','13203','25562','28158',
                          '21155','31247','29502','53580','15030',
                          '24133','73434','48932','56498','85273',
                          '64513','26648','32078','34784','20570',
                          '12559','98869','26781','82826','25870',
                          '56531','45726','60121','77476','59670',
                          '66344','10664','88169','39614','56901',
                          '95822','68873','60205','84103','88335',
                          '52364','98487','38070','23027','90773',
                          '66125','52750','52652','68863','81231',
                          '64290','52267','48486','45658','73474',
                          '96075','87075','28232','12949','50112',
                          '72464','19495','92287','29602','20756',
                          '87762','32120','75466','45447','21719',
                          '27306','16161','17586','50492','97512',
                          '66350','10149','73052','19473','92248',
                          '63854','88347','74457','88490','74379',
                          '12593','47354','70903','82425','48338',
                          '59776','21893','82498','57246','51946',
                          '88219','10370','92659','81609','85234',
                          '49933','37365','54362','34179','99902',
                          '10209','25728','78991','55303','71825',
                          '95751','48781','63607','63482','12222',
                          '19101','29674','39206','22019','29695',
                          '77809','67138','53622','19835','54977',
                          '72478','39052','22215','76756','76521',
                          '78407','44058','71367','30012','37825',
                          '92523','58946','14602','61478','71566',
                          '44003','77288','64257','47824','64010',
                          '70285','93747','70697','33766','78190',
                          '48388','11290','87645','43240')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


