
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '90056','54922','89404','60622','83393','26174',
                          '82280','24825','83322','57982','48923',
                          '75100','62343','84694','22337','47125',
                          '76181','29497','72905','30585','18552',
                          '73762','94374','62178','35723','67679',
                          '10266','35009','80336','21844','22321',
                          '15269','61909','42926','13741','32636',
                          '44776','42680','97979','64588','24966',
                          '48141','86160','67376','18960','51568',
                          '44080','38104','14540','52600','66817',
                          '16388','82273','81843','30849','25140',
                          '83695','35119','77582','40509','16851',
                          '96334','63967','47791','90360','34711',
                          '45782','22012','95623','68638','28303',
                          '38150','37430','78653','48524','58716',
                          '53638','97659','22679','65257','53859',
                          '14591','99761','89376','79356','89813',
                          '66967','49343','41287','61408','33712',
                          '91602','18527','44294','12686','32271',
                          '44112','62071','26932','46050','99648',
                          '29239','71020','14780','85498','15312',
                          '33036','35430','78668','26426','48519',
                          '71646','47938','15203','26130','62732',
                          '58557','45520','55356','18198','95327',
                          '98738','97764','30492','99956','87680',
                          '77044','83021','79085','77933','21294',
                          '70663','15562','69489','47990','39130',
                          '67749','81740','71630','79199','71851',
                          '21808','60736','53130','57293','72238',
                          '70615','20039','85304','45256','23300',
                          '95091','62814','60689','93951','90525',
                          '72736','74347','30745','71143','88820',
                          '93171','61344','14484','56875','76580',
                          '66772','17726','21526','98674','34366',
                          '45945','58885','51106','20931','97442',
                          '70485','31242','93232','96478','95670',
                          '54696','25829','86102','80387','39287',
                          '88095','90638','28697','68956','60863',
                          '51684','28520','57319','89579','19111',
                          '57064','47191','97163','49026','70515',
                          '28923','74880','73049','32031','79656',
                          '31264','19832','72664','10316','43599',
                          '12756','19342','82774','18004','30659',
                          '10681','58391','59508','18727','31617',
                          '63178','74335','80405','17205','32064',
                          '25165','19842','19929','90291','26994',
                          '67838','65330','46689','71201','33281',
                          '51930','47358','46637','99443','11610',
                          '85693','57761','81848','43256','99344',
                          '34562','64400','82885','98104','46295',
                          '58803','14802','92477','42816','11970',
                          '66533','85185','86744','40156','30005',
                          '28149','39815','67483','26131','30314',
                          '30212','88985','85755','11417','19511',
                          '70013','54094','67959','52485','15259',
                          '80874','83970','61796','93475','63518',
                          '56744','67352','50129','37269','33677',
                          '30695','12976','35478','30486','99754',
                          '31379','94576','44324','64920','58294',
                          '85427','23986','69160','95500','36948',
                          '11116','55923','14406','24176','13375',
                          '67487','36316','14499','20236','22782',
                          '43314','80490','65138','77692','44033',
                          '20803','97504','98346','40437','94502',
                          '73458','37582','92801','99968','70115',
                          '11637','67309','75916','82083','49513',
                          '35580','46361','44585','58715','71465',
                          '79898','21503','81041','11581','70418',
                          '84202','17104','93073','59991','26108',
                          '47529','54319','81443','99276','76389',
                          '22584','46842','13825','27602','52279',
                          '90418','41158','11496','81034','83107',
                          '25779','62075','67164','27265','50992',
                          '37257','18056','88430','64729','76427',
                          '65332','36339','13505','86074','19548',
                          '81089','23847','47903','38232','53765',
                          '36514','30140','72215','53198','30517',
                          '26412','39311','53523','15268','12207',
                          '73155','42800','28196','31243','87998',
                          '32281','95043','35327','55395')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


