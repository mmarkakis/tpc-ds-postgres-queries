
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '73219','51626','58064','27768','27537','43969',
                          '34113','57658','69844','17288','16381',
                          '36386','11399','14227','37807','62873',
                          '65097','55471','46862','58462','28625',
                          '30307','36754','67296','13850','49201',
                          '87953','12338','99276','40294','39215',
                          '77393','66232','57754','85843','72026',
                          '39121','43402','37759','60362','58169',
                          '30958','71373','88606','11159','66018',
                          '26425','74719','29674','55959','67078',
                          '70176','37126','16776','77402','96918',
                          '29351','25211','80544','49345','60772',
                          '87652','42987','84525','70292','79809',
                          '69745','38509','52648','79266','48542',
                          '10561','70502','12980','28272','35729',
                          '94057','71950','28442','47355','43540',
                          '68826','10716','75965','60627','75660',
                          '42613','18800','55204','53530','52202',
                          '96278','15064','24716','51472','17571',
                          '93669','52484','96855','66703','84061',
                          '87340','17280','53781','41922','42148',
                          '39433','12343','21201','65750','26243',
                          '61163','31041','62995','36542','78012',
                          '28930','24981','81049','95926','74044',
                          '84325','49682','75533','73320','33248',
                          '91540','29401','13211','48521','62228',
                          '77196','45765','41778','34422','24730',
                          '35464','99439','40966','29217','88166',
                          '23933','25303','43674','89932','97255',
                          '94175','58609','12170','45313','71718',
                          '33113','37148','29536','67741','14859',
                          '68656','18782','30499','52508','76997',
                          '75274','75616','29648','93584','98807',
                          '33237','24566','41176','41356','42238',
                          '90191','47049','59341','34685','67248',
                          '84409','48934','14059','26236','26602',
                          '19397','56872','78086','94990','76785',
                          '23445','30150','64857','96675','67434',
                          '20721','63000','54902','51332','94233',
                          '16732','43954','69075','97655','93639',
                          '78756','65737','86606','71914','32937',
                          '42697','52183','68395','42961','88180',
                          '97051','65222','43628','58028','73446',
                          '85028','16593','95184','15410','69644',
                          '69314','39513','72210','37980','74033',
                          '81440','98756','13498','68503','49938',
                          '27550','61596','44583','77869','40969',
                          '68515','76726','69319','99409','50103',
                          '24765','24003','36240','46386','60606',
                          '70915','64227','21456','66955','63674',
                          '13676','25893','89606','71539','22609',
                          '13855','77403','17444','63119','97557',
                          '98424','44733','95332','84026','73230',
                          '23314','98783','28733','73466','45078',
                          '58358','68245','87828','74574','71287',
                          '99642','97833','25913','37300','69387',
                          '29918','38418','78249','40614','27563',
                          '55255','60790','27237','42059','18388',
                          '21772','92916','45513','83405','35875',
                          '15344','56576','67900','84428','23414',
                          '39438','16053','64597','94591','32628',
                          '96676','45951','90035','77309','63627',
                          '18243','98498','70996','11435','71915',
                          '68407','45643','18078','50720','72712',
                          '33470','92266','14122','74709','20893',
                          '66002','25003','87490','98470','65479',
                          '24898','91657','22641','53901','40936',
                          '70005','76532','96953','23764','45735',
                          '94131','39389','50162','85079','56952',
                          '59783','60925','31469','61437','74219',
                          '26493','98664','14400','88774','29889',
                          '11438','96287','97332','64284','36502',
                          '68883','81161','61607','75754','49525',
                          '44855','36180','86195','87138','91026',
                          '49123','39658','12735','28227','98321',
                          '75375','32526','88195','86892','57841',
                          '77209','67325','34133','29387','37242',
                          '41989','69515','93244','12745','59392',
                          '25234','56966','60468','11310','97277',
                          '98454','63612','35251','51243')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


