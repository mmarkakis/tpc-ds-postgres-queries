
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '96035','15682','59364','21876','51527','14442',
                          '85695','28302','56192','84807','51033',
                          '60840','94740','11465','37428','45683',
                          '78958','88308','38392','52788','36166',
                          '53380','21421','98380','16041','75233',
                          '13374','33928','66213','25051','12856',
                          '93078','56411','14986','10275','96797',
                          '59249','62704','11904','40050','89815',
                          '74096','62622','17239','36158','50269',
                          '69132','59634','63875','20671','80059',
                          '49220','43865','79300','17997','57837',
                          '59783','56086','22839','91778','22708',
                          '38575','16918','66345','88073','48701',
                          '66510','17047','51464','36533','69082',
                          '41768','57250','42058','51395','12260',
                          '50065','44663','63600','28322','22814',
                          '75590','57683','14904','47082','94080',
                          '47381','48976','54621','96868','14959',
                          '43447','75090','24700','44022','71295',
                          '11117','28830','18896','25949','43679',
                          '40115','33061','36051','50813','55956',
                          '99909','92364','49508','80183','32116',
                          '59817','74191','45153','91734','15024',
                          '99825','91665','27505','80666','69938',
                          '98527','55479','37623','23847','97753',
                          '16910','57401','84489','52683','16623',
                          '23034','52525','67860','11942','13642',
                          '45028','81795','42914','41685','51152',
                          '26186','48567','71384','24246','72684',
                          '11691','13523','63288','44007','37485',
                          '91869','86867','57663','35643','72961',
                          '83282','31538','11089','26041','77305',
                          '20138','16828','47645','20301','85876',
                          '33243','77526','85562','60833','67845',
                          '62142','88804','37585','18417','64055',
                          '44309','56159','38974','42196','82879',
                          '12843','79694','92828','61969','25394',
                          '40293','63471','90262','60828','98805',
                          '47935','11708','41828','38252','83302',
                          '11418','13511','84996','49001','90290',
                          '79814','44975','68887','25549','56328',
                          '18967','55362','29665','68876','71493',
                          '88654','90039','33927','43936','16441',
                          '21815','64709','27267','97106','84294',
                          '56899','46057','27063','88915','74187',
                          '17421','54430','47162','71728','95048',
                          '14398','88045','42664','82230','86401',
                          '63894','89766','46968','53363','99417',
                          '45472','74168','34036','70107','19886',
                          '73928','27433','59087','75690','75940',
                          '75044','89853','31329','71719','54435',
                          '97601','70079','49571','52182','59154',
                          '33016','94884','17961','69899','47005',
                          '96949','90507','13574','51489','41654',
                          '80222','16044','33643','10736','97375',
                          '35089','45215','59684','63232','29464',
                          '53416','59660','44083','75324','93630',
                          '20512','69905','16401','45776','74778',
                          '32732','27830','73428','64101','41022',
                          '78302','75246','40993','66841','19295',
                          '57778','86207','28736','63903','55627',
                          '79602','47125','15753','41737','68527',
                          '19413','72033','99747','14825','65386',
                          '79524','67552','90503','71157','44493',
                          '87809','84156','71578','10693','60435',
                          '27494','47349','20529','53895','93615',
                          '94373','11318','97981','55889','42630',
                          '18449','93810','32342','58987','88472',
                          '54274','44827','68532','19683','52508',
                          '51414','47741','50986','33265','19909',
                          '40746','14211','36980','97646','80779',
                          '78668','33105','85598','67766','82545',
                          '81062','24252','81661','17285','31903',
                          '41078','42964','19159','41794','66113',
                          '36498','48226','58995','57371','93013',
                          '84435','96059','40376','81853','49154',
                          '42075','47657','69256','88364','68236',
                          '24631','80768','77367','58797','81271',
                          '71796','68105','54957','79189','28373',
                          '73827','54824','43902','23586')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


