
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '55940','89446','24690','32417','32876','67844',
                          '77063','51538','31210','99957','68308',
                          '49988','79281','71665','87170','36500',
                          '50407','98945','60466','75268','65410',
                          '44770','78852','78066','10897','82889',
                          '11423','45120','31387','78177','83871',
                          '63881','54092','73735','54416','67110',
                          '41885','24960','11743','53601','18262',
                          '98740','21238','86535','30352','76898',
                          '40270','98547','19124','93520','55483',
                          '18751','81729','79999','74159','42068',
                          '71611','66731','87647','85097','77632',
                          '52358','87112','41338','66590','20166',
                          '75026','23774','53480','71745','64179',
                          '72176','19377','74819','82379','62589',
                          '83781','61296','70539','34061','71363',
                          '40247','25038','55667','88918','25982',
                          '11370','90848','32188','79969','66227',
                          '58772','44642','18458','17738','33425',
                          '95880','52524','55354','35979','27265',
                          '95266','92557','10219','93033','99950',
                          '35347','55669','88704','79346','22619',
                          '97413','65798','77647','37187','63711',
                          '82816','25135','94277','89195','55406',
                          '67269','24907','69205','77440','69781',
                          '90678','15453','60811','46611','63439',
                          '85209','95297','55401','81906','38803',
                          '78376','94522','97311','22212','21325',
                          '82142','84268','59855','10837','59136',
                          '88701','57180','47301','65109','87708',
                          '91331','63978','79763','70505','21127',
                          '86707','82637','93245','24667','25155',
                          '81750','22236','65212','94999','86602',
                          '34416','86008','58446','41167','78194',
                          '83378','92940','69105','99885','12366',
                          '56878','24413','10735','60486','34889',
                          '65569','24334','93032','19910','25766',
                          '97284','96660','54537','86725','13952',
                          '29099','81246','29145','58864','99599',
                          '25468','47941','39830','14345','37560',
                          '17175','39864','16126','50581','11985',
                          '63068','51918','85150','55717','53686',
                          '96323','39445','51220','65339','24755',
                          '37554','82528','73485','44408','44699',
                          '75428','54387','96567','78000','63102',
                          '51187','46688','93005','82388','78491',
                          '67005','82182','73690','53631','80349',
                          '77196','99157','80252','51201','97910',
                          '94247','32135','32521','86609','90510',
                          '88932','29280','62327','85405','44326',
                          '43112','50779','53612','83943','34663',
                          '53933','32001','61148','69984','92840',
                          '96194','70570','73150','71720','15650',
                          '36465','92790','41615','43282','48563',
                          '71339','74893','19401','78756','30449',
                          '57225','60116','14923','27578','66897',
                          '45949','94365','64587','14295','43245',
                          '99758','45244','37011','84230','77451',
                          '18743','83746','29509','11132','65024',
                          '70823','22933','39998','16275','83267',
                          '36122','23221','76453','70243','67427',
                          '32997','15502','86153','36528','73495',
                          '24521','14682','51036','80609','95306',
                          '63013','14445','17717','12976','79150',
                          '53299','72867','56698','12284','11702',
                          '42642','49240','36882','91721','21311',
                          '75620','94239','51814','59663','97422',
                          '94160','93667','63356','58860','83357',
                          '81440','51094','73565','92411','58094',
                          '83573','80045','92299','67480','92678',
                          '50652','30172','65974','14404','74247',
                          '91907','13009','22673','52894','87607',
                          '16592','79836','11039','29560','49070',
                          '75254','53377','46993','23344','31694',
                          '12790','77463','79679','80136','57531',
                          '51635','10301','32507','90596','82823',
                          '29297','78277','45671','27303','67692',
                          '12484','52819','87044','88043','70313',
                          '40651','52913','33300','18224','24063',
                          '48656','28902','84350','27605')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


