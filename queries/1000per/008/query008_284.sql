
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '21232','87166','22400','95819','78590','62559',
                          '87298','39255','90116','14196','87326',
                          '93112','81580','10075','45286','90988',
                          '67753','53577','24648','49343','21128',
                          '46660','17751','98592','55395','32779',
                          '75162','65296','23615','70266','12277',
                          '67100','87184','50217','21955','31044',
                          '36106','52882','74406','93608','69666',
                          '70092','36707','23152','46669','35326',
                          '31909','13283','14871','81415','10474',
                          '87486','25672','55149','49289','54030',
                          '13390','41975','13103','60774','83886',
                          '40196','32137','80466','48629','12035',
                          '25887','77428','16759','16056','82677',
                          '91175','21447','74139','52913','57756',
                          '88949','15179','48546','62489','44358',
                          '40854','47138','57427','86921','70298',
                          '27005','66245','60731','33835','50970',
                          '90484','82032','61953','26029','87250',
                          '27144','46840','58426','42277','22698',
                          '69091','19416','95526','38991','79800',
                          '47875','95679','95273','87416','89996',
                          '74793','92183','44805','69483','68398',
                          '70948','38136','76609','95648','19252',
                          '48675','64940','18457','60151','28109',
                          '51573','83761','93295','57422','82806',
                          '44943','25262','88133','10716','35414',
                          '50816','54117','57452','82216','25110',
                          '95182','24024','34141','21430','20104',
                          '24213','46524','58886','41139','49089',
                          '34050','12994','61382','83491','85064',
                          '90329','10124','26669','16329','35959',
                          '44977','50510','15719','93172','32715',
                          '87480','21185','29505','83587','90175',
                          '43937','83006','12489','96643','62818',
                          '49117','85927','71942','72935','87147',
                          '93557','68088','13538','53715','33953',
                          '96926','80463','82068','90849','89119',
                          '21579','60443','19054','77677','24753',
                          '96044','57653','58739','23720','11770',
                          '18143','66381','37438','30768','10197',
                          '21547','66399','54047','65162','25403',
                          '24538','68503','95449','52118','55491',
                          '69833','95363','21526','11390','40054',
                          '97865','84474','50942','57523','70173',
                          '90636','32153','40303','54563','37367',
                          '20464','84985','84428','19918','91907',
                          '94395','11136','39472','40378','61674',
                          '66029','83845','26155','60146','29839',
                          '83079','67195','45001','32407','89716',
                          '47532','82346','36523','16750','40398',
                          '48314','83114','43024','47091','59463',
                          '95216','98452','55043','75971','24266',
                          '48536','40907','55641','63305','18742',
                          '74492','86998','70543','16513','93933',
                          '72667','19923','55781','34859','16982',
                          '86762','43534','95574','28328','40150',
                          '29671','74278','99918','49725','28300',
                          '26417','33833','35896','37062','58832',
                          '82751','31124','40161','54698','16987',
                          '73722','52672','16097','15660','76775',
                          '13319','35827','57346','19286','67939',
                          '63607','30233','87509','69753','32688',
                          '51529','51793','97122','27529','44330',
                          '28579','98780','72934','54543','89062',
                          '95125','92840','83334','20490','57306',
                          '77666','17864','54193','63655','96418',
                          '34439','45444','72021','72584','94153',
                          '97050','76636','58045','14906','60841',
                          '39916','87150','76265','63667','57957',
                          '76098','94662','18580','61214','51545',
                          '74801','71837','67220','42415','62390',
                          '10215','55380','93665','97880','63940',
                          '10548','38826','67356','86816','34482',
                          '35013','11670','80366','39454','24388',
                          '37404','83711','71267','90698','54833',
                          '70765','97160','54626','93802','17872',
                          '58539','10302','17931','56130','16034',
                          '11486','94932','55068','85802','18694',
                          '70931','78067','65499','27494')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


