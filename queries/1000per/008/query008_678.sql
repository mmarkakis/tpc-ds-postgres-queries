
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '76367','37056','95861','23644','59923','23659',
                          '12344','84959','85151','25088','13325',
                          '90765','22585','57682','62178','70891',
                          '35682','57564','54878','30564','48220',
                          '29241','32687','76846','17806','15011',
                          '86815','77706','85600','18918','35493',
                          '87083','16876','14100','51318','72763',
                          '34238','29712','10475','17291','34535',
                          '35610','51028','83631','60950','26523',
                          '51037','96099','33357','41990','52508',
                          '47607','45148','96616','13474','67806',
                          '25838','35801','20523','93737','57376',
                          '49266','39388','86392','71132','25541',
                          '91082','24104','58115','82917','13247',
                          '40048','27495','92735','69881','80945',
                          '44720','99178','79603','29255','25548',
                          '19477','28005','25100','91060','91435',
                          '49352','19187','68428','13797','38870',
                          '65837','95829','80461','45814','55153',
                          '52780','73340','55420','62716','74360',
                          '57053','14563','97357','49154','48206',
                          '46231','52197','17838','34218','88651',
                          '91221','43507','66927','11065','74294',
                          '99810','84487','68535','41909','56278',
                          '60093','98838','88032','10635','27255',
                          '32522','48446','17442','77080','10784',
                          '37613','40686','58308','86320','32607',
                          '37970','47329','20072','48256','24395',
                          '63679','54652','51080','90725','60696',
                          '18776','79080','51893','36505','50027',
                          '47130','81755','89587','83979','22182',
                          '69169','11416','82629','94442','72801',
                          '24260','76701','16029','91847','15068',
                          '12511','95376','25206','23157','88105',
                          '70480','96153','14448','19698','59895',
                          '64576','43050','70831','12395','45131',
                          '60479','70215','23307','81705','51069',
                          '99251','49767','44479','10465','96034',
                          '61943','62269','92158','71146','71958',
                          '12856','41295','64395','98122','56816',
                          '20591','77975','90022','87578','25910',
                          '59605','64933','52312','94800','52098',
                          '97976','71129','39592','12985','48563',
                          '99399','67022','83976','99039','45266',
                          '49426','78920','65416','75125','35616',
                          '97086','39804','72213','94112','15996',
                          '33116','48906','35740','97749','93755',
                          '88936','99136','76272','65278','94451',
                          '91379','73840','60010','18175','63127',
                          '59115','96919','14501','92188','40229',
                          '46012','58349','59145','76829','91455',
                          '81010','91191','49347','60920','91028',
                          '87689','99757','92327','59413','75656',
                          '66865','84774','26723','14575','16576',
                          '66621','99042','14908','15880','45342',
                          '77317','98117','25788','22049','74169',
                          '11405','39768','40337','12437','82925',
                          '81167','39426','14127','59984','20280',
                          '63282','63101','32520','51936','33713',
                          '66307','27992','35624','59160','59091',
                          '58375','67978','92320','72061','88256',
                          '32276','73908','92299','65449','90827',
                          '73311','17653','31369','18576','15264',
                          '14713','59553','97889','86900','16283',
                          '26102','77304','23962','80014','95714',
                          '25939','47234','80297','55988','72152',
                          '88484','76531','77660','73967','29032',
                          '99268','82062','99619','41925','88098',
                          '21808','87980','75698','39314','54378',
                          '82977','32544','36446','50484','46705',
                          '39208','73512','43278','11059','72310',
                          '26951','67699','96160','64141','41989',
                          '63915','22097','53634','60919','83331',
                          '52677','64649','86356','38167','33554',
                          '62619','89696','10221','13786','38733',
                          '36342','74089','15477','62808','81136',
                          '54811','84675','94227','72556','14210',
                          '84951','53624','50109','32218','40226',
                          '18235','20197','12968','40548','43687',
                          '35033','46498','80443','52291')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


