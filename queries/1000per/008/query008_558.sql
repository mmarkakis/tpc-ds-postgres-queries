
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '24670','43262','51932','77652','21522','43654',
                          '32259','64129','52890','73465','20469',
                          '20091','67158','50115','56720','65089',
                          '99809','93759','76062','26962','27534',
                          '91554','14031','30085','80686','72487',
                          '13462','66539','57338','69407','24617',
                          '54422','23912','11993','49457','25574',
                          '24497','27793','85168','52019','15467',
                          '84079','12069','60183','91689','85374',
                          '10305','73535','42412','13398','61626',
                          '84260','31088','40627','41065','57786',
                          '83990','77795','53426','44552','18196',
                          '39417','59756','98949','97799','61242',
                          '53553','87715','95728','95752','92475',
                          '11340','56313','51984','48717','76781',
                          '69910','24264','41007','58930','92922',
                          '12895','95734','96256','60504','26575',
                          '27715','11051','23207','45042','61821',
                          '23983','26761','85419','72034','76554',
                          '91084','12705','94061','63522','67629',
                          '82319','33904','43506','27336','99066',
                          '25335','71660','89505','18930','87500',
                          '51549','94387','54698','65294','87926',
                          '33905','23467','68751','12495','49598',
                          '77725','83828','38469','70976','76976',
                          '96568','47014','39869','60889','17093',
                          '46474','33281','31112','93694','41727',
                          '78469','24513','31212','26103','36800',
                          '33918','38375','60279','72724','32920',
                          '38277','77422','20534','99522','84844',
                          '12200','77138','82974','38449','46506',
                          '37987','77305','76358','83880','82853',
                          '40370','91892','20631','97644','65015',
                          '68963','25356','63564','68351','69187',
                          '52010','27440','23947','47817','78242',
                          '76671','32083','64481','15620','44220',
                          '15720','81318','19547','70113','10160',
                          '71900','75284','98649','91587','71935',
                          '71564','72065','89071','30379','53737',
                          '63915','31660','35418','15569','54634',
                          '55154','47196','55130','76877','70598',
                          '13238','69244','95804','92323','45818',
                          '27280','61250','96268','15952','83076',
                          '13386','28898','35963','19101','56785',
                          '72410','45378','17762','64660','95800',
                          '12047','26753','78180','11887','96989',
                          '70393','43291','42279','10806','91204',
                          '95796','81891','68747','22248','64929',
                          '20547','25450','41609','54758','34814',
                          '69570','59883','49972','46573','13583',
                          '73961','98758','22442','64542','17946',
                          '59677','98058','89646','32917','20605',
                          '48388','55251','76284','81742','41835',
                          '52469','25672','66261','78448','85625',
                          '33057','52887','96988','93843','64079',
                          '78804','51702','21192','51559','95346',
                          '27080','73276','18467','75024','30192',
                          '10653','10191','96645','14558','68680',
                          '45393','96687','71696','17118','44448',
                          '47690','77993','33175','35128','60244',
                          '55183','59776','36180','18830','19749',
                          '70618','86748','20119','77158','58080',
                          '76943','55082','94015','12024','54953',
                          '76599','86228','91808','29724','61006',
                          '83438','53099','63380','95192','95360',
                          '25425','60743','90695','12615','13254',
                          '84990','72221','82682','83402','78260',
                          '23346','91599','79425','34408','68471',
                          '79705','59537','36217','47595','12552',
                          '81368','26766','28616','84127','93788',
                          '35420','96258','45922','52978','29041',
                          '22924','60960','27339','65242','44888',
                          '41362','31371','55951','87094','79840',
                          '72457','30760','88632','30073','81899',
                          '40506','37687','57271','58675','17692',
                          '77926','44421','55705','45065','40703',
                          '27539','40975','11263','63152','49086',
                          '71452','35069','46789','61671','39536',
                          '40342','67402','33081','51349','46368',
                          '38427','14704','81177','49771')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


