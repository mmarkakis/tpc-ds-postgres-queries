
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '23822','13553','25909','35215','55952','93504',
                          '31431','25685','20455','77644','48845',
                          '76982','10807','80143','34895','94523',
                          '43589','45881','96192','13288','63393',
                          '12658','52356','48070','67891','33103',
                          '91204','19717','50320','53069','98750',
                          '95349','51445','74221','53458','37181',
                          '51113','66802','37613','64086','36635',
                          '77280','25283','73376','27211','94248',
                          '86415','65452','36023','39714','65423',
                          '56973','62980','19445','33638','26200',
                          '28325','33449','11635','26559','75544',
                          '46587','21648','72437','30510','60514',
                          '44708','52743','62927','31308','94707',
                          '98903','30019','36048','81795','84149',
                          '71642','56150','88837','63954','92932',
                          '85244','44075','88178','97178','26499',
                          '95129','11380','15585','26724','71681',
                          '12376','49024','76574','99616','13655',
                          '61816','51620','80858','38744','64371',
                          '43417','11474','50491','84271','22470',
                          '24536','68981','12337','83539','95889',
                          '58119','68551','38980','14985','22601',
                          '15546','84430','65483','82836','59492',
                          '20700','21350','34140','18689','64886',
                          '78257','61342','21954','84503','82669',
                          '25824','88534','43438','44985','55250',
                          '72179','75829','81244','19374','17207',
                          '96992','13053','78188','92520','90283',
                          '32636','79798','19415','10016','24071',
                          '40122','18453','28038','54451','15860',
                          '10759','25830','47977','56612','35875',
                          '29268','28452','63824','25458','82569',
                          '65825','87546','19196','75280','48203',
                          '16338','74478','17393','27212','36287',
                          '39592','26860','55271','52685','77358',
                          '67352','99910','53198','16229','55877',
                          '45026','25529','81689','39748','64930',
                          '68094','81075','37468','60277','25696',
                          '83952','51441','36408','12937','94767',
                          '50268','87940','12168','45380','64195',
                          '66821','20671','63320','26957','72022',
                          '27982','79019','34269','45938','50326',
                          '69631','42467','27634','53378','48566',
                          '45316','80602','26532','59331','23793',
                          '37402','17855','66683','58740','85007',
                          '38400','61884','14930','68553','74450',
                          '39028','38952','27249','61502','56482',
                          '30965','24215','54629','88771','51510',
                          '71353','80744','28871','87638','59323',
                          '67390','47516','47758','12213','52108',
                          '62216','71481','13691','29966','15602',
                          '14539','63665','83300','99744','17359',
                          '59088','55783','78857','65834','92301',
                          '49524','21257','93999','61067','28961',
                          '52007','13519','14088','38444','20444',
                          '24125','39025','13201','16540','14621',
                          '97722','42946','82972','24399','71430',
                          '50950','16684','95884','78760','45857',
                          '31577','85451','48038','37000','47103',
                          '99326','56790','30555','40837','66715',
                          '13866','52965','19011','73838','69316',
                          '70674','37028','84728','49278','97763',
                          '26468','27749','65113','53464','33310',
                          '21271','59907','21035','17643','67513',
                          '49552','19690','66889','54031','84432',
                          '68346','74816','33897','62969','10195',
                          '37283','57729','52042','40055','19156',
                          '63764','16515','84820','27985','51714',
                          '93119','90881','85792','95793','75623',
                          '27295','96273','95941','77390','59817',
                          '45779','13613','64474','44067','33043',
                          '74184','97865','23556','13231','89294',
                          '33021','24472','98499','43058','63373',
                          '51019','28944','77028','21922','48417',
                          '54743','22395','13732','84869','31017',
                          '88032','88233','26405','98117','45678',
                          '70284','51120','74782','71491','62210',
                          '61101','93085','38752','87055','68831',
                          '18406','86417','20839','69092')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


