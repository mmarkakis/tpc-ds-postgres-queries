
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '17288','86888','71302','82379','56465','62646',
                          '27845','32676','49660','30647','94005',
                          '95085','56174','92957','53686','92845',
                          '94257','29800','17743','60096','30613',
                          '35152','91986','20285','15577','56281',
                          '63731','18576','78536','58630','38361',
                          '63627','18269','25613','82858','40213',
                          '45338','56908','62286','50623','39592',
                          '71020','77438','97095','54732','54294',
                          '59028','85859','47736','86934','70593',
                          '78232','98436','23355','51110','93935',
                          '91069','24934','29640','58137','76123',
                          '49483','28064','27086','33780','48197',
                          '62673','55335','18796','32482','91241',
                          '43097','42410','34612','60900','79932',
                          '62146','79255','71595','99440','85160',
                          '24294','13114','34110','24206','54868',
                          '26730','93240','58192','48204','60848',
                          '35291','92175','90824','44745','29865',
                          '31481','56416','47091','32092','99494',
                          '67020','39334','50024','63935','25954',
                          '42986','58406','38908','57455','55823',
                          '72423','37354','54312','30529','67351',
                          '34426','36954','79093','20042','56609',
                          '95765','83447','10896','90161','66600',
                          '25628','44979','86817','17447','26900',
                          '39777','84186','69847','87702','99682',
                          '68525','65603','10706','65038','96110',
                          '17666','88869','29888','44528','24531',
                          '27038','65963','61914','24582','36020',
                          '23405','87604','25245','20717','45759',
                          '28114','14537','23031','74531','36501',
                          '80463','55222','41849','16838','73700',
                          '60124','69811','44589','24120','11273',
                          '23097','71249','12673','29058','61830',
                          '74730','70644','77623','49347','11785',
                          '22462','87411','32837','76765','30308',
                          '53746','13609','74155','74000','88053',
                          '17405','28768','51784','11506','60528',
                          '91698','83336','17857','12260','59220',
                          '49134','41470','64213','28687','52829',
                          '82217','94628','67629','46607','36423',
                          '35606','65172','18599','84016','17262',
                          '51758','92270','91240','51493','59691',
                          '87209','53369','81860','12074','55358',
                          '15269','52617','13982','45672','33360',
                          '61220','93103','53561','97621','31415',
                          '32260','86474','99263','81159','34293',
                          '26596','16909','78788','31762','83243',
                          '36546','94882','48765','80868','95439',
                          '60650','59710','66512','30630','67508',
                          '58498','82644','88334','81802','81818',
                          '19509','90182','34934','49625','36086',
                          '64484','81231','42486','96391','36757',
                          '89080','31789','72825','41230','15118',
                          '44575','26256','57988','78933','25080',
                          '37145','26103','26324','91502','53296',
                          '89807','97053','62550','86632','27727',
                          '68130','87251','70605','24373','38161',
                          '76102','58584','79140','11789','32245',
                          '76533','83778','46924','41306','77205',
                          '52448','21161','13565','83479','42187',
                          '58605','80337','73627','21521','79535',
                          '90634','17767','76584','65309','68261',
                          '44614','96713','38522','75129','87784',
                          '24842','11702','89036','23338','68609',
                          '97472','84592','45561','37005','95623',
                          '63620','50988','40153','37688','73603',
                          '39963','29550','40368','45863','67723',
                          '44876','58436','36818','70751','81331',
                          '76141','69324','11236','76779','70740',
                          '95688','39958','48897','34352','40741',
                          '69241','65840','39546','48022','73327',
                          '29486','25320','11046','42436','85565',
                          '17082','41929','40094','31240','65621',
                          '29923','57992','54295','13563','80345',
                          '30167','82987','77807','61326','39663',
                          '99478','75595','98455','65292','78728',
                          '83220','26732','97048','11520','29583',
                          '97202','35147','39694','14530')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


