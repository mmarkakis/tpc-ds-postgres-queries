
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '39709','78471','98495','86433','88324','25700',
                          '17950','90969','91047','59680','73630',
                          '86200','28238','32028','82504','53512',
                          '87449','58975','13519','98319','52550',
                          '99681','90881','73191','27063','21359',
                          '70152','63897','55864','83535','52827',
                          '70673','41741','16896','57184','32431',
                          '15110','17115','11333','20400','31274',
                          '40342','94832','46439','86773','32254',
                          '60035','65814','41495','79817','25788',
                          '41397','73978','22563','16082','78064',
                          '77960','86670','78020','60468','43434',
                          '69984','72538','30463','30981','94970',
                          '85062','54100','66689','58876','53615',
                          '12898','55634','19962','18081','47755',
                          '42545','95218','18412','12129','17047',
                          '91974','78391','39287','52941','10391',
                          '65932','93571','75275','12342','53252',
                          '41818','29117','42688','98694','76748',
                          '18413','60269','81382','68061','52653',
                          '24527','89125','10658','18402','82553',
                          '70104','63130','52012','88525','13085',
                          '29838','39029','60197','54644','46861',
                          '25827','30501','37371','41645','65582',
                          '86646','74513','81962','93313','82917',
                          '75876','56046','56581','58489','24649',
                          '36638','50909','26879','95282','31746',
                          '49973','98853','75501','28178','67785',
                          '13833','41205','90146','85910','92989',
                          '76787','74305','58077','33596','21752',
                          '17630','39639','72345','79933','29829',
                          '58225','58620','26870','52314','83460',
                          '95339','47117','25399','37515','23701',
                          '20707','13225','52799','98632','40348',
                          '32912','91530','80275','26016','36156',
                          '66708','64418','61403','55847','96662',
                          '94120','60219','43431','87364','44307',
                          '91373','92470','15540','18456','87252',
                          '11331','43653','32283','83355','62513',
                          '43177','77851','97373','55635','60856',
                          '19912','69412','42330','25266','25432',
                          '75621','69436','73357','73054','57934',
                          '30248','61901','91122','82899','12733',
                          '19152','40716','17166','27116','77113',
                          '31486','28583','75531','17984','79095',
                          '38009','84305','41003','81131','55278',
                          '59635','52336','43257','15224','22435',
                          '64940','32045','50135','78093','51117',
                          '10870','29537','49323','72590','24902',
                          '32253','13700','95326','18573','65042',
                          '64901','50064','94964','23204','85824',
                          '26501','15988','54905','45751','69431',
                          '75445','32830','36157','49775','42111',
                          '66583','43869','62552','62295','53524',
                          '16978','89731','98697','39675','17340',
                          '20831','58131','57150','30841','65067',
                          '58957','19961','57907','67462','77323',
                          '93204','98866','89025','87506','51503',
                          '76119','58302','43200','40147','88031',
                          '48664','85727','39188','22286','72037',
                          '70739','10230','72135','49089','96399',
                          '19766','43478','19026','25135','38108',
                          '74706','57565','80639','49904','50130',
                          '61323','97542','89171','32288','20201',
                          '70575','84967','35130','13411','79421',
                          '77949','93744','41458','91028','35498',
                          '60630','62467','55993','19379','20511',
                          '51889','69634','16448','43526','50216',
                          '63876','33355','65169','92948','97243',
                          '21450','14918','22404','98264','42957',
                          '35745','75126','28311','99075','40653',
                          '70862','52711','12593','48855','37358',
                          '33707','53872','31974','21127','96261',
                          '81103','33009','11309','68841','67986',
                          '39320','72674','26546','48289','99083',
                          '73134','83100','82341','61237','32141',
                          '97655','14852','72737','93057','99488',
                          '74274','95345','12133','98359','40008',
                          '50796','95052','99021','59755','53813',
                          '76681','56894','62735','90890')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


