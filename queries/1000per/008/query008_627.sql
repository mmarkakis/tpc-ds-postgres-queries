
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '39347','41745','10608','88357','45292','23185',
                          '32466','49979','14940','48486','65949',
                          '37575','86823','58583','11593','79896',
                          '16520','10699','17708','66452','20556',
                          '41456','55214','52939','21791','74357',
                          '65542','67725','66561','87933','36962',
                          '60840','98977','87710','72455','65844',
                          '17611','95649','48175','85914','94686',
                          '36050','25533','16808','53182','28998',
                          '48492','32254','59861','86032','50810',
                          '39102','40355','42673','94877','83617',
                          '57410','14116','31432','96255','37656',
                          '43334','42443','30276','50456','49942',
                          '51876','82458','42647','27700','79820',
                          '51076','61978','75994','86776','33672',
                          '30856','16321','45356','63381','70916',
                          '60492','46913','22054','85180','22506',
                          '18438','78790','50067','74890','55891',
                          '71755','56888','87061','24964','13384',
                          '82265','73950','57870','94344','52075',
                          '53785','57154','60838','54685','75904',
                          '25532','53469','61288','39131','10886',
                          '16839','46826','48624','79051','43221',
                          '51747','53635','72953','49767','13147',
                          '30345','12901','48479','22964','97537',
                          '74338','62460','25342','43944','50903',
                          '42358','90277','61986','87610','76112',
                          '29785','47823','27096','45896','14646',
                          '97835','26226','15532','81014','30680',
                          '68006','82564','37010','63819','44409',
                          '31774','14430','76699','64040','68969',
                          '16973','22559','58529','62858','77878',
                          '92775','88896','65748','52705','49626',
                          '50838','76074','20923','54545','12092',
                          '52309','55410','36527','15011','75959',
                          '94373','34413','14335','38470','24335',
                          '39787','44951','74606','52025','66241',
                          '34216','88312','33094','23712','46875',
                          '12781','99585','99205','43205','12674',
                          '25001','19009','74659','21197','20571',
                          '78201','39980','20940','21006','30236',
                          '16765','23774','62921','84901','64052',
                          '19302','63950','54330','26516','79597',
                          '56249','32116','60460','13354','72008',
                          '79116','10859','92030','31600','58338',
                          '67487','10049','40895','78065','95829',
                          '87889','44411','44261','42772','34064',
                          '35625','38314','15149','11078','24477',
                          '71674','33011','59514','21674','42464',
                          '18337','26655','82173','76864','69267',
                          '10119','49910','88927','29242','35418',
                          '87302','91645','16714','34689','50715',
                          '54909','79696','82434','14892','30520',
                          '59216','27542','36997','68913','38929',
                          '80477','68632','27803','42843','89290',
                          '30475','65231','42971','74945','65346',
                          '87237','45422','15554','27648','45502',
                          '13411','96510','27277','89134','60811',
                          '48828','94474','95708','45407','94052',
                          '88680','11422','13603','40546','83150',
                          '63947','28985','58084','63183','38170',
                          '87641','29263','10411','38364','79406',
                          '58294','89411','58604','71194','73097',
                          '11706','13508','17974','62210','98182',
                          '43931','18797','52925','86841','89409',
                          '81781','87874','20601','96992','64198',
                          '71379','48236','53181','76477','69026',
                          '91186','62760','68611','15379','50620',
                          '20844','83463','84780','50666','12972',
                          '68805','22782','40953','21455','14498',
                          '49382','91480','21992','44812','31532',
                          '16967','73820','65788','17330','87108',
                          '17241','24186','54843','12539','73652',
                          '49718','10946','50740','66176','46513',
                          '23020','10556','60026','27754','64842',
                          '68884','80699','11989','85246','94572',
                          '24475','22885','36427','48544','38789',
                          '85050','83511','28675','99834','92530',
                          '42036','88214','21690','73547','59782',
                          '66698','75803','47755','54086')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


