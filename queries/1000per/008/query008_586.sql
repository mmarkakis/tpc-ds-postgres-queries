
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '93070','93286','31498','41933','29203','39011',
                          '88784','77038','83313','86407','48658',
                          '54372','66672','53700','96684','10537',
                          '31692','86419','80752','22978','51776',
                          '72918','34546','99848','84105','75955',
                          '46727','52993','54484','24014','16437',
                          '45666','63157','69348','40001','14398',
                          '64730','18148','72346','74219','82608',
                          '98874','96502','92613','98563','21200',
                          '38557','40525','83954','84831','27833',
                          '66607','81639','85994','34603','13587',
                          '90762','23768','10754','94938','42462',
                          '46255','79864','39315','40233','60918',
                          '47386','48792','50761','18731','77396',
                          '36941','24720','77191','11527','91122',
                          '73425','99054','31807','67321','17116',
                          '47068','76342','27349','97989','94216',
                          '57642','68447','37822','17810','59357',
                          '19246','36843','96661','85582','41716',
                          '18828','71384','87996','10481','41299',
                          '86967','98336','97418','67011','71621',
                          '33441','10419','36140','78501','73865',
                          '27709','85039','63662','40254','43550',
                          '68157','20596','48905','74483','21264',
                          '39819','94573','15382','46854','72523',
                          '56435','78854','17866','30617','17661',
                          '74606','49308','76209','42879','12287',
                          '73687','58777','75983','21293','70565',
                          '29933','92933','23320','98730','97984',
                          '42241','29476','78990','55487','99616',
                          '54781','13707','65721','61881','84868',
                          '10775','61467','38073','91510','54529',
                          '24266','22360','33415','37935','72437',
                          '73953','29521','87817','20794','21485',
                          '13399','98576','83351','50571','54451',
                          '57498','37958','90173','79754','20523',
                          '54276','47377','43180','43735','81046',
                          '27737','76587','86347','10502','46810',
                          '46848','31557','61637','29397','25064',
                          '67795','90057','18933','84911','86180',
                          '22546','77980','78220','38266','22012',
                          '23182','51835','18841','26883','55608',
                          '25777','52210','20102','29034','49678',
                          '89603','69626','45206','50219','30699',
                          '27366','87840','38038','15198','25267',
                          '76680','50375','69092','51356','21268',
                          '27075','49620','41637','57269','38607',
                          '58226','40913','53910','66744','66657',
                          '64640','20589','17814','32077','78365',
                          '17186','31903','42111','15814','35476',
                          '49825','51436','40086','77568','38898',
                          '52431','41171','69609','82816','59027',
                          '38687','55764','36303','60396','36476',
                          '10309','59704','79373','84244','78324',
                          '94156','43556','90791','79665','58959',
                          '49739','57402','97252','47138','14275',
                          '33396','50381','63194','54090','94406',
                          '13728','42384','21050','30610','77028',
                          '92966','91685','70126','57992','57963',
                          '57761','47693','98435','71379','65437',
                          '46963','58984','53750','12105','53685',
                          '64191','50069','36122','54333','32307',
                          '42615','88745','78209','60657','19447',
                          '48424','30314','93092','25068','33100',
                          '69352','55102','20379','98694','42186',
                          '13193','84179','36086','79912','20488',
                          '75060','13244','96052','87917','13879',
                          '46565','19300','76544','46194','53321',
                          '26525','52743','73730','85346','66724',
                          '65291','48817','96788','61678','83760',
                          '54277','39200','84145','84611','28363',
                          '60929','27067','17736','39658','43948',
                          '13143','87082','34548','38354','72830',
                          '75769','63518','96284','47072','76515',
                          '17082','14834','98421','58474','55677',
                          '99803','91817','97476','10795','39761',
                          '85826','60153','75799','72707','70255',
                          '33897','58480','81155','84610','27140',
                          '10810','68615','86871','93031','49786',
                          '73006','79259','66762','42125')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


