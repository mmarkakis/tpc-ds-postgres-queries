
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '86231','10977','95231','92734','20878','50873',
                          '42478','75250','51121','42871','74539',
                          '16926','16354','89037','64246','86385',
                          '56959','57793','49456','29255','81648',
                          '48678','43477','25548','91833','95127',
                          '56070','60018','53722','24937','85321',
                          '77777','31284','43124','50995','47136',
                          '48595','44662','88915','60954','15678',
                          '55816','74885','49108','21245','38817',
                          '43510','11635','75866','36983','60456',
                          '11458','44961','24786','39443','18416',
                          '16033','66197','75365','76541','16627',
                          '41155','75136','55404','42165','28772',
                          '33721','63523','32921','57615','89702',
                          '21534','42130','45389','65638','49309',
                          '83736','14210','61916','63878','35161',
                          '30015','47426','24335','81163','66661',
                          '52469','67138','96002','81711','70585',
                          '40823','78070','82883','58004','81208',
                          '74185','51512','99553','17878','95549',
                          '21677','13580','29812','21727','86056',
                          '96813','30863','99832','77149','53481',
                          '52867','42018','44980','42070','26563',
                          '87884','25822','70912','86340','65759',
                          '53323','52797','80325','66754','54681',
                          '82476','82156','88829','23359','37285',
                          '77651','51633','35160','83218','20770',
                          '67434','21280','86566','23413','14511',
                          '67464','34415','83666','53852','35317',
                          '83321','13904','10997','34886','60048',
                          '61621','83911','85277','82053','20529',
                          '76170','21840','96047','18816','84732',
                          '52946','45438','48963','40179','12272',
                          '13594','51449','51042','99545','97866',
                          '43701','52953','56776','53286','85448',
                          '80635','69058','42330','36705','40469',
                          '39261','41393','69194','35007','91350',
                          '19694','18023','63690','68997','49342',
                          '62764','61723','65396','92684','96541',
                          '32694','60610','27623','97687','97842',
                          '78656','69579','60204','67074','88021',
                          '89151','52835','74927','75172','54546',
                          '90911','84342','46092','87672','62989',
                          '56609','31953','89460','70368','60477',
                          '72728','23598','55119','66364','82783',
                          '83458','73414','35574','15944','17622',
                          '46500','60602','38321','30766','91351',
                          '34897','80678','41266','43665','57666',
                          '80833','34746','33992','10626','98270',
                          '39878','25485','31262','82740','29195',
                          '98548','14092','91059','83773','83457',
                          '56315','80422','42973','88534','31117',
                          '78565','79771','69135','59882','80158',
                          '17778','35487','58649','54098','41772',
                          '85681','45446','28360','30771','19892',
                          '58474','89344','84024','48481','11605',
                          '14600','81582','12202','39479','84684',
                          '56425','48483','18492','51303','88753',
                          '57489','32501','50579','96787','15194',
                          '24154','93852','21847','21737','94773',
                          '96298','84085','34308','62916','54961',
                          '55627','26570','68197','33595','55818',
                          '49937','89644','92272','79369','33989',
                          '58108','71027','99909','73027','18138',
                          '65474','39605','95709','27280','19524',
                          '48424','76939','86496','56267','97951',
                          '40783','94668','92740','44487','89538',
                          '45841','67509','59864','77871','48908',
                          '95841','32536','83663','56309','60906',
                          '82739','84596','10969','31890','13177',
                          '87823','23356','29871','48588','27464',
                          '19414','13587','79240','53901','74629',
                          '82953','69613','49155','62483','36778',
                          '94157','68582','14378','52550','51260',
                          '85421','13211','54418','57020','29120',
                          '13417','17409','33476','13887','44717',
                          '43036','86654','18915','77634','87700',
                          '35548','73304','40223','92199','48451',
                          '25975','74633','30544','99177','94118',
                          '46894','17930','57640','93687')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


