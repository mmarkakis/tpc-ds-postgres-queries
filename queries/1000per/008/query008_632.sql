
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '26775','47171','23698','82672','45648','20979',
                          '27581','10361','79069','21813','84384',
                          '36783','41481','14671','29486','58272',
                          '74454','78186','44894','32331','72417',
                          '72107','79486','58349','81068','68642',
                          '68575','76114','82718','92607','51639',
                          '34850','54241','22050','80371','76216',
                          '83708','40093','60264','82141','45493',
                          '55569','93366','17281','46935','54740',
                          '38250','55554','86242','59088','47243',
                          '14437','81267','69863','12783','53376',
                          '89844','79637','22874','66314','34446',
                          '80263','98698','56329','51267','85872',
                          '32457','36241','27041','65291','75714',
                          '17904','57877','56466','93057','32111',
                          '63212','17263','72049','51665','90485',
                          '89071','20852','77406','85267','67087',
                          '47496','52456','71982','49067','82941',
                          '78874','13106','84117','67947','30746',
                          '15366','54510','40669','26876','73523',
                          '56492','85496','59987','45108','45483',
                          '74456','34711','88665','82957','62157',
                          '86597','94547','16237','99641','70129',
                          '69483','24227','23154','34219','16959',
                          '15090','90675','30356','89051','58455',
                          '36459','95426','79997','64115','15772',
                          '27026','54951','73743','64652','85927',
                          '98869','66490','91628','52088','84361',
                          '56878','87140','97443','32245','65435',
                          '76383','83062','41949','22689','12108',
                          '54300','18043','95950','32537','60979',
                          '53562','87310','34181','75546','50477',
                          '14811','56226','39466','75619','93006',
                          '34088','87997','95677','58020','12616',
                          '41511','46243','56250','57302','22499',
                          '18451','63130','41845','44770','25476',
                          '47172','63910','40424','85788','74465',
                          '66778','79012','40607','53382','77597',
                          '35895','59566','83816','45576','44235',
                          '43560','47164','40316','12833','95038',
                          '99054','11652','63335','76999','34249',
                          '99300','65721','40732','41571','15035',
                          '87245','62443','49634','97277','22194',
                          '23368','38140','50701','34419','59831',
                          '37226','34315','85553','98022','24408',
                          '24672','78998','65732','75648','74150',
                          '89431','96937','93066','93749','29874',
                          '56211','36008','19860','22248','42114',
                          '20803','71598','40041','54754','76179',
                          '13832','73401','96270','78714','31220',
                          '12088','76344','80106','99564','60270',
                          '48507','29448','41507','75154','69960',
                          '75877','61642','98650','55305','65722',
                          '13563','17526','20863','41885','17583',
                          '53536','74530','76342','14543','62190',
                          '36845','73952','97680','91694','39419',
                          '16329','23597','20679','14752','31699',
                          '66550','54262','74578','14074','64430',
                          '57116','76082','55578','42076','36612',
                          '24336','56928','83508','63265','20427',
                          '90244','42045','27302','52432','41030',
                          '39922','77864','18622','82300','16819',
                          '19754','26861','18308','40520','72488',
                          '21748','98960','19140','16293','71368',
                          '90878','44362','14175','27379','17103',
                          '83635','72154','99638','46822','79963',
                          '64509','76271','28599','93403','94400',
                          '94470','29413','29312','88871','20445',
                          '14195','42726','53574','81932','45246',
                          '38502','86519','42108','32029','85454',
                          '75945','39651','12488','91521','51017',
                          '88635','25520','25805','36793','54562',
                          '61710','76590','11150','42501','75601',
                          '95456','90739','62148','94062','48038',
                          '56679','15593','46915','88751','87211',
                          '99613','40809','34447','53295','14756',
                          '90604','52443','62472','88986','55479',
                          '44846','16809','69550','45558','63946',
                          '86343','42239','56778','13346','67369',
                          '63470','66633','92690','45031')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


