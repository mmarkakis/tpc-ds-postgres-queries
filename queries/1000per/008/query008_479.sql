
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '42087','94898','62920','78866','62454','29418',
                          '96052','77031','82340','67890','39317',
                          '30402','41706','32531','33781','39932',
                          '10251','20980','18027','77335','46850',
                          '96505','47649','33721','19354','66673',
                          '29461','70870','86220','51163','56580',
                          '14281','13778','78919','14234','11101',
                          '91571','58021','46380','63589','21901',
                          '22128','18949','58017','62531','34611',
                          '42881','94000','55959','39864','27471',
                          '88596','68409','26277','50602','16282',
                          '34358','80902','94512','43295','23766',
                          '29347','20760','76676','16439','46719',
                          '57192','93825','85113','72392','90623',
                          '44281','73690','57510','96749','56943',
                          '12129','82888','94481','33926','49588',
                          '74965','46092','71925','61643','98779',
                          '46077','61567','81447','82571','69286',
                          '78664','47557','98441','94798','56258',
                          '35805','80320','60781','69476','23138',
                          '49245','47884','19319','39528','33841',
                          '52769','19382','26885','15219','83326',
                          '83380','30167','16613','31153','76846',
                          '35044','31795','53109','60048','98600',
                          '67940','63043','30778','28928','13050',
                          '29023','18962','47975','80611','51910',
                          '44477','64118','79564','53207','15071',
                          '55416','70227','22441','54884','87774',
                          '17649','58636','73926','25824','88758',
                          '58883','10115','39940','68043','22803',
                          '72303','36869','29330','83346','84330',
                          '80622','38251','77711','29039','21193',
                          '17397','21170','61341','69542','11901',
                          '33726','63916','48112','46197','65833',
                          '98446','14605','37545','55025','92163',
                          '82904','92331','93485','21093','63136',
                          '16152','99972','10815','33628','45082',
                          '87380','23140','75108','78303','62432',
                          '55516','20163','91497','32230','25060',
                          '11100','53108','65541','10646','90494',
                          '34852','98134','34336','88491','60268',
                          '87336','41937','64789','79163','25421',
                          '28944','95058','34307','93376','38993',
                          '41677','99817','92003','92687','41760',
                          '86934','68928','86746','12816','20757',
                          '32133','45176','83023','71210','82384',
                          '14929','52960','90538','23635','51253',
                          '50913','52895','44851','64976','97589',
                          '31044','96702','13705','63420','17103',
                          '90101','26371','91095','58489','65134',
                          '90785','40459','84841','69026','56134',
                          '49486','95423','97503','67664','80748',
                          '75245','39754','36915','26557','30119',
                          '42972','31647','29968','20612','63456',
                          '66026','20680','90761','64553','20580',
                          '67132','96054','75826','92162','83513',
                          '48394','71085','96769','18125','84806',
                          '90684','76611','25893','13912','34233',
                          '73444','77298','45496','95519','99253',
                          '17780','29355','78484','49410','46248',
                          '84808','33644','10937','67468','19271',
                          '89639','44626','89169','14926','39370',
                          '66322','40139','44875','60316','90108',
                          '14848','20479','87896','84734','43394',
                          '73627','54975','50552','71776','16145',
                          '89048','88680','11541','22246','92955',
                          '20408','12663','39497','25960','11324',
                          '16135','23624','52159','94568','23980',
                          '83280','74905','54433','38676','85751',
                          '46044','51988','93037','22638','55288',
                          '46228','38257','46902','35851','76097',
                          '74665','75115','97552','35821','38260',
                          '56894','76265','14184','34796','66740',
                          '66898','39018','25660','62345','18757',
                          '58200','26390','20546','84383','65442',
                          '27427','83188','97564','48357','12611',
                          '43091','90132','80497','22870','49269',
                          '72803','10870','46246','18434','74763',
                          '45416','33702','37934','38771','46580',
                          '90373','97884','25840','62579')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


