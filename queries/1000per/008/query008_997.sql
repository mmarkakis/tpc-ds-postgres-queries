
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '72579','35536','38914','46494','95334','78005',
                          '88784','71893','14452','95257','63805',
                          '77081','22934','91757','89116','33260',
                          '72502','71886','73830','68683','79571',
                          '21338','73857','87850','61655','17324',
                          '89111','47651','57579','43780','89006',
                          '28565','23237','49452','30808','57975',
                          '53981','56273','40287','42668','23167',
                          '44590','88051','31130','61424','86222',
                          '79800','20751','49458','93860','10253',
                          '33918','45392','80169','77518','87942',
                          '56782','44719','45584','12037','82554',
                          '11465','38686','61637','87285','94319',
                          '77128','37942','96299','20433','18661',
                          '19000','57953','71789','12827','80439',
                          '36935','53904','50326','75701','83605',
                          '82101','17093','13134','20724','48211',
                          '80430','41743','85904','43447','70122',
                          '88422','81800','30391','72369','60962',
                          '45087','84999','37152','52987','85389',
                          '77013','58761','58627','51046','52989',
                          '68577','68916','45394','70883','38893',
                          '76150','48630','72179','84744','14366',
                          '60669','22890','82893','70566','32271',
                          '49571','61183','73207','94402','66241',
                          '73964','92926','10172','71179','64629',
                          '39307','41035','42188','96503','91753',
                          '57917','70155','11319','13171','24715',
                          '82154','93149','50104','19991','30856',
                          '29159','32268','24843','15921','31004',
                          '68970','27017','17714','90393','89464',
                          '70479','54770','60596','34131','23391',
                          '89624','49297','56206','36808','82600',
                          '74891','47027','62088','24405','20208',
                          '93714','79604','84541','38988','48080',
                          '37492','62198','82225','50535','65108',
                          '43338','79731','35213','57697','21755',
                          '49071','68004','64260','11860','23296',
                          '88985','99133','69169','59019','51037',
                          '91715','84876','20551','54771','91280',
                          '14393','66941','98120','37385','43312',
                          '51469','44086','34100','50443','27284',
                          '48731','98830','87486','89176','32246',
                          '68339','94419','91612','12771','13128',
                          '30842','91394','69498','51374','95833',
                          '39426','80807','12780','92890','66823',
                          '10940','86376','51552','81575','33740',
                          '97765','67531','67204','26593','63466',
                          '68982','44895','48667','92194','47249',
                          '31463','61067','89704','80436','76600',
                          '49689','64646','78434','78962','58126',
                          '25071','81453','84559','19859','58933',
                          '46529','12437','13365','41808','67720',
                          '43024','25165','20584','84401','28071',
                          '28693','27150','42918','85733','78282',
                          '44335','61814','30014','98083','79483',
                          '83660','49211','71476','77790','12944',
                          '74954','69680','72674','49316','87865',
                          '87513','27136','69641','65899','91268',
                          '12672','22842','72096','63338','38438',
                          '34895','71694','60365','39122','71479',
                          '75795','64148','71432','98102','90086',
                          '40607','85033','88948','12255','23725',
                          '66467','95117','41544','23668','63727',
                          '39093','97713','40294','13543','44412',
                          '38505','69540','82623','21269','32197',
                          '67721','20723','28447','72214','27156',
                          '36987','36503','45998','81495','50296',
                          '15206','67452','26843','22058','93314',
                          '86506','72454','20555','41141','82905',
                          '53887','68555','38654','10067','67812',
                          '90122','62967','86784','12102','16795',
                          '17497','59888','10581','50775','28194',
                          '49627','43052','38940','98705','74539',
                          '68410','77775','52582','91030','43619',
                          '19017','18607','18008','25910','96307',
                          '43493','32008','74554','54237','22357',
                          '67842','57702','53609','13638','93131',
                          '85572','24872','92577','82074','63112',
                          '65367','27308','89327','88359')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


