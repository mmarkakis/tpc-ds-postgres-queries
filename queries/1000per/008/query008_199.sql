
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '30558','79310','56196','87960','20096','20775',
                          '77782','30725','60566','46686','42914',
                          '12953','36293','44275','18553','65180',
                          '88441','44645','18085','73552','44651',
                          '89916','79617','57473','40477','42363',
                          '37678','27995','24928','25205','62352',
                          '27737','36064','84466','41165','21339',
                          '43990','61798','79038','41860','70554',
                          '74135','64517','67462','92871','76143',
                          '33999','65986','41559','98253','19719',
                          '78018','48689','76341','17748','22128',
                          '18368','28933','52800','69988','85216',
                          '93571','94598','43876','79032','13064',
                          '84402','24747','25451','55698','66228',
                          '60820','17028','59239','16387','76429',
                          '30940','99705','68483','93066','28162',
                          '66190','80587','98177','51701','44621',
                          '62456','54387','75000','85901','30213',
                          '26994','99360','97623','85692','86571',
                          '45167','96388','13096','60406','24813',
                          '50393','15853','55210','58386','80272',
                          '60935','75477','38809','97890','36963',
                          '69758','96203','54393','28252','15371',
                          '65491','21781','14075','19852','81388',
                          '70675','44500','80341','47466','12439',
                          '67664','26927','49405','53499','80893',
                          '65721','95013','50765','20334','31572',
                          '86418','47917','84851','18245','11592',
                          '72160','87821','13118','76068','31657',
                          '37018','44267','32843','10544','66526',
                          '85045','33421','10004','31886','15038',
                          '69212','23472','53339','82115','41646',
                          '23404','18041','64298','19312','93870',
                          '50322','17670','69087','44316','89470',
                          '46362','56084','37800','32332','13345',
                          '51160','72343','76205','91364','47295',
                          '17622','67415','66542','98208','48969',
                          '50170','70676','60653','77519','73044',
                          '84305','36841','53926','28040','43062',
                          '14734','61487','68094','19040','12331',
                          '67217','26847','76323','90935','53047',
                          '54269','74580','30507','69096','34335',
                          '37035','43130','58263','61747','57832',
                          '21715','20231','16890','73977','73824',
                          '57880','75614','24367','85284','42256',
                          '96789','95953','19989','72993','85164',
                          '73536','41990','39233','22511','25677',
                          '56589','25109','59522','14548','51457',
                          '44495','12325','26297','58371','82603',
                          '26484','67728','59026','26169','54265',
                          '60391','78083','47970','61911','22436',
                          '32236','42576','97462','75620','42865',
                          '67522','61170','12900','14700','18984',
                          '45813','53936','56268','70485','78841',
                          '27335','91885','94391','15792','47839',
                          '35366','88616','55405','88802','44489',
                          '64831','79548','31669','21019','83879',
                          '44641','59245','72521','36761','78915',
                          '33621','83044','29086','31079','90257',
                          '40691','87709','22536','36602','27008',
                          '38955','74753','46752','26417','75528',
                          '25638','68238','68786','69336','73279',
                          '69718','73207','33613','29165','24552',
                          '78757','39360','46279','32593','17664',
                          '63820','23467','12670','38566','65861',
                          '96717','86742','87777','64079','23844',
                          '39738','57079','11906','56346','37649',
                          '29150','24683','94420','72333','59107',
                          '28115','72279','61366','29876','68939',
                          '79985','98427','35564','98644','14268',
                          '48454','45023','47877','53123','56552',
                          '94197','82159','34322','43126','59498',
                          '16756','31790','32881','44235','75618',
                          '64286','54308','52493','81447','64647',
                          '33350','26849','61381','70520','48237',
                          '34987','16587','29773','37976','25186',
                          '56455','41326','15807','91532','59055',
                          '72105','38856','34731','37607','59978',
                          '66987','75243','61636','29832','44216',
                          '21452','68886','25143','12660')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


