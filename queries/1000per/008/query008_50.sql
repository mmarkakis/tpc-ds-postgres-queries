
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '19421','35309','97749','37140','96525','24864',
                          '89299','93704','67435','68311','92595',
                          '22374','11443','74103','38543','21334',
                          '11330','12594','49784','56619','78787',
                          '89495','54705','76090','63751','59716',
                          '17946','46920','80107','12562','78144',
                          '18325','19914','96444','23052','61692',
                          '58256','47353','56029','96188','90497',
                          '45963','13890','15574','70504','40105',
                          '65633','38990','37641','90539','89837',
                          '20853','39075','59688','98043','23994',
                          '73476','83310','21114','38314','99908',
                          '20143','69134','84505','71871','98656',
                          '41163','21641','11104','35489','72962',
                          '60605','97955','78772','44679','37019',
                          '78374','70268','31221','21606','89647',
                          '95180','65569','73539','63475','80482',
                          '89474','51194','61293','68051','86670',
                          '37646','45352','48036','95465','27490',
                          '98137','69475','74102','31928','64392',
                          '19031','97333','13264','20527','58292',
                          '76834','88339','88272','30968','30489',
                          '60734','46663','86872','97986','50118',
                          '86181','29081','45062','56532','99090',
                          '81974','21172','58440','31885','62333',
                          '58747','66635','34742','92383','76026',
                          '55832','53356','23362','45794','30426',
                          '67449','11407','74653','16571','40621',
                          '59776','36509','84029','88229','10123',
                          '98689','79912','22638','92818','74435',
                          '72557','24130','80733','98975','86513',
                          '63209','58366','22894','57256','82126',
                          '63155','10596','54133','46856','11343',
                          '96197','82425','84057','89728','60750',
                          '86553','52195','27945','49027','33785',
                          '21662','97448','20866','46295','88199',
                          '73081','89464','99120','68287','79354',
                          '84613','62081','40447','74066','94740',
                          '45718','87952','10638','14260','49532',
                          '20692','82612','22196','94099','22310',
                          '67068','69938','61500','92243','98776',
                          '46701','69398','91403','30890','81502',
                          '68613','54501','19247','73094','52103',
                          '16467','59772','11141','72577','78682',
                          '14028','50302','58533','36957','51574',
                          '55303','47989','75889','21489','12783',
                          '67656','18344','36034','39671','25902',
                          '43377','30139','68915','73932','14860',
                          '23755','22470','47846','45516','63932',
                          '45012','21670','97583','15563','90058',
                          '16882','37286','39538','53282','24967',
                          '38387','87342','72866','84777','75938',
                          '82516','69660','29105','29449','17683',
                          '30232','83638','36142','34925','42048',
                          '60222','33067','43299','47315','52495',
                          '33659','67927','68238','19875','85608',
                          '47494','11754','77427','31241','90511',
                          '50479','58454','62335','23658','57184',
                          '80104','35141','26976','49211','45330',
                          '87521','24894','15735','51629','98246',
                          '59645','50809','29445','41506','12138',
                          '18674','45171','50555','92915','11502',
                          '10852','89525','99733','65495','22512',
                          '34326','52809','64056','14501','46065',
                          '72057','17357','28661','11214','21397',
                          '37653','65757','93831','48584','17447',
                          '24348','33542','91574','45546','72268',
                          '59034','26861','18205','81803','59123',
                          '44902','96921','94617','37291','38980',
                          '63699','78129','65255','57667','79749',
                          '95494','75391','53758','19038','99045',
                          '58263','89776','85358','42302','57000',
                          '82327','50633','64996','45568','99365',
                          '56473','70835','47813','92113','56684',
                          '17416','81640','54445','71615','72779',
                          '63975','51293','58083','97838','48206',
                          '71442','78516','87869','94504','30828',
                          '50569','27623','30860','84560','89175',
                          '24034','11099','71038','93452','86544',
                          '42231','62400','41184','98839')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


