
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '69215','37399','41513','85436','12209','69475',
                          '74192','91382','51732','83484','84745',
                          '59269','31913','32033','67613','34409',
                          '88879','51574','35121','57162','24822',
                          '33341','24595','97793','25620','15748',
                          '26602','21704','30203','50709','44989',
                          '77404','27132','65477','19789','64284',
                          '38761','81973','45285','83011','32475',
                          '80172','96020','79419','36092','91039',
                          '31575','32004','33133','87385','30775',
                          '97046','13527','86630','60107','54608',
                          '33081','64309','43119','72152','74878',
                          '56910','27420','47964','13318','93969',
                          '43314','93870','95175','31500','58254',
                          '85232','26136','21845','20420','34737',
                          '52098','83092','58215','74392','15092',
                          '28019','65436','72094','13480','44196',
                          '76027','98258','62185','91217','42492',
                          '21215','58362','30757','89953','45004',
                          '72681','78045','32070','68060','55273',
                          '95675','79352','33642','33096','54869',
                          '44177','51530','45009','65264','38525',
                          '17842','43118','70850','15293','50619',
                          '17743','25615','20828','16361','47404',
                          '32485','46735','33662','43393','96975',
                          '83959','59958','40471','93377','33786',
                          '48374','35263','25824','13598','93588',
                          '53102','42722','63655','28865','35576',
                          '98680','49674','56681','28344','23650',
                          '13750','87578','95728','19597','94669',
                          '44598','40775','42276','87424','83001',
                          '87143','76526','39730','33066','50776',
                          '41957','67604','36459','98992','50108',
                          '60019','73849','86784','21208','68773',
                          '59197','38354','35581','65427','63310',
                          '63062','73205','63381','10437','59506',
                          '89283','33128','14026','67312','14593',
                          '70711','70655','26129','48007','39843',
                          '54501','89833','73450','94540','89417',
                          '15346','73359','58992','55097','40160',
                          '24567','11284','21620','13199','62756',
                          '41121','40589','32500','44846','93614',
                          '17136','58784','55981','30549','42188',
                          '83942','33345','81387','75227','91121',
                          '43727','40034','59190','19834','43158',
                          '34221','44421','84133','17781','41078',
                          '38047','70018','83112','32830','12557',
                          '70856','11447','66130','31304','19438',
                          '40561','19209','21097','51869','75391',
                          '80791','83533','73177','80862','95502',
                          '67921','88223','10093','60020','96812',
                          '58422','10954','82531','88953','12687',
                          '12882','53637','87051','53085','40816',
                          '56842','71114','75572','51503','18844',
                          '76835','87226','84012','15256','18352',
                          '66305','28427','38183','64477','43023',
                          '22484','96758','40294','11847','29634',
                          '74826','65552','16416','77475','90225',
                          '33760','79485','41102','18029','26208',
                          '70964','39161','83090','72997','98005',
                          '64295','52461','59956','91666','78454',
                          '38946','16617','75447','85431','58977',
                          '23229','93656','28737','78922','50391',
                          '53231','89184','10319','37785','48971',
                          '77974','59374','90024','12345','76721',
                          '77778','76532','84743','36873','97711',
                          '82619','96731','57673','28866','30098',
                          '32685','24453','79636','45901','31193',
                          '36711','70184','50750','68219','27872',
                          '57321','72645','78938','56868','81383',
                          '21864','89339','32119','70830','15009',
                          '75403','66942','29160','24305','48022',
                          '72145','51110','54496','73182','35714',
                          '11813','41550','74579','24142','34502',
                          '86792','75502','96563','12417','72544',
                          '11210','66921','39296','79718','60700',
                          '72343','58033','56980','16856','90465',
                          '29672','73029','27969','94218','44052',
                          '16119','23848','94741','41407','62134',
                          '59722','71059','11642','25088')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


