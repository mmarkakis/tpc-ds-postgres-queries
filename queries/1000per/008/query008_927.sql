
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '21386','71773','88519','54043','33394','66764',
                          '87681','24515','76670','61953','67530',
                          '64302','80871','31029','43429','47351',
                          '11725','69133','72699','73938','19267',
                          '36794','14515','62032','60670','99588',
                          '58487','94688','69349','76355','64936',
                          '33993','39924','95131','99845','46197',
                          '41646','63833','68068','75376','13796',
                          '81653','55819','55284','70803','61109',
                          '70128','77130','56441','13226','54501',
                          '39163','72259','63528','87857','87312',
                          '79687','37068','67883','37536','52054',
                          '34382','12799','19312','61540','98573',
                          '69343','44941','60709','34949','36798',
                          '50789','60289','99568','27418','94562',
                          '54908','48515','48785','87731','73826',
                          '40864','77255','12398','25796','10188',
                          '17625','30089','22055','13408','46313',
                          '79739','27607','28315','22362','76340',
                          '11989','30988','23001','34534','44017',
                          '88553','81381','99483','79807','85160',
                          '90465','66312','13054','79791','34106',
                          '35476','49732','70098','24960','12827',
                          '79569','23816','89698','69554','63518',
                          '38351','37215','62772','25242','21744',
                          '60011','75381','24983','13729','40361',
                          '41932','97791','13348','24219','56788',
                          '92254','84547','25548','14061','77613',
                          '57065','25321','40117','31751','40188',
                          '20367','17153','13901','45091','46454',
                          '42888','81598','79579','23865','14047',
                          '55353','41466','63231','59577','72800',
                          '86573','66326','63087','76422','19488',
                          '38686','35854','50032','62565','85861',
                          '10121','32120','28365','22450','54845',
                          '19205','76622','26110','16578','24737',
                          '21854','80154','42361','70796','88008',
                          '13772','16911','14434','67608','56010',
                          '36120','65053','60953','75666','99323',
                          '16897','53306','42334','39031','59640',
                          '54566','41815','69191','25994','65848',
                          '72421','68346','80568','32164','55968',
                          '80390','35253','25228','29206','78765',
                          '56394','56293','62670','34913','89411',
                          '39680','16028','46854','10620','84159',
                          '91483','55586','30693','65456','41130',
                          '22726','14824','25370','12047','43186',
                          '92602','53385','99536','66358','81437',
                          '10839','94609','36237','22037','39867',
                          '72821','24840','12582','11125','54489',
                          '14502','25804','25893','66469','48155',
                          '98079','11269','20770','29173','80576',
                          '22270','43637','89861','60808','26053',
                          '10284','35876','70512','74999','50312',
                          '38381','64938','19342','87999','11241',
                          '60042','50658','85442','45908','46193',
                          '57817','80360','62297','70110','34112',
                          '20113','41719','59710','54140','80050',
                          '27697','61538','94279','80714','10875',
                          '66359','77469','18032','44153','21280',
                          '88531','32525','23693','83005','19337',
                          '72562','23915','62573','57846','65109',
                          '76016','42251','11798','79360','40687',
                          '67136','43514','55418','85693','10445',
                          '29604','57041','13165','23270','33261',
                          '84139','58922','74312','30869','41510',
                          '51249','39993','31277','18555','14636',
                          '39050','19880','17552','19634','49320',
                          '74000','77726','59543','90446','73233',
                          '25061','11478','78352','80624','91705',
                          '48926','24207','72435','88049','31759',
                          '38952','72605','17107','36971','18457',
                          '83331','78609','28570','24322','33985',
                          '39851','71999','85251','63486','70447',
                          '39524','42280','54163','96626','85419',
                          '63690','40807','44911','20702','47992',
                          '77957','73355','36805','22013','21258',
                          '48599','46627','31194','69178','61304',
                          '19663','28998','28751','50436','33246',
                          '74855','45906','56956','32241')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


