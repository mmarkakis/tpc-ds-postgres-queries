
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '49720','22582','30102','41670','96869','38101',
                          '72885','79663','18582','37918','23063',
                          '79857','26712','90877','21552','22141',
                          '83644','50557','80673','76394','40687',
                          '53064','14905','54791','55121','14531',
                          '63649','66725','42433','60299','57063',
                          '21055','63307','47413','27956','40062',
                          '15508','59044','62628','93065','78831',
                          '78467','50419','93957','58468','52164',
                          '47929','47357','95078','89665','48942',
                          '96754','85725','84832','52797','74411',
                          '12714','53252','74104','21463','60030',
                          '93055','36564','76368','26443','29302',
                          '50518','64883','41260','71233','90996',
                          '26793','61817','93797','97942','90692',
                          '78843','79873','12313','45801','71520',
                          '61026','68222','56137','65685','97809',
                          '67681','68439','86622','83120','87464',
                          '88531','65279','27575','80602','45181',
                          '60495','66538','99308','32498','69664',
                          '48629','83820','69015','20232','36806',
                          '28427','72421','34427','15381','78076',
                          '38921','64025','95276','20774','24010',
                          '39568','54853','84827','66055','50299',
                          '89917','12753','94307','72908','47454',
                          '90013','26778','27923','79918','56471',
                          '87252','94199','26923','80603','84976',
                          '34308','92489','59291','89020','41618',
                          '48930','89874','79307','75052','66782',
                          '83487','27510','84643','15040','36066',
                          '78458','61523','94407','46173','98197',
                          '99287','65602','64505','91966','11878',
                          '69503','84794','95475','36411','43919',
                          '80460','63614','80497','90158','33176',
                          '59516','76028','23909','94295','91665',
                          '11903','17410','77955','33880','76733',
                          '68058','35676','99340','16087','54699',
                          '27599','38584','95407','38630','85418',
                          '25554','63325','19159','72954','97375',
                          '78361','92274','30064','27884','65291',
                          '79117','82917','52735','61269','97424',
                          '93729','74304','15531','30382','14838',
                          '35560','80835','53674','99357','15106',
                          '40347','21572','76239','86162','68496',
                          '87820','25032','54452','23004','95130',
                          '39025','25661','57675','24626','28727',
                          '39149','81892','76232','42742','62477',
                          '37063','46052','46096','88668','28697',
                          '17539','31173','83438','65116','20891',
                          '43681','83783','88542','37494','45831',
                          '48238','16310','51641','84146','55899',
                          '68372','27752','13659','82609','74639',
                          '64119','24401','98159','45162','24416',
                          '59714','26288','56991','50693','58446',
                          '99981','90647','55000','75624','66594',
                          '66507','34163','94840','99051','42268',
                          '98034','38207','95503','13107','37044',
                          '11246','72595','72863','76720','50886',
                          '90869','27153','91066','98081','91586',
                          '68869','60780','39312','29487','50145',
                          '13615','57281','12200','65650','48258',
                          '24170','59507','46463','61841','28082',
                          '12663','67932','93859','23649','98008',
                          '60487','17296','14198','90078','45596',
                          '65000','76428','68146','29604','32644',
                          '75724','32709','77781','85467','42405',
                          '68676','21082','19924','65827','70768',
                          '93393','93379','72799','56751','56359',
                          '41042','73020','32113','59881','15395',
                          '81341','28849','56937','48320','68144',
                          '68114','50160','31744','19858','18957',
                          '59067','71401','17350','42240','69204',
                          '93692','63748','12944','43444','57013',
                          '26612','41726','38633','51901','36737',
                          '11667','79033','90480','40706','84965',
                          '90910','13852','89199','49440','76997',
                          '27504','45231','39256','89833','95565',
                          '93404','65875','14754','29549','43655',
                          '11048','77429','52011','48937','14640',
                          '89275','13138','83550','45331')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


