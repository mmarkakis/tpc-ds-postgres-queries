
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '69418','45024','82955','80114','17620','15788',
                          '80005','25677','14038','55003','32132',
                          '45594','51176','54109','64539','88809',
                          '18773','41633','79550','88496','43819',
                          '57694','29420','38562','31205','15663',
                          '82281','24766','87366','43198','72132',
                          '62550','57728','58919','89472','15134',
                          '19053','91471','16001','99970','89006',
                          '48830','75325','49314','32385','45388',
                          '11865','40161','23242','38487','30707',
                          '67376','77579','66581','81596','78129',
                          '35642','48969','99595','72119','59236',
                          '93420','26480','87275','23772','23141',
                          '99066','65955','70912','39464','93673',
                          '96558','31213','56287','70040','14956',
                          '53805','87610','12133','74306','68097',
                          '51598','21845','22734','38198','66852',
                          '47703','39059','36249','66385','86340',
                          '93406','52744','21670','84021','16441',
                          '92818','95693','54460','86832','43051',
                          '91384','21100','85930','89710','26248',
                          '37705','35027','53493','86012','59310',
                          '48771','16667','93747','81172','36577',
                          '19286','28441','39388','20400','84383',
                          '28573','51781','51396','31613','26142',
                          '47773','89261','88438','45583','51919',
                          '56010','11964','40778','52819','38885',
                          '74875','23725','83231','74139','74296',
                          '43347','17668','17891','62247','80300',
                          '86353','85712','22698','81395','78612',
                          '79562','24235','58993','91779','25105',
                          '74567','65436','49253','65733','60420',
                          '15487','35658','20728','13936','47199',
                          '18432','30560','74977','72116','31029',
                          '46524','71147','57162','58439','97669',
                          '68029','17465','28424','95687','84339',
                          '19499','59250','14005','17926','18066',
                          '86615','33510','62860','95383','88117',
                          '41517','30165','40658','84655','79502',
                          '89692','31226','64427','90571','15610',
                          '97885','33722','18313','85487','72392',
                          '87592','15481','50770','70051','33522',
                          '67399','96220','52695','80311','32802',
                          '79117','99993','71643','31151','86325',
                          '17230','51371','80141','74946','62982',
                          '38296','48332','73553','34398','19822',
                          '75308','76990','24535','93216','33766',
                          '46608','42452','72371','99313','23301',
                          '17085','86909','13611','31799','15590',
                          '12446','41912','32580','91916','28551',
                          '96018','44276','77844','60707','54144',
                          '76408','37356','70739','26973','83484',
                          '11374','27176','58108','88353','79594',
                          '68841','86221','80849','24715','12477',
                          '99403','56780','43680','50188','99379',
                          '87101','94390','57665','45442','39728',
                          '11649','16336','39241','92269','20932',
                          '37403','42100','17245','27682','98266',
                          '50128','37089','91312','15779','53055',
                          '27406','69189','91527','77134','83700',
                          '86816','32037','93397','99321','75172',
                          '75599','76354','30085','57795','28494',
                          '57912','64903','94047','55270','83317',
                          '90218','36740','80348','17753','83353',
                          '25889','44138','12045','31223','52122',
                          '24700','32552','74692','19494','54615',
                          '67532','44341','41987','31586','50984',
                          '46497','42106','38630','89969','60231',
                          '84671','99901','73717','16905','51326',
                          '82729','75655','75837','26787','82197',
                          '24934','44091','48821','90515','16167',
                          '23864','27812','54764','37516','37721',
                          '13203','77712','60189','98456','91210',
                          '21754','57921','51134','14483','89441',
                          '93724','44595','72594','86945','89763',
                          '57266','24959','14044','68255','32983',
                          '79551','19874','67594','49898','14718',
                          '60340','82345','49290','20977','72261',
                          '55261','99714','63303','69238','37519',
                          '38714','26995','79052','62012')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


