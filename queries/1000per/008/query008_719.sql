
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '83271','55213','81988','31458','54946','34367',
                          '16156','53907','67230','19402','15308',
                          '18216','86209','23304','12567','75210',
                          '42562','33849','89030','52562','43082',
                          '46316','67775','92015','92363','68815',
                          '75471','38648','94234','43258','37978',
                          '41173','97646','79126','15669','91701',
                          '49426','58229','39112','94472','68032',
                          '51941','93920','28417','55903','56851',
                          '44453','40521','35008','62470','98711',
                          '28313','80881','89092','78787','46349',
                          '89507','40653','49673','45681','66959',
                          '24452','82703','66879','12630','20969',
                          '89644','26809','13451','71218','54419',
                          '43148','19541','65452','86231','20605',
                          '88777','24630','68337','31511','60605',
                          '37665','41175','99828','68212','96061',
                          '42073','96772','98349','35981','19077',
                          '36048','50875','30150','39829','40444',
                          '73154','43268','22266','31863','63595',
                          '97170','91922','92743','11739','80235',
                          '15924','36560','36962','52241','43254',
                          '45295','93649','99793','54541','15844',
                          '44784','97266','83859','74473','79582',
                          '27626','97488','47992','45714','10207',
                          '49724','60647','98160','84981','63535',
                          '22750','70770','12300','75911','48606',
                          '45577','58231','55662','23326','91633',
                          '72565','86195','86822','64870','55914',
                          '43918','30263','23794','60073','91232',
                          '78453','69228','90655','82840','32375',
                          '17387','79020','76460','82855','24010',
                          '46663','60236','52929','96118','55259',
                          '34968','39610','85009','91100','12507',
                          '18350','18718','90423','81298','32462',
                          '29956','86719','72489','74877','73083',
                          '56221','83375','20433','14624','79864',
                          '25417','47989','52706','20438','25619',
                          '22522','93546','29923','88025','90435',
                          '23966','15144','50729','13080','74612',
                          '85731','78216','99246','83582','48951',
                          '68627','35301','60552','46307','20197',
                          '72599','61556','89340','90521','72694',
                          '55896','64309','42195','86972','86470',
                          '14832','39063','98399','11915','37317',
                          '95147','23923','37141','78431','48356',
                          '46685','12801','19699','60290','42409',
                          '90563','76813','76481','47285','11743',
                          '69703','89421','82714','89250','50552',
                          '58728','63579','33801','69889','53989',
                          '84508','26710','28911','37217','99967',
                          '24323','45825','40222','11446','63245',
                          '14121','22234','33586','19687','86795',
                          '89094','73846','97691','26970','67322',
                          '26769','85869','78952','31572','78951',
                          '87296','23165','95960','13513','86550',
                          '10278','49084','14407','21233','38253',
                          '49991','36735','91033','65730','33855',
                          '75912','98624','33245','79304','97175',
                          '58413','59106','64706','94732','45598',
                          '56992','10706','85563','17328','47361',
                          '91585','86734','18016','85959','32945',
                          '61923','67460','87146','47689','80243',
                          '49858','20100','67558','44804','28019',
                          '58845','36679','81342','62482','28043',
                          '63841','20823','36141','58142','70194',
                          '77014','24582','43248','99737','74848',
                          '16876','31982','15515','72734','54009',
                          '58896','18426','53727','57602','10583',
                          '96551','93204','10458','87103','43034',
                          '46735','14067','22749','92192','92845',
                          '12849','43122','74746','80868','72566',
                          '81861','65074','77544','11153','10650',
                          '82830','42940','96503','18535','14139',
                          '38614','79959','91794','51387','51255',
                          '17730','38937','47311','77180','46710',
                          '66626','17164','37540','84582','24682',
                          '19753','22194','55155','83574','28661',
                          '18259','78139','29620','40223','85379',
                          '59065','51687','68529','73191')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


