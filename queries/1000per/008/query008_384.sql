
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '94303','30798','40817','26352','67694','43158',
                          '40568','28127','23848','14734','98956',
                          '87934','59254','14938','87267','37874',
                          '27605','97739','19410','58504','23778',
                          '37236','30158','60058','37057','30704',
                          '89764','41744','63224','37455','90485',
                          '20895','30674','57524','71435','66086',
                          '38424','27567','13389','23123','25483',
                          '16489','58579','24560','39514','45277',
                          '78832','52096','60642','83245','54005',
                          '77450','41619','90861','11787','15098',
                          '81862','71177','81775','11277','26818',
                          '41279','55220','80706','53488','45353',
                          '11257','74733','16228','36078','52298',
                          '44993','11654','81994','87661','34548',
                          '38561','96589','49497','72341','27645',
                          '65783','42897','18438','84414','51347',
                          '29333','65322','40846','84112','60220',
                          '54184','32719','98271','27028','53884',
                          '54192','60972','79958','66357','50556',
                          '89627','90151','49120','96893','62578',
                          '45175','86368','86032','19713','95587',
                          '94120','55278','84299','66242','51057',
                          '20455','87140','97630','75115','80712',
                          '21721','24161','39020','57722','85338',
                          '20417','65733','77148','97662','33115',
                          '89567','44530','23328','68749','80999',
                          '99978','85685','96335','85531','72732',
                          '34708','76151','45709','61097','92448',
                          '13172','38763','54349','69784','20812',
                          '51476','58551','66371','31019','39075',
                          '83677','17594','82854','33650','30671',
                          '49318','21120','61857','66320','95640',
                          '22557','53946','88204','49817','52902',
                          '26925','22311','99500','85871','30828',
                          '80202','29566','73662','64039','57604',
                          '52333','20071','13559','68033','95124',
                          '28865','40504','88450','83520','30000',
                          '61483','32472','37882','71014','61467',
                          '38492','36341','25278','56612','17481',
                          '21834','15536','43434','42391','86108',
                          '84636','36232','55558','74159','89283',
                          '14623','94985','18498','47404','35672',
                          '30858','19176','34340','66862','61893',
                          '30891','44283','80980','50141','77028',
                          '48168','86743','11927','13633','43623',
                          '86382','28524','38273','88217','12548',
                          '88257','84599','74295','56045','83230',
                          '59006','11323','31925','53960','51516',
                          '37658','29953','80341','56098','92669',
                          '80360','16666','85706','47821','91137',
                          '65489','10184','62763','14273','17779',
                          '21611','10586','13200','56286','17875',
                          '77116','47196','74041','89860','43915',
                          '90478','33255','86075','68739','24930',
                          '77203','75423','96202','63799','92947',
                          '62370','54790','79964','28404','16495',
                          '60846','34023','15855','14849','38862',
                          '71863','21329','83361','82747','90435',
                          '77917','66677','78804','79896','76260',
                          '90615','37431','86184','51450','25859',
                          '72729','79082','68919','81619','21097',
                          '41404','10465','72520','99182','45616',
                          '33889','30390','75204','57181','59888',
                          '92026','95274','95527','21069','78836',
                          '92195','83906','25363','24384','97385',
                          '61913','28979','61374','33007','66022',
                          '77549','38362','84164','11158','30048',
                          '98532','29072','89026','62656','79013',
                          '86571','28555','12047','21626','22235',
                          '72398','32365','25910','19641','18039',
                          '53468','94564','37144','77142','41599',
                          '48166','96037','58759','78192','65773',
                          '61904','81898','37735','46620','55137',
                          '47399','44564','56719','41377','87350',
                          '65157','92147','78544','19629','48830',
                          '99949','51652','24693','61132','42257',
                          '15607','88936','21070','30077','97250',
                          '21266','85043','99574','57996','63179',
                          '54414','83259','75169','79683')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


