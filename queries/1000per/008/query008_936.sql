
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '40639','30945','22765','17108','90282','95059',
                          '87562','43435','76514','91031','15514',
                          '40732','82262','61728','86459','34269',
                          '53183','22569','87657','84469','16408',
                          '12945','80775','41979','37009','62799',
                          '86504','59210','16377','50162','31832',
                          '40677','52539','78214','48888','41627',
                          '56525','46773','69428','97043','13626',
                          '34088','16140','67937','57090','16682',
                          '23159','65722','71812','40651','16754',
                          '32924','61979','91373','42836','99011',
                          '81145','88751','49801','76338','83322',
                          '62503','78486','70481','54429','12673',
                          '18750','99279','93748','23929','40509',
                          '32867','36125','60858','14420','45838',
                          '76391','48533','97185','86895','77957',
                          '83243','42010','95543','31539','58425',
                          '20574','94220','28970','15673','87098',
                          '84411','74057','81298','61463','64640',
                          '37024','75061','49224','29128','89580',
                          '21747','30754','93591','33237','59404',
                          '79095','79890','27218','50944','14974',
                          '68138','16541','46468','57253','41947',
                          '75864','38035','14345','34019','11007',
                          '77223','29635','40476','14384','64027',
                          '20796','83474','98387','20325','78288',
                          '71888','55034','68112','79218','96989',
                          '12640','97513','30221','13780','87417',
                          '97359','26504','12238','71727','28807',
                          '74147','12701','21920','82936','70520',
                          '77369','81243','83077','78717','23396',
                          '96197','47907','73880','51991','35279',
                          '90806','71120','33513','47966','90202',
                          '42842','81165','13601','22242','39435',
                          '88387','33547','66628','23231','37698',
                          '46019','14009','10345','29798','47488',
                          '11927','67593','96189','52424','12037',
                          '33800','36839','56274','99331','53605',
                          '44799','95218','95701','15303','38994',
                          '90127','90530','72922','88022','14454',
                          '99758','99451','54987','68341','95991',
                          '39217','45095','88392','90206','64720',
                          '16455','56940','78804','31465','88720',
                          '17912','12723','57816','32725','92329',
                          '81712','51773','11629','50093','86019',
                          '79234','17028','36427','10812','38413',
                          '87551','72004','52873','40394','52724',
                          '65745','93299','67411','85193','55844',
                          '34260','35228','81404','40309','74925',
                          '18873','48967','51682','89433','62753',
                          '34554','15327','30502','81303','21466',
                          '37150','78241','38200','12203','94154',
                          '80492','43944','83053','19518','78021',
                          '11700','57594','23293','63787','25302',
                          '73587','34212','26691','37714','96625',
                          '22102','72421','73892','53154','75845',
                          '69695','18943','96980','18705','65021',
                          '64855','13218','42022','50767','78258',
                          '96872','97911','79568','83265','63690',
                          '32098','77484','61919','60815','84485',
                          '63694','84922','22147','84934','87465',
                          '38076','29774','49485','53807','70941',
                          '26843','54951','29359','91285','85559',
                          '42460','34169','89926','41894','74358',
                          '47973','96569','31841','54853','67155',
                          '24596','47516','70535','45542','81212',
                          '36037','12334','88524','68017','61793',
                          '39427','99578','53908','48764','51741',
                          '82123','51715','15543','92681','84041',
                          '36490','21822','82478','48699','35472',
                          '47651','33083','82741','49873','93166',
                          '45414','61207','37351','25633','21713',
                          '71272','20496','77351','89243','14097',
                          '76686','37749','97271','59918','13457',
                          '81853','52593','83628','10797','43975',
                          '57992','91483','95643','92521','10072',
                          '58535','19628','82236','40757','45767',
                          '61628','94397','13162','67767','41776',
                          '52916','28706','36730','10348','72507',
                          '64869','54834','25560','44646')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


