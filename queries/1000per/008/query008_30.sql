
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '32311','19902','14821','41527','21906','11517',
                          '21300','82483','40798','77325','15898',
                          '23150','86146','96761','22918','37679',
                          '19395','21361','70180','14263','63472',
                          '56887','64565','50328','11523','83514',
                          '45068','92819','20678','89632','29051',
                          '95439','94557','44821','46249','39810',
                          '41080','95879','12239','71456','66740',
                          '43847','66580','88031','68386','39014',
                          '97799','51069','98523','46415','61830',
                          '89329','83686','89954','45044','10939',
                          '28863','81709','43496','56638','29458',
                          '10608','44011','69763','45054','64682',
                          '44198','40621','45415','29144','17639',
                          '13940','89310','48676','90989','44726',
                          '62189','58220','40657','47687','67717',
                          '40457','39271','52215','35514','25921',
                          '60116','33021','44224','33766','96750',
                          '97642','88309','40895','74717','16387',
                          '85852','99132','53266','57507','60021',
                          '31692','97111','46291','10715','49042',
                          '12519','87498','87615','39408','20165',
                          '14029','66752','49260','91802','40120',
                          '59132','38359','19872','25357','20127',
                          '79991','71048','98079','64979','82993',
                          '51749','59998','76926','27790','24856',
                          '70319','34362','32204','61050','64107',
                          '72760','89618','88517','55145','35047',
                          '16799','39407','35335','65670','17327',
                          '33892','21854','32642','55954','37512',
                          '66047','27962','29371','38310','98457',
                          '48145','43723','87864','10765','13076',
                          '27598','44469','43821','60661','15919',
                          '48839','75446','25242','91181','96342',
                          '48955','63870','98580','42351','92639',
                          '97885','47957','35481','84133','66782',
                          '94333','82140','63769','31497','66725',
                          '20412','49544','57642','94864','64424',
                          '80602','85401','29001','60807','82221',
                          '81797','62704','52601','70080','30426',
                          '14950','91742','69424','69678','34837',
                          '24993','18889','81408','25257','21246',
                          '20281','83703','59005','83655','55373',
                          '29233','16418','65460','69503','84578',
                          '33551','88371','45462','98191','52692',
                          '34057','61107','80858','95067','10758',
                          '22066','99118','66627','24046','75586',
                          '70010','81401','89055','44052','90826',
                          '79505','22417','25738','53057','77358',
                          '43378','96361','76846','47666','74216',
                          '50446','41702','15787','20384','95852',
                          '86863','30896','78432','35575','39007',
                          '62114','53144','44403','71616','82959',
                          '71865','86800','66658','73766','76935',
                          '38101','52059','36738','46319','66976',
                          '52062','22410','54016','47586','85617',
                          '52068','93160','71971','91948','95442',
                          '98908','94053','58544','13473','66261',
                          '66296','70796','71357','50512','29533',
                          '90949','25370','81142','32129','34054',
                          '59302','81558','85185','51301','67527',
                          '85412','33915','60056','10951','50568',
                          '16171','31286','48472','35630','15044',
                          '24784','69787','59954','67625','34403',
                          '65144','65695','59917','53340','94889',
                          '72864','71651','98169','74156','49616',
                          '29149','82389','48345','23928','78765',
                          '81168','93161','13532','62937','72883',
                          '36240','37541','60555','48149','83433',
                          '15275','37518','57673','29319','94155',
                          '35469','86373','80665','75132','91487',
                          '73866','93376','44275','28549','93043',
                          '26980','42955','24368','78273','13951',
                          '71070','54291','10135','76147','36384',
                          '96507','16120','76197','87573','22827',
                          '26935','11737','34845','30262','10933',
                          '19896','42023','21935','87432','75395',
                          '90297','84245','11813','16903','96997',
                          '41834','38618','38236','24601','32557',
                          '30443','19425','46096','40843')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


