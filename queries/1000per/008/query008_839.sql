
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '10292','81828','99219','35522','61061','40722',
                          '90617','93818','84987','86011','98674',
                          '79441','31914','28492','48923','22724',
                          '52872','95558','21764','79079','83575',
                          '94058','60450','12883','98179','28936',
                          '80654','37021','39484','35545','57250',
                          '81359','51768','64451','45188','26615',
                          '45739','53345','23038','30801','30124',
                          '48223','81823','30205','63476','21961',
                          '32177','90479','45573','56371','27841',
                          '61950','10296','18264','24299','41822',
                          '71635','85761','13516','78541','49522',
                          '87065','87059','79775','52513','60256',
                          '72323','28929','98127','11354','25832',
                          '72613','36178','50665','98476','38255',
                          '39834','49755','66674','92631','51610',
                          '48659','43907','12807','38440','54901',
                          '37167','49425','47182','33310','12081',
                          '57039','19105','37681','49883','31857',
                          '68857','59665','62956','82839','92527',
                          '45378','24502','93358','55107','80766',
                          '74782','51360','78372','29148','73626',
                          '68249','65824','74706','11239','28510',
                          '89439','49271','65784','27090','83755',
                          '73820','97812','68870','55735','46479',
                          '90047','67961','18864','88883','81624',
                          '19566','45143','40979','65249','12865',
                          '67523','98323','39124','83214','66824',
                          '89969','22752','84241','95657','82654',
                          '49926','82799','32017','30587','92294',
                          '57124','62770','22147','94722','79370',
                          '53143','39649','38452','98351','53399',
                          '52792','49745','13433','59829','53008',
                          '68441','89577','27747','56820','56062',
                          '91204','26933','22474','80469','13925',
                          '80429','81218','37836','81889','71345',
                          '43159','50151','64690','57723','50328',
                          '11305','56061','99862','80756','26995',
                          '17167','49213','32276','44815','10154',
                          '15715','86427','81180','14214','21517',
                          '87543','35398','84277','72189','43705',
                          '17983','89315','85539','20812','90196',
                          '34455','22181','80464','56381','64973',
                          '73163','67836','50872','10629','73752',
                          '15096','90784','33558','27771','77714',
                          '20005','54640','46790','56829','73112',
                          '27513','33801','58873','11776','98342',
                          '60362','73391','77019','35221','78536',
                          '33954','55169','12315','51625','88286',
                          '59304','64187','82475','64681','35149',
                          '17041','31161','58422','41520','95029',
                          '23382','63100','62183','71182','46882',
                          '58483','21650','59883','74060','20273',
                          '90446','41031','63362','68674','93608',
                          '68862','68260','63340','87296','25426',
                          '29422','13049','58306','40073','41330',
                          '30025','57542','31632','69906','46246',
                          '31607','90963','74876','31524','86114',
                          '20251','10209','83948','26559','46816',
                          '43974','87751','43803','99734','24838',
                          '50982','76544','70864','28001','84963',
                          '28912','84964','62977','65627','13309',
                          '85715','12336','21373','97664','11571',
                          '55960','28831','94204','69704','88275',
                          '35738','94444','47014','28198','69298',
                          '99603','67348','92353','55261','48957',
                          '73689','24888','17462','41107','67408',
                          '44609','68981','34382','99671','39602',
                          '19165','32827','12939','84688','45966',
                          '42385','99841','22907','11187','75427',
                          '28146','89834','26594','47268','43652',
                          '87377','94493','41657','92798','98420',
                          '27084','36824','66320','23194','19808',
                          '48637','78226','71639','23361','31963',
                          '18539','53688','33020','82273','10496',
                          '82668','45452','54688','12820','26808',
                          '45056','93457','54204','86755','58566',
                          '36646','63594','18622','39943','11841',
                          '70642','92108','55066','16984','77702',
                          '45486','34728','59457','69396')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


