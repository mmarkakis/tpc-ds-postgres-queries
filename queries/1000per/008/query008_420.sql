
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '39742','70897','66361','36816','57533','93191',
                          '73089','32172','95123','93827','70145',
                          '69763','68755','40290','79883','44785',
                          '76772','57526','16993','44689','89309',
                          '42254','14496','21627','69008','24131',
                          '58952','95893','40081','81979','88629',
                          '41520','68676','15261','38036','86772',
                          '20266','31866','46220','38679','11888',
                          '82992','99119','85230','73717','68849',
                          '17342','30291','78992','43787','10008',
                          '92052','73199','80328','43807','63503',
                          '35037','59258','72164','94898','51248',
                          '91581','73426','95467','21235','64913',
                          '84213','69561','44572','81918','60850',
                          '64981','77690','88528','54726','66975',
                          '19011','30183','10720','52893','97517',
                          '25564','18250','48294','47170','44060',
                          '86488','68049','63274','60884','10867',
                          '87090','95571','61946','92821','87989',
                          '74212','31453','88226','29449','51644',
                          '96937','90661','12274','68014','13132',
                          '85475','25544','13788','18289','18088',
                          '79394','19879','15547','84775','28427',
                          '73221','41053','73949','40197','92536',
                          '22711','72324','45163','56234','98970',
                          '44773','69405','56341','98786','44667',
                          '77459','48603','11715','25940','79951',
                          '33515','73225','33774','73257','71786',
                          '32605','20748','91583','21662','87840',
                          '48912','12173','14297','60040','31639',
                          '65289','37894','46162','52777','57936',
                          '37069','44235','56779','13236','11439',
                          '35078','61936','17863','30172','31572',
                          '66817','16072','15303','62917','50178',
                          '73835','17316','17980','67586','25103',
                          '90170','33547','21439','77310','84372',
                          '54728','83462','82118','20608','20940',
                          '29353','43589','38097','58934','32211',
                          '47979','66239','77273','70741','91465',
                          '30091','72044','38393','10192','90469',
                          '44515','84051','75120','15534','71136',
                          '93262','69081','43911','35190','82090',
                          '82549','47771','24615','75702','20622',
                          '10000','25987','12243','20841','83091',
                          '47501','57319','50294','16143','87560',
                          '43354','58571','65566','18564','38092',
                          '42317','33566','61877','59049','96234',
                          '80336','98604','82486','60074','68782',
                          '74223','82016','79644','69377','94034',
                          '57249','33759','45940','98016','10407',
                          '86920','82476','84957','75317','18553',
                          '37052','23342','55142','73301','96778',
                          '51250','66068','41200','30382','79773',
                          '86726','59182','29554','31775','42881',
                          '58943','57149','28855','42224','28613',
                          '59811','11008','89765','68287','27864',
                          '39371','63388','42994','32943','63364',
                          '43397','24467','31832','34087','87005',
                          '61395','32111','95999','92630','49777',
                          '62880','15558','11965','40646','12810',
                          '22384','53281','52902','71979','62111',
                          '28990','31683','27483','74830','42849',
                          '80368','92037','68946','17771','37495',
                          '49903','92129','49565','20286','58313',
                          '27135','94799','50060','58687','75448',
                          '35974','55914','54951','84694','42146',
                          '58167','10322','57726','73899','94383',
                          '25470','14066','86593','95158','16020',
                          '76530','36366','43437','41782','70075',
                          '20466','12903','31514','10281','68907',
                          '82434','80861','74302','34015','57711',
                          '11336','10129','86290','41191','53367',
                          '15238','46213','66502','30677','80322',
                          '85054','65518','51791','97126','96895',
                          '40886','85888','94659','51580','18393',
                          '36189','49500','12036','87380','48966',
                          '72819','52695','10228','45355','19974',
                          '39172','12902','14868','43355','55985',
                          '88160','25927','38121','21908','40699',
                          '20877','75394','90499','15792')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


