
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '78589','64838','90104','34846','43420','35270',
                          '45552','26735','76805','41015','18376',
                          '77276','45971','10014','23385','54277',
                          '71228','68325','66415','27602','22356',
                          '30822','74760','15101','66748','44566',
                          '20038','32101','86720','46484','21118',
                          '90806','99658','74033','98630','38721',
                          '80239','64936','57912','79757','84877',
                          '19193','22666','37248','60097','37492',
                          '72178','10484','33292','57640','82846',
                          '72495','86119','28598','68178','95377',
                          '69495','97566','99940','39544','63615',
                          '89008','72594','69489','68266','89351',
                          '32624','31915','79844','42711','52578',
                          '38756','79260','36214','30737','21556',
                          '62791','59018','17102','17889','82490',
                          '60969','48116','85806','50798','65575',
                          '30785','30012','23874','47308','57926',
                          '32848','27455','62259','21263','17609',
                          '57295','76208','54403','11462','51947',
                          '96709','85799','44541','75861','17529',
                          '45009','93852','63822','76851','69144',
                          '63807','16191','52965','84500','48747',
                          '89847','78146','63550','87406','13973',
                          '54485','59806','52191','77584','53577',
                          '43492','87355','53183','79412','92518',
                          '78108','94802','29356','86164','52526',
                          '63431','69198','77450','36608','81180',
                          '96446','46165','91047','14689','10840',
                          '60999','81689','15338','58815','47604',
                          '27225','73972','43212','61230','48765',
                          '74389','95310','98391','14625','30181',
                          '26322','49675','35208','38171','26353',
                          '54256','38336','38842','44163','69111',
                          '86330','19644','98811','48525','20880',
                          '87555','63069','15153','83461','99690',
                          '79691','25649','74651','55646','96800',
                          '55132','75432','27728','48391','75763',
                          '92332','39237','49844','89358','98222',
                          '85743','36238','43265','95858','12830',
                          '92775','55929','10686','95263','57090',
                          '41219','71922','36815','74027','77382',
                          '10559','38719','77411','45132','28946',
                          '58558','37592','64795','86503','65749',
                          '92584','61412','88238','84496','86958',
                          '58775','59600','25848','83882','76516',
                          '92838','99461','82051','96313','28666',
                          '45024','88332','22442','82942','25665',
                          '19337','95203','12468','73650','45929',
                          '46186','17046','35977','93024','94596',
                          '65234','36207','91147','87340','82363',
                          '15562','89703','23879','73563','23827',
                          '69559','58918','27153','98883','52533',
                          '43059','43595','83760','37431','62669',
                          '68294','55947','10412','39541','78088',
                          '43149','82313','81428','45333','78705',
                          '22216','95439','24156','70129','36749',
                          '10682','48061','91004','33088','14252',
                          '68979','85307','55908','57319','23070',
                          '98016','19766','39770','61884','75400',
                          '11588','28973','78727','18657','11184',
                          '76665','96639','16298','84850','31629',
                          '33760','20269','75148','11704','40822',
                          '12402','48781','14332','18489','46595',
                          '93888','74156','16034','67166','51480',
                          '44643','80104','42885','48163','10744',
                          '96183','79393','54452','32412','63245',
                          '73652','57859','90150','48935','43167',
                          '20212','19737','87069','61110','72739',
                          '34507','15121','59999','30450','70112',
                          '37698','73516','84047','94909','59721',
                          '77458','89389','68194','85354','27232',
                          '89408','31022','19689','38786','70269',
                          '76842','18466','89826','64417','15040',
                          '82984','11246','97131','82114','19216',
                          '69185','12860','92165','37073','89148',
                          '85140','77868','37364','93256','28488',
                          '27535','89516','33332','20922','56816',
                          '22500','13362','18786','83551','71223',
                          '24968','41461','17508','90907')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


