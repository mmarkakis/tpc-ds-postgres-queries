
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '57027','19651','10309','40065','97260','31610',
                          '13248','20669','46943','25537','15009',
                          '19151','62031','68263','95992','98465',
                          '53206','70811','23077','71966','98270',
                          '96266','12295','42265','29829','28043',
                          '75981','97831','10986','70207','33857',
                          '39856','77261','29621','73184','81089',
                          '13613','65270','29688','46145','63084',
                          '66331','73772','48663','30770','11572',
                          '31500','47990','47983','34248','91654',
                          '70216','54369','69298','72243','53323',
                          '22866','27277','30581','89274','82153',
                          '46570','55707','91020','73315','41054',
                          '92937','17988','56549','43483','29184',
                          '40137','84676','17776','49627','21281',
                          '64658','47458','16913','34137','48109',
                          '48726','27075','73974','26326','35143',
                          '69070','69765','89840','40797','23606',
                          '28029','81210','40020','39936','14028',
                          '14099','27600','67278','53413','12137',
                          '33630','85332','79304','62164','22404',
                          '14503','80260','12849','36583','19492',
                          '27521','83147','85786','16024','84471',
                          '65728','44331','49410','22708','40440',
                          '34463','58917','99707','17055','38810',
                          '84074','28279','52896','70540','53846',
                          '64077','38118','75827','23042','59265',
                          '10450','19038','65733','58949','70669',
                          '84397','23154','68891','25042','16057',
                          '71725','76585','35741','71741','53620',
                          '10740','70964','83693','79395','64835',
                          '20338','51532','20429','75352','22568',
                          '59756','32697','97183','49697','57015',
                          '47501','59469','25022','75447','55149',
                          '47442','27863','56487','85605','74022',
                          '10731','97023','54103','82841','31271',
                          '47570','40945','57373','86628','12803',
                          '47691','59390','35882','89453','52459',
                          '50913','61542','78969','71742','47668',
                          '28467','65722','71327','75034','17222',
                          '11132','21923','53469','39005','96814',
                          '48950','24742','39332','41792','82011',
                          '43150','75324','14629','79977','69852',
                          '70498','48927','50992','37699','85355',
                          '35752','63338','48106','72605','88578',
                          '66978','53365','51146','17922','60376',
                          '75504','41469','44279','70783','26933',
                          '10559','85415','60696','18514','14258',
                          '46634','14318','24780','53190','27289',
                          '43708','54948','56787','50613','69508',
                          '80460','18250','95951','23596','41969',
                          '85212','67505','39816','40573','86015',
                          '46638','15527','35064','27692','39638',
                          '66379','98876','33285','63016','64611',
                          '98121','84136','66980','13218','60288',
                          '64122','90077','88223','47797','42819',
                          '71401','62326','93177','72598','64506',
                          '54203','60806','50371','21382','37074',
                          '15265','35095','31023','83851','31851',
                          '46660','91949','12807','95731','61008',
                          '84924','97719','17058','56839','74930',
                          '22899','47416','30381','86690','98186',
                          '60414','11912','43682','21434','85421',
                          '13132','48281','43082','39167','43228',
                          '76808','18328','40810','49709','44643',
                          '71007','22876','77105','13915','96565',
                          '20417','93122','88919','93672','27077',
                          '69833','55235','25576','55269','65523',
                          '13376','44588','24048','95738','17453',
                          '52510','66588','30064','29811','10820',
                          '52090','19828','57598','49122','33009',
                          '94939','64285','82756','37513','33201',
                          '64569','25680','81323','50705','69908',
                          '63676','28969','99920','30953','35292',
                          '86345','24059','77684','96809','67889',
                          '45878','12047','39609','28309','59600',
                          '40299','16600','85877','32544','80026',
                          '62249','21558','77870','17612','29161',
                          '42873','65644','37427','99873','35959',
                          '81771','87836','38159','88054')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


