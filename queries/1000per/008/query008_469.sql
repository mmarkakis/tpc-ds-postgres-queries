
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '40866','65154','37531','64015','94552','52311',
                          '80993','66074','84850','38442','86619',
                          '71323','28056','13276','91647','65883',
                          '68734','90608','37875','97353','14594',
                          '64941','72805','70349','86295','96319',
                          '41074','94806','24316','42285','98782',
                          '68548','35586','88929','83652','44106',
                          '51569','71675','43391','99106','92620',
                          '71897','34566','50997','62285','30623',
                          '45870','87569','69740','55321','32507',
                          '42918','81627','26285','47241','98212',
                          '85684','40661','92499','36855','22974',
                          '25880','57572','16912','13494','20988',
                          '93357','61611','36647','60537','25090',
                          '86777','95116','94797','36489','92127',
                          '69972','25014','49483','30540','13286',
                          '98108','82534','73098','65362','53651',
                          '37578','70961','65963','45491','41831',
                          '92051','49952','57703','92407','79588',
                          '46187','97494','62034','93786','68476',
                          '22669','36563','96836','59949','34184',
                          '85174','17020','88454','14325','84974',
                          '83785','14057','54272','16805','78043',
                          '28100','14767','15967','94459','77485',
                          '64456','78664','92943','86217','16087',
                          '48606','49536','18103','82759','96751',
                          '97251','85781','23980','41205','56732',
                          '27639','96219','71253','75463','68197',
                          '84504','29421','43968','75301','65208',
                          '48727','24864','30923','31822','49328',
                          '95838','11434','31754','75125','80379',
                          '32486','46574','41061','14679','10980',
                          '78057','41389','57264','32297','57628',
                          '28268','50939','57665','12385','41327',
                          '51816','29373','14935','43691','33213',
                          '50235','16171','20154','37615','94935',
                          '48793','63396','51333','41262','38911',
                          '88480','17489','22248','95175','68187',
                          '20456','86276','27440','40427','18737',
                          '15248','68091','69388','91645','55652',
                          '66792','22777','50553','96174','73830',
                          '94227','60998','17371','71356','88616',
                          '88866','88021','21434','67204','22422',
                          '30894','99699','51402','36688','14242',
                          '57794','33047','25113','21266','95272',
                          '54898','50155','36666','88227','53756',
                          '97019','74348','13313','89618','44493',
                          '43671','36332','30624','66404','65237',
                          '46435','13381','50099','44719','58781',
                          '73141','17810','84841','48283','11498',
                          '10532','67144','99914','58500','42575',
                          '46951','52176','82213','16277','53711',
                          '62135','43793','30484','68101','98538',
                          '21315','69193','46811','57456','26081',
                          '56117','72309','57388','60232','16679',
                          '34553','28698','97310','77296','49418',
                          '65891','22080','93442','62958','75241',
                          '62269','82079','48649','80909','94887',
                          '32203','71559','17137','50082','82046',
                          '44027','92157','59246','94719','70870',
                          '19035','47954','70665','50449','81678',
                          '12239','64883','30390','91554','46786',
                          '33749','83053','21176','45880','38436',
                          '93704','58271','21718','70832','35773',
                          '38196','28422','87821','10870','82821',
                          '67701','48080','94142','11569','48884',
                          '12013','85084','51883','33037','67721',
                          '60927','80976','84017','21549','13301',
                          '11546','90091','17723','37546','84191',
                          '67122','35472','60723','38373','29642',
                          '42215','13038','49440','96387','70786',
                          '57939','20755','30440','52628','26996',
                          '81636','16511','14212','39499','68237',
                          '41029','93448','71377','99539','44825',
                          '76309','29094','23316','28003','12559',
                          '14000','57232','91646','60879','62471',
                          '20863','53830','66868','73905','22807',
                          '51234','68666','83627','41330','65908',
                          '62651','70835','67682','67104','95698',
                          '58399','72308','51245','58904')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


