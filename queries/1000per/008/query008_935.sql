
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '17386','63980','83746','48544','25006','18919',
                          '59475','88564','25962','93682','60338',
                          '54872','74064','42721','12900','55587',
                          '77308','40398','89687','94710','63989',
                          '15453','77572','37898','14049','69313',
                          '64306','57613','72852','79119','83100',
                          '46122','29653','83721','40971','26304',
                          '31994','28045','97978','55362','86266',
                          '40120','10867','35204','39158','67624',
                          '80013','30325','90464','14784','87378',
                          '27621','94133','23692','81580','83855',
                          '91177','70016','38726','98814','28489',
                          '57085','13794','31963','51287','58118',
                          '40111','32267','30833','26583','92490',
                          '64903','91550','47643','27357','99966',
                          '64389','58965','53957','43238','94370',
                          '57993','11866','42585','96287','41863',
                          '56182','83757','36652','96481','11867',
                          '74684','52324','11236','56251','13428',
                          '84409','44989','94690','51504','20854',
                          '67833','13740','63739','75624','42921',
                          '87886','35732','18891','69925','48755',
                          '70526','44817','80239','81129','61990',
                          '46109','36968','89236','47090','62762',
                          '46434','62785','67210','64098','39285',
                          '54231','83269','17127','69887','26515',
                          '75797','62010','60390','89890','22260',
                          '45531','64994','91792','50267','68100',
                          '56662','62134','26822','39432','97073',
                          '94085','14905','81724','76969','47450',
                          '68753','47858','60452','61099','62149',
                          '88841','22094','55371','67375','58187',
                          '52986','70332','50593','26945','34036',
                          '54039','60782','92403','50978','55914',
                          '99997','84239','70200','54830','90672',
                          '62689','11593','46329','45667','53080',
                          '59785','89142','37715','82622','64640',
                          '41429','84763','72132','41787','63135',
                          '51246','37213','16081','26987','78513',
                          '71418','64664','70048','10538','74761',
                          '65407','48236','44232','95800','31098',
                          '26518','61935','86901','95703','37972',
                          '60588','19159','12445','38997','45322',
                          '53319','49903','42059','23451','52765',
                          '41051','25212','34508','34030','34856',
                          '68525','82011','13160','89168','70982',
                          '31200','27517','68922','88816','72092',
                          '50651','99930','48433','76047','57819',
                          '29974','94054','80091','20680','50207',
                          '22069','96726','38691','54960','96187',
                          '37424','17686','83903','17255','51461',
                          '41198','12666','26080','92649','64897',
                          '20310','64548','88529','64310','91398',
                          '75723','86974','16387','60297','18944',
                          '81497','66123','72711','93817','97024',
                          '42075','88866','21986','74607','16412',
                          '66855','98967','87439','80962','35788',
                          '20740','54853','12236','92575','42412',
                          '48550','59551','89988','87124','81564',
                          '84335','23438','31261','17886','86383',
                          '84053','46937','70097','80464','11110',
                          '96679','54047','10184','33088','87487',
                          '76259','20094','27212','69582','34015',
                          '85609','53655','57244','64045','67772',
                          '57301','37072','14833','97830','84150',
                          '59256','25020','67421','88885','18341',
                          '18787','47829','39409','46526','10101',
                          '87166','35000','86206','26450','30630',
                          '65037','58874','72933','82360','64513',
                          '26741','82878','16705','27808','40998',
                          '11338','63316','17381','92213','15956',
                          '70644','96661','42975','24551','82395',
                          '88988','82770','57675','37300','25343',
                          '72808','79920','78029','82888','76989',
                          '46506','92596','90557','77888','48395',
                          '18376','72197','56647','44497','89862',
                          '19186','72483','73298','73033','45991',
                          '54334','69788','58316','18126','91001',
                          '17184','42521','12532','25162','11059',
                          '22068','97505','18887','96384')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


