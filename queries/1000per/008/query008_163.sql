
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '51419','55997','51550','76136','28429','90614',
                          '10317','74214','14230','18421','65671',
                          '58447','52458','77346','55445','61214',
                          '83251','99319','56753','33888','64306',
                          '71587','38922','61724','29653','39014',
                          '84867','35874','29116','35759','73279',
                          '87179','56159','75046','42579','33074',
                          '14842','47571','27324','92919','32957',
                          '51244','39094','68447','31331','96113',
                          '26074','60731','98255','70289','20449',
                          '47578','61795','67402','54842','69563',
                          '58820','62708','66491','54743','86143',
                          '94469','73306','18903','89438','65978',
                          '99106','75303','61141','54114','29005',
                          '34336','73592','56160','74168','15469',
                          '36764','48727','65413','41561','18832',
                          '15550','55347','76312','35520','90313',
                          '40818','60505','72039','17884','67317',
                          '29562','85642','73823','72834','98040',
                          '34013','72556','80711','25218','25113',
                          '17534','87774','41063','68612','95500',
                          '76928','40141','32250','19439','46517',
                          '69643','96212','18975','57784','80391',
                          '53462','76663','51058','30140','47626',
                          '37782','31418','73729','42322','77292',
                          '62485','52685','29050','15973','10674',
                          '93769','97791','91686','76640','76701',
                          '69723','22808','26680','98131','94297',
                          '67879','97139','53085','55122','57714',
                          '54072','90118','93570','35276','40228',
                          '20816','63515','65440','50945','31395',
                          '74108','40986','35933','84823','66534',
                          '19002','92503','65455','94817','56800',
                          '76218','85588','70016','39237','50093',
                          '99802','44095','60199','13490','23343',
                          '13889','43314','35561','75848','67322',
                          '32254','33217','42905','25064','37480',
                          '14936','43949','69981','70924','17057',
                          '60792','46595','15053','96011','71992',
                          '56215','82537','94093','95443','74544',
                          '43183','89905','81462','13329','39372',
                          '28637','93890','86242','37202','10893',
                          '49421','20037','59730','33740','50376',
                          '49434','35071','76930','14860','37728',
                          '66668','74799','36719','95423','24317',
                          '41976','47292','93452','97044','47635',
                          '17514','27076','74631','67426','79021',
                          '93938','15995','14734','29078','28160',
                          '81586','34247','31131','76639','10565',
                          '55427','78845','40611','67622','46597',
                          '97508','36915','82467','89576','89937',
                          '21189','49159','73460','81433','59997',
                          '12301','24978','94330','86541','89319',
                          '28509','40719','58771','40081','36428',
                          '95308','78688','50681','69855','85505',
                          '61436','34831','88008','17685','14972',
                          '83896','95061','68834','78914','78600',
                          '39959','77383','66616','97436','91362',
                          '45550','29606','36526','92640','42664',
                          '14901','80790','54567','26065','12358',
                          '12902','51761','68586','97433','85936',
                          '70246','52880','21743','57577','81293',
                          '16449','80868','73429','80429','16359',
                          '55246','36129','44900','16072','45233',
                          '14683','22208','16017','54110','30226',
                          '12940','64427','86526','22003','32101',
                          '33936','62460','47262','31750','29659',
                          '54650','46981','10996','44999','70759',
                          '94612','52463','11422','21483','27174',
                          '32543','47105','32600','79694','10823',
                          '51272','29187','52525','80639','66805',
                          '72401','62532','47479','33858','86700',
                          '70985','64889','23417','47321','86103',
                          '43005','53570','54316','36193','73519',
                          '60126','74269','59939','16604','75508',
                          '82771','47866','51771','26126','87960',
                          '53614','19135','11799','51221','61221',
                          '18150','86929','40969','55606','51021',
                          '85761','19480','94749','80794','53730',
                          '27358','44067','49893','53820')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


