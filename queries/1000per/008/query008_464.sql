
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '96289','11067','67576','40652','83249','75232',
                          '95696','62873','47920','93520','71067',
                          '11778','70568','32404','18486','15542',
                          '90804','21036','61747','37856','12417',
                          '66413','64036','95064','68817','66932',
                          '44794','46862','57893','27983','72549',
                          '83568','10284','10874','16566','35337',
                          '54241','67078','78820','22104','36525',
                          '39679','73962','51045','91533','22878',
                          '88319','99008','41132','99780','84175',
                          '62270','62589','12790','79365','81660',
                          '94870','51247','60630','21384','26631',
                          '29683','49299','32358','43742','64170',
                          '21237','44169','16120','43239','10668',
                          '56557','88770','96242','99800','61055',
                          '98117','52019','31725','66754','83955',
                          '51530','67995','58583','59876','19639',
                          '69063','41660','24615','39373','45707',
                          '89072','75026','56314','70502','27991',
                          '85268','35188','21864','15561','51534',
                          '34046','89670','17249','63238','67108',
                          '27721','77122','15891','56693','14500',
                          '73301','38491','87892','58016','45737',
                          '71223','31454','80158','95343','70011',
                          '51474','42681','15407','86781','10396',
                          '72608','66675','57450','77729','10382',
                          '92073','27518','19689','14162','98994',
                          '55227','26840','59387','40433','69510',
                          '15876','22578','59268','43467','79717',
                          '58223','40185','67580','27157','24473',
                          '26199','45974','80603','46715','33701',
                          '27994','86576','54737','69700','39056',
                          '81874','90690','54623','29828','35622',
                          '56797','29965','20781','69442','88016',
                          '57092','40753','27640','40341','30569',
                          '82558','90220','76057','25309','57005',
                          '28354','27973','42358','40886','49917',
                          '82057','47713','82434','20363','50065',
                          '99317','81126','46135','58017','41087',
                          '68826','32204','37281','98309','28815',
                          '55424','32678','61798','35238','79877',
                          '25376','66645','13091','86979','62090',
                          '71757','90116','25756','51059','77635',
                          '93310','90302','91181','93686','13316',
                          '28831','51516','95066','70908','60671',
                          '55865','70631','47244','20883','59159',
                          '30834','87381','59578','45223','62128',
                          '10330','47825','86890','20927','52697',
                          '78549','37359','42575','27355','35134',
                          '28624','97498','22254','46858','59817',
                          '63723','18106','45470','27459','70556',
                          '73563','63545','72454','83760','38075',
                          '76051','21988','19973','67466','31991',
                          '14058','15405','74514','71760','96684',
                          '89210','83022','74838','20528','19647',
                          '79736','69764','72110','97315','28510',
                          '96699','68616','31027','37797','24945',
                          '87041','23093','91924','57782','72345',
                          '41644','18023','21985','20096','97932',
                          '99945','93394','77844','15463','28699',
                          '18144','70712','38267','79070','76365',
                          '71780','79221','79963','94049','84148',
                          '70089','39479','66009','96307','60695',
                          '76328','55177','51506','56787','15516',
                          '44509','81146','75854','84876','20065',
                          '45858','60826','47207','94950','47912',
                          '87997','19209','66829','81462','74297',
                          '34867','19922','53198','53403','54899',
                          '41042','26371','70248','95011','34070',
                          '85028','59151','11809','36699','52100',
                          '50390','61005','85353','34738','48194',
                          '56551','91902','26237','78100','71768',
                          '33146','51007','96505','20793','31636',
                          '76306','81397','69388','90568','43714',
                          '91389','97766','58417','97804','92645',
                          '10208','41454','38986','41856','45636',
                          '21934','74078','15417','48442','74371',
                          '30354','10738','25041','50584','95468',
                          '14411','14297','44089','73731','58407',
                          '87613','63486','32625','40154')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


