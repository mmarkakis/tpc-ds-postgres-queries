
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '63940','60769','20220','18195','50832','40121',
                          '74322','92897','24792','62545','35866',
                          '57751','50850','51038','69539','34800',
                          '99915','64386','54508','91518','47246',
                          '45880','76342','39940','38143','59879',
                          '23666','89342','30660','84916','44196',
                          '53008','90383','85859','32624','24700',
                          '66163','81164','59882','21105','64137',
                          '14782','43761','24329','40382','42294',
                          '13613','62895','55067','32331','76326',
                          '72780','18840','91436','35585','55356',
                          '88472','13736','88551','13636','63623',
                          '21607','36353','39717','39190','82533',
                          '36907','21109','32054','88756','48958',
                          '57761','71110','88540','95754','74951',
                          '46489','44075','73185','96934','71314',
                          '99141','81518','13148','55426','13479',
                          '57921','70613','89833','77093','76685',
                          '23519','28004','97970','90296','63679',
                          '52000','22010','67554','73513','47231',
                          '47495','65101','72755','98361','39217',
                          '98837','35125','77944','62948','43722',
                          '31973','36740','16175','33000','34706',
                          '79714','85414','26635','14119','96542',
                          '27968','39300','76255','87859','32420',
                          '45667','18440','60836','47271','87701',
                          '91788','69674','95993','34815','29200',
                          '89526','69148','99411','77728','68660',
                          '99291','71550','92101','88163','49648',
                          '94142','88623','29023','91696','88743',
                          '33261','80798','71803','15975','48330',
                          '79658','33868','34294','25974','32281',
                          '72612','34786','17575','56027','39063',
                          '80220','29491','56014','67643','69464',
                          '63797','35785','42420','44326','10866',
                          '88134','77115','89005','70285','52462',
                          '64128','69032','40591','70950','92777',
                          '79912','32952','23452','78133','26880',
                          '55441','62826','20314','90207','51273',
                          '72429','83165','84241','21177','34805',
                          '73473','72194','42551','75885','44669',
                          '63984','95190','12382','91414','89201',
                          '61421','22760','77887','68814','33843',
                          '35825','45512','41422','22888','42779',
                          '26817','51209','64990','85119','41285',
                          '29897','93723','10385','36200','46586',
                          '58376','12333','45304','65112','18719',
                          '93325','67253','15739','63758','31012',
                          '46349','69803','79035','69128','10982',
                          '23907','69713','85164','79896','85848',
                          '93496','24759','40159','23231','38945',
                          '26625','46420','65044','63061','25406',
                          '99155','97608','71058','82318','39783',
                          '15296','59770','38725','24955','94530',
                          '39324','86037','85827','33090','70945',
                          '14977','60269','72161','27701','18049',
                          '32226','24200','85360','11225','35730',
                          '37308','12168','10241','44432','39633',
                          '38754','60051','18595','46211','83827',
                          '52634','21277','31788','20336','33803',
                          '96125','76665','78868','65496','66124',
                          '35183','83492','61585','80960','29457',
                          '80038','58104','80076','99211','39166',
                          '60352','85251','13322','15060','19757',
                          '40036','49059','34523','65298','50705',
                          '31894','94323','99846','97014','63027',
                          '46572','49119','57281','33649','55575',
                          '71974','47256','94663','54570','50468',
                          '48839','89037','88269','24144','44791',
                          '69482','93737','78915','56944','69290',
                          '88074','94455','84749','17045','29988',
                          '99142','15394','16431','55465','48027',
                          '74045','21156','16956','69982','19644',
                          '47769','57054','91399','43128','92647',
                          '40474','34231','98603','33654','41265',
                          '29891','39701','72016','43431','20731',
                          '67181','19963','72280','34084','44675',
                          '67422','93845','83193','59542','79479',
                          '65059','94317','77592','19127','99448',
                          '31115','74235','82517','31624')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


