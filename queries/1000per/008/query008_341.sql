
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '57456','45667','10163','68457','67229','77457',
                          '41679','25084','53409','63131','65925',
                          '93951','31407','31371','47060','62400',
                          '73755','65016','14055','18513','34062',
                          '23416','17641','80876','18879','12072',
                          '65653','18074','84241','18796','15398',
                          '63061','51237','95874','24447','29235',
                          '62256','44026','55944','52062','42417',
                          '19741','26262','25474','89854','42976',
                          '44829','28524','37283','61248','92099',
                          '67678','57177','56776','13337','11965',
                          '71442','11232','52345','41096','33168',
                          '23317','67262','82336','50418','87150',
                          '46147','78810','13155','40399','43324',
                          '52591','72459','45876','31831','10793',
                          '55148','15608','62187','61757','71457',
                          '77863','13627','76126','79794','72188',
                          '33529','43329','18644','15350','97679',
                          '10686','68118','41307','84457','64746',
                          '12117','46737','42964','17714','71305',
                          '89127','56868','95181','25354','50163',
                          '45083','86988','22221','40494','42688',
                          '19664','41632','13639','40121','40678',
                          '54541','49101','48650','78583','57082',
                          '33367','35452','62689','23480','17608',
                          '67350','76335','63585','75837','52559',
                          '12607','58219','70013','63367','38129',
                          '54640','79337','30088','14031','58535',
                          '58823','27038','87981','94759','33110',
                          '49445','76636','99698','93442','94758',
                          '60994','39071','28977','82204','93579',
                          '57501','95891','20844','42467','63009',
                          '23447','73685','66526','12947','45327',
                          '49830','39909','36809','20725','90236',
                          '69394','22808','89294','52278','55846',
                          '65743','28424','19303','27003','99658',
                          '36106','13129','14152','46260','70312',
                          '58465','20681','27118','11210','21810',
                          '98018','65498','43030','68466','48757',
                          '91184','84194','57707','78145','55334',
                          '52671','38422','56959','19970','52188',
                          '98246','48862','33656','96583','87839',
                          '64824','12096','95911','17803','46606',
                          '94177','21291','46592','33579','65100',
                          '57631','27609','12485','67615','85305',
                          '19866','10270','75452','82335','16864',
                          '31913','46491','70319','10737','74297',
                          '61631','71365','16795','27667','63740',
                          '24492','63102','38319','89220','33061',
                          '64888','39630','10177','36710','64056',
                          '57826','93717','46454','68016','30497',
                          '31377','57398','49637','85514','66421',
                          '41565','25641','50147','68267','91738',
                          '71015','66536','14206','42896','33052',
                          '37662','50796','94045','25886','33850',
                          '26877','60899','86503','86268','69522',
                          '22847','73238','11522','14296','53623',
                          '93066','67189','92288','83627','90652',
                          '91846','42659','75487','56905','24304',
                          '73673','94138','94989','81911','91022',
                          '11786','77162','94429','70719','41269',
                          '92900','31384','12183','67498','79350',
                          '86493','28801','26060','61989','31119',
                          '13103','89688','59827','96284','72427',
                          '40753','17741','72359','56274','69280',
                          '55526','42726','26092','65131','25602',
                          '35527','34372','88305','69739','35734',
                          '25396','96642','76269','78723','21856',
                          '88812','79439','18911','51858','58453',
                          '34517','88777','62034','18686','59144',
                          '16494','97722','71019','97959','44191',
                          '39043','89533','42373','29520','71627',
                          '31379','89987','71955','89921','88248',
                          '27518','36517','48135','45999','82003',
                          '30705','47047','80124','77807','80322',
                          '62458','44111','18542','98203','70509',
                          '84887','61870','23969','89238','56516',
                          '61708','90173','51758','69851','27427',
                          '54368','65742','64515','89447','13125',
                          '72484','23241','68531','37484')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


