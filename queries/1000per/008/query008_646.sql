
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '47414','78188','26827','23200','17100','82358',
                          '81002','12855','76578','38181','85335',
                          '44700','42531','13196','22587','74964',
                          '51031','11044','89786','84249','42307',
                          '17254','83291','19096','31612','80164',
                          '55502','68174','68691','66090','11947',
                          '75955','13713','52940','52640','32800',
                          '90669','37139','71909','92954','22379',
                          '55185','55581','20553','17063','80211',
                          '81796','82044','67252','88600','17698',
                          '24398','72131','73088','18901','29096',
                          '59594','30060','19455','95654','75098',
                          '12107','40317','28663','33289','21296',
                          '32955','21663','63662','49160','96892',
                          '27494','90451','19849','77743','56466',
                          '95714','99985','29915','74299','64172',
                          '51457','78835','40069','67534','61019',
                          '37045','30443','83468','20952','82609',
                          '78399','96863','48314','87867','58201',
                          '69346','88733','93729','55309','38450',
                          '38322','24551','68419','43294','60859',
                          '94638','58473','48605','71962','68210',
                          '42835','18383','71163','82619','45410',
                          '23256','28479','90509','74475','42096',
                          '90240','17642','84412','64884','52723',
                          '33470','29151','59443','72327','13930',
                          '56291','45385','96520','81226','63981',
                          '44486','14733','94000','50782','11933',
                          '76447','69568','32577','41780','89576',
                          '83007','98154','95195','81483','82333',
                          '76929','88920','68495','81245','92172',
                          '25606','35787','37775','35411','13059',
                          '48979','16609','90553','30676','80744',
                          '69118','54984','14170','17476','45759',
                          '92601','67128','63823','43289','20524',
                          '43494','75844','44255','21793','44664',
                          '98744','70012','90192','67405','15102',
                          '76963','87587','31250','94592','84800',
                          '72450','37394','98113','28098','68016',
                          '84896','65396','51333','31552','55620',
                          '52381','37149','50256','15556','45645',
                          '24773','46922','30070','46265','43908',
                          '58150','80314','37302','88279','47171',
                          '47323','30600','83899','90839','95442',
                          '40641','69915','95617','50607','20902',
                          '96521','33146','29489','50300','66786',
                          '73207','15946','39344','61795','22777',
                          '41926','65049','16553','33495','81224',
                          '91620','76068','66221','25478','64819',
                          '35691','99152','25138','11294','48972',
                          '82232','16947','49208','69018','11243',
                          '39441','94456','90705','91908','81891',
                          '63480','36572','44566','95379','54546',
                          '18273','93377','16013','48440','32330',
                          '96082','28852','70183','34673','45714',
                          '10173','42006','85371','16199','15167',
                          '98971','78210','60884','81831','57411',
                          '95575','30637','35012','14402','58999',
                          '90559','74124','29335','63671','41084',
                          '50531','42667','76668','42633','98309',
                          '29916','33337','75120','62600','40243',
                          '32422','76460','30752','68969','38206',
                          '79320','48174','80396','22371','20990',
                          '70890','17113','49965','75352','72712',
                          '90761','39135','11550','56133','57272',
                          '14833','12451','54585','38171','12997',
                          '24225','25321','53389','32513','61234',
                          '83941','17179','34808','94674','69205',
                          '18215','68810','93253','30543','11346',
                          '31870','98808','49505','64507','17835',
                          '26850','61146','36254','93017','51636',
                          '36151','55895','70805','48464','11014',
                          '53296','99836','16627','44817','49419',
                          '78349','71569','81726','23631','84571',
                          '98491','17122','49983','55559','61813',
                          '38132','98457','45705','77374','42727',
                          '38777','63049','12330','41418','87000',
                          '72971','28133','94347','80781','23915',
                          '57315','21369','78100','77871','67693',
                          '85478','94529','12147','38877')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


