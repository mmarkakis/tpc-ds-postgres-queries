
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '97860','86824','35906','97585','91460','98451',
                          '48905','74185','98872','39969','32916',
                          '60813','42817','15072','72333','87110',
                          '37702','77715','93743','44191','52202',
                          '79027','68224','70618','17521','32659',
                          '57448','80976','99748','40896','66421',
                          '70343','34932','90494','19374','69545',
                          '88403','44174','54446','83954','14723',
                          '89586','72989','97599','70373','25020',
                          '45210','57025','42541','58844','86244',
                          '28856','33046','94580','78561','79365',
                          '59817','76739','62687','75986','11597',
                          '94092','95784','12898','74799','20834',
                          '54637','40243','51507','91046','54495',
                          '25229','97226','95060','49283','20179',
                          '73906','47722','58162','55906','69721',
                          '82354','50206','15968','75543','17128',
                          '33749','72054','11634','76659','25626',
                          '83620','74014','52362','18139','58528',
                          '43971','54588','31697','48588','56743',
                          '77971','53046','49280','33057','63732',
                          '87058','81089','50174','53616','99302',
                          '70268','14439','76563','75505','40398',
                          '47853','39229','86295','58543','64979',
                          '23307','90195','17917','83133','46498',
                          '42616','80961','30088','25037','26736',
                          '76580','25465','82583','93199','77424',
                          '37502','79189','59476','18327','16177',
                          '40325','86642','71149','13658','32220',
                          '26532','87884','52137','32195','90523',
                          '28339','10237','51969','88219','11497',
                          '95815','48710','89808','33145','84232',
                          '96181','59723','77745','40580','81352',
                          '96696','88029','13194','88231','35531',
                          '95277','61091','34846','58748','41264',
                          '15331','29382','77906','81139','51765',
                          '61445','52680','89543','38827','16454',
                          '23108','17494','84302','71545','15019',
                          '89742','95681','14253','24945','55379',
                          '19667','65167','35806','63272','98206',
                          '42337','28665','22325','69543','76897',
                          '52696','16431','40911','67767','95942',
                          '42795','99333','32159','21067','89154',
                          '89455','70196','58554','43460','29510',
                          '90765','39646','68940','54030','26401',
                          '56951','88481','40721','39857','79439',
                          '46137','70312','48347','67511','20561',
                          '94855','69325','55306','21490','50416',
                          '31889','19954','73002','25905','19530',
                          '22195','56329','79787','68085','19186',
                          '49599','18953','27017','30197','86016',
                          '25200','93220','36396','84413','21534',
                          '71143','81701','46938','69824','73788',
                          '12382','30201','27877','82295','71298',
                          '83657','63867','47169','87869','85010',
                          '95828','17211','82160','77822','20391',
                          '10265','96531','83415','16728','52034',
                          '12219','12775','37207','70752','80189',
                          '88252','75854','30738','82693','44830',
                          '20426','63599','33222','20537','86812',
                          '58590','14818','67278','39228','12894',
                          '75395','14273','88713','88501','86176',
                          '69712','64982','45049','74264','53307',
                          '69429','90472','60471','17558','31363',
                          '29694','66095','57651','11745','59868',
                          '40939','68291','60356','45398','74752',
                          '83180','74399','19501','50888','59875',
                          '97044','47182','77733','20293','91135',
                          '85755','64688','19896','53532','73213',
                          '15377','57923','64691','57406','99612',
                          '88994','35873','47761','61647','25462',
                          '16195','25682','99987','95547','16503',
                          '24178','43389','22788','51404','52611',
                          '14560','55352','66549','32642','99043',
                          '96033','51416','29207','81916','64381',
                          '64732','94441','82106','30234','12287',
                          '14259','53729','98952','99944','27836',
                          '34984','79306','87742','70420','61309',
                          '38721','20241','52138','86905','48516',
                          '74344','69016','75167','70459')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


