
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '15214','68192','48041','35006','35704','23752',
                          '59402','23001','77527','31036','43482',
                          '79898','32233','77267','95115','62241',
                          '35592','88821','76099','84229','29092',
                          '45467','97944','16899','15326','75523',
                          '76026','93289','73348','81407','22414',
                          '62194','79806','92898','24223','74573',
                          '90883','79063','30644','76957','52292',
                          '63425','82785','63000','46921','78159',
                          '40917','80625','73708','83970','12460',
                          '96725','44835','96995','72286','18839',
                          '11181','14236','59481','38102','27720',
                          '58062','45926','74910','92537','58904',
                          '92388','86791','90221','15623','92042',
                          '79101','59738','75654','26828','21369',
                          '76877','68683','30208','93224','24791',
                          '87588','92168','15504','88898','11517',
                          '43619','99415','16919','48927','46850',
                          '96186','15587','27454','34765','29790',
                          '89635','90497','90407','42075','11966',
                          '58524','22444','56033','44464','56111',
                          '49608','86838','64034','88630','43111',
                          '39417','66482','96252','56121','43142',
                          '88009','31447','53542','69550','99900',
                          '82456','78522','63497','26047','17708',
                          '25060','48828','18645','46615','99397',
                          '56947','75327','65292','31405','35499',
                          '82603','55386','48864','59847','94829',
                          '37342','61455','60658','50756','49629',
                          '20259','46551','13693','80130','58138',
                          '70261','91289','83244','23502','94639',
                          '75072','91449','22255','34445','74315',
                          '11087','58364','30740','65678','20410',
                          '38241','42315','23293','85332','12027',
                          '85040','18298','68994','28020','98553',
                          '59210','73551','17580','44696','48747',
                          '53699','35009','32701','29213','53667',
                          '26682','80181','26981','96791','52197',
                          '33683','87783','65969','53244','50310',
                          '82067','22891','40150','23128','15130',
                          '18961','69489','47152','76012','14897',
                          '80036','10932','36610','88414','53235',
                          '20472','57914','73705','63599','44245',
                          '89034','12668','21707','46392','77616',
                          '94031','47157','42266','39300','34353',
                          '90866','98112','30805','59140','42463',
                          '87707','32806','80526','39194','48118',
                          '46499','31931','86932','72312','84747',
                          '79721','10063','66515','56477','34273',
                          '93774','18691','50422','57429','67530',
                          '21049','55422','48159','79725','57312',
                          '51241','41576','20748','21532','65271',
                          '20448','19668','97264','62347','18116',
                          '28550','57116','10903','42837','40111',
                          '20433','85748','36982','82243','28402',
                          '49288','73844','26098','53534','12291',
                          '85736','53779','11591','95268','59204',
                          '99417','15652','57060','53615','65456',
                          '84765','94285','78237','58859','58527',
                          '84509','79911','45153','96037','54847',
                          '25776','33501','50508','53705','90038',
                          '84343','90869','20840','73404','22094',
                          '42630','55828','24452','16253','74719',
                          '73388','86673','69823','26979','59056',
                          '69699','25582','28757','31324','69615',
                          '89938','79002','53095','30064','27808',
                          '72066','21785','47149','89578','70632',
                          '65635','60464','19418','76927','49448',
                          '55873','99027','26006','14293','82406',
                          '91703','64415','94483','28825','77867',
                          '40324','79247','15088','33233','68401',
                          '51078','54432','85310','39416','41109',
                          '12686','57386','73828','28248','84876',
                          '30745','46604','95722','60355','85498',
                          '19104','10765','63728','56792','97889',
                          '30668','73912','11341','35076','76448',
                          '15826','42299','63698','69044','97065',
                          '24651','59927','43519','87962','14264',
                          '43368','44881','13792','23940','39328',
                          '32427','23738','48491','99063')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


