
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '96557','96850','17762','46611','54490','51331',
                          '56668','16145','31242','80060','29045',
                          '26258','67502','38004','45885','38423',
                          '53634','73395','78411','97266','22580',
                          '70946','82886','23958','32339','61525',
                          '49255','91893','53505','32990','56115',
                          '70318','51689','68298','21965','60263',
                          '68125','84901','25355','38014','24245',
                          '83144','54431','21648','13617','94261',
                          '73339','15843','33334','59055','96987',
                          '58614','22576','21805','95067','81972',
                          '62424','75982','76419','14482','10054',
                          '55019','78165','28263','96866','55680',
                          '70861','28575','32424','30616','18378',
                          '63597','75744','45299','41167','10702',
                          '25658','28009','21076','25762','81866',
                          '28526','39947','59539','10999','63107',
                          '26479','81768','15546','86969','83863',
                          '96370','91763','97861','25053','10585',
                          '44067','45719','44643','75687','37642',
                          '20201','45303','41132','73554','63050',
                          '47451','51991','26969','65518','78613',
                          '99444','68696','24452','71277','68361',
                          '65197','40578','90601','15381','99367',
                          '69010','17488','77301','63730','31574',
                          '85012','62362','48226','43334','16119',
                          '92515','48965','57712','74605','96113',
                          '22528','46889','30159','84265','62757',
                          '31064','56961','22232','55410','79407',
                          '19255','95159','12691','66763','40716',
                          '22382','97490','41051','97777','17562',
                          '39683','39631','78166','91866','31720',
                          '82098','36260','64825','57951','19446',
                          '71418','70097','93540','12402','67084',
                          '16352','55205','76367','65539','39457',
                          '54630','71559','76784','94223','11441',
                          '93306','96006','55626','21117','23680',
                          '98004','80764','37355','15404','63291',
                          '73735','40007','30339','91373','52683',
                          '48791','79095','89257','89931','59290',
                          '44766','15956','58973','73978','91599',
                          '87609','42253','93404','71622','99834',
                          '99379','20276','22033','17642','14613',
                          '78260','39755','15169','60913','77920',
                          '79072','90042','91136','61364','11595',
                          '46693','50954','12745','15865','23380',
                          '22381','34448','48841','44702','29085',
                          '62456','79090','12938','39861','16042',
                          '37153','37060','48996','84327','38456',
                          '34764','41492','66679','40921','77543',
                          '68581','95913','14490','13800','96746',
                          '17481','14419','32325','60781','54135',
                          '26796','36271','24668','71495','92394',
                          '26375','23582','93378','93988','79320',
                          '50691','78895','67937','20846','52535',
                          '87355','10700','31236','70401','50467',
                          '44114','66479','84230','34840','39258',
                          '42499','83734','58716','56850','73300',
                          '42648','65782','78577','88927','22690',
                          '37577','78127','88278','66367','82300',
                          '16256','21976','25353','26079','83919',
                          '20685','53481','87338','96826','80032',
                          '98039','78687','93799','62991','44926',
                          '54540','74836','56619','60253','34461',
                          '49608','28294','10344','66355','84057',
                          '41726','55323','43593','62188','88202',
                          '87508','10679','72449','38956','56424',
                          '33811','14788','89903','18234','30956',
                          '23357','84039','23711','75357','99050',
                          '14786','75309','99203','41181','53459',
                          '84706','86972','77403','33211','86626',
                          '85039','18520','51948','69676','42060',
                          '85686','19295','81653','73452','56379',
                          '86828','27911','57933','70674','51793',
                          '15651','82185','43944','64064','50022',
                          '44817','61281','17067','77526','41362',
                          '51422','35836','67407','30215','97249',
                          '44267','70608','20161','36901','51340',
                          '60738','53133','98656','40750','31443',
                          '96649','64092','13057','43406')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


