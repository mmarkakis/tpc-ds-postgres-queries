
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '13609','38521','43201','84698','23234','35640',
                          '99326','74479','57956','37280','24434',
                          '33712','69731','20936','17086','33062',
                          '74842','36903','90771','82258','34958',
                          '52595','67565','17866','99887','28075',
                          '40133','34912','67969','87922','52689',
                          '35001','72801','81578','40051','30682',
                          '72579','11860','97157','69239','94169',
                          '68174','97716','67153','49473','61620',
                          '85414','75821','62643','63601','93836',
                          '33845','28108','35171','36482','50503',
                          '86128','44888','47967','52256','51047',
                          '41956','14413','86573','79637','95933',
                          '90185','40668','51325','15392','10262',
                          '24445','62804','48602','31399','87129',
                          '73816','35566','79710','51412','50461',
                          '94418','67957','28581','12819','67308',
                          '20201','67069','80150','27363','70104',
                          '15861','65309','26445','56328','24015',
                          '27463','68446','67187','60996','85377',
                          '33052','14111','78695','27458','26886',
                          '18613','51880','11327','17605','90053',
                          '62134','37225','37985','72243','17937',
                          '68013','98889','95232','55233','17625',
                          '64162','59806','70039','12312','33977',
                          '65501','51407','49651','54342','35919',
                          '10127','40615','80533','64448','16884',
                          '99990','77587','92163','56459','41865',
                          '20723','67191','36420','79615','90956',
                          '55487','83842','72513','39478','61083',
                          '80577','46292','66324','72096','39629',
                          '32726','10836','89110','38042','89699',
                          '66316','52935','14938','44907','69811',
                          '91215','95852','30903','18873','65123',
                          '66797','96139','71152','89398','79162',
                          '64700','26401','37264','48112','84453',
                          '51642','65281','88434','64053','16993',
                          '47555','38189','32099','11708','89518',
                          '86156','65068','60852','26771','74943',
                          '95144','36156','99384','12360','67784',
                          '75730','84194','44179','35633','46014',
                          '72791','66145','48572','74339','56044',
                          '90935','20817','86416','81737','87750',
                          '10294','98839','32007','73902','46172',
                          '14750','46897','88901','37710','91979',
                          '95551','52916','64992','90896','97022',
                          '64443','54821','42067','12122','33785',
                          '65425','99285','88671','48444','95371',
                          '80917','17261','93908','95660','51155',
                          '89263','46215','25562','45265','43912',
                          '87272','63902','96439','22207','88920',
                          '35060','36061','85398','27602','75398',
                          '18808','18722','67286','95400','12453',
                          '72463','70462','71063','10333','94256',
                          '29713','41828','41324','97972','10319',
                          '56029','35242','50007','36708','49195',
                          '14847','88836','55358','80508','36161',
                          '19698','92388','63659','10693','95264',
                          '86226','98949','55350','55437','12367',
                          '58231','45196','25957','31103','63844',
                          '12885','52520','75139','86705','52044',
                          '21634','53800','47103','70541','77652',
                          '41073','64403','35744','79501','25603',
                          '22244','78467','91757','29967','95563',
                          '93707','54487','97544','13549','20552',
                          '46948','44872','33829','42088','19265',
                          '14578','37586','37551','82323','16546',
                          '78932','42552','19022','49676','10322',
                          '29816','44885','81329','46803','72384',
                          '72749','42989','73184','61102','22890',
                          '13272','44141','75200','16533','99351',
                          '68621','86104','25462','15664','12738',
                          '94520','19768','17561','71894','18614',
                          '17826','38258','90521','55521','16852',
                          '28250','40609','91510','41377','33435',
                          '85615','94541','76883','58722','37923',
                          '59267','91148','86418','83532','33980',
                          '58036','21087','59904','46901','52061',
                          '56830','92668','92998','74544','71612',
                          '90349','14641','61064','65206')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


