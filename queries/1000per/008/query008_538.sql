
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '61131','71235','95257','62433','35277','11059',
                          '16262','17180','98027','31080','55209',
                          '87677','56891','74216','57443','47655',
                          '63202','41062','49696','27703','14962',
                          '92113','97625','63510','60633','18117',
                          '58896','19997','38885','99825','82847',
                          '27122','29241','90125','59795','68320',
                          '55326','52261','73003','64501','25860',
                          '51794','88817','99934','10290','78290',
                          '51945','28457','20351','77621','27072',
                          '45887','78705','90249','46047','58224',
                          '86198','84257','92644','59448','35089',
                          '14723','66172','28060','79452','86377',
                          '50629','20181','71477','62249','20909',
                          '23930','77491','40047','69945','25651',
                          '42227','42288','83216','73420','46667',
                          '56825','55903','46752','22773','61440',
                          '77098','19553','56139','39386','49080',
                          '44559','36083','24968','22704','65964',
                          '10125','70987','54229','11749','48459',
                          '86623','57994','68847','95524','12090',
                          '84494','81096','50182','34175','98455',
                          '18335','30717','26197','30873','33395',
                          '87828','92591','71300','45790','30575',
                          '25750','96789','28700','73291','27301',
                          '25743','63218','19441','29526','18132',
                          '48564','95797','53819','60331','74370',
                          '25127','68738','46585','28615','25796',
                          '79887','24500','42557','10879','44404',
                          '17322','83144','88025','45531','13050',
                          '55775','47183','47958','28241','26710',
                          '35848','76772','53808','87132','60900',
                          '36423','98772','53742','66531','38344',
                          '37222','66171','96546','63855','91737',
                          '78888','84129','81236','29715','29464',
                          '61986','23520','77804','76297','42454',
                          '79284','86298','35644','35390','48717',
                          '86585','90236','52834','56412','24576',
                          '64441','80437','10620','32122','77676',
                          '77483','43273','21070','65012','72450',
                          '15268','76696','60353','22801','34881',
                          '35417','46113','68823','46949','36508',
                          '98442','18881','38079','23205','93329',
                          '68055','42085','70408','21035','41794',
                          '68721','65363','47266','34685','79562',
                          '88582','28069','80525','65491','25410',
                          '20072','50535','83818','94620','67047',
                          '63845','15360','55230','62764','37145',
                          '82714','53422','61503','44963','87978',
                          '21155','74509','16300','81649','73951',
                          '39402','94192','72492','76635','99400',
                          '96694','12989','49209','94908','82022',
                          '30668','81861','38861','27139','20825',
                          '43622','18937','11829','31605','92659',
                          '60554','48667','74706','17613','54390',
                          '84096','83412','16073','44178','38024',
                          '68480','10834','16970','78298','65535',
                          '81023','25861','96393','19164','53113',
                          '41523','26154','59947','56464','88315',
                          '71741','52116','96315','24114','44567',
                          '27742','91391','82445','44080','75304',
                          '23778','94199','29101','32980','90813',
                          '58384','29069','71116','40056','43709',
                          '10234','15346','65606','51453','58068',
                          '11419','42279','33910','91647','30778',
                          '64083','12738','15870','92027','91635',
                          '42553','20467','10657','19644','72599',
                          '32024','15009','53055','86016','42312',
                          '24659','98685','35531','55476','32062',
                          '94161','43732','63214','43982','51944',
                          '55092','16270','93113','72916','28739',
                          '55690','90643','74905','46374','86346',
                          '14307','77227','64917','30275','55012',
                          '40878','99036','26454','34864','52490',
                          '13184','13731','52028','82377','51620',
                          '86968','78260','81426','32461','17722',
                          '14684','70159','89553','40050','75519',
                          '92369','12897','64386','21676','89305',
                          '82295','83052','16611','72105','95015',
                          '65345','63243','18618','51458')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


