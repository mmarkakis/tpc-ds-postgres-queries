
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '26769','12495','47017','97304','13460','58390',
                          '58412','28752','17078','59097','40839',
                          '56624','87406','88000','49918','50880',
                          '75605','48858','97404','61875','34625',
                          '89799','78622','41941','66591','74778',
                          '45714','36201','24664','75593','18113',
                          '79065','99328','88324','77137','44137',
                          '17865','52786','34519','34803','74370',
                          '76526','51587','60616','62861','21414',
                          '69192','20143','55634','34179','71182',
                          '12349','58912','76318','86749','80714',
                          '81589','16087','18813','18338','93887',
                          '36716','95100','87961','96020','96003',
                          '75784','38908','56758','63315','85411',
                          '19446','10181','74768','96019','50860',
                          '42132','66865','67592','79763','42980',
                          '96250','68706','59300','12588','29209',
                          '60475','43203','94864','57047','63578',
                          '34385','64814','39114','60993','22168',
                          '69385','27031','98151','67934','69090',
                          '98226','35998','46114','51080','40132',
                          '63359','12717','50582','38631','49340',
                          '20633','26885','72723','63638','89869',
                          '90736','57857','58255','26449','68916',
                          '16421','65028','56268','92572','17212',
                          '60857','15859','42146','42856','76057',
                          '62200','64966','81149','16777','63013',
                          '55799','71124','55925','65642','68506',
                          '33468','60757','18163','41326','32095',
                          '52078','52609','33445','50322','83422',
                          '70383','23802','68878','66790','83343',
                          '39618','23097','53582','70106','41669',
                          '78425','75946','94892','56016','18392',
                          '36982','74512','86794','84422','41373',
                          '37089','29142','41065','49643','73664',
                          '43772','32782','73825','20654','72574',
                          '19986','22813','99831','44985','84156',
                          '76488','43087','94732','68770','66798',
                          '48576','85340','41110','86514','97535',
                          '92759','48474','25059','16215','52385',
                          '14888','38224','91087','85854','49015',
                          '41082','62838','53552','46424','84036',
                          '80618','41426','45130','47619','10098',
                          '85791','54849','23179','80062','40192',
                          '15739','73706','41697','37933','28732',
                          '36020','67142','73340','32934','46847',
                          '51697','35165','88997','33785','60793',
                          '10170','90472','63734','62234','13748',
                          '60777','58405','95069','28145','23662',
                          '93543','13133','58124','17123','24195',
                          '73443','94020','64831','15108','13614',
                          '98916','34324','84481','21356','55738',
                          '40181','66016','32241','83699','51189',
                          '15694','95295','72372','13022','51782',
                          '51972','92599','53738','21225','50886',
                          '58948','89874','51485','99792','64578',
                          '84145','58600','69400','74906','55016',
                          '53678','11794','43899','34403','11564',
                          '31223','20001','73480','68873','64928',
                          '47592','88418','54478','44653','66005',
                          '51913','42393','17167','55920','45166',
                          '64997','18968','44438','98089','51965',
                          '42496','21386','81773','65918','81239',
                          '43904','72310','76367','66709','93875',
                          '97884','65780','87073','25516','36337',
                          '23039','16174','44926','85679','90931',
                          '78128','21761','71504','33001','97684',
                          '18632','88836','27318','12486','43393',
                          '37394','27238','24167','62220','14813',
                          '24985','89563','57432','63534','47310',
                          '81188','25773','32637','75700','37128',
                          '66253','63684','66832','54943','20459',
                          '64845','61504','19894','55716','67451',
                          '96625','42730','81037','65240','41387',
                          '73203','21572','34661','95827','30168',
                          '21633','90156','16151','70958','36843',
                          '18585','49931','85806','83971','34967',
                          '92456','39224','91179','73116','88885',
                          '93122','82523','19428','54356','79824',
                          '78793','81705','80363','48833')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


