
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '63758','95941','76143','43429','21463','41880',
                          '55898','58343','89702','37802','76910',
                          '63040','84957','66952','27606','10256',
                          '11515','18126','92192','61103','15377',
                          '29280','25408','85517','73455','51596',
                          '63783','19977','98617','81422','35791',
                          '98556','35944','46486','50903','86309',
                          '59462','88144','11518','27461','90903',
                          '48225','62293','20202','77219','91593',
                          '14691','46420','58395','42737','60857',
                          '48623','11783','64555','94518','44879',
                          '45663','43472','45115','70569','28807',
                          '62335','40103','72532','18292','85532',
                          '58734','81791','65220','72231','37980',
                          '57366','27800','37715','59233','36718',
                          '50283','82765','38651','68467','92258',
                          '47774','25748','14293','91626','86818',
                          '89135','70191','55720','21158','39230',
                          '96033','95918','61354','79533','66741',
                          '44106','50733','95560','62711','99206',
                          '26186','84005','34889','33844','10286',
                          '58598','26732','84677','88102','23670',
                          '73725','38960','32831','85354','84014',
                          '28624','52669','20282','24818','68672',
                          '60788','65709','60214','47407','25333',
                          '85428','51993','71852','48580','58846',
                          '99587','72276','36741','67747','14083',
                          '47898','93686','39240','92824','21317',
                          '22823','49217','62028','75846','18660',
                          '51139','69240','69048','20847','76885',
                          '56274','58572','43250','90257','45980',
                          '78360','54720','14905','30651','62260',
                          '67374','19889','69142','77247','65692',
                          '47346','70081','84560','26137','87054',
                          '97657','29878','76512','76852','59159',
                          '62072','11017','11361','32841','76515',
                          '83582','22315','83187','84244','69581',
                          '64781','69486','23345','63608','64085',
                          '77053','82718','45094','78954','32362',
                          '43482','44899','17538','96315','53026',
                          '68882','95371','45198','17148','22627',
                          '65050','33776','85435','36917','31486',
                          '12153','19688','62876','35441','11176',
                          '93433','65584','48150','14537','25844',
                          '67542','13660','43487','87347','26919',
                          '98037','58057','44875','18344','91947',
                          '19378','18311','57989','37667','53263',
                          '12789','72990','42421','27356','63779',
                          '21133','99841','78498','30589','32485',
                          '11145','48825','42636','34268','86351',
                          '96214','69022','26894','60664','93020',
                          '36248','12986','43332','33312','36143',
                          '29736','19609','12977','22959','80348',
                          '66638','59859','27234','24622','70482',
                          '99578','11794','57135','45236','16270',
                          '74061','97171','49671','34258','87193',
                          '82400','57798','15660','94536','24171',
                          '62739','49362','11551','61781','43777',
                          '26143','29032','76095','80376','40693',
                          '71765','24262','63436','78190','64564',
                          '84636','26580','39290','56954','54951',
                          '17117','34757','83378','89071','14128',
                          '90563','95112','33269','79415','37736',
                          '45157','67025','21085','18712','73234',
                          '13223','40593','25565','62766','12672',
                          '67508','61237','53906','25757','27402',
                          '88167','96403','12038','24737','34981',
                          '34190','93652','71305','41415','30100',
                          '52221','66589','73220','30789','77556',
                          '90080','73595','91413','11078','38733',
                          '97393','10708','78976','85164','26223',
                          '31905','79935','22039','54653','78194',
                          '84043','73555','85292','77142','55795',
                          '73856','32301','40561','69139','80287',
                          '67669','74254','16187','79496','93809',
                          '51375','50114','84012','40180','69837',
                          '80085','45364','29074','11730','20691',
                          '93353','33863','62039','15417','72661',
                          '50252','99522','37716','50586','57194',
                          '17800','25153','68249','41802')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


