
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '16038','53390','45863','47315','42991','66539',
                          '10782','18861','16880','27321','33494',
                          '41034','75304','80722','89548','55628',
                          '56236','14265','51110','65916','57908',
                          '21565','59016','21668','10422','15099',
                          '18714','97629','65491','45886','24975',
                          '69975','57839','70644','13003','17509',
                          '16323','63559','56865','47789','42602',
                          '66896','13668','26433','27463','12135',
                          '43474','16735','53863','35527','96654',
                          '67261','26591','81181','66482','22302',
                          '98731','43540','75231','85904','97782',
                          '43597','42289','48383','82083','37588',
                          '69112','35677','19793','96509','30067',
                          '35633','77721','70462','23049','46977',
                          '27162','31361','66718','82686','45390',
                          '72111','25389','79753','67562','18620',
                          '14509','41098','58881','98622','39755',
                          '41731','54312','58634','86290','26194',
                          '27600','53907','99251','11939','79068',
                          '41915','36665','28014','84475','85933',
                          '28161','66483','49733','68383','33689',
                          '57849','64448','63956','59561','55834',
                          '16941','13647','39767','93060','15572',
                          '62970','28069','87066','42028','13937',
                          '35998','86007','73741','48633','25370',
                          '62543','28202','20612','54423','10144',
                          '80881','91379','78880','42764','61939',
                          '81370','41359','42906','72347','92263',
                          '46668','26451','38162','29093','62598',
                          '57132','89990','86276','32400','20760',
                          '94595','22071','86446','19679','97672',
                          '15415','41384','47201','36549','99439',
                          '20615','39041','21208','89269','30582',
                          '99238','52377','47767','17042','73487',
                          '72103','93567','90137','13234','68911',
                          '57109','42474','79416','94477','17548',
                          '23094','14362','26039','26108','33258',
                          '97723','67632','17584','35683','86357',
                          '27661','75276','76805','64462','78124',
                          '87122','53749','77575','70698','65453',
                          '53915','86282','16740','15698','36579',
                          '74578','21560','25726','43432','71681',
                          '17060','93787','13830','83010','95733',
                          '49518','93025','85545','17865','95357',
                          '13101','50275','36575','59115','80719',
                          '66326','93220','90007','14089','46978',
                          '80632','27392','52482','45984','62791',
                          '15756','76433','33939','22101','13686',
                          '64745','41682','53088','41838','89311',
                          '22131','16274','52813','83471','16065',
                          '17392','35497','57485','53431','58883',
                          '34396','17213','48531','65753','54903',
                          '99286','16104','35045','36795','54431',
                          '53841','81074','41449','73252','73335',
                          '55513','51389','76481','66773','46866',
                          '19416','35789','41726','84511','53095',
                          '94661','80555','39639','26267','55071',
                          '38442','24866','71127','74657','49087',
                          '67783','94378','47871','16790','93297',
                          '11523','53722','33291','69677','13689',
                          '86429','37813','17199','25564','22171',
                          '86130','27571','39830','47915','83235',
                          '82235','54079','96434','92712','57872',
                          '56802','79030','60770','50312','29775',
                          '31695','62207','13966','81745','88274',
                          '44473','54669','79365','86154','61782',
                          '57447','90989','16280','77928','37307',
                          '11236','48316','95742','73707','35921',
                          '45443','49061','74505','16707','79359',
                          '91488','42880','78506','91424','24916',
                          '64899','92673','36572','85275','51315',
                          '21406','15752','70011','28489','98980',
                          '36829','12864','60785','24027','20235',
                          '92345','34880','46605','96996','70567',
                          '58203','65641','31673','90395','44905',
                          '84251','26648','44296','14458','34248',
                          '62174','70416','67243','92503','98179',
                          '98828','63720','15501','24626','63053',
                          '10453','89915','29842','73129')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


