
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '32547','37649','99062','46338','91305','55121',
                          '83730','24534','88903','65665','99783',
                          '57152','19040','62682','26914','17429',
                          '28891','44601','48513','13752','92266',
                          '22820','26029','10033','89315','68433',
                          '58649','99541','26435','29616','36474',
                          '46827','42456','80504','43009','65211',
                          '20564','21352','83099','10048','62444',
                          '81476','38093','76037','56321','80970',
                          '50866','27144','81550','27779','94791',
                          '35894','21685','86713','44286','54738',
                          '61741','58432','90511','22909','64041',
                          '59299','37027','97185','26441','79572',
                          '12331','45412','16401','15212','99209',
                          '40555','60591','35322','82727','88534',
                          '40000','74522','81182','66298','97898',
                          '25313','44394','82155','14059','29366',
                          '21028','60023','94480','10515','25957',
                          '20765','70322','10436','83284','33583',
                          '11810','17625','32320','34703','50246',
                          '88048','86567','43701','71229','23781',
                          '11222','41817','56634','71521','71575',
                          '69896','28868','89499','48264','77860',
                          '38136','49866','67168','10581','83960',
                          '44670','46199','19905','41275','51066',
                          '42002','88625','41875','61113','94595',
                          '74248','10788','21113','49454','98476',
                          '74903','45705','10002','73690','54512',
                          '38894','17731','27125','91904','32309',
                          '29525','41671','60342','26483','51998',
                          '41152','66769','25784','28718','76614',
                          '64227','12668','13126','26111','81959',
                          '38284','49870','94655','86897','43647',
                          '62842','87320','39529','67696','14653',
                          '32708','33954','86765','79755','95414',
                          '33791','99583','75782','26163','23347',
                          '48088','49673','16327','81883','69568',
                          '59489','55470','72422','70338','88411',
                          '14747','10890','29978','34464','76495',
                          '31112','61332','47306','75316','83800',
                          '96327','48233','37347','51113','98604',
                          '45271','66336','58640','55092','69938',
                          '62387','70967','21936','75938','10980',
                          '44771','39418','24493','94233','27026',
                          '57719','96242','66131','31167','12484',
                          '64922','10664','52235','23458','20606',
                          '96046','81821','19673','15066','32950',
                          '51522','32713','60649','58809','82415',
                          '34005','76095','86231','88301','12502',
                          '93524','31797','82527','21096','86543',
                          '38055','44120','54124','76737','54462',
                          '31259','19036','90007','60431','76858',
                          '46496','33327','71033','36380','87255',
                          '45369','56217','92231','56105','25757',
                          '93061','66539','88260','39574','87244',
                          '24618','15376','84790','77843','64926',
                          '43599','25146','99044','37884','80525',
                          '57925','99492','87179','47349','13574',
                          '19117','27538','21338','54788','41413',
                          '60016','85254','76727','36388','16777',
                          '50583','80396','65455','84377','68151',
                          '41984','62730','36929','50999','98830',
                          '56993','66237','14985','28169','25241',
                          '54529','13106','73683','22005','19699',
                          '94285','25693','17480','48091','38085',
                          '25549','78509','98738','85772','83680',
                          '19008','92442','43888','20183','51328',
                          '47791','78824','64538','17008','80113',
                          '28060','70767','52098','47981','55583',
                          '33015','77850','85684','62519','48424',
                          '72342','24613','46429','95888','17775',
                          '79359','24798','51095','62889','25472',
                          '37053','35202','25294','37774','54218',
                          '33085','38289','47608','60489','16172',
                          '44133','92748','96185','17921','98769',
                          '94916','31799','82147','99723','62067',
                          '41016','37806','44483','77591','52178',
                          '95737','74176','22941','58051','50499',
                          '21802','43649','73659','48100','85634',
                          '62451','29044','65331','68113')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


