
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '58845','10370','96016','32986','60656','43187',
                          '97427','19760','69112','71037','14122',
                          '54891','33719','91891','46814','52088',
                          '71337','62587','23606','44555','11779',
                          '16180','91538','71551','27045','92392',
                          '38725','51037','56864','36392','93589',
                          '25858','31253','23164','26571','53469',
                          '97158','65480','49976','32338','95092',
                          '39839','91285','72419','31719','93092',
                          '74730','98230','16917','43384','40009',
                          '84509','12333','78298','24200','21224',
                          '72596','26136','25321','82071','21569',
                          '97877','60100','73832','83111','63410',
                          '36067','11121','64474','76296','33691',
                          '83561','33483','60208','54131','80692',
                          '74265','67755','69623','38070','55887',
                          '33769','49341','28910','81266','47799',
                          '46676','44550','78077','77173','24479',
                          '11822','20201','56468','78262','21953',
                          '25541','95462','14912','60706','43560',
                          '53092','78574','53750','18139','80931',
                          '65622','10326','89340','51636','43266',
                          '67365','39266','55776','13627','30941',
                          '38279','79534','65078','34588','18172',
                          '62467','99621','69493','65642','31559',
                          '66184','19204','23267','59288','87955',
                          '38141','22000','44043','48634','11027',
                          '35319','98515','42804','33379','61197',
                          '71516','28995','49762','24368','55553',
                          '29875','60773','46002','80819','92897',
                          '60357','71902','77944','43256','37318',
                          '57812','97608','58961','92807','79977',
                          '99039','30495','98719','51740','24531',
                          '16344','93000','60017','54780','41512',
                          '12009','85820','39451','26401','96295',
                          '91629','17600','86862','27301','44713',
                          '48659','50924','85889','29596','19707',
                          '87844','38335','74119','64634','20356',
                          '79094','59340','96647','96808','76006',
                          '87545','72216','13235','93329','30302',
                          '47899','59815','43399','13700','82884',
                          '69308','81937','45371','51216','69564',
                          '57434','41674','99175','70767','34584',
                          '43875','90351','75791','70332','19487',
                          '18338','69986','96320','13230','60278',
                          '39302','91492','70165','40367','12050',
                          '56313','15090','70471','86818','24114',
                          '76506','30104','68941','67818','72260',
                          '89123','81598','85409','94500','85548',
                          '27003','71086','81553','52501','15987',
                          '58959','49060','82763','33510','91935',
                          '35042','39950','38905','18345','50193',
                          '31725','74099','98786','27757','67971',
                          '67163','68588','47674','86894','22335',
                          '57705','70058','86342','68105','54264',
                          '37812','83709','51683','38684','81120',
                          '29097','10669','90775','53859','48499',
                          '60019','90697','46552','51822','46456',
                          '54296','83056','18013','65598','76596',
                          '96328','62996','21997','46453','99435',
                          '32606','92741','62313','69787','70386',
                          '47322','53591','69746','64942','96058',
                          '27232','84310','70456','61946','77903',
                          '73028','91029','70226','38293','48809',
                          '68499','60482','81645','33750','79339',
                          '72750','73153','61996','98690','43119',
                          '16019','58995','71674','34800','90572',
                          '11440','29750','31548','44458','38543',
                          '35802','79716','18220','95019','26056',
                          '39653','86327','64832','76586','22981',
                          '85411','92969','23483','49776','65611',
                          '54634','70639','64223','51092','76194',
                          '31496','30725','92988','31535','90037',
                          '89672','52459','67411','31312','72112',
                          '50645','82800','55832','19154','93614',
                          '60759','17938','71784','73838','11450',
                          '79157','89038','98669','11979','53579',
                          '65792','14799','45852','39710','14482',
                          '60361','86240','81191','43300','54742',
                          '61092','19431','19720','25565')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


