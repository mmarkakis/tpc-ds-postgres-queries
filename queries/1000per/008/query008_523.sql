
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '83863','23044','80627','63047','48114','19529',
                          '46191','53530','44784','66930','81271',
                          '59755','25127','14770','12631','29820',
                          '49847','93556','13673','63997','33276',
                          '70638','78632','97293','45087','69994',
                          '49782','44983','49310','42789','56341',
                          '15399','44469','59617','98928','92660',
                          '53790','69867','97695','76941','44457',
                          '98879','32601','14583','79911','26286',
                          '22189','11898','63627','21318','73032',
                          '57312','24693','57030','49701','98016',
                          '40386','75152','84659','44499','31356',
                          '46779','59529','44829','94457','57482',
                          '88536','20693','86911','83254','99455',
                          '39370','93603','45888','56964','22044',
                          '67027','60539','67753','69743','82735',
                          '69982','89257','63840','77246','75067',
                          '94848','26066','77208','11832','39388',
                          '96413','31905','27445','86851','14975',
                          '71464','75423','98303','25800','94401',
                          '55100','88089','69443','67480','27499',
                          '23788','91917','33748','41267','17095',
                          '45160','12368','94797','35928','67088',
                          '81695','97458','98144','22605','76006',
                          '76893','25814','56858','42666','36281',
                          '29941','42760','15801','19909','15991',
                          '61303','76180','67130','58081','92726',
                          '30796','49926','65118','49051','86337',
                          '18195','42261','95499','59289','89001',
                          '66115','74727','26953','54005','84218',
                          '37655','72917','18202','54485','61723',
                          '69716','39007','79071','15159','37177',
                          '11866','50156','72888','34041','71250',
                          '99751','29060','89640','69591','83098',
                          '48187','19779','98035','37786','11609',
                          '62291','75797','90703','91653','63287',
                          '35577','41196','15576','51525','25743',
                          '15139','35398','88297','48447','46202',
                          '27738','67728','81142','76911','99649',
                          '13938','58522','45391','13551','52741',
                          '23414','81700','18401','80436','41024',
                          '55991','34963','40894','37393','61590',
                          '42497','51806','70631','16010','53021',
                          '59835','51455','74001','50671','44901',
                          '13201','76946','57291','65891','56378',
                          '85157','21120','57230','78773','52053',
                          '77716','93406','84598','16270','91982',
                          '42747','18929','29990','80852','18725',
                          '36838','86728','26929','95157','83872',
                          '97998','62305','21781','85008','85513',
                          '67772','90667','10765','60232','16943',
                          '10418','95989','17262','73727','99758',
                          '96935','49377','48357','37080','19079',
                          '77023','35842','29290','98363','60161',
                          '22560','96139','68292','20513','45616',
                          '61505','75960','53976','77052','73858',
                          '11029','31659','32014','68463','81232',
                          '22100','86201','85394','79683','68998',
                          '66288','48576','77229','95113','53191',
                          '66021','77356','52424','32474','53328',
                          '95230','68801','39344','70791','19613',
                          '44437','99141','55795','32894','62680',
                          '26981','97038','55911','44304','48342',
                          '11186','24168','55842','28825','50362',
                          '72832','85509','42604','69103','49032',
                          '74312','94055','19081','65681','13659',
                          '94560','72788','66017','85480','81305',
                          '80548','64601','65116','30183','36049',
                          '11093','66642','38917','65152','37214',
                          '26580','51372','56468','54272','98112',
                          '66208','52380','64348','77575','83574',
                          '98801','62338','57840','80907','78500',
                          '90226','12473','53042','67547','56046',
                          '31743','69843','48933','98296','93729',
                          '34244','45603','12929','51878','80463',
                          '24127','66034','76214','78692','93674',
                          '61601','77567','95321','90562','82182',
                          '48608','69406','25751','39317','12680',
                          '90150','48859','18217','64709','23111',
                          '33014','51139','18246','99839')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


