
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '84357','47619','26433','25216','63974','52342',
                          '16415','23849','76883','82927','45331',
                          '29645','61360','18705','94523','32445',
                          '35250','85093','91606','22202','60208',
                          '77572','90394','27815','83132','11569',
                          '30919','44281','15111','54383','60950',
                          '15679','14658','22445','17731','55660',
                          '70065','69313','20468','86656','33686',
                          '65089','85904','88292','32895','86853',
                          '81679','12653','40257','78243','45319',
                          '68555','77324','89811','36479','20199',
                          '58274','50468','17852','86709','49770',
                          '76018','73649','64194','12273','20239',
                          '60688','66035','91188','87385','43726',
                          '40908','55349','42552','13281','20480',
                          '94862','59091','18417','38273','74344',
                          '18014','59400','10900','73318','58575',
                          '81695','88685','86224','13891','93794',
                          '79611','94616','23397','55035','88462',
                          '87855','14776','74323','51632','32835',
                          '89081','76860','65899','50004','78026',
                          '74292','25972','67782','60474','77302',
                          '29662','26173','29656','99455','33196',
                          '67141','71129','77273','73821','24156',
                          '44750','87714','19405','48003','15798',
                          '85883','70025','90114','99519','27338',
                          '68563','48542','67708','29772','47296',
                          '51495','13348','87307','34615','13917',
                          '54878','28216','14246','28539','30457',
                          '60863','82851','82969','53961','56470',
                          '74982','37177','18371','15053','67375',
                          '41167','35120','75981','12120','59559',
                          '78551','43647','66083','85200','84850',
                          '62330','98000','39842','43702','84918',
                          '48159','37315','55434','53335','12386',
                          '41966','75846','53159','90906','66930',
                          '65892','78175','87024','41979','16724',
                          '49729','70635','40090','53003','47885',
                          '83670','23070','79215','15860','34759',
                          '71041','40582','56112','47115','91245',
                          '24530','13108','80811','46559','98786',
                          '12901','81773','39374','70202','99447',
                          '32205','11457','53478','84266','60095',
                          '65768','25190','85427','45832','61327',
                          '90363','64960','55129','90473','69895',
                          '55904','41451','56039','21010','16416',
                          '70225','73556','99910','55741','41892',
                          '62727','56795','92083','21387','22100',
                          '46066','23665','73430','96426','47925',
                          '55195','58246','80442','61702','53683',
                          '61125','59992','61800','14189','67649',
                          '12110','10861','70414','42599','90154',
                          '72027','46757','50412','36895','43341',
                          '89400','58994','91406','60512','10279',
                          '39802','42398','14311','29358','11839',
                          '69158','32144','29123','89654','82194',
                          '66269','20242','64704','93908','39326',
                          '44674','25063','63382','67239','11507',
                          '87663','64866','69167','41232','88482',
                          '72504','71995','42188','22212','79074',
                          '68755','80159','34762','53419','18023',
                          '69465','60070','95820','73163','54788',
                          '14800','57428','54228','40105','20469',
                          '44569','70389','29122','69394','24706',
                          '83031','33454','13370','21375','31635',
                          '53137','46786','22936','32435','30396',
                          '71203','83326','32545','43554','28832',
                          '69593','40722','21714','78723','38774',
                          '17672','66957','22833','97696','15708',
                          '28468','43745','91352','85660','26299',
                          '37359','17102','69315','13605','72973',
                          '20317','81594','47289','20216','64174',
                          '73152','37340','53394','33197','53761',
                          '76621','57922','24666','29441','72306',
                          '26459','29521','11684','60568','44521',
                          '88489','31201','93453','35392','44655',
                          '67218','54573','69190','83341','65602',
                          '68120','59984','55955','90635','28963',
                          '73054','71394','68162','13740','26041',
                          '28590','42416','42517','28804')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


