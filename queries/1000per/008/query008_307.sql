
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '13093','41602','20247','19347','99251','67460',
                          '52570','72858','80772','88383','72701',
                          '10719','61984','23926','20133','53261',
                          '54874','26406','57565','76584','27830',
                          '14935','15347','83948','93125','42826',
                          '37991','40307','82321','58779','89753',
                          '89756','76558','65407','46402','78697',
                          '33344','49250','61654','49387','61034',
                          '53124','76538','46564','17955','91780',
                          '85344','63032','64112','29597','72494',
                          '81198','30329','67316','88912','75284',
                          '51349','21331','38864','46549','32815',
                          '64476','54175','72179','64024','59818',
                          '43262','56850','28914','22659','59108',
                          '53401','69977','51041','85378','42544',
                          '18496','92051','46733','32078','15613',
                          '45066','53037','89745','22988','11386',
                          '94599','71316','94415','85481','17258',
                          '46200','81713','10884','85878','94795',
                          '74655','25447','27715','73240','56181',
                          '26131','14322','72463','29580','99049',
                          '40678','29451','78040','47894','97382',
                          '44942','71839','56087','82920','51274',
                          '81328','37988','92449','47719','79700',
                          '13191','44116','36646','24904','29053',
                          '88502','78766','67149','79142','19343',
                          '68000','81466','42800','36948','78640',
                          '33688','66670','92356','67208','57577',
                          '84638','54356','90417','32639','86484',
                          '17872','65189','15325','14553','73692',
                          '54916','56086','64466','44108','22795',
                          '48449','11758','79432','89195','71918',
                          '22943','79464','24198','46202','54883',
                          '47727','99091','89522','13898','88062',
                          '94287','75952','67359','67327','20069',
                          '70515','69646','63321','30063','60738',
                          '11883','67212','74775','34431','72729',
                          '39202','71609','76282','89108','12760',
                          '14851','64134','57491','93343','61899',
                          '70881','41538','38164','77264','71951',
                          '11391','38397','78075','42823','90296',
                          '92933','17422','60565','77920','96554',
                          '47339','60372','60615','71711','57982',
                          '95457','62748','18941','43418','12149',
                          '40287','39118','67209','77741','26573',
                          '56173','70324','70355','30848','14311',
                          '87868','84625','63506','88122','62554',
                          '76757','23632','78237','82763','83408',
                          '41945','38274','37436','70802','12503',
                          '29239','76639','28423','29974','67074',
                          '48031','76300','65722','67605','51158',
                          '69335','96881','63713','18520','62375',
                          '34332','74224','77051','43631','56843',
                          '95208','99640','80804','72474','68799',
                          '53716','61478','69450','47452','55097',
                          '34520','61714','23023','35909','53651',
                          '67903','87483','89032','62181','29975',
                          '29670','52448','94521','13946','16396',
                          '22223','92177','96372','18737','65763',
                          '76853','76248','65884','13644','96169',
                          '94390','55704','93375','57003','45895',
                          '35667','33151','60294','55776','46459',
                          '39144','37305','73996','70682','77784',
                          '51356','13877','12151','80689','86883',
                          '38835','79746','38331','61582','83094',
                          '76913','33064','70578','71670','92904',
                          '66198','80004','60614','30156','96921',
                          '26328','30287','43904','60024','46003',
                          '58506','81844','83832','76076','81322',
                          '47048','36693','76198','95965','56802',
                          '87678','12564','77688','14846','43783',
                          '48772','23289','39089','59743','17840',
                          '48240','81347','55231','64039','60835',
                          '78169','73615','19284','72599','63197',
                          '57966','39511','85060','45196','71336',
                          '87367','47847','59516','91969','28505',
                          '43917','93693','99662','48424','11158',
                          '90453','14698','87176','26809','31863',
                          '69584','20796','41594','45802','38493',
                          '51196','62998','88349','84752')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


