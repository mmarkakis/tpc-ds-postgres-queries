
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '89664','23402','99097','50749','24993','46597',
                          '10488','35461','73205','45993','30533',
                          '35221','10224','90610','80572','75631',
                          '70309','33981','73452','68471','49526',
                          '58923','93271','27165','47716','26479',
                          '69134','38980','41622','98908','16967',
                          '46578','62492','10244','30634','40116',
                          '51984','92009','98502','90459','76124',
                          '79557','61343','36342','64014','25028',
                          '70656','53776','36934','19341','83481',
                          '30687','15267','40237','96695','65908',
                          '48145','74022','85716','29763','82516',
                          '66312','38753','58728','40961','72246',
                          '94322','16122','84583','59123','56722',
                          '99766','99084','38558','65162','31403',
                          '43577','42708','58502','54931','55002',
                          '93927','67368','60168','70642','15990',
                          '37373','82463','45033','79380','27663',
                          '16505','78314','92314','16836','39714',
                          '73346','81324','21363','34608','90751',
                          '59786','69766','48293','88460','17943',
                          '95501','92769','50652','99541','45556',
                          '92536','51535','39102','48600','25764',
                          '85843','20151','82845','87209','47501',
                          '63165','34120','45664','94728','91207',
                          '28190','79941','57831','60731','10802',
                          '21926','42343','13522','49368','77953',
                          '17166','27683','90385','30918','65830',
                          '36971','11372','38068','24940','18405',
                          '12652','88097','15395','12838','23210',
                          '90821','41892','10382','72761','29430',
                          '91175','75187','90239','99909','19804',
                          '76678','27279','78057','31894','41345',
                          '14001','73984','87716','52171','49240',
                          '20757','64680','81265','15087','30103',
                          '25237','65647','95905','12499','67975',
                          '30768','55872','61369','81246','72418',
                          '53264','65581','34653','22691','54713',
                          '27842','60977','50362','18417','27925',
                          '40849','68425','97478','14699','94332',
                          '39015','99530','24652','30081','62246',
                          '22307','23989','47429','23643','74204',
                          '75570','13738','63544','71670','41397',
                          '22682','75111','45985','80724','40512',
                          '24886','50599','11570','71161','14955',
                          '43852','19457','85396','10049','58257',
                          '98683','86498','62045','17970','31654',
                          '55928','36124','99190','53965','80910',
                          '63815','31560','23898','61120','97939',
                          '51278','59349','73846','82579','46199',
                          '97756','86637','32505','42139','74633',
                          '75085','64229','90428','19416','18082',
                          '14690','73289','18380','94617','95234',
                          '34091','46550','15745','67132','26855',
                          '57150','47300','89584','53660','29057',
                          '93647','29318','62770','99581','52293',
                          '84914','73208','33154','93269','35001',
                          '15287','77085','11691','45119','40941',
                          '46819','37278','70688','35823','30403',
                          '94473','69098','12063','72265','88443',
                          '57360','24086','88026','74363','80953',
                          '29775','44103','36328','43319','86304',
                          '76034','26153','17362','49164','94038',
                          '28206','26482','91846','76183','19920',
                          '74730','28051','78783','89391','56538',
                          '64599','51783','79773','35430','90623',
                          '46982','52492','59705','71160','56489',
                          '31178','77663','70133','12785','21545',
                          '58578','98255','64397','86016','93363',
                          '58368','40271','23356','39297','70613',
                          '31876','64916','41125','64523','53200',
                          '46407','40217','69195','19198','72063',
                          '77078','75298','48579','28467','83804',
                          '26432','37820','87829','57796','85951',
                          '96010','46750','83753','32040','50397',
                          '54176','95677','54201','22958','50366',
                          '17162','54990','99147','46089','67910',
                          '20986','94148','17040','71430','81087',
                          '88009','29956','81658','43046','11709',
                          '40641','22514','39651','28469')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


