
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '68942','47022','54597','79788','11727','40636',
                          '76990','47306','29461','74655','70151',
                          '50824','38970','15765','96528','91256',
                          '45545','63270','30590','90905','41838',
                          '60514','24410','43910','30138','22134',
                          '61214','75149','42267','94126','49607',
                          '58460','16190','25420','74263','44196',
                          '45768','84154','48549','38929','55548',
                          '41501','23913','52485','41078','80343',
                          '41238','71095','94616','37366','45950',
                          '76083','12631','81484','82756','50931',
                          '89970','12061','63119','60071','20823',
                          '86791','51475','29119','20178','90972',
                          '87421','56628','41746','67936','16063',
                          '44959','71407','37227','71728','40733',
                          '53831','54259','73983','49712','71277',
                          '15818','76285','93468','50760','89089',
                          '91836','59777','52107','45410','49198',
                          '39898','43235','44954','68956','57150',
                          '20123','67593','22979','80484','56719',
                          '35791','90562','96674','66517','76320',
                          '21486','61220','72103','22027','73575',
                          '99358','63772','92266','91052','12334',
                          '98058','62194','94593','56000','97173',
                          '88234','82412','37144','61865','26699',
                          '27383','76420','18305','67845','93002',
                          '12590','12113','84336','10657','27129',
                          '15918','25180','65721','30349','92311',
                          '16970','11179','30974','70823','79025',
                          '30064','30969','61443','75026','33940',
                          '36779','33302','18268','86416','43168',
                          '37479','90718','19052','45485','44871',
                          '83318','53428','82216','94764','73403',
                          '60263','37453','98806','14861','65385',
                          '89992','90456','62675','36454','83218',
                          '19106','19149','45244','99486','34216',
                          '80861','36896','33603','51101','89320',
                          '69652','26896','43971','43228','34372',
                          '19898','44480','32660','84125','22473',
                          '16129','55316','94564','21367','30702',
                          '83506','51053','57612','63139','33228',
                          '82776','94957','45853','58396','25793',
                          '44597','12037','92419','25282','30527',
                          '97704','32101','22272','34653','25518',
                          '59572','87539','38546','10560','12772',
                          '85204','27328','85418','85498','46952',
                          '22206','51099','18592','94739','92182',
                          '58714','45519','26391','59956','97764',
                          '95749','68646','12371','90321','85170',
                          '94545','21748','64475','20283','69955',
                          '84831','81756','28041','70510','41844',
                          '97447','94065','99684','23043','92443',
                          '79760','10281','88075','47638','38098',
                          '39634','93937','33835','19165','38224',
                          '27124','13299','73062','37862','20072',
                          '51899','20580','37302','15886','83394',
                          '21847','54326','38115','24598','71836',
                          '75867','45126','77695','95762','49694',
                          '94162','31112','59357','32221','55876',
                          '14153','19592','18160','19735','90095',
                          '11112','27444','43633','69433','94512',
                          '54606','22814','22333','96064','95527',
                          '40456','79513','29022','43148','77016',
                          '94246','16049','85857','79865','23455',
                          '20184','48301','70935','17310','49850',
                          '12838','84188','77231','82419','69762',
                          '88390','38249','72396','43573','79281',
                          '18061','45343','95019','22031','90056',
                          '15554','95763','64783','64277','25652',
                          '28587','59958','82814','18756','65290',
                          '82928','19108','61923','54376','31848',
                          '31936','39488','47446','79835','93874',
                          '64586','19068','11978','47504','28153',
                          '63485','28565','91986','66952','93235',
                          '62076','27195','53483','17284','38440',
                          '38003','36182','88922','54909','78566',
                          '51808','94221','94738','60073','37732',
                          '60752','41330','83421','57685','95100',
                          '26328','28939','15136','50797','30628',
                          '20527','53449','54001','54353')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


