
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '96188','86800','66635','80331','16517','44720',
                          '79841','80468','38517','26631','15775',
                          '80114','82933','43445','42175','31849',
                          '89867','13223','43926','48695','53908',
                          '10748','94714','19644','40846','10580',
                          '38995','82805','32336','25028','11108',
                          '55712','88909','28523','50812','50827',
                          '68958','28585','92908','26591','62839',
                          '13213','41051','27497','20546','97450',
                          '52845','55893','34548','55465','22790',
                          '70157','66784','20839','71883','71185',
                          '12262','64682','84029','33725','42729',
                          '33772','11141','67110','89800','50887',
                          '73988','53340','58018','42370','27922',
                          '19939','98523','72814','53366','96752',
                          '29359','98355','20666','67137','13220',
                          '47129','67962','38333','99704','35221',
                          '60547','88196','51701','13170','60203',
                          '20981','49946','14026','54382','68037',
                          '57754','95910','82134','80633','88547',
                          '32264','36748','58458','69828','10521',
                          '53173','83507','90035','74564','86293',
                          '60738','37554','34449','37646','27102',
                          '54418','92818','57741','52526','12126',
                          '79216','17916','68002','21407','46646',
                          '22847','76838','33256','75300','46361',
                          '92707','24963','92256','70862','93967',
                          '36955','31022','51648','17057','60605',
                          '89958','58060','50173','98579','23612',
                          '16571','81645','63963','97676','47786',
                          '86886','31015','28017','51748','31777',
                          '44487','39110','42563','37549','91110',
                          '42001','83095','72191','21739','70103',
                          '71053','81608','41620','75129','49458',
                          '61028','68757','10839','60559','22020',
                          '93888','20068','67243','39574','27575',
                          '44314','32200','89310','90742','68117',
                          '22927','54122','14242','11036','50365',
                          '64091','89845','24663','63900','19664',
                          '87200','21815','11549','73304','81459',
                          '28821','67288','87025','60381','95164',
                          '67271','19916','20941','43294','87461',
                          '53535','19824','98289','35462','31568',
                          '43024','49241','31691','69146','50993',
                          '64381','49947','40777','58623','61780',
                          '50861','33935','36387','91623','41353',
                          '95092','58403','36914','87230','57984',
                          '29956','56098','37451','56020','63512',
                          '20442','76756','91959','79960','84588',
                          '61567','93464','42919','79928','17785',
                          '77680','63404','90339','38090','64289',
                          '56859','53112','88052','79387','50460',
                          '66391','28809','90306','60927','57160',
                          '68726','77262','23218','92003','11140',
                          '82944','33723','56619','71123','44515',
                          '41826','51443','28772','81213','86660',
                          '98503','72094','51572','26979','76637',
                          '72251','76782','57424','40262','33141',
                          '27949','64003','78464','81509','38215',
                          '27597','31823','86580','96601','12338',
                          '24743','23202','53942','64435','22238',
                          '77020','20554','70302','23536','68060',
                          '22838','75534','61999','38701','76856',
                          '19751','23428','62760','14164','62819',
                          '27903','93574','93054','99175','89906',
                          '72533','96903','79834','93815','72807',
                          '78504','24288','78522','32002','38356',
                          '79174','56990','50328','10479','83699',
                          '55168','87874','62196','10497','90247',
                          '97705','24799','76239','11295','51301',
                          '80394','55484','55877','74419','62393',
                          '80676','73414','98041','58625','43711',
                          '25326','12293','21301','85285','70416',
                          '93131','33960','81286','21781','37613',
                          '70038','42026','33962','81458','34495',
                          '12346','93274','74981','93728','82404',
                          '10547','68185','63894','17073','86595',
                          '34397','97438','86845','72576','46412',
                          '97923','89094','52366','98201','45900',
                          '39405','77453','71884','18246')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


