
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '85655','62582','69156','89282','26303','64492',
                          '56175','93285','27296','75306','48927',
                          '80074','24793','53482','18741','61596',
                          '52720','69148','74494','85073','58822',
                          '11169','27715','83743','71178','83576',
                          '43617','17108','29937','39245','37248',
                          '88319','35579','30535','79227','97523',
                          '55705','33309','17479','11341','60390',
                          '85348','62441','36733','54247','98365',
                          '60249','42462','96848','77292','52558',
                          '26976','99058','62154','90103','47623',
                          '34689','32938','71948','32527','83065',
                          '60439','27299','99156','66971','75258',
                          '70291','75640','79736','93487','43390',
                          '24557','39134','24005','20803','18650',
                          '49484','96328','41606','98912','89094',
                          '75200','33771','60182','81928','90866',
                          '16508','77720','89011','92420','40386',
                          '15351','87532','54853','50751','46943',
                          '14845','33459','42330','94291','28985',
                          '46417','94793','39521','71225','30507',
                          '70242','85788','23969','87076','57090',
                          '81193','65871','84864','17687','62974',
                          '64517','33609','52997','81689','78052',
                          '97790','36707','56937','53071','39514',
                          '75884','77951','84222','11827','68149',
                          '25379','96692','49218','82699','38460',
                          '53395','67352','72734','46128','98493',
                          '22724','55256','28293','37715','74749',
                          '81425','77857','65990','67083','40318',
                          '32698','39111','33973','86669','33016',
                          '80507','81381','33110','53284','47717',
                          '24205','31794','41664','78421','70582',
                          '43458','38421','36818','86356','80210',
                          '92645','76048','81533','16781','81903',
                          '78622','50360','22462','91469','62171',
                          '60637','71052','52552','74803','79732',
                          '57744','98091','98648','21782','32901',
                          '38323','77654','19276','73293','14538',
                          '11117','36316','34544','65549','65568',
                          '37665','88317','85567','91473','82243',
                          '79447','98068','89514','42275','11972',
                          '24974','36858','71361','58232','45578',
                          '93332','78339','72419','16255','82342',
                          '55618','70308','38550','72481','25184',
                          '73582','65509','65348','65674','56463',
                          '12262','70491','16578','61502','17284',
                          '61424','47459','63966','71661','22665',
                          '21141','84484','31351','82609','69935',
                          '29286','61831','90570','59717','78539',
                          '73060','68025','53862','96957','11638',
                          '23720','68517','17329','26688','22232',
                          '58351','42129','61755','55189','18511',
                          '19142','86853','45286','69850','21353',
                          '97820','26487','92836','26041','76165',
                          '29522','44568','49497','72441','21683',
                          '45748','78952','98637','53732','51211',
                          '71068','80244','68315','10413','89880',
                          '60194','62627','18427','73968','13998',
                          '14930','36857','62136','12394','10158',
                          '46672','87945','63800','78551','54467',
                          '89869','98040','67923','47451','10397',
                          '42157','15112','72280','88100','27873',
                          '68895','61562','31906','74380','23897',
                          '79472','55418','83896','70974','44787',
                          '80365','11482','68562','99057','20883',
                          '16308','24574','85668','90588','30896',
                          '87184','22583','71131','19523','58344',
                          '41672','27107','51983','22843','53593',
                          '27559','99129','10563','53306','92339',
                          '42894','53702','69349','77985','49806',
                          '19284','84858','34309','61525','84275',
                          '10682','41084','98367','44274','70832',
                          '67848','74143','71926','69125','94868',
                          '98087','71490','57715','63239','18232',
                          '80430','68950','25540','70489','63791',
                          '70713','71774','30300','90549','59139',
                          '76146','88232','86774','11309','68917',
                          '59830','48087','80472','50095','83177',
                          '82611','88916','59517','85779')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


