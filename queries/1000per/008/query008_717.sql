
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '80696','52346','12529','97649','48673','97025',
                          '39575','41781','79706','31127','51115',
                          '37906','42889','75763','85057','59234',
                          '91933','25077','44137','29014','77410',
                          '75020','75998','77133','17895','31519',
                          '73525','53450','73512','69647','60011',
                          '66827','99214','25328','74205','29874',
                          '65289','30344','93511','88866','93797',
                          '79287','11788','44511','17598','49906',
                          '16462','65032','65326','88033','15630',
                          '11692','84897','43088','38074','95737',
                          '36204','97183','92968','48466','40952',
                          '85728','21681','56644','63693','29394',
                          '18223','57138','52619','56189','45907',
                          '83821','39964','15255','53968','53692',
                          '83365','73102','82809','99277','14675',
                          '26648','22888','65922','99565','68113',
                          '52702','98844','16991','21742','64744',
                          '57442','71375','72323','91720','54392',
                          '59165','82505','37793','32759','34678',
                          '55945','46397','38959','83277','52054',
                          '75124','93984','68806','10717','97912',
                          '62274','24437','38890','35252','65770',
                          '93353','69676','83930','74334','78712',
                          '18054','61250','94536','45511','78355',
                          '14355','29676','16825','89315','70941',
                          '86183','40792','72792','22837','46961',
                          '26496','95668','53700','98708','73315',
                          '50960','73987','55923','14226','42057',
                          '74253','20739','62151','59110','77116',
                          '48563','44588','24447','96007','80139',
                          '28910','62455','72229','29885','27015',
                          '92376','20631','28776','51923','65435',
                          '43810','70404','62881','51296','18033',
                          '34345','85048','63418','10473','55807',
                          '43704','97359','52887','90677','80236',
                          '88972','92987','56297','93309','97866',
                          '61394','79285','83943','36655','76947',
                          '28923','59842','84926','89255','10336',
                          '97530','67341','63942','40992','77563',
                          '23606','61327','10636','23288','64258',
                          '37253','14809','45149','60566','14749',
                          '81400','31997','12871','29974','25394',
                          '52497','46689','44118','54844','22968',
                          '77615','78098','72584','64493','57844',
                          '89584','68898','76937','58236','35725',
                          '99316','39625','92674','37263','33966',
                          '14755','56894','77151','31036','16604',
                          '56093','46093','35503','55362','80602',
                          '10743','96923','64838','65929','62316',
                          '56837','75227','31360','32448','90244',
                          '17380','40540','42916','76590','56391',
                          '67517','82704','72969','10035','53352',
                          '38992','78495','72646','40781','76473',
                          '97041','67536','93049','80416','75350',
                          '62669','27820','74460','99745','45258',
                          '59309','26002','65329','44447','26597',
                          '35234','10703','63935','47772','84539',
                          '61738','69261','50634','93325','33996',
                          '31641','91499','94056','71256','39480',
                          '91330','60934','49467','73268','10574',
                          '97119','96550','86145','27549','91157',
                          '57920','80254','82843','63678','54842',
                          '49756','59274','70142','93017','67484',
                          '60175','30234','14823','64255','32811',
                          '92657','85350','78654','67524','63316',
                          '48450','89897','81780','79655','13394',
                          '23801','66946','58325','65506','19916',
                          '35756','74024','11784','30753','10863',
                          '82746','13139','90342','27728','49573',
                          '28324','63889','17789','64617','83983',
                          '34397','30303','46522','35946','34898',
                          '81751','89206','98227','52001','58181',
                          '16533','69359','38776','36443','37811',
                          '40611','94072','45644','15168','99418',
                          '40075','94737','47291','84783','30595',
                          '39430','88105','91732','76511','20157',
                          '79208','80214','74858','24838','38630',
                          '11370','79045','96184','51536','41246',
                          '23026','32470','90217','43995')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


