
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '44242','41990','61635','61474','15154','36955',
                          '81852','83214','15178','46688','22095',
                          '31350','95815','39414','12522','17930',
                          '78541','73743','56620','79874','40397',
                          '67373','49069','80333','95743','35997',
                          '52408','18389','70980','95000','23359',
                          '63436','53063','81918','21788','85107',
                          '53984','92147','90674','99532','78265',
                          '80656','41477','74038','60660','46924',
                          '15471','73686','17423','51102','54819',
                          '14049','58151','53793','65067','63619',
                          '12374','85092','17263','73390','39526',
                          '21209','31895','63459','14063','89557',
                          '63735','52898','56402','27393','35532',
                          '19111','35410','32780','51664','38042',
                          '26597','89773','75379','21126','26159',
                          '88605','53508','86372','49783','52148',
                          '68072','93931','61238','36338','86963',
                          '92199','58586','60630','24661','17488',
                          '49812','66442','79425','30161','68514',
                          '78765','20915','30089','44950','59224',
                          '15027','34240','52333','99249','15046',
                          '40972','54798','46214','67374','53430',
                          '48626','43670','63492','68394','12673',
                          '73347','13226','32984','37186','47701',
                          '64303','34934','62591','94672','35235',
                          '89186','91332','59844','19154','65895',
                          '78224','47110','77592','91184','82474',
                          '51305','48650','63341','64749','39766',
                          '43571','54174','21497','68091','21615',
                          '82484','44759','68559','29498','67563',
                          '91283','80371','40841','68480','18404',
                          '81264','37243','32320','41484','88399',
                          '31353','21907','90560','22107','58401',
                          '33765','30359','58246','66314','57492',
                          '61649','78771','13018','91993','26676',
                          '23434','80872','87547','85038','42642',
                          '91287','28808','12969','91548','56061',
                          '60709','87000','42623','16871','93320',
                          '76291','71778','83512','74422','63969',
                          '85747','20587','64306','55619','96277',
                          '33652','83515','58937','75032','97437',
                          '94249','93372','79746','75263','21360',
                          '94389','25259','56733','49900','18660',
                          '95449','74395','33624','53909','53461',
                          '43984','83258','54842','50942','51017',
                          '37043','52207','15282','41988','97346',
                          '60122','20221','91628','89945','77677',
                          '78926','44106','96230','98620','38501',
                          '94285','28816','32893','51523','99684',
                          '52860','74526','31060','58010','44672',
                          '50630','29450','54649','70733','76032',
                          '41331','12366','96244','28473','70956',
                          '31331','94500','53391','30059','97688',
                          '34328','84429','40799','49178','67656',
                          '78675','86153','93935','11923','36187',
                          '40421','86246','18376','15902','24365',
                          '35302','92531','22995','25997','22780',
                          '91550','16043','28920','60671','53239',
                          '85843','81944','47702','98941','78890',
                          '38841','34490','38162','67131','20551',
                          '74770','34393','73380','50510','90346',
                          '22509','90319','89082','34847','97995',
                          '39329','82901','46936','93712','63349',
                          '75484','78497','49730','85261','40102',
                          '56246','38179','92038','87189','16846',
                          '46841','88615','81457','32905','77666',
                          '87434','89708','50757','72296','99205',
                          '91172','43867','18816','24501','59176',
                          '72831','53305','10696','83287','12403',
                          '17762','36941','52973','30649','27789',
                          '45531','61520','87088','25093','44692',
                          '88453','21105','94215','42013','31969',
                          '23781','80428','25700','41196','98167',
                          '38299','66353','92985','77363','39709',
                          '12197','55168','18030','22736','94259',
                          '88562','74508','62838','39923','63987',
                          '20760','73914','32577','31833','80669',
                          '21445','47192','66179','36533','77314',
                          '25586','24477','83319','98916')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


