
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '74781','22855','47577','91641','14516','52504',
                          '41718','44289','60547','72185','68696',
                          '58807','82866','21877','20884','24527',
                          '83853','60416','49718','77508','31376',
                          '48301','85293','99481','66154','28201',
                          '49783','97543','37397','82177','20229',
                          '17782','11727','49330','13893','49982',
                          '85249','49247','79040','89845','51140',
                          '21567','54925','11315','93459','67835',
                          '53743','94710','14377','10472','12390',
                          '82684','63555','31637','91318','38721',
                          '56638','33338','65237','73011','76632',
                          '73669','25122','56407','84529','10366',
                          '67520','47760','37615','31184','23277',
                          '44971','87431','75355','66399','28942',
                          '50082','31397','88327','36324','60010',
                          '34240','88152','59429','80488','50701',
                          '54037','63304','43442','47784','71962',
                          '69176','40048','36667','26737','69415',
                          '49823','15285','38460','18854','46487',
                          '33651','69576','64661','71407','67771',
                          '20933','52309','78590','10995','78185',
                          '50162','86674','97987','63189','48067',
                          '29068','11421','87543','27431','37953',
                          '65581','16817','10175','50740','15947',
                          '74031','25626','40514','35732','21428',
                          '30378','87615','82602','18133','78096',
                          '99715','81810','64348','48440','93937',
                          '79254','73346','46496','75537','93463',
                          '42912','63015','16098','71098','14986',
                          '44197','95939','30919','60411','32388',
                          '79183','38994','19365','62135','11311',
                          '47124','89673','63596','82871','88480',
                          '92450','80918','72078','36588','90538',
                          '12345','67064','23504','12453','18546',
                          '74313','99447','12255','89555','30423',
                          '49031','79386','12264','28239','12303',
                          '57554','98791','39938','38081','19232',
                          '70113','79054','95033','17221','21785',
                          '37626','10785','46121','12097','81991',
                          '45767','41982','22061','28391','33702',
                          '71143','20868','86320','57412','61717',
                          '59038','13554','77489','97919','71572',
                          '67701','12828','19709','47252','65823',
                          '23728','85934','68876','98228','61975',
                          '47980','20921','24099','90792','57797',
                          '92999','98261','63347','78930','61440',
                          '38275','51989','20247','20339','51320',
                          '60455','17248','29121','43685','63508',
                          '94731','45613','75119','13871','86456',
                          '16815','53660','37431','46260','14548',
                          '79678','38403','65123','47575','50188',
                          '41444','92507','23890','36692','80991',
                          '63921','78896','15900','64912','48333',
                          '51435','60219','19024','77717','78479',
                          '46629','26762','63354','94942','81380',
                          '90917','16502','83953','42560','21616',
                          '72814','15259','16088','64375','90119',
                          '64301','95958','29475','29032','91649',
                          '43818','66145','50297','70685','20898',
                          '79050','26977','30775','53473','95485',
                          '46544','54633','81450','24109','42642',
                          '17034','56940','46031','34532','96834',
                          '71248','96915','62147','85027','54117',
                          '93421','25869','79790','54766','75993',
                          '59856','26979','94342','39030','22132',
                          '34383','90109','28393','97442','73643',
                          '99356','95405','93985','39468','65677',
                          '78759','16739','41212','52317','96943',
                          '83699','64759','82957','74728','94179',
                          '27436','64039','24185','88221','58510',
                          '24938','29948','74947','35348','45550',
                          '55798','66368','59672','55692','18155',
                          '55961','97271','58327','24062','32118',
                          '76940','62475','92332','30395','62870',
                          '79310','18739','25595','26900','23787',
                          '48130','77036','92275','68928','30054',
                          '25939','60892','80678','72732','43499',
                          '49876','79224','32933','62610','29434',
                          '42972','49495','39616','78070')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


