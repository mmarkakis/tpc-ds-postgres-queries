
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '97778','93758','30625','33559','86170','70277',
                          '12042','74390','91324','34603','59003',
                          '25321','61026','89138','21152','75613',
                          '65279','89850','73369','70723','77440',
                          '72637','43694','84772','45889','19478',
                          '43634','10671','16707','89227','40600',
                          '11235','43573','27591','68883','18314',
                          '75889','26594','68034','40002','27747',
                          '64995','54804','26849','94250','11282',
                          '80041','85960','65238','22958','68979',
                          '58205','19830','89014','25531','17312',
                          '95457','38728','94014','90615','92794',
                          '84680','20463','72872','91953','50386',
                          '61415','52014','25339','38368','49468',
                          '27579','58231','45284','62738','21036',
                          '79084','88383','43356','88956','99137',
                          '19216','47235','22181','99119','45326',
                          '44732','18238','78826','64904','83379',
                          '60272','47978','33873','21901','35126',
                          '62594','69754','83490','60584','95321',
                          '48895','55507','59883','24207','60672',
                          '12646','60266','95518','32633','65943',
                          '88859','42627','99173','21641','96058',
                          '52708','26720','97054','59649','39732',
                          '80861','11768','67196','18353','78243',
                          '66817','80398','74767','52621','92728',
                          '85163','69301','39289','67075','36207',
                          '57207','68352','44103','45968','22683',
                          '66395','76315','20754','25815','72358',
                          '42797','60949','14692','14158','76045',
                          '43988','39143','25753','56329','71413',
                          '12851','66313','12349','55196','36259',
                          '18747','37719','50347','40454','78037',
                          '52830','63940','46559','31863','99920',
                          '74733','83247','58435','86151','26094',
                          '95990','26640','43102','27476','24800',
                          '34033','35459','86123','47149','72962',
                          '56266','78090','22687','75510','67407',
                          '93723','82727','86282','59812','28691',
                          '53400','63072','50888','37823','94361',
                          '65836','73100','48324','33795','42727',
                          '71824','76219','45926','14285','18095',
                          '64353','90536','63595','92564','21117',
                          '91670','10111','31906','23263','54457',
                          '75675','70267','22837','66992','96298',
                          '89167','79858','37533','59761','86185',
                          '29130','29425','75476','78895','57597',
                          '99622','25089','19844','45119','93930',
                          '28268','68586','61324','16785','75100',
                          '74543','78613','25266','66753','36046',
                          '87604','58226','71270','60571','32409',
                          '98953','82410','90484','67701','23877',
                          '72774','11586','60281','98073','81280',
                          '96901','89909','64953','28184','27464',
                          '21735','55414','66173','62966','48715',
                          '19362','90063','57895','22453','85242',
                          '70354','74070','40155','66013','83176',
                          '23163','75351','24407','83774','13723',
                          '21330','80713','76427','41153','50896',
                          '67561','15178','73111','93683','75308',
                          '78977','87854','44790','59322','91574',
                          '46547','29704','30124','60338','64611',
                          '81171','92373','79668','74996','35522',
                          '82829','37605','36162','68269','80354',
                          '85835','20320','91849','26307','23184',
                          '23293','78233','79974','77227','66367',
                          '28002','36526','26665','95644','55802',
                          '27242','77696','69701','82863','53178',
                          '70353','31560','70521','62265','23946',
                          '82744','42249','72274','73184','67542',
                          '14526','80353','86734','25155','91038',
                          '75950','51680','80796','55389','55012',
                          '57890','71150','63978','56900','51489',
                          '13585','33024','26328','59415','50106',
                          '61942','16424','75764','99285','96410',
                          '31172','13717','69459','31787','95346',
                          '49414','66858','16221','11608','30713',
                          '62950','47303','50249','54253','95268',
                          '98143','50503','50836','83266','85748',
                          '42961','45815','75012','18444')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


