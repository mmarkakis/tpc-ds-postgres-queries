
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '36996','73150','66608','78421','41900','62380',
                          '83112','76488','93159','94833','36382',
                          '35719','62381','77656','16779','92122',
                          '47721','52004','11848','14571','83782',
                          '39620','95832','98022','97554','57434',
                          '38301','54786','56119','60185','15075',
                          '70368','23862','88539','37443','16192',
                          '66964','99429','32261','13109','41773',
                          '17274','60388','46120','51580','59054',
                          '22356','63598','26306','30052','95405',
                          '96093','17094','99990','65358','36398',
                          '25991','63136','83524','96634','77205',
                          '55293','27422','26264','60903','50266',
                          '90058','68853','65947','67269','55620',
                          '34006','97315','79382','26858','29156',
                          '86004','10741','66668','70272','22865',
                          '73269','45551','37842','72410','54440',
                          '22930','70020','54975','76639','80394',
                          '70720','39826','24279','29325','80050',
                          '70711','53830','92764','74388','80511',
                          '79297','69812','53294','56876','53591',
                          '92691','43519','82037','96224','24852',
                          '10351','32248','22036','67183','98935',
                          '92411','64438','24499','27613','91625',
                          '53343','20755','82309','89981','19933',
                          '79946','75641','54755','79537','86353',
                          '62668','17215','16327','64980','67730',
                          '34259','22731','91227','24528','93264',
                          '57356','44124','61958','54953','11675',
                          '34043','34384','45049','66217','90045',
                          '22823','67833','12756','39587','38636',
                          '56325','29891','94906','88763','53412',
                          '79953','48817','87263','44019','91277',
                          '27412','79168','27346','24723','83877',
                          '81454','58119','73725','17963','60361',
                          '15842','51410','52555','74808','23075',
                          '93884','59988','54591','97095','16529',
                          '49711','78848','49430','18054','37572',
                          '82927','78535','96912','34918','47902',
                          '46462','66923','15903','63345','51494',
                          '86662','95700','71851','44064','63826',
                          '92065','89025','25356','98454','19517',
                          '79086','91981','11757','60953','31176',
                          '70249','53193','42770','16730','21158',
                          '51032','21657','60309','48137','60874',
                          '92571','75332','39690','83263','79329',
                          '75458','64062','20962','11582','96309',
                          '82715','54985','10405','91655','71083',
                          '41829','33430','22618','52219','67877',
                          '39062','11598','41185','52903','24292',
                          '17142','77857','16565','24468','59900',
                          '88901','88553','41331','84691','61619',
                          '76657','98047','61508','81360','34731',
                          '43245','86124','25178','13988','47194',
                          '64491','58406','46664','17521','20884',
                          '94607','60136','18888','12464','11955',
                          '84022','30077','87348','29005','27920',
                          '53198','18767','81836','91763','88665',
                          '47769','89258','28549','37338','82833',
                          '54994','36429','23606','99561','68203',
                          '21596','65236','21399','29320','40224',
                          '49305','80969','66496','73589','25682',
                          '98210','67392','68043','58692','42743',
                          '13553','70644','88889','19583','76136',
                          '35991','54274','26825','79009','47526',
                          '38245','60229','39991','36934','77733',
                          '85573','96544','26470','79496','96117',
                          '77337','38718','38989','16508','25306',
                          '97256','98003','41463','88582','52389',
                          '99934','13946','82614','25741','72139',
                          '40492','52127','96993','39450','33568',
                          '44447','60609','47796','14198','80693',
                          '11485','25441','58273','49695','39929',
                          '24741','77350','27249','97037','82516',
                          '26081','23417','61507','81093','86667',
                          '25238','46076','22574','49800','96430',
                          '63820','94083','86793','64264','68156',
                          '77609','78412','86611','62164','19782',
                          '69960','60952','58357','90960','93095',
                          '43132','34406','50736','84468')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


