
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '25480','37165','20857','65644','39938','88290',
                          '21113','70313','11923','30288','11834',
                          '58136','82790','14194','91842','57470',
                          '55344','66832','81463','84801','76583',
                          '73104','63509','12818','11349','92129',
                          '24088','73194','52425','65381','40316',
                          '65305','13128','37527','33545','46103',
                          '91414','37119','99802','84809','59900',
                          '48920','26218','26035','34621','66211',
                          '64583','72720','55514','70173','42227',
                          '16520','15488','34776','63034','49553',
                          '50818','61475','57274','16603','96963',
                          '29367','38936','23455','62115','40302',
                          '50858','25306','35488','24895','47530',
                          '74967','56315','39356','39339','48088',
                          '99125','89645','44901','33782','19908',
                          '72406','24532','42742','95759','22056',
                          '13218','29000','98199','43506','43590',
                          '64260','27211','75127','29607','65130',
                          '92247','42807','22245','73575','58880',
                          '55722','37681','98578','33858','81965',
                          '59189','32050','28013','54838','16470',
                          '19899','42438','89490','62034','60945',
                          '99269','73622','30527','44701','82496',
                          '71564','37702','70938','79870','79624',
                          '76350','89593','41267','78999','18062',
                          '96320','41036','73338','55929','80482',
                          '25797','30269','46277','42153','77046',
                          '95864','75154','12390','40617','73846',
                          '83426','45725','63105','40313','37118',
                          '20338','30088','24428','39169','53340',
                          '95523','97383','28226','14249','14811',
                          '40838','36358','43086','98314','23039',
                          '11081','54769','37243','80587','96508',
                          '37340','84606','59375','18548','12761',
                          '59170','33095','61933','87841','47678',
                          '41893','73023','61085','99071','92926',
                          '88888','64346','14763','22871','75054',
                          '50580','74264','93098','93036','32328',
                          '81088','59374','98034','10039','90628',
                          '18353','75464','25819','23164','79539',
                          '29266','79812','37643','80263','96706',
                          '84236','61964','36206','63069','50379',
                          '24899','26808','22918','82070','56253',
                          '94238','77366','12184','55465','21086',
                          '69783','62866','92397','31543','83568',
                          '26106','95157','82266','25300','29975',
                          '62253','12455','50161','31692','48848',
                          '89417','18806','57761','27488','15486',
                          '82891','36711','18126','31135','22044',
                          '10276','79156','47236','55698','80033',
                          '20669','94478','14856','35218','59801',
                          '12579','96357','58793','14967','86574',
                          '73112','62461','42633','82113','94305',
                          '67568','16721','67654','50245','29679',
                          '64184','61428','22590','23587','93090',
                          '65441','88756','65006','56804','29392',
                          '84107','65288','48361','14765','39069',
                          '33062','67384','18109','16534','91946',
                          '22011','57746','72931','62757','85089',
                          '20860','97762','92932','73065','52346',
                          '43608','47376','38006','63796','22766',
                          '57513','24508','28371','11359','45641',
                          '60010','95150','36099','25947','19063',
                          '59451','48120','39885','93912','71142',
                          '71534','14531','27253','38084','49375',
                          '41131','17068','31677','64817','41919',
                          '11985','30621','67087','58113','20910',
                          '15994','68906','61249','77248','44050',
                          '52747','84287','23219','36908','17147',
                          '11484','46153','33383','18336','32689',
                          '38458','26448','56778','85733','22467',
                          '50548','53589','84875','70050','76890',
                          '18659','66288','63467','87701','34570',
                          '37951','50227','56035','83332','49608',
                          '92785','40246','39115','95033','87623',
                          '32636','18760','81391','12136','26793',
                          '84817','10719','19031','20836','38734',
                          '27408','59482','16021','12050','37733',
                          '13227','34178','36427','26772')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


