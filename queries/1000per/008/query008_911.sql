
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '90533','12031','24853','68171','42271','26448',
                          '87035','55490','20151','10859','13058',
                          '19617','45592','98005','14208','16611',
                          '70806','22523','62171','57933','85507',
                          '11208','71704','17307','20063','32206',
                          '82019','24594','99501','61074','90904',
                          '26352','20459','10641','76525','76686',
                          '31728','75041','50384','73326','40867',
                          '87966','96911','21882','12083','62567',
                          '87657','67634','61995','96265','13673',
                          '81273','71621','75201','55801','20753',
                          '92532','43787','36931','55221','52615',
                          '84037','38080','31571','45955','68174',
                          '34832','68353','88173','41375','85351',
                          '59039','12117','85170','57251','71559',
                          '56751','97728','73688','38111','41001',
                          '76181','80690','22390','71131','81246',
                          '75026','39655','11560','26535','23765',
                          '84417','15074','45725','17425','54174',
                          '49911','29236','54781','57235','50465',
                          '78599','53695','34358','42946','70265',
                          '18425','84241','11542','82657','67350',
                          '56722','79207','74089','38059','78200',
                          '39546','99416','31525','62046','62923',
                          '40159','27171','79792','76716','28193',
                          '72299','83300','17645','53480','74057',
                          '54598','95003','16212','56123','75817',
                          '65035','72180','64224','19684','99191',
                          '19673','77903','28359','74361','59960',
                          '48016','61807','47797','76660','53329',
                          '95425','40168','81239','44253','83172',
                          '43085','28261','43844','37154','15844',
                          '82995','33529','50898','54753','96697',
                          '87227','68721','58130','53203','50412',
                          '22572','27329','41662','84314','14380',
                          '30180','91222','49905','12937','60139',
                          '78999','74525','41220','18143','42512',
                          '39877','42507','18252','87562','80909',
                          '31457','18335','46535','73162','27517',
                          '15708','74863','21912','47861','53874',
                          '38092','36601','57529','58824','91343',
                          '29892','16257','92891','44694','57802',
                          '30799','13051','27305','75384','53376',
                          '66601','53175','14762','24581','25431',
                          '28891','73200','56752','37605','35552',
                          '38504','97731','43586','89248','92287',
                          '83094','15338','80748','28229','81599',
                          '35879','27339','25533','36432','96960',
                          '55506','73024','25893','84528','34821',
                          '70278','96542','82782','39452','58607',
                          '82640','15120','65519','10410','19241',
                          '37350','32034','16942','83124','80705',
                          '93016','83575','25776','22915','42687',
                          '83002','26768','76685','53391','62445',
                          '21329','72941','24258','79657','38928',
                          '19813','95595','53370','60503','26450',
                          '15076','27439','51095','71940','19565',
                          '21230','74052','29653','54222','77977',
                          '60331','76299','58120','79539','83619',
                          '49146','69512','31405','89771','10855',
                          '38034','39721','56205','49986','50026',
                          '70522','98800','59560','98563','91892',
                          '74535','39415','64269','39587','14039',
                          '63308','76385','55398','78028','80345',
                          '57797','54050','57602','20299','27248',
                          '54070','66598','66928','60928','94005',
                          '61904','25320','78226','34487','52007',
                          '96018','95143','32822','10716','37322',
                          '13939','65208','45428','96887','66776',
                          '90549','73839','53052','99821','81620',
                          '62482','75972','74044','60982','65283',
                          '68651','36952','68934','96551','83833',
                          '42180','23031','71687','76940','27941',
                          '36481','12714','56303','36589','96181',
                          '74166','71163','98280','38250','61587',
                          '39108','29394','69190','40365','55608',
                          '87317','47244','24167','84100','18410',
                          '20615','14863','72032','86919','70919',
                          '99727','72058','27222','63630','69384',
                          '87982','21184','46393','88430')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


