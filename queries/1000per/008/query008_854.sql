
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '44335','25487','38247','41688','43414','59692',
                          '43095','44350','31520','89447','32341',
                          '15641','58921','30722','30338','20208',
                          '10274','62058','98747','94074','47678',
                          '64587','20371','98822','88355','50108',
                          '29790','71054','18466','76017','15927',
                          '69983','32738','27206','74698','98738',
                          '17761','79551','68554','57568','65064',
                          '46227','93502','87395','71481','89793',
                          '43158','75263','35765','75424','97865',
                          '83722','57822','81059','53356','36470',
                          '88404','18139','40041','13706','51891',
                          '95845','57653','14896','86402','76772',
                          '52344','79056','64000','63528','99004',
                          '86590','64607','48671','75002','74990',
                          '99698','45105','26174','84670','52131',
                          '86415','70805','77381','68590','66423',
                          '20770','94797','27147','20667','62868',
                          '45608','65023','15277','62835','20635',
                          '11095','13895','15072','64361','72415',
                          '74183','77097','97628','73618','87518',
                          '56546','65894','16151','88625','18177',
                          '17871','70106','69938','18405','55932',
                          '99973','88638','33773','85888','33387',
                          '87164','39636','79287','77758','82480',
                          '99498','52494','50359','28184','61458',
                          '13625','94427','71136','20678','87589',
                          '79974','34810','70268','92337','58606',
                          '88679','30735','18142','53685','51336',
                          '35509','34121','54229','48818','80323',
                          '21430','84077','22203','89419','93798',
                          '39856','53770','92122','29693','51749',
                          '92079','56582','83865','14716','82423',
                          '71550','24440','82327','22156','98796',
                          '58207','91925','17257','66013','93762',
                          '49458','37240','67450','85457','90489',
                          '43780','86520','91359','27216','90313',
                          '28523','27533','61342','66803','48333',
                          '35121','64790','97314','65868','46415',
                          '38717','31597','94213','90918','61429',
                          '43656','88148','41424','73321','75649',
                          '97853','50850','84265','83525','77115',
                          '96315','76360','61820','11352','95181',
                          '68785','44609','25883','30073','86336',
                          '41754','31170','94306','48654','74283',
                          '36509','69363','78994','18073','20604',
                          '24784','27585','72038','19556','48578',
                          '75740','39184','91975','63544','94670',
                          '65176','12911','37323','38489','46286',
                          '17253','74478','80243','46428','53912',
                          '66328','76608','91250','49150','92302',
                          '54597','26192','60498','48018','68668',
                          '28321','80775','77597','31348','11641',
                          '77726','67275','67372','11129','72907',
                          '99079','53351','68952','58100','92617',
                          '88200','74863','51762','97665','89300',
                          '16015','85509','63363','49304','67875',
                          '49731','86206','31618','74701','94657',
                          '41935','88935','17356','58098','35018',
                          '45233','65348','11582','91376','87500',
                          '42730','71385','57333','64381','40459',
                          '74855','67200','43139','93397','98185',
                          '77239','10128','93186','45724','15162',
                          '89328','17131','76350','56555','16081',
                          '97041','33730','57427','23639','66474',
                          '93249','37851','97501','17903','40712',
                          '89774','94459','83339','47467','48133',
                          '61902','41746','19079','67228','67873',
                          '89846','39590','11933','62828','73066',
                          '80329','56237','69304','31666','84079',
                          '97818','77935','13623','28783','66178',
                          '90624','90571','91941','11693','63553',
                          '94084','79659','42754','41526','79876',
                          '79469','78210','27558','49134','24873',
                          '38774','60000','16848','46659','61463',
                          '67434','89598','89329','84674','11964',
                          '32254','41298','67773','20011','89706',
                          '73250','42545','83873','96799','31981',
                          '42387','43263','79923','73433','87815',
                          '98691','82508','41066','65975')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


