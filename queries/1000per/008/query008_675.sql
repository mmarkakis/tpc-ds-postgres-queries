
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '23182','50891','26150','18852','10615','35357',
                          '13044','93035','41984','22342','27771',
                          '62469','53947','96262','12222','12226',
                          '29659','68838','89618','78789','87713',
                          '24634','74135','14262','66238','59934',
                          '26457','46540','14887','61377','61715',
                          '65462','23346','43860','74844','45503',
                          '44364','34306','20931','96040','13402',
                          '95794','58282','24743','20067','48124',
                          '13428','69836','60724','61145','68214',
                          '90915','98155','21532','59073','53748',
                          '10410','32457','61245','35954','23240',
                          '66009','21075','78016','76832','56782',
                          '45951','12074','30611','68642','86069',
                          '31445','91150','61963','50947','66420',
                          '67152','86055','21834','73117','71653',
                          '52664','39061','93189','50903','12499',
                          '80390','72544','36108','58021','40879',
                          '81011','68906','19361','12474','58295',
                          '32862','92617','29365','10133','28311',
                          '81965','52718','96287','79953','72984',
                          '72977','31773','57917','75618','81874',
                          '99918','65315','23154','67869','48222',
                          '28226','93529','84640','11366','49727',
                          '51449','97834','55082','51024','77722',
                          '49960','75099','37772','34727','44431',
                          '22450','42779','88359','36861','74423',
                          '21812','78051','12542','54231','93498',
                          '25743','27929','30117','84829','28395',
                          '45202','85402','83417','10506','92533',
                          '40603','96049','37487','62928','35908',
                          '62471','80037','42851','17612','75644',
                          '82384','99205','42417','51773','86321',
                          '96842','38365','20575','99452','11084',
                          '82129','97195','64677','47820','21085',
                          '61694','74972','14819','45977','37358',
                          '18460','46881','22607','27478','79197',
                          '49909','53094','97249','34888','60434',
                          '12435','46527','20651','48072','15627',
                          '33484','67010','45774','23417','75488',
                          '10795','15463','74095','86569','84683',
                          '86368','82955','60510','57303','13555',
                          '37161','34838','71389','27377','89760',
                          '64754','70857','50632','14056','74010',
                          '86217','46880','23386','47999','55646',
                          '91407','29030','15046','42353','44588',
                          '81139','94814','23688','75272','90816',
                          '34263','96794','88643','45029','72839',
                          '51918','37098','21873','31501','43116',
                          '39833','50935','92671','63362','58390',
                          '90617','39647','23835','58787','73106',
                          '25914','34287','29648','14593','43092',
                          '19601','72106','96909','12115','83663',
                          '55901','59352','83102','78699','15034',
                          '64478','83491','23683','35786','98422',
                          '77428','26250','51903','58956','27248',
                          '23806','45619','71335','26950','98816',
                          '86162','82284','55528','98484','36516',
                          '51495','55740','85618','96932','47375',
                          '22523','67172','50803','89077','42288',
                          '49330','70220','48871','91294','55029',
                          '93314','69677','70783','15467','55261',
                          '58001','26655','71112','60940','22133',
                          '32411','35679','58996','32383','86365',
                          '26749','56420','75956','48262','89915',
                          '77444','31637','43176','56317','36754',
                          '19336','96604','85329','93199','51346',
                          '17655','65518','19341','93965','50772',
                          '86997','46412','64469','89950','34084',
                          '81954','48398','74494','66120','24179',
                          '40869','66925','95390','99140','81771',
                          '62195','21514','87492','44102','16913',
                          '40108','55243','33160','60563','87398',
                          '30300','55040','62848','91132','92412',
                          '15112','91465','27593','55943','38383',
                          '70290','25706','11101','94303','30230',
                          '61372','84712','44956','74882','17271',
                          '43039','54479','62886','29192','76186',
                          '59148','29890','58230','54940','15907',
                          '65176','36141','51640','26905')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


