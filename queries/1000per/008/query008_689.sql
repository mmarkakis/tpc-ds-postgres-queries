
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '76056','59925','97414','39255','50801','82826',
                          '76477','89071','46066','69881','66077',
                          '18662','32933','27074','23591','23782',
                          '16410','87105','98293','18659','27768',
                          '33851','13983','18762','54669','12105',
                          '59149','69370','72905','22592','73541',
                          '13196','31497','71758','67251','28945',
                          '19515','11754','14105','31955','63837',
                          '97805','23526','39856','70283','38698',
                          '30862','67665','52643','76228','31929',
                          '11543','83842','46953','99059','83647',
                          '24763','46717','90963','86928','98069',
                          '52134','72881','92694','11156','52525',
                          '60845','14082','35699','13685','61906',
                          '43293','48380','59202','32142','22584',
                          '28633','60312','78676','78198','95481',
                          '42525','58600','55812','54316','90298',
                          '36364','16986','47135','15105','11915',
                          '91539','72621','55674','30331','50233',
                          '13705','20877','30744','48477','43124',
                          '55778','45707','81260','84176','19504',
                          '95268','97843','65875','57442','94371',
                          '75252','10179','77378','32893','98310',
                          '99083','98237','26899','77659','78945',
                          '91685','87920','82436','12580','83268',
                          '45369','12358','58689','11042','35978',
                          '10303','77062','53204','70730','37685',
                          '90291','90665','99653','42701','33465',
                          '19355','23468','99634','97872','85930',
                          '65613','53185','14791','21126','56726',
                          '12734','80177','31425','26127','40296',
                          '69136','67957','91718','86028','35103',
                          '21072','54408','94063','49094','73326',
                          '89779','18004','30078','84508','28801',
                          '30309','63763','32883','58312','11357',
                          '37648','69356','79157','44076','62995',
                          '41946','62080','84866','40686','60357',
                          '49138','39086','65790','91609','19982',
                          '96165','70034','21866','68042','72287',
                          '53109','62323','90354','93154','20366',
                          '64344','28372','75472','10541','73482',
                          '58212','77690','32970','18255','26467',
                          '22050','74302','31807','18733','57252',
                          '60257','16388','96444','28627','57469',
                          '28138','67786','23831','87146','22942',
                          '35097','62455','82605','30894','55155',
                          '70418','53451','48414','75757','89204',
                          '60761','21123','77246','48544','79137',
                          '41866','61192','32323','78172','86769',
                          '24066','32836','97510','89925','11666',
                          '92407','53361','11365','39499','79029',
                          '34269','22742','31007','87095','88913',
                          '16145','10516','87641','75879','97254',
                          '33360','56218','28698','89035','14216',
                          '54511','31191','65635','83635','23268',
                          '14590','54106','57490','22240','50960',
                          '44813','21905','92216','71894','52166',
                          '41133','15297','30648','36176','17501',
                          '52878','50661','95980','80092','41463',
                          '19704','99175','75404','20227','66428',
                          '33560','85236','81746','54755','27019',
                          '72788','76314','94225','53802','35725',
                          '70865','89620','77868','55473','89713',
                          '37436','86032','32350','52831','13571',
                          '17605','46681','93537','69195','65024',
                          '57259','17568','39510','52446','92951',
                          '85546','57848','65538','22320','10982',
                          '53571','25601','55997','73817','17102',
                          '62791','75146','22717','22128','49365',
                          '25689','11179','98584','37902','57553',
                          '88310','52586','78933','71981','49616',
                          '43970','61778','14559','82479','40628',
                          '27325','71401','25519','20109','81272',
                          '21410','72681','49720','97142','13636',
                          '87966','15390','72646','58929','81187',
                          '40298','76883','10756','40341','85485',
                          '33913','83605','48436','69324','98859',
                          '20220','22433','91791','96158','31808',
                          '86202','65234','32269','14141','38591',
                          '89120','15552','76656','56335')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


