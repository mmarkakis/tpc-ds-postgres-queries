
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '94322','21648','18101','73633','36499','99822',
                          '10751','12330','81621','39455','30095',
                          '39225','59693','65817','65516','44556',
                          '28248','51109','34840','94340','21020',
                          '76172','46673','26704','16061','54959',
                          '90286','70593','19636','74472','20543',
                          '57810','29457','57265','51350','31855',
                          '88499','61966','38476','32944','76144',
                          '69163','38548','32398','84330','25795',
                          '43044','11537','62806','41356','24897',
                          '10605','55261','69172','73299','66884',
                          '71778','48048','82141','94036','19209',
                          '70611','40033','77412','56083','13088',
                          '57702','19989','14664','75392','22936',
                          '49609','73907','90400','62981','30724',
                          '97203','35921','53442','77449','26373',
                          '30583','25188','52578','91070','27786',
                          '60955','81888','11541','11691','42180',
                          '36296','41326','85541','51371','51632',
                          '17395','30593','65285','39641','29690',
                          '97793','23817','25285','81251','82057',
                          '25797','96087','14059','92640','67866',
                          '95006','22005','93514','76455','97750',
                          '10342','67158','82700','20958','97836',
                          '10250','71752','22500','57545','51000',
                          '54552','65442','15824','34586','14283',
                          '77685','52018','96232','27365','83464',
                          '99248','72027','79730','27624','63856',
                          '76635','67903','58815','76421','37637',
                          '39577','25474','21626','87602','35399',
                          '15597','17214','23815','15024','98179',
                          '34048','78805','61442','88219','37244',
                          '78295','62869','56161','89859','87063',
                          '38463','95039','82054','98674','59539',
                          '76448','17427','52101','16423','73111',
                          '66863','48506','26259','38238','88183',
                          '53157','17618','26201','86876','52567',
                          '78149','66645','90963','80654','90247',
                          '26766','95371','17501','78353','77886',
                          '17682','96543','16156','37050','57590',
                          '11837','30472','72153','96957','66759',
                          '75947','33952','39203','22483','36647',
                          '21194','80464','50509','24353','32687',
                          '38339','85294','57835','94306','45477',
                          '37803','37307','81238','37667','21133',
                          '42091','98734','86199','26737','85664',
                          '44640','17774','10545','63088','31975',
                          '21779','33056','86989','95409','41795',
                          '25604','54865','34058','45705','60197',
                          '93350','35923','45396','52689','68114',
                          '77944','73318','88112','56513','85953',
                          '53486','25844','67889','51263','73707',
                          '48885','50533','97336','47052','43882',
                          '58828','73571','19088','50163','79776',
                          '29982','54950','27217','13953','66057',
                          '78182','89978','90621','97630','20900',
                          '30952','65284','22924','32839','37557',
                          '59867','12897','57170','13396','29425',
                          '32396','41889','74457','65029','83686',
                          '36736','11492','24162','88034','69156',
                          '84014','98332','14745','78735','49289',
                          '68583','83275','58669','42068','67318',
                          '52478','25725','96490','18418','23102',
                          '25075','79438','98315','96947','78346',
                          '49867','70919','17929','13471','36401',
                          '47832','85011','27477','85769','76514',
                          '17053','81151','55151','26849','88434',
                          '84085','83786','63735','43226','76643',
                          '36485','72061','60281','58782','35175',
                          '69471','18955','50257','80465','57458',
                          '93403','35212','83628','25582','13801',
                          '94665','56723','65978','30132','55924',
                          '53869','37827','43682','71291','50634',
                          '50456','23019','35615','12556','87013',
                          '70068','14707','76529','54357','87357',
                          '24659','87875','81936','44846','92301',
                          '68014','91995','97309','79173','78370',
                          '37528','54419','62143','32939','25740',
                          '19521','63313','58803','80527','69528',
                          '23265','34364','86901','47829')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


