
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '17758','21430','55859','99628','49628','23656',
                          '86828','36868','66571','48251','93788',
                          '40386','63843','37956','21974','19168',
                          '44050','82760','56911','62110','80724',
                          '41025','17223','64587','19250','73717',
                          '77990','56602','89805','60180','19563',
                          '66289','90494','39907','98100','85538',
                          '55948','61346','22347','23947','49586',
                          '34832','94181','38254','75674','69823',
                          '80920','23803','19760','84096','56727',
                          '52018','97143','76519','47381','83757',
                          '95373','59176','72058','81632','62565',
                          '54910','84293','32822','23583','51333',
                          '35539','25872','14754','26689','86928',
                          '75623','68149','88530','43045','25770',
                          '94868','73080','18807','49664','48099',
                          '72555','69806','55575','46929','24749',
                          '58921','22322','38489','42174','13076',
                          '23252','73745','15090','20567','54455',
                          '33921','68275','39730','34390','83847',
                          '69045','60401','44805','51354','70329',
                          '65087','30928','40316','66943','76883',
                          '35404','73268','72887','35446','80198',
                          '86661','73335','30475','62125','80640',
                          '54737','76234','68498','91921','89235',
                          '62910','44518','59360','69747','31310',
                          '92090','28003','63763','20543','72750',
                          '55875','56903','94058','77012','67007',
                          '63740','59788','53884','61901','14050',
                          '81002','11653','22505','22818','81039',
                          '62299','87867','83339','59762','83271',
                          '71753','93793','32483','22809','38938',
                          '39040','75272','21534','16293','84342',
                          '14939','80837','26511','91930','35486',
                          '98019','98459','63645','57253','17058',
                          '52839','88852','94285','12133','16474',
                          '76076','18855','11094','42416','29725',
                          '38133','88837','42679','15355','94909',
                          '80255','50483','59218','30317','77598',
                          '93642','89829','80264','59283','51368',
                          '65445','17035','48736','14671','25711',
                          '80926','13259','17730','44403','60576',
                          '69925','17895','35431','26770','71338',
                          '26352','64610','53330','61049','58734',
                          '40311','96137','59933','77452','27690',
                          '96664','46460','41920','66452','15223',
                          '78605','10200','45584','27378','48710',
                          '64820','65138','68864','24291','67066',
                          '70723','67838','48474','76788','22906',
                          '80538','49063','58526','52138','85367',
                          '31306','61931','96171','95553','11550',
                          '49758','49812','80449','24062','16587',
                          '51134','45699','44102','10247','29691',
                          '55830','86136','24252','83394','59053',
                          '92077','95439','21583','66318','43221',
                          '30577','83450','73563','11399','17869',
                          '40011','44890','40772','70077','80728',
                          '94997','29473','61116','87842','21147',
                          '20196','54835','60354','80282','31554',
                          '62365','95421','25386','47493','10782',
                          '15590','72885','35908','12935','78734',
                          '20776','57990','49983','75527','92365',
                          '95660','16905','61363','27627','94712',
                          '69049','94128','48445','19312','27953',
                          '81751','58990','98099','53039','96812',
                          '65794','99457','65273','57960','51613',
                          '81477','39545','91329','11981','20529',
                          '61574','56129','96566','13769','51077',
                          '55946','99880','30195','62698','52595',
                          '60714','75063','10952','28259','12560',
                          '42987','84842','40777','96836','44281',
                          '56909','27560','86360','89006','24715',
                          '18435','90950','92419','70121','92223',
                          '64669','83102','94437','41306','93334',
                          '14239','58772','89306','98662','57644',
                          '31854','75446','30707','53777','92928',
                          '14957','59383','68058','56209','76566',
                          '73303','44231','23675','58904','95757',
                          '86933','98854','78950','31732','92585',
                          '95745','76425','66988','71935')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


