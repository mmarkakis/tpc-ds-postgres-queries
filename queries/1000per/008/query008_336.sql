
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '81759','73905','47607','22593','76550','24368',
                          '97032','59197','22028','15810','32943',
                          '64963','53137','82952','97797','44319',
                          '73085','58558','15789','34334','76289',
                          '52254','22580','60807','11216','53648',
                          '18211','84873','58769','86908','66950',
                          '31368','57032','16041','79499','11772',
                          '67628','55865','80142','39804','43632',
                          '95969','83487','94835','40037','48344',
                          '76160','57630','33672','75477','31254',
                          '18642','22415','76688','29375','23173',
                          '18480','32249','98968','25806','56068',
                          '79272','52377','19698','54538','44622',
                          '16829','28107','19098','20755','88054',
                          '31000','48027','38974','54903','51965',
                          '85359','76357','74423','43250','75108',
                          '80870','61735','94033','78802','56099',
                          '37527','82375','11617','58654','43631',
                          '15478','76669','35952','64910','43319',
                          '30328','28109','14605','51439','73548',
                          '68190','86076','57312','80197','13537',
                          '57638','16745','93103','63624','38212',
                          '98546','97714','97166','18468','99246',
                          '97345','75700','10638','31143','86091',
                          '49016','76427','23873','98289','46486',
                          '28978','68343','61287','61856','34313',
                          '28532','14035','20444','75622','51417',
                          '53969','45914','54893','36003','47430',
                          '13872','19657','38347','92483','40495',
                          '28274','36393','59990','43408','56632',
                          '90800','95676','39180','63994','24817',
                          '50288','45770','68557','28318','91883',
                          '49981','72391','71852','24636','53503',
                          '44764','26865','69664','24852','72916',
                          '41798','66506','42494','72136','94699',
                          '50604','60222','44902','54154','39089',
                          '99208','11238','63491','50583','58548',
                          '38990','21167','95140','58559','62027',
                          '86616','10923','80254','13202','90801',
                          '95634','71373','30592','82130','99507',
                          '12284','50115','22399','80964','67531',
                          '96173','91275','33242','21266','91411',
                          '61276','71839','95843','84113','59797',
                          '90971','88386','49940','26359','68902',
                          '56318','42744','57380','79754','86789',
                          '61098','52497','17396','95238','45520',
                          '81216','42019','96730','58815','84365',
                          '42250','26003','68901','52007','95942',
                          '59462','29396','41027','50986','98608',
                          '15601','92083','89182','32017','38537',
                          '39267','74495','68531','93831','83344',
                          '39824','86951','33899','17145','55777',
                          '30329','25249','76113','21300','85035',
                          '33792','31947','41013','47390','30105',
                          '56431','26866','45814','11001','44810',
                          '26752','24583','84006','36487','28832',
                          '31496','32519','97001','50286','67250',
                          '39716','73996','65489','68139','50434',
                          '63615','20338','30549','55708','90280',
                          '66951','79274','89969','27743','23048',
                          '11137','69588','65980','88299','23358',
                          '70166','80973','42692','91613','44395',
                          '50159','95852','43836','77824','53049',
                          '39961','74112','62442','39860','71887',
                          '30674','10222','36697','71240','61714',
                          '30548','42519','11560','72220','75746',
                          '90064','42677','32113','95566','15522',
                          '55085','28493','32580','78786','33035',
                          '89640','56807','34148','68324','38998',
                          '47540','52255','41335','54669','57317',
                          '22541','20380','36097','68634','76836',
                          '74820','58900','61775','89629','41589',
                          '86394','11136','73090','80621','23044',
                          '53147','11585','88555','28626','70162',
                          '97620','61190','62365','19751','86981',
                          '88533','50058','68646','65082','20834',
                          '57546','56923','86564','35355','18803',
                          '23575','73533','62431','98813','22647',
                          '17020','18889','80932','75874','31298',
                          '63470','83518','94922','99771')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


