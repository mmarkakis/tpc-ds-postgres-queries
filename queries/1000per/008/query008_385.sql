
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '22277','42389','55955','48834','36560','79859',
                          '42859','72560','81182','14696','52173',
                          '95882','65457','94449','51729','31157',
                          '92207','19548','23564','19870','24021',
                          '11218','98096','31759','30212','37115',
                          '50708','66134','58486','82679','43311',
                          '51160','96846','68427','74134','40087',
                          '52559','51558','93946','16986','27565',
                          '73189','27954','45292','31872','84100',
                          '67788','37268','13784','37250','90917',
                          '13430','78228','68482','23351','74113',
                          '41642','38627','31588','73203','50600',
                          '48123','56157','20189','61976','12974',
                          '29060','54237','21623','80480','13322',
                          '67493','84597','34621','56326','70901',
                          '30568','72391','68839','63563','25958',
                          '31770','39696','27192','20634','69641',
                          '30868','73079','18190','72187','39556',
                          '15251','14897','83044','87212','71860',
                          '13352','17651','84015','36663','28018',
                          '80718','71733','36657','73816','15023',
                          '92133','24731','13187','72461','24241',
                          '63376','19507','85433','57523','14155',
                          '61152','29186','29605','38318','21658',
                          '10093','18473','51284','14918','53735',
                          '73819','18018','37787','71904','75768',
                          '64595','61496','57606','75167','77992',
                          '69621','50762','62183','47083','43038',
                          '58558','29835','67855','14694','13639',
                          '13107','53706','10089','76553','84083',
                          '64294','31337','87298','97886','10336',
                          '53920','54155','58138','78730','17309',
                          '35432','97391','41598','80708','50295',
                          '57980','99940','51032','36477','33121',
                          '17321','15610','11969','34938','85196',
                          '87395','56766','24210','56504','55102',
                          '60580','73398','52626','50163','43068',
                          '28707','41920','45930','75868','72792',
                          '33373','28474','72073','22288','15084',
                          '15681','11050','23875','83968','66934',
                          '84106','65014','58851','57376','85827',
                          '19383','56747','81940','82067','24639',
                          '24701','13787','26504','55796','35365',
                          '91012','63836','25100','49640','55396',
                          '85254','81180','31495','81658','18847',
                          '34918','28938','24945','14062','13177',
                          '23656','78309','25877','23572','25824',
                          '23423','42372','54470','31094','45121',
                          '94211','31625','66610','21364','94510',
                          '25701','79609','38803','64216','88897',
                          '16906','89405','83639','13515','83696',
                          '94740','40820','61706','83688','97033',
                          '72043','17472','90489','62767','12420',
                          '25331','44678','86868','80680','54525',
                          '51466','63979','62560','41447','34845',
                          '85255','29262','61792','86546','30133',
                          '13269','11222','88775','83679','84400',
                          '77433','36093','35429','58348','90221',
                          '44242','60861','96950','49542','35150',
                          '81458','35590','92235','71233','67426',
                          '82467','52888','91223','15078','76313',
                          '52721','63857','26410','52417','14266',
                          '17746','82072','89300','25317','92136',
                          '27911','36612','64177','48885','87482',
                          '84325','81169','36227','27489','45417',
                          '69067','16579','53804','28013','29741',
                          '38992','45168','73921','20299','86869',
                          '55398','79851','58230','40362','14610',
                          '93759','33962','80712','49219','26119',
                          '88081','43624','71020','27868','38524',
                          '26047','67245','65382','54433','20223',
                          '13310','97672','83887','18569','13632',
                          '56698','41437','53052','88651','13336',
                          '72727','24660','93345','21142','86451',
                          '97803','53574','45067','92562','88630',
                          '77202','68116','62346','57748','14592',
                          '10603','47251','38837','66650','27400',
                          '94252','79457','82548','95044','24007',
                          '73858','94823','16588','22729','33115',
                          '59099','85418','21352','73376')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


