
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '59731','57452','22874','84943','14527','48696',
                          '61889','13240','63953','69643','31259',
                          '89427','42400','78857','47532','94489',
                          '70261','52619','87790','22595','80137',
                          '25134','29550','20362','35567','35894',
                          '84599','18109','12577','86910','21058',
                          '87314','28375','43473','90576','65380',
                          '11075','23090','89657','82705','28268',
                          '13474','25075','83591','25915','11610',
                          '59490','52090','51369','11938','88320',
                          '74281','16916','45995','77153','34989',
                          '10607','30679','61459','43108','63898',
                          '87355','97400','53169','78467','61028',
                          '30039','66800','28456','51882','73711',
                          '82786','34157','71937','65997','48704',
                          '77567','24961','38067','14306','46796',
                          '12477','54662','79352','91527','22799',
                          '50952','55255','42865','29065','90278',
                          '11162','79339','86717','30044','83696',
                          '98755','67978','45098','20941','50885',
                          '20500','65825','93920','88777','97981',
                          '25942','46252','90361','47828','80316',
                          '98308','20093','82650','49208','82078',
                          '42222','25163','39287','67067','64792',
                          '43617','88553','30608','91572','81232',
                          '30225','97562','50732','14106','35194',
                          '96192','60712','66027','34009','67326',
                          '52528','99092','23084','30276','58083',
                          '99277','96307','94642','33764','53219',
                          '74282','93246','73955','14326','69559',
                          '25547','27405','71323','40742','49765',
                          '15612','33928','97896','60778','22361',
                          '71596','56923','42383','83547','78442',
                          '68896','61292','69714','24570','23041',
                          '12801','67537','75149','14814','67981',
                          '17273','37509','59049','81086','85461',
                          '77511','36021','32778','15143','13819',
                          '90360','96486','90495','36577','13439',
                          '16517','27166','75887','72330','39931',
                          '99068','81587','40772','18491','23630',
                          '40725','87659','30971','56244','81534',
                          '33202','24887','48324','11481','73583',
                          '38225','91387','14674','61352','59442',
                          '91685','92928','76773','91136','71567',
                          '32179','13885','35770','45445','97268',
                          '24711','84747','95311','94544','27486',
                          '51167','54851','22452','11561','58153',
                          '70884','76385','24802','51644','85876',
                          '87374','74789','65912','55579','74440',
                          '71393','88439','36638','68704','32397',
                          '71163','62007','35793','17924','93134',
                          '81995','82562','76445','31477','18654',
                          '50015','71932','26753','64929','95440',
                          '30416','18653','58595','36108','90920',
                          '63976','23386','55333','64748','14346',
                          '68398','23847','88570','54096','88689',
                          '33991','42575','30450','73032','25761',
                          '25049','74132','59669','35672','78338',
                          '29929','67943','71719','69101','27959',
                          '33076','21496','18980','55319','59917',
                          '14028','94906','89511','59724','52153',
                          '61744','58435','18404','59412','37200',
                          '29003','73137','94926','83276','43656',
                          '71804','77712','93717','36120','48607',
                          '92850','50459','50320','23500','21541',
                          '40356','47040','99445','61196','58035',
                          '71105','48751','75678','39383','43905',
                          '26309','24606','61964','22046','36418',
                          '55518','29348','22572','66400','47372',
                          '64181','23575','41300','43587','79995',
                          '79494','92555','89831','77042','85756',
                          '61018','20681','57684','10077','20356',
                          '63382','58223','97016','11588','99276',
                          '70138','95586','18026','79490','45066',
                          '85465','25253','48429','16737','48134',
                          '50051','31599','16508','38059','10048',
                          '61293','51988','93009','74809','11479',
                          '48063','49994','17301','64220','29350',
                          '16654','64434','59309','45947','82841',
                          '17577','32689','76757','42674')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


