
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '15480','56875','50146','32959','27341','10821',
                          '72411','43255','62609','18807','28722',
                          '45433','27689','50119','41350','58345',
                          '39567','95908','54102','18110','61566',
                          '98897','22649','83972','92239','57408',
                          '80780','47674','27789','28316','64183',
                          '30293','34668','95687','65403','22253',
                          '26266','13662','33481','71856','20607',
                          '19263','60457','79874','87831','54393',
                          '62269','47856','35950','75815','16930',
                          '26242','67398','91822','51379','34722',
                          '68820','15307','72567','77550','55751',
                          '20044','28822','80271','45391','40440',
                          '33955','73018','14988','29617','32195',
                          '35654','84882','89356','87310','51897',
                          '51648','33973','27858','65421','99063',
                          '91830','21038','41531','53965','90688',
                          '10987','16983','89414','73983','28963',
                          '19416','71889','31528','72716','12176',
                          '91136','46756','77700','32350','10227',
                          '31132','80975','77620','90597','68455',
                          '13310','43198','10917','67030','94429',
                          '65075','32673','47093','84149','70343',
                          '18815','18285','56945','31978','44709',
                          '62901','61892','95011','40746','74844',
                          '73358','81078','50984','84629','26632',
                          '53606','89081','81417','12075','24848',
                          '16378','76023','97790','35795','28828',
                          '77818','40266','78338','88077','78788',
                          '40907','74438','81808','51502','32969',
                          '87824','51418','58031','96311','35375',
                          '43049','98536','28423','14436','84451',
                          '28774','45667','36957','69240','80663',
                          '62838','89062','99541','43171','14141',
                          '88268','91069','30570','55853','79943',
                          '93548','13604','31713','59076','31488',
                          '23767','87387','17015','87601','89788',
                          '49637','71469','46646','10695','99423',
                          '84118','52277','91667','90439','40933',
                          '90007','33503','73862','72256','91288',
                          '33885','52981','84417','26825','63740',
                          '96636','62419','79287','69474','50861',
                          '50931','76827','40703','56400','45128',
                          '52596','91944','80683','95588','58917',
                          '98667','70168','90911','44889','15421',
                          '73700','29388','96937','63756','42353',
                          '26025','56539','22241','47206','39020',
                          '30103','22217','12397','37726','24029',
                          '51429','66794','83865','52929','29016',
                          '73218','38431','62265','60068','48558',
                          '77359','44237','63110','40567','54149',
                          '82737','12942','87890','40403','44032',
                          '63310','68628','62038','54982','16751',
                          '63152','50659','22374','70702','63371',
                          '62471','85607','84367','81406','62060',
                          '22001','24800','32119','36425','98744',
                          '95551','43259','12376','88617','44668',
                          '45236','58683','78781','22242','37156',
                          '33887','96153','53490','42625','16438',
                          '96967','68140','98498','28821','42191',
                          '21927','13716','44593','33724','34560',
                          '14020','81072','97741','22250','84192',
                          '78311','43862','94432','44702','32790',
                          '44769','80458','40901','23689','33630',
                          '69381','16241','14234','57870','41068',
                          '80731','13285','55306','27597','18426',
                          '63287','93066','39891','68657','25976',
                          '77641','52644','99645','63816','83187',
                          '40960','53413','77602','88311','95939',
                          '84895','48158','93309','36617','78350',
                          '14668','17605','99234','42417','11113',
                          '48107','68667','54779','65339','56161',
                          '59627','49948','82804','24692','88345',
                          '32015','32164','37038','22248','86402',
                          '28501','21044','67701','99508','96601',
                          '98613','81014','36804','58191','44834',
                          '70039','93126','95851','40241','13823',
                          '41700','56495','73603','47857','97582',
                          '94748','98275','14762','94419','51363',
                          '46621','16293','42919','20967')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


