
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '82560','85649','26613','20611','38154','62302',
                          '24928','98102','34502','13807','61348',
                          '42861','78554','51517','22126','38378',
                          '96357','13071','23579','54077','91076',
                          '36720','63910','87234','80743','62580',
                          '29962','23538','68299','76611','17815',
                          '26653','49124','99694','10583','22282',
                          '43636','31628','16597','40618','84347',
                          '61634','91152','69274','98708','54004',
                          '47340','50881','10682','94928','11142',
                          '85236','74623','58686','82222','88567',
                          '34620','86767','85815','22514','41648',
                          '41229','23961','60848','34055','23919',
                          '80821','17235','76338','12823','77216',
                          '63496','44536','10635','38027','66986',
                          '85517','28641','74464','82462','30792',
                          '42526','38244','38874','71713','40323',
                          '78519','38558','58002','54779','42536',
                          '59851','27496','33210','55263','86322',
                          '58877','16669','68542','95634','83766',
                          '36956','12508','44690','80193','26472',
                          '28850','14894','87946','11642','62886',
                          '62724','57914','29645','74991','76235',
                          '88654','22791','43784','28192','66767',
                          '31918','26531','67380','25432','95562',
                          '91445','47186','58810','75177','96490',
                          '92677','22824','40807','32455','14756',
                          '58611','83860','84707','82548','86361',
                          '19033','82859','72317','65105','46199',
                          '31266','62577','99766','89031','79442',
                          '91578','57444','49667','54468','80715',
                          '86308','28883','64856','54134','54299',
                          '48391','21142','52820','21362','46190',
                          '38981','14719','40535','54728','87493',
                          '15973','24993','36651','13753','28988',
                          '84955','17627','92009','19015','80004',
                          '63352','33418','96360','88694','80627',
                          '22655','89017','95200','98600','54510',
                          '18784','37912','73668','99172','75886',
                          '86110','41884','82451','85690','88594',
                          '12986','70841','67011','20268','96778',
                          '48016','95911','35136','85601','97980',
                          '29487','24105','96773','95648','48005',
                          '26665','36773','12216','26893','39312',
                          '28441','14068','92246','92635','65136',
                          '35571','61926','27945','26488','69734',
                          '86428','61603','28114','29200','52182',
                          '94021','83421','70247','23873','58282',
                          '59484','37597','61076','50227','20847',
                          '31998','99441','55667','81063','38550',
                          '42967','21708','22672','98305','88417',
                          '70852','91289','73643','62986','34033',
                          '82628','88107','47982','11148','53358',
                          '72389','30078','66701','29244','71868',
                          '85573','92926','28020','73521','24834',
                          '74945','19744','14779','45715','63813',
                          '38701','27863','92361','96444','65476',
                          '21944','72921','17109','87272','97518',
                          '73056','14529','47555','78567','66419',
                          '63940','91642','99115','49251','48172',
                          '45204','59746','45405','98668','36446',
                          '65376','82757','95887','46677','77696',
                          '71243','82204','45519','36362','17130',
                          '94654','69629','15925','72142','82108',
                          '17137','79396','56631','98227','80758',
                          '32089','38741','72375','81098','62975',
                          '72478','75879','51758','85726','97562',
                          '47208','45087','78436','76424','46516',
                          '76883','13576','60309','72274','56848',
                          '89356','19575','82224','32147','22139',
                          '65818','88142','43342','57720','84300',
                          '12578','16466','41567','64812','52329',
                          '44908','17410','67278','46797','82629',
                          '23172','81673','41788','43573','82214',
                          '97318','57990','31313','31392','71260',
                          '88774','48770','28075','67915','63639',
                          '32525','26753','74636','20993','44488',
                          '33113','65919','92161','91921','76960',
                          '33080','12579','88181','83142','61795',
                          '79102','31546','70662','70107')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


