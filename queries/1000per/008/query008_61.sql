
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '94908','94619','62415','79809','42741','76687',
                          '80221','10933','22175','53812','57362',
                          '28781','41928','90500','86940','80118',
                          '59710','14715','16350','81991','65434',
                          '81720','21647','49762','23838','62020',
                          '57985','49285','79771','80986','39613',
                          '21422','26257','61648','19079','64981',
                          '91433','60201','52418','74421','83401',
                          '96405','86245','82425','39221','66978',
                          '53393','77006','13259','30311','76311',
                          '59959','89549','40878','55584','90284',
                          '39522','41601','61123','12225','18287',
                          '81893','32939','10224','82800','18298',
                          '94380','42800','25249','44104','55016',
                          '94585','43257','76984','23162','75669',
                          '47878','68765','45406','32634','21632',
                          '52891','83447','52604','41400','72626',
                          '17838','67269','48551','23412','56878',
                          '23588','97212','35552','86967','51459',
                          '11105','79554','23110','12291','75599',
                          '28057','54925','80680','69084','17090',
                          '15940','23645','23821','77416','99073',
                          '18415','77504','78345','26954','57647',
                          '96496','97126','78112','36126','65497',
                          '76704','63387','89396','60869','94339',
                          '46560','30803','48630','12874','53440',
                          '46179','92963','90432','69450','27751',
                          '92067','17279','84828','53193','40050',
                          '74404','86714','61292','67754','75325',
                          '70556','59373','26631','26788','88767',
                          '36175','98603','91955','43928','68752',
                          '80292','72504','63139','73291','53192',
                          '70241','54747','92668','54985','69963',
                          '97764','42521','59300','17580','95598',
                          '47713','40781','13547','54609','73443',
                          '23601','37255','70227','90729','61626',
                          '52692','41048','54668','49075','38600',
                          '79811','48881','60165','95731','28689',
                          '64574','53493','86143','67123','90600',
                          '64671','74956','26504','96048','74700',
                          '63955','89095','95419','94341','14531',
                          '75347','79360','63244','21485','39266',
                          '72069','79400','50953','60265','90131',
                          '14651','38488','33599','14655','70996',
                          '18958','12614','55572','74652','17518',
                          '82210','31507','38062','80617','68449',
                          '89325','83546','60721','40367','77704',
                          '15816','51611','87556','55372','40124',
                          '97673','87820','33879','40243','36751',
                          '76853','85684','19071','20279','12507',
                          '57382','59075','31980','30191','38460',
                          '67721','16194','31967','26961','80722',
                          '35310','89909','91476','45783','64531',
                          '57549','44954','23982','46064','84032',
                          '83918','63029','21292','75566','73864',
                          '38529','85810','44235','33902','88357',
                          '66677','98975','84986','83844','79337',
                          '52298','34433','12699','53929','27603',
                          '58861','80136','92933','84546','40646',
                          '66501','32647','31005','91898','94299',
                          '52245','67618','43423','93525','39556',
                          '39352','34532','50214','52511','70455',
                          '32092','97282','82592','22961','76470',
                          '96437','67121','70606','74567','25913',
                          '85542','14965','13583','89493','20745',
                          '76076','34152','57851','39868','62443',
                          '68790','81073','18621','46331','90760',
                          '64359','75028','77343','85521','51504',
                          '92738','83062','88185','15451','61731',
                          '90885','22632','80181','59199','40568',
                          '86942','51488','74471','52478','31214',
                          '27338','51920','52956','55239','40208',
                          '63750','10631','18355','66872','43290',
                          '56218','92408','49179','87730','77918',
                          '72272','83483','19820','87292','23473',
                          '62809','76447','30424','98020','40349',
                          '62931','45321','32992','85715','93509',
                          '68606','25485','21171','97733','66854',
                          '11826','96317','38526','49454','12239',
                          '23392','69397','35958','51897')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


