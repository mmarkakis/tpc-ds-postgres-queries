
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '97738','60437','97182','12511','30697','40528',
                          '90669','55102','13008','80611','62027',
                          '52739','81436','84207','52023','60118',
                          '32394','80251','90844','45699','36838',
                          '51878','19300','68318','79729','24971',
                          '29778','47794','43261','28283','69416',
                          '52546','94084','77763','67855','62704',
                          '63860','45089','67868','13160','91226',
                          '21934','57836','81848','21215','30465',
                          '91283','82618','76874','77357','18496',
                          '29311','65541','62488','53690','75822',
                          '64737','78431','40666','59351','65061',
                          '65223','52259','72401','47182','31507',
                          '54411','22240','13360','43739','84459',
                          '37483','97267','13683','61503','72077',
                          '48610','81309','67768','44295','88243',
                          '51723','39531','45805','46209','69781',
                          '32366','24624','31451','74859','58503',
                          '27570','96435','39553','63980','49010',
                          '90877','92938','40939','80293','34948',
                          '95127','66929','54005','36631','93347',
                          '73554','20925','24505','69560','74054',
                          '62313','90053','96003','17711','35293',
                          '91910','29978','47408','63705','48710',
                          '43437','22962','49530','25885','48016',
                          '64431','57671','19874','49301','32355',
                          '94291','12015','95851','83686','13058',
                          '76888','54461','81242','25160','10450',
                          '81540','17363','24900','39810','75467',
                          '68790','89206','12560','68534','56111',
                          '14254','37762','52478','78988','73560',
                          '22590','72325','61281','61985','68691',
                          '76969','33736','65481','59228','28748',
                          '98110','60841','68581','44564','84020',
                          '47515','67512','46017','36791','57262',
                          '98482','10789','22148','19839','46411',
                          '86332','54059','76784','29596','59213',
                          '17633','41090','30581','62754','36022',
                          '61658','69405','87499','74919','38143',
                          '47412','80592','70586','57168','50762',
                          '92055','10168','83399','64105','10530',
                          '10492','97411','13049','40053','71767',
                          '25992','47726','59000','96569','25879',
                          '59008','72463','63487','58373','76574',
                          '22977','12593','48264','99504','84214',
                          '33550','85614','57213','17265','90291',
                          '40435','97257','23540','70652','17660',
                          '18094','51599','56003','91648','79427',
                          '36637','57218','38804','40328','20612',
                          '64184','87496','94848','11616','84843',
                          '19777','38205','80933','98494','91183',
                          '40754','50738','80413','23145','95318',
                          '56344','30345','54602','68229','84945',
                          '99553','13462','41901','69030','92252',
                          '51196','36476','25180','52128','20085',
                          '18620','52942','34028','67972','63293',
                          '47569','72402','49992','49487','75402',
                          '60812','91222','84194','53712','97804',
                          '44230','37675','73437','18027','76188',
                          '93550','49049','31083','15409','89632',
                          '89902','13983','75529','53811','25005',
                          '27944','94238','78971','88969','80538',
                          '15178','74249','82282','90310','29991',
                          '99865','27379','42334','62218','17615',
                          '63719','19857','96253','34131','18022',
                          '46074','29570','59769','27058','93051',
                          '26125','30206','29317','21280','31369',
                          '58853','57520','68430','68020','23233',
                          '96615','47685','96939','22333','21209',
                          '53345','31545','23271','17869','18965',
                          '34415','97762','63883','12154','85810',
                          '94153','93518','47170','80971','37174',
                          '91433','30081','61069','86890','74358',
                          '73622','41489','51743','22851','89224',
                          '67751','70458','20364','24817','75745',
                          '10165','26415','51665','40251','14080',
                          '84349','34184','41597','49512','19687',
                          '16467','36789','97046','47974','67601',
                          '94852','89810','42232','92307','45504',
                          '10870','98315','46284','44370')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


