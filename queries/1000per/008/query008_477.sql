
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '41007','83938','47204','63528','95142','24992',
                          '36983','27133','42110','25262','92574',
                          '11497','47715','53512','27145','89137',
                          '61339','64695','80086','70642','11495',
                          '92269','57732','99534','64469','37766',
                          '91268','16088','79300','68732','79365',
                          '30962','63399','87864','90807','80110',
                          '31162','54209','20605','21615','75984',
                          '75952','37503','58142','90497','89485',
                          '35512','21437','47025','20525','96990',
                          '79866','58474','52590','93297','72757',
                          '62352','39228','83939','41413','61502',
                          '51669','35930','47511','37546','67871',
                          '98896','19447','26907','45957','66822',
                          '14887','74249','86131','91043','71364',
                          '90086','36153','50131','13423','88954',
                          '98977','31213','60777','90318','92902',
                          '34562','34352','78001','56323','94978',
                          '52576','59371','14554','21205','74687',
                          '19743','48007','62744','36190','70035',
                          '61888','72282','99961','27922','95442',
                          '92638','56500','89604','45579','54125',
                          '44732','90523','17652','28732','13090',
                          '63319','92946','38091','80505','52466',
                          '90840','60611','67282','69879','31295',
                          '25074','49242','80067','99057','48203',
                          '18609','64055','32140','30151','14273',
                          '48724','86203','16893','33140','24297',
                          '41550','54945','46331','99894','12858',
                          '21686','57309','76807','83121','43064',
                          '64136','93439','30320','33315','98035',
                          '17953','32364','90282','68874','75319',
                          '20602','14473','88086','15750','37837',
                          '65320','62401','74385','55326','20620',
                          '64463','88599','25756','66371','97309',
                          '18487','63496','55522','67852','78831',
                          '66287','34344','49111','18801','47394',
                          '98984','72793','36174','44419','96081',
                          '92444','82231','11359','33247','68389',
                          '49877','99081','13092','84011','85626',
                          '71130','96062','78124','45351','43950',
                          '64838','51057','43244','79326','57490',
                          '28103','89995','99317','88815','53301',
                          '17779','36620','45795','98016','13446',
                          '12528','71901','33147','97277','53933',
                          '95181','52051','66806','79706','99447',
                          '93380','24784','87042','44123','32610',
                          '98163','92598','64883','39174','72665',
                          '58673','97723','74755','31898','23690',
                          '49233','13063','36736','29290','47252',
                          '53162','19677','18776','84811','18922',
                          '55273','18382','73777','81828','46354',
                          '19892','25232','71688','16485','40349',
                          '17432','34602','96164','40838','24889',
                          '31013','24111','92449','22061','38503',
                          '62327','42178','10448','88947','33375',
                          '52897','50709','24065','85091','91555',
                          '12581','17655','11974','52159','91281',
                          '37953','64242','90006','91747','71047',
                          '49854','38626','68920','17110','15090',
                          '67887','28138','47586','15967','19415',
                          '74849','13325','85557','41322','62115',
                          '32171','78047','57515','62530','64471',
                          '49306','42054','73576','34478','84606',
                          '38516','61641','81255','14398','46003',
                          '28610','87556','28441','18844','68298',
                          '29522','76588','91204','83096','91232',
                          '32443','92507','17842','96374','11330',
                          '92674','59764','24590','26654','46125',
                          '59467','70407','74370','75244','82726',
                          '31622','37636','14534','28153','55640',
                          '50249','53344','25532','32555','77295',
                          '29774','56668','88322','24024','12079',
                          '85009','67214','25972','57160','65043',
                          '76728','55577','67837','69770','86263',
                          '99929','65700','59902','19549','55456',
                          '66450','50096','80462','99542','54555',
                          '39242','77112','73948','79783','58062',
                          '49920','36601','45793','59040','64523',
                          '52196','13480','29372','12645')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


