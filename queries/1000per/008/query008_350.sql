
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '94192','10711','82182','94875','74150','61125',
                          '33080','45177','94692','47485','81372',
                          '62483','79372','57325','24773','30463',
                          '52314','79233','11425','50559','79052',
                          '20624','23416','95787','47436','17275',
                          '63147','33465','11985','86478','17943',
                          '20229','20502','38832','37072','66864',
                          '25253','92970','64441','31686','89616',
                          '61330','81130','47943','89282','13022',
                          '76077','26241','18740','62617','32196',
                          '46522','90225','55791','49578','41131',
                          '79911','27386','17866','97062','89933',
                          '15309','38033','20264','37771','33343',
                          '30794','90465','96979','34967','11718',
                          '76950','81981','73806','61039','78725',
                          '41378','20445','70829','36579','78134',
                          '34653','39383','17361','43667','47010',
                          '12809','86271','26549','92362','14188',
                          '37396','37810','37033','90097','17176',
                          '24317','20102','11802','14246','76616',
                          '79098','12207','49938','86825','36817',
                          '19059','41486','68147','94922','17116',
                          '19494','67252','76852','87021','37956',
                          '58739','38982','80901','62869','23426',
                          '98998','35556','72452','42159','17668',
                          '32027','51901','62885','88102','36397',
                          '53250','85727','88935','41772','17189',
                          '55800','36358','40925','84238','44720',
                          '51142','79368','40252','42498','52249',
                          '18250','34152','42058','50125','43755',
                          '70001','97970','13388','93714','36402',
                          '83524','22692','90963','99367','97206',
                          '78300','80089','84550','76294','82657',
                          '37916','96480','73122','78433','59433',
                          '75340','56827','37347','40939','43582',
                          '88346','38137','88614','62253','69539',
                          '11957','59127','10553','25407','74225',
                          '91256','44157','80373','37255','29331',
                          '23858','69244','56273','47254','13971',
                          '55798','23367','99641','30032','47819',
                          '94465','57744','14572','42281','75471',
                          '25770','72640','36062','94773','23501',
                          '53129','96214','68591','25825','18234',
                          '82976','67386','50377','64659','88696',
                          '55076','21365','14643','21547','71615',
                          '21128','74714','14633','15432','86860',
                          '86489','83819','23966','83189','98264',
                          '42518','66525','20884','39664','52135',
                          '92756','65946','77392','14837','34094',
                          '92639','17563','82333','89313','22242',
                          '34778','32224','77277','14492','51407',
                          '32016','85376','66131','14594','86941',
                          '33396','60513','79787','76575','97886',
                          '39360','91688','79737','36826','56535',
                          '12333','95566','85699','54325','73070',
                          '20654','40466','89240','71502','70242',
                          '18509','72094','16973','30884','64866',
                          '77484','72051','25025','83279','24355',
                          '22729','96687','42824','63833','41540',
                          '85147','44726','65657','77802','70375',
                          '12134','92691','81712','22499','94858',
                          '86325','80675','31566','74384','52464',
                          '81930','77879','70174','85566','22576',
                          '31268','78334','15531','75288','33534',
                          '95389','98434','89258','94167','95147',
                          '48409','76377','91395','45981','17676',
                          '91291','32136','16722','15217','83059',
                          '23012','31656','74219','24183','51251',
                          '71334','88462','72723','86842','31334',
                          '78745','97115','71738','57673','39509',
                          '32127','97076','45235','66941','94515',
                          '55333','23113','76488','22113','58757',
                          '24039','90489','31611','56721','61137',
                          '55397','98545','74203','31367','20279',
                          '66547','15731','40380','27768','92623',
                          '88025','63649','15620','46957','16578',
                          '58771','65082','43102','75925','35968',
                          '40123','13072','57041','85674','29125',
                          '52025','46322','72636','29373','23489',
                          '44348','18860','87427','14396')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


