
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '41173','52827','87452','41981','27457','46733',
                          '43240','24468','45254','95322','93054',
                          '12580','54610','62507','32468','87199',
                          '58248','95576','37121','53126','35163',
                          '16046','74946','12711','25431','41876',
                          '77503','96367','34677','51701','16817',
                          '17546','14324','97159','78617','30268',
                          '24193','89107','13893','92126','36086',
                          '29992','94474','22691','70874','12182',
                          '95568','59315','35870','89061','15358',
                          '31429','41774','38531','84666','57675',
                          '11567','64259','86749','37046','72724',
                          '55679','18520','40476','74658','43436',
                          '16717','16514','77609','51314','72936',
                          '67719','67947','44228','15683','34334',
                          '27123','95238','50478','69776','80064',
                          '84386','34028','27460','70139','63063',
                          '38479','19503','24247','50358','60475',
                          '27798','69283','36034','60412','91521',
                          '74937','57394','73029','70980','98895',
                          '54943','91918','12757','29176','12115',
                          '35356','17133','79948','80877','87542',
                          '88672','81734','36399','28440','72805',
                          '85170','25579','81244','80409','42303',
                          '71492','10909','78520','45798','78261',
                          '94824','33546','32990','37026','10031',
                          '10357','78020','76839','18400','92301',
                          '55295','33244','96773','28994','46030',
                          '84631','62302','98073','10684','41408',
                          '81121','11126','58594','38949','98429',
                          '81419','76364','93698','72201','10604',
                          '15977','82970','17077','18984','90407',
                          '95034','28737','69352','88191','33088',
                          '97917','82700','53847','83057','13585',
                          '92523','71574','17003','21150','28901',
                          '69633','29971','67827','39066','70694',
                          '38413','78187','87653','62568','84943',
                          '76560','24774','41029','84767','97036',
                          '14615','63917','46309','28216','46020',
                          '27680','13719','79099','22263','73957',
                          '65783','28082','52240','31088','57642',
                          '52714','70964','40465','75458','75453',
                          '84142','30908','27039','97451','65966',
                          '28557','56322','75455','74394','69112',
                          '41462','64500','49166','29856','20266',
                          '83342','85798','21401','80460','84696',
                          '59556','26273','10139','58363','66420',
                          '63552','92865','71822','47450','90047',
                          '91706','38731','23276','85273','70518',
                          '29678','59831','74930','27322','52864',
                          '17447','66768','71868','84878','71937',
                          '48095','74366','64581','58801','10492',
                          '46738','71395','43549','73785','19600',
                          '43434','98114','85015','24792','97635',
                          '83123','56050','58917','40067','30320',
                          '42738','67157','11875','58075','94499',
                          '62054','43913','75130','60790','57859',
                          '31230','28825','86639','54654','28034',
                          '67417','97364','34212','76356','51635',
                          '45838','44314','25814','72515','40639',
                          '98976','16343','17375','93512','91946',
                          '97161','55068','52772','36533','32097',
                          '82598','50418','47605','56130','56425',
                          '73773','57377','27692','26466','32815',
                          '62564','91801','29688','27865','46102',
                          '15315','74269','31757','79083','57753',
                          '42888','82550','39450','71837','21144',
                          '34953','16774','56109','63477','34911',
                          '95996','29078','11185','67099','27940',
                          '32461','15252','58925','79329','89518',
                          '51953','31560','27089','82371','19869',
                          '27337','29630','91307','18648','51836',
                          '12363','13626','92283','50316','65404',
                          '72726','67884','60036','32189','13129',
                          '69190','87799','12908','69513','51968',
                          '45466','42563','36069','77476','26930',
                          '19134','25024','60162','49046','50715',
                          '89208','57374','40937','63032','41800',
                          '66409','19909','39457','44108','43757',
                          '45012','63189','81214','41285')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


