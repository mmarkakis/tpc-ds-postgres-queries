
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '74493','10026','81134','98288','95004','66461',
                          '30232','21034','92910','72079','55497',
                          '56662','12523','58975','98717','23611',
                          '20569','22420','88683','67381','94060',
                          '35651','88359','52065','93018','87888',
                          '64280','14779','82301','92084','59455',
                          '21549','72949','61556','73141','75971',
                          '60814','69223','45160','48918','11408',
                          '62229','14294','25419','86946','15841',
                          '14040','37351','97808','26158','93061',
                          '13993','59017','70748','41584','94666',
                          '61284','43526','18017','95696','63889',
                          '56946','12410','63991','57352','15847',
                          '10574','51145','16990','47443','68683',
                          '21598','39646','75110','38471','36505',
                          '75331','56988','76139','53011','67735',
                          '19971','23348','53603','92475','52814',
                          '44375','30467','11087','80168','85146',
                          '82104','66837','95012','34535','31419',
                          '67099','72398','65604','93068','87283',
                          '39332','10519','66632','76120','61176',
                          '45897','21203','22636','24869','99344',
                          '89478','23374','33584','16384','98168',
                          '26355','36431','68984','54926','99267',
                          '86755','22195','21625','42235','52430',
                          '91445','56592','44977','92909','78546',
                          '43644','61767','33057','52607','33486',
                          '75935','56954','92410','32721','90804',
                          '14898','10832','75098','44212','54039',
                          '20243','67867','56358','72579','42155',
                          '25425','88151','95604','67587','97525',
                          '33766','72823','32764','89854','64738',
                          '98455','87392','69737','19238','95605',
                          '58243','94802','99258','79530','62181',
                          '35843','51694','60823','71772','69171',
                          '76236','40253','61906','89899','96303',
                          '64114','45772','71612','55450','23002',
                          '89516','53625','53099','18204','51190',
                          '58931','25449','75515','48101','50032',
                          '16461','58066','34652','88450','44116',
                          '15373','59243','53368','94088','93877',
                          '64036','27679','93636','94755','68113',
                          '36012','73285','61736','72503','26716',
                          '68455','68039','89719','13749','23004',
                          '48071','49573','83686','90048','41032',
                          '10429','71103','25943','34581','83795',
                          '39620','64877','52787','39417','95255',
                          '68041','47263','33838','36884','71652',
                          '28701','55483','52402','41820','48049',
                          '42395','39501','85475','60779','67036',
                          '86596','11740','63606','55623','22714',
                          '87188','93754','22710','72588','61490',
                          '95277','67814','43006','60522','31383',
                          '76423','28550','53765','41922','76714',
                          '62431','26612','98146','56962','12848',
                          '16834','43631','48300','16464','26910',
                          '64584','84384','90542','83690','43880',
                          '77694','75989','98574','58991','85241',
                          '72107','97393','90830','34240','35667',
                          '66234','98804','57120','36668','12543',
                          '91380','28999','25047','97712','75102',
                          '69727','21684','27524','90791','55805',
                          '79501','10640','14551','99800','75813',
                          '54613','74717','53965','53983','61122',
                          '26599','79474','80798','22093','85879',
                          '95303','95323','73545','55469','57955',
                          '88779','82753','60650','23912','65133',
                          '41179','55375','77374','49741','47629',
                          '48917','73151','60266','53546','31399',
                          '97049','17153','74969','62853','84354',
                          '18444','58602','71468','58705','44679',
                          '39427','22468','99803','13913','55683',
                          '92901','37329','32236','84692','37545',
                          '46063','47395','24158','88936','30877',
                          '97539','93725','88505','61241','91171',
                          '52046','72363','23900','79110','82292',
                          '15058','27043','41163','46415','79948',
                          '43581','21721','95714','35797','23964',
                          '67111','70378','33314','23540','60850',
                          '35209','55285','33211','30625')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


