
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '73700','66824','84862','79461','87951','56480',
                          '21779','16463','36101','92794','15730',
                          '45918','85988','41728','46173','44250',
                          '59341','36154','13640','48418','34451',
                          '84594','96310','42063','23773','10118',
                          '55728','17141','25270','50857','46241',
                          '14305','64724','82815','78936','83397',
                          '37579','47536','72694','86142','92537',
                          '76672','92311','27265','48062','28460',
                          '24464','17654','27132','43689','10469',
                          '29286','56699','19436','93716','99461',
                          '98958','19419','18375','41867','79503',
                          '84698','91124','63259','55217','51923',
                          '61295','83862','97315','10004','10757',
                          '95140','94897','59333','38918','99010',
                          '28651','30755','82233','92894','36264',
                          '28535','93318','69331','46542','65448',
                          '40630','63978','41698','58612','20858',
                          '17572','22664','85269','64514','36550',
                          '10921','10882','32919','60781','67286',
                          '37784','38314','11114','97068','21168',
                          '50853','86161','60338','63018','99346',
                          '84391','45227','66160','20440','75348',
                          '10015','22087','23101','52385','47626',
                          '48521','62931','83845','27196','51383',
                          '96533','18652','91426','67229','20927',
                          '44665','60248','35229','81786','97582',
                          '44948','24752','67255','81597','45476',
                          '81516','57042','10566','24711','23816',
                          '68742','81179','21669','28441','26120',
                          '49287','51109','89076','18393','94218',
                          '12637','28435','41299','35875','51730',
                          '37317','25840','49847','25024','97043',
                          '33600','90621','17661','89332','41517',
                          '41251','93204','43726','67044','45049',
                          '72923','98471','91233','25140','94490',
                          '86760','15506','85828','64384','28689',
                          '89258','57179','78263','93915','76959',
                          '36907','24948','70800','69459','99314',
                          '26194','89967','74595','96259','92970',
                          '68428','40227','71340','73502','20232',
                          '38098','56229','58954','75839','96198',
                          '50454','46293','96994','95571','57320',
                          '69813','50182','44862','96992','29563',
                          '32389','68314','79144','30082','97744',
                          '37146','21552','83272','94224','40839',
                          '14490','48663','13479','56472','99076',
                          '74799','88611','51090','64319','70645',
                          '75236','42437','48135','92576','37132',
                          '80259','79609','85476','55065','92280',
                          '87245','73997','90356','61291','62969',
                          '22672','77830','33213','95350','72746',
                          '65167','28604','92391','60279','32044',
                          '67729','63126','27904','67090','26692',
                          '71346','95113','51555','54529','74408',
                          '29310','21718','54261','66643','54669',
                          '56589','94951','54537','40599','19247',
                          '63458','68893','61735','26562','35751',
                          '79902','70352','91201','49321','70074',
                          '79108','12501','61016','48748','43106',
                          '15773','20124','46692','51361','73258',
                          '39870','78762','84209','59032','89340',
                          '17337','52229','81353','26106','27420',
                          '54816','48736','80947','66683','14659',
                          '91854','97069','33526','33789','89965',
                          '93348','97821','15057','98094','27784',
                          '40636','84791','59313','88879','71388',
                          '33851','78510','76584','56643','27571',
                          '62899','25978','67798','65013','32834',
                          '98952','15016','30390','10887','81517',
                          '82042','28724','86350','26502','95624',
                          '80460','27620','96632','34137','89262',
                          '67812','46988','18901','69843','69011',
                          '87969','33870','64155','20061','22992',
                          '83215','82700','72986','52885','45201',
                          '31834','94351','88109','62701','48793',
                          '92333','84817','91921','81526','82646',
                          '35613','58076','99606','31837','67133',
                          '44239','61953','47482','75036','79353',
                          '79976','95677','75290','23890')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


