
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '60399','55397','84005','26228','21926','41717',
                          '20740','32185','29623','27896','96017',
                          '89089','27462','99539','42853','82993',
                          '82029','52161','73778','53211','87526',
                          '92927','85388','82459','33432','71890',
                          '79120','79567','25067','72449','61735',
                          '10771','77789','27497','38013','35032',
                          '79555','24678','74609','61956','39355',
                          '11377','84496','87059','79333','26431',
                          '70768','86777','30374','85885','14566',
                          '41077','48479','97250','73548','64938',
                          '57840','76774','41774','44024','74380',
                          '96418','51840','88465','59949','38989',
                          '71182','35360','57799','33727','43995',
                          '55656','28583','64375','57166','21544',
                          '74679','92294','47125','69306','36618',
                          '50851','15905','79123','11746','61292',
                          '37436','88196','90072','84889','76426',
                          '30148','72530','85207','82477','42906',
                          '47975','13715','60644','15773','21154',
                          '24617','12894','79533','95964','54827',
                          '63598','25952','88512','33633','45942',
                          '90355','59667','35935','91397','64614',
                          '16704','89815','54663','26557','13035',
                          '50155','44019','66044','21594','54222',
                          '78506','84703','32771','81857','87680',
                          '72814','50141','76091','47432','80928',
                          '95920','37829','76458','46021','26529',
                          '49540','53569','78628','39481','28968',
                          '20669','38237','34051','24655','22647',
                          '84541','17900','74165','37842','42503',
                          '68106','18088','67234','23016','35124',
                          '59540','76864','27077','67512','80477',
                          '97330','99395','15565','35950','55761',
                          '27951','62900','98480','24992','51901',
                          '83413','56884','69756','12264','31604',
                          '88114','47026','27129','46294','79222',
                          '41753','79452','75736','13391','21949',
                          '50607','91455','15930','68267','97842',
                          '73935','13093','74439','52843','68915',
                          '92667','53077','67890','30919','92584',
                          '18972','87379','83682','44769','42430',
                          '62395','40130','74027','48691','91061',
                          '15916','79777','97424','27411','21800',
                          '62681','75720','22649','80970','45252',
                          '57355','13613','86668','47767','83300',
                          '56553','34466','74029','37647','60628',
                          '35275','60473','53011','44762','70661',
                          '95460','66979','91399','84489','13380',
                          '74181','87783','55906','22888','74153',
                          '50984','84098','28781','46568','68747',
                          '56088','46107','86938','14534','76775',
                          '38966','54745','28001','33667','72145',
                          '45438','12597','74828','90330','62529',
                          '50968','75945','43901','43622','25481',
                          '72423','24716','76653','84559','66168',
                          '87770','77940','62195','12744','98619',
                          '63673','64379','18540','94731','36018',
                          '78166','24082','27585','93561','52660',
                          '68097','30791','50560','43562','24187',
                          '97286','17951','49573','28818','79050',
                          '46759','59172','13954','87262','98319',
                          '85355','38361','71435','17462','25590',
                          '76391','76527','91329','80594','14127',
                          '85975','19660','74556','27043','13046',
                          '51955','33213','92594','17694','55818',
                          '59033','79118','87574','51794','40640',
                          '30331','39141','60630','23269','95466',
                          '91419','58461','29800','79931','24272',
                          '60858','71439','80721','46842','93154',
                          '20721','45492','74974','84627','41709',
                          '54354','19557','57605','38112','50264',
                          '92777','80343','46851','37749','25216',
                          '10565','56096','21138','95757','43439',
                          '56025','60572','34084','46085','16331',
                          '61939','62439','54428','70762','54239',
                          '78548','24528','99862','58256','40662',
                          '68512','60222','67754','36965','13114',
                          '85608','70478','88859','24680','14763',
                          '65522','12142','62359','82779')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


