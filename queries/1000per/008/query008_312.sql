
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '26072','35328','49575','78854','99480','90935',
                          '18576','59744','11960','14529','58613',
                          '83152','19471','26103','77196','15239',
                          '15327','96254','55484','53492','73891',
                          '21461','25868','70919','92012','38707',
                          '56213','83673','56152','84007','21321',
                          '91532','13256','82200','76869','46075',
                          '25805','10151','56262','46725','95869',
                          '51716','24076','56132','76036','20990',
                          '64213','56323','50888','63181','77857',
                          '44285','44935','19850','51946','24393',
                          '31926','14082','71719','37544','15478',
                          '73277','93108','84701','77827','41616',
                          '98055','83037','34091','16470','93480',
                          '38892','38449','85941','20684','26990',
                          '13305','77378','54145','18232','15686',
                          '91396','86283','20348','42729','76167',
                          '12156','40654','34609','18322','89853',
                          '33851','92351','43900','72717','65675',
                          '22887','24322','32747','13220','69303',
                          '19208','59946','48922','41796','51106',
                          '50357','47759','32660','26320','46621',
                          '50578','47699','65922','43220','22973',
                          '57360','63599','28807','66095','60957',
                          '91661','76612','74907','72393','50451',
                          '94570','25402','17384','75529','37989',
                          '66698','29398','89756','49980','98440',
                          '36481','52631','52089','92342','32486',
                          '41919','27472','24502','24071','19773',
                          '35637','60914','20288','84443','35498',
                          '90775','10251','14799','71956','30849',
                          '41773','53537','72819','94883','61657',
                          '22420','93980','23294','53476','53868',
                          '68941','60044','79278','86748','44346',
                          '73658','30863','14888','49881','83091',
                          '64630','56709','15663','38666','73384',
                          '85824','29821','84429','45545','21815',
                          '86323','21588','35252','35361','39067',
                          '35075','12015','15695','89074','94518',
                          '88728','29155','68252','23291','61287',
                          '35821','51342','15801','32851','13872',
                          '39168','37600','66845','56137','30598',
                          '12354','60406','75357','85773','86419',
                          '95286','61033','38662','30788','90411',
                          '32645','37487','73687','62642','19621',
                          '53155','64348','85712','93548','97531',
                          '56914','83615','93133','16635','26551',
                          '92104','13598','49504','98836','26535',
                          '59379','54617','50843','65796','96294',
                          '16787','89423','27683','29029','23558',
                          '80039','27382','32393','81205','23996',
                          '26806','60915','33698','58260','53974',
                          '93967','76804','13589','91976','15933',
                          '33383','24802','64452','82493','67849',
                          '88839','55493','99715','71293','13470',
                          '23278','28637','70204','47609','56961',
                          '83147','23843','63031','88058','97518',
                          '18381','91156','58855','31386','82624',
                          '17533','41858','25702','99266','21831',
                          '56626','41300','90922','44509','84609',
                          '27856','98437','83385','80117','65348',
                          '60701','63510','41805','79716','14473',
                          '93506','15316','41395','21202','72279',
                          '70364','96516','58635','11828','69306',
                          '31675','96115','46584','14075','28380',
                          '60070','10697','11502','94129','70184',
                          '74024','89130','88042','84033','83395',
                          '18800','39330','67127','66188','77195',
                          '49633','94469','93261','60124','71661',
                          '98116','53030','45992','74451','78650',
                          '92229','20026','54774','81854','77787',
                          '76806','35495','81261','62910','83253',
                          '47804','99783','53523','22596','65451',
                          '98736','33028','59187','30041','19593',
                          '89445','19186','97311','54103','72663',
                          '53149','97272','61326','20305','66783',
                          '11581','76946','62228','89014','29353',
                          '31916','71253','23432','59432','27893',
                          '46589','84704','55444','49444','88930',
                          '37477','53975','37115','30684')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


