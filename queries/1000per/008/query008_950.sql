
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '26113','10970','39490','95642','28739','23016',
                          '51461','19647','18611','70358','65896',
                          '33826','86780','75565','37885','39037',
                          '31866','57117','28574','18182','52332',
                          '23970','53580','96271','45667','99721',
                          '75834','15187','82105','14462','31399',
                          '84960','85862','36983','82162','92044',
                          '63101','22609','90024','33441','19614',
                          '66030','14251','45386','90607','78682',
                          '62491','22180','87652','58331','96274',
                          '38631','24845','95184','83785','40739',
                          '12185','99507','80646','56593','37153',
                          '59928','65469','63514','37978','24128',
                          '97750','73110','89940','14528','84031',
                          '65263','16589','58881','54220','62623',
                          '57101','27251','39468','70467','92333',
                          '56744','22284','27694','53308','95042',
                          '60302','21661','85489','39263','96345',
                          '81121','95903','43287','91865','97912',
                          '78722','62783','43226','11207','99087',
                          '35075','94088','55630','39979','41601',
                          '46863','64526','99249','62841','79770',
                          '73147','58665','71305','20018','56063',
                          '30220','96191','36492','22114','99117',
                          '65116','43592','20252','91774','10526',
                          '94331','31956','50393','18193','73178',
                          '51873','40799','57413','47750','98346',
                          '17781','82478','26010','60864','22570',
                          '90404','63371','68767','53434','63755',
                          '57641','69918','80452','57285','41642',
                          '33310','57135','82675','27691','56761',
                          '16958','43936','15864','34252','16767',
                          '19783','99399','55284','30885','98706',
                          '35353','25520','88836','77015','47424',
                          '86615','87076','28937','74907','59613',
                          '70606','67295','23719','43987','43755',
                          '58245','81450','28913','24623','87699',
                          '81543','89181','33513','10832','97868',
                          '51576','74496','38953','30014','83262',
                          '90553','34758','29468','61617','34882',
                          '30050','85956','78136','88808','25337',
                          '62158','32483','46364','17813','17331',
                          '59810','43860','17414','12187','24605',
                          '40794','30007','28262','19928','37071',
                          '90577','93733','16051','10612','90275',
                          '98576','81077','78624','85823','58566',
                          '83940','25100','19029','74163','50119',
                          '95204','88076','60109','28576','58008',
                          '84084','89834','58209','45261','66251',
                          '52227','91804','50942','56285','45883',
                          '19341','44056','57230','51435','10958',
                          '46558','92785','97011','23825','59488',
                          '56859','34109','71463','61548','38986',
                          '47461','87141','93012','22719','59437',
                          '60669','96408','18497','60925','46314',
                          '70596','47571','38422','84731','62663',
                          '10011','16123','53173','19304','98020',
                          '99943','82995','20179','79753','54148',
                          '30608','99423','64669','12329','32904',
                          '90895','67020','70309','56912','63803',
                          '40466','93146','47777','38164','37428',
                          '25174','32621','54031','10454','34781',
                          '62303','98190','14539','60853','76517',
                          '94104','69504','88591','68175','87424',
                          '47103','22229','33534','98504','61904',
                          '26260','32212','11243','18148','16567',
                          '66714','74604','12188','72117','41464',
                          '67737','30956','27928','72735','72804',
                          '77071','92613','62793','71202','84319',
                          '36395','59487','30493','74255','97856',
                          '66462','69022','72330','96247','82945',
                          '17676','18495','52283','66907','88910',
                          '67830','85036','14568','49536','53320',
                          '17155','13427','12768','34789','20750',
                          '37190','53222','75690','42619','55197',
                          '32580','65564','46432','48792','83979',
                          '69596','56826','28951','54379','29611',
                          '86294','52468','29976','22927','18613',
                          '38927','89826','31798','90228','69060',
                          '62168','28367','57951','64841')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


