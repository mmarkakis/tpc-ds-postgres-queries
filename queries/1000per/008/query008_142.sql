
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '55291','18307','53677','91549','37844','49396',
                          '40494','74633','85681','48415','63854',
                          '11485','55540','95107','42144','80794',
                          '84828','11520','89301','64385','30695',
                          '72599','89339','88198','87008','64728',
                          '65778','92615','11845','22393','82225',
                          '19244','64847','63992','89494','96217',
                          '49382','16058','16173','57565','18631',
                          '22659','39063','34268','53367','47001',
                          '56590','99686','15553','75182','12691',
                          '44336','25747','81236','10527','86368',
                          '20255','62082','46852','69387','64364',
                          '66158','56861','27071','30707','42129',
                          '71028','46343','87033','87996','54205',
                          '87037','38010','76962','94002','82965',
                          '47007','41127','87875','64492','21409',
                          '30381','71757','95850','75927','20512',
                          '57410','90977','74763','90074','84958',
                          '45597','77810','43746','40230','77051',
                          '15379','31056','65942','45766','59219',
                          '73201','19745','96533','43772','63149',
                          '15377','12114','28285','30848','50735',
                          '84220','19123','95207','13820','95039',
                          '45518','26691','36660','98044','66937',
                          '46144','26714','78348','63122','16375',
                          '85179','29955','25805','74952','33787',
                          '23903','90352','43204','59480','22868',
                          '27905','26822','73020','98617','58980',
                          '28257','10197','30083','93724','60878',
                          '97814','25030','76978','64291','64746',
                          '88854','75271','10170','21391','82167',
                          '63886','73025','52394','79871','30888',
                          '58070','39245','14696','18824','95247',
                          '25291','16666','51821','49280','33304',
                          '44289','32885','75628','61449','48435',
                          '35985','66299','90260','26843','29495',
                          '54225','79295','14083','97219','27095',
                          '65263','38608','12648','54354','31123',
                          '38303','40899','69804','23458','50104',
                          '50808','11682','28879','63151','70584',
                          '75636','67319','34765','55955','74779',
                          '32730','10223','69624','12820','83260',
                          '49856','54831','27454','29324','75667',
                          '48231','32269','25408','28553','67035',
                          '94721','39678','33904','84605','81191',
                          '19844','22449','83517','61612','19530',
                          '63465','92947','22072','14406','88206',
                          '44736','62502','82048','72029','99534',
                          '95132','49979','93162','23363','65717',
                          '62364','95960','25649','47606','42121',
                          '19805','31415','91123','87352','56376',
                          '80905','90515','29136','81907','42197',
                          '52922','73673','38182','91929','67061',
                          '43073','92831','58267','39573','77332',
                          '59934','72543','86566','91675','89480',
                          '78761','21572','26836','68295','48169',
                          '86168','39199','62131','70676','58582',
                          '79168','83920','21576','12132','57270',
                          '17277','95827','43954','64830','18910',
                          '58807','80569','50162','16437','79874',
                          '44787','12405','69429','47619','15760',
                          '93752','68588','97487','65208','97822',
                          '14279','62228','30563','29329','99254',
                          '68290','20366','18610','98794','61491',
                          '13595','95135','25008','84728','69946',
                          '21206','56086','10338','22123','10536',
                          '64491','64557','36339','37365','93714',
                          '69974','71627','59753','14809','62291',
                          '24732','56296','34241','63603','70692',
                          '29910','98696','39103','84944','88470',
                          '73746','80840','96852','67383','68795',
                          '54341','67346','38396','43791','36750',
                          '31657','25019','81512','55467','43723',
                          '13195','27270','73588','92952','54503',
                          '46621','63014','78942','11123','32458',
                          '96805','68057','64467','93020','26532',
                          '32721','49550','79866','66569','68857',
                          '14930','13798','29458','79394','88101',
                          '49473','49521','79625','15893','17982',
                          '95096','96150','37015','79063')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


