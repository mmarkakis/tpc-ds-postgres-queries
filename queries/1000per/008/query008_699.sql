
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '99795','34273','57242','82768','27931','28926',
                          '83338','13955','35849','92596','42389',
                          '36250','23360','56003','89206','35040',
                          '71439','44686','73467','49358','88695',
                          '25364','97167','18769','35568','42514',
                          '35328','97792','87631','84051','63464',
                          '22571','89705','27249','63817','76833',
                          '97585','59867','91434','82441','43530',
                          '42000','91869','43932','11485','71950',
                          '11088','71080','48351','10452','88342',
                          '73481','87701','17732','98893','25560',
                          '79150','51867','93976','87806','75186',
                          '68395','64931','98482','79392','66062',
                          '56304','80770','88481','46267','14064',
                          '71306','42306','23170','81387','68307',
                          '59342','12021','75964','10013','92288',
                          '53827','26526','30703','11779','23180',
                          '36421','61806','44067','73881','30270',
                          '63416','56354','93379','25443','50380',
                          '59484','96149','76610','98355','15196',
                          '99487','65387','14401','96177','22576',
                          '32448','15440','43719','82524','79277',
                          '99255','34594','37978','11070','58157',
                          '34705','96428','85014','95184','84860',
                          '99581','97705','82840','93377','38331',
                          '97581','24526','92511','13865','60879',
                          '55375','42141','20447','41571','66842',
                          '53450','25006','94917','37925','75259',
                          '96290','31853','52003','56520','54675',
                          '66934','44489','66561','34710','78297',
                          '88343','63642','84253','16593','94892',
                          '47386','45410','78715','27264','25436',
                          '28576','75354','39438','33860','78334',
                          '57274','30433','75045','88364','54076',
                          '91568','48373','73409','76627','32481',
                          '86219','72011','53780','87560','56106',
                          '34617','40493','29412','50243','41792',
                          '13155','88143','10305','95101','75479',
                          '52423','66679','17659','10710','37013',
                          '53253','73436','21356','32941','24210',
                          '10722','81749','16289','53868','19742',
                          '51787','42047','57410','95753','43708',
                          '49823','43572','31088','69859','75240',
                          '86747','36480','73747','90667','60431',
                          '17707','20517','77860','82680','76059',
                          '75375','78498','77146','18376','58609',
                          '59182','88629','83190','62318','47372',
                          '98749','47224','48353','93614','41492',
                          '28253','95166','88874','36947','76600',
                          '66258','33128','16097','82132','78956',
                          '84154','50545','64005','97677','22202',
                          '16141','89089','20341','11147','35942',
                          '40742','34023','41589','42608','23220',
                          '45807','23332','86373','23223','82083',
                          '35801','48107','63677','73283','38295',
                          '93642','45634','27348','14818','93179',
                          '27440','78353','87947','32182','23918',
                          '26245','70902','31422','11473','68137',
                          '92138','24042','66461','14353','40117',
                          '97361','29013','21491','82532','61669',
                          '18799','43055','70360','48479','69640',
                          '13538','85255','41837','41092','17027',
                          '57606','39174','29398','53549','38332',
                          '58276','83573','31080','87263','76519',
                          '93105','42727','68183','48880','50409',
                          '67176','65795','89345','27314','96701',
                          '89538','86907','43869','96036','67366',
                          '56571','81315','28998','46499','91586',
                          '18507','90228','26656','67087','63735',
                          '47296','94531','17586','60893','32272',
                          '75681','14902','50005','45204','48703',
                          '38756','15905','51467','10389','69862',
                          '61107','93922','12890','58514','82353',
                          '76341','25637','69552','88643','61148',
                          '75607','67771','92392','66482','16172',
                          '31810','11289','34011','65213','27089',
                          '81695','65883','11166','47160','38099',
                          '42734','26792','78295','78765','31837',
                          '25910','38629','82319','94855','95074',
                          '69729','49640','40766','29875')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


