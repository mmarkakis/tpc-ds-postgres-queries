
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '87640','42921','44781','46548','34338','76782',
                          '27600','96231','80679','20515','84453',
                          '18851','52234','31798','38230','55333',
                          '89789','91961','66080','43663','97183',
                          '40089','68199','85588','50498','28164',
                          '61982','80382','10273','38452','22975',
                          '21750','65925','55707','44584','27603',
                          '96275','77996','53998','20464','98978',
                          '42258','80138','13781','12533','94020',
                          '85930','94507','47750','90099','89496',
                          '38193','10981','10677','44663','20029',
                          '97120','35525','18579','56531','93620',
                          '90744','92920','88443','29213','29140',
                          '65124','33815','93235','74331','24650',
                          '94992','93190','17640','15933','22354',
                          '72187','49347','19960','71134','34660',
                          '71657','27152','45825','84288','45101',
                          '63594','84701','54421','91101','23198',
                          '47245','33055','95724','19094','37255',
                          '78994','77145','78722','31223','10738',
                          '53264','71097','19230','89051','28658',
                          '26314','53931','12803','72424','34634',
                          '99467','93840','72707','62318','96610',
                          '45388','24241','71086','72489','66481',
                          '25090','99063','92835','36997','40169',
                          '63770','69049','71066','71070','38847',
                          '59554','80565','54547','73719','75258',
                          '92735','40627','47573','58051','59702',
                          '99285','97197','63693','51842','17595',
                          '83416','74882','21784','33209','47925',
                          '94559','39384','50677','82647','60564',
                          '47339','53105','20967','82551','88712',
                          '45196','22006','97240','34598','23651',
                          '84041','83938','22370','72195','55918',
                          '35325','46806','13540','59130','34308',
                          '58883','93444','88041','72736','58929',
                          '73003','20060','55824','99073','66315',
                          '57938','31752','94471','88072','92340',
                          '18584','71831','61270','59457','61614',
                          '79397','24896','85200','69585','22545',
                          '19571','10562','42395','20960','28107',
                          '56119','52757','52412','79964','49469',
                          '79282','58795','80483','11339','39357',
                          '28524','24632','24645','13019','85729',
                          '97188','83072','94577','45578','39858',
                          '22442','79619','24217','53505','37269',
                          '33077','37232','63460','30236','22335',
                          '51245','59316','13099','87051','13595',
                          '17908','26571','37365','32089','85874',
                          '88470','51760','19688','37309','91315',
                          '89152','73807','97792','43078','65907',
                          '22275','97017','72545','32926','30491',
                          '57831','57586','98742','13890','30783',
                          '13219','31413','26415','95192','69834',
                          '43764','79331','95763','82091','86599',
                          '80935','86380','38611','82686','90350',
                          '88100','40896','12771','37503','40629',
                          '84037','12837','54793','36501','54554',
                          '40915','71846','14615','49585','21275',
                          '15682','50068','47757','50471','14582',
                          '11255','77075','40768','17265','43747',
                          '89181','81046','86175','62502','98520',
                          '84361','53849','16268','31294','42361',
                          '81204','35653','74280','68431','48666',
                          '70691','54347','70740','84148','25423',
                          '54923','32059','76288','59007','77043',
                          '70861','59706','93687','95858','64463',
                          '36860','48801','74492','97498','76325',
                          '30509','64035','29548','31674','34941',
                          '87340','46857','19553','51290','26277',
                          '23390','64056','35172','35030','15067',
                          '50047','41191','51934','16437','55165',
                          '85282','34696','75567','78706','84156',
                          '18821','10415','85566','66908','88214',
                          '55317','99552','43646','16511','41758',
                          '16844','42743','81890','43641','79641',
                          '99268','57241','76400','24107','27708',
                          '60585','96083','46175','35669','77792',
                          '54066','61085','40301','36639','89321',
                          '27131','41059','37229','57518')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


