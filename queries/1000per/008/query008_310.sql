
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '41640','78376','63658','92445','70539','82624',
                          '46298','43999','27461','66859','35744',
                          '17790','39885','67232','66467','66259',
                          '68433','55597','40352','54632','23580',
                          '28789','36122','51112','30947','18398',
                          '17167','53031','97350','23984','23309',
                          '51325','69294','12483','22065','27561',
                          '42463','67332','62882','79242','77687',
                          '69772','21241','58871','38013','41171',
                          '47425','63041','64031','52153','11732',
                          '50015','13079','88980','49832','41818',
                          '24733','79919','97675','47094','85463',
                          '36963','19870','20667','82251','37682',
                          '29212','14064','96904','40397','94942',
                          '69417','48242','63891','38548','62041',
                          '34674','27237','38660','30394','13526',
                          '75268','34466','52072','87349','50493',
                          '19986','44212','74832','47767','49242',
                          '92999','52658','91700','89047','91801',
                          '65405','10261','39776','89156','59761',
                          '17154','43500','78158','88053','73337',
                          '50998','86704','81660','44988','76723',
                          '33284','89758','34098','71953','81865',
                          '49284','43794','30692','50684','64988',
                          '59285','45170','76745','74238','49059',
                          '99790','75424','18578','51982','22084',
                          '91786','73204','26706','18553','40829',
                          '12250','66405','52467','40826','45492',
                          '20305','58634','63869','93660','52797',
                          '83217','56336','96812','47226','49367',
                          '91851','22567','93233','76990','93100',
                          '73587','99671','10612','42561','20224',
                          '95372','87630','54073','18616','12599',
                          '50023','36732','10239','36145','47480',
                          '35621','16963','13823','69707','30731',
                          '77306','59137','58450','48123','17507',
                          '48965','37286','99480','30053','92934',
                          '91767','10727','75875','72466','45195',
                          '74052','89855','53300','68392','80940',
                          '94577','63521','80060','54524','68201',
                          '83300','39810','42585','62784','95161',
                          '85344','42894','71278','82584','89624',
                          '25404','51913','66270','64658','69376',
                          '80624','34148','10414','68179','96071',
                          '62602','87479','11390','64191','70663',
                          '62297','58928','40078','86089','19900',
                          '78523','85837','61364','38342','48842',
                          '38650','85230','18367','68832','33413',
                          '49932','76307','84210','87778','42972',
                          '92130','95595','14299','98434','18666',
                          '65188','63607','96198','18810','50392',
                          '30382','77341','48659','91835','14397',
                          '28680','47615','65862','51793','52694',
                          '35428','61861','45435','93276','71580',
                          '73187','68053','14291','37710','92829',
                          '24146','82780','34487','38613','81401',
                          '23992','45465','39981','79213','55102',
                          '77747','49126','28517','57257','46970',
                          '79715','96364','61890','17648','78236',
                          '62393','29282','18607','35176','63568',
                          '24699','37202','34804','58937','11949',
                          '73462','16432','37889','42357','21324',
                          '60871','21024','45217','61655','96922',
                          '25988','97284','15111','16685','72419',
                          '29455','87966','53479','39855','81492',
                          '83283','96075','73865','39938','73229',
                          '26033','38828','68024','35500','20761',
                          '65117','90503','95849','49224','99834',
                          '79355','24606','55996','20777','28626',
                          '32199','89473','73344','29014','35627',
                          '49478','92002','30068','23568','85603',
                          '14179','21559','23261','56238','16131',
                          '89119','51428','18493','34532','50791',
                          '26764','38231','87639','55289','60617',
                          '22341','59747','21937','51769','77780',
                          '58202','49158','37196','58506','64661',
                          '19483','72730','55678','66469','90594',
                          '17340','32619','51313','63791','27015',
                          '10907','59574','17379','37672','62093',
                          '21875','97139','30904','79458')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


