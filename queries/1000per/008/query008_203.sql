
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '92005','87493','18048','95034','75088','45621',
                          '25061','49607','57633','92423','61660',
                          '13626','96543','68639','73383','16335',
                          '55734','16714','20409','88028','76771',
                          '31185','98890','20862','49462','11699',
                          '31927','60683','50758','81959','24722',
                          '94438','79940','78347','13419','34999',
                          '44051','35061','66607','81168','84843',
                          '30334','45857','43587','44475','52561',
                          '89441','66526','21395','12101','46344',
                          '52701','28888','57525','81357','44690',
                          '42577','44246','33192','93838','91542',
                          '83477','60431','80834','30298','81446',
                          '82410','96943','58465','36838','17268',
                          '28363','93225','36404','71489','55683',
                          '98577','20143','39225','92753','71120',
                          '38141','48745','52966','12284','19025',
                          '73321','72226','30254','69297','60754',
                          '69303','68294','82526','67470','81245',
                          '19222','96383','80927','12745','31566',
                          '90381','50923','40546','27818','31521',
                          '64045','99137','84781','66640','44939',
                          '61740','48280','85860','85289','18916',
                          '38943','98558','68848','11554','93728',
                          '57271','88724','91797','48946','98983',
                          '24273','79070','31302','14734','95089',
                          '97962','88832','34152','75002','87954',
                          '12451','44996','89171','59510','76622',
                          '64281','23099','99494','46228','45593',
                          '64785','89683','89625','60678','80507',
                          '35694','39790','70704','52675','39551',
                          '45052','24182','17813','86970','98601',
                          '95588','83672','50712','77113','48780',
                          '83256','39321','36259','18330','70380',
                          '91103','66271','72841','83649','26096',
                          '74910','87004','25393','95122','95705',
                          '88352','70162','24906','47017','22252',
                          '42934','56092','78919','14032','89320',
                          '86706','15814','70922','79066','61904',
                          '79793','55321','85131','50829','47845',
                          '56509','46224','65004','82883','55950',
                          '58196','47417','92552','60525','85702',
                          '74252','31324','91231','64427','53284',
                          '12646','30207','56744','22975','12945',
                          '67601','28412','38251','30079','27772',
                          '50251','33298','50641','61299','56014',
                          '91880','27898','36261','11261','63698',
                          '66112','90324','19308','43791','18130',
                          '21737','32584','39811','30621','76432',
                          '70731','71741','60364','23616','58475',
                          '38286','78275','87671','55494','50657',
                          '56715','14909','69288','16791','63341',
                          '11684','55340','54943','24797','37117',
                          '97692','19062','48542','36926','75889',
                          '41813','29158','57777','76399','18069',
                          '93893','53932','69517','88684','85399',
                          '43878','38845','69395','26775','99409',
                          '44636','28057','34862','49890','43214',
                          '99447','90648','57602','53703','46997',
                          '80860','82908','40436','52798','52407',
                          '77977','81383','26166','97586','59824',
                          '76016','36039','80033','62946','62193',
                          '67303','67735','73305','18879','63265',
                          '38156','93233','79786','21368','75645',
                          '38136','70779','95923','86185','54656',
                          '19914','56920','91167','64612','34190',
                          '92694','40569','46299','88607','66983',
                          '70395','49088','34823','33063','26721',
                          '47642','89175','30422','89498','81921',
                          '51859','52236','38298','79700','13756',
                          '56623','57768','54670','71819','23596',
                          '61038','68293','69385','45321','78232',
                          '87699','34049','55186','87348','37859',
                          '82037','94053','37725','49057','32150',
                          '67797','43701','15446','15799','36544',
                          '93935','10397','66308','54511','89596',
                          '12166','16829','37751','98492','72068',
                          '14071','96825','67001','33103','46071',
                          '87763','57531','95514','87059','79096',
                          '96301','49866','88529','76411')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


