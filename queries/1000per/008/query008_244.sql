
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '27579','23162','67017','22900','44448','20468',
                          '61143','39040','22037','45678','20415',
                          '19130','12712','62975','85691','55769',
                          '20268','14144','73257','65005','19338',
                          '83191','84482','51083','87173','65830',
                          '36238','26517','48746','43356','44527',
                          '59104','55495','68147','17400','78147',
                          '78163','75675','45794','31011','28437',
                          '12001','40817','94546','42864','46223',
                          '27238','55847','41280','84768','97278',
                          '15900','37808','91991','72519','59581',
                          '37167','52010','73285','27014','72132',
                          '37292','25683','67918','37858','72806',
                          '85824','44071','58205','76140','45043',
                          '41877','23690','95540','99087','56388',
                          '96937','10343','46739','67652','39678',
                          '40670','53282','18158','46437','58481',
                          '66819','39181','94976','58772','71721',
                          '27400','33586','28072','77245','69624',
                          '68765','44044','12910','18613','70531',
                          '59611','18697','84241','16394','13731',
                          '41593','94879','10404','79325','50364',
                          '51579','51140','22443','55587','86538',
                          '93367','10235','55891','73447','79441',
                          '46787','36607','71956','38732','78782',
                          '38724','70352','78488','29440','90610',
                          '18685','18882','97474','38798','92673',
                          '43566','39117','35652','38222','13244',
                          '16931','52322','59738','10499','64451',
                          '69495','22805','84852','88071','80633',
                          '13316','11397','46317','87450','43298',
                          '58010','79141','37663','94099','44783',
                          '85620','77279','25750','46477','56173',
                          '92432','41023','63938','80154','62766',
                          '92082','45536','96246','71585','79361',
                          '24384','21514','36323','35223','44640',
                          '92105','83783','38199','50541','57880',
                          '48122','20916','61350','46961','48782',
                          '80346','36574','90320','65946','66646',
                          '69493','57828','72604','69976','69203',
                          '13305','42439','33790','16171','68677',
                          '94736','17054','41081','63173','76410',
                          '94207','26055','61575','10173','34687',
                          '68062','28582','64155','55653','86195',
                          '25139','37318','68228','18790','56182',
                          '37490','93629','14340','55352','81667',
                          '71285','47609','91042','14376','60951',
                          '48635','37872','55099','83956','70173',
                          '30559','32949','38422','35270','42710',
                          '94718','45339','28465','90924','67888',
                          '72207','98355','62635','45288','10323',
                          '74426','39842','26294','97197','10055',
                          '83122','87873','43899','88120','99412',
                          '44135','73458','94045','43760','29973',
                          '44823','93759','42730','39829','69736',
                          '93936','91255','96405','80373','70899',
                          '76586','96527','17126','83082','84230',
                          '79044','64733','80047','93750','37617',
                          '97612','68533','42217','36270','74338',
                          '63073','83779','88207','24241','30829',
                          '99192','38537','77391','74928','23480',
                          '39721','58059','43681','87916','28631',
                          '89764','39525','65322','39341','17893',
                          '48055','78837','75502','28600','97123',
                          '62807','68165','17095','21401','24900',
                          '61956','52719','82931','45856','53169',
                          '72577','32289','31838','25736','64213',
                          '73842','47351','17222','67423','69033',
                          '16410','66685','66004','19005','44476',
                          '95463','91735','11715','68580','22382',
                          '42687','59108','95474','18488','63823',
                          '11070','99271','90292','93152','63977',
                          '81557','31467','69977','45485','51708',
                          '30707','69759','32496','47393','36569',
                          '50984','68873','30059','96930','94472',
                          '82134','97224','76580','35716','24521',
                          '16301','80719','64720','65751','83056',
                          '93787','77465','41568','39577','74706',
                          '96973','87067','68738','87391','44520',
                          '86593','38130','39224','93311')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


