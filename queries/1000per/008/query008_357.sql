
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '27914','68267','56745','83196','47356','24343',
                          '23553','93228','33555','87397','90387',
                          '17947','67062','33795','77287','21764',
                          '13068','57562','85683','19973','58311',
                          '96391','31282','70397','89221','51984',
                          '20406','28615','31328','21056','82889',
                          '29110','42911','68810','34560','90825',
                          '85158','25265','57831','87421','75676',
                          '49515','91433','13818','77991','46534',
                          '73313','25767','55826','57768','11446',
                          '96993','71274','22700','17791','42885',
                          '37126','95211','69292','11527','82135',
                          '79677','82208','54532','21137','23918',
                          '45082','42576','70010','67074','53112',
                          '36776','14100','23073','39494','33131',
                          '76110','53659','85234','40848','31358',
                          '24655','78183','84080','45504','90664',
                          '59987','94039','27920','13468','76495',
                          '14924','21047','27994','84522','42797',
                          '10713','14437','15739','94424','57020',
                          '13628','99370','75929','60085','59709',
                          '53576','77921','18467','73693','14176',
                          '24984','15847','62397','13509','58522',
                          '77597','73741','30861','52339','96820',
                          '30775','19805','27854','14058','62939',
                          '36918','45990','84759','78658','81747',
                          '55333','97605','18026','60262','35720',
                          '38441','61656','94206','22436','54982',
                          '73501','64536','14475','43614','51652',
                          '53933','78884','67293','80404','55278',
                          '94777','78195','14710','32798','66393',
                          '97396','56639','76210','72835','65457',
                          '12729','91115','93436','62589','70421',
                          '31167','78800','90713','27822','82129',
                          '88613','43194','66757','46953','17290',
                          '43483','42208','26622','96055','95623',
                          '48593','55712','54574','49297','86947',
                          '91516','50026','44431','33284','62325',
                          '62309','44141','27667','52250','68225',
                          '98323','59860','82452','82685','75801',
                          '20157','45626','64215','88487','72285',
                          '89453','37059','83769','28731','42028',
                          '93144','65453','29260','87445','44624',
                          '95133','45396','73712','50433','12936',
                          '74498','38353','65244','75052','72852',
                          '85488','19773','62595','69487','84628',
                          '45047','10660','85100','55994','11843',
                          '76139','14871','12554','56019','33135',
                          '95738','45498','76431','41893','89641',
                          '39439','33880','45964','75882','72845',
                          '35933','76459','98799','19262','55365',
                          '37603','73622','35880','65287','72078',
                          '30952','65756','52908','11477','44376',
                          '53508','87935','22633','63662','88560',
                          '23146','78448','69662','19664','65431',
                          '93563','55605','41759','55590','81174',
                          '69339','47683','85051','41248','70081',
                          '82597','79140','60191','86805','38439',
                          '93039','13385','87022','47037','92130',
                          '13387','50101','69454','67065','22688',
                          '87219','39509','61911','36969','88842',
                          '53876','17504','94444','12463','83566',
                          '82946','52170','28924','81133','98098',
                          '53556','74393','41593','14845','22573',
                          '73369','12793','81622','10410','92383',
                          '74528','88130','21246','81439','44670',
                          '22683','39699','61032','17450','78122',
                          '24530','90511','31170','10058','33993',
                          '94619','70838','84999','72789','55776',
                          '55266','21460','13494','68953','23361',
                          '98834','41354','11563','23712','60836',
                          '30199','97955','99495','17423','84328',
                          '71226','91712','74067','36649','39336',
                          '97121','41661','74469','73022','56387',
                          '52583','48348','51099','92675','50695',
                          '31677','12538','35316','53726','68214',
                          '16080','15332','72592','62052','89787',
                          '26364','52135','58948','74691','97552',
                          '22911','73393','42721','61695','84388',
                          '90116','37631','42052','58113')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


