
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '43292','75064','20342','79368','36127','55470',
                          '86465','48209','52602','55150','85049',
                          '63447','79440','70600','25744','52356',
                          '50861','94404','48832','40723','71832',
                          '18611','77727','23326','25344','76167',
                          '38370','61299','14176','90030','21921',
                          '81322','48446','92130','37253','64929',
                          '18237','59135','34583','19196','46004',
                          '56129','21409','25168','16194','50751',
                          '71334','31735','13874','36592','80156',
                          '87396','55191','96759','25637','41692',
                          '59187','86601','80050','18775','71043',
                          '62966','66585','75422','33875','86586',
                          '26068','73883','40924','87549','79847',
                          '32525','36247','15167','52649','23961',
                          '66941','87542','69308','53235','32780',
                          '63406','52973','79312','74543','13088',
                          '92343','79927','73196','27138','43568',
                          '70949','89189','10572','67398','89663',
                          '17829','77687','99863','93075','61974',
                          '46963','22065','78187','89444','27778',
                          '37517','81063','43242','74258','59155',
                          '97682','36545','17542','54540','70498',
                          '56172','39866','20358','34704','80390',
                          '91126','99643','68914','94567','24252',
                          '32847','53390','75005','15018','33848',
                          '32559','37191','76258','34493','15234',
                          '34935','97714','22747','29250','68825',
                          '48149','51562','28174','32313','24855',
                          '90295','43925','41698','17101','12016',
                          '67887','44646','77736','16209','69526',
                          '45493','78471','26915','58926','90048',
                          '32216','72830','96841','13570','58188',
                          '15991','35415','62783','16407','58544',
                          '35927','42290','15787','71238','81569',
                          '65220','50211','82646','96044','29401',
                          '49527','19293','88293','89255','88810',
                          '72600','50547','65128','78359','47955',
                          '36509','11964','21439','73558','25587',
                          '42755','38834','10509','90731','74618',
                          '44818','73702','42312','86608','70745',
                          '69517','90208','37878','47802','19803',
                          '40294','11725','43883','17106','64022',
                          '82143','71500','67077','19584','56421',
                          '52802','45956','47664','59569','32237',
                          '92907','25802','52847','35906','31170',
                          '98607','83115','38819','32014','81320',
                          '66217','56445','88456','12119','90719',
                          '88089','22185','94244','30910','74342',
                          '60111','42025','25618','60053','88210',
                          '73166','13123','80163','40388','87824',
                          '61585','61957','21806','10141','36758',
                          '13333','85189','92082','14474','67011',
                          '44984','78773','54194','95542','16969',
                          '34825','44971','31579','48047','61361',
                          '67735','51430','25194','12414','30178',
                          '31594','40738','97438','72224','38466',
                          '78081','32740','57793','79990','49674',
                          '71935','72227','89820','11750','49797',
                          '42314','77756','23715','52598','21011',
                          '80166','53262','15540','57839','88973',
                          '87852','11998','18417','59719','77833',
                          '40595','17490','18703','11695','23711',
                          '30412','43625','67316','85697','69145',
                          '29235','88006','35064','49513','24463',
                          '88281','87658','83338','69256','71013',
                          '35840','96393','68263','23491','66456',
                          '85637','52831','59747','99071','32256',
                          '50933','41559','50011','47066','35835',
                          '74278','75275','35679','34216','55809',
                          '23041','26980','19624','34794','50550',
                          '46664','61809','27702','88435','84225',
                          '31915','32961','38934','54407','58701',
                          '59258','14114','55895','22384','20537',
                          '78327','34459','78753','26912','39937',
                          '67235','58913','28291','31063','60349',
                          '55797','30198','32828','98083','42186',
                          '48171','62291','96074','96290','34130',
                          '15988','79028','49950','15090','55881',
                          '73831','35678','60816','18411')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


