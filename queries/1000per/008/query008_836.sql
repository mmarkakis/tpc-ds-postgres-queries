
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '99014','64336','37007','64071','83014','26560',
                          '45778','30745','71970','60012','28311',
                          '98103','28384','15083','80026','15113',
                          '94800','89714','49198','57154','99864',
                          '87188','41973','75960','95642','10616',
                          '83755','47652','20770','21727','41655',
                          '75556','25901','71002','22441','83425',
                          '95696','64910','58819','49110','41843',
                          '25447','59132','89275','97389','63993',
                          '10848','52616','89150','56036','55873',
                          '33498','89051','99117','61056','28820',
                          '64353','18116','27962','95342','16574',
                          '13632','97241','64664','44478','40948',
                          '26389','56950','33367','72159','63100',
                          '61939','14594','72079','32556','99174',
                          '25622','85441','88948','80161','98066',
                          '67920','87167','50618','90858','58060',
                          '63049','98321','25491','48261','63599',
                          '25888','24299','28934','21930','20174',
                          '70031','29750','28292','60089','80565',
                          '65542','85734','66024','91987','68267',
                          '59215','39641','79590','20287','18745',
                          '66310','49701','27666','80711','80203',
                          '78878','81238','50464','97724','42756',
                          '34662','63048','61685','33287','14472',
                          '83566','39762','56218','42525','15664',
                          '38669','26132','88284','18670','89886',
                          '47727','34802','75510','92559','93338',
                          '98971','94379','16267','73565','71448',
                          '95916','74880','17263','68627','71503',
                          '60005','17953','52468','23645','17771',
                          '42037','40922','77023','26876','60703',
                          '81624','11876','20154','44699','29073',
                          '56324','52663','60302','44800','46138',
                          '63551','32848','95393','49132','86340',
                          '60345','55380','21918','25031','67680',
                          '50660','50206','97484','48555','20761',
                          '66896','82152','44165','92032','37270',
                          '98382','94117','64272','77204','72264',
                          '15484','25566','66483','80184','67292',
                          '60997','29271','28643','36276','66951',
                          '59573','78601','70973','82419','20829',
                          '98151','25846','72895','38439','13446',
                          '64228','78327','10109','26755','67250',
                          '65575','70642','93449','84663','96456',
                          '18573','83780','48203','16177','60259',
                          '61737','39086','24040','86624','35310',
                          '78211','42169','72476','33368','51178',
                          '43721','79869','49218','88919','71040',
                          '81811','93884','25756','47734','79220',
                          '46278','43362','75817','25759','79018',
                          '67760','81296','83279','39589','86768',
                          '39161','56070','71703','74226','89869',
                          '71375','78540','50278','29740','82469',
                          '82878','35738','39219','84625','35812',
                          '64142','41351','90754','14071','44362',
                          '67132','65182','90315','75952','16052',
                          '73018','51153','40144','51248','11207',
                          '17739','75084','11512','90856','24147',
                          '24527','64123','72672','99917','12460',
                          '69682','99177','14508','21732','10832',
                          '58278','73055','71734','26161','15236',
                          '29590','33714','42560','41159','94067',
                          '48276','92968','72627','85801','12876',
                          '29295','41047','30119','85268','35368',
                          '73117','57059','38281','35527','50380',
                          '82202','31213','99368','58590','81141',
                          '62807','16526','34381','96734','19315',
                          '49721','50567','75194','49311','16592',
                          '35252','96582','75385','41266','32829',
                          '72473','33926','37973','99072','19451',
                          '42098','70295','33097','22235','17937',
                          '83065','19142','99672','81497','14699',
                          '14973','49677','27290','51899','63988',
                          '82937','93108','25097','83591','88462',
                          '55997','19298','12011','58828','36183',
                          '14173','96795','92462','98374','47575',
                          '99309','41892','17644','54098','53446',
                          '34914','31118','29079','11730','15362',
                          '59374','60584','79211','74677')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


