
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '82487','43816','87112','82004','97112','69602',
                          '99572','72029','27266','34499','16319',
                          '79772','86102','29938','91920','36264',
                          '37797','26941','69670','89514','30152',
                          '23553','96950','21950','68704','28075',
                          '59155','28979','73888','66974','50040',
                          '77585','78945','76098','69560','62991',
                          '96375','94109','21686','74168','37332',
                          '64335','97352','26289','71454','13979',
                          '46558','31314','78257','80518','94032',
                          '88551','45804','30981','93987','37793',
                          '79915','87123','43217','38322','73227',
                          '82542','64960','10909','86517','63842',
                          '12840','77108','22822','79103','38788',
                          '76586','71271','94423','92337','60287',
                          '75940','92743','70229','23851','93434',
                          '10105','96270','37877','45761','16467',
                          '64427','86623','87103','88968','12199',
                          '29492','87660','64129','13168','79946',
                          '71137','90612','59679','13585','89396',
                          '79007','55401','95572','99060','55395',
                          '46621','72848','68127','26483','40636',
                          '48931','83847','73920','80835','36358',
                          '37602','51394','53649','63864','38286',
                          '75649','93237','54371','12881','50935',
                          '98661','12142','48874','56575','60481',
                          '98939','44425','86384','66447','36737',
                          '18126','20033','42312','27047','66349',
                          '44031','87199','82098','94594','55054',
                          '67333','35338','73725','62945','97152',
                          '95395','83186','47988','43687','56941',
                          '40425','44181','27498','50945','87401',
                          '53845','89245','22687','82643','23875',
                          '98128','41825','50439','97901','49363',
                          '23907','54780','25660','79317','40669',
                          '33643','45197','90490','98759','57976',
                          '92657','37592','91961','36258','77354',
                          '72290','28202','91443','67585','17229',
                          '17770','10451','28194','46778','70723',
                          '46125','45248','90783','93546','43174',
                          '33719','74415','27722','65962','98301',
                          '64838','19650','26004','59374','57351',
                          '55411','64151','29775','67850','66346',
                          '55931','21031','26012','45441','92421',
                          '50881','15459','67828','63062','69710',
                          '86868','14729','97849','73983','18722',
                          '60295','62174','68689','12770','25419',
                          '29239','77965','97018','27092','31620',
                          '38659','35824','64389','10317','95426',
                          '10284','27959','71583','75553','37026',
                          '76872','51947','48198','75184','93896',
                          '40120','64957','46470','47615','12448',
                          '55773','67473','84668','74183','66195',
                          '79889','57499','44680','90626','63886',
                          '38816','69079','82621','30749','78968',
                          '66455','44602','23902','17234','87446',
                          '26644','54212','39995','58522','68201',
                          '88691','88804','79810','52036','17576',
                          '86880','57731','54403','26111','17785',
                          '95711','81548','54264','64941','12715',
                          '78743','38621','93818','87101','67898',
                          '26175','84582','17359','76032','99646',
                          '81580','97877','68220','14040','34226',
                          '45915','54874','55406','22274','73663',
                          '40913','74031','38227','26902','13362',
                          '32204','32704','19092','34318','44996',
                          '14770','88662','46303','31898','85365',
                          '82601','95671','20002','41339','52473',
                          '84825','25904','87833','81397','58137',
                          '22370','45001','31080','84352','46000',
                          '39433','54910','34228','40110','52876',
                          '73045','18643','24300','95139','28788',
                          '75321','26865','70351','66578','64444',
                          '42675','76894','31214','40653','39576',
                          '85362','87132','45754','48117','16155',
                          '62059','24220','10977','71683','65511',
                          '73169','10704','77801','59165','55699',
                          '69926','82114','82921','77082','54280',
                          '36062','41153','83371','89311','98290',
                          '45838','43829','20911','71255')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


