
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '49770','50155','85134','58226','35915','12253',
                          '33032','64143','92459','36330','15014',
                          '62038','14074','62040','73460','49311',
                          '20021','40850','52259','54582','71629',
                          '17462','62432','76910','21270','88580',
                          '98634','38435','64097','75254','43109',
                          '42757','71411','75071','32013','60093',
                          '69819','35738','26884','73789','11635',
                          '32766','72918','43005','78153','93684',
                          '36093','89410','43609','47559','15495',
                          '88284','94123','55061','80443','60326',
                          '89290','74616','75735','46700','74667',
                          '10951','36670','59718','92495','51380',
                          '91379','39489','42926','62279','70994',
                          '90751','65024','85271','93781','43043',
                          '67141','96978','82720','57021','71549',
                          '51883','22787','14921','94168','13954',
                          '34448','63918','71394','84249','23515',
                          '17589','76886','93035','66010','31546',
                          '19912','80068','72759','80776','69834',
                          '84505','85589','11175','34583','30826',
                          '16206','49849','48117','20700','94133',
                          '97724','40583','99984','73075','90674',
                          '40608','78915','82869','17749','95650',
                          '59989','52676','23208','91908','21272',
                          '18683','83873','82736','99145','47918',
                          '66815','76183','78615','67926','56284',
                          '68198','41791','27027','23338','33642',
                          '25478','65609','70311','12337','35223',
                          '22770','53147','17900','41460','44857',
                          '27814','54289','31851','62977','51547',
                          '28344','80349','61433','81856','18082',
                          '69112','45965','68626','58927','55085',
                          '75870','92039','16220','80132','67294',
                          '22652','86671','72301','97387','19388',
                          '75453','22013','53330','57062','76736',
                          '75839','26887','53183','75933','48555',
                          '58521','50144','45547','60151','79418',
                          '47039','96286','28560','91107','36758',
                          '61898','55879','38282','64116','18991',
                          '94068','26150','21451','76281','83478',
                          '79542','14707','30131','37904','87672',
                          '16825','95857','37988','89378','97590',
                          '71725','10373','88129','89561','68896',
                          '37615','33955','83546','45998','58496',
                          '72013','55551','77753','98191','22858',
                          '28190','84767','34830','88896','85901',
                          '57860','33769','66924','81978','89753',
                          '87576','17169','17778','50666','33783',
                          '77779','30990','62682','53350','78963',
                          '87820','67376','33239','50540','11093',
                          '13273','37014','54670','44028','59021',
                          '65121','15417','53810','91833','22924',
                          '82665','56604','82477','96086','38486',
                          '46622','65236','34047','67410','82036',
                          '19740','87761','77230','99646','12254',
                          '51087','89164','91293','42436','30654',
                          '20457','97789','34570','32825','35666',
                          '11840','39457','32886','62747','12751',
                          '35523','73273','30814','35769','74278',
                          '64888','42102','85189','48484','42526',
                          '53702','30319','71954','10230','96630',
                          '32737','31516','38366','77173','78862',
                          '17556','37044','63691','38333','99049',
                          '86167','85327','68657','60827','21498',
                          '98898','72753','74924','35510','64733',
                          '37109','63342','11902','32873','41545',
                          '47999','86385','69876','67839','84581',
                          '93383','71018','48576','45311','31770',
                          '76449','90326','94718','23911','77132',
                          '56597','49164','65777','76644','12021',
                          '80828','87123','77908','83099','34694',
                          '68978','16430','84253','83933','21684',
                          '30377','54888','55084','29093','86726',
                          '31096','85584','78512','62486','95753',
                          '88160','74141','29849','63665','59152',
                          '80871','56990','60039','41670','26730',
                          '71915','98171','62209','84140','96241',
                          '72064','17460','60044','89087','73124',
                          '50845','61585','83295','85792')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


