
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '29283','90618','80782','28506','47094','92181',
                          '20791','12310','17031','31293','30031',
                          '83212','27969','18457','30139','31185',
                          '28966','97440','52269','52840','96576',
                          '49846','30144','44239','51693','10389',
                          '92586','62338','73223','30058','74731',
                          '94355','68835','64903','79403','44884',
                          '85726','20550','43786','91273','76665',
                          '31115','31352','60386','45996','96051',
                          '86696','41765','35068','76955','70558',
                          '88899','26446','37733','52658','60729',
                          '87262','17931','39191','99613','91555',
                          '89494','95273','44806','76211','80810',
                          '41605','47991','24048','73226','24512',
                          '85691','82006','89693','79808','12240',
                          '27461','84981','38234','15798','31508',
                          '61937','56702','85527','88819','74708',
                          '82842','85391','15789','79909','63684',
                          '95823','92031','66570','18270','49781',
                          '17393','40851','34001','20015','97453',
                          '41759','45450','76485','67384','26127',
                          '38069','32604','95715','60613','18332',
                          '22992','31898','14668','29986','61895',
                          '13604','46023','14285','20864','89900',
                          '89405','45227','91771','91235','96632',
                          '30399','89773','75970','82290','31043',
                          '77982','81471','76070','50497','41571',
                          '82723','60798','61244','86386','44280',
                          '40431','13343','96907','13834','42596',
                          '10669','66005','78558','52086','99228',
                          '98552','58208','22504','58623','41140',
                          '62152','82915','71252','14005','78872',
                          '82461','87440','52233','98260','24755',
                          '29340','47345','56352','34074','90571',
                          '44160','15250','60698','34591','23145',
                          '89243','78443','99982','69980','47518',
                          '16691','57622','29782','96160','87448',
                          '30352','15187','32752','28996','11218',
                          '88203','22133','42239','73311','73418',
                          '43523','43555','95793','26682','87762',
                          '31658','70248','41621','83680','92745',
                          '45877','93511','89844','55157','77845',
                          '83821','34701','32681','61347','79737',
                          '38553','57794','73530','43028','50943',
                          '25916','28493','54101','52799','62941',
                          '57052','98970','64254','73972','87862',
                          '41560','15663','88171','94967','21040',
                          '84141','77276','86987','69175','52432',
                          '89034','88452','43726','80933','73881',
                          '18678','49160','52383','92405','55265',
                          '98584','69300','44409','60400','56664',
                          '74132','43572','27689','95064','34505',
                          '68569','95287','76636','60914','13223',
                          '78839','81262','75548','53482','11495',
                          '76025','96280','41161','28374','62835',
                          '74356','25046','72146','12526','67387',
                          '48276','55179','90732','22016','12437',
                          '22656','22795','14854','30812','59419',
                          '17153','54202','61552','53821','70397',
                          '98711','29863','38436','17344','32220',
                          '48984','16663','88761','49389','56277',
                          '16850','64337','95770','33599','39830',
                          '96671','36907','24517','30320','81549',
                          '59541','48748','61498','41389','23306',
                          '84323','11540','54606','48529','56450',
                          '74268','45986','27197','67151','38830',
                          '76261','42293','14049','19410','36405',
                          '75028','86155','67742','92952','73887',
                          '60952','44910','41828','60280','24015',
                          '14381','69643','12280','84510','61622',
                          '88506','50849','53963','69511','93720',
                          '14660','59536','13580','23811','19026',
                          '22854','15638','60577','20100','30477',
                          '50653','51292','12920','81125','53092',
                          '91340','98947','66288','27180','51522',
                          '30490','33171','28945','52779','79366',
                          '93376','67789','54459','23639','90918',
                          '35696','94759','40609','41617','45042',
                          '17638','71081','51532','96127','19361',
                          '25068','28674','60019','27755')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


