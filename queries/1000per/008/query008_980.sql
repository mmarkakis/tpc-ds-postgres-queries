
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '26302','79018','69974','55505','83892','11021',
                          '52358','27683','21074','98689','65528',
                          '96175','31131','51603','74090','89005',
                          '75114','43792','24466','67360','91948',
                          '59886','11939','38546','12538','33063',
                          '40484','80510','34141','77607','98580',
                          '79644','32239','20655','24737','12057',
                          '45581','88463','39987','10820','41374',
                          '12722','80719','35979','55343','96998',
                          '46465','46928','17257','82577','97808',
                          '59426','84263','96605','61156','23777',
                          '80196','88827','65233','19312','30956',
                          '94649','99557','32289','47454','10764',
                          '29902','13895','56252','22078','58458',
                          '49691','36609','83398','66681','69776',
                          '48442','18188','90079','66527','82108',
                          '71608','43564','20461','13111','16281',
                          '52329','17724','79323','60295','54363',
                          '19963','53097','13164','21455','28936',
                          '92542','68947','94643','60393','56954',
                          '33330','87269','48053','39364','68230',
                          '67856','36785','68581','71120','43524',
                          '28467','45627','65639','73656','66209',
                          '32099','70958','72593','34240','30711',
                          '87137','37542','77474','12839','10706',
                          '84376','45569','49388','50542','86013',
                          '33749','86245','35639','47448','15957',
                          '22348','35756','47316','33729','67052',
                          '98094','50842','40957','60009','28859',
                          '54492','45376','83223','78482','53241',
                          '24736','92487','77702','96964','67924',
                          '26215','49374','30663','43220','33033',
                          '18241','97196','95548','31563','27804',
                          '87331','73196','33550','90894','75287',
                          '58947','22531','36265','34272','25357',
                          '88357','90901','77824','14671','10840',
                          '78310','33228','34831','40513','24691',
                          '33449','75556','12228','51799','27733',
                          '70963','61400','71548','45059','32928',
                          '88344','95094','12024','11835','23720',
                          '99006','26107','93592','74284','75394',
                          '66731','41601','42097','69095','32124',
                          '47329','52469','46058','20353','37903',
                          '77751','32984','43906','68418','34998',
                          '83580','31840','72399','10665','53689',
                          '30762','74149','95046','83654','39292',
                          '62947','64222','14877','51109','78974',
                          '18053','20903','73103','57300','22201',
                          '41820','20882','50879','23740','80354',
                          '21558','92721','69058','82963','97989',
                          '12543','40522','86556','55196','55699',
                          '81535','56319','28414','80111','85449',
                          '30407','98483','97371','42398','55230',
                          '32260','68872','61027','61197','20005',
                          '72268','67228','93837','59724','50437',
                          '80586','94284','72740','31550','49435',
                          '89802','43088','82053','86452','74211',
                          '64136','66432','67115','72020','40511',
                          '25822','76771','44029','42770','87164',
                          '55164','97349','74588','28954','63884',
                          '86275','51877','84442','46172','95898',
                          '49655','52391','38500','70424','92905',
                          '32277','18138','38225','18217','45957',
                          '61524','89920','19076','86679','67852',
                          '60459','49440','30019','29189','78568',
                          '84748','53145','32810','55010','14409',
                          '77331','88656','73872','11592','86743',
                          '23830','42858','93097','46096','99952',
                          '72932','59482','38945','33392','28872',
                          '93036','75758','87712','64831','91587',
                          '57961','79650','13807','86851','67994',
                          '48129','48531','26162','13566','43084',
                          '24611','28063','33841','80645','36836',
                          '93108','14457','98156','48082','71528',
                          '99857','66835','74565','50983','70541',
                          '80607','30045','95426','40041','75574',
                          '90889','44154','92388','75474','14350',
                          '46263','25889','39204','55877','84644',
                          '73265','80584','69828','55506','94329',
                          '44312','27577','68839','29795')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


