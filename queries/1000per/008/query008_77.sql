
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '41856','94632','90705','33364','26572','20896',
                          '48258','36796','10308','35463','60919',
                          '99446','16572','39762','46893','20088',
                          '87223','73765','37611','95482','18214',
                          '21325','49563','39318','80728','57381',
                          '97816','51607','53138','75300','60052',
                          '51975','76688','95097','29256','15724',
                          '30303','22405','20998','24639','64510',
                          '59672','50048','74136','62115','23347',
                          '16133','46586','90865','30463','85781',
                          '20209','26028','60858','64369','82476',
                          '41954','27717','52718','84488','84461',
                          '21756','60053','71438','30587','63656',
                          '17143','73195','68660','98752','20144',
                          '10867','17350','72440','42129','60612',
                          '14608','63468','13795','57658','95516',
                          '46741','76160','16482','80936','79868',
                          '98239','36598','35912','24002','33590',
                          '40866','56786','17074','89747','20218',
                          '53107','17488','35677','92330','80431',
                          '59118','95037','13282','29017','62288',
                          '30834','40304','46499','36186','13005',
                          '41673','71434','72339','33032','24980',
                          '45030','36183','68228','43990','50870',
                          '37449','25110','45965','48349','75411',
                          '97638','40438','30389','59209','59791',
                          '34444','57845','87242','29176','10400',
                          '28357','86163','21439','40669','91184',
                          '64070','62940','62775','42291','47282',
                          '52001','23955','51543','55896','28719',
                          '47150','44810','11731','16977','35984',
                          '22992','99797','84475','49059','41947',
                          '54654','47234','33175','73770','40228',
                          '68405','96902','78727','49733','11288',
                          '75820','69033','12426','15090','88846',
                          '72401','12227','54301','70630','10487',
                          '84049','11370','13653','57189','95179',
                          '83738','40654','16228','53954','80965',
                          '14933','93402','45234','43559','92010',
                          '22327','78394','86240','47582','21416',
                          '52812','23301','65091','99940','40805',
                          '75205','60072','95896','95600','44078',
                          '64851','63131','29552','22246','48348',
                          '50052','86326','17304','30049','92492',
                          '14599','27346','98264','71781','55076',
                          '88022','91551','16671','51514','15584',
                          '70172','28896','43982','84681','78586',
                          '23278','12620','69220','54822','88712',
                          '24308','41678','10554','53536','31399',
                          '57783','79392','39390','87882','38860',
                          '19027','79448','77113','79954','49355',
                          '51179','18246','91954','55574','64827',
                          '76474','84398','17805','13771','99009',
                          '86360','44662','65888','60041','54584',
                          '68796','59614','19893','62047','84097',
                          '23192','85436','50822','63532','35294',
                          '40725','10039','13427','14669','99305',
                          '73834','46425','60596','50751','87936',
                          '33124','30015','65877','73816','82145',
                          '39352','90441','16814','81251','37923',
                          '14461','56844','71699','95528','18837',
                          '76570','67906','27061','87618','65856',
                          '21107','68155','93265','28696','21010',
                          '31018','74045','50059','21301','96915',
                          '97199','34832','12297','56614','30975',
                          '90241','13512','41445','27490','26574',
                          '32171','86771','84019','33996','39183',
                          '98385','13710','54877','94317','80603',
                          '40867','11502','42482','30042','40801',
                          '17786','16819','79565','73783','80807',
                          '27040','65289','28563','38401','38179',
                          '46859','77926','55871','68178','18773',
                          '29181','39306','16773','78534','79696',
                          '87378','27323','52217','29600','59832',
                          '37809','36461','47481','70870','38571',
                          '55307','34157','85768','13629','95777',
                          '40378','84650','47251','42006','47853',
                          '64717','32589','32999','65883','92941',
                          '69265','54931','11295','12769','32077',
                          '75042','45683','96095','35355')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


