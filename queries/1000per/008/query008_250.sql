
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '36865','10154','94387','92183','20199','40948',
                          '27640','12343','55514','38518','97238',
                          '18617','52021','33535','32442','17267',
                          '73800','45430','47585','16516','97125',
                          '56835','12828','98539','15327','31418',
                          '95055','56596','73917','88195','45579',
                          '58232','29464','29787','60726','27012',
                          '40263','80457','61889','49025','87552',
                          '36924','87459','95508','45498','74340',
                          '20115','24366','78857','77637','76171',
                          '81490','44479','66416','55121','66836',
                          '35274','64699','73831','16973','43074',
                          '66847','18436','43344','28556','75873',
                          '83895','46043','61572','46827','94218',
                          '37638','75916','88079','11037','91706',
                          '94685','69009','56773','60662','52569',
                          '66839','72937','65649','32643','23409',
                          '50460','53978','77979','21299','45220',
                          '27239','37408','20379','20599','78428',
                          '73702','20906','75368','52806','76149',
                          '20929','70572','17639','48221','89750',
                          '82208','98734','74896','81359','83403',
                          '82564','47062','51509','92621','31286',
                          '72863','77633','64202','69528','17154',
                          '55127','24324','93265','58814','51675',
                          '83607','62322','34868','55445','38015',
                          '37210','73753','93385','64846','70707',
                          '72065','37441','44826','67727','61060',
                          '18769','66217','32638','20390','63273',
                          '86273','67117','35137','75092','28563',
                          '49575','77960','12424','26795','18879',
                          '44720','80265','85508','53794','93844',
                          '28934','89137','90727','15304','66677',
                          '12333','25863','97091','91733','38930',
                          '49553','17883','73071','18378','97653',
                          '83035','30627','91975','66113','36857',
                          '54954','25618','56740','43878','68034',
                          '87159','77297','69374','31710','80701',
                          '14732','34721','65722','68710','96578',
                          '44734','75629','40150','62540','57497',
                          '35960','20753','74204','77865','93938',
                          '14482','23441','19673','14532','65659',
                          '40277','71628','49760','67791','11472',
                          '13533','30057','78588','56621','69772',
                          '82768','34664','44141','98710','35289',
                          '61952','86608','48515','51190','61786',
                          '25308','81126','23907','87522','82976',
                          '22708','39699','59899','73798','46304',
                          '24230','87757','31311','72362','98337',
                          '49873','16590','51365','68929','68543',
                          '16786','49850','91754','66240','52036',
                          '83264','73888','49886','76098','60746',
                          '11573','54604','57462','29371','61292',
                          '15032','12120','92136','70104','30199',
                          '43862','71310','59276','43293','41110',
                          '46149','78354','29137','28570','71484',
                          '79562','61801','57481','12437','10086',
                          '76015','89988','56975','38029','78526',
                          '33283','68398','75607','50395','76026',
                          '27352','29771','30742','53608','86117',
                          '50889','74550','57862','78024','41627',
                          '30705','16876','38746','60321','89461',
                          '86562','82159','40810','53659','78299',
                          '85813','42826','48142','23782','10637',
                          '87703','33029','26248','30695','85901',
                          '45181','56905','99889','26665','21708',
                          '55442','41556','30239','59957','93850',
                          '34286','65822','44848','30227','92727',
                          '13402','35769','15290','84043','43438',
                          '53804','70829','26627','70054','68410',
                          '89670','63618','47913','69581','95120',
                          '94211','91607','31492','32624','46291',
                          '37365','36397','47932','63581','92809',
                          '26578','99089','55796','54650','66395',
                          '17794','68982','64194','43530','12194',
                          '53443','56642','73936','10122','55664',
                          '93087','12502','84840','40934','10074',
                          '48172','50285','83504','78813','92029',
                          '30012','65782','32364','96653','35347',
                          '24661','68706','74675','56555')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


