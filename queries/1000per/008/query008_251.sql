
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '79922','20855','17845','93173','12189','73854',
                          '95808','83605','58257','12218','63247',
                          '89333','47630','66380','52789','21661',
                          '17036','19286','50267','10401','80476',
                          '95124','72132','85584','14488','35910',
                          '80176','82839','38996','55263','17739',
                          '97271','60056','47875','96666','59622',
                          '33595','29328','72418','34843','18634',
                          '61100','54163','79627','64504','90446',
                          '90371','25711','91185','98333','80107',
                          '80128','88997','95708','73625','98770',
                          '14086','30186','10719','36437','43141',
                          '74477','26727','74514','62554','31895',
                          '66677','91065','25272','70731','33845',
                          '28780','10131','34733','25227','28514',
                          '53367','11669','52772','62518','47411',
                          '74234','73395','39920','22368','91039',
                          '90714','76947','93468','12509','19454',
                          '52591','81822','65540','85349','82715',
                          '86102','40161','27975','97464','54797',
                          '13711','69859','75984','26695','85522',
                          '28821','33330','96472','77017','62656',
                          '32372','19266','44849','25117','12557',
                          '15735','32109','69153','60077','90526',
                          '83012','58120','30581','16518','17956',
                          '65023','83073','73767','37600','59983',
                          '59371','11982','13978','16132','19240',
                          '67447','75610','33638','68932','29605',
                          '39087','16551','30969','28027','33750',
                          '42579','43445','16262','62683','30158',
                          '19382','98058','16504','39840','86870',
                          '52774','55121','64555','75137','44220',
                          '45181','94033','62631','73752','84286',
                          '96701','97401','36961','95450','60603',
                          '78636','41713','39821','46039','60143',
                          '44313','97213','99282','37876','44008',
                          '15012','33772','70891','78122','24409',
                          '82063','48423','84401','88194','32568',
                          '15612','40922','32785','26102','20022',
                          '76761','81912','82128','95677','22065',
                          '60104','87249','78159','58406','36476',
                          '28018','78854','27998','19366','23952',
                          '48784','79759','54477','65219','17420',
                          '84166','97298','92755','66192','36124',
                          '55009','18188','96277','33310','64731',
                          '10627','11683','52634','40420','35681',
                          '31712','15994','61991','71970','58981',
                          '32523','91451','71611','67498','48812',
                          '70884','19854','27655','32380','97012',
                          '69870','43247','86378','75365','41587',
                          '15428','67757','63700','46147','93699',
                          '47377','29010','82261','84884','79090',
                          '46515','81843','50766','36211','60866',
                          '26110','91063','73351','10293','38439',
                          '98106','42684','13110','31114','48576',
                          '86821','39461','27614','58296','90841',
                          '94311','18400','30085','55880','16581',
                          '56529','49971','57719','69626','77167',
                          '15976','26811','57460','16172','28545',
                          '25777','77387','46856','32278','60948',
                          '90557','28995','14197','66191','22805',
                          '45204','12664','83565','39966','59346',
                          '60969','27742','63073','91714','75302',
                          '78763','74004','22256','24616','10715',
                          '16241','69093','86321','50106','14187',
                          '47170','96176','61353','60394','27953',
                          '61384','27496','85532','54342','88744',
                          '98590','66892','12440','55703','63333',
                          '51009','65699','24565','29235','52319',
                          '99623','21068','11530','62453','24032',
                          '43643','33222','22512','26931','55101',
                          '53286','22763','28617','80782','85409',
                          '46469','76653','53601','78599','32241',
                          '38644','35698','13279','74939','74503',
                          '80930','26415','23469','85766','10155',
                          '51995','60166','84001','26463','91028',
                          '27785','48920','64164','92889','42591',
                          '10819','56636','44537','26804','23115',
                          '77357','71812','85531','62658','71222',
                          '76255','58434','29946','60892')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


