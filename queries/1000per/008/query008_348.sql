
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '85905','44143','46648','22816','81678','47911',
                          '36199','38544','92654','70340','51334',
                          '23862','31417','27226','76835','76582',
                          '38299','70563','74134','76837','34435',
                          '11850','21400','61776','49060','12525',
                          '56901','10475','24609','40962','34181',
                          '93387','38392','98551','47711','40415',
                          '39454','64279','35165','95946','20481',
                          '71587','92758','60786','92627','86362',
                          '46924','48428','21918','92703','47278',
                          '77812','75756','57529','78011','82427',
                          '98816','97716','91427','42623','72174',
                          '79514','31164','60348','38504','75203',
                          '19357','46053','91738','58830','86096',
                          '99956','93624','61835','53463','74563',
                          '34120','13685','96240','29340','49047',
                          '79686','73164','87474','95283','51769',
                          '90659','47101','10355','75501','79454',
                          '33152','76771','28352','29499','74502',
                          '44411','45572','92058','41628','14463',
                          '16365','81056','88467','78590','42314',
                          '91167','36086','76298','26368','38882',
                          '75725','38660','94631','99496','77493',
                          '13849','66329','97613','24119','57424',
                          '61204','16764','63827','41452','53142',
                          '72090','79657','84502','82681','34394',
                          '16003','17245','97973','49757','52115',
                          '80768','36948','68657','34717','71731',
                          '27979','65499','27424','15921','10041',
                          '74438','27591','84788','32718','34214',
                          '60692','33612','15724','12191','33035',
                          '54813','41087','74476','41215','81768',
                          '26023','57015','33077','48926','65133',
                          '23267','55871','97334','86588','22946',
                          '99274','88352','54847','83269','33586',
                          '10840','19411','53080','91431','43131',
                          '63816','17350','88505','69380','61583',
                          '10999','21724','79433','52562','10672',
                          '93437','54638','99296','70534','20621',
                          '94180','83748','38621','48000','55841',
                          '13698','70718','74515','78705','58664',
                          '91363','14604','93116','67761','83568',
                          '79866','75930','23543','81730','33060',
                          '28705','22013','22637','71888','14515',
                          '17297','16425','10700','86433','26996',
                          '54264','24277','38727','47936','46279',
                          '18467','57067','64147','77331','34650',
                          '85090','67859','65779','39101','53590',
                          '76396','24025','26680','19305','20846',
                          '46234','30307','74280','76664','59787',
                          '14420','69255','62181','18722','28930',
                          '42555','71926','42101','38855','85195',
                          '84125','53993','98807','51421','42097',
                          '44376','31811','22580','36022','70913',
                          '72886','55628','48712','51052','22756',
                          '57980','26365','71339','13439','87717',
                          '95345','76948','60566','80959','87379',
                          '25390','79646','33177','40453','89055',
                          '69446','30838','29881','80949','64158',
                          '26120','45202','76785','72450','16249',
                          '80050','74095','13275','97429','88604',
                          '63931','84371','65754','55140','14316',
                          '49709','87765','73073','21594','32819',
                          '42870','78543','93940','64445','18624',
                          '31601','15422','37033','30289','49515',
                          '67500','53456','75915','81847','50758',
                          '94863','72562','56972','42452','66686',
                          '40407','18647','40181','71362','18308',
                          '62842','98218','63366','35716','38896',
                          '71709','33418','65643','21043','79773',
                          '89642','38521','99353','69676','94159',
                          '69568','62747','14560','21705','33266',
                          '47194','37411','27693','55317','20056',
                          '52999','20449','91231','80273','30537',
                          '37726','38694','20076','97823','53481',
                          '48214','80843','17146','65861','94162',
                          '33899','48180','44960','78847','33024',
                          '11151','98024','14633','10807','29372',
                          '19084','51994','31398','27307','10511',
                          '40162','25029','71322','27085')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


