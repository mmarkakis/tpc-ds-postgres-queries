
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '47976','14114','72423','77281','73714','59342',
                          '15064','27590','21368','61378','74960',
                          '53656','58812','10972','21886','68117',
                          '70712','84787','86021','59898','26585',
                          '61690','74070','58257','96521','28656',
                          '45937','12403','85659','46404','44891',
                          '49116','46282','47473','32953','35626',
                          '48859','61687','35408','89966','91716',
                          '40444','79616','22403','83359','52682',
                          '87309','11851','25308','47878','64864',
                          '16308','95581','23692','94830','14216',
                          '37798','87194','36830','45836','11872',
                          '35714','57595','78007','53554','34535',
                          '91056','53305','24249','95290','90057',
                          '33653','83118','62135','96955','61014',
                          '17994','76699','71561','60612','79825',
                          '69944','71216','95036','46060','36453',
                          '43764','10696','92653','27950','21982',
                          '18951','44438','78093','27778','47869',
                          '84653','60002','22385','60234','24171',
                          '44049','68595','98582','71317','31011',
                          '25815','96475','16581','67051','71428',
                          '81428','52921','87418','85822','90218',
                          '84424','53508','53034','33206','43568',
                          '42311','20764','42954','87093','28571',
                          '34995','60304','29557','27930','97827',
                          '94432','45926','54680','55269','97539',
                          '93210','67988','97420','80346','97149',
                          '96510','27170','58990','49753','58128',
                          '98470','11982','78659','90497','99986',
                          '24437','55654','93640','80459','29371',
                          '92486','15807','32256','13234','31806',
                          '38734','77107','59029','57817','94103',
                          '66460','99528','37867','27070','72449',
                          '19885','21988','73585','52744','22406',
                          '51321','93176','64491','81216','59102',
                          '74270','84680','45675','44321','13922',
                          '22935','18007','22545','60388','24576',
                          '10635','73697','66003','22240','53940',
                          '99056','54408','36604','75289','23229',
                          '88625','44281','95646','22016','49304',
                          '81688','98632','72926','57730','91837',
                          '25628','92682','52590','89913','92852',
                          '67882','30254','97301','27221','37651',
                          '55753','48755','76853','90686','21532',
                          '55504','71425','86795','23723','51285',
                          '43499','50878','93147','11645','55640',
                          '44719','48949','88418','67281','90199',
                          '29545','61516','66156','54249','34625',
                          '42643','92111','90622','12483','21828',
                          '44983','28173','34201','70121','42084',
                          '66134','93942','36837','52158','16584',
                          '53423','14957','13573','93530','56413',
                          '54593','40420','11079','12333','92453',
                          '35871','93535','21262','78336','84720',
                          '12729','49234','35080','71927','68714',
                          '66865','98724','13371','64157','20541',
                          '35788','76398','61921','10590','76385',
                          '75009','14143','89923','58699','95834',
                          '80799','10556','55153','99362','75916',
                          '29131','32465','85168','84555','33625',
                          '64590','41184','40172','80696','38993',
                          '31278','88898','79816','18484','26406',
                          '79758','87736','51072','43698','30985',
                          '73973','36462','90003','95681','92687',
                          '96815','25688','48623','34641','59600',
                          '57370','76307','91544','16060','10493',
                          '81453','45080','44693','13065','37429',
                          '29719','94601','11153','71165','51771',
                          '19879','15828','73286','55203','34325',
                          '48011','89097','31861','89954','65595',
                          '86293','36057','41716','94943','60930',
                          '42703','94307','22368','40225','34368',
                          '21389','26139','81313','45334','77580',
                          '86448','77557','22647','42563','96150',
                          '85125','53828','99076','91466','14123',
                          '68992','26392','83123','28244','95998',
                          '60453','79761','86049','99848','47918',
                          '73556','56377','12940','64903','56969',
                          '34895','16643','69103','58698')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


