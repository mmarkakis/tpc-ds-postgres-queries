
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '53225','27291','22197','81839','67461','53925',
                          '64950','92917','48385','11830','17471',
                          '51120','40589','22027','78733','41513',
                          '48786','19448','43903','42279','51110',
                          '43083','30276','53906','93337','64620',
                          '83224','46017','22106','90666','84340',
                          '62394','67996','32639','31446','82215',
                          '10790','64238','22690','52745','91942',
                          '72274','23008','98053','10344','60453',
                          '61413','29667','62744','89033','89684',
                          '44983','70617','52246','88382','95150',
                          '67357','32149','98887','93391','27032',
                          '61988','85468','74226','25020','69163',
                          '39231','24299','88551','71458','63812',
                          '76147','89921','68222','33160','26438',
                          '34013','64237','20844','47044','22443',
                          '62518','85576','47284','32762','13195',
                          '62683','99822','17618','99847','99606',
                          '15368','74332','32258','90951','99476',
                          '17463','70812','96355','20795','75998',
                          '38415','32676','39584','78266','52138',
                          '89969','40647','61685','11928','57503',
                          '33539','90933','83134','18652','73921',
                          '93831','79830','86072','80112','15314',
                          '84380','70761','62632','81297','52754',
                          '37376','50378','66537','31776','63098',
                          '75785','58138','63678','49401','56036',
                          '15001','38220','11953','20282','24074',
                          '86743','79375','77155','32021','95839',
                          '47527','94668','34025','53193','73599',
                          '82547','24590','45611','94335','54987',
                          '86209','38666','40557','11046','86051',
                          '45067','72346','47530','84580','51670',
                          '84452','85470','39263','46602','42066',
                          '26790','15814','33140','53903','76950',
                          '26024','64895','76321','21956','25267',
                          '90964','30955','55460','22076','86649',
                          '60081','29237','62192','83323','36862',
                          '10211','17186','57975','95648','43601',
                          '74276','61643','78188','65167','96177',
                          '44331','10807','93048','88892','61190',
                          '29587','98398','91049','82837','42204',
                          '50620','77249','79913','86216','96655',
                          '46586','68380','78996','56753','84192',
                          '92736','46152','67224','49945','39348',
                          '74595','63117','31866','86256','69245',
                          '38114','45657','75847','20299','75741',
                          '46004','94431','49072','41691','52978',
                          '83860','40503','39138','14928','21579',
                          '65648','74915','90637','15580','43205',
                          '83995','26602','37723','97884','61975',
                          '66137','43649','83405','77846','70581',
                          '24634','89579','33969','94305','44098',
                          '69822','48973','98509','84450','81053',
                          '72569','84529','10223','78064','53407',
                          '21788','37357','80872','22337','33234',
                          '71132','39504','85385','71231','97715',
                          '85089','97611','19412','67598','39191',
                          '47358','33490','36987','95726','53288',
                          '44099','28444','39836','23673','73973',
                          '40351','88666','61887','12192','47418',
                          '56674','13718','48836','67592','42322',
                          '35355','93627','17626','10120','80204',
                          '62432','36704','58710','98062','60153',
                          '61073','53677','70927','55048','21936',
                          '66678','18040','74695','33594','90498',
                          '45412','72141','68068','95799','45283',
                          '19250','65398','66273','10391','12462',
                          '29622','41455','28370','22576','70553',
                          '74973','38024','16123','99645','52157',
                          '71054','48312','53510','28800','87066',
                          '92671','45228','74026','78809','17065',
                          '72578','34372','40462','54227','83355',
                          '52200','83425','36054','29265','90341',
                          '18967','24099','92907','91292','35596',
                          '98482','99533','36392','71357','18527',
                          '69791','22720','79392','62059','26943',
                          '70933','22484','22226','77134','17249',
                          '20515','10131','77396','89842','46138',
                          '68764','16834','13770','61261')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


