
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '30474','92572','37611','13495','88706','41462',
                          '74490','27039','67791','24346','93254',
                          '59268','70920','55625','93339','19306',
                          '45216','82775','93111','91382','43647',
                          '21926','45391','21902','68391','38515',
                          '20761','30182','42626','94537','35598',
                          '54489','46897','81592','40179','89126',
                          '58173','65312','28190','45914','55769',
                          '50726','53260','81570','64959','94121',
                          '94313','11775','79287','49875','71393',
                          '69484','52745','23161','75177','10559',
                          '64445','92426','53619','63477','48647',
                          '54078','36636','25255','49395','71337',
                          '14793','64740','48404','60038','80968',
                          '49961','40068','41649','52323','37641',
                          '17033','64991','87361','69873','52999',
                          '67821','88837','63462','62052','76654',
                          '88276','53682','77611','24732','10203',
                          '57968','80133','32623','43459','45450',
                          '92325','59156','38702','64776','41140',
                          '14578','44352','52139','10593','81352',
                          '70637','47166','10536','98995','52165',
                          '78245','17041','37297','95273','56598',
                          '54421','52011','82225','17272','35621',
                          '75438','76173','27488','24126','90881',
                          '25749','48503','46656','88126','81241',
                          '47147','11003','57027','11959','63581',
                          '73517','90651','76768','62921','93329',
                          '62418','24852','98390','27427','28482',
                          '35015','19094','91988','55651','76957',
                          '71289','43913','53007','14890','21517',
                          '19662','54549','15278','47615','99127',
                          '13702','24685','90696','78139','19527',
                          '60663','82008','92229','32875','38199',
                          '40414','30276','63346','73374','76041',
                          '85111','32397','60566','93652','83986',
                          '26869','52299','10773','40896','67680',
                          '26685','18802','76148','55350','56930',
                          '47224','27425','27246','18764','68646',
                          '39738','96994','66090','76046','87133',
                          '56552','44049','30897','96023','62403',
                          '85771','38526','43654','50942','58291',
                          '91486','43020','89909','99918','84386',
                          '48430','20889','99321','55150','41190',
                          '92045','50131','49921','38271','89685',
                          '39532','57237','93023','82121','23175',
                          '80605','67813','88393','45589','62226',
                          '85135','62134','83428','90238','58130',
                          '35294','15198','91231','64813','34377',
                          '61352','82178','81872','69231','35811',
                          '43759','92266','81252','52954','76058',
                          '47289','87811','25725','84598','21577',
                          '42487','79226','14071','21071','98199',
                          '25285','36322','75578','60312','99187',
                          '36038','50356','16189','20275','24141',
                          '79616','88535','59787','70691','78466',
                          '19073','99227','55870','12380','59229',
                          '69450','69859','41573','22617','43462',
                          '33011','84798','14878','87326','49000',
                          '69903','53416','71818','38543','76933',
                          '90325','37907','29193','56709','17942',
                          '61769','75611','30890','30521','36250',
                          '67640','60508','43637','17185','72877',
                          '30803','20394','80777','62317','93333',
                          '99855','97100','69573','56290','84792',
                          '65710','39246','75889','34257','58626',
                          '84609','58041','17508','28083','55745',
                          '59912','49051','59789','61133','87864',
                          '75478','19456','31937','32836','60259',
                          '96261','62625','12287','88813','73049',
                          '62761','72100','26596','77292','70696',
                          '33126','38838','12424','67150','69578',
                          '30025','98717','95304','40862','62896',
                          '59402','65088','15086','66867','30958',
                          '26821','50648','28391','60632','49696',
                          '21140','82216','56310','93725','89463',
                          '30161','59898','77603','61497','26790',
                          '14077','27245','41659','38494','29385',
                          '82744','70496','15373','29738','42004',
                          '71322','84136','15500','22561')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


