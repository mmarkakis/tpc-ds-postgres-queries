
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '85278','62275','88034','42150','89427','88037',
                          '76364','46242','53718','66465','86595',
                          '61565','69647','49881','58688','90893',
                          '31400','72716','75992','47432','53366',
                          '39881','92098','82299','56685','88997',
                          '65893','42872','36963','33937','90491',
                          '29273','44745','14867','38823','36675',
                          '29751','43296','57729','60013','31604',
                          '64759','22870','61088','88160','30034',
                          '15596','14138','68611','31778','14725',
                          '37910','40512','94074','41030','39612',
                          '66892','65038','99362','65959','66918',
                          '78719','85264','42473','69082','11132',
                          '75973','21188','16230','31744','23247',
                          '70479','42746','85043','18453','15367',
                          '34433','43328','23369','31835','45217',
                          '45189','17462','74262','36011','97922',
                          '30505','18255','86768','27689','41048',
                          '39453','62625','79253','23067','78990',
                          '65329','69882','85029','66151','34523',
                          '39579','46873','79937','59267','31324',
                          '51644','57107','45027','16643','61331',
                          '84833','27127','21230','45788','66084',
                          '99799','77723','74774','63652','56011',
                          '59478','34338','51906','19904','43548',
                          '27509','20803','78993','45537','95595',
                          '94045','25195','13440','14453','68657',
                          '20367','66573','76358','56276','59814',
                          '73835','16314','81003','61733','75026',
                          '91446','99561','34457','44322','26219',
                          '61317','47872','75323','92226','64232',
                          '31167','34118','16209','30435','31091',
                          '48991','58010','54407','25512','66799',
                          '95375','29223','66394','37536','68047',
                          '95268','23591','11278','51656','76076',
                          '46061','73733','85258','12672','63023',
                          '44593','91140','92353','15404','54102',
                          '11718','33841','48430','25321','40972',
                          '30340','86615','68700','43114','97979',
                          '24141','49765','80239','41709','63411',
                          '51785','69751','45583','23479','72199',
                          '70720','43740','24535','39770','98063',
                          '57718','56710','89396','50877','86265',
                          '97401','86322','88925','14372','79809',
                          '75586','70645','40990','13272','91467',
                          '33371','97180','85120','50156','45215',
                          '36916','93545','78549','35966','68029',
                          '54617','98419','31784','19158','50846',
                          '43186','99450','10564','83537','26966',
                          '93682','39492','87757','47396','35610',
                          '59356','63079','27056','26009','23115',
                          '79600','33322','20495','34807','12882',
                          '46574','57045','97713','79086','85287',
                          '93163','85997','73762','16333','39658',
                          '52864','83854','24329','59672','30097',
                          '15478','90030','95011','12751','55877',
                          '41277','68599','60365','58899','36902',
                          '23820','38964','79933','85945','94341',
                          '27681','28467','40397','48477','16882',
                          '44407','46323','86147','89369','14755',
                          '93797','44451','31216','19761','76268',
                          '96884','84562','87763','81233','40568',
                          '26555','27686','31287','24668','41865',
                          '77669','29637','66774','66674','56267',
                          '15396','70817','57230','13437','71923',
                          '82089','71565','17502','85489','96501',
                          '34027','90240','71596','65559','66749',
                          '31164','14841','26018','14315','37259',
                          '71408','21938','51668','53195','98321',
                          '21993','32578','67868','50614','95396',
                          '62670','95616','68681','82223','40515',
                          '69767','82950','40209','97502','14628',
                          '69235','25755','72321','18425','56219',
                          '42676','80866','75119','89206','96729',
                          '39257','51620','61840','31681','72874',
                          '48797','82761','50454','15302','75479',
                          '87577','41939','41654','57793','11385',
                          '34353','90275','71606','36530','29914',
                          '34812','38315','70261','77240','15797',
                          '45529','18845','10919','13436')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


