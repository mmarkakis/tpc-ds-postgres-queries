
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '15202','32274','22844','82637','28137','89458',
                          '19524','89658','28938','55272','60756',
                          '22635','68036','41518','76132','97924',
                          '11791','59856','58519','87330','53123',
                          '26587','35053','94942','95403','53397',
                          '88198','63389','43046','71232','20923',
                          '68961','43970','63840','46905','16441',
                          '87775','36964','59984','55761','84857',
                          '69589','12030','21996','68107','94989',
                          '30408','21984','68935','59673','40017',
                          '36691','46758','79679','79132','53028',
                          '87299','56122','94285','53110','15191',
                          '76299','72182','11716','10351','68186',
                          '27966','86838','26656','42223','54726',
                          '54078','17577','31501','18815','65360',
                          '62275','35738','82552','43553','60035',
                          '85697','59572','91314','18367','31068',
                          '30177','59662','51154','40392','75766',
                          '15763','43052','11140','73108','40223',
                          '45649','84592','64727','87926','63148',
                          '26249','86338','88677','32832','39576',
                          '18943','89173','17235','99857','15496',
                          '45352','37169','96624','96792','32103',
                          '57145','79270','94469','76498','88368',
                          '29163','99794','35733','55192','10890',
                          '44112','97385','93529','12780','87869',
                          '75731','90904','75132','29295','88348',
                          '90173','22183','17941','82686','32610',
                          '62383','42451','19821','41439','85068',
                          '74586','96050','96504','84784','69033',
                          '74627','89523','21101','10431','49649',
                          '49928','11055','26955','20397','12552',
                          '41868','25793','62650','55538','87616',
                          '15841','83999','76515','75587','96448',
                          '59087','65378','46415','38047','77133',
                          '65919','10257','66170','79621','28842',
                          '38969','80937','22524','45182','55680',
                          '45265','13281','92043','95702','76201',
                          '36381','10267','14708','67345','20445',
                          '96014','31051','16661','47369','74493',
                          '13554','44916','79150','81026','94559',
                          '75180','51056','90240','96496','97970',
                          '64165','66333','52228','55179','55544',
                          '23727','42374','58135','79887','84858',
                          '29392','58117','31232','13385','23749',
                          '10675','57140','15427','67480','95810',
                          '53041','67592','73495','40987','39412',
                          '13992','96020','44941','72770','25916',
                          '47042','34730','89181','91168','69599',
                          '44274','42885','12131','73539','12916',
                          '53252','98455','77779','45359','60815',
                          '35967','16437','11731','24606','32986',
                          '55805','27927','40301','45166','25546',
                          '47891','72538','11047','31839','65467',
                          '19105','77993','25061','12964','10891',
                          '91426','88190','75631','75472','76591',
                          '83951','37401','71988','67384','11764',
                          '89849','82624','89163','73740','30329',
                          '55579','48312','85487','24794','75075',
                          '69982','84739','75937','16321','23567',
                          '84470','43779','85831','31207','95630',
                          '62920','11091','39494','24017','18921',
                          '48519','27747','43651','60221','95520',
                          '38819','27673','19871','48442','67284',
                          '82240','69828','30795','30021','88145',
                          '51932','90473','62422','42739','85163',
                          '93555','41152','69743','94914','58033',
                          '70335','85033','84109','96287','35756',
                          '87815','22643','35949','54227','63868',
                          '24551','39040','43091','17342','54281',
                          '46482','69454','47825','13408','75911',
                          '35651','58386','19162','98872','67978',
                          '90434','85106','19013','67554','36565',
                          '30926','90548','18914','10596','59753',
                          '45901','44282','80530','90680','27817',
                          '81216','83093','91479','47910','37925',
                          '64952','18081','60494','51923','79178',
                          '28250','27541','40052','77607','84330',
                          '31693','34495','52468','38484','91376',
                          '31627','50263','60146','31478')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


