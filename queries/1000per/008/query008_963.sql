
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '80328','78391','36832','85001','81214','13901',
                          '56939','75102','50347','33399','18504',
                          '68062','73612','69698','64013','58564',
                          '61303','21257','54716','92963','84056',
                          '60540','13911','80449','51860','70096',
                          '34128','82334','86199','76337','76803',
                          '51880','57492','62767','15896','97694',
                          '97096','41017','83125','45953','18624',
                          '79800','36695','69415','17805','81735',
                          '70688','62687','23202','48838','18965',
                          '43926','59509','71208','78342','62811',
                          '41393','53319','74890','34740','36893',
                          '24472','20813','16703','85553','40910',
                          '42390','80562','34247','65978','30299',
                          '14110','92382','30251','56434','75228',
                          '11501','83217','11631','35160','48242',
                          '56596','23988','82316','51542','41887',
                          '33859','19097','57606','67220','84533',
                          '10261','94684','23413','78610','49147',
                          '18785','40723','84368','98229','87736',
                          '94497','92879','35281','49961','93034',
                          '14557','61443','87435','79483','45055',
                          '52317','95129','72595','41733','86447',
                          '58754','52651','64813','41771','85958',
                          '46145','75415','49692','91952','47982',
                          '20468','14276','44350','44806','77566',
                          '44885','96034','66788','17345','75776',
                          '28992','31026','25892','42527','56044',
                          '55177','17832','86823','64095','87508',
                          '18672','19587','23869','53337','81488',
                          '15268','11122','36896','72337','66302',
                          '40872','66805','57580','41007','86239',
                          '30615','43738','72573','76210','88709',
                          '50411','40695','36779','79441','15267',
                          '67886','71075','50801','62657','80549',
                          '28600','47059','70543','19759','73946',
                          '86725','18007','22583','28641','99054',
                          '61931','66322','78485','76172','29670',
                          '91367','19141','36826','23321','52798',
                          '52734','73517','44443','47788','52941',
                          '42562','41668','38459','47191','67542',
                          '56267','24197','26268','26802','54462',
                          '87280','97719','54928','48463','58854',
                          '22527','13459','43972','57317','58632',
                          '17715','55503','61187','28354','96122',
                          '56709','95454','13821','77952','63438',
                          '24170','30687','95045','41233','45909',
                          '87111','84735','71950','25819','48555',
                          '71461','81617','30434','69988','54258',
                          '83297','66889','65209','82981','22452',
                          '30087','25986','68031','30311','59739',
                          '68288','11199','92711','54915','81734',
                          '65573','11781','68582','82759','53042',
                          '91468','20172','78600','68262','24540',
                          '75694','56341','55685','11711','83027',
                          '54485','72400','24343','23390','83405',
                          '54484','78412','36373','58767','43813',
                          '91526','43032','99317','67442','94695',
                          '28514','54025','85971','26843','32224',
                          '49233','71628','40371','66482','34695',
                          '33155','37095','29219','31593','13461',
                          '30492','46856','65191','58923','96559',
                          '81468','54379','57457','33220','37115',
                          '10503','88398','63911','21168','77681',
                          '65271','74283','16695','71130','30593',
                          '86141','96314','27579','75807','53836',
                          '44620','10441','83723','59288','21123',
                          '88494','26993','20342','65498','78197',
                          '21158','17300','15606','19076','66319',
                          '27658','67710','87001','19674','25704',
                          '35549','24768','76753','20189','88383',
                          '24604','85942','62594','67665','60294',
                          '94135','88782','89497','98829','52214',
                          '44394','57156','20207','67937','16131',
                          '61191','99438','12345','27411','13127',
                          '48522','97945','56002','20555','29747',
                          '85624','65204','62894','86451','88397',
                          '33641','88521','43610','73665','45346',
                          '73708','51573','69965','57952','23905',
                          '27327','92916','76651','84476')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


