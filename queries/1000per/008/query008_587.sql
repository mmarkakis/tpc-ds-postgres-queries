
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '82129','41296','83604','69524','93461','21005',
                          '88410','17847','88196','24094','55960',
                          '73140','72924','81888','22838','46372',
                          '52685','28119','10288','27404','58663',
                          '68724','13835','36980','17332','83709',
                          '74340','27701','15815','41688','45270',
                          '60725','10200','64925','55200','31208',
                          '72207','87575','71037','39313','26877',
                          '13549','95931','15693','21324','80025',
                          '51602','64779','99614','92513','80449',
                          '16176','94543','67240','86282','96030',
                          '12331','41324','95175','26194','29601',
                          '11808','57081','64077','68111','94810',
                          '33236','49804','98748','32404','82048',
                          '66531','53037','20053','20572','68775',
                          '18327','34477','62187','46444','63710',
                          '13399','99137','80484','69338','60546',
                          '90743','45189','18109','60369','13252',
                          '95737','90913','51506','62528','70785',
                          '26964','80915','62892','16498','97000',
                          '80773','17738','10714','71269','36472',
                          '18988','10179','84402','34543','40307',
                          '94822','20673','30129','53357','71506',
                          '35836','93976','45456','65443','21364',
                          '46189','58961','99268','14130','80867',
                          '44908','14810','74487','54828','79722',
                          '25183','86531','66782','80040','23128',
                          '11029','67198','31222','28625','31604',
                          '93596','27924','59094','25636','40441',
                          '69132','18411','25647','81629','89661',
                          '86809','11267','26957','99939','84658',
                          '17705','54450','84252','33156','92045',
                          '79130','79142','57088','15146','39420',
                          '24518','37896','43416','30156','12010',
                          '95137','64335','96482','20841','64278',
                          '83184','10586','58992','96279','94869',
                          '17943','25092','43965','30115','17993',
                          '72894','77701','46003','67111','96162',
                          '17464','41292','59168','78995','78256',
                          '14385','83505','64068','64448','50234',
                          '42033','80939','99911','40214','91716',
                          '74715','30264','36451','55798','72260',
                          '39798','11488','52127','64111','19264',
                          '47711','79483','23415','60701','88799',
                          '21412','50337','75584','40643','63909',
                          '99171','53126','51419','46622','50232',
                          '90190','29751','27570','99138','53987',
                          '90493','70163','84308','10423','68200',
                          '42047','23240','99071','64315','24074',
                          '14976','26365','49626','31504','16829',
                          '11777','94393','50268','60856','66421',
                          '54850','73798','53974','46456','11471',
                          '55600','50655','78091','33540','27752',
                          '17486','45997','35423','87232','70134',
                          '91091','91441','49666','85866','70582',
                          '28749','11807','48474','17576','75360',
                          '26628','83468','67675','36265','29233',
                          '69757','89088','46120','74165','77135',
                          '39155','89442','68764','42826','74900',
                          '63269','94031','21177','31284','55755',
                          '84457','37185','46262','23296','28454',
                          '18768','31391','87317','89721','13999',
                          '18454','97134','53477','14561','66096',
                          '46934','50346','44148','75399','45309',
                          '21563','77739','47872','69169','24907',
                          '53398','58203','15516','36381','46607',
                          '86154','55921','29378','58746','12269',
                          '26166','52469','63078','80467','51466',
                          '10625','48112','98497','37337','28881',
                          '77385','32694','28677','66425','65670',
                          '69240','55619','88290','71577','44799',
                          '73388','21944','55969','28055','85260',
                          '40431','61617','63117','35716','59499',
                          '57293','41974','84839','72702','27623',
                          '96174','37762','84881','42188','69971',
                          '26268','38653','36929','30960','36503',
                          '91341','43695','52969','59484','81685',
                          '97584','45158','11815','19442','17999',
                          '74716','59672','71760','84250','84787',
                          '40006','16021','12310','31151')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


