
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '42765','25721','82404','25380','10898','60766',
                          '42936','20273','97223','74187','18207',
                          '53538','54597','38967','78149','26801',
                          '30311','84597','28467','49946','67274',
                          '79242','48680','62719','62004','59645',
                          '16887','62000','97104','28448','20682',
                          '26691','27342','54161','93379','67905',
                          '92994','54199','89615','59469','63577',
                          '76976','37143','63680','28422','77442',
                          '81551','76297','21168','14394','57726',
                          '10560','89743','22568','79017','44350',
                          '47187','22785','85266','63570','58759',
                          '27613','83126','52036','36225','14070',
                          '82494','43311','71437','76210','30821',
                          '29337','61507','12719','30192','19067',
                          '51370','36550','59142','75136','94184',
                          '83664','45817','36385','84187','25152',
                          '80826','19010','69259','66983','57290',
                          '90489','99424','94099','86973','41788',
                          '67057','58588','75074','76337','49730',
                          '32841','33074','75188','16270','97239',
                          '15685','77866','88374','58139','59631',
                          '32102','71638','92527','98535','68288',
                          '11418','51216','99636','22260','16852',
                          '61355','50338','89729','43693','36664',
                          '64379','84976','16786','60872','52066',
                          '94643','12779','66525','35288','19702',
                          '76222','31999','97082','35802','39331',
                          '83815','27210','55751','80666','93886',
                          '64634','17640','28784','12264','40695',
                          '48320','98231','69061','70002','94512',
                          '58371','13953','28956','41767','60454',
                          '14513','39778','54239','85595','92953',
                          '70375','31518','24802','24176','51263',
                          '61358','26905','51854','80394','96037',
                          '97020','38092','10807','61948','79928',
                          '13789','36423','21646','66220','66323',
                          '38554','94954','48207','84100','11611',
                          '34855','15473','69549','29170','29531',
                          '16393','85632','67153','81610','96477',
                          '70683','99551','98075','97083','81003',
                          '36483','17744','32785','25312','65611',
                          '62708','46261','56475','22907','50730',
                          '25854','83023','69112','14452','76126',
                          '50244','41469','22001','48176','49247',
                          '92904','60771','17484','80329','30804',
                          '41141','61603','17244','13896','89580',
                          '70186','57798','93731','20071','30322',
                          '20868','76849','57476','62326','66627',
                          '65106','94977','91321','66404','30652',
                          '56260','26802','85919','75391','74029',
                          '32079','64412','59838','25973','42954',
                          '28594','92418','83621','91019','36368',
                          '28995','70727','10522','13277','74127',
                          '36495','93789','23498','17541','65515',
                          '24541','72939','59395','21516','53553',
                          '20288','33300','73191','68188','14293',
                          '42871','33855','23936','75557','21245',
                          '82594','61800','59701','96073','21526',
                          '43176','47147','90282','26711','40673',
                          '18618','35058','25663','66227','13949',
                          '44662','77455','70539','18865','93704',
                          '19782','27560','31250','71336','62755',
                          '65831','10331','79711','50490','45182',
                          '98477','15857','23248','59790','12755',
                          '27124','95181','11508','90421','52408',
                          '19894','54081','96354','53525','66748',
                          '16403','12683','70824','13925','45680',
                          '78256','90156','32996','44489','83628',
                          '32951','43090','87973','56913','45874',
                          '96983','56826','50767','56173','26218',
                          '64898','43607','52123','80368','35262',
                          '57992','58821','23611','33269','89867',
                          '57232','35412','25893','10194','57392',
                          '52060','72361','79318','32641','89214',
                          '98593','13778','92485','77613','56731',
                          '34098','17095','65600','54785','91129',
                          '64624','87242','99369','66478','68870',
                          '63083','35526','23434','93914','46560',
                          '43213','97357','24504','94328')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


