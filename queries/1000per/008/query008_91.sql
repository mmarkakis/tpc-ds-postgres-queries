
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '35324','96809','60095','11523','76088','60621',
                          '67354','27688','54765','25785','58417',
                          '52814','99369','75186','77939','67191',
                          '63426','23494','57362','99855','50148',
                          '84016','47613','86336','86366','14976',
                          '66027','95313','14074','68318','17495',
                          '30868','10247','75498','12360','71203',
                          '21343','81827','40886','60392','23641',
                          '34306','81913','68164','69449','57443',
                          '91994','33772','25271','18092','47658',
                          '73937','78638','19700','82510','93126',
                          '69539','10688','42539','82291','55744',
                          '29026','87995','20215','15196','30815',
                          '45865','13976','84864','64364','23181',
                          '60357','48758','54028','68478','79569',
                          '32643','12572','24983','20051','98018',
                          '86986','19007','74055','85090','70611',
                          '40919','12724','99911','61106','88975',
                          '62051','41232','21704','19127','33602',
                          '33834','37472','32097','79202','22722',
                          '16992','98861','22627','90903','27003',
                          '70289','94285','74148','76887','31672',
                          '78162','16171','87431','93648','78115',
                          '22165','88056','99278','55562','96364',
                          '92388','53342','53720','43396','77753',
                          '90034','18004','31075','69554','53150',
                          '79031','43905','34761','64164','77880',
                          '87751','28300','68743','79081','11340',
                          '72486','66411','50853','70661','71752',
                          '73908','10417','44696','61301','20168',
                          '89783','21717','25250','39120','31734',
                          '34665','94192','44912','73516','91438',
                          '42737','87011','88554','33501','57401',
                          '51864','27715','39674','37371','58208',
                          '22872','33545','42825','33837','20908',
                          '70222','35846','95721','78531','55102',
                          '53470','37755','92028','98208','69502',
                          '60507','66095','35555','39319','75048',
                          '66896','58657','88424','84025','61654',
                          '24930','96735','76114','13032','96971',
                          '85270','82829','79111','29400','72857',
                          '84107','32465','55902','62327','32584',
                          '21866','89323','58386','46301','49105',
                          '92595','77156','55568','21596','38479',
                          '74531','89380','53587','52481','94360',
                          '51598','34259','41223','54010','54722',
                          '70736','94567','32611','25912','90371',
                          '62911','80116','62571','89147','83314',
                          '88690','51811','93554','18296','52915',
                          '25670','74552','88803','85582','95390',
                          '31770','15294','24003','61892','73364',
                          '32618','65671','86277','31930','81043',
                          '39038','23319','56106','57736','50296',
                          '80692','56446','76245','16272','83649',
                          '77598','59672','30993','23903','78270',
                          '64246','15994','29130','23907','65926',
                          '42400','99694','42733','77374','53162',
                          '76484','57770','66894','48002','14108',
                          '20300','63976','75197','23264','44126',
                          '77080','18769','83814','77410','74313',
                          '34885','69260','25454','26819','42231',
                          '16669','14110','96811','27047','69999',
                          '58344','24773','43523','55741','90362',
                          '55471','49500','40259','18506','13402',
                          '65540','58362','14042','71283','40526',
                          '70640','58125','24310','92823','63487',
                          '64766','52386','43420','78756','23029',
                          '12850','11123','23353','20268','78972',
                          '19085','38749','38142','72527','79494',
                          '25875','33219','93495','28821','91218',
                          '26507','31917','41926','27593','76650',
                          '74137','62713','87477','85948','39040',
                          '67525','40750','71286','64944','72039',
                          '82106','71375','43078','34562','11478',
                          '55184','82125','56135','79134','81741',
                          '85902','25361','25282','74306','74926',
                          '72937','25162','90452','61871','53866',
                          '12825','30261','48720','64974','95890',
                          '37530','11399','52635','48979','42900',
                          '33850','96825','86573','93773')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


