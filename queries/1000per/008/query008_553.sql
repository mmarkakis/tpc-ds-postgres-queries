
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '35782','93549','31626','94488','88648','21386',
                          '98563','95672','80347','73415','91398',
                          '50947','96345','50136','13564','11094',
                          '78396','89574','15298','94387','45497',
                          '16312','23965','78223','57425','88686',
                          '54301','83265','38769','59127','84045',
                          '81211','17230','65671','73494','34868',
                          '74526','14067','62790','74367','34282',
                          '91692','88093','90678','27792','38308',
                          '25381','89478','36444','53312','39207',
                          '61406','59577','49482','19942','96636',
                          '75060','14756','85259','94630','18754',
                          '32678','29452','54007','71092','31480',
                          '51286','18666','96694','22469','75158',
                          '99891','88951','85231','59707','61654',
                          '84996','66197','85905','21921','38717',
                          '43863','79000','34916','66811','39240',
                          '56367','31127','79471','76157','53848',
                          '58854','58736','85907','73711','13850',
                          '36892','49990','51613','34739','63401',
                          '87864','23777','61442','98220','42232',
                          '66707','77962','96326','79654','63454',
                          '77157','81847','74755','31728','12358',
                          '30877','32801','34806','50373','35705',
                          '19200','12720','15100','90271','34396',
                          '88245','32903','38815','11433','24772',
                          '19660','73499','45094','14907','31405',
                          '60412','17716','43372','25900','74017',
                          '74905','36411','68994','99434','58162',
                          '50681','55027','85161','69574','11311',
                          '99262','47803','35083','28140','38803',
                          '72249','72046','94390','91024','91451',
                          '34787','74687','46545','33876','73025',
                          '37224','67645','95987','30576','64049',
                          '98670','43461','31075','38231','98108',
                          '18610','31804','27195','90880','92587',
                          '19909','73745','61957','93315','43313',
                          '14830','82015','62487','43824','72849',
                          '54502','81395','37023','98080','13430',
                          '45394','87373','42574','75031','44666',
                          '91720','53969','61468','64728','52430',
                          '39476','17126','65140','73305','11253',
                          '21598','39809','93801','15145','15345',
                          '48149','99637','98005','95710','80857',
                          '93323','58567','84720','81587','90669',
                          '24113','57830','15060','64764','14505',
                          '54412','67001','33057','77906','96224',
                          '77329','72816','51159','15285','26922',
                          '22121','93919','18773','91492','44647',
                          '37819','16171','75494','95198','26183',
                          '48134','30867','36277','62260','18423',
                          '86536','36714','82400','13957','92284',
                          '85266','55750','19158','99342','77058',
                          '77215','55754','29172','83385','47611',
                          '56763','19658','62747','66070','34559',
                          '34252','86359','31532','25730','30371',
                          '61771','16861','17715','66945','82077',
                          '70960','52473','75273','72096','16068',
                          '84312','63680','32853','22873','21907',
                          '92682','52015','89193','29366','85072',
                          '62791','35093','54130','28892','78073',
                          '96162','51581','58378','77159','17243',
                          '32790','97467','54106','24794','41924',
                          '97341','79650','88867','12909','73894',
                          '92063','54992','94071','19833','53740',
                          '77516','66607','46334','18096','63919',
                          '84005','44262','23152','19835','30017',
                          '47745','25656','14567','62011','91266',
                          '38300','37136','51711','52136','12325',
                          '60078','50599','73973','13056','33385',
                          '72281','26413','30985','88999','69697',
                          '50914','25125','77991','45817','61886',
                          '78576','61874','95244','59096','72827',
                          '64655','16802','91106','46049','78785',
                          '24810','93340','29780','85307','24356',
                          '11093','40129','84315','79778','89373',
                          '38432','78038','21655','30634','53967',
                          '24985','14358','32240','64035','48485',
                          '29228','87009','63880','29014','17513',
                          '40882','57070','79265','40088')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


