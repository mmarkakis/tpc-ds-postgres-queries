
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '38984','89157','75874','47084','17653','82962',
                          '79139','28718','66995','80686','86987',
                          '14777','66170','64570','98437','73597',
                          '46455','48517','96375','69702','45583',
                          '37107','49573','95400','25217','26705',
                          '89043','35888','57497','59576','57801',
                          '90698','46617','37089','38559','11196',
                          '73268','60007','35432','15907','11312',
                          '29983','56847','69873','12026','57594',
                          '31689','56737','88943','71777','93960',
                          '74364','99338','89473','68495','38798',
                          '24085','42234','55521','18378','63510',
                          '36915','73304','50420','76746','63511',
                          '70768','62779','90230','38880','88449',
                          '23980','86660','57239','26205','74903',
                          '58627','88107','92789','26063','59239',
                          '25409','51309','85281','39473','49102',
                          '81327','24881','97354','50176','80770',
                          '89284','28332','52010','57224','40277',
                          '27146','60729','89739','90438','87805',
                          '71698','54532','65989','54346','61665',
                          '75139','57661','43358','24941','95220',
                          '66792','74995','97022','16852','17737',
                          '73977','44565','35640','59884','36163',
                          '85841','35297','71069','75816','64247',
                          '63256','87032','22493','75110','65892',
                          '88886','81662','14523','97679','46628',
                          '17905','80888','28827','31713','92289',
                          '90180','55955','75807','90150','27459',
                          '19551','70935','91322','91368','74505',
                          '51779','27482','72083','90371','27081',
                          '24907','97237','94723','79012','51579',
                          '32856','32216','10300','29593','63855',
                          '11068','85382','84064','65149','60481',
                          '63313','65568','83294','21083','24356',
                          '87077','22728','23931','93094','44169',
                          '28141','44713','63545','46228','23935',
                          '94617','22597','88233','29977','77781',
                          '69457','69451','70418','70548','73605',
                          '51212','69189','67860','55927','31386',
                          '11192','73748','79310','94687','70943',
                          '74800','87574','42202','30330','47725',
                          '72492','87842','22808','83321','14468',
                          '91701','81617','30336','29567','61830',
                          '25232','83069','96035','70059','97991',
                          '74919','96006','19480','73091','90366',
                          '71463','89900','79603','53552','52739',
                          '68665','19666','39100','51701','30534',
                          '94872','79054','12482','99546','67996',
                          '65300','74667','30525','79692','86186',
                          '56129','45902','30069','95310','63344',
                          '65864','33927','74619','94051','29794',
                          '81524','56883','45634','93460','32392',
                          '77077','32523','66862','91849','73314',
                          '40563','14066','81813','21851','19319',
                          '71028','21898','82438','95203','54148',
                          '56423','17709','36471','42909','96116',
                          '89343','82699','45355','23785','75667',
                          '91773','83809','23801','89030','68204',
                          '20009','89435','69894','94659','39550',
                          '82532','30756','51633','99033','48482',
                          '19467','84657','26486','40537','22521',
                          '20868','85701','81934','22975','26417',
                          '65465','84054','51588','24717','49635',
                          '70394','35621','16486','31448','78342',
                          '58480','25768','40633','86795','49825',
                          '49793','38040','86578','50441','73906',
                          '73090','39999','65398','90576','93557',
                          '75748','65772','28811','98274','57130',
                          '37679','93219','16312','11318','24680',
                          '54481','36849','60957','53026','16233',
                          '61858','88074','87921','60985','65434',
                          '74777','23643','44449','34184','39334',
                          '28632','38195','66604','17706','95788',
                          '13152','90890','81584','46669','15801',
                          '80386','96147','63604','82038','24947',
                          '21112','70760','69054','62656','73641',
                          '93165','49606','94714','69102','53975',
                          '31433','45844','86009','42474','15147',
                          '95184','52900','17964','91915')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


