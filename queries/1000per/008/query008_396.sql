
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '37885','70135','73112','98857','68271','13264',
                          '69937','12400','67428','10200','54837',
                          '68255','21494','54978','53250','22493',
                          '98259','27220','70026','41066','24905',
                          '24080','46570','54560','34065','21197',
                          '11665','35675','18274','34978','32002',
                          '14481','75248','90283','23501','17804',
                          '42195','27276','18238','98189','86565',
                          '38304','98474','38617','44547','34299',
                          '58807','69929','35020','69718','83329',
                          '81178','28398','70615','64286','21814',
                          '27831','46177','18232','20253','77310',
                          '90934','10080','56900','71626','85797',
                          '62096','41153','27622','42555','82955',
                          '27245','64708','98662','21769','90195',
                          '73614','25334','42309','29678','90267',
                          '12755','24072','46106','81982','27604',
                          '44445','64555','79422','13542','33088',
                          '71315','43504','37751','90333','17414',
                          '66929','30560','51377','33768','76253',
                          '85754','18382','36353','51773','53897',
                          '53848','63037','43507','60268','27811',
                          '44392','40956','68565','31070','91109',
                          '93775','18991','95645','10709','19604',
                          '26268','44366','54403','31124','58239',
                          '71935','49666','19513','62009','29966',
                          '64066','83101','93799','87123','18880',
                          '67007','57345','16829','62970','20466',
                          '50855','88926','85617','93970','32513',
                          '99741','66005','44206','22119','16848',
                          '37671','69100','11890','28826','90128',
                          '88950','92488','16434','94131','13226',
                          '91004','49531','84981','91143','80569',
                          '37844','49023','46092','73607','18540',
                          '16685','58375','64549','47423','52395',
                          '99113','45394','83768','87045','27463',
                          '29779','90287','96596','54990','67758',
                          '92952','38969','71330','31762','40173',
                          '49219','79025','79148','63917','88917',
                          '30044','59020','50533','39841','75351',
                          '86361','79863','82907','71201','10318',
                          '75293','50532','83500','15574','62696',
                          '69681','26468','23080','37283','78852',
                          '67565','57914','51122','69684','34998',
                          '94692','25717','36586','13107','59523',
                          '33321','64294','40629','46558','98719',
                          '58365','72882','85270','20916','46126',
                          '76798','40285','56631','27384','31501',
                          '38411','54732','27543','10551','14251',
                          '33730','59968','16392','57681','90094',
                          '88982','43491','99546','42717','39985',
                          '56051','69474','95588','59118','62509',
                          '34086','43624','73530','39971','30211',
                          '27257','94099','28383','19792','44321',
                          '27090','10822','63600','23232','20250',
                          '83584','48335','72859','91807','66214',
                          '56206','97866','96692','81907','13075',
                          '72137','62800','19252','27958','20839',
                          '74309','26020','10204','33528','41454',
                          '48495','66049','16364','33881','62978',
                          '19685','98899','75645','47769','80927',
                          '67976','93239','92902','41683','13711',
                          '11261','62037','46833','26721','53540',
                          '69310','18105','80152','44314','88099',
                          '94437','38848','28024','14304','31603',
                          '70710','31931','43428','16942','14499',
                          '41738','46395','86683','20985','27934',
                          '74470','75077','98426','56380','34647',
                          '76692','20053','50011','39499','70172',
                          '49095','76843','88793','66863','47519',
                          '61730','63191','86631','48523','12454',
                          '95221','83973','24804','43530','27158',
                          '79343','46787','27920','62897','99362',
                          '30986','98810','77155','81752','68387',
                          '85576','21491','54311','58728','76050',
                          '33166','92806','15189','65340','84106',
                          '24453','98409','78782','87191','82755',
                          '87290','34219','46675','10864','88213',
                          '23853','23992','10813','47865','90058',
                          '55411','85966','29337','39478')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


