
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '32188','19552','91481','50027','40680','41185',
                          '56917','47602','75313','33467','27004',
                          '62747','18354','17161','15830','27310',
                          '63152','89667','63474','75800','10803',
                          '69027','83074','41732','56968','55070',
                          '91174','77542','13111','71780','75424',
                          '71640','69590','89797','88090','26906',
                          '39279','24498','34935','73598','64562',
                          '56749','33941','14133','75205','63552',
                          '68163','17626','27564','29355','83394',
                          '42012','59709','90108','74925','53736',
                          '87218','92108','99111','20741','10481',
                          '58767','95720','21697','92272','97638',
                          '33249','23225','68873','49918','12522',
                          '84068','75138','81231','80328','81182',
                          '13643','84519','72154','16508','33610',
                          '87440','18201','92758','55244','19460',
                          '52386','71289','71934','15583','25184',
                          '29120','84553','82844','41158','80261',
                          '32484','97646','55299','94098','33749',
                          '88257','90515','66052','33771','80087',
                          '84406','96004','68090','17998','49601',
                          '47656','68852','79796','76216','37694',
                          '35788','19014','30172','73875','38971',
                          '58751','47572','77463','57894','61001',
                          '45420','44935','37779','47610','35819',
                          '50653','76863','34041','10445','74911',
                          '85852','36291','28752','58731','67452',
                          '92988','56438','89987','33369','29070',
                          '19425','50973','22944','88151','94817',
                          '45578','68216','60385','59084','89455',
                          '73891','21963','63970','93744','47119',
                          '22259','12179','11940','36473','66209',
                          '71928','93648','43188','12763','79419',
                          '20850','93338','38414','37817','81226',
                          '14547','28069','27018','97510','99556',
                          '14880','39447','55769','25553','53038',
                          '52793','59135','48027','23611','37251',
                          '26168','41552','32209','58545','68315',
                          '57213','67929','93549','56587','27139',
                          '47558','35303','46790','90815','30097',
                          '55876','67974','53643','69105','14235',
                          '35806','92425','28348','98336','93094',
                          '21162','42948','14311','43968','21723',
                          '28686','73515','87400','31822','96901',
                          '67936','49806','87172','48486','85568',
                          '17938','99936','35204','82758','14613',
                          '77255','25928','61534','30718','94835',
                          '29981','66453','31298','86557','95903',
                          '18681','42491','29780','97767','55297',
                          '32127','73719','57090','82962','88539',
                          '78856','19610','72412','79896','77457',
                          '10127','13099','31085','77985','86967',
                          '24494','66611','52519','63192','49989',
                          '62357','51813','42404','81478','50517',
                          '70469','10333','68382','80815','50762',
                          '24762','97821','22413','97594','11124',
                          '15822','43070','78150','54215','88205',
                          '45728','27175','16263','37945','59064',
                          '45148','39996','70140','21693','38840',
                          '76656','97140','68615','75577','17009',
                          '13862','49813','65463','62093','53821',
                          '56116','73949','82804','17982','67341',
                          '18086','52828','37720','61414','40075',
                          '64201','20601','71995','73498','97203',
                          '80051','23925','41582','43342','82393',
                          '70056','91232','56951','43977','64074',
                          '37879','70637','59550','55238','74513',
                          '28762','13841','96224','41374','15582',
                          '76805','63697','40285','49805','46313',
                          '34687','34921','12084','67319','84375',
                          '16467','75021','33282','71517','69113',
                          '21348','86417','22586','48277','32424',
                          '29073','85386','76439','73355','52864',
                          '42733','64894','67098','50537','21858',
                          '47269','25142','80467','37194','20966',
                          '48965','59364','92380','54397','39615',
                          '75219','52911','21672','33512','69943',
                          '76524','25048','60393','35065','12413',
                          '47542','53753','63767','36675')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


