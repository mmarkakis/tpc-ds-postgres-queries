
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '64008','44926','30791','73170','17270','87215',
                          '30815','70734','50175','24986','26056',
                          '36265','19120','55874','60623','61474',
                          '67126','12216','22363','83618','61265',
                          '23201','38285','33018','96232','69096',
                          '94420','88268','70297','20046','33035',
                          '35668','68286','68971','72617','27844',
                          '57503','17157','24911','54378','68710',
                          '32248','40991','67360','47317','50105',
                          '18124','11840','66465','93806','20953',
                          '96760','14077','46886','78560','29427',
                          '28656','50797','93808','91444','53526',
                          '89142','81048','70379','86394','87931',
                          '36043','87457','59223','64231','86395',
                          '33986','82638','44957','39852','85642',
                          '80026','93139','92295','72991','55699',
                          '31738','84536','42067','33183','28738',
                          '79754','35979','38301','32222','81538',
                          '98017','81717','56483','25572','71438',
                          '77926','67480','18737','70595','45415',
                          '58602','57217','93267','71158','85414',
                          '55781','71560','73580','75926','98289',
                          '77372','48904','23996','47416','55158',
                          '60848','60010','14024','58203','22788',
                          '26078','98020','78332','77736','11270',
                          '23816','87742','89145','68250','86347',
                          '81528','97563','60370','85632','55417',
                          '23825','13461','63251','74209','45850',
                          '20049','49240','72274','91605','53609',
                          '53248','37859','99238','60939','67106',
                          '91126','25279','61705','80493','27403',
                          '48514','30621','70839','31970','52005',
                          '86170','93668','27490','62768','18252',
                          '51911','19309','30756','15081','92586',
                          '87793','24039','30845','95272','68950',
                          '88919','58700','19946','71192','43374',
                          '91022','19025','17765','80559','41644',
                          '21313','39806','45836','82852','45080',
                          '59665','16411','63334','25356','66957',
                          '87232','46619','17929','44229','17660',
                          '45845','52943','49143','13527','45475',
                          '82335','42781','27871','75479','65370',
                          '59053','18630','92743','59280','14391',
                          '15744','37040','23390','88387','75085',
                          '31317','21109','10663','35700','69202',
                          '78751','25916','56769','37245','25955',
                          '17253','35151','48816','80770','36700',
                          '16153','88694','15427','40986','56070',
                          '67435','97803','44253','28306','99589',
                          '10956','64488','81945','38321','21095',
                          '66479','43190','20433','53187','19286',
                          '33428','60384','22613','85316','14800',
                          '77545','98062','66331','42694','89132',
                          '32228','98633','57995','62120','89471',
                          '10696','26080','28070','74882','59308',
                          '56705','94772','70770','99334','93168',
                          '60513','83466','44132','91657','90700',
                          '37143','37485','48431','54293','34510',
                          '47849','52896','53940','81422','29151',
                          '40293','40845','53542','67561','83757',
                          '38233','78197','64966','27259','64753',
                          '42639','54336','59729','43727','65562',
                          '46570','72244','59009','11999','66391',
                          '85275','18181','28110','34445','23740',
                          '45802','41004','95797','42069','72370',
                          '22205','85992','59021','21071','40884',
                          '63917','47662','40957','64936','49047',
                          '51704','79937','33328','15282','76234',
                          '47153','19424','98139','41667','16235',
                          '91065','24472','56024','32692','96522',
                          '36365','52310','15372','67489','61477',
                          '37169','12822','46490','21289','94160',
                          '55830','14343','55319','75174','95705',
                          '47060','38371','71146','24336','45839',
                          '46304','62774','55031','66173','36729',
                          '52533','91354','45609','24408','29721',
                          '59953','26306','33591','13316','30972',
                          '36623','34827','72251','44028','29611',
                          '87369','63525','25665','85722','63088',
                          '54058','18621','45515','48718')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


