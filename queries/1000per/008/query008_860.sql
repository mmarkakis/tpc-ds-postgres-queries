
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '46049','11595','36316','10271','46001','69814',
                          '97759','64641','67208','87749','82831',
                          '10522','82526','50726','73150','33473',
                          '44490','59355','69091','20375','43263',
                          '20194','39036','88115','84639','86081',
                          '21687','43495','80431','40380','45764',
                          '65957','98692','24178','10491','26459',
                          '91781','57253','63817','43690','14524',
                          '82823','70136','65570','30416','87825',
                          '45122','24493','32403','49465','57995',
                          '57416','22993','10472','40205','73947',
                          '32351','13533','50357','20468','51271',
                          '97259','20335','53339','75324','75115',
                          '88090','36076','40047','14070','12005',
                          '83964','99053','49185','75526','33443',
                          '33391','24323','81774','78651','40737',
                          '46852','11564','18900','97055','70156',
                          '18232','48943','99369','13974','72097',
                          '15088','92138','25898','37536','86813',
                          '89334','34905','29026','86517','31279',
                          '92160','69690','23471','24779','75366',
                          '47006','39581','96470','57002','72041',
                          '93801','24629','99424','68207','34992',
                          '42793','51115','91964','59148','84364',
                          '43032','61765','32201','78721','17274',
                          '39106','98991','26812','27571','88840',
                          '85422','89784','24318','43157','55949',
                          '55718','44682','54652','92019','72314',
                          '96034','11210','66712','57204','17386',
                          '36768','83058','83929','83094','10386',
                          '46407','65152','78339','30252','23059',
                          '45286','25485','62288','49543','21532',
                          '97250','25424','60799','14765','98896',
                          '66558','21711','78851','79855','79518',
                          '73769','75678','15080','13303','36456',
                          '15001','19643','93083','15073','59008',
                          '96085','62077','32845','86829','75628',
                          '16067','35451','18532','67523','86359',
                          '65120','16879','76867','57994','34993',
                          '58649','13601','46664','69163','17092',
                          '71638','84335','22532','92231','11891',
                          '44255','21020','64606','51060','62167',
                          '83875','72715','95676','36221','22834',
                          '83631','92378','57160','94349','64587',
                          '54894','52617','67082','31203','37855',
                          '30882','81298','85452','55349','28017',
                          '90080','58035','23091','23581','88630',
                          '60821','32611','72179','12845','61923',
                          '75381','89505','99084','64498','97917',
                          '59506','57616','53775','86803','39615',
                          '55278','33848','79295','76572','36867',
                          '24645','14323','44646','23473','27494',
                          '47085','43137','84625','88361','69174',
                          '93183','92211','97300','32776','34220',
                          '88801','10770','58535','85710','37424',
                          '20502','24093','75681','56377','72676',
                          '13414','90022','39111','61244','13800',
                          '83928','32531','88628','57781','22117',
                          '91421','57778','81849','49240','49609',
                          '63013','79706','96131','73734','42510',
                          '18992','33545','58722','29945','67765',
                          '31387','61537','16884','88068','39919',
                          '67364','70889','91685','27717','75839',
                          '95747','94535','75188','87714','30775',
                          '45087','51783','22539','21266','41375',
                          '31095','89035','76923','33811','78839',
                          '55000','74141','44636','34673','57828',
                          '82399','43909','39567','32669','36719',
                          '84290','98288','48754','51614','37387',
                          '90265','88634','91376','91831','52200',
                          '78481','34695','34095','10788','24456',
                          '11945','98263','65107','82719','91998',
                          '27506','80019','20935','58208','58621',
                          '95261','15180','91165','23883','43836',
                          '61344','41524','81622','23738','63559',
                          '87966','12985','59721','82646','39795',
                          '63631','82850','43512','68637','65304',
                          '41668','57667','77997','14701','32213',
                          '35405','96870','18553','25790','88196',
                          '95113','84199','18358','66912')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


