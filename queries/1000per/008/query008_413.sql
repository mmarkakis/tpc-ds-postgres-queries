
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '83115','58003','78118','35805','24128','41234',
                          '81426','76450','87175','89919','56994',
                          '79930','26402','10238','26522','61472',
                          '79940','25737','33146','27556','60855',
                          '70844','64286','19488','86167','89641',
                          '91807','78735','79958','68385','35719',
                          '31072','91795','62678','85727','81735',
                          '77910','57519','62787','52191','12965',
                          '21631','59230','47578','58175','20445',
                          '66835','66067','75373','68038','17929',
                          '47529','36803','32979','36540','57404',
                          '16658','67061','75527','18229','68770',
                          '95547','39837','13602','87260','80695',
                          '35804','12703','31441','77024','23519',
                          '92689','48685','99832','84375','79043',
                          '13555','67174','89567','92841','12523',
                          '97534','76124','70528','14064','28079',
                          '60953','46658','45569','63488','86249',
                          '19462','38648','90171','85857','87428',
                          '40587','96023','80536','95728','87059',
                          '93730','70004','14719','41414','70867',
                          '79499','22416','70693','13424','15581',
                          '94720','73303','84448','97422','78085',
                          '20440','91309','16373','65450','49962',
                          '91741','51447','21127','87688','72869',
                          '22013','69608','52027','34227','79378',
                          '23498','91851','95334','99103','24063',
                          '84339','57807','39087','39151','76469',
                          '48323','46150','11016','35272','79994',
                          '14388','25722','72556','45296','83191',
                          '35600','60477','16885','73478','98921',
                          '16338','74307','53904','52116','79680',
                          '52529','61416','94080','67139','70212',
                          '58871','38681','45627','79621','35577',
                          '97179','72584','15741','16239','88878',
                          '24217','69725','74047','84900','26744',
                          '56117','15470','90003','70695','98865',
                          '73483','52327','68825','65429','80531',
                          '77315','86457','21679','95186','46318',
                          '63040','73519','53576','45290','37755',
                          '76630','40237','25406','56969','10687',
                          '36432','64009','44559','74792','32288',
                          '52894','65424','32227','35283','98372',
                          '18863','69347','25400','87312','84137',
                          '11401','10579','69275','35800','53572',
                          '57162','54524','48441','84672','25405',
                          '96667','24290','38504','39665','13586',
                          '37977','94403','49859','78312','89810',
                          '43487','92716','75683','82608','82972',
                          '45257','45385','68361','53798','61332',
                          '96002','38693','79417','36616','21778',
                          '97013','57775','30468','16343','15805',
                          '22129','93355','14796','25636','86407',
                          '53184','97668','98831','70820','37655',
                          '30920','25658','38838','47755','40409',
                          '42597','75818','86948','18705','45126',
                          '25962','75017','24051','50901','65291',
                          '25769','21105','15106','91230','57763',
                          '58355','29701','39587','34787','99391',
                          '20034','81320','27587','94882','83829',
                          '31553','42024','70860','10517','40682',
                          '25970','35567','28766','32577','83011',
                          '20055','63440','24798','73627','62400',
                          '21719','28320','72057','54386','79510',
                          '53375','61314','77220','41067','62533',
                          '21692','50252','44556','92462','46416',
                          '60504','28613','79701','42086','83154',
                          '18195','75975','83731','59337','66639',
                          '77644','87493','45481','21738','55676',
                          '52567','10295','23709','85091','74041',
                          '43758','17675','26390','58573','27228',
                          '77127','20741','37006','61175','65649',
                          '22046','13385','25648','70213','87878',
                          '18094','69875','74914','37097','59560',
                          '98379','77783','42632','96778','73362',
                          '85235','79211','26579','67181','35847',
                          '22981','65225','23731','98694','24913',
                          '97238','52790','78996','10601','34303',
                          '35392','16660','99108','82121','17125',
                          '73032','10717','82925','63987')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


