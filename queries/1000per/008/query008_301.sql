
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '75630','88401','36670','48596','46258','95078',
                          '89940','47928','97359','98859','92371',
                          '15259','25220','84803','14639','66561',
                          '25558','85058','36534','51300','24680',
                          '30285','34779','36158','99546','80010',
                          '51495','44522','69924','55230','41533',
                          '67213','59799','68109','48907','58848',
                          '32395','78296','58136','39752','16548',
                          '28160','63600','45410','29464','45765',
                          '63754','51201','98186','48316','70679',
                          '78961','52924','89973','39654','28427',
                          '49140','21270','57236','54660','96308',
                          '74764','71880','39611','37615','59644',
                          '56750','41140','99514','82402','93184',
                          '50817','62095','39968','66630','29976',
                          '38026','26238','15710','52640','99873',
                          '89308','44822','44443','78588','28750',
                          '71725','61181','51801','38588','24627',
                          '67745','14778','95386','68705','99148',
                          '73459','14588','33007','85442','16547',
                          '89018','87995','79953','74758','39784',
                          '82681','31486','68211','94488','45632',
                          '55628','52208','10967','58803','84999',
                          '94951','75064','62364','43159','66192',
                          '80670','68786','41033','62589','77223',
                          '65242','40691','23976','27192','30848',
                          '40120','32246','63408','16661','95814',
                          '62497','51274','95767','75196','66779',
                          '47930','38800','17782','29422','68103',
                          '47308','68396','27405','29427','86359',
                          '55033','35897','83844','36354','74761',
                          '97582','17773','81579','89041','20434',
                          '73134','76346','18395','50797','54224',
                          '30081','16403','71792','26308','51861',
                          '45065','76390','35216','90130','75326',
                          '63864','28141','93785','58316','49916',
                          '63737','40603','76826','91666','59064',
                          '86872','82451','67707','10044','19572',
                          '56518','41218','85088','41471','23505',
                          '15322','82822','12680','51979','19754',
                          '90663','43493','46312','35973','83669',
                          '55305','95403','11409','88966','10745',
                          '60299','54095','66304','20930','24333',
                          '53004','74990','44330','93210','79699',
                          '97275','59957','72306','12401','90677',
                          '11987','77799','19598','52009','64038',
                          '59603','78785','92054','40794','17507',
                          '15159','19910','79406','71482','98956',
                          '58213','18161','19316','86076','38189',
                          '37588','34049','43212','28674','40146',
                          '43733','48186','85315','63194','75719',
                          '49107','13093','79975','74114','69999',
                          '33402','11082','19882','92042','25266',
                          '79379','95713','30648','71485','53756',
                          '58314','70921','39101','93076','19264',
                          '95298','35734','24485','25818','32523',
                          '78051','83380','57873','90380','49638',
                          '93504','24137','16465','61258','57170',
                          '19484','58084','35849','36709','60610',
                          '94220','64027','53733','87576','52083',
                          '13035','58562','75398','80658','11745',
                          '60076','48093','28820','88610','31148',
                          '23796','42386','81955','69508','82903',
                          '95263','73833','38769','84078','52099',
                          '48936','91338','96561','63655','47283',
                          '35525','64448','94011','17432','60129',
                          '93367','19198','47912','43052','40708',
                          '89522','92937','27410','63106','90854',
                          '14885','63700','66264','26072','23792',
                          '56554','75977','90810','27104','97073',
                          '65422','42596','54827','46438','12613',
                          '31127','78558','46955','32965','14890',
                          '82505','10694','44331','34530','98717',
                          '91217','93452','76796','93806','83713',
                          '68432','98234','16746','18245','35278',
                          '30570','57044','85800','58073','57278',
                          '85186','65099','83470','74109','53930',
                          '60241','73838','43283','65407','79885',
                          '89246','13297','97924','75199','81260',
                          '35426','89566','77180','81471')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


