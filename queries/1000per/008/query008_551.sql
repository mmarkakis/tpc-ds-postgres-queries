
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '49510','16119','59358','23634','68209','98963',
                          '20145','56668','74834','40119','65305',
                          '20030','62038','79356','79905','70465',
                          '18597','75109','85587','14083','38206',
                          '62355','45309','19555','16665','41004',
                          '70706','37663','20538','53443','36032',
                          '68595','38286','70957','35713','28345',
                          '90749','52214','91003','57282','96095',
                          '38001','90050','31643','22044','73294',
                          '19136','95546','81864','38541','79422',
                          '81071','38057','24011','43429','24968',
                          '92823','43943','94595','90458','70407',
                          '14230','81948','37467','87910','68027',
                          '59767','71486','92752','16077','18896',
                          '82485','14245','79193','84151','73161',
                          '81428','48228','50411','80611','17515',
                          '25878','98466','38462','81807','32973',
                          '31971','38195','93588','84187','98201',
                          '23424','88593','67061','82877','46795',
                          '22461','20467','93509','20001','51143',
                          '90522','41014','23691','10633','70437',
                          '63751','10327','92706','52208','57186',
                          '66378','79046','88722','10526','64382',
                          '86138','59651','68874','32021','41042',
                          '28390','41854','40199','15328','52804',
                          '40036','90861','83978','54198','91606',
                          '51616','33611','47290','27487','98923',
                          '38829','57260','87503','58593','13141',
                          '84572','84457','42219','16767','94004',
                          '44228','87391','76278','44444','62605',
                          '27726','11522','56852','66349','17408',
                          '90352','55594','16776','15553','62216',
                          '61656','19650','41240','63004','97079',
                          '40803','49214','11994','71104','42887',
                          '11425','35185','58935','47069','33515',
                          '45753','83400','10026','38082','67396',
                          '26789','89861','71532','81020','42574',
                          '96033','34351','96593','99079','31035',
                          '92952','27743','77264','62573','91507',
                          '55777','49095','22098','84869','84593',
                          '30447','85362','19491','98596','78964',
                          '86975','19066','46661','25096','65833',
                          '15992','27277','66354','91571','78721',
                          '87221','51879','30230','77974','19101',
                          '15602','47395','55530','71410','35258',
                          '18580','84632','15150','58106','69277',
                          '11002','19573','81746','87138','33455',
                          '17541','90700','83675','90915','83266',
                          '60421','72232','82857','81088','83531',
                          '33775','63394','46883','10519','52717',
                          '69292','15220','14191','46295','69777',
                          '73814','65265','65021','79222','66749',
                          '32803','75593','10271','12285','18174',
                          '73377','58829','42228','27522','69211',
                          '14921','52102','28510','70896','93360',
                          '56878','50337','82219','75054','11412',
                          '58393','19151','65014','18215','11540',
                          '33803','24522','77070','33004','50755',
                          '91114','58204','18824','35384','10540',
                          '94237','72799','73526','40973','43654',
                          '56187','16379','42151','25756','35142',
                          '72853','48009','94593','80658','22136',
                          '15396','80981','42006','68731','57252',
                          '65455','75812','55656','69785','18863',
                          '51954','94501','48485','73911','53321',
                          '42221','55055','13128','93328','70184',
                          '62843','98394','27281','66070','81870',
                          '51022','83184','89178','93784','63635',
                          '15337','52204','96300','95125','18867',
                          '72283','65498','51948','17552','55539',
                          '38107','41616','38054','83126','37902',
                          '82902','57129','75598','86873','84389',
                          '99978','93379','77310','99033','24868',
                          '59265','62100','68347','35525','86007',
                          '67044','97746','65567','60012','62897',
                          '32819','20572','16299','95434','48630',
                          '90754','41111','95275','14446','91926',
                          '17920','95811','32165','32220','83552',
                          '21891','15824','81614','40080','79723',
                          '26078','80868','24715','93595')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


