
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '28664','80216','14213','45759','68858','81599',
                          '53062','70308','22099','59229','22652',
                          '54915','40786','76989','92155','82106',
                          '33336','18449','50983','29376','86549',
                          '35280','21459','87811','87998','13222',
                          '11569','52115','16907','46534','22967',
                          '35614','52419','16492','45955','86517',
                          '54009','19294','70812','37396','83430',
                          '48284','10931','11252','29880','13044',
                          '28839','91979','27295','81775','38019',
                          '88450','22819','14376','36881','88073',
                          '26975','46753','99979','98828','88103',
                          '64001','48921','41841','26552','16591',
                          '52028','29982','34911','29383','50238',
                          '37519','13146','46916','73507','47154',
                          '37806','23381','73089','63059','54223',
                          '27336','93325','21861','78789','81461',
                          '17304','76539','46311','62405','79841',
                          '46748','67341','90922','20697','44266',
                          '21995','27254','38545','19674','94301',
                          '58111','67312','83703','69817','83157',
                          '16496','57906','44902','23514','76286',
                          '39026','22369','38995','34869','74429',
                          '16599','61113','67895','53596','12570',
                          '65202','74109','48020','27769','44936',
                          '51202','80208','92238','54167','41736',
                          '89494','31172','71694','34632','95417',
                          '46640','59136','20496','72628','99485',
                          '57225','87308','56098','29175','20282',
                          '38595','67802','25642','26473','20763',
                          '88674','17162','36735','44103','12429',
                          '23968','10047','74258','34889','72229',
                          '10096','14233','76751','21789','76083',
                          '13447','20044','12443','41964','25323',
                          '13664','29928','22992','11701','95661',
                          '61418','44343','47766','95812','10758',
                          '67757','67805','28020','22089','18927',
                          '18796','99627','63629','98795','76484',
                          '24915','51550','53855','78762','36183',
                          '62712','68506','76243','58797','31064',
                          '60042','86588','29475','82601','50825',
                          '78657','45820','24813','55575','40047',
                          '64617','99013','90234','99055','14252',
                          '35604','65921','23125','79127','64531',
                          '20192','17244','93198','79391','88401',
                          '67250','85837','95811','99250','12106',
                          '71463','50615','44496','75506','68698',
                          '66891','71896','18277','38731','89191',
                          '46912','21275','54905','45747','63041',
                          '67405','78493','89430','57983','78741',
                          '11951','42828','19193','75802','23834',
                          '86346','26681','17401','14321','86288',
                          '41912','55171','95529','47259','50134',
                          '69863','82881','61344','66658','97586',
                          '24852','32503','16600','92293','52734',
                          '12352','95705','39992','74116','67651',
                          '67046','72168','40043','27596','10262',
                          '86379','24117','25566','85785','33644',
                          '48563','94118','36779','89456','36984',
                          '88179','46637','26672','83941','55603',
                          '87472','78023','63598','35844','21140',
                          '91853','57543','80892','86619','18974',
                          '80772','38814','31966','55519','17725',
                          '50957','56563','39370','95061','92441',
                          '83722','33209','65604','12794','86614',
                          '52225','38713','56443','32422','97912',
                          '48960','72643','34255','64571','72193',
                          '19915','24093','60236','51282','66086',
                          '45254','99725','23597','33069','55599',
                          '92917','77180','10133','58669','85549',
                          '10960','61675','21767','12849','74929',
                          '73534','69281','70557','94132','92549',
                          '97867','17396','77993','19457','26808',
                          '69961','99596','71810','26179','24470',
                          '54495','94154','44099','48174','48694',
                          '16753','92355','17462','51255','51526',
                          '76287','76737','30606','38809','81932',
                          '93161','56571','89583','56461','19996',
                          '21196','74387','44470','94536','79024',
                          '24878','98731','76226','84220')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


