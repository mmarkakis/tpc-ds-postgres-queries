
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '86231','39811','43517','97572','96770','42778',
                          '74407','97483','67199','86902','92752',
                          '24743','56913','43099','59239','79198',
                          '73739','53321','77383','40397','10168',
                          '73143','77975','25286','68649','79751',
                          '64063','50818','34139','19356','78538',
                          '32314','89521','14242','50862','66514',
                          '92721','36907','30857','57803','42002',
                          '94167','59699','85187','43028','78860',
                          '24319','86274','95913','18342','99998',
                          '82907','32149','26878','91836','28867',
                          '45245','25864','89638','96368','27694',
                          '11243','63936','74727','37150','23375',
                          '43713','66432','73198','22494','29541',
                          '79505','48976','87330','96541','57972',
                          '22575','63645','67352','27843','61140',
                          '50373','70369','60561','32622','59045',
                          '87508','96443','96971','55329','73864',
                          '22989','68287','91275','33523','63450',
                          '95520','66271','28067','15713','32138',
                          '24492','38088','12960','42154','63789',
                          '45098','56291','33431','80449','10698',
                          '82099','66600','48945','51766','52647',
                          '42130','31001','22235','26325','91523',
                          '45789','37352','61484','77899','26802',
                          '40827','40025','64947','32713','53300',
                          '67765','22829','79244','98200','85997',
                          '94458','19108','80736','52909','31628',
                          '34316','21563','52920','51191','19910',
                          '11538','71632','33621','72881','10826',
                          '37515','55298','47113','96715','72050',
                          '93988','14137','14102','80515','40125',
                          '25789','14623','26678','10283','62697',
                          '92125','96291','70003','22302','55763',
                          '52754','86232','67415','68545','24138',
                          '38699','91197','78866','90045','98408',
                          '95281','26799','16779','20611','40252',
                          '39718','66478','35977','57547','21458',
                          '82940','62105','10724','77678','53809',
                          '69232','39693','54971','89804','59006',
                          '44011','97686','99889','96137','93455',
                          '29907','76730','10629','51369','87995',
                          '58332','80090','47781','14797','15732',
                          '85030','22207','10107','99438','25532',
                          '23335','18913','79470','98532','63927',
                          '33965','88934','65296','68619','47697',
                          '43785','91063','56682','19334','94432',
                          '98154','92207','31205','51598','20947',
                          '73993','70175','82818','75377','87263',
                          '74842','60340','52419','70047','44114',
                          '22091','37715','57956','27283','69128',
                          '38627','84864','59552','75096','85903',
                          '73077','25938','65303','38597','65620',
                          '13767','89700','87827','49575','63768',
                          '36984','68585','36202','12146','93511',
                          '86140','31710','49870','80330','33252',
                          '53952','29135','53182','46179','30321',
                          '69921','76667','23511','85946','76812',
                          '66472','26132','97371','46502','19596',
                          '72037','91937','26701','45482','11391',
                          '87595','77226','25628','54428','73747',
                          '52888','49238','36373','59470','42295',
                          '69411','60427','66074','80924','77169',
                          '46155','61158','27019','95791','44189',
                          '60816','86966','81232','53926','50256',
                          '20528','21527','80849','48815','65866',
                          '40484','88449','64962','70468','31528',
                          '54105','36544','99856','40435','90380',
                          '60178','37851','88727','12544','25387',
                          '64434','47865','59051','90029','93329',
                          '55047','73104','98289','45169','59467',
                          '83794','74566','31109','90557','96284',
                          '55503','55556','32676','44452','65165',
                          '79508','43665','78097','41059','45095',
                          '53636','38059','32645','35913','27685',
                          '76486','20022','18614','63386','34830',
                          '40450','58074','42688','85822','23732',
                          '56623','76876','96393','38001','55630',
                          '42787','13272','42093','63508','48597',
                          '35528','12870','19846','25732')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


