
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '76442','17810','30018','29775','44415','14594',
                          '50850','88675','59429','95829','58979',
                          '86057','54619','71337','43611','15786',
                          '35107','73628','19110','16621','45158',
                          '23198','19650','68788','97116','67151',
                          '17152','24624','78658','34315','68063',
                          '30148','62383','94104','73546','15055',
                          '88831','75251','27222','16437','73585',
                          '74800','55346','61909','62883','76868',
                          '63201','58686','63542','41137','55105',
                          '32684','11526','47805','94899','39967',
                          '57104','13029','23050','44164','79847',
                          '86028','27697','14258','18323','50067',
                          '85821','17729','37271','16518','23880',
                          '44824','75836','90288','70340','91966',
                          '70293','11957','96241','99317','20893',
                          '63770','53068','14802','19255','93728',
                          '49571','12987','91085','71106','50692',
                          '31635','48672','15627','57844','99779',
                          '24569','59617','94315','20990','94017',
                          '57603','97461','87232','36196','51167',
                          '12109','32575','22937','48424','63406',
                          '65719','75160','41770','69930','53238',
                          '67856','33294','21840','55301','45729',
                          '30363','71843','74625','28846','69552',
                          '64386','42791','72676','51970','97104',
                          '66873','36135','61046','32458','10732',
                          '18465','19504','99120','17543','88672',
                          '83132','51727','95270','39915','20051',
                          '19470','52095','35637','39385','78193',
                          '11743','88012','98936','81150','94554',
                          '16637','27161','40197','89708','95729',
                          '88815','89242','11208','66769','39371',
                          '86407','23169','83532','29417','99249',
                          '63353','95107','66444','12598','40684',
                          '74648','96326','36430','18466','38161',
                          '12903','60315','22909','15382','11961',
                          '44939','97463','21765','45057','45575',
                          '57933','67097','70886','34241','50835',
                          '91653','89505','99393','46795','91237',
                          '64367','91670','37330','15842','87099',
                          '82202','28279','44898','34162','47933',
                          '13494','93536','25517','16554','90610',
                          '40058','69881','71928','86500','35673',
                          '33179','45864','24576','96131','50382',
                          '37044','59834','77576','87294','12861',
                          '80309','78061','70751','30357','24972',
                          '56559','91327','85598','36793','32623',
                          '20876','37385','19300','65069','40685',
                          '30105','47881','48610','50636','23504',
                          '17997','62212','76148','88729','67675',
                          '17732','88757','73402','77590','70792',
                          '72485','54433','73066','73336','20232',
                          '62713','77984','24465','87641','41132',
                          '57120','85629','22104','17090','59882',
                          '32101','66836','90252','72203','37579',
                          '17361','36596','84839','67058','40207',
                          '50735','27624','34255','61154','41513',
                          '35937','96146','52742','40245','84991',
                          '91207','22620','92720','82800','62685',
                          '59523','70052','71163','68712','71665',
                          '87150','24552','60419','50282','78480',
                          '45650','51235','89163','91687','15035',
                          '52354','47168','52705','30143','64612',
                          '42144','78650','40384','85810','77340',
                          '11851','33680','50744','30249','90868',
                          '56477','32694','47649','84737','39493',
                          '71111','46171','68709','82813','99863',
                          '12901','52417','42560','58937','84410',
                          '55756','54601','77936','72542','15131',
                          '74116','15850','58061','81421','90678',
                          '62747','58699','81959','66027','81491',
                          '29183','57017','54949','23980','47321',
                          '76903','33145','70269','52846','63986',
                          '59686','84785','27941','14546','50114',
                          '19125','47462','46382','37630','64707',
                          '35780','63213','21711','60636','30682',
                          '23330','79999','18731','89582','10597',
                          '31543','14403','83966','93178','60457',
                          '30330','96699','65507','45065')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


