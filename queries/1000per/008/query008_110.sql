
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '52508','76900','50729','21392','24785','28849',
                          '10583','45813','65857','78700','15085',
                          '52534','97470','32913','37121','36204',
                          '60191','45001','74337','17120','33609',
                          '82165','48131','86206','27323','13468',
                          '27305','54187','30682','71040','11725',
                          '32699','64243','22291','71997','40288',
                          '48191','86941','88847','14528','49292',
                          '60217','13915','78740','96326','46104',
                          '28480','80647','38548','65915','27834',
                          '62750','52341','33579','60446','89346',
                          '13344','76123','13479','82101','19424',
                          '76106','91495','18211','64233','49249',
                          '24191','78605','11207','66678','53328',
                          '92129','92999','71075','89652','76719',
                          '58197','90139','93194','51292','45153',
                          '67394','28938','15072','11311','65978',
                          '99248','44464','17188','56985','20133',
                          '58685','45761','76202','75451','35042',
                          '54960','37735','66613','37124','84638',
                          '64649','53819','20619','12556','36750',
                          '55275','67330','15966','54730','57171',
                          '12127','91054','18564','12332','53063',
                          '33563','70637','79888','19796','39554',
                          '13393','81071','40573','87089','30864',
                          '53000','91815','24229','71063','69568',
                          '44218','47485','44629','27569','35960',
                          '43106','10433','55936','64544','57013',
                          '11846','29220','57854','11068','66594',
                          '82652','57167','77913','97149','77001',
                          '92322','80779','99509','11569','35785',
                          '73390','77850','58176','17029','99274',
                          '73044','77728','13451','26957','87423',
                          '62121','47364','82834','86737','60214',
                          '43417','61821','34030','23967','66953',
                          '43274','26209','33763','52216','89374',
                          '74190','18889','51006','34164','74296',
                          '97502','10331','47847','40461','70158',
                          '37182','91763','99733','17660','83657',
                          '90662','62375','13162','77146','66471',
                          '54949','13101','50453','88876','45671',
                          '12091','39021','47343','51373','36148',
                          '27896','53643','63850','32312','75188',
                          '56906','16372','86104','97531','18817',
                          '41344','52888','45755','28802','29373',
                          '71718','19928','46462','45073','78796',
                          '29011','92529','58487','95363','54420',
                          '73706','90191','75837','61907','39979',
                          '17867','92665','11924','97444','19949',
                          '71103','10059','41577','63585','61082',
                          '77240','93134','90194','46449','91863',
                          '62410','68780','59861','58966','46625',
                          '49525','15821','88514','53618','36334',
                          '99445','67383','73566','95098','51635',
                          '49321','81780','83211','59851','55039',
                          '43215','27032','91060','51592','62854',
                          '91636','23251','67110','57056','51418',
                          '56487','82657','94322','98607','97017',
                          '48607','37268','94883','38982','93354',
                          '69581','10181','17074','94018','49768',
                          '18846','30971','21012','10870','36186',
                          '32362','91995','75624','31924','66967',
                          '32639','19875','32850','80657','12876',
                          '85187','20225','25331','21239','41872',
                          '27247','44443','46829','59407','79063',
                          '18422','89461','17326','73916','69230',
                          '68989','85338','57117','48287','21187',
                          '66959','46935','67054','14928','81893',
                          '63480','23202','47197','27002','31739',
                          '95482','50628','99253','97359','19487',
                          '98892','54681','41030','88524','99690',
                          '36018','91612','93613','46740','62172',
                          '88221','12182','53312','55987','90476',
                          '50996','87347','97485','96199','19808',
                          '43629','46607','48381','69989','10005',
                          '71831','92993','15286','91805','82895',
                          '15847','81700','52530','51932','50026',
                          '77020','98619','67135','12428','33644',
                          '50151','53170','68255','48708','95423',
                          '31324','78719','54033','77974')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


