
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '69480','76534','67502','86825','96133','67918',
                          '99817','86370','44753','84658','85358',
                          '20228','83231','52339','12003','51545',
                          '51657','34287','22067','67812','45934',
                          '79084','56558','85734','70532','99800',
                          '59950','16659','17739','82708','48274',
                          '96597','35128','31415','43372','89341',
                          '24582','36267','22611','49238','77691',
                          '90351','51861','29485','87074','16440',
                          '48069','46693','16460','63895','29609',
                          '76306','53373','51969','72513','83249',
                          '15861','91622','96348','15424','24304',
                          '45131','68797','43674','45020','58869',
                          '23248','69447','56851','73775','56354',
                          '64081','34838','73139','48760','46280',
                          '36117','54998','10343','14517','57339',
                          '94254','76140','61683','14292','86102',
                          '92977','63689','12543','89190','41638',
                          '70276','13241','98919','64618','27528',
                          '77955','56911','97469','66702','64074',
                          '21687','89358','27458','39517','66881',
                          '77828','30383','92632','98778','57513',
                          '41669','62430','55135','56536','76404',
                          '68316','42407','38826','85169','81924',
                          '75068','22714','77355','81009','91513',
                          '36993','99285','85942','27194','47131',
                          '41312','15796','63686','97153','21072',
                          '50685','98451','58388','32102','44086',
                          '93243','39378','97015','20908','14084',
                          '42017','96600','30615','69644','56357',
                          '89528','86894','25979','25912','55672',
                          '65514','55538','33055','65833','62099',
                          '28549','89339','29178','13780','69296',
                          '47935','42468','96140','23832','12709',
                          '42657','40969','94752','13222','63253',
                          '63590','87969','67666','58086','34848',
                          '36075','39226','44730','56510','41063',
                          '94117','30804','64806','60531','94426',
                          '71508','16314','51702','71798','28487',
                          '81455','54571','44243','44315','54615',
                          '45785','46257','96941','46163','74376',
                          '75441','41886','82709','95540','52848',
                          '52797','19178','95211','28748','36734',
                          '67816','97878','22097','79501','26420',
                          '38959','84412','77497','49242','69146',
                          '89093','48378','78091','55586','13062',
                          '41854','41641','42830','88247','28809',
                          '71415','36167','44398','29029','50416',
                          '75685','13340','74787','77089','21689',
                          '83652','85807','58901','53593','10874',
                          '39368','44852','64379','99023','56549',
                          '15080','16930','30218','50020','46246',
                          '86264','46968','90722','48540','91809',
                          '39848','33208','23851','64474','74875',
                          '69638','51270','49663','90365','91985',
                          '76141','56111','93403','58731','80726',
                          '64851','24413','78387','24849','89336',
                          '41912','72975','77426','98980','21288',
                          '60007','49782','40824','49937','66226',
                          '10021','55330','36859','37686','85658',
                          '23977','40085','26616','73070','84982',
                          '92252','20495','78219','79347','97091',
                          '13052','77624','54586','26568','71023',
                          '70036','74632','16086','36788','78453',
                          '28899','69144','94789','21156','28718',
                          '16368','76366','85078','90692','66951',
                          '95635','24390','59566','18236','13699',
                          '15100','17326','90682','91938','32250',
                          '76794','58044','47693','59207','71994',
                          '36454','24420','13272','71668','28152',
                          '89730','76048','61157','44320','67845',
                          '39303','18865','61314','85035','21331',
                          '68022','87165','47812','16023','88305',
                          '97861','26800','27575','49000','71216',
                          '37978','77575','76253','10177','98386',
                          '73564','63725','46771','16484','30881',
                          '39135','88245','46642','67086','34367',
                          '97695','49305','64170','14715','21763',
                          '37683','78777','61489','86466','61877',
                          '85041','93531','81322','25789')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


