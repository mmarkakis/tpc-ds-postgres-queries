
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '47505','41317','80123','60217','95766','48599',
                          '83499','94471','84220','32989','29302',
                          '52252','67115','13726','13205','82159',
                          '11247','24655','66473','62018','15399',
                          '72290','32966','16762','86273','14128',
                          '87248','62612','95316','50113','40100',
                          '13645','30419','82189','24377','60476',
                          '69150','26706','36599','97195','92229',
                          '43033','39493','86245','21126','48252',
                          '31235','96421','24509','48763','73602',
                          '82395','90410','49230','47129','95924',
                          '67012','18341','81228','95533','85073',
                          '84057','15394','70159','14238','79891',
                          '60792','93563','92439','30309','80814',
                          '48125','23103','83448','50643','15655',
                          '21703','79636','63111','84857','94825',
                          '57261','78523','67486','65852','38307',
                          '41351','84255','77144','30132','35060',
                          '82769','84360','34015','13177','43142',
                          '97287','49114','89798','75843','46817',
                          '21193','76219','77129','38618','73761',
                          '37570','48840','81193','95567','17893',
                          '78611','26271','63417','78149','98712',
                          '78905','82538','61645','66118','45808',
                          '98478','45468','20187','61474','93345',
                          '82891','76351','84067','47002','75687',
                          '94568','50625','56440','71642','59587',
                          '26621','59019','82871','45827','34563',
                          '88789','69220','79400','30595','40494',
                          '44297','19864','90513','76781','90687',
                          '91267','66660','72588','78625','96477',
                          '67930','95104','10205','37038','26798',
                          '98165','69119','74469','23136','41396',
                          '54068','49030','84745','60029','35659',
                          '75718','35700','21408','39066','88422',
                          '14950','56347','11689','82419','20551',
                          '41827','63800','10826','40619','22025',
                          '35253','28427','39977','46267','63012',
                          '80237','90402','65097','82537','72251',
                          '75729','65828','57997','85582','31271',
                          '12040','95764','75144','49120','33413',
                          '23101','38187','46774','98959','12561',
                          '42255','84387','89429','66248','50828',
                          '37567','94542','39107','75433','10412',
                          '91135','79424','61046','42056','54325',
                          '25660','94433','40939','44975','39596',
                          '22609','56085','33585','58995','26491',
                          '20529','20738','51694','27539','70487',
                          '66376','21660','84440','37177','30117',
                          '78247','55567','69883','59424','18504',
                          '74933','13378','50325','42436','65619',
                          '99455','94009','94717','36538','91688',
                          '97248','56384','22125','45104','99830',
                          '74131','54798','36513','57304','62258',
                          '95561','26673','79741','49828','29614',
                          '22880','75067','30170','87125','59362',
                          '85272','37295','77822','42402','83731',
                          '10072','96476','71263','84157','42840',
                          '10245','38728','82805','85114','35139',
                          '32109','40512','41090','64320','31206',
                          '42805','26021','58458','81869','16827',
                          '68019','96286','76628','66942','16318',
                          '87493','61254','84877','57436','53840',
                          '23074','68762','82266','49440','33346',
                          '84687','87714','67234','17164','35131',
                          '34366','85858','97894','75778','13860',
                          '82160','40852','28595','71728','90068',
                          '36248','72572','72200','84532','12374',
                          '66972','20871','63309','29222','63513',
                          '37036','46399','49639','44591','34523',
                          '68986','90933','70168','91431','39980',
                          '91018','12309','90995','20677','25960',
                          '30750','54492','93110','54329','22323',
                          '76605','12289','35214','92659','52114',
                          '38336','95407','58493','95962','89321',
                          '17427','34854','40978','59996','89400',
                          '21209','55956','82770','29415','11079',
                          '55078','55870','49684','46682','22196',
                          '33962','88582','90280','60204','36449',
                          '45590','98967','51409','17733')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


