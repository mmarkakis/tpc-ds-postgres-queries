
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '65381','84912','23975','94508','24755','48835',
                          '46214','25055','24076','43442','62555',
                          '33353','17484','98863','65385','70152',
                          '53646','41882','16042','46851','33238',
                          '50378','56770','86912','32384','69965',
                          '56884','87099','56079','48615','34884',
                          '91186','32404','84291','55804','51922',
                          '48789','29217','22626','50530','86594',
                          '27542','41045','42962','42644','99830',
                          '94870','53108','87878','34639','35338',
                          '32396','68784','38762','84761','29815',
                          '67494','77202','43636','68003','80002',
                          '72143','81349','79178','88989','35655',
                          '69827','56161','61054','35375','16251',
                          '32335','20071','24045','90221','75359',
                          '96780','59398','51390','98182','66629',
                          '22942','72983','62534','25735','50886',
                          '18820','15347','39023','87976','13194',
                          '71622','41837','22377','69322','49705',
                          '37569','65938','92254','91482','86220',
                          '82396','79799','56792','66911','18636',
                          '87062','10257','65796','51642','36815',
                          '38442','52052','43546','20187','56114',
                          '45955','76118','47401','73405','73321',
                          '22456','44412','73426','26059','24065',
                          '59492','92748','97066','39619','55294',
                          '27763','76967','88468','42262','47595',
                          '47104','62125','97359','31346','92946',
                          '31098','35423','26872','61553','11355',
                          '26075','32099','49962','46137','47987',
                          '28938','59535','46892','70241','91578',
                          '79736','20505','28936','65984','72168',
                          '51936','34741','34104','77789','50780',
                          '92365','50678','70171','16128','84963',
                          '33989','10760','93301','85067','31199',
                          '30815','83751','13564','22478','71300',
                          '63487','82059','93914','98787','61490',
                          '83318','80755','92437','25302','11093',
                          '39491','79990','96787','71201','30424',
                          '11033','36551','77672','18404','76485',
                          '26139','46858','94704','96790','83833',
                          '52766','92750','86510','83502','69594',
                          '69557','46766','54044','21019','70427',
                          '43880','35716','73456','32244','93067',
                          '34031','77074','99153','52281','54680',
                          '99075','33401','60976','34356','72850',
                          '75293','95250','58561','48815','23269',
                          '47479','71632','64567','56174','43049',
                          '50419','88743','14371','92736','22244',
                          '19851','59268','29945','21113','65060',
                          '44361','86042','41619','98989','28304',
                          '97503','99476','57307','29986','23412',
                          '69043','54622','49486','38219','78139',
                          '84001','47269','78207','10809','61493',
                          '69075','91021','19931','41872','45788',
                          '35595','57949','64883','47107','47178',
                          '10313','44590','76261','10414','21947',
                          '12180','87071','34955','42797','53368',
                          '42076','49254','80779','36906','68083',
                          '38301','33431','25074','53213','21116',
                          '83586','45040','44167','11638','17194',
                          '93547','94043','97181','82916','55998',
                          '33779','42319','54058','77970','63434',
                          '80812','61207','37920','89206','28439',
                          '97150','95038','28242','77933','11127',
                          '92605','74642','96652','89719','33962',
                          '56380','83797','32725','28502','23167',
                          '75957','65384','65657','93955','66483',
                          '10908','86315','63590','77056','69952',
                          '13941','92507','71699','18440','51071',
                          '53406','54358','51009','33167','95901',
                          '66457','14042','48121','71961','38248',
                          '49921','18435','27254','61876','90403',
                          '60231','40408','13758','60833','82026',
                          '54438','92492','28389','30086','80409',
                          '93324','65690','30594','78107','19348',
                          '87104','11107','72243','43043','64634',
                          '65727','70274','77985','66654','51205',
                          '77032','64681','43258','76151','75226',
                          '79163','22967','17525','51078')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


