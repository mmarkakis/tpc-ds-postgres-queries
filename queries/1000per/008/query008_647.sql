
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '85762','79454','68780','42082','77979','21573',
                          '16063','97260','28897','31344','99946',
                          '11353','36945','95480','79817','25485',
                          '19747','70564','19675','49534','82965',
                          '76019','76692','82920','75050','13388',
                          '79035','71108','57529','21210','32136',
                          '37754','75015','84314','78635','53814',
                          '87639','16149','47427','30337','32078',
                          '26232','11363','55140','80627','69772',
                          '67874','53153','87986','51637','55383',
                          '82073','10357','20834','16066','32944',
                          '43649','89982','45191','61650','66521',
                          '40160','44599','76108','85948','19704',
                          '37839','99518','33863','15817','13371',
                          '65546','53199','13348','81272','70728',
                          '55469','84300','69124','96905','85271',
                          '53935','96828','78464','27179','69808',
                          '92653','70210','78111','78545','41879',
                          '60346','15574','79688','23422','71032',
                          '19404','61806','18208','38604','93832',
                          '34968','95028','38681','69914','44620',
                          '80700','52924','15445','29991','64215',
                          '10969','69525','79851','42450','91797',
                          '21200','83173','23446','15466','95347',
                          '68423','82076','43760','15047','42047',
                          '76063','57359','52435','95656','48006',
                          '41377','48603','95392','93140','10175',
                          '26537','11708','26700','43462','66859',
                          '58336','34341','23170','49118','69023',
                          '74792','47714','48469','70991','75810',
                          '21454','34835','41906','19862','82025',
                          '66268','49529','36807','76073','22413',
                          '45444','28501','14616','53841','52482',
                          '20136','61120','80266','65373','54990',
                          '47573','94690','63475','58269','45167',
                          '50076','43193','81259','88476','63328',
                          '67508','88210','95366','80954','22252',
                          '53141','92885','40050','42309','59406',
                          '16701','12647','42908','46032','53307',
                          '46896','47468','41519','57337','79251',
                          '12224','46242','82552','81359','13593',
                          '34232','91742','72681','71209','53671',
                          '97047','56252','35596','84703','38065',
                          '51222','38682','13656','44053','45877',
                          '90312','84010','12316','11467','13975',
                          '48680','71166','51439','57542','79786',
                          '99828','84625','49570','36821','64248',
                          '60775','80755','12072','57701','57666',
                          '55392','18488','71328','35814','16877',
                          '87983','65275','70402','32603','45001',
                          '74745','64596','97123','50479','64222',
                          '20335','60711','30917','46852','50665',
                          '86171','77500','46458','44579','26961',
                          '75342','38956','56224','49596','56966',
                          '37584','41249','84324','98320','10225',
                          '22303','87306','42703','32519','35148',
                          '10244','45590','30184','34897','11401',
                          '58202','79257','37215','79897','61709',
                          '29572','59235','91385','47516','68058',
                          '32372','29492','88705','34669','49483',
                          '20553','70057','89160','52613','80423',
                          '86288','20564','52454','56858','65535',
                          '74393','25882','80038','56866','79986',
                          '70939','71432','86469','11258','85562',
                          '71014','71262','95262','91648','95752',
                          '13736','16700','41517','22714','24212',
                          '17668','26341','89491','53171','20818',
                          '89742','50691','65280','10780','72582',
                          '18724','55064','41129','27370','84678',
                          '93118','86499','59805','98159','32245',
                          '16783','28725','98801','37283','31404',
                          '91478','19022','64605','97279','18837',
                          '41056','67972','40903','17810','56096',
                          '77794','17910','59267','52870','56583',
                          '64638','75204','41497','71943','30984',
                          '19634','92611','42867','15595','85590',
                          '23308','94106','17689','70281','78395',
                          '85299','67347','71194','56339','21732',
                          '50940','26585','82143','89139','29926',
                          '62050','78931','70913','50344')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


