
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '54984','22856','43365','95763','89859','78125',
                          '57645','99566','78174','76374','76815',
                          '15910','75179','56982','58346','79896',
                          '67583','46101','75374','28508','97036',
                          '42948','70740','31727','68706','19140',
                          '35395','21449','41941','98429','28490',
                          '61923','92113','77293','74737','15160',
                          '92314','30959','88739','87446','40991',
                          '29260','82246','10721','55678','85592',
                          '70791','43749','98520','89936','41632',
                          '58660','82947','20361','32367','92365',
                          '25229','92948','49773','47479','68640',
                          '91974','40953','54344','76255','59216',
                          '41696','65624','62104','22531','64926',
                          '56692','50119','33671','29887','31226',
                          '47545','78228','46313','15542','36800',
                          '74155','11719','49226','92007','47496',
                          '55677','26636','10005','15753','47146',
                          '56730','94958','77952','93835','31849',
                          '93259','44515','67410','94202','89718',
                          '36438','61059','21624','18741','27465',
                          '22237','21882','56819','10106','75645',
                          '80032','99938','56067','46815','65064',
                          '32507','90312','45760','94598','69371',
                          '71302','41536','18196','47748','96168',
                          '81031','74682','36462','95614','89809',
                          '96728','87716','56079','97582','38706',
                          '95581','48416','38598','47255','26842',
                          '98851','82870','14155','91009','76627',
                          '79925','56755','26310','91515','62739',
                          '79229','88564','85281','17677','38331',
                          '49771','47959','44478','35850','79487',
                          '80207','13264','80468','67069','39783',
                          '16224','63233','95213','59201','44676',
                          '66328','16086','59190','35539','74315',
                          '54636','16763','70921','29201','50974',
                          '29056','26863','76963','87062','75663',
                          '54914','21298','48085','89648','52797',
                          '42253','98455','54643','85052','16174',
                          '72066','45519','40685','25096','10033',
                          '67424','59829','51506','82910','73678',
                          '80524','47679','58149','19620','21048',
                          '15116','17700','34796','31023','73446',
                          '36601','23763','35232','17546','29440',
                          '90713','24628','54876','98392','28658',
                          '86575','38425','74183','64558','47439',
                          '32065','54511','24083','17408','70973',
                          '44387','34527','22664','85994','94924',
                          '78132','64150','71770','29752','63646',
                          '61892','54931','19914','72029','70655',
                          '98875','84801','98319','60064','63811',
                          '51301','78283','84186','52436','13587',
                          '94200','51340','48658','46336','98252',
                          '92940','17059','87976','62238','88199',
                          '49115','20148','42423','84648','33775',
                          '35990','48688','96828','32491','53559',
                          '89536','78475','60005','77646','98084',
                          '94818','65683','60194','55038','16854',
                          '96131','55865','73850','33065','16724',
                          '78739','95768','79816','78482','64281',
                          '95084','46322','58406','62305','97209',
                          '88385','80653','62910','68046','36283',
                          '40632','37074','46946','81454','33784',
                          '41385','11332','58132','86975','51043',
                          '38244','62033','53841','13450','60761',
                          '58857','10454','73975','62434','44877',
                          '47248','29000','59976','49683','86926',
                          '24664','12625','62084','38513','48787',
                          '22852','35568','96380','47565','19010',
                          '73412','12744','50139','17418','40052',
                          '28926','30269','28097','30527','92887',
                          '67700','94895','81057','57408','40820',
                          '58417','95350','19422','90938','49603',
                          '45704','44611','58518','43902','85546',
                          '55318','71395','82015','59682','80516',
                          '70138','12208','80344','91699','81804',
                          '47671','56597','21300','13063','24079',
                          '46823','60133','69146','49245','34927',
                          '89274','14528','29281','36421','97360',
                          '58912','92132','24370','50962')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


