
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '64439','34618','35613','77711','53075','53896',
                          '42866','40148','84471','88660','40671',
                          '10609','30025','99325','88477','41835',
                          '88946','92144','77448','20976','29247',
                          '13490','32129','92235','40239','61303',
                          '80854','65009','50926','77347','47639',
                          '56014','11713','67992','57708','95441',
                          '47277','55399','92133','62818','83160',
                          '27350','20563','21281','81352','72736',
                          '38098','51963','53178','49503','44873',
                          '78796','87396','43093','99916','58309',
                          '23377','30674','33389','66546','58024',
                          '29256','30339','58498','15153','97172',
                          '10174','18628','68589','22090','75941',
                          '45909','66196','10908','17137','91058',
                          '63221','86407','17157','37014','83585',
                          '97115','95230','13247','30378','86971',
                          '64087','66098','57297','52325','66222',
                          '18407','23735','22839','39796','81950',
                          '89718','90358','83260','78075','88473',
                          '58828','12157','71581','87160','71155',
                          '57154','74268','23897','56062','48829',
                          '27473','11301','88549','10123','17495',
                          '86329','24167','74264','13344','72922',
                          '14412','58844','45491','51788','52140',
                          '35609','28750','89966','92147','88108',
                          '96202','36951','37151','87228','83510',
                          '69307','69280','63285','68443','55382',
                          '89964','82366','80299','70442','76699',
                          '76438','72218','95170','64748','55850',
                          '86879','62156','75259','25649','66118',
                          '64753','22301','76092','94185','20532',
                          '80968','97285','70286','48154','76734',
                          '28579','44691','51604','72029','41799',
                          '60332','29901','31553','46563','59467',
                          '46641','76308','26249','48595','49412',
                          '20919','43119','91245','13910','36910',
                          '43526','49894','82890','91781','79699',
                          '24665','23124','13886','57788','58660',
                          '44074','76415','86839','10513','52498',
                          '70410','94964','69045','66480','36487',
                          '54082','29578','16737','15713','41236',
                          '81109','57066','87958','63662','24954',
                          '20762','84825','46312','65755','44158',
                          '49416','71272','89859','57780','60871',
                          '93789','86833','50870','90885','94948',
                          '73052','51271','98242','10463','40401',
                          '72089','26184','30380','68056','36410',
                          '48989','38607','68686','75396','92273',
                          '76305','84252','29328','95329','51290',
                          '70531','98159','67666','24560','95212',
                          '94551','79179','52746','84384','76368',
                          '84067','13668','62808','37448','42549',
                          '95804','31956','98124','40117','91907',
                          '30488','67812','86278','89088','93599',
                          '82586','96010','33319','76376','89188',
                          '64353','29616','66112','24739','90754',
                          '29437','99676','58104','99854','41933',
                          '49495','41018','52061','55906','84216',
                          '93156','48635','33166','75271','71684',
                          '18703','31699','39696','99904','75411',
                          '17268','77256','74065','16916','58228',
                          '76732','58539','67479','72335','42612',
                          '34266','72095','63891','74537','97834',
                          '31686','17249','13188','39814','66331',
                          '15897','64229','61483','65243','98572',
                          '92636','89113','15127','95043','82113',
                          '37933','56554','74596','81544','36969',
                          '55365','91776','42727','45435','82870',
                          '92139','38339','68537','62773','67658',
                          '93824','12105','76155','18929','66388',
                          '26797','38553','62711','49420','45339',
                          '85284','79966','63610','40748','67003',
                          '65962','54697','35131','24667','72510',
                          '38595','46347','33646','57739','31090',
                          '12483','29619','24735','67714','73087',
                          '12753','92533','93888','87657','62088',
                          '91412','65705','26636','17128','52615',
                          '59525','16281','92556','47233','17828',
                          '89350','99236','76999','12650')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


