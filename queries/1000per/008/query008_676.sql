
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '59134','44622','47475','11334','77596','29577',
                          '88717','79948','36966','82717','37858',
                          '52538','30701','95003','67794','11369',
                          '72741','42352','39593','94357','77488',
                          '52135','26068','70186','43201','54917',
                          '16261','64533','98170','38183','72085',
                          '83798','76278','86505','47365','20584',
                          '50311','16522','26013','46046','95240',
                          '62375','51868','69054','40739','62413',
                          '74702','89084','70347','54654','73155',
                          '56131','13845','53402','67537','37325',
                          '31725','44012','48768','24317','71992',
                          '43640','66560','26942','39368','13266',
                          '26223','58858','14533','92507','22080',
                          '38304','36837','80060','46429','23931',
                          '37433','74359','25394','59611','93835',
                          '26486','95803','65843','89714','80133',
                          '42230','33600','65130','19669','18672',
                          '15474','73471','42838','45137','63903',
                          '45436','81373','32696','48285','19059',
                          '89813','56034','58954','92343','93269',
                          '19306','65164','15113','27591','23599',
                          '46051','59291','29108','44001','53787',
                          '36654','92478','88221','62092','30619',
                          '43919','12762','79232','17914','21266',
                          '82210','87695','28690','45746','36357',
                          '45655','26532','57935','17264','42278',
                          '81324','33076','93602','48938','85880',
                          '93342','99326','38990','47358','36769',
                          '62546','86431','64807','40939','61521',
                          '83597','50655','40959','19688','52753',
                          '47854','23378','51950','58701','92522',
                          '38472','40323','78824','90812','89567',
                          '24401','75370','94972','90099','94248',
                          '55122','97559','37712','58990','60715',
                          '63139','22243','63574','26620','23574',
                          '53695','63746','10587','93317','35584',
                          '66178','65344','73252','83678','84374',
                          '57056','67966','62056','80422','24126',
                          '95167','29543','27716','46151','59716',
                          '96687','64948','38035','42979','74173',
                          '13151','23150','19186','47009','49489',
                          '76736','31859','85618','60182','58629',
                          '18733','58586','38336','54330','86748',
                          '85167','69117','70124','57237','67011',
                          '52971','99419','44046','42095','36059',
                          '81594','22761','78518','50803','69780',
                          '53240','39009','74714','79003','96227',
                          '57993','30217','85829','35326','95340',
                          '28215','94219','57485','84823','39247',
                          '44417','13590','84440','55491','27519',
                          '37486','39796','82599','96782','16634',
                          '82779','36721','41690','85555','67390',
                          '70933','30165','82607','51548','19658',
                          '39059','45400','16515','27374','80907',
                          '67292','80354','25658','56415','30624',
                          '64927','85171','27076','47686','31534',
                          '36195','95737','95524','84212','24886',
                          '76892','99149','67706','62485','19763',
                          '73000','26549','57892','51409','52861',
                          '19241','70147','55365','55227','26021',
                          '80200','10726','81338','78758','15287',
                          '98935','94256','70545','24095','30042',
                          '11718','99576','80982','69539','86608',
                          '21716','43602','93647','39518','15368',
                          '73881','18992','69049','96129','21687',
                          '46255','93173','31382','53936','36586',
                          '84882','74927','49329','51852','13849',
                          '71457','70385','99178','59739','31853',
                          '19024','90525','48412','33383','20616',
                          '17775','98038','77275','68711','63125',
                          '52437','90968','65226','59817','53526',
                          '47120','79712','90631','38599','36297',
                          '78284','42627','52795','42320','13100',
                          '57087','97046','11489','26365','51934',
                          '25244','64441','93675','87343','87036',
                          '68346','26059','43586','53604','42746',
                          '88966','45275','56590','52442','95666',
                          '76868','44659','35484','56470','74095',
                          '73395','66957','91762','34031')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


