
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '59785','40369','32519','89386','36723','51899',
                          '44868','48181','91836','90129','94469',
                          '84983','46784','39657','15224','50329',
                          '10327','49157','68264','45559','78433',
                          '77469','56133','79355','73155','22765',
                          '16839','47043','18952','98257','48867',
                          '34019','62269','16147','48960','69707',
                          '87766','54905','11623','33875','37620',
                          '17954','22959','57842','67270','26001',
                          '56172','81860','87998','15725','92375',
                          '68734','40258','40169','33151','76912',
                          '33408','27651','74764','58808','18460',
                          '52787','25094','67533','94605','52986',
                          '48642','64321','90997','13201','30387',
                          '64432','77041','15353','99585','83319',
                          '79229','73170','96951','75877','20890',
                          '69912','11411','69533','42938','27214',
                          '60731','25753','54671','10478','86987',
                          '50571','45393','46158','14071','15260',
                          '65889','88134','51270','20619','21915',
                          '10608','30080','55580','36378','99593',
                          '58494','27157','36421','12000','71863',
                          '46994','42387','52535','62390','54954',
                          '12660','70510','88513','69558','79639',
                          '73281','85902','64779','74364','68249',
                          '46730','27203','58837','15391','92225',
                          '62920','24549','38133','57501','27851',
                          '57211','15610','90382','90748','12855',
                          '51844','45752','41215','93739','31903',
                          '75603','33683','21419','89805','45535',
                          '58566','18134','75173','54508','51954',
                          '24691','68379','81303','42953','64167',
                          '62675','82560','90232','22828','34673',
                          '14585','20380','59892','68653','30130',
                          '32422','18813','95065','73924','81495',
                          '13204','79223','56345','92099','61519',
                          '50837','97979','92601','80036','64064',
                          '75054','24964','38745','71171','19844',
                          '34206','21552','25349','39953','46614',
                          '39074','47431','92805','39514','55413',
                          '57841','18343','87217','12044','62192',
                          '15397','16734','21985','18236','37683',
                          '54870','39212','74501','47937','21620',
                          '90057','88236','46789','85051','53401',
                          '17670','99999','96924','91634','40004',
                          '65380','12881','72392','19977','60554',
                          '17982','81354','97477','97962','57511',
                          '64084','95427','67744','29096','71194',
                          '81399','62042','91967','15388','76870',
                          '14833','80829','57950','60104','34467',
                          '73447','44439','87534','77826','55882',
                          '61741','49730','64534','95222','48371',
                          '78107','28398','89842','29332','88330',
                          '48933','72249','61769','32819','37462',
                          '44236','18692','93492','55492','21930',
                          '35680','77317','61356','94692','73567',
                          '97539','22612','31054','70760','18878',
                          '23318','12587','35071','82637','11811',
                          '69364','34776','52505','37100','34017',
                          '96187','63337','64068','74551','90247',
                          '83848','21070','19108','56646','69278',
                          '84120','24847','72247','56669','20033',
                          '99211','71851','50493','67375','67445',
                          '35863','98334','51389','67655','71897',
                          '57710','35076','41618','99805','23956',
                          '51636','24447','41185','82378','14035',
                          '90388','18342','58989','77558','41975',
                          '66249','79211','67014','44168','84740',
                          '31022','40936','66928','70439','25383',
                          '22855','44891','79837','57930','81686',
                          '40254','16062','75646','16741','67536',
                          '83087','13924','50412','28030','25514',
                          '10374','68548','17129','60531','76737',
                          '88042','55806','91458','70270','42711',
                          '45580','86982','51436','90402','85529',
                          '94217','59756','48345','79468','66264',
                          '12217','10612','93859','40866','70349',
                          '79803','63331','84830','77569','60968',
                          '45974','47048','91540','55656','64400',
                          '34596','90532','56718','70770')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


