
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '87670','96021','53142','58876','28159','29687',
                          '32613','11053','22023','60939','27946',
                          '85566','75858','43935','27370','85772',
                          '82415','96961','56675','32585','10775',
                          '37605','33701','38686','17532','89322',
                          '41909','95540','12973','88565','71731',
                          '52097','86425','51060','82361','10219',
                          '74085','58027','57844','52988','17505',
                          '50355','57168','18431','39588','66323',
                          '89677','12924','80252','74493','23167',
                          '78212','77130','21064','54328','26474',
                          '93118','70671','42766','20475','38257',
                          '21322','22111','63200','16843','67734',
                          '78704','90904','23922','47646','77118',
                          '68589','20875','22167','98733','94207',
                          '35053','33117','20280','54489','78353',
                          '56769','35768','85057','12241','28195',
                          '34715','26803','31137','97890','22466',
                          '40656','72829','17905','37174','63696',
                          '51063','80966','55524','80765','19326',
                          '43654','21039','63976','53879','37506',
                          '18997','55878','19620','31127','58090',
                          '24392','18775','13572','41173','42586',
                          '15685','55694','61457','91075','58957',
                          '74092','76872','74748','16401','91966',
                          '70664','50389','96730','97996','94748',
                          '78801','73858','91808','59890','31579',
                          '18344','63765','72760','41393','51733',
                          '88488','60383','94216','87663','30803',
                          '36307','67285','22868','75606','67070',
                          '48629','91027','92489','27846','76681',
                          '65456','64308','81612','10309','57234',
                          '23776','11622','19079','90996','54998',
                          '69734','30331','18288','51953','26558',
                          '72774','81787','29470','84685','92305',
                          '43122','16402','70937','64044','89912',
                          '51001','27235','90555','39481','55316',
                          '24756','30354','91161','15434','48093',
                          '37247','79461','51955','17861','48714',
                          '24222','75277','50251','17237','41454',
                          '14072','64094','24630','73485','41411',
                          '93037','60734','36253','90560','92406',
                          '42083','43590','93994','98353','89001',
                          '51721','85161','79258','40740','97113',
                          '37814','79516','45334','17935','44848',
                          '85211','40532','14077','76377','33776',
                          '73816','69420','52290','17051','80900',
                          '28363','35081','76649','60210','51813',
                          '28409','47552','32998','60768','51094',
                          '79338','18396','77389','59694','88248',
                          '53558','17011','79761','43817','29313',
                          '80208','43790','81094','97797','81502',
                          '96871','19993','58448','49714','85710',
                          '85979','71350','97080','11217','99967',
                          '18800','33800','86706','70256','30130',
                          '41022','24226','80169','18737','33962',
                          '38874','73895','27754','65025','18562',
                          '37343','45839','32738','33521','62222',
                          '18696','52233','43564','12810','99979',
                          '25352','33580','33879','95469','14297',
                          '16388','40832','93205','75423','14199',
                          '86849','15323','24085','50314','61407',
                          '90147','46995','91271','31946','41052',
                          '39491','48698','98472','16888','47593',
                          '21935','66243','40707','94238','64283',
                          '86227','20435','75249','31791','24628',
                          '84489','55876','67832','38458','25765',
                          '55512','45525','88550','66076','94766',
                          '12581','61624','57650','34808','64590',
                          '95428','37841','76504','12271','54843',
                          '80962','70834','20393','53601','26760',
                          '49616','24852','20866','79321','22925',
                          '71932','70978','89637','88326','75399',
                          '89781','31442','24528','37885','45618',
                          '61517','47737','44317','61281','36878',
                          '17872','26123','90601','18724','72914',
                          '53203','40647','11171','77818','88900',
                          '77048','84180','42039','70892','41674',
                          '52066','59091','32963','11896','91117',
                          '54769','18184','54781','37846')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


