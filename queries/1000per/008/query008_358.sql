
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '37681','92904','77996','82741','30490','70301',
                          '51644','43280','93497','90601','81651',
                          '36981','40126','21306','39431','98857',
                          '60959','85302','26998','75465','85611',
                          '84668','25267','48885','42460','69852',
                          '77040','70074','74947','73503','55024',
                          '84651','78500','47181','58998','96791',
                          '44291','32277','50151','37051','19711',
                          '45193','43917','95298','86567','18850',
                          '72206','33723','27106','62701','32896',
                          '25287','86873','59181','87325','22301',
                          '31179','98788','65736','69570','20397',
                          '29073','89869','11641','74424','11477',
                          '79483','87172','43100','67137','57246',
                          '35181','13587','55645','25729','63045',
                          '74370','30806','45017','87908','12326',
                          '38825','49384','89593','33476','81843',
                          '94315','68263','47906','58026','99928',
                          '35979','93325','27126','47572','15136',
                          '48838','35346','53589','96952','60236',
                          '42701','38284','61300','76619','83787',
                          '54272','10510','86131','70897','11232',
                          '11163','94190','18172','69189','10105',
                          '56712','98319','64040','67552','12633',
                          '55351','29338','78787','21896','16360',
                          '89073','16122','11080','12505','23590',
                          '79360','65150','98125','12666','79385',
                          '17343','68061','89954','26205','15036',
                          '18114','70575','48401','98535','49347',
                          '99508','99953','23101','67420','95748',
                          '25804','75799','96688','60061','48855',
                          '54197','97340','19629','74510','94623',
                          '48691','24499','72846','65931','83840',
                          '58739','45466','24752','34461','34478',
                          '61637','39199','98150','40615','10045',
                          '26118','22819','99237','83907','69541',
                          '87357','84339','41681','22392','51652',
                          '61194','10581','39297','52615','60857',
                          '85820','64758','64780','26080','18892',
                          '91372','39286','58219','75646','99804',
                          '29612','16950','19219','82001','47590',
                          '73924','67418','45030','16288','93327',
                          '54422','57917','32319','36995','90124',
                          '22853','27672','63943','23391','48027',
                          '97858','28566','29525','24478','26210',
                          '60131','27590','75815','23637','78028',
                          '29115','74432','25299','69254','26192',
                          '16840','57164','75545','20708','88021',
                          '21768','94114','25653','27347','34320',
                          '20636','88955','23294','28673','94180',
                          '17673','52256','71460','94824','40033',
                          '14931','50375','37306','68772','51123',
                          '78561','54485','71752','73338','84206',
                          '85266','16725','58932','45909','41165',
                          '66671','48738','64065','71556','59474',
                          '46679','98765','77695','19739','30328',
                          '71091','34663','76611','77583','94194',
                          '53180','46251','57209','62107','28944',
                          '26303','60953','90460','73050','69328',
                          '34339','60371','43596','76283','46639',
                          '35370','64344','58726','30522','33830',
                          '75395','90857','17737','97556','60832',
                          '84575','64508','34774','46214','38283',
                          '27256','16207','81085','57864','70935',
                          '12799','74864','33109','19569','96028',
                          '47263','58955','57433','66810','36631',
                          '98828','46563','87101','58237','90265',
                          '54205','27183','83740','14470','46510',
                          '42723','60444','28664','86023','52695',
                          '51748','21177','58017','48966','97714',
                          '74374','90105','77391','76857','21313',
                          '56440','58650','14056','52070','80985',
                          '12217','77290','24473','43169','76077',
                          '92446','18779','80756','94619','26280',
                          '42606','23941','45050','80741','11581',
                          '98059','83063','29330','93548','82949',
                          '20451','57384','71184','10471','50804',
                          '56159','78823','37130','15978','15620',
                          '57525','57703','65494','43385','66695',
                          '38156','26124','29762','67247')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


