
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '88267','34204','76173','21541','18991','44262',
                          '73830','34501','46981','89335','27044',
                          '90475','89494','68982','32033','51871',
                          '53691','14475','49031','33337','27183',
                          '20875','37012','64774','64619','66850',
                          '90503','30150','71733','25477','84097',
                          '83766','38489','29711','98083','49251',
                          '28147','34663','10626','55399','60010',
                          '72712','99773','54256','90358','71448',
                          '20095','56399','70276','48313','15408',
                          '15867','61274','79069','52657','71174',
                          '14951','89058','73595','28894','48061',
                          '57942','79384','78600','45647','61493',
                          '63982','43085','52582','15679','66100',
                          '70393','92078','67216','19697','58307',
                          '37673','32923','65291','48160','51301',
                          '39896','58453','59108','77019','96303',
                          '62974','25284','83181','68083','85676',
                          '18324','86871','68638','26774','97000',
                          '35156','80805','62973','97107','51089',
                          '58271','30952','42046','87484','98572',
                          '66898','55658','18076','21133','23817',
                          '50941','30790','72327','42640','70383',
                          '25274','99016','79230','52538','13960',
                          '87069','12725','91185','44163','34285',
                          '83046','22325','46940','58093','45284',
                          '14703','53012','62357','92500','63135',
                          '60419','98576','34755','85043','27052',
                          '42480','36659','48274','10006','33386',
                          '93396','55891','51579','52359','76634',
                          '67419','92084','61902','80400','64048',
                          '97877','35202','80729','75928','91672',
                          '64026','16163','26420','91067','59172',
                          '36031','56085','12500','55314','98966',
                          '51494','56680','44032','77359','87223',
                          '90661','58184','65696','58308','16172',
                          '97598','52393','20864','24014','78654',
                          '68202','57141','11923','33469','86337',
                          '25874','32133','16299','18500','39267',
                          '23139','40122','52062','72390','10058',
                          '68020','15359','96980','51847','63629',
                          '92729','49316','56934','54888','73947',
                          '62657','81562','72107','22211','75979',
                          '74220','48646','86068','15415','78299',
                          '36655','13124','90305','48679','60165',
                          '37380','45315','58740','35805','79688',
                          '70258','40209','99534','58419','92024',
                          '40281','13153','40502','35482','22536',
                          '58920','81877','99532','20425','65059',
                          '74144','53222','59239','86242','72949',
                          '86093','16866','19799','45420','49636',
                          '48922','25523','90029','75425','94411',
                          '60127','12436','81695','53414','66117',
                          '80237','35870','37261','34954','70168',
                          '26980','84812','61070','54431','19040',
                          '28390','48147','20911','52750','65006',
                          '38359','18357','58466','99738','87441',
                          '55836','44226','96453','78622','28967',
                          '42985','50383','63056','10322','87321',
                          '94131','36294','61100','99146','51892',
                          '48381','90133','34473','72075','65156',
                          '63198','74413','81656','44840','90923',
                          '45939','97664','12156','21058','76618',
                          '89546','90243','88722','64383','20659',
                          '95135','37369','47488','84339','50482',
                          '12573','13500','73365','36924','79725',
                          '29727','20340','77262','56407','18479',
                          '43778','41737','44779','68651','85519',
                          '72990','74013','84642','64969','53204',
                          '66302','94963','45156','81995','28819',
                          '91363','87051','62675','57910','22272',
                          '91762','83326','79982','15254','15598',
                          '70456','43275','82721','41289','22299',
                          '11917','74328','90452','64330','33695',
                          '18100','25691','77128','25840','78671',
                          '44465','12627','85029','66457','18758',
                          '45980','14687','10554','66570','28268',
                          '58991','66029','90219','79394','45504',
                          '41844','28405','94862','34706','13570',
                          '88536','94437','74560','47798')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


