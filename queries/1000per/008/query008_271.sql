
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '28449','60049','81761','66829','29798','49364',
                          '63358','76964','48759','86400','62459',
                          '36869','69397','85743','12699','77457',
                          '73791','39514','55323','42471','88194',
                          '11702','56913','44023','98916','65737',
                          '67909','51503','40699','98113','68499',
                          '58721','74319','29795','92250','98589',
                          '53674','26002','85468','78071','81738',
                          '70460','49736','29033','13955','58529',
                          '88676','92009','85971','70469','78159',
                          '49228','49492','23254','39765','35485',
                          '57117','60577','81698','44258','22514',
                          '27670','90219','78697','42627','47895',
                          '37186','49679','51700','28793','97935',
                          '65568','99835','27317','63563','17200',
                          '41150','64630','17495','21305','54969',
                          '61435','56682','74138','81289','61785',
                          '37512','92951','55745','24821','70548',
                          '15592','83930','39361','35656','62049',
                          '86638','90642','68772','14973','14180',
                          '72881','84445','60246','51516','45183',
                          '99216','22061','88223','21483','16005',
                          '90273','61869','41575','28824','85337',
                          '54220','64872','22230','91185','36052',
                          '20902','68571','76972','96875','80107',
                          '56355','17704','86145','71931','82416',
                          '61179','18937','12675','94376','99679',
                          '45176','31591','32792','68497','12437',
                          '48561','97834','34882','78401','52234',
                          '35976','83415','17326','20472','82210',
                          '44571','54842','71975','58802','32680',
                          '58380','39795','94758','73289','48012',
                          '11995','68964','20586','79378','72962',
                          '71158','34741','45571','74118','96452',
                          '25149','48655','17130','15866','38995',
                          '57794','65058','20986','18738','93354',
                          '77827','36883','43500','84634','78329',
                          '65474','46579','77766','15040','53282',
                          '38386','39854','65864','34261','97426',
                          '85130','53791','88826','52523','85792',
                          '30519','14307','89392','47912','39232',
                          '12799','56621','26886','91184','91924',
                          '90518','86090','99815','73441','38205',
                          '88524','10469','51805','44442','51532',
                          '22135','80078','86984','76437','75715',
                          '36390','52287','93125','59212','29948',
                          '70504','52220','87289','77522','13075',
                          '98853','74909','32022','58070','71758',
                          '79292','25772','90205','86718','95102',
                          '62144','76130','69182','52199','64610',
                          '95530','33574','57016','89567','48121',
                          '33625','95653','17386','58191','84876',
                          '85026','42979','56719','28311','82534',
                          '54980','21482','53782','19116','55821',
                          '83459','75649','36962','22582','46740',
                          '62919','10209','91361','42912','35180',
                          '88966','52799','34806','48233','38061',
                          '65077','98116','41514','91532','68389',
                          '61093','95339','76987','12973','95526',
                          '74589','59808','95667','82615','98238',
                          '91575','68690','96234','51799','64469',
                          '64548','16673','91821','36887','78692',
                          '53983','52655','30087','13491','81816',
                          '12140','36075','73192','36513','69217',
                          '22303','95033','77550','70940','20711',
                          '66480','63127','33110','68243','68566',
                          '71371','59251','48947','94110','40142',
                          '15958','74945','55729','63632','14062',
                          '58140','19114','80232','92647','24564',
                          '31685','39638','75479','90907','60926',
                          '36485','38643','88167','53881','58081',
                          '59856','65203','59512','72146','82088',
                          '61724','44000','33941','54143','65388',
                          '18037','83768','25453','37753','19100',
                          '93763','34934','35179','72424','58284',
                          '54657','54279','64807','16021','74867',
                          '64565','65234','98452','42335','78212',
                          '15514','51989','98775','53303','44851',
                          '21720','79047','58798','29202','30579',
                          '74399','61704','27593','92872')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


