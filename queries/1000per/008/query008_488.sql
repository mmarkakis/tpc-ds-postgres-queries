
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '32636','10853','24121','19501','85913','25143',
                          '32684','11198','62090','80839','89314',
                          '48032','31663','92863','61098','46900',
                          '71304','95861','90510','91842','22976',
                          '80621','76078','53564','54987','41153',
                          '51908','93177','36558','72098','97919',
                          '34522','20029','70381','31127','99982',
                          '62363','76540','93139','32672','13921',
                          '77579','32575','87652','81462','60375',
                          '84814','28039','33205','73329','87517',
                          '57830','21135','56348','69792','45369',
                          '87120','94788','24133','21670','73546',
                          '45850','49354','37511','45406','39933',
                          '60023','23327','75555','90998','39990',
                          '46722','98098','34558','79546','23623',
                          '19807','48760','25672','48582','25219',
                          '95761','85500','63503','29232','91004',
                          '37537','41330','93567','25598','93330',
                          '20556','73445','14956','60383','45019',
                          '60648','20038','71050','81928','33442',
                          '62450','88385','81177','81262','24102',
                          '62192','84346','25730','74315','38621',
                          '33363','16748','61120','36556','70882',
                          '56730','82024','85626','91874','40817',
                          '29120','61890','21452','68892','84625',
                          '26702','89603','58841','24581','90072',
                          '26991','54821','53109','75580','72566',
                          '83907','94786','73000','56602','48724',
                          '98224','65606','20508','50065','61881',
                          '98315','59142','26294','34113','25607',
                          '26043','80440','62012','24425','80746',
                          '60954','80177','14547','90213','26581',
                          '81744','33891','36270','43107','82128',
                          '94899','83906','86697','97315','97161',
                          '45013','86310','15234','84707','23734',
                          '38745','71865','82375','32457','29643',
                          '59373','81021','72176','99403','14015',
                          '35129','65456','67767','65063','82446',
                          '43375','68382','12857','82850','88765',
                          '25465','13785','49249','70489','81158',
                          '48948','55283','58973','71474','10687',
                          '19348','33165','20051','78397','46553',
                          '71379','48543','51906','95336','14638',
                          '97191','18573','93479','35861','28160',
                          '36118','85321','88789','19725','85078',
                          '40588','80444','21053','36793','83857',
                          '21106','47851','81628','88621','26987',
                          '71051','15309','79654','37673','43774',
                          '87595','23917','79759','15582','38545',
                          '34417','35931','99281','80475','18873',
                          '57748','65012','29472','63369','69259',
                          '22711','24042','72681','59801','86391',
                          '43664','28024','46841','23538','22302',
                          '10202','52053','81480','52980','23127',
                          '40580','55259','81681','87443','20718',
                          '78057','58276','13409','33602','29113',
                          '78402','39264','62520','93774','75653',
                          '79008','55813','92600','65954','58438',
                          '23853','90889','23238','64024','20012',
                          '96721','74482','22295','81666','88476',
                          '77793','51358','34661','42164','46828',
                          '25608','75646','96699','60956','78416',
                          '19097','38715','97439','64809','18324',
                          '34725','99140','58204','53718','51990',
                          '62907','84680','87501','31847','23051',
                          '43596','36493','93045','85088','60182',
                          '63950','46252','91416','20014','79110',
                          '56134','88960','61660','81403','51959',
                          '64189','27401','95097','57758','94440',
                          '87485','19516','71095','99029','38515',
                          '30915','51691','53092','97163','86910',
                          '65517','24465','66020','20489','59779',
                          '84853','12954','40099','90053','84042',
                          '89153','47295','82332','30242','37298',
                          '30845','25453','87560','62994','23521',
                          '17493','17917','55620','77633','13267',
                          '66162','98133','25625','46936','37553',
                          '85751','21196','40945','64227','68939',
                          '26679','63575','62655','16667','18431',
                          '32064','65518','90894','91774')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


