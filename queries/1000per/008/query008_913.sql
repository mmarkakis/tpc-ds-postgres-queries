
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '69847','32651','41052','26173','16869','41889',
                          '82724','52847','80636','23840','45522',
                          '13094','43439','79131','50591','81905',
                          '54619','28771','86676','78513','38606',
                          '89023','56275','68151','84482','92423',
                          '54058','90724','86080','79073','93134',
                          '59442','27134','92743','44921','72484',
                          '21006','65268','23871','61909','55910',
                          '69161','52649','26338','27597','67872',
                          '41389','72454','44743','95379','57368',
                          '76877','93624','81900','77618','29245',
                          '17612','29494','52207','39840','31609',
                          '61489','34626','85433','64267','61299',
                          '52869','55915','12956','50194','58250',
                          '87891','58543','46738','62229','10527',
                          '99014','71253','50350','93493','14916',
                          '29892','67852','99836','20708','31378',
                          '61385','29636','30251','60295','21136',
                          '93495','80015','87140','60987','61540',
                          '54865','36647','86565','21071','30798',
                          '50922','54618','21832','17377','29634',
                          '79973','60393','13195','98749','12383',
                          '91539','87718','79175','53494','21978',
                          '33093','94966','25266','63426','66234',
                          '86583','50917','85131','50983','35306',
                          '11328','20228','64184','95325','17421',
                          '88471','18211','54895','78660','96374',
                          '80560','57454','54731','83910','22634',
                          '80585','16227','92138','60978','27055',
                          '26907','41339','19709','72595','14078',
                          '20796','59086','28247','59524','64900',
                          '12753','65808','76792','36867','26835',
                          '98257','97783','61832','40145','23654',
                          '44139','36824','93821','67241','59206',
                          '38849','62492','73506','74728','84606',
                          '63919','49318','32058','34067','72719',
                          '97333','55446','75994','37172','29609',
                          '33403','70165','23360','19394','23296',
                          '86571','53024','72761','72920','27566',
                          '48794','90127','69466','21150','63941',
                          '44099','58939','22411','10016','85137',
                          '27716','99885','44497','38678','77886',
                          '60302','17855','80369','94108','94898',
                          '41974','33846','56483','80121','90983',
                          '11814','93385','82005','56309','92072',
                          '74606','23619','85584','71797','55450',
                          '12466','33829','47034','41482','78197',
                          '58539','50092','78969','56195','45604',
                          '94783','86358','44368','86338','70218',
                          '13310','35382','83505','73174','97144',
                          '61337','46986','63705','64090','21684',
                          '64769','41829','31472','86682','42151',
                          '80808','94927','72768','82196','26137',
                          '63535','52132','68200','86757','64939',
                          '30436','93265','34263','72383','50669',
                          '77349','23416','60649','62868','99713',
                          '70919','23713','83205','63923','63589',
                          '70312','46037','97152','11365','91748',
                          '71827','50048','57935','72524','41458',
                          '33261','13462','89722','44118','65459',
                          '65003','53720','20855','41211','24305',
                          '11071','72522','68591','54750','96179',
                          '72812','84975','81553','11866','41310',
                          '32976','89310','22953','43054','57694',
                          '82392','24132','58382','67375','91663',
                          '15488','99976','18875','29381','40947',
                          '94467','27158','45785','71043','70778',
                          '31943','30517','31299','62348','76327',
                          '38698','23630','25819','56722','14752',
                          '18006','25843','89488','91293','43910',
                          '67882','18843','63236','19485','11299',
                          '61840','46104','90800','98313','82657',
                          '58088','11884','16856','37000','86577',
                          '66360','50851','37855','47558','66981',
                          '42251','38638','78485','34372','13061',
                          '52278','62979','34603','42479','52844',
                          '66534','70066','69943','29110','34648',
                          '34943','48248','24881','23977','94537',
                          '37060','39964','37179','63054','93372',
                          '82886','49960','87626','36557')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


