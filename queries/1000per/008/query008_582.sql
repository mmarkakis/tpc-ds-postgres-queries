
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '44654','11489','94523','96067','55051','84630',
                          '84619','67699','66354','80509','87996',
                          '45710','84638','56325','30975','49538',
                          '63426','80518','29772','48130','53121',
                          '38187','26114','95941','74781','66076',
                          '25798','85255','42132','64993','85094',
                          '25051','71938','72672','59515','87110',
                          '24326','95395','68976','25231','11854',
                          '22017','40721','45709','30476','37767',
                          '76373','36723','92230','54601','96409',
                          '12103','26239','85686','58322','17662',
                          '70506','90255','86580','89631','80814',
                          '50457','97272','87500','26680','36742',
                          '73062','69281','96073','98307','99342',
                          '56796','47403','30527','93884','88172',
                          '87256','84418','44601','50671','82680',
                          '23453','41080','79800','48867','25551',
                          '85182','18736','56866','85134','73239',
                          '62064','97069','68527','12086','68722',
                          '90627','36900','87233','59299','67570',
                          '30316','61350','34715','97685','16850',
                          '13008','90659','75733','58390','74324',
                          '46126','93312','82794','45362','95249',
                          '25235','60134','18959','24674','18442',
                          '14975','11940','91353','74652','10437',
                          '28201','48483','23185','30822','81520',
                          '17249','22738','64279','77231','91254',
                          '54604','69782','45949','80232','89157',
                          '76632','90789','41546','99972','26292',
                          '22174','93190','93458','34747','28442',
                          '78716','84964','98427','26391','87791',
                          '99602','16339','86359','53729','65135',
                          '48316','24321','94764','61470','80343',
                          '86680','12660','42232','90512','35376',
                          '96662','52937','96282','56157','10912',
                          '67047','55791','93679','46105','17909',
                          '60969','69289','58072','32950','64501',
                          '72269','29261','83935','29506','68787',
                          '85448','80760','30636','16843','96630',
                          '83647','70081','93200','14189','26185',
                          '39742','96692','96992','48233','66793',
                          '88009','61548','93417','10842','49385',
                          '86085','30963','61058','46522','55758',
                          '89840','42810','20349','65581','89412',
                          '25776','60619','48786','87957','35194',
                          '98968','99316','73910','51975','94748',
                          '30080','68734','82348','90953','60723',
                          '99784','16777','37537','63911','17085',
                          '37896','65230','52756','99568','93327',
                          '28706','83759','40841','32387','56309',
                          '34300','69879','77079','92418','67970',
                          '32333','92219','93062','91268','60191',
                          '81177','36428','19781','56086','60984',
                          '95492','25018','48586','14446','13213',
                          '50275','82183','68320','90890','21587',
                          '86234','79144','67069','18768','43512',
                          '69511','58870','46726','72519','32276',
                          '11771','25264','78870','74598','60192',
                          '13561','16446','29125','80935','77739',
                          '31182','10230','66898','73211','82594',
                          '29520','22419','44849','70010','66266',
                          '71669','11951','37358','95704','67008',
                          '29452','24894','97112','12403','27091',
                          '58139','14348','33219','84115','94044',
                          '72642','51191','41337','25584','74204',
                          '39202','56842','21662','12590','64922',
                          '33060','31010','45651','30676','85363',
                          '84594','27334','37980','89550','76700',
                          '92309','38032','30910','44159','97945',
                          '55032','96503','73788','41745','67346',
                          '98368','76423','41640','47180','70703',
                          '36632','37947','33823','30551','94356',
                          '10319','29200','97354','44508','94939',
                          '50435','62362','55081','59652','66918',
                          '12845','77275','46230','30221','92510',
                          '65125','96564','88548','11932','34462',
                          '15592','87094','10097','97510','12316',
                          '88510','34610','90706','57831','11978',
                          '14555','44171','74864','54293','72180',
                          '12808','27372','65223','82445')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


