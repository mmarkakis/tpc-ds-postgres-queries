
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '79142','46986','69736','88177','99567','65434',
                          '37956','47943','32882','71377','24061',
                          '49515','11464','17297','88809','59915',
                          '98350','34779','73780','36433','32631',
                          '70912','90774','68726','27906','45510',
                          '73482','55967','65012','66530','53565',
                          '50019','28272','29392','10824','84172',
                          '74203','58975','45797','40606','87785',
                          '88133','52076','13842','26685','67915',
                          '25632','82865','58591','69055','21479',
                          '52493','24000','33151','88912','39685',
                          '26708','88579','28493','44497','62243',
                          '74076','59098','77597','90531','69242',
                          '41186','75515','60039','34819','66783',
                          '57091','32721','82924','16058','90085',
                          '93444','79882','24839','52749','23296',
                          '24727','85684','98179','34150','98581',
                          '27632','26320','19160','70503','94880',
                          '94535','38184','63805','62672','19433',
                          '77110','76871','47847','98071','83236',
                          '25436','28157','15631','32420','46343',
                          '51846','77345','23472','82705','74832',
                          '71652','75688','57750','34754','25212',
                          '47705','16470','20639','94137','78404',
                          '48176','37573','41597','60364','44896',
                          '35731','18771','58739','64951','68732',
                          '12518','48004','91580','72677','54297',
                          '71068','31037','62191','60478','47187',
                          '44288','77168','31980','10687','91966',
                          '45039','85704','52811','14960','37586',
                          '51251','72404','57898','13044','64942',
                          '26469','47985','44561','59150','56025',
                          '78476','97083','81395','15949','34172',
                          '84643','59064','39571','65786','93464',
                          '55378','14141','73440','97422','71870',
                          '71115','91507','35840','91616','65568',
                          '64635','92369','96599','80710','41743',
                          '36646','36566','72559','54952','84965',
                          '99075','79031','38990','62477','48791',
                          '45029','10485','41629','52713','69557',
                          '26134','11062','36080','97633','55983',
                          '59065','68486','24838','41531','58397',
                          '36990','96470','58358','62789','29409',
                          '19701','31473','10402','70153','97653',
                          '85526','89637','72875','92869','35111',
                          '47541','98725','61984','84251','47795',
                          '66344','65279','75012','80122','86907',
                          '95425','20947','96409','85785','64331',
                          '10258','77304','36381','12779','21992',
                          '68466','46181','53369','71727','78085',
                          '39427','44876','45367','71042','10546',
                          '43919','87950','32253','27482','11975',
                          '16531','91150','68815','24205','37107',
                          '25196','79072','33414','82900','84684',
                          '58649','70702','38428','88839','30378',
                          '62001','65268','15160','68624','65931',
                          '20325','50057','63344','81109','93297',
                          '82366','44174','78259','68381','28975',
                          '24142','28054','19888','56886','97128',
                          '97845','81525','94623','51612','38073',
                          '16982','87866','81955','77261','71079',
                          '57267','74731','90473','45186','96926',
                          '71671','91166','68831','93635','53487',
                          '64283','62875','82476','10877','76808',
                          '10516','76822','78269','96369','58500',
                          '88359','68217','62886','20041','35275',
                          '31732','82631','55309','59493','58343',
                          '63254','19262','90664','89484','68272',
                          '32278','33368','56688','60569','50602',
                          '53916','50701','48031','58188','34039',
                          '80972','73979','95401','18728','35510',
                          '24708','13681','77026','35742','39710',
                          '62105','27284','70997','10093','75825',
                          '92900','31638','16544','56221','74009',
                          '63491','68721','37111','37623','39809',
                          '58071','46375','52412','21745','47610',
                          '48110','43017','30773','84153','20877',
                          '24886','20847','17666','89416','66047',
                          '84860','92816','92775','77095','88319',
                          '22186','94636','37902','11900')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


