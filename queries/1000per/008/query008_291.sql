
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '35218','15863','55906','93185','16213','38656',
                          '33529','30667','84450','69633','12920',
                          '24717','62406','52989','13059','37430',
                          '82421','80524','61756','40011','15165',
                          '32586','54919','43539','74437','20287',
                          '32199','33349','68591','59677','91689',
                          '98751','44486','46597','17751','92070',
                          '66101','94703','70996','97526','23014',
                          '58493','85174','82648','42500','21622',
                          '61228','46102','44203','31182','45185',
                          '95104','16634','39681','78555','48993',
                          '88398','97893','59953','42636','94082',
                          '70048','67650','61018','74023','44148',
                          '32045','26773','89539','23495','56736',
                          '27576','26464','47305','62088','59893',
                          '52658','95853','77556','77937','78115',
                          '83765','52590','95450','91467','66525',
                          '51727','95623','52474','11648','51628',
                          '28560','95075','74491','34350','67662',
                          '87308','69829','92849','14819','31759',
                          '58252','10010','80281','67324','75252',
                          '96336','12230','70705','33347','20027',
                          '39345','99039','67420','31902','94455',
                          '32432','64937','86060','20874','19466',
                          '71556','24363','87654','31301','90451',
                          '88802','18357','31820','85575','74689',
                          '17470','55557','82474','47302','53622',
                          '65418','73116','76962','71579','36853',
                          '26592','64151','50940','19861','52156',
                          '29666','30001','85774','26108','50239',
                          '42253','11570','44361','35732','86817',
                          '63499','21964','43884','28452','76237',
                          '33740','41805','91050','26870','15320',
                          '75258','15955','49237','31666','98354',
                          '32168','15993','80789','57385','76936',
                          '94487','17345','67903','97912','91419',
                          '71298','71092','37328','61106','68490',
                          '97733','54763','44966','93081','67010',
                          '50102','86509','76908','98986','97376',
                          '41422','71140','67756','62911','37021',
                          '65187','55048','83728','24020','16484',
                          '88483','90374','57400','38054','41080',
                          '85816','79661','95238','98224','36527',
                          '28432','12532','37780','59150','91291',
                          '80495','13003','11276','16818','77982',
                          '70458','86973','21518','56032','37599',
                          '75326','66008','41022','47707','26143',
                          '68856','76897','41591','29531','69457',
                          '11027','37910','59972','98741','96093',
                          '32626','57703','43514','33077','19944',
                          '40104','80596','43945','98437','70443',
                          '16192','68682','60974','80389','58789',
                          '73771','43683','50793','43814','74865',
                          '36403','60085','57345','51561','62690',
                          '48045','62618','10429','44282','36807',
                          '62464','24268','91949','92718','75961',
                          '28715','77856','76540','82477','63269',
                          '59089','92538','89079','28398','47640',
                          '17713','56197','58391','65121','97959',
                          '44112','99748','61313','91557','70965',
                          '36901','31604','37492','85202','90363',
                          '58816','56467','54471','55550','42504',
                          '54508','81644','34391','83932','93962',
                          '53192','64676','99458','54160','86793',
                          '59892','94575','76210','97800','37753',
                          '21137','36985','23420','41972','79709',
                          '93157','33401','74267','45860','51251',
                          '59542','25070','16654','98215','77354',
                          '53971','52081','26954','29191','96810',
                          '96531','88584','96946','90485','68489',
                          '61488','85641','80559','60804','32074',
                          '88478','59121','24193','13697','60246',
                          '20826','88321','83524','54122','85395',
                          '56048','49209','95218','41106','29122',
                          '15841','59606','50045','75046','26680',
                          '82691','60837','41323','22596','18241',
                          '49940','38476','65401','33511','54952',
                          '42147','76169','54221','41310','83496',
                          '67555','65687','54491','72576','14673',
                          '65810','27031','93965','59602')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


