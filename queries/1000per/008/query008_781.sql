
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '75287','80619','40152','64591','17149','17740',
                          '88928','28972','88166','38088','49294',
                          '54656','31776','50895','49615','14007',
                          '73431','64174','86773','83525','63672',
                          '40603','70923','95070','85015','82783',
                          '59025','49326','32300','15599','37371',
                          '27782','40009','45793','81524','15703',
                          '10065','32270','31183','45581','36597',
                          '22303','33978','53944','87152','30825',
                          '77605','71397','63171','98057','68319',
                          '55130','32695','38726','41007','93660',
                          '40840','88554','62639','33240','43599',
                          '84726','75953','46600','53899','42715',
                          '72998','97566','23163','60164','49364',
                          '79485','99040','70030','42547','94529',
                          '29469','30935','62891','38266','93150',
                          '71787','11465','81143','10648','20301',
                          '53893','50617','41664','91325','25779',
                          '57390','68969','82806','45405','11318',
                          '51909','21440','89771','98734','74975',
                          '12944','86118','96754','82285','19670',
                          '47781','20915','24501','74003','44761',
                          '53018','40687','29077','82507','62761',
                          '48348','23020','82105','82438','27889',
                          '44442','17791','99406','43557','70754',
                          '76214','60300','98185','26523','18841',
                          '87054','67153','15654','94457','29559',
                          '57297','96025','59858','83111','24601',
                          '23074','43722','81799','53913','25045',
                          '91208','54793','93902','23868','15184',
                          '20767','32494','18455','77624','53947',
                          '68352','61406','50655','53516','79559',
                          '32480','17236','66039','12333','25968',
                          '66206','25211','16952','45385','50768',
                          '99376','24981','17543','26356','48410',
                          '21797','18257','13221','63158','65167',
                          '83372','24739','47293','55011','32619',
                          '24127','23836','23378','52752','41845',
                          '52103','78867','43718','97427','37955',
                          '52762','74096','64608','15588','56811',
                          '31418','70460','98704','46033','85339',
                          '45827','73300','22610','84381','30784',
                          '18785','17111','20750','60946','58998',
                          '75699','76757','17819','90359','35171',
                          '59248','52564','23204','24881','39461',
                          '79303','58996','47493','56896','96045',
                          '56986','83786','11234','26520','19544',
                          '26324','84151','80790','15637','51868',
                          '74703','94177','68419','16063','41277',
                          '63909','56210','25369','78568','45213',
                          '28284','28111','81605','41106','29641',
                          '45419','55523','67076','45337','24909',
                          '81815','45314','52800','86568','37781',
                          '65963','53414','62806','78557','45439',
                          '89316','99845','95287','72282','42841',
                          '46847','63058','82866','88721','98444',
                          '65703','55567','56059','74411','43239',
                          '40457','41156','71140','19506','71582',
                          '99434','17107','63005','65831','12762',
                          '83268','52182','60713','78456','35153',
                          '19777','41308','32643','17807','72243',
                          '12040','14382','36159','99486','43217',
                          '62877','22375','25866','20875','60944',
                          '65947','38589','47713','47773','19297',
                          '36548','99533','77725','43857','37184',
                          '54529','79426','47776','12672','27074',
                          '77613','36350','41617','27986','45674',
                          '31361','10927','10193','64953','69138',
                          '62897','10022','47396','94764','11988',
                          '92633','36901','75337','71710','34601',
                          '18733','69949','22088','10113','50110',
                          '18245','72041','61374','78334','15887',
                          '71984','77862','94078','19657','13600',
                          '82240','51069','31470','57122','15477',
                          '10423','44394','58533','85334','34715',
                          '66235','14440','87347','25397','77143',
                          '51215','56421','63754','30618','50427',
                          '95638','21983','76317','65767','93562',
                          '49935','21301','74637','97984','27198',
                          '74898','54065','95467','32170')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


