
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '97739','71038','17772','51825','82400','94255',
                          '50885','20380','31152','32937','19945',
                          '97384','19656','37855','35616','32113',
                          '13906','97361','13167','90296','85996',
                          '78847','74077','14334','74707','34467',
                          '48804','51500','16667','57987','14241',
                          '10043','54498','91845','77350','12947',
                          '92324','19454','55672','86466','94663',
                          '18224','83457','87438','80036','76158',
                          '66175','64981','72247','32863','57365',
                          '42896','26242','51367','20260','66341',
                          '36284','82310','71867','99809','31596',
                          '12451','20556','37120','98929','17368',
                          '31093','61714','82575','26749','76905',
                          '74548','38021','13284','88681','29892',
                          '86159','88113','43121','31982','50760',
                          '64091','84320','43593','78995','80514',
                          '46484','53087','40325','16677','64717',
                          '97952','58484','96041','82954','21634',
                          '30320','59955','73110','75476','99109',
                          '49029','36351','66222','24476','90543',
                          '31095','56450','51202','41371','33560',
                          '23981','67301','51672','27016','36958',
                          '41029','14988','66196','43156','77267',
                          '55880','53140','52624','78982','56635',
                          '13387','58261','49758','49646','13789',
                          '54567','31718','33076','38954','13131',
                          '98103','73897','69083','99735','95383',
                          '71276','90733','92364','54803','77158',
                          '99752','43755','96200','15556','39994',
                          '46368','47253','23025','48342','55204',
                          '48849','11576','83067','28439','72149',
                          '22100','82531','55000','54059','62846',
                          '14956','24189','28226','55018','99734',
                          '96074','59626','87372','61193','67559',
                          '21046','46289','55814','45115','21820',
                          '91777','94662','28410','96538','76393',
                          '16559','55379','26605','21200','16966',
                          '30927','10005','33574','88331','98363',
                          '45652','25544','52425','60233','37755',
                          '12137','59676','31520','60125','53545',
                          '72317','97849','49429','58424','97654',
                          '46663','26469','75340','78726','37676',
                          '89692','31711','80141','17799','15414',
                          '78283','39243','28190','65043','30819',
                          '39658','14787','22057','18316','12707',
                          '75652','81258','87264','86391','27585',
                          '48579','49529','76388','18008','98861',
                          '99923','55925','15065','63301','18318',
                          '78698','11575','90501','83765','98160',
                          '51327','59291','15247','56131','50564',
                          '46665','61350','76561','90715','72431',
                          '70930','80405','98707','15082','67595',
                          '80622','79797','90595','45215','41163',
                          '31653','47684','66033','76907','95977',
                          '46694','77012','86950','24796','20938',
                          '17034','74485','33246','18920','10074',
                          '26007','71455','33009','76918','57400',
                          '39006','82891','88077','48248','78923',
                          '80759','41970','59321','41716','67501',
                          '59510','85488','32974','45859','34858',
                          '89448','94528','74291','37656','46444',
                          '87673','63701','67763','97874','94196',
                          '66590','30669','37410','59575','44149',
                          '28841','94559','57733','39251','87355',
                          '51701','90980','43590','12389','94437',
                          '78984','57302','80151','35807','43415',
                          '32585','56699','99190','46157','49683',
                          '98553','13216','36763','82426','81270',
                          '28478','90225','40443','10730','78671',
                          '73799','94996','69539','73377','91299',
                          '20234','85605','23487','61194','63687',
                          '43918','92926','39810','55617','45410',
                          '82203','99917','36379','82679','47927',
                          '76237','54711','75278','98863','15549',
                          '76492','81763','10716','62319','20698',
                          '86013','11482','14457','48990','35248',
                          '22285','46419','28644','23537','68826',
                          '33266','38361','40163','86962','44010',
                          '87243','90998','84977','13403')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


