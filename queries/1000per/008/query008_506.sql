
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '25351','49938','89218','84062','35837','31613',
                          '64713','71703','27927','87558','10356',
                          '65274','28096','86529','22681','88083',
                          '62113','42985','97789','44967','20967',
                          '62488','38005','24986','50008','67896',
                          '92766','83885','98521','45264','86713',
                          '65999','34102','16266','17168','63829',
                          '18179','29938','71542','84072','96616',
                          '32817','65166','22765','95819','90321',
                          '41117','28504','39540','29374','79191',
                          '85396','89456','48416','19094','66355',
                          '16028','85689','14726','33814','36349',
                          '66372','30262','67078','73354','71766',
                          '25319','82874','32444','60866','14665',
                          '29997','51066','94602','28973','36590',
                          '21752','15531','95214','59536','82114',
                          '68571','95210','29180','22127','85671',
                          '98362','30953','94873','30604','49603',
                          '35425','32662','14879','47224','33698',
                          '68489','51839','66479','17712','56023',
                          '17555','67028','24709','82867','68350',
                          '94535','35707','51313','68419','55256',
                          '44840','74789','27822','84979','49922',
                          '38401','71323','81067','48414','29233',
                          '35572','71633','82723','61411','24048',
                          '53580','93312','20360','83169','65880',
                          '31139','47374','73919','82686','26358',
                          '18094','62978','84874','96611','27165',
                          '65377','54052','69586','55306','54307',
                          '67354','60588','35149','25864','77018',
                          '39595','46477','37037','32343','29494',
                          '79280','71069','78595','99715','80490',
                          '32180','36976','92053','34261','95493',
                          '47226','30311','41337','86814','39187',
                          '33636','11784','87169','73123','51383',
                          '20787','55374','38344','68284','21107',
                          '90734','14065','83947','41699','78012',
                          '40633','83648','93089','67125','55507',
                          '23967','81101','83606','72759','56806',
                          '25034','43233','66939','77954','98418',
                          '27951','77578','58061','21207','83912',
                          '17917','35767','61629','11970','84097',
                          '27122','30157','27148','91415','66041',
                          '39232','38101','42845','11874','96714',
                          '97404','87271','33347','46320','24143',
                          '46882','78816','42968','33785','71192',
                          '82385','79110','87885','51559','69528',
                          '54957','25300','73264','38164','44064',
                          '49675','21231','20560','68415','89229',
                          '75158','54864','80819','92862','68582',
                          '24439','99397','87023','67624','68006',
                          '47901','15632','63123','15203','65886',
                          '82405','14497','49252','92815','62656',
                          '61758','50406','34619','40618','71712',
                          '75472','98465','46974','15967','98036',
                          '74026','64087','20592','75800','27137',
                          '66483','61472','98069','39904','61126',
                          '94778','23811','44624','18304','36959',
                          '93959','95915','53259','51248','21760',
                          '31376','80350','74340','61306','36322',
                          '87967','55759','88979','55380','86559',
                          '93533','66335','75082','76786','98408',
                          '83984','55266','64908','63381','94024',
                          '96414','83291','57434','66137','64789',
                          '89360','90462','42111','65353','83821',
                          '39280','92981','66814','71465','15768',
                          '76926','43422','12790','20412','11057',
                          '62661','92795','19698','74169','93461',
                          '22844','98856','25567','21603','33207',
                          '68000','30289','13143','37299','65433',
                          '94165','30475','48967','22112','95106',
                          '19860','73046','76936','31425','62704',
                          '83193','37107','95202','47080','46875',
                          '21779','26553','13584','86015','49902',
                          '15968','73314','28174','31064','37605',
                          '44121','92248','73267','17558','35231',
                          '22858','56706','57181','94651','74477',
                          '40295','63232','26064','44505','69420',
                          '61552','68092','65640','63918','50349',
                          '43497','28883','96606','45329')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


