
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '83133','15569','83325','53984','50618','23528',
                          '88304','25540','80695','88993','79837',
                          '42534','75157','17706','36439','47640',
                          '15045','13946','58338','54164','71038',
                          '38452','45984','51439','70401','96339',
                          '84250','45745','84645','74905','17183',
                          '10011','33084','53714','31569','35300',
                          '49505','71465','90210','89992','50283',
                          '52862','38379','90436','13091','51499',
                          '86367','56921','99945','63629','30854',
                          '14311','96865','13176','88523','75594',
                          '21242','51961','45502','52134','79359',
                          '60580','39584','73252','96586','99084',
                          '98275','41832','84758','71822','18640',
                          '45066','59653','19228','28854','46536',
                          '97440','88292','82021','20958','69009',
                          '54388','98095','46621','20279','17463',
                          '62760','37510','25380','40487','95016',
                          '45245','36713','59666','20104','89487',
                          '74551','58603','29271','91595','80662',
                          '77413','70198','55815','47651','76271',
                          '40919','84083','66285','37073','41861',
                          '77418','74408','50984','13821','77237',
                          '62079','15994','83379','17174','65181',
                          '84526','23999','87724','20081','73323',
                          '42744','11259','64896','52485','60920',
                          '50543','58823','11833','67705','18299',
                          '90422','14539','51344','27088','17129',
                          '40531','15599','80139','88633','18631',
                          '72021','27935','75672','93117','64275',
                          '76319','81832','71128','32508','47410',
                          '94946','10233','44407','38304','55483',
                          '38990','49224','32888','79393','30513',
                          '94058','93671','60761','85373','14561',
                          '69319','30660','82828','38121','82806',
                          '83088','50410','19797','64448','81239',
                          '31878','82576','67931','69719','60610',
                          '10967','81493','28663','75580','81133',
                          '44516','79629','92195','64034','39491',
                          '66885','37646','52087','48998','72997',
                          '20720','85081','27851','82972','15256',
                          '78680','27658','88712','32283','53675',
                          '21595','77380','46382','17714','30339',
                          '14864','79705','74340','93302','65353',
                          '48212','31083','30493','43334','65679',
                          '15446','46392','36978','79040','61030',
                          '71625','26908','21452','43972','49071',
                          '91384','89002','45653','14670','25784',
                          '82519','73760','80390','30774','93377',
                          '32248','44402','93557','34046','55377',
                          '86896','75806','81428','46378','91289',
                          '76149','95639','32313','37683','82443',
                          '75342','50075','93378','33561','79806',
                          '57913','91796','85018','17323','41945',
                          '51942','10425','86800','78219','72136',
                          '69914','41500','83235','82030','76377',
                          '40343','32040','22789','20775','85239',
                          '95117','66338','59496','95187','25840',
                          '43797','23210','58998','86590','71982',
                          '85589','84723','69631','97657','44910',
                          '59178','93079','95233','34312','46318',
                          '40880','84410','49320','97274','80183',
                          '17796','99495','69022','38795','37020',
                          '60206','85427','10805','45231','70969',
                          '31293','85608','45992','12616','60571',
                          '58609','75186','87652','30345','88534',
                          '28566','19801','58852','20922','26517',
                          '64247','28747','13198','23725','28085',
                          '79738','90430','46114','82086','89034',
                          '40397','69919','77741','92397','93201',
                          '93080','67496','87870','33407','11015',
                          '41924','59756','25378','74812','38499',
                          '89339','53770','41335','34239','90282',
                          '92701','63094','48384','78536','46889',
                          '46798','11859','38009','50529','26720',
                          '71165','11964','75621','25428','34614',
                          '21730','83164','45298','51670','35357',
                          '38269','49335','32048','87389','31855',
                          '98670','71436','36081','39284','44627',
                          '14972','10441','27605','87346')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


