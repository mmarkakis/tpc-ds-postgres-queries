
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '41997','76861','10255','66115','77066','91619',
                          '14077','13159','82549','46801','96716',
                          '57292','61178','29690','26494','37527',
                          '79770','52650','78897','67576','53435',
                          '94509','36254','60024','61274','93006',
                          '31463','22110','38721','54522','13110',
                          '43696','28969','34480','37762','55369',
                          '74314','68127','61755','61095','50007',
                          '92328','78545','47422','19765','15787',
                          '53332','93155','36803','16970','34637',
                          '67307','96667','56956','12873','89780',
                          '41908','83971','94066','22075','14188',
                          '93752','47603','83781','62371','15023',
                          '51729','12079','18545','60789','92723',
                          '49736','62164','86402','93795','26879',
                          '94367','14752','52151','64691','77944',
                          '10512','25102','98934','68220','90199',
                          '24834','73571','35390','28982','59172',
                          '18786','64902','93527','66696','48527',
                          '15169','36763','31958','31594','31037',
                          '56512','31876','43661','81674','78032',
                          '34495','46481','61507','29227','61656',
                          '24684','62042','63354','92507','28466',
                          '76876','88243','55038','64521','19255',
                          '94230','96324','91542','73359','28381',
                          '21334','63681','71059','97357','11902',
                          '33858','66551','82585','34875','41250',
                          '37459','77616','64198','49467','21497',
                          '24600','76491','53249','10716','38882',
                          '17153','64275','82415','68643','76783',
                          '98797','67960','96190','81244','49322',
                          '34644','16195','90894','26338','86453',
                          '65413','87615','61242','41677','69210',
                          '58523','87075','83263','24569','89961',
                          '14239','23541','11660','55686','47923',
                          '12882','58013','59363','91239','69417',
                          '38453','84695','64964','83935','29356',
                          '57730','71432','42441','73321','32114',
                          '38975','29657','95870','17507','58366',
                          '80756','49043','15888','23324','72549',
                          '45268','35241','25573','87606','44619',
                          '24782','23652','55133','69858','57798',
                          '37273','43674','70148','23156','63530',
                          '95030','87645','28625','94090','97622',
                          '68017','78391','71346','12826','94847',
                          '31654','57726','39611','79581','42532',
                          '31783','84797','70737','53694','90114',
                          '80196','16553','40876','13832','55940',
                          '26068','46817','73501','83070','78022',
                          '83862','79852','83649','35914','18178',
                          '77966','47754','91259','98430','68527',
                          '61801','63326','19878','80959','42018',
                          '32867','44242','35775','22184','10574',
                          '41621','73769','19260','42569','78445',
                          '90458','58375','85276','17241','71947',
                          '44702','18562','93116','12099','98009',
                          '64705','17221','31855','43297','85718',
                          '47741','55653','48755','11614','18707',
                          '90227','42936','74787','52622','20702',
                          '91843','69537','51456','33361','70008',
                          '64435','40845','32016','72230','23765',
                          '20879','53918','11917','91348','58682',
                          '97674','43575','56888','91770','64957',
                          '23640','17336','30170','14464','74126',
                          '38474','36868','40348','89543','21419',
                          '30472','53905','78767','16293','50845',
                          '45987','95054','52680','60265','79551',
                          '89750','62789','94555','13380','98048',
                          '89059','47757','70812','15357','64880',
                          '13541','43887','49271','34021','17223',
                          '63152','86071','51408','33045','93350',
                          '41600','88946','52126','66012','81020',
                          '31549','30188','31861','14616','37126',
                          '53898','29348','38643','97816','17522',
                          '53494','55807','32509','47822','89966',
                          '69677','39965','54885','46084','97211',
                          '57160','53914','42915','91089','15110',
                          '10040','92648','22296','34054','16844',
                          '83423','89823','83143','69868','70411',
                          '60169','95884','66336','10674')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


