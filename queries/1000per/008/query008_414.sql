
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '90635','15621','44969','18285','60169','60074',
                          '68453','44866','29653','33273','43695',
                          '69433','64524','65545','12434','17471',
                          '59129','77683','49982','76537','12769',
                          '48103','94003','19321','73747','65173',
                          '80474','45176','64213','85765','94167',
                          '27882','76366','46035','39313','91362',
                          '98949','62913','24182','27060','15193',
                          '96444','82309','63373','56827','13990',
                          '58557','78917','87533','65555','48946',
                          '34003','77604','69821','44355','52113',
                          '61278','89754','29809','65525','98329',
                          '90885','30201','34113','99054','94289',
                          '49915','28658','80671','60948','78211',
                          '43966','47140','94670','18961','59976',
                          '40728','64121','85318','93607','49064',
                          '16271','54940','16425','81055','51821',
                          '40300','17483','35107','73604','61863',
                          '17800','23456','88014','54591','67242',
                          '26857','10923','51669','78322','41901',
                          '36859','32550','99026','81720','23105',
                          '79455','55203','75909','18603','77542',
                          '96015','14498','49443','55865','93576',
                          '76001','90914','53665','73994','78477',
                          '15794','70596','81844','97496','54796',
                          '75720','51435','70534','44219','17984',
                          '42269','55412','52809','81317','34022',
                          '82671','34038','17024','55706','16796',
                          '80030','74972','94050','66570','43692',
                          '95345','80997','65116','84981','30746',
                          '83964','17220','75032','22924','11468',
                          '43574','56941','38684','93250','16232',
                          '37744','67991','27685','76379','54066',
                          '58290','47065','37265','77848','94506',
                          '79132','56014','47246','53982','85110',
                          '11868','37469','60898','59020','35710',
                          '42051','38421','66647','77097','28597',
                          '75289','35004','73555','95992','33961',
                          '54760','72852','12209','51134','42502',
                          '89483','80953','10784','48564','27217',
                          '32648','31032','87815','79941','69883',
                          '78435','23095','14208','31541','58008',
                          '82905','94326','80426','94186','80580',
                          '69174','79195','45958','33112','21697',
                          '37851','37570','14613','21535','68443',
                          '55845','75641','97034','48807','62254',
                          '34425','28515','47519','71554','30964',
                          '95785','68428','65499','70385','49269',
                          '38462','76142','91034','46595','87038',
                          '91964','78385','94545','92690','67847',
                          '30469','42438','86710','66207','91864',
                          '41937','75547','65295','57690','96109',
                          '46860','18291','68030','50955','27761',
                          '59720','68335','17117','45676','88215',
                          '77182','24219','36799','72743','11310',
                          '46171','58252','59830','28572','68343',
                          '80777','64549','61295','56402','28765',
                          '40092','95168','82438','14987','96059',
                          '69292','28446','24407','31623','25701',
                          '49773','61986','77865','39817','59890',
                          '55819','13730','63409','26639','81749',
                          '79121','68260','70190','47415','88959',
                          '61228','55272','40583','29174','55304',
                          '30769','81305','75764','38551','40700',
                          '95388','36074','84958','78625','51517',
                          '10033','69199','66886','93380','77799',
                          '70038','56762','17051','19394','87381',
                          '69836','88045','49296','44193','95346',
                          '17751','80727','62324','98020','43496',
                          '91767','47292','71336','82272','85060',
                          '17842','62982','53592','38882','51584',
                          '69956','69121','96196','55034','65843',
                          '12160','31115','18391','51113','69480',
                          '21194','65989','73883','26517','20024',
                          '35351','10177','23442','86515','84112',
                          '91931','96578','86198','62145','18251',
                          '40361','71541','56209','44734','70616',
                          '41469','81852','76111','78887','24279',
                          '57745','85634','93451','14072','56241',
                          '74053','33050','43812','14030')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


