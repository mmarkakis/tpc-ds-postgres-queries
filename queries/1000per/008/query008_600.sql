
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '63972','33508','34500','84390','31638','81692',
                          '13538','55106','59185','30142','19465',
                          '21388','11618','50989','24611','94995',
                          '61012','83704','88676','32035','30699',
                          '61910','63453','48256','38760','96162',
                          '54343','69969','66404','55031','32171',
                          '17299','10279','64135','73433','23531',
                          '65236','87582','59703','52386','38312',
                          '15235','16989','89457','89750','60137',
                          '46384','86860','83801','83870','93676',
                          '70927','86779','79604','59848','22850',
                          '11088','48435','22275','88436','37641',
                          '48333','39726','46416','60542','97411',
                          '30707','93446','56628','68611','92300',
                          '84219','11219','23958','58543','37234',
                          '85260','65242','12123','96113','12838',
                          '31775','71507','98615','67274','22187',
                          '99520','69722','32906','28850','36272',
                          '38646','35337','26365','89491','33977',
                          '89426','92989','49775','53955','90584',
                          '88922','73975','73068','85667','74549',
                          '11302','58256','83925','67254','42637',
                          '96559','66175','96578','54141','52871',
                          '61674','64916','76317','31470','59429',
                          '66057','69762','86069','64687','90965',
                          '60268','69886','34492','77171','73541',
                          '25501','73977','79825','62632','18813',
                          '70286','11678','84545','51453','65431',
                          '56423','41261','22126','67484','21796',
                          '43350','28946','13433','30443','21700',
                          '38602','65754','89226','14987','92547',
                          '99663','52530','73119','39439','94943',
                          '36698','73570','28129','52080','64240',
                          '99147','92763','96640','87394','13018',
                          '62762','84859','68160','21804','13335',
                          '62588','93965','90667','60338','73549',
                          '46949','46110','59485','69659','76858',
                          '91013','76895','77826','50337','49661',
                          '19844','40344','90943','39123','92205',
                          '83571','56306','18305','13952','64657',
                          '88780','27255','11345','89200','19560',
                          '42907','35483','44137','33553','26282',
                          '20895','83116','14105','32287','95819',
                          '11934','13820','48314','75612','28749',
                          '20603','11668','64990','70210','10907',
                          '19695','88894','48717','33936','63433',
                          '53110','57476','53887','54673','53644',
                          '79395','24315','13481','46528','19269',
                          '14011','25264','18426','46475','85237',
                          '53826','65908','48225','51487','50962',
                          '74874','65799','67362','75880','42329',
                          '68104','24119','70288','60409','78091',
                          '49678','29812','71160','37382','66081',
                          '52473','50048','42685','45226','63414',
                          '17055','34493','35012','54053','14836',
                          '87918','20389','52900','19891','51594',
                          '68079','84056','96486','91077','72624',
                          '37946','24726','22662','38497','18511',
                          '89286','71324','31094','31658','30310',
                          '27288','94336','23471','31452','26880',
                          '35347','31374','81633','15917','42821',
                          '70634','62729','52708','87504','75268',
                          '52410','33908','69382','13405','20854',
                          '37882','55284','55200','37034','63167',
                          '93295','51148','98978','92938','29372',
                          '90662','62153','93306','33061','52201',
                          '66877','22351','76457','96921','42355',
                          '77016','67664','50749','57033','93939',
                          '83005','73786','23392','49642','96336',
                          '37322','57048','95461','17408','68265',
                          '56382','56598','18725','53591','42673',
                          '94803','55188','86567','65015','21335',
                          '49701','16556','84340','97915','69046',
                          '44181','88587','62252','82551','45041',
                          '20586','73978','99081','78865','47115',
                          '99057','42774','60228','37726','76758',
                          '35364','51584','69445','69960','13779',
                          '25031','14818','10299','72821','91802',
                          '21866','70448','63229','25644','30563',
                          '76805','34859','16379','12523')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


