
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '29541','34132','56110','57110','68167','10940',
                          '88519','80368','13572','36927','46838',
                          '30346','16481','20217','54847','90537',
                          '10040','13133','57671','37006','28826',
                          '69653','53822','21210','39101','50260',
                          '50839','77467','26447','63607','28604',
                          '32342','28868','50296','65488','39055',
                          '78335','83405','96006','95667','66998',
                          '11536','19379','42199','60826','46004',
                          '11282','43604','47456','31021','27869',
                          '62946','83759','17911','77370','90772',
                          '87000','63782','25070','88656','85321',
                          '60389','93965','10229','41464','43580',
                          '98258','58082','38138','74318','63379',
                          '13671','39803','85566','81544','49736',
                          '98518','45031','87122','86919','14375',
                          '34834','70431','50418','47132','29889',
                          '44692','10228','25863','64402','45053',
                          '37647','17747','28122','71178','96205',
                          '71822','14198','90935','47560','66762',
                          '59814','12681','95989','96211','33650',
                          '38993','69820','73613','13042','36077',
                          '68790','40899','67546','10803','61993',
                          '72318','26455','67649','90393','18509',
                          '22846','33434','35779','76319','97529',
                          '66017','22909','58485','94466','19409',
                          '10108','47980','17042','13520','45352',
                          '57625','82698','38370','28460','25267',
                          '75614','86650','46996','30062','76690',
                          '46914','41324','12131','49817','63140',
                          '79995','16653','26518','27891','62898',
                          '40847','48648','78843','10180','58227',
                          '37415','66113','76756','63750','32688',
                          '16488','14525','39319','78403','78367',
                          '65093','64652','58834','68136','25430',
                          '40620','68435','52576','81030','66006',
                          '55868','30890','73259','95472','50417',
                          '71037','15302','23935','49005','62562',
                          '24160','98639','27004','41114','89404',
                          '72331','65645','59990','81927','81196',
                          '11373','72148','30207','62962','15845',
                          '29343','95942','22365','64880','44838',
                          '86804','96573','72833','79086','94445',
                          '25311','32943','89044','38740','15752',
                          '25577','55906','29853','90433','72154',
                          '38518','61336','88214','69306','91384',
                          '87096','48542','85472','89690','75980',
                          '91983','48954','33424','65308','95908',
                          '89451','70094','32869','66482','34560',
                          '89058','26203','81355','68950','70727',
                          '79603','54735','53806','25288','22898',
                          '84756','78958','66540','50402','27002',
                          '98925','24293','96577','73367','58146',
                          '98509','74522','90005','31765','56563',
                          '91856','40222','42902','29310','59033',
                          '36692','28822','54126','87156','48608',
                          '43188','67121','65868','44185','90786',
                          '46162','89452','92084','50127','96101',
                          '55823','38424','91823','88361','93606',
                          '62933','34459','28285','79559','48851',
                          '66768','16379','24049','54159','86275',
                          '28286','17876','12508','15969','52579',
                          '96303','17605','80206','74543','27508',
                          '64372','73352','11234','12787','25824',
                          '46851','53188','10895','91602','89118',
                          '59077','93198','91543','36603','12708',
                          '70554','90826','18456','83814','99674',
                          '72158','22730','25890','55427','78995',
                          '25537','17450','36812','12715','94378',
                          '33468','49639','92223','92827','14450',
                          '61694','57282','37918','38247','34033',
                          '58840','92284','56691','81461','22716',
                          '55677','23520','19098','73141','63813',
                          '61547','94352','43717','77580','79542',
                          '68645','93876','43827','22731','25671',
                          '22495','25034','44594','63308','57607',
                          '47841','63261','52106','42749','36519',
                          '30942','35755','88346','91670','81907',
                          '19242','81317','74212','46297','51596',
                          '17664','50900','30057','81071')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


