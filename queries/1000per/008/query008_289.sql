
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '54796','14225','89822','96867','35026','48771',
                          '80152','29193','88377','39348','31163',
                          '67567','38372','46886','19153','72026',
                          '68135','86372','27309','78847','82196',
                          '62545','46428','32253','33651','43573',
                          '28739','55371','34491','59505','11817',
                          '97049','72435','67524','14181','33567',
                          '47286','47833','27625','29066','16432',
                          '58631','85418','74208','36527','85707',
                          '81354','83234','92380','17213','42305',
                          '20670','46459','22488','86508','36795',
                          '75964','49302','96960','73878','59581',
                          '24956','14009','21868','16707','58818',
                          '42614','84547','79814','29096','37252',
                          '35465','20908','28953','19617','52226',
                          '58299','18841','25755','73751','62237',
                          '90905','13014','85205','39399','64136',
                          '74781','94971','85117','85871','96877',
                          '79123','97824','52850','31432','49363',
                          '22573','83290','59014','93897','39148',
                          '66572','91961','13715','52495','23852',
                          '75784','58386','13447','58563','30786',
                          '50039','55907','58244','48052','90729',
                          '80162','44705','36288','66299','29162',
                          '86900','78327','32842','70347','91099',
                          '42129','40600','33712','81809','63311',
                          '38709','36861','84252','41285','12218',
                          '18589','21768','65674','67503','68328',
                          '36312','75440','23844','44818','13299',
                          '86606','41961','16117','66819','34004',
                          '96490','77594','69319','14438','65696',
                          '53528','33338','55503','83966','54751',
                          '59355','28270','51263','36064','58399',
                          '34492','47397','46295','18539','27588',
                          '19206','74299','44528','90342','76291',
                          '65424','74591','24211','51707','37074',
                          '13748','20607','66826','55259','41919',
                          '75488','46404','35274','48965','33846',
                          '46317','92809','38785','23272','44404',
                          '93631','94175','82532','17492','74037',
                          '61191','29367','17393','52963','18310',
                          '97051','98609','34369','47817','26945',
                          '59211','81859','66118','11635','64179',
                          '63753','98045','17744','74297','97162',
                          '35115','89508','50299','78423','28352',
                          '24345','33821','70838','74424','95802',
                          '81298','62095','52475','92373','73651',
                          '52299','46667','13870','19284','15694',
                          '85559','22177','87821','54229','98852',
                          '31002','61626','36780','41925','29471',
                          '47192','87672','63105','98215','98527',
                          '87572','30492','44884','93850','90695',
                          '36022','48404','15737','53069','26989',
                          '28009','20689','71137','82585','73272',
                          '32604','35073','69969','96249','43034',
                          '45387','53537','74291','99635','91207',
                          '63550','72883','67171','30878','43823',
                          '88206','31130','70828','70476','58470',
                          '62196','40041','91069','59367','13221',
                          '52041','61500','16565','45041','86770',
                          '91999','58488','82826','37655','36832',
                          '90247','98108','96806','63406','28989',
                          '25205','16278','65538','65906','96121',
                          '55948','63472','69277','15799','73224',
                          '17043','99255','28652','81225','47467',
                          '64659','50949','84194','16809','10448',
                          '89028','30572','32686','58656','17449',
                          '16690','71774','63987','67783','47708',
                          '73068','92084','42743','19400','38989',
                          '40299','31503','40438','57122','15720',
                          '77562','82873','63347','15859','89706',
                          '55663','85426','37146','43416','68814',
                          '27999','98929','50797','79006','94752',
                          '72422','52769','86468','40861','38354',
                          '78589','84233','45125','14441','91907',
                          '79421','73482','78216','19854','87262',
                          '37757','11039','68620','46411','90632',
                          '61902','74119','60870','12853','46104',
                          '83756','10848','66027','60887','84652',
                          '19108','15826','51160','67147')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


