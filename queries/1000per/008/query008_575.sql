
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '65368','60640','47345','32761','36602','72368',
                          '12555','27106','71144','30538','91173',
                          '30400','33566','65150','87151','41141',
                          '89857','68909','84914','66008','90298',
                          '68581','38946','17913','72883','96895',
                          '38842','56709','29080','42462','64841',
                          '19088','64933','64065','10912','13180',
                          '10785','75673','87084','24680','19935',
                          '67158','12305','52504','47939','91162',
                          '73871','50657','46083','19748','15527',
                          '37574','81031','17493','34362','85086',
                          '28027','58009','53822','83495','46437',
                          '29513','13469','10885','88459','28318',
                          '85690','58040','66451','19872','56347',
                          '36779','49239','10180','38252','68261',
                          '88858','61885','91847','94931','70225',
                          '60279','70866','20263','96367','97999',
                          '53317','52313','19359','48611','42577',
                          '51120','23837','95748','16642','24196',
                          '34844','24825','29812','24838','19297',
                          '64646','72748','96629','14554','79551',
                          '77039','14005','46538','84863','93033',
                          '22643','71627','54464','40350','66095',
                          '79148','44551','36899','85628','91401',
                          '86742','75764','28062','97200','63331',
                          '99916','21522','46039','13781','57402',
                          '88333','32484','18589','70784','29402',
                          '11033','85959','84226','64227','12990',
                          '88063','23665','81284','65882','92600',
                          '96741','14774','18958','86187','70401',
                          '61514','94410','74343','78191','55115',
                          '75299','97303','62648','33335','75276',
                          '61527','41792','37975','68210','79639',
                          '27928','38233','78220','28210','96459',
                          '96658','44033','91982','40846','91523',
                          '63662','23424','67578','29596','12230',
                          '20244','85849','72064','91579','52382',
                          '90364','74194','43398','52115','98216',
                          '69615','45762','23532','66840','37538',
                          '53256','67611','78418','39482','64484',
                          '13301','35619','40312','34887','87705',
                          '50165','66777','29222','31978','28371',
                          '46268','67574','90438','37525','21054',
                          '88276','73655','88864','93072','13788',
                          '60929','31350','86384','57466','31934',
                          '55294','90597','35414','25063','71906',
                          '25628','87992','34840','71120','17987',
                          '45393','95361','44570','63415','21376',
                          '72528','29091','34234','58075','68179',
                          '25684','29986','14460','11221','70699',
                          '42695','53712','21864','37103','64862',
                          '99842','27060','39923','74828','96511',
                          '98673','47056','39865','28298','42725',
                          '24702','87158','96821','43117','91570',
                          '92991','13854','50451','96013','57030',
                          '81367','63422','90492','47084','66925',
                          '30940','21604','96811','41097','44859',
                          '21749','73335','87149','76362','20185',
                          '76042','33925','65758','72768','23970',
                          '55283','63740','89305','22954','93765',
                          '41449','58106','29059','15310','62605',
                          '81169','58892','90110','59076','11495',
                          '23840','60281','70703','79213','27043',
                          '26944','31968','64715','70759','23044',
                          '88598','78177','37657','35338','14354',
                          '38332','86842','42967','89894','12729',
                          '92651','25989','34452','25186','19215',
                          '99545','14973','53665','55477','76967',
                          '98159','71850','65901','63598','20285',
                          '24874','42389','39652','10738','90899',
                          '56038','91846','53087','19513','34787',
                          '81003','14137','35259','26385','73034',
                          '89849','24619','15433','26684','43429',
                          '52289','47315','41048','67276','77025',
                          '95169','39396','37094','58182','37640',
                          '21322','81346','83958','92451','89471',
                          '38741','89874','25645','21543','48603',
                          '39768','25236','91702','83333','90924',
                          '86311','86534','83857','33507','90294',
                          '39575','26001','85091','93316')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


