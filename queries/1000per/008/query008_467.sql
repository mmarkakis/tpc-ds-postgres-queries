
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '53942','52275','21129','78862','48530','37929',
                          '52202','16322','60205','89215','60656',
                          '14896','63866','60149','99621','15623',
                          '46265','45789','38856','21747','85316',
                          '57094','98340','59024','20138','17963',
                          '82455','17311','10420','90025','87115',
                          '45544','99374','32080','92447','25931',
                          '71532','56762','68461','17105','39392',
                          '46335','60109','36203','92735','80949',
                          '88137','40506','11623','48245','21168',
                          '93229','87089','93160','66334','53233',
                          '87847','79446','68914','55815','70091',
                          '66105','49342','32827','90018','54577',
                          '80427','62038','70146','19369','34731',
                          '53664','50046','42991','35375','86697',
                          '48569','33653','78759','87322','56104',
                          '56303','67413','49797','52575','42959',
                          '59783','75678','29057','58187','48838',
                          '16701','67388','28348','86178','95231',
                          '68110','22828','23080','40977','39338',
                          '97816','26231','31358','38039','52716',
                          '84651','56700','65677','85341','91769',
                          '82449','63059','46977','96931','94457',
                          '45843','89436','12300','20683','44542',
                          '47306','23792','63193','43099','14255',
                          '34337','95949','63021','77093','78281',
                          '38304','36994','66726','84548','30692',
                          '21945','68681','87873','42311','99764',
                          '92706','23139','99283','51343','35564',
                          '62732','89603','25960','96690','23758',
                          '13807','50231','65717','76437','66398',
                          '28180','62840','31862','29065','46651',
                          '33369','81668','30629','19211','71530',
                          '73735','84607','95674','81832','65621',
                          '11360','34295','67702','53972','27131',
                          '38885','18414','93629','40533','60062',
                          '97838','23044','28335','15651','31264',
                          '88154','97231','90776','29480','18389',
                          '92718','12949','61640','43175','14852',
                          '25883','82412','52141','11320','62156',
                          '55414','23534','35769','30269','48011',
                          '91109','96161','19122','69968','79978',
                          '77596','77650','98700','10967','47184',
                          '77232','93136','98751','25166','76085',
                          '64404','55309','43422','34941','75977',
                          '11078','20960','19261','12797','77571',
                          '64260','73864','84105','39200','21009',
                          '87141','57653','59466','75571','97951',
                          '30972','21864','27533','92096','73823',
                          '35557','85061','28914','26876','36577',
                          '95233','93142','79817','17816','28668',
                          '79044','71198','90900','70224','84915',
                          '69439','47384','63451','51183','59430',
                          '71963','34562','34309','93688','59307',
                          '99082','11826','78992','75175','40095',
                          '16069','75852','27327','98914','54344',
                          '93830','32449','53057','54968','57064',
                          '21195','92643','85638','27974','48811',
                          '87920','14361','82871','30276','76628',
                          '47107','98922','20695','47071','63613',
                          '47084','55496','14955','38781','27203',
                          '61068','88788','66620','79563','93193',
                          '92902','53905','68514','44078','38329',
                          '49675','30042','83050','89782','37629',
                          '25147','97949','20273','14504','30223',
                          '62004','50309','10641','77124','17424',
                          '23490','98575','89492','37879','38283',
                          '41024','49773','24878','66342','37510',
                          '75526','56815','90811','33018','91417',
                          '38394','56577','95681','91545','80076',
                          '56540','91092','48768','48090','67397',
                          '87363','44560','34169','77545','21516',
                          '49132','74305','22579','34340','17806',
                          '51916','42839','44549','79486','50659',
                          '39794','54685','18950','39067','66379',
                          '63774','69886','17705','47572','25771',
                          '68207','59179','89388','66075','57649',
                          '32427','22955','20603','38040','91201',
                          '82943','56617','90428','15905','38519',
                          '12831','63588','84567','86271')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


