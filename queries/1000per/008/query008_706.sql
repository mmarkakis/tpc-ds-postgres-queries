
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '28349','19761','61496','51326','49046','98353',
                          '83471','58688','96070','91555','31560',
                          '55284','78468','30014','41825','89216',
                          '60658','42171','20016','77580','77648',
                          '40041','97391','87716','10059','34081',
                          '29195','66938','36518','30262','99514',
                          '77170','28491','66965','58989','27173',
                          '83523','96731','26373','62804','57797',
                          '90543','21889','46311','52800','16917',
                          '62836','48086','13550','29103','16820',
                          '94621','42304','76440','38544','82300',
                          '40907','49395','10726','81444','29512',
                          '49386','33640','94100','15946','58838',
                          '17232','62634','75907','59046','47552',
                          '56348','68552','74819','31333','89890',
                          '74172','83867','46881','82457','89252',
                          '62564','84628','41301','38518','27555',
                          '22825','21065','53059','72978','69404',
                          '60289','54675','39661','85091','77248',
                          '79281','53653','95036','20054','10743',
                          '83862','58485','68873','39010','98394',
                          '26415','56993','77552','37274','39514',
                          '43581','68343','83877','30168','20091',
                          '90867','29115','47049','34022','37524',
                          '94422','66585','62758','92492','93511',
                          '50132','71837','41733','12260','97226',
                          '87826','32050','94011','63491','35246',
                          '17878','28604','48960','22397','49706',
                          '20099','35932','78026','69799','20757',
                          '24535','76338','79587','39919','29581',
                          '79793','31655','24876','46934','25216',
                          '94862','44984','76557','63632','52084',
                          '34045','85326','69937','63939','86851',
                          '35866','35947','72697','72113','25641',
                          '65680','76261','53197','63107','85195',
                          '32793','83595','50295','51732','19692',
                          '64223','54862','66474','36065','13681',
                          '75580','79256','93200','33776','76341',
                          '59570','85674','62985','76484','75880',
                          '25293','75654','41740','36551','19210',
                          '92753','23176','59504','63444','81654',
                          '40467','43723','16546','64582','89110',
                          '21765','89968','60750','20895','40836',
                          '82515','45262','17511','64323','87108',
                          '64190','68409','34313','58423','13154',
                          '33976','72214','22722','58882','41248',
                          '53127','51532','86112','47561','32640',
                          '53938','86898','50269','13117','50330',
                          '65581','88429','99184','65577','73368',
                          '20161','86945','70029','33258','43935',
                          '58678','11283','33772','26178','18475',
                          '94743','42080','80625','78094','69890',
                          '66213','42735','78703','54058','43827',
                          '10018','33763','86077','68960','32611',
                          '58199','64133','95136','55052','27397',
                          '17651','88675','21788','30152','53991',
                          '80840','20607','86452','95589','26091',
                          '66819','16616','98299','94387','85467',
                          '13712','37701','47749','33063','96961',
                          '87802','93413','22728','62330','40066',
                          '39264','81007','44991','49673','27144',
                          '37317','84327','30097','68356','70637',
                          '29004','71762','58492','11190','14314',
                          '42088','31241','80846','49121','31660',
                          '98274','28961','66993','11267','48025',
                          '22984','74605','60774','76445','25251',
                          '45429','47872','53984','89235','27865',
                          '76966','71446','88696','96394','55219',
                          '83100','85955','53223','31202','98620',
                          '32104','52095','51177','68192','43868',
                          '86754','74237','99507','47657','81049',
                          '17234','59820','85884','48390','13655',
                          '77293','57599','13205','80116','99838',
                          '84609','72517','90693','64836','30842',
                          '42683','65368','33865','62981','72429',
                          '49387','75122','76276','13036','60928',
                          '18812','98588','88559','58308','69991',
                          '63479','21560','36457','46481','69968',
                          '40120','78877','18233','41386','85152',
                          '53961','95697','82792','59297')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


