
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '37034','34632','19606','76534','54964','49163',
                          '92901','47223','29242','89015','96781',
                          '84682','18717','68960','95303','17172',
                          '64329','37300','43040','50071','74514',
                          '60070','22984','91053','90674','39853',
                          '46135','91704','25134','64455','42400',
                          '64124','39327','21687','37611','70770',
                          '50587','52311','97918','91874','47692',
                          '28527','24601','70981','98218','14436',
                          '35268','23870','80955','99000','35919',
                          '94538','19029','17551','28449','85630',
                          '73008','73547','35470','25232','11423',
                          '40866','34887','71558','69276','35267',
                          '89328','67623','61617','99224','60559',
                          '66539','89024','98534','48062','41338',
                          '65766','92384','54858','29178','61440',
                          '65352','41506','75820','43030','66379',
                          '86573','27793','75035','60873','48605',
                          '74241','32854','48293','20473','90777',
                          '78939','50241','11006','44061','59012',
                          '18545','84892','54860','10769','37747',
                          '69352','81104','80628','12854','37032',
                          '76436','38788','12119','49709','46349',
                          '83348','59442','17662','15251','92842',
                          '84436','28554','60003','62233','67616',
                          '63722','76234','85198','66411','93493',
                          '31548','37224','43425','97368','99034',
                          '78498','84194','82239','34729','21721',
                          '97841','25905','69783','48323','53151',
                          '51611','42174','49990','92719','41795',
                          '47244','92768','50585','39926','89951',
                          '40878','71694','43881','31507','23004',
                          '40929','31428','11941','17571','91811',
                          '47070','32404','31786','99671','40309',
                          '27686','58043','72572','58765','24693',
                          '85966','11732','28617','61979','78470',
                          '91977','40696','59564','67767','19592',
                          '81856','43554','48417','79495','70444',
                          '23406','57937','52261','38742','53590',
                          '16253','37703','82390','51231','43541',
                          '41242','33501','23438','40817','30112',
                          '41184','38703','35351','65632','19850',
                          '27308','72647','33011','23308','91519',
                          '39052','81317','25864','24310','84972',
                          '40009','12940','61395','65013','45961',
                          '42295','85305','37307','22324','48642',
                          '66084','25186','35878','89607','62546',
                          '69109','30471','48456','74566','20257',
                          '32500','32473','86051','99689','25239',
                          '11392','72108','64507','76209','50110',
                          '81978','16372','12303','81369','81302',
                          '86922','36540','49578','24789','47684',
                          '88369','16452','30736','97112','32542',
                          '61315','37782','38112','23859','14173',
                          '66698','22464','70274','71644','62142',
                          '95811','39583','67720','21137','96574',
                          '94109','26503','55366','18034','21938',
                          '94168','79324','17087','12908','79990',
                          '72496','91435','99755','40725','99883',
                          '96327','69750','34274','96418','13413',
                          '30577','71638','24285','52453','86038',
                          '20728','44154','19402','35072','66989',
                          '50640','70703','56906','67599','43561',
                          '21948','77206','36802','22193','77868',
                          '78929','62096','95268','66557','44901',
                          '26465','11468','95870','61145','49327',
                          '41772','77966','47159','21090','52741',
                          '84468','51658','51808','38417','51949',
                          '48060','60158','45778','75557','20076',
                          '91905','26003','85051','42358','96181',
                          '30494','93928','63144','81160','90404',
                          '50894','85856','14670','33497','70857',
                          '77199','85063','53871','22394','20269',
                          '88492','91256','60615','58758','39423',
                          '29710','72247','87213','57392','33311',
                          '89487','89033','33284','50355','25584',
                          '16928','35422','54171','80627','22664',
                          '19635','84357','93843','39868','86534',
                          '94155','51434','82673','95930','56487',
                          '47548','42751','59531','59766')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


