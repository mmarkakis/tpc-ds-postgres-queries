
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '55559','66320','30097','73621','85654','36412',
                          '26239','57961','68344','52936','71102',
                          '42418','53817','53647','53560','99435',
                          '40361','16246','79792','42404','50835',
                          '21793','12883','24910','62717','79495',
                          '27389','13073','95926','90495','74795',
                          '59607','44243','48648','65319','95795',
                          '12007','48086','95363','67015','53306',
                          '45310','41367','97768','72181','60300',
                          '38269','37970','94101','67572','30536',
                          '71822','42642','95378','96077','53129',
                          '11046','45566','44746','32504','41264',
                          '42272','60949','93628','77126','80276',
                          '48700','49184','57249','13341','73582',
                          '94375','13467','45003','22801','94853',
                          '67637','59357','95702','19300','71927',
                          '46108','80255','26244','35470','74915',
                          '93793','12852','72126','10606','86011',
                          '40591','29980','39365','73940','85087',
                          '96002','82576','52550','86497','17595',
                          '28424','66751','91180','79499','46758',
                          '62392','56415','46606','97842','83317',
                          '55728','33317','34015','28091','97104',
                          '70081','40497','24932','85505','73248',
                          '73757','47778','45301','44906','52305',
                          '89293','27626','30659','68514','13129',
                          '26599','40900','23021','77238','95244',
                          '53692','39168','45208','32330','10367',
                          '94590','97833','62282','48917','57031',
                          '11371','34571','16900','39281','81795',
                          '73917','39189','84588','10127','90478',
                          '36245','45337','62320','91100','84651',
                          '80585','27419','13305','11197','11966',
                          '96899','58813','52008','79247','57040',
                          '28632','24230','60314','95532','11781',
                          '47181','54080','24961','46322','28878',
                          '96639','42631','82721','38477','53016',
                          '55105','85435','20060','89575','21315',
                          '20407','51852','19443','96393','56260',
                          '76717','84099','31124','92464','74805',
                          '99548','64210','28587','26286','90176',
                          '52610','78063','52112','16653','80948',
                          '77938','10931','36247','21395','58651',
                          '13012','67850','92631','92583','55034',
                          '96536','68362','82439','23443','60610',
                          '53787','24059','26560','24281','66867',
                          '23899','20475','63721','36467','72438',
                          '18180','85695','86368','73637','74673',
                          '12956','52612','29686','67464','25411',
                          '67894','43738','25767','16328','35804',
                          '23272','89360','99542','97713','79243',
                          '52757','64402','94360','60845','33048',
                          '36431','55415','41896','75940','93483',
                          '25973','87622','68820','75588','17437',
                          '61960','84288','41230','78985','85846',
                          '46335','70840','10141','45217','50124',
                          '26675','20375','15934','37468','52585',
                          '51694','10972','90091','22179','13589',
                          '50769','65386','17645','68984','66934',
                          '11180','39379','73079','39793','90157',
                          '39011','20981','35677','68876','84051',
                          '21120','79163','76781','15244','12542',
                          '97153','90052','59291','74522','41462',
                          '24301','50801','71861','10561','34059',
                          '99871','85850','41558','77740','18725',
                          '83181','68255','85460','34874','13038',
                          '98038','48418','62453','45857','62698',
                          '13381','74746','54535','44741','96812',
                          '46153','51049','43182','68139','70740',
                          '41312','72079','74825','58633','83794',
                          '65130','37064','34077','87457','74058',
                          '76806','12701','80858','66503','22005',
                          '19555','29038','52986','45261','45730',
                          '36405','85086','12356','27247','73017',
                          '44400','19449','65269','79840','76688',
                          '79848','92408','82116','34532','77618',
                          '15752','13476','63013','60556','10576',
                          '32880','26620','50141','27789','20785',
                          '61787','86064','91072','94276','97263',
                          '21358','45276','33419','97777')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


