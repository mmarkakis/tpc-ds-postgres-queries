
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '74753','46140','79097','91186','44331','85976',
                          '20431','65972','22746','40146','24934',
                          '76366','21626','93098','87712','62347',
                          '87036','46385','90794','65366','51101',
                          '46876','99390','33499','19357','15405',
                          '17670','27627','70537','29357','99193',
                          '24690','18995','51063','99264','13926',
                          '63587','36169','78517','20915','57712',
                          '26395','95404','57345','13296','92178',
                          '90426','30891','60482','96312','38710',
                          '64477','95599','80965','80363','13301',
                          '56272','98579','79131','60452','19965',
                          '84330','78843','34908','86668','73926',
                          '75394','61767','54472','73326','93132',
                          '58440','92897','28236','48961','84849',
                          '29635','58856','49297','97055','87311',
                          '23419','89939','74566','33258','40875',
                          '50361','92393','80590','73758','38458',
                          '65506','12274','84651','23278','16905',
                          '54184','37301','24274','95416','30419',
                          '62591','41494','86635','28231','94379',
                          '84227','54088','49953','22138','22971',
                          '50687','41601','42953','92867','54581',
                          '57524','50485','20898','53659','50918',
                          '99043','93096','15015','97649','77022',
                          '57087','77014','95033','29143','33450',
                          '83421','86511','47498','65885','70477',
                          '73750','37359','34216','38768','12472',
                          '36596','38316','78062','22335','77455',
                          '33203','30455','84621','74923','76974',
                          '17794','55277','12093','59354','28639',
                          '40255','30063','85288','39177','35133',
                          '20613','74391','86412','79200','47477',
                          '96022','40779','45740','60192','52503',
                          '81783','24559','53035','56768','81661',
                          '99570','36714','86751','85696','26439',
                          '83702','10479','94917','28902','79609',
                          '49565','27436','73103','79817','25365',
                          '12014','82436','98007','81271','49996',
                          '16228','22889','39647','36853','47946',
                          '39998','71038','98610','56150','40077',
                          '70367','21166','40910','95006','58570',
                          '76670','38070','85828','24771','79729',
                          '26004','98980','34341','23628','30611',
                          '67029','44298','92382','95561','15610',
                          '28541','93053','94574','27533','24723',
                          '40941','35586','38140','72690','55675',
                          '30818','69955','58510','95603','98429',
                          '30458','73497','86901','82842','75416',
                          '47058','77782','93722','35420','59858',
                          '24570','61371','78058','60518','36178',
                          '83871','11267','24562','17239','86205',
                          '24278','13977','54663','53684','18068',
                          '55461','29275','72284','37850','83613',
                          '15201','85695','18302','99434','11916',
                          '13627','10520','50423','57358','42563',
                          '62348','35499','25001','27677','27359',
                          '84391','69017','78818','80509','97909',
                          '81400','96256','60817','60845','12312',
                          '92069','62831','11273','96841','23765',
                          '23393','57264','97678','50664','84746',
                          '91489','61907','77243','66677','40073',
                          '39219','17373','92613','39769','99096',
                          '82534','46667','28641','67532','85839',
                          '11699','99736','98738','38155','59242',
                          '13077','88329','62383','68607','72019',
                          '70200','76085','78719','14551','85729',
                          '60832','97424','76242','22921','72531',
                          '58901','36372','50377','39713','94619',
                          '36493','35031','91330','48008','37614',
                          '35238','90206','57173','99985','37456',
                          '16030','39263','55046','72473','45588',
                          '74518','49165','70249','81778','24367',
                          '89332','71884','42482','41445','74139',
                          '19170','62091','54233','26799','34808',
                          '44431','58268','50482','20955','14793',
                          '43807','59228','91069','88079','70197',
                          '37011','89996','61774','75063','29282',
                          '77606','74758','21175','16205','22799',
                          '29180','35264','43396','61734')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


