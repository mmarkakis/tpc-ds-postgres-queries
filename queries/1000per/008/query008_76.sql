
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '54399','88766','28568','24637','80671','73700',
                          '89314','36404','57641','88445','85159',
                          '44646','68762','15988','59199','34030',
                          '14341','36953','60771','49974','95458',
                          '72819','59216','55340','83069','24318',
                          '76360','16069','84570','33335','38232',
                          '40990','19238','63692','29601','27339',
                          '55944','28509','56199','30895','98075',
                          '65240','72011','65607','10023','93067',
                          '55863','20454','92572','77294','10659',
                          '62752','45847','95948','98844','18190',
                          '12420','53820','58054','71322','63439',
                          '68743','78274','28571','13943','39453',
                          '76931','25161','51700','16509','82233',
                          '33147','33838','89864','23732','24202',
                          '17057','65478','99552','13180','18896',
                          '49774','91997','83119','97997','57636',
                          '24419','96220','45159','40794','47162',
                          '32745','11853','72295','95874','74624',
                          '85535','10487','49325','82519','96511',
                          '64752','55980','90977','66899','31474',
                          '92227','75294','93129','77932','90658',
                          '25792','74609','82595','56654','97334',
                          '24729','50749','51235','65707','85057',
                          '45722','26282','27494','62081','72949',
                          '53651','43412','74232','88860','27963',
                          '71173','73573','28166','99428','35201',
                          '41160','16540','24640','77319','26732',
                          '32575','17900','31716','85968','71015',
                          '97920','10325','45615','28921','56447',
                          '86604','37578','82793','94975','32144',
                          '76732','70034','31727','25355','82072',
                          '59792','87871','86690','25852','97154',
                          '77992','58019','66501','78539','56758',
                          '60186','98878','30228','93884','83650',
                          '26685','59781','19844','92974','65686',
                          '24943','93461','62943','78297','33755',
                          '31316','50245','28544','59983','59641',
                          '66780','46502','47535','17726','50232',
                          '87117','70467','90355','90082','91793',
                          '76415','23633','71513','74994','22214',
                          '50336','30836','13351','13221','62919',
                          '59245','51735','43911','61395','46134',
                          '72238','13181','67113','48432','66408',
                          '39550','32508','74066','80015','20510',
                          '30485','64352','92836','25110','79805',
                          '83466','16259','86522','46299','73989',
                          '70313','79084','13009','63831','71425',
                          '63289','38618','68860','25975','14958',
                          '73133','48660','97559','16785','23974',
                          '39553','82107','60617','63926','33667',
                          '85234','45801','17510','98917','93503',
                          '15958','11852','65130','55929','38135',
                          '25395','22769','93688','26618','85434',
                          '92773','17753','88725','50320','30503',
                          '28826','63033','70469','76169','17134',
                          '15652','41028','51440','25263','31456',
                          '73630','74363','51914','42215','84863',
                          '33742','17403','79335','27939','16021',
                          '56537','65168','10963','60498','64252',
                          '77223','69220','37422','91223','13229',
                          '83239','99344','99639','92146','76843',
                          '52533','29310','81258','49551','93074',
                          '85383','46182','19329','74408','95001',
                          '67564','10917','61975','74437','71343',
                          '83191','36948','14376','77632','30789',
                          '61889','75141','57277','19251','32101',
                          '52563','92868','80749','57683','68767',
                          '10271','41751','78976','47121','22989',
                          '81474','60557','48443','92648','52303',
                          '86245','35496','71681','80808','22510',
                          '21897','29975','92667','13026','13820',
                          '52712','49840','54968','68582','28007',
                          '96172','43783','71290','77914','55180',
                          '79085','42017','98510','31804','11623',
                          '56523','78008','56906','34812','91831',
                          '32038','52472','28253','91898','30148',
                          '88028','20790','12293','51635','93879',
                          '80779','28489','20099','35694','94998',
                          '73302','30126','16767','45510')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


