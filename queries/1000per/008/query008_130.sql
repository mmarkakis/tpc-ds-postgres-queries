
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '47201','64654','91811','45173','70455','48232',
                          '64243','62788','77607','55415','15446',
                          '76231','50964','14699','85681','35315',
                          '61888','61701','96102','10646','23703',
                          '28128','27177','33217','82260','38615',
                          '32497','22510','85828','64192','65627',
                          '29672','35194','78419','50445','67469',
                          '21219','70299','94504','79796','97588',
                          '55176','14061','25185','95879','42210',
                          '89193','44132','82434','31375','48284',
                          '50182','84319','96461','52857','38407',
                          '79314','64905','94383','38304','81802',
                          '50517','92585','82907','13046','98750',
                          '73133','62985','58484','60114','83521',
                          '53135','70813','24400','92675','45044',
                          '12110','66627','42895','28730','59913',
                          '54583','65318','69381','99887','48015',
                          '64855','34894','36146','77440','25869',
                          '60453','12835','22531','57345','14135',
                          '25483','85247','14555','13804','13926',
                          '39325','31873','68118','36099','60321',
                          '53024','98691','28455','28747','31868',
                          '76406','38731','27929','89991','72098',
                          '86998','85373','54891','13873','48837',
                          '52065','12931','69210','64051','22454',
                          '89498','11778','53982','94748','35085',
                          '66184','99642','29745','50104','96286',
                          '68544','53034','86262','69929','10356',
                          '93097','66304','27260','75892','10489',
                          '92005','89407','69438','62180','69125',
                          '36376','37626','48251','33776','98192',
                          '41356','24324','46189','13417','75920',
                          '27241','25566','94320','85297','66104',
                          '29863','12813','56078','99536','63950',
                          '68771','38616','86586','84193','18232',
                          '56278','79774','44482','13136','24204',
                          '24988','43108','91449','94971','66563',
                          '58637','13699','61504','71912','63006',
                          '38727','31579','88066','33614','88522',
                          '55754','14496','14968','49206','21530',
                          '21903','81787','95342','87811','86938',
                          '63058','21834','40101','59687','12785',
                          '80582','69879','95747','40365','99127',
                          '22043','18954','74239','37686','59353',
                          '42793','22809','59387','61685','88807',
                          '34612','23196','49739','70022','87300',
                          '46720','41712','79926','62308','43984',
                          '24131','74856','86939','76917','55674',
                          '67813','41101','65462','36461','39946',
                          '45486','90081','96279','61523','41498',
                          '82961','93258','69441','26905','65119',
                          '51619','64839','39616','44250','11441',
                          '23972','18598','38183','17021','33196',
                          '54685','64652','82166','35203','95252',
                          '32748','86222','22240','43495','86684',
                          '63770','33904','75741','32902','33082',
                          '73365','13632','82858','16382','56513',
                          '15663','85278','62286','64778','25381',
                          '84806','80302','93517','56985','99081',
                          '58744','44423','81834','23937','62440',
                          '62339','46405','39889','45635','38873',
                          '53515','48324','71701','51323','37388',
                          '83169','81991','31902','27590','96436',
                          '90490','48190','10711','52451','89042',
                          '19536','68786','46339','25846','20762',
                          '48552','38216','77684','97869','85360',
                          '32645','45149','19808','84756','80870',
                          '22796','69832','50513','33018','52270',
                          '88248','28178','79095','28353','15128',
                          '52112','23295','16534','70380','41806',
                          '51827','74538','21610','69624','13918',
                          '97809','50322','79572','27714','91696',
                          '38632','80610','99029','46752','15394',
                          '46825','50930','89088','53473','53254',
                          '47904','50782','32884','16981','40779',
                          '39948','45262','48947','25070','20110',
                          '89050','71940','12183','98479','27692',
                          '18076','37896','44987','84334','38948',
                          '45290','79670','16973','95093','37102',
                          '82919','41576','57471','45735')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


