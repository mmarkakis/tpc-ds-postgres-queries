
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '31187','88757','24066','52662','64490','89372',
                          '12021','49725','30414','55448','88670',
                          '23780','12228','64343','94114','99279',
                          '22401','43770','70969','73618','78429',
                          '73138','65500','48363','23601','38158',
                          '17338','76756','16617','95967','58657',
                          '93626','63056','96246','74165','71881',
                          '42763','56268','46043','90577','56047',
                          '39355','84021','73874','66149','50522',
                          '96378','55170','65413','96645','27723',
                          '30067','38010','13250','62296','74698',
                          '68952','87748','41776','69373','43254',
                          '42179','56824','66332','20564','81558',
                          '18191','81721','83170','78329','28059',
                          '44118','16619','58429','29577','27984',
                          '20266','85107','30924','59744','81239',
                          '55375','62486','33535','85304','65448',
                          '87941','15269','91354','45804','13237',
                          '80441','30288','70767','42212','36833',
                          '51357','14488','96976','36580','50255',
                          '87620','10536','23910','78839','63820',
                          '17233','76862','63635','96668','41320',
                          '37544','17315','68843','12792','83225',
                          '59994','40336','39717','94562','66977',
                          '34943','25762','85197','39369','88885',
                          '68526','40715','48010','72160','57290',
                          '95433','41017','58358','71956','42844',
                          '57428','41945','14540','85113','77948',
                          '68383','21772','89244','23876','37473',
                          '77828','97196','17907','68724','71604',
                          '30611','81624','40345','97408','82135',
                          '61029','81117','71746','24065','14953',
                          '75361','85176','32312','66000','93931',
                          '94997','14334','36300','75691','76147',
                          '90461','68281','19011','96936','85407',
                          '20638','50431','71084','27708','80702',
                          '59988','12423','86498','90026','19374',
                          '43571','13358','97589','34099','27854',
                          '54724','98058','18777','44400','65336',
                          '58268','44472','35981','63959','71853',
                          '94784','99177','41718','75971','27718',
                          '98866','84598','39879','58414','96298',
                          '13099','95082','80274','65492','88890',
                          '38693','44189','53826','32321','10480',
                          '28007','95555','40909','96624','10640',
                          '52772','61881','60650','90376','64512',
                          '45563','29175','52775','75320','92605',
                          '60657','87383','89452','47029','85060',
                          '60788','44734','20328','64718','29283',
                          '10716','56881','46144','62217','58649',
                          '48423','53142','42027','55621','30796',
                          '80710','45549','41024','14744','76312',
                          '68041','86686','91343','31587','68953',
                          '42545','90331','40987','10615','48552',
                          '88542','98706','43291','10086','92038',
                          '95618','59912','35734','54031','80590',
                          '77163','44401','29615','42452','35049',
                          '95286','78541','48421','52708','90525',
                          '13169','45300','27288','22618','99573',
                          '62366','52919','83182','13012','38226',
                          '23015','53650','96384','74177','97488',
                          '97703','77131','72231','54377','48841',
                          '50458','34497','68034','17284','28520',
                          '74341','20086','19431','40739','67442',
                          '33724','24463','48889','26956','36625',
                          '94563','54063','14514','68142','79042',
                          '14317','92005','21307','96187','26079',
                          '78626','49823','58055','19640','25316',
                          '36895','62772','93996','47649','96720',
                          '22486','26015','51552','59054','75488',
                          '12626','71504','73819','84049','20032',
                          '28351','21204','42877','64661','84744',
                          '93683','43936','24042','98125','45993',
                          '77982','63805','45089','49693','58408',
                          '77938','79879','26140','76956','67521',
                          '92598','50915','87539','65014','24652',
                          '27604','50263','53603','21132','36507',
                          '23183','16425','75956','16639','74496',
                          '75477','35256','24068','72375','85944',
                          '11680','42596','90840','66665')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


