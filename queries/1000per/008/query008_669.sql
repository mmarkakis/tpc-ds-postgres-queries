
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '69598','99615','49228','43663','21275','44721',
                          '29647','59390','73738','61252','90492',
                          '47639','33844','28441','30193','36315',
                          '43706','70439','55977','78240','78349',
                          '28954','28700','63078','36297','53020',
                          '91809','31400','76835','27585','35417',
                          '41462','66466','74217','85057','64045',
                          '82728','16718','60962','94120','42177',
                          '94471','54434','97899','78210','91689',
                          '61789','36246','38125','75138','82367',
                          '11632','21781','59718','71117','88157',
                          '87100','55155','81898','59384','60568',
                          '60161','30333','35029','66619','47967',
                          '91311','76244','27391','75766','36817',
                          '79526','34398','96891','67355','45426',
                          '94504','56047','93156','27881','69383',
                          '32818','45968','98493','94333','73123',
                          '34033','16395','96375','43950','68282',
                          '45041','30360','55861','41082','94605',
                          '25065','11732','70284','67404','36616',
                          '67278','90955','39607','76355','11993',
                          '33589','58670','68578','85473','92408',
                          '18165','10764','88502','36065','80595',
                          '57372','18660','87363','31671','22137',
                          '69635','66661','15679','77332','48798',
                          '33975','86460','20352','63678','26809',
                          '66132','15723','54979','10735','37368',
                          '86652','12220','81591','59901','31684',
                          '21044','65257','65595','69772','58215',
                          '44112','50964','55978','66034','19024',
                          '72415','98772','28102','53956','95577',
                          '90975','98416','65958','34336','95253',
                          '93493','64381','67312','89643','58796',
                          '93972','25216','43514','79988','36368',
                          '23848','50179','49606','38397','23674',
                          '34062','85511','54875','29531','33272',
                          '69391','22518','69242','26211','81350',
                          '37356','99556','63419','97326','30705',
                          '93932','21771','90387','94844','76624',
                          '99401','79804','88141','34278','86992',
                          '95869','23149','32560','78272','45522',
                          '80035','32030','70061','97191','61228',
                          '75637','28255','89647','36312','52851',
                          '48172','23661','11325','29912','26665',
                          '71241','12034','49027','49332','27900',
                          '63801','76465','63002','49342','87439',
                          '41217','12933','44502','15452','94172',
                          '45542','21646','61283','53741','75517',
                          '15781','59427','55980','97852','31073',
                          '93545','28666','90269','54082','29293',
                          '25046','75170','90185','61744','15459',
                          '61295','10155','22501','19528','16586',
                          '93574','17605','52266','98565','45518',
                          '38438','91844','92455','69202','14288',
                          '74278','97621','46029','78497','75185',
                          '69571','35154','92268','85135','86659',
                          '36797','23615','24172','53500','24605',
                          '62124','68447','93668','76291','18127',
                          '18555','89142','28846','47373','74604',
                          '46928','70018','27195','40959','66151',
                          '40569','25025','53347','92228','24138',
                          '35372','33067','19571','33662','92285',
                          '48949','81682','41618','37318','58038',
                          '80638','70079','36656','87481','29926',
                          '33193','38168','46464','40372','16056',
                          '77809','11517','50792','46580','29994',
                          '64163','61316','14010','41403','11207',
                          '92883','55508','19911','93548','72511',
                          '37648','26468','81625','90898','57028',
                          '97419','41331','98819','79939','26059',
                          '19654','66201','72284','91848','57434',
                          '92252','13169','66631','25742','74480',
                          '94446','71732','41872','96877','89713',
                          '69099','52735','96575','12783','19820',
                          '33808','38569','66666','88323','38933',
                          '32901','34764','25539','47109','39280',
                          '96904','66323','48255','22887','98549',
                          '45805','45009','53370','20461','28716',
                          '15960','19854','55276','28379','38820',
                          '73651','29766','47876','99192')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


