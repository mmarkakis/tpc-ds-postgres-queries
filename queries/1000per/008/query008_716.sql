
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '50009','25301','99631','89894','55574','72381',
                          '86091','74977','62742','55664','16775',
                          '52959','61964','41293','97255','38635',
                          '86032','45023','53690','98249','29747',
                          '30321','79329','10131','59868','51456',
                          '94731','30209','80097','20869','85767',
                          '39519','21290','36366','97097','80374',
                          '14651','26027','80647','19897','54344',
                          '26350','78795','93585','20854','35375',
                          '17643','17711','78476','83280','15246',
                          '71704','22854','93488','43802','29801',
                          '16631','71943','28304','50148','46967',
                          '68945','83086','51622','84858','44591',
                          '14574','38881','25443','40525','47824',
                          '21493','95223','85765','85015','10072',
                          '10037','31271','25820','64924','61912',
                          '11255','29146','30613','32601','21584',
                          '27659','99409','61578','29709','84791',
                          '81893','62879','86461','47015','66892',
                          '42692','20084','81925','28559','28291',
                          '17296','43863','14309','71203','20505',
                          '94317','32151','31974','39269','62550',
                          '80260','98867','76810','78441','48155',
                          '45309','68649','84606','84653','17804',
                          '84509','97842','33489','49608','78480',
                          '89692','78188','14647','69663','27493',
                          '56041','36064','24918','38729','40769',
                          '95609','86839','86835','75424','69812',
                          '66820','43838','22152','21453','98875',
                          '40214','93087','96287','66533','40423',
                          '64140','66947','99706','77311','63894',
                          '30599','27687','29844','52661','88905',
                          '92200','59207','28408','45430','15649',
                          '97424','46156','87158','74344','80703',
                          '50309','96352','40650','79547','42723',
                          '36981','41217','11064','48930','11156',
                          '20427','16209','92481','95978','34405',
                          '31123','84511','36847','15866','45800',
                          '24204','42507','59333','58814','70513',
                          '90539','47724','94094','48490','20840',
                          '86902','59817','74050','40178','32441',
                          '34988','57050','36818','92743','21960',
                          '89240','21628','46667','43044','14836',
                          '56212','57856','46618','53680','18697',
                          '93936','90438','91715','87004','45449',
                          '15279','41674','10015','63161','76805',
                          '43610','86001','71785','49832','54249',
                          '92506','43316','10628','69832','78358',
                          '94957','89921','16545','20541','67110',
                          '93621','41975','54955','90349','38200',
                          '31368','71198','43598','15922','70185',
                          '18651','87820','46613','60487','17902',
                          '42432','26082','80386','85615','13201',
                          '74843','37249','67322','74374','19899',
                          '76504','77532','84383','42213','64392',
                          '24968','43481','72121','19817','18369',
                          '56649','85580','88764','39320','69264',
                          '68581','92789','30851','64812','93793',
                          '37427','62141','34695','32353','85324',
                          '86779','78454','86031','62008','80723',
                          '79931','13982','37760','61523','23175',
                          '82855','14625','94895','60901','36505',
                          '28549','83475','91628','53624','20866',
                          '38331','27909','31553','68644','82950',
                          '10000','93691','50037','47309','62431',
                          '68808','94546','54813','52472','84413',
                          '62759','88427','22571','13557','80697',
                          '43339','67329','42270','81626','63490',
                          '55952','70852','39502','76832','41159',
                          '88883','54144','77806','40163','72419',
                          '17905','38075','16599','56884','61369',
                          '51101','59456','64108','73859','97669',
                          '20542','86692','74012','71951','94947',
                          '29713','82459','79126','55094','62534',
                          '41466','27783','83030','14065','38303',
                          '35927','30137','73238','62114','12345',
                          '84057','68235','32195','61133','34063',
                          '74983','56988','53596','82431','45896',
                          '42620','13188','24132','17585','48570',
                          '52633','54377','54986','44248')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


