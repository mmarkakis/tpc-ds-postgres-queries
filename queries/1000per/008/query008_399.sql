
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '80898','68569','52333','12215','31820','15190',
                          '81179','79680','72329','67515','32770',
                          '21783','56356','28446','51433','20502',
                          '71191','39246','76298','97006','88305',
                          '65135','62549','40700','84662','57471',
                          '96361','62708','54516','20857','35376',
                          '12140','13319','20528','23358','26763',
                          '41024','66183','57869','62416','29786',
                          '31140','58109','16546','34078','37799',
                          '81089','44621','69467','26370','18950',
                          '45958','45617','20891','34278','78347',
                          '76645','54066','92557','57535','24969',
                          '49582','38243','17857','35458','22371',
                          '83334','75138','81470','77470','21263',
                          '43417','43142','32757','25090','80500',
                          '63061','42300','29026','21775','98518',
                          '22266','18460','50587','21649','93330',
                          '94451','24584','89461','12886','33819',
                          '14022','74641','66370','20252','94605',
                          '88173','16775','94119','89830','59648',
                          '37061','22213','17046','87125','54925',
                          '88247','30745','67736','85710','80728',
                          '12937','78361','99952','64267','68315',
                          '93612','19132','83123','13098','50390',
                          '10376','54202','82698','57792','70160',
                          '90677','35727','14336','10669','78835',
                          '71344','95333','24480','22022','36803',
                          '49738','42526','47593','92584','51353',
                          '27765','68781','57359','45171','42639',
                          '57098','10650','16778','36498','67870',
                          '47928','82395','60329','19034','30567',
                          '70870','22769','51269','56579','67006',
                          '82514','48254','30559','28200','50430',
                          '79545','45674','87324','24425','22326',
                          '53924','99763','57172','37564','25341',
                          '38202','32980','98630','10112','61518',
                          '98162','21281','31882','98275','65751',
                          '31123','41307','39901','95035','56937',
                          '85814','59592','57630','55825','49901',
                          '13267','25682','41102','98296','80331',
                          '83880','47489','36295','72377','60762',
                          '58405','47532','39541','69990','85112',
                          '53816','49228','64532','51858','62187',
                          '91574','88630','80332','10012','43122',
                          '51304','95590','47835','68421','44631',
                          '50968','71439','26232','94827','82969',
                          '67972','20985','63098','78808','67609',
                          '81236','13027','92970','35718','36962',
                          '72157','89649','61778','61615','77028',
                          '70065','75925','32546','59906','39406',
                          '59290','34640','32792','84731','44229',
                          '62404','69303','78325','19488','68190',
                          '10206','25432','29716','20743','16346',
                          '84075','59345','92177','51704','83202',
                          '63704','18427','47759','14137','44342',
                          '58633','76228','74212','50949','90762',
                          '52865','54097','85635','83426','39488',
                          '74756','26794','90908','69573','91846',
                          '44475','74470','70931','98745','83418',
                          '11828','84335','94261','58114','10535',
                          '39591','23163','71139','98358','74367',
                          '25041','58389','72745','56295','23355',
                          '61888','73685','84737','80610','63811',
                          '67150','17668','96120','88846','71669',
                          '60353','52902','65682','80290','62130',
                          '18845','71247','89835','12918','97753',
                          '58119','70129','87791','60098','43491',
                          '88415','71310','11465','72142','35296',
                          '50734','17029','28454','61771','19865',
                          '44392','55976','14423','83481','35788',
                          '51144','35916','70212','72469','18070',
                          '76286','19642','57316','31365','28681',
                          '29493','20291','54546','45131','97666',
                          '70090','26737','13135','24320','70862',
                          '74776','60112','64353','13040','62025',
                          '78533','92662','97769','82337','14036',
                          '20731','89208','93439','32414','46415',
                          '68269','40019','97262','75376','44474',
                          '14541','13995','38903','29645','77592',
                          '30747','22985','34607','19218')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


