
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '94155','37148','33359','38769','16297','67346',
                          '51990','64851','49208','33814','32074',
                          '93658','63796','12314','73182','20412',
                          '87930','43637','65478','95446','82392',
                          '69957','15358','74487','30545','53101',
                          '73434','60279','81798','92068','90783',
                          '79271','49743','85390','90544','19989',
                          '49125','38289','16945','17219','77106',
                          '49400','95444','34365','83275','73735',
                          '73274','85041','19043','55578','27317',
                          '63436','96460','67803','87079','50384',
                          '52365','34361','35835','60397','17997',
                          '58076','17549','99146','64675','26286',
                          '44724','61756','79093','62247','51356',
                          '73129','24414','56421','32323','30580',
                          '20401','52813','11827','77372','42102',
                          '95425','60719','80026','55011','79440',
                          '34043','30735','41351','29085','55661',
                          '93490','79580','56159','21548','16582',
                          '86081','67529','86779','73030','87503',
                          '34855','42396','86468','50270','38160',
                          '25635','32607','66196','72162','93937',
                          '21330','20030','79460','57328','10574',
                          '43805','19762','78549','92213','39339',
                          '41043','87624','80563','87743','12594',
                          '14763','93630','91615','73498','26846',
                          '52627','60827','48103','97034','85215',
                          '87239','52433','90194','29650','86129',
                          '12267','18033','86453','10836','19411',
                          '99440','90385','50867','82826','69450',
                          '79995','20667','74123','90332','32666',
                          '97476','97003','55084','67108','61137',
                          '63005','97088','75975','44676','74820',
                          '31436','95082','67085','79125','85579',
                          '57561','36748','39974','96033','77101',
                          '31142','58804','19068','29505','67776',
                          '81187','88104','42567','70351','43508',
                          '29482','69441','99028','46946','53692',
                          '52193','74293','82527','86100','12008',
                          '54361','18038','61099','89322','32976',
                          '14162','62037','46498','15498','26802',
                          '89014','28722','76175','71261','91858',
                          '17750','40107','21276','59464','43555',
                          '22802','69232','45482','31321','51544',
                          '81643','16787','44126','83404','94458',
                          '60353','56563','29387','62877','50194',
                          '86396','86770','66511','18017','66605',
                          '24585','41089','29912','10909','61045',
                          '38352','76687','91398','36543','87755',
                          '46417','55453','82983','82788','30351',
                          '38574','56767','47036','76853','48506',
                          '22654','75363','98711','22973','30618',
                          '56341','28537','89495','12101','17916',
                          '15631','23473','15047','31721','92418',
                          '46050','19686','29099','15645','56020',
                          '17243','92848','71681','36885','77155',
                          '46544','14832','11559','41439','26863',
                          '70918','14522','72988','51083','48157',
                          '29574','91749','61186','28459','31968',
                          '41645','53721','82220','53730','43735',
                          '55942','85938','20825','49534','19495',
                          '38293','29554','67597','78722','81275',
                          '68339','25983','53680','39143','32130',
                          '92512','56474','51882','92968','86913',
                          '82530','45585','98537','84016','96637',
                          '27362','17695','70102','93084','70595',
                          '28002','97865','90036','66465','34340',
                          '65652','37761','73675','68462','95543',
                          '55327','61588','45935','54846','67623',
                          '75786','59109','15423','94973','50404',
                          '49379','21836','35946','36227','19517',
                          '62210','17001','15024','51916','26040',
                          '71216','84805','53166','50022','17350',
                          '41878','10621','99894','51158','88191',
                          '30350','31841','49919','82131','94340',
                          '79990','67262','37967','98022','89738',
                          '65391','11000','58075','90346','49794',
                          '84479','62460','15676','85839','62805',
                          '68363','66048','81688','30520','19401',
                          '99753','14228','89695','61271')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


