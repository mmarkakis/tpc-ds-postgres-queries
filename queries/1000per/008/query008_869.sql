
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '39105','69910','63672','21864','75128','58364',
                          '44095','48346','50475','96813','42179',
                          '64758','94499','73878','87115','67911',
                          '34268','89381','81461','45116','78746',
                          '94681','81541','93698','64010','26020',
                          '37010','79543','27092','88115','78744',
                          '20832','93551','62644','70513','93358',
                          '63736','81291','20013','60105','53384',
                          '61070','57224','95349','73527','45538',
                          '27336','94626','48564','47603','55740',
                          '79469','39540','85403','45455','17573',
                          '80047','71156','28727','36282','52876',
                          '99349','28162','70846','80770','16269',
                          '78841','50012','89740','51265','77821',
                          '44194','75302','30493','63462','69778',
                          '66629','56322','63707','24316','41727',
                          '38146','41943','95682','15262','74371',
                          '15623','99213','14193','26167','97092',
                          '28405','42897','43940','30114','34620',
                          '22004','95173','96708','54793','77803',
                          '44943','18649','57132','58582','67318',
                          '57024','45253','79424','70039','95756',
                          '93898','11873','32096','55069','40575',
                          '46603','10604','46394','98720','48286',
                          '62075','69127','96594','91212','17140',
                          '73582','25416','74410','70635','84254',
                          '35891','46013','33409','85125','59605',
                          '52529','55461','63029','57722','39352',
                          '95055','91788','85387','67267','24867',
                          '44579','50233','22013','36990','28276',
                          '54602','96162','53990','29993','89040',
                          '70596','82577','34482','13421','35100',
                          '99523','83520','30505','33326','55324',
                          '63034','62371','10805','92170','95552',
                          '32963','23973','81363','86517','54026',
                          '11308','67186','11187','81772','66204',
                          '84273','61869','26365','16374','90828',
                          '58987','79073','67720','34583','69808',
                          '28753','33240','55302','71493','48517',
                          '16018','77082','94563','31890','68047',
                          '11145','37171','84515','13909','76227',
                          '78555','33588','49954','26254','90325',
                          '35821','93127','85532','31499','86843',
                          '13447','84168','89027','86107','95270',
                          '13031','40540','85578','15996','25689',
                          '61297','82459','25312','48081','31927',
                          '68138','95595','36195','45242','37771',
                          '84680','32945','97103','98006','10075',
                          '71975','31545','27055','53027','66568',
                          '35991','78315','85718','77645','25161',
                          '63658','30768','44116','11528','83409',
                          '28882','98344','50302','61915','46044',
                          '40627','46875','32256','57423','94384',
                          '51724','52467','65560','28771','88593',
                          '82229','16924','58966','21561','96667',
                          '66763','48348','38564','15726','14492',
                          '45203','93879','93587','32552','63326',
                          '79421','20993','21090','27851','54454',
                          '34789','13229','92792','31403','10408',
                          '43202','27193','71011','14985','75293',
                          '95330','94783','43885','79276','23505',
                          '83898','10222','83502','55103','93100',
                          '96734','42538','27458','40894','19950',
                          '77663','23235','95024','54739','12607',
                          '66236','55763','20664','92652','62568',
                          '96467','71017','18581','35800','88196',
                          '50914','12224','13776','37039','74163',
                          '39614','27740','91128','65378','16781',
                          '73640','99920','56097','81423','51372',
                          '11330','79940','33063','83422','52322',
                          '56559','56851','61629','62622','75535',
                          '41764','87511','82878','23569','89419',
                          '45742','17150','73574','93490','25268',
                          '44708','75226','57758','61480','30894',
                          '10274','49133','86111','83596','56896',
                          '25623','16257','28644','36784','17697',
                          '63958','66200','68128','26224','43688',
                          '42864','71153','87136','71151','76817',
                          '79312','50706','41023','10557','78795',
                          '82418','50907','35458','66815')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


