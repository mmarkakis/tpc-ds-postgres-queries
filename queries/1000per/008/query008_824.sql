
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '32747','39825','82100','50189','27894','22075',
                          '44380','90913','57722','60791','37446',
                          '22670','90753','26992','95639','11931',
                          '55705','80437','34240','58395','78456',
                          '42486','62122','43604','96480','91680',
                          '73739','32722','25117','44126','43917',
                          '93341','94620','39382','80335','39727',
                          '17818','61768','72164','50698','23419',
                          '90288','78453','43988','16248','69362',
                          '28946','57902','51430','12869','73718',
                          '86807','78783','84402','65272','21421',
                          '42373','98903','32316','79368','35644',
                          '17201','15722','44513','33507','11441',
                          '57387','67661','88154','86832','18265',
                          '36920','87975','48486','60504','70519',
                          '24822','76913','24373','27752','77952',
                          '98464','63130','37770','32185','33346',
                          '61661','31963','23240','24015','95343',
                          '94452','98579','42698','70065','97261',
                          '70690','46098','81965','76002','76211',
                          '81143','39791','65467','67342','37490',
                          '62881','82645','78165','69674','98347',
                          '89627','40273','62250','71907','43501',
                          '99092','32190','63299','30290','96824',
                          '94519','12851','17980','12247','91185',
                          '45636','55837','87408','55665','34576',
                          '85832','47413','94302','54800','92418',
                          '96149','96759','62203','27492','98407',
                          '61208','74372','22363','83968','45241',
                          '80975','43701','71574','24941','80884',
                          '93592','18278','39855','99066','32036',
                          '12188','69708','69316','86142','13958',
                          '25333','99627','65061','29641','40077',
                          '29076','64301','14214','21868','67095',
                          '76679','61248','24476','24331','63112',
                          '80197','52670','29366','32532','19741',
                          '64457','56892','16577','34340','90943',
                          '58875','41467','52344','99892','79571',
                          '71607','22162','78624','67017','96327',
                          '52140','93597','74925','94195','24653',
                          '93023','31379','62478','69608','43918',
                          '88544','66875','90348','71161','59809',
                          '52328','54754','25819','95069','59035',
                          '19594','29707','58504','31342','53653',
                          '72049','55279','83159','43389','98322',
                          '56845','11783','87328','12069','26087',
                          '34877','18007','43165','25360','46272',
                          '38721','57892','66925','21245','78916',
                          '86454','91318','85623','67910','66165',
                          '78098','86035','24390','63256','28264',
                          '68902','15534','62340','85242','91958',
                          '63588','12018','25458','56872','44643',
                          '47046','45632','63511','22309','95740',
                          '40323','45985','36904','37715','57085',
                          '16358','70301','91488','59676','80663',
                          '99639','93298','34111','65478','17435',
                          '69477','41964','87658','91316','36957',
                          '26369','18728','32871','84127','66016',
                          '29529','67076','31618','28517','19982',
                          '52858','23658','58435','70446','25862',
                          '53435','77212','55833','26130','74325',
                          '70930','42938','74155','43458','32828',
                          '24993','56695','43946','96351','92136',
                          '69909','60986','37719','12764','12759',
                          '98699','29271','69089','43340','49996',
                          '23663','74893','53484','28080','86669',
                          '31945','39241','55875','29505','25616',
                          '68298','59701','22455','77103','13995',
                          '38252','88316','51074','36963','23802',
                          '72956','99149','18723','17282','33182',
                          '17596','24055','83991','18943','44117',
                          '16544','28596','73025','75665','12720',
                          '94469','49776','81610','11857','30280',
                          '67644','93452','10357','68039','42895',
                          '52909','59457','50367','57641','82958',
                          '47988','23499','55433','29417','27685',
                          '11232','51963','14968','39914','92519',
                          '53245','96996','10603','55972','42262',
                          '92286','58778','68349','70904','78619',
                          '20629','68193','43463','83109')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


