
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '85477','10221','39757','24757','74320','96771',
                          '90098','96384','82381','67669','67902',
                          '33682','83430','30043','97893','75776',
                          '59504','57545','66646','51464','44901',
                          '26792','54964','58185','88212','97202',
                          '44942','81598','68785','30685','21346',
                          '69707','23505','95958','34736','93247',
                          '12182','16790','10424','74583','77633',
                          '74185','65900','70731','40936','21874',
                          '20046','47361','60055','86428','99980',
                          '36438','60062','95294','55689','48119',
                          '61450','57050','84602','52433','20403',
                          '58647','28340','10821','93613','32724',
                          '25274','73095','35484','76877','79024',
                          '53558','10425','40795','92840','33530',
                          '63772','22309','28684','67491','83853',
                          '72863','23200','10208','82384','80972',
                          '37859','59055','69267','19508','97915',
                          '48616','68120','28167','67878','15837',
                          '54394','78039','42756','20922','41622',
                          '42593','86751','63467','12599','64242',
                          '89799','91396','99612','77116','58068',
                          '45022','86569','48299','43068','76292',
                          '68066','60611','35057','96231','95166',
                          '13106','13167','52903','19349','63035',
                          '18945','26667','56794','22817','99189',
                          '98491','28770','34212','78037','43872',
                          '69982','68178','70408','88970','60592',
                          '49011','52679','19964','13782','70038',
                          '95631','49852','15855','77128','57847',
                          '74433','42375','82568','55279','42659',
                          '15857','69104','47404','86536','15963',
                          '76211','30818','82894','92273','38775',
                          '17004','26748','55151','75763','39453',
                          '34826','41568','71714','36609','88120',
                          '85154','90501','45216','71562','94057',
                          '77355','80209','66070','21056','64412',
                          '93745','22041','51194','91014','27353',
                          '54601','80780','11186','77463','93738',
                          '65608','82441','35984','23604','49184',
                          '33877','48768','24883','58574','13632',
                          '60413','55082','44420','37729','45974',
                          '39863','87928','42319','78674','94830',
                          '30833','59572','13332','19545','61276',
                          '40021','77450','13542','28452','10835',
                          '91243','52953','47156','37335','23853',
                          '82832','15023','28380','80824','21204',
                          '99035','19400','70361','44082','10796',
                          '94189','79713','21156','53178','91061',
                          '12397','80315','46109','32011','97099',
                          '17166','42002','61420','59499','18849',
                          '65917','29686','60052','28929','44684',
                          '94820','88823','81698','32837','95342',
                          '40107','71376','66784','29122','49607',
                          '94384','44222','41940','47982','25792',
                          '97404','24206','77827','49165','25140',
                          '16038','50811','11129','34050','34519',
                          '57753','77822','19775','75225','33374',
                          '93869','58298','70827','84480','79534',
                          '86156','61142','96861','35349','99486',
                          '74960','26426','19702','34549','97621',
                          '85485','71046','58829','54629','46557',
                          '66765','19799','41855','10591','41732',
                          '52411','23279','30995','24693','50262',
                          '85071','77719','36133','37527','84658',
                          '27733','83511','65166','65498','61011',
                          '81318','62826','84619','79641','59441',
                          '49828','48658','38597','21960','88581',
                          '47744','23892','90062','19679','90965',
                          '86972','30886','42927','69490','49635',
                          '35765','12860','17354','74391','55854',
                          '51485','72148','37331','79961','94400',
                          '70698','41826','42153','47851','95782',
                          '65655','69043','41981','67809','63242',
                          '37176','72425','44678','36878','14095',
                          '56315','14557','24893','33913','50001',
                          '18323','92560','61806','23605','16088',
                          '19245','84414','18673','40880','61111',
                          '93171','95609','92896','23126','46009',
                          '47939','29409','80286','10013')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


