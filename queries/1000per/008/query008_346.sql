
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '75302','70763','42633','59369','76219','79621',
                          '32457','16224','54735','39550','42367',
                          '27637','90443','29371','43619','59811',
                          '33951','35879','52573','34741','23164',
                          '33717','13936','77835','38108','90661',
                          '20600','57349','19367','28109','72109',
                          '96257','70472','23247','74410','21415',
                          '90857','45177','60761','31376','21188',
                          '47621','89179','69199','80446','41070',
                          '64114','39965','21982','95733','41464',
                          '64932','17714','45971','95543','65890',
                          '13221','85298','56895','68505','29535',
                          '97960','33298','45910','26519','60116',
                          '46595','38191','59134','96846','83924',
                          '56198','67093','56864','72616','17126',
                          '58827','72316','38298','88616','50570',
                          '66713','31793','82314','25975','22225',
                          '88829','11739','77272','34071','88035',
                          '92703','87293','80507','78926','89148',
                          '76308','78778','86710','30922','20437',
                          '53131','10147','22149','68963','35675',
                          '92148','83355','55162','15526','42399',
                          '64946','23276','77586','97508','56856',
                          '42850','64702','45942','45676','66586',
                          '48778','48987','94813','34174','66615',
                          '70752','75825','30608','65193','70968',
                          '93571','95036','60939','87586','60548',
                          '45750','74441','15831','44447','74466',
                          '12668','19793','98174','48684','10975',
                          '60264','53926','42148','93390','26229',
                          '18622','25929','54407','41500','46743',
                          '73675','40482','66555','68984','35172',
                          '61731','46986','22387','35233','69635',
                          '84222','44209','67585','80338','41285',
                          '10799','82717','62326','55639','87860',
                          '91969','72599','61907','38870','93402',
                          '80532','84911','50028','81581','77054',
                          '90349','22893','24935','20518','79444',
                          '88148','57415','49380','97856','89635',
                          '14073','94915','92937','59279','28138',
                          '53034','58645','91875','38054','18617',
                          '79741','66026','14392','77040','11251',
                          '65459','11726','51073','16514','96694',
                          '41981','61454','86223','92990','66960',
                          '27284','27814','57631','85145','97451',
                          '38048','54129','38035','51531','33984',
                          '22312','87316','32732','70602','27346',
                          '78985','10727','70593','15434','23001',
                          '92724','26374','34770','74768','75278',
                          '67598','54147','95734','62087','70455',
                          '56060','73058','61461','15960','34408',
                          '62507','32057','74967','16897','19263',
                          '19785','45918','97782','21854','83195',
                          '39524','64617','31018','62027','69585',
                          '15614','36334','36089','96974','47712',
                          '18972','24702','11198','76874','63554',
                          '73102','93771','68073','68553','20312',
                          '59076','22852','67899','38980','42210',
                          '59644','38758','15778','66537','87277',
                          '87874','20805','20727','57841','68160',
                          '92325','67522','52449','78037','46392',
                          '48803','37024','60806','46873','12729',
                          '52290','63687','71340','78109','80940',
                          '66857','80218','73020','66842','53781',
                          '45110','91396','65859','74241','19362',
                          '62280','16187','22415','56327','52748',
                          '21618','77405','57714','21500','18743',
                          '14286','80239','36103','19418','55359',
                          '46694','22263','77940','79611','83110',
                          '14855','72972','47692','34681','71167',
                          '95134','45883','35770','50880','64326',
                          '69675','62453','41446','63123','95051',
                          '41320','58580','46999','20156','24948',
                          '96994','77052','79265','80006','49704',
                          '51247','10831','67028','59050','58529',
                          '82329','85116','82664','50383','74163',
                          '48745','58249','94108','97853','43796',
                          '13251','61866','96107','95686','49446',
                          '69293','19191','49690','12106','97767',
                          '22939','64642','50325','13765')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


