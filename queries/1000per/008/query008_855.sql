
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '61279','41784','73079','53863','94497','65357',
                          '54300','54694','31635','86366','65447',
                          '58801','27855','22109','40480','60740',
                          '37147','21337','38450','70118','96068',
                          '67017','76736','20797','72415','40320',
                          '53975','46910','22350','17213','12939',
                          '99603','82978','16712','37879','22466',
                          '26014','21635','55151','86878','82286',
                          '95869','97332','61162','37382','82712',
                          '72249','19826','14800','87377','17972',
                          '28717','75905','40481','22603','21380',
                          '70066','93115','46951','28209','15267',
                          '59797','15082','67506','14152','99375',
                          '19865','14862','76842','32108','53277',
                          '25360','85290','93160','39125','53883',
                          '47043','39206','63920','45363','72889',
                          '63090','39800','22417','93353','77857',
                          '93042','39644','64214','52217','69136',
                          '77520','99167','84065','27192','66871',
                          '12283','80567','44438','48145','20778',
                          '42890','40607','34397','97384','83663',
                          '30890','52983','97040','92472','88865',
                          '69394','96058','25468','96949','28065',
                          '94466','53525','16238','46745','12399',
                          '63367','23968','56332','70122','85355',
                          '80752','81292','65948','24443','56106',
                          '67919','88092','34577','32913','53570',
                          '14169','39753','47238','53020','45923',
                          '46683','61671','80197','37819','23145',
                          '72953','86022','61166','45997','91740',
                          '37235','33804','49268','43200','83644',
                          '46955','23252','76534','76330','46815',
                          '75174','47230','73947','49199','28386',
                          '67446','28259','43312','19202','12949',
                          '99852','80135','97642','42682','35275',
                          '92807','48366','72020','39867','83996',
                          '33926','19378','24158','53560','71955',
                          '60557','76592','45968','78016','60242',
                          '68898','38726','40725','77724','65052',
                          '24212','82042','48205','82885','15179',
                          '40689','58581','28831','53927','83913',
                          '34963','50247','10111','99147','77928',
                          '66461','72220','58734','78728','60138',
                          '27503','95819','97816','91075','42017',
                          '63199','41902','86193','88036','85105',
                          '30677','81731','87796','58977','91101',
                          '36961','16301','38913','96951','24834',
                          '91517','10498','10393','39842','51841',
                          '33280','28752','68682','75290','23506',
                          '98895','60493','32819','44812','18242',
                          '46950','95678','22635','90285','13969',
                          '61653','37084','79773','38968','99629',
                          '23370','57136','48874','52952','46614',
                          '26925','18353','44502','50186','22036',
                          '78468','89812','80275','33037','59983',
                          '95310','59203','65442','81846','74700',
                          '81589','57527','45271','80900','60598',
                          '27157','29297','62119','86755','70995',
                          '84258','22869','75037','23189','93870',
                          '61191','98989','51265','10248','79350',
                          '19964','13799','15663','75370','69714',
                          '47075','79748','76698','25791','19219',
                          '94235','23254','14347','45974','47165',
                          '47461','49547','91605','52051','61579',
                          '18515','26033','17408','36466','23178',
                          '41155','36662','58991','94693','96142',
                          '65686','38931','23719','62050','13796',
                          '96332','49639','90472','45359','86541',
                          '12921','90335','55085','75412','61246',
                          '47628','11058','80857','27673','21961',
                          '43953','97517','20585','81616','42439',
                          '38320','73378','94183','83036','51169',
                          '52348','80044','28861','95443','49503',
                          '75456','82558','77016','39305','25867',
                          '28374','21732','33041','79806','29756',
                          '16973','20367','79111','47187','94205',
                          '88701','98982','51505','85388','31329',
                          '98002','47922','78098','49478','58436',
                          '56000','87918','22299','38438','68559',
                          '36875','24206','50566','12864')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


