
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '55755','99292','53164','36468','86006','80081',
                          '90564','23285','43775','32149','85095',
                          '77397','28015','70921','90929','35184',
                          '54614','47676','18555','85585','11262',
                          '65275','22418','89889','63234','20772',
                          '82345','50801','55888','32198','18755',
                          '61192','12225','16102','43705','10103',
                          '83620','59377','38377','95888','60218',
                          '40987','57690','42787','92033','98335',
                          '58045','84624','19215','54513','80792',
                          '26243','40454','53661','33058','77598',
                          '16945','18138','99603','98162','79531',
                          '85637','50932','81403','51804','53955',
                          '54523','23289','81340','45955','49693',
                          '32195','59860','86675','36633','32995',
                          '31888','22424','33470','36462','56142',
                          '70125','39852','77237','54609','82448',
                          '86873','21147','63628','86103','20769',
                          '90149','66535','98109','61896','22908',
                          '44605','76680','89422','85385','55159',
                          '28672','75025','10237','70255','44780',
                          '33879','61076','82642','32969','13325',
                          '72781','55378','64814','82696','52459',
                          '79291','12671','41839','47260','69671',
                          '77154','65615','12391','12642','25177',
                          '48741','45209','52955','24884','81176',
                          '49009','33279','50549','62297','11772',
                          '97550','55859','89820','16070','94849',
                          '57652','13303','69113','37169','25096',
                          '93144','27586','81026','63558','62493',
                          '18181','25511','51716','45731','94750',
                          '44764','19814','46077','72336','95056',
                          '60471','21428','65718','48654','69274',
                          '10698','49246','26074','45677','97173',
                          '94384','96290','31437','26794','22134',
                          '82977','83196','78313','63443','15483',
                          '13859','88521','80761','62835','16713',
                          '49084','18865','82107','51872','97884',
                          '69179','37327','70711','87510','54170',
                          '54294','89221','28176','28279','46995',
                          '43612','78903','16902','13664','40054',
                          '13871','48378','74412','17817','19944',
                          '29309','38653','35673','98532','17066',
                          '21071','45736','90980','46542','20756',
                          '26021','24037','93143','61929','75316',
                          '41204','46560','41269','49352','78591',
                          '21554','49244','56129','81737','35724',
                          '42447','44433','12121','13575','26687',
                          '80159','85101','68597','86045','96805',
                          '40387','29781','79101','87181','50743',
                          '40221','37806','23394','97877','79369',
                          '89114','36834','32887','61257','78080',
                          '25188','61189','35159','86181','67522',
                          '61173','15477','34878','59127','45917',
                          '50654','76200','34233','51632','21110',
                          '45081','15851','80908','49327','25315',
                          '45246','52887','26382','56973','18921',
                          '96954','56366','27958','19669','89417',
                          '39915','29445','99112','10820','13720',
                          '69801','14915','30364','30375','40386',
                          '11067','52092','22508','77357','59958',
                          '77516','26331','93855','75043','75766',
                          '95978','99676','99060','99678','76769',
                          '11213','41009','41925','32430','91848',
                          '41107','53378','19609','27413','70246',
                          '81998','65920','90971','36420','60801',
                          '51595','60418','32379','39321','49248',
                          '12476','74293','77036','90167','57818',
                          '83970','42552','16101','50763','84140',
                          '57696','49900','75349','77106','15579',
                          '75562','11506','20642','57894','56981',
                          '51280','40085','70698','66630','49198',
                          '40866','93433','11911','82422','29047',
                          '88614','19006','33750','92486','75001',
                          '51250','33616','30645','85845','45011',
                          '16434','76797','47882','35106','93423',
                          '44289','63145','79596','25756','30903',
                          '33901','72141','74139','30055','63114',
                          '43591','96293','56392','58227','72729',
                          '49635','87495','18872','43563')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


