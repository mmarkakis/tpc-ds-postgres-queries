
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '65018','42059','73036','35852','22851','35258',
                          '73344','35168','90800','60586','87273',
                          '38501','85413','95740','45670','12857',
                          '27447','11672','40483','76546','87003',
                          '86258','82217','55379','10263','22262',
                          '31119','43827','84901','73362','18047',
                          '20609','52833','30546','59467','92851',
                          '99766','75328','89457','42375','81419',
                          '35201','95340','92649','32549','73116',
                          '10946','24593','17526','12238','68145',
                          '54925','94619','94971','99101','31410',
                          '70420','54811','31353','50585','42435',
                          '56006','36398','98799','68581','83238',
                          '16637','44056','64434','82586','96245',
                          '95123','50694','85348','15395','39306',
                          '56524','50538','97343','28027','59776',
                          '55211','96425','79764','80474','55627',
                          '40076','88371','99642','38004','45807',
                          '92723','79538','91770','43436','57577',
                          '78405','12345','10111','51212','70883',
                          '89375','51443','71816','11635','99697',
                          '79184','55927','14898','67692','42842',
                          '67187','33576','33270','83438','95083',
                          '79319','99286','77337','82399','23056',
                          '58843','53511','85862','66345','29550',
                          '40428','40042','53515','83051','82887',
                          '87342','55710','36510','15938','92307',
                          '30619','92487','39632','68832','34198',
                          '47680','76331','25645','82235','82670',
                          '75091','89989','49211','56923','49018',
                          '26756','80047','13674','16948','75782',
                          '14214','85355','36124','17354','93169',
                          '20966','20971','51594','95317','21878',
                          '61812','32994','73092','99612','95042',
                          '24638','44718','26869','79333','75280',
                          '73995','41216','41574','32010','41803',
                          '98520','73620','91285','65062','87762',
                          '70120','64194','35970','10689','54670',
                          '16138','80240','67352','62795','15562',
                          '87413','30101','10926','76302','46853',
                          '76243','87415','49726','67500','66030',
                          '27339','67525','83205','80028','41150',
                          '36496','47192','10986','46605','86355',
                          '73948','30447','38728','55571','84916',
                          '29966','49413','34253','56921','22342',
                          '36796','94843','86022','16193','77352',
                          '60110','32572','67455','76136','72387',
                          '13141','14906','34505','28007','68205',
                          '93329','39224','95630','81281','14538',
                          '42856','42197','92361','21428','41361',
                          '43331','87757','52015','20019','65225',
                          '11768','61788','24082','53697','27902',
                          '21820','10845','73585','67484','22593',
                          '71038','62387','93315','99058','22706',
                          '13866','95660','66739','19609','48560',
                          '56402','15923','98296','20054','78867',
                          '27681','76472','42812','36084','53072',
                          '60472','39197','89184','82207','93188',
                          '51217','49225','80369','24774','49691',
                          '22133','67574','23794','46625','67387',
                          '73292','80972','88181','10112','15174',
                          '59363','20825','12447','65673','49493',
                          '67897','31162','35231','58286','31086',
                          '10779','69555','16292','15479','97910',
                          '43940','58952','98823','94799','56570',
                          '30118','67639','25479','25718','95391',
                          '72592','91188','15769','21112','54356',
                          '61218','78597','39543','81631','11716',
                          '88418','35721','15912','27315','67969',
                          '19639','61417','69439','78839','21681',
                          '41203','19667','32533','75855','82755',
                          '10668','34025','87976','63239','97224',
                          '70744','89103','40279','65237','50531',
                          '87317','71635','43292','99031','67121',
                          '28507','79463','53889','97956','65895',
                          '25921','96471','54679','18600','39598',
                          '28201','41053','80167','71063','20605',
                          '86056','45819','32245','17493','15003',
                          '86114','92966','21646','52618','79873',
                          '88376','90238','95885','12731')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


