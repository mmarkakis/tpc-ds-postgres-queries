
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '97248','52679','45296','45552','90767','19680',
                          '10203','79738','46813','76650','10215',
                          '44261','79936','29295','56256','74164',
                          '96788','51214','32053','81010','85194',
                          '41198','32690','21694','26576','79058',
                          '64414','66328','70326','37369','97436',
                          '72895','12896','67255','15377','82926',
                          '60982','54299','55408','62895','29496',
                          '69865','33448','69700','89196','87113',
                          '72738','35926','66314','15272','46211',
                          '25315','70944','33800','59236','52101',
                          '62104','28867','37470','41521','26419',
                          '23519','95916','57836','59588','77270',
                          '31083','43394','61855','60453','42642',
                          '25504','60348','95563','88808','94921',
                          '10606','10775','66891','99434','22983',
                          '67512','59824','84674','61527','32309',
                          '98751','99421','70410','77357','96247',
                          '68003','96134','66546','89168','37391',
                          '27432','76285','94835','13243','32761',
                          '75355','67717','57718','84357','94897',
                          '94616','87269','73990','47623','91531',
                          '87215','54955','22514','57299','75889',
                          '70081','38146','16182','26966','22506',
                          '89012','43132','93010','56865','32111',
                          '49440','55368','73216','63984','93308',
                          '28350','77935','34800','77765','68503',
                          '30502','95462','98581','55653','77629',
                          '93900','57975','49542','40720','25450',
                          '39271','62937','98394','53537','37661',
                          '34509','98097','30269','41702','72580',
                          '61769','96401','83339','68225','73655',
                          '92630','64737','18449','66135','54038',
                          '83249','69179','37712','18762','44328',
                          '43636','40508','81275','92144','68595',
                          '13281','91628','51323','46089','39718',
                          '60962','56703','75989','43651','31289',
                          '53292','21454','88942','92377','97391',
                          '29360','33132','51478','95397','26831',
                          '93476','31168','35794','38484','97891',
                          '89777','61597','50946','85031','63520',
                          '79756','44486','14543','66455','42979',
                          '75694','63837','14355','73577','50518',
                          '45483','77868','46334','35357','74931',
                          '92017','72854','51973','44305','65724',
                          '76154','87670','51106','38452','23471',
                          '96059','60739','87156','64101','68653',
                          '57568','96044','97201','20826','98962',
                          '78403','52558','16346','68059','57235',
                          '64767','94644','26238','44252','45491',
                          '72182','37820','44888','52527','28800',
                          '77384','44835','92986','98266','52009',
                          '79112','58279','21914','86109','76590',
                          '78437','43976','58554','99569','84700',
                          '45182','22398','26666','76934','10334',
                          '28160','27651','29098','43981','41183',
                          '11582','36282','65658','90905','35566',
                          '24482','10285','91132','84212','95843',
                          '97963','38513','20327','54576','50354',
                          '45982','22897','75079','16592','70716',
                          '98009','67527','29538','35026','79478',
                          '38036','78956','43325','35353','90565',
                          '66122','35377','69669','71278','39521',
                          '22822','87911','63748','90793','37664',
                          '75482','74976','26440','13517','29044',
                          '65344','21467','83783','47285','92805',
                          '47332','67135','30929','51577','98330',
                          '35232','31027','49760','82786','71872',
                          '55425','11818','66824','58026','74788',
                          '37797','12734','58373','54277','66032',
                          '82875','12072','61359','58954','39743',
                          '33583','97019','33008','76752','86653',
                          '71557','34434','77541','45070','81630',
                          '27550','12974','50049','92595','81348',
                          '37257','65327','71558','58507','84058',
                          '30677','33753','50484','38596','11251',
                          '93521','71355','34876','35948','77523',
                          '87783','71570','72050','49928','88343',
                          '46740','82664','18719','73902','32938',
                          '19958','48767','69133','69239')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


