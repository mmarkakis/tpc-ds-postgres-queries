
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '44905','60515','87000','96580','77137','51911',
                          '62205','56730','96985','97797','48106',
                          '55834','54963','10397','90175','57926',
                          '96914','98353','55663','64915','68224',
                          '97311','22617','56698','87392','90911',
                          '14115','14585','96208','81547','25858',
                          '63286','52882','96418','91373','19198',
                          '54544','19394','30414','94825','54244',
                          '99641','75867','78545','72319','68641',
                          '22336','41522','94908','15824','52648',
                          '84026','69896','56824','57537','15227',
                          '14357','64349','85941','86126','41549',
                          '58861','42390','15296','49287','67556',
                          '15028','75739','64893','11746','32806',
                          '75762','21696','57133','34423','82734',
                          '39614','68189','53039','97641','58324',
                          '93835','84366','32728','62399','71035',
                          '51208','48467','97408','94591','13935',
                          '96030','46452','56090','29702','16676',
                          '96246','16265','45700','28187','33251',
                          '60684','38564','54485','64548','85335',
                          '64157','41400','17341','38785','85845',
                          '40573','36982','14407','20822','70623',
                          '47466','32062','34924','45178','93166',
                          '80111','19894','42890','78208','40575',
                          '61449','80299','39178','48069','61868',
                          '60452','43228','92576','96180','59521',
                          '34701','39532','13703','25427','14756',
                          '70099','28719','38020','50023','91608',
                          '47938','24298','59529','64886','57636',
                          '85874','97065','30183','55631','64757',
                          '89511','39988','65180','13568','36790',
                          '28166','55243','72194','23166','24557',
                          '20347','40399','49916','41452','85185',
                          '46596','13800','79737','53342','99973',
                          '62710','44439','99552','71180','29430',
                          '54289','19465','42445','68999','21444',
                          '43631','10109','92908','20743','44382',
                          '68598','51357','77786','81503','66824',
                          '33815','81527','68466','14445','17657',
                          '50016','63689','82987','34872','47600',
                          '95791','60663','61297','54507','44339',
                          '70674','85232','27705','83554','66147',
                          '24912','97053','74917','14459','15576',
                          '97434','84846','47123','88429','14551',
                          '96192','26006','64452','76475','96575',
                          '38381','14472','97465','88037','73261',
                          '89538','59736','39237','83567','94374',
                          '61653','16604','79543','79475','45479',
                          '26623','51063','51553','51406','92160',
                          '95055','38259','11494','78947','53783',
                          '54709','38746','40567','89427','57075',
                          '44207','17465','38695','11722','51556',
                          '18477','47068','81058','88738','40269',
                          '99394','93480','61479','43601','27595',
                          '53889','39340','55730','21072','89257',
                          '27793','98804','58298','17615','46155',
                          '16530','75924','57289','63662','76804',
                          '35066','71343','81861','24168','88407',
                          '49665','87316','38042','86304','64529',
                          '51420','37013','26582','15122','78790',
                          '16690','74363','82434','33946','42106',
                          '23273','23103','84809','32377','84988',
                          '41143','75215','13559','62686','66643',
                          '70726','32403','90767','30110','29197',
                          '70040','93513','93367','33608','88196',
                          '11894','17215','18943','26937','54147',
                          '86772','97129','14872','82907','29632',
                          '78246','98275','46770','21522','39748',
                          '23815','48301','26731','97487','51255',
                          '75153','68593','55342','66506','90122',
                          '57856','96627','96891','95876','13678',
                          '89596','74509','15005','39273','16366',
                          '62474','86221','82173','52811','55345',
                          '40850','81524','80815','76722','74789',
                          '50054','35945','76297','69795','31423',
                          '20255','82318','88602','46125','28414',
                          '54226','39771','11704','28232','89822',
                          '83731','29215','38660','32042','11541',
                          '19632','25056','27328','87332')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


