
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '76143','36595','31787','24375','88294','37465',
                          '19760','11750','85808','17939','34137',
                          '76185','40831','84867','87313','98443',
                          '99316','75238','65378','38953','11857',
                          '59423','34050','54722','52363','33205',
                          '15020','24464','54951','70792','20114',
                          '35731','47434','36121','26415','98699',
                          '27440','10544','95744','44645','43952',
                          '86346','77790','88422','32077','60172',
                          '98950','17121','62776','65489','92681',
                          '41023','51029','26990','71047','70499',
                          '32259','49555','12397','41135','55118',
                          '14369','59050','46546','64748','23712',
                          '25019','91135','36061','38927','33325',
                          '59549','31002','16268','91292','58385',
                          '89843','14178','81483','18322','84544',
                          '91865','67027','43959','66232','19267',
                          '41418','56347','57148','68545','39628',
                          '93567','34683','48120','26431','97823',
                          '81171','50076','13679','70105','42654',
                          '17649','31324','66864','35573','49486',
                          '88536','74275','29632','21075','54405',
                          '77608','41158','51481','67787','55397',
                          '28019','10430','23682','81938','97160',
                          '87660','83714','29650','90819','42280',
                          '58167','97731','51417','26130','10538',
                          '35517','81851','98673','35196','47301',
                          '41987','14066','39876','38584','49139',
                          '25493','29200','63802','95155','41859',
                          '17924','94547','22501','60709','50691',
                          '85398','47987','89921','76043','32059',
                          '96396','98104','95735','87366','89477',
                          '94073','57853','56627','94965','47032',
                          '55286','39042','14088','71548','77417',
                          '45136','34498','73443','45025','77427',
                          '18814','78523','30123','99225','36665',
                          '70386','89763','32832','13896','14262',
                          '78246','49431','69352','94949','28413',
                          '87757','98172','62324','90798','16488',
                          '67758','49815','72105','81310','31728',
                          '94182','36854','11131','68131','14582',
                          '60341','52708','33075','78897','38120',
                          '70127','53322','69579','43100','78473',
                          '68640','25036','83998','68075','95705',
                          '79629','92149','58050','49353','70298',
                          '31522','28472','51498','12282','22077',
                          '68421','20545','34618','26215','46055',
                          '34563','36236','37483','22467','30703',
                          '50544','53098','49104','73510','59264',
                          '72218','25503','48678','65492','47760',
                          '78059','26742','25297','28193','23512',
                          '58452','88623','54244','82997','91249',
                          '73724','10493','33052','79604','77687',
                          '78942','67481','39213','55526','35549',
                          '87886','28250','63238','64665','41951',
                          '21165','10563','66562','14388','75860',
                          '90855','91382','66271','78007','22418',
                          '67576','54614','21147','83871','67324',
                          '87088','67001','96243','73509','90992',
                          '19270','92865','95987','98952','26059',
                          '69393','86943','33940','61824','93612',
                          '82671','60380','56396','94090','80681',
                          '68350','18560','93283','99046','13804',
                          '54442','50887','69437','30532','72000',
                          '95404','24945','11515','17236','38964',
                          '32947','99434','76448','87081','76333',
                          '38908','40338','29337','31784','69023',
                          '62449','55600','10625','94036','33172',
                          '82628','97959','98116','53197','60143',
                          '64311','88001','38622','45573','16783',
                          '47973','48932','40591','58882','35720',
                          '59639','55550','70226','53503','48937',
                          '79068','74907','38181','66789','78074',
                          '33724','50973','54618','38987','75886',
                          '27738','70860','32983','33007','22886',
                          '15320','13149','63990','67394','48192',
                          '77366','84775','36909','80901','80078',
                          '70482','24745','50871','39117','12119',
                          '14926','51049','52760','59947','60259',
                          '45093','36650','79279','37882')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


