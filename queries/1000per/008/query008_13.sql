
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '28474','21420','57983','23572','88082','88822',
                          '78307','25307','43781','83182','98538',
                          '39203','76914','11261','21320','46659',
                          '93180','90483','46096','71331','59145',
                          '43944','24885','63103','94014','32828',
                          '15403','76200','21230','98193','35207',
                          '25695','49462','58364','96771','13387',
                          '72214','83162','79324','58425','65489',
                          '87425','28603','46049','23709','99343',
                          '67855','40403','37019','77001','50438',
                          '25495','45593','71513','23546','66853',
                          '20508','16638','28965','73149','59455',
                          '39759','70011','80144','25947','89004',
                          '24235','37699','67885','16986','56733',
                          '84710','91674','81162','70726','53265',
                          '86649','79775','41002','36455','38159',
                          '30259','78570','11806','86756','34055',
                          '93705','74842','56741','34182','60186',
                          '74687','44488','95522','15320','62378',
                          '45348','75561','26353','37086','11579',
                          '89358','26106','33167','43021','61041',
                          '64480','51660','78496','59615','27286',
                          '46926','21430','12929','46908','31997',
                          '73745','92144','58944','72130','21688',
                          '85866','14928','94747','39956','77904',
                          '60452','76232','97605','55755','53894',
                          '64475','46697','22312','18830','35173',
                          '12031','53502','66777','28628','62806',
                          '17339','86453','27454','97770','25127',
                          '82151','12964','63563','29122','13399',
                          '34816','47158','69065','81911','60170',
                          '74519','79593','60304','24127','45596',
                          '56373','77110','87758','66907','72912',
                          '92844','39034','84967','23236','34625',
                          '14568','84113','69298','68553','27593',
                          '74200','32292','41479','37043','52170',
                          '87177','92683','11590','73517','78299',
                          '57624','66794','86266','48194','39967',
                          '19016','16338','30518','98219','55209',
                          '88247','33484','84251','38246','13719',
                          '30819','26414','33321','25090','37358',
                          '17167','55637','30778','91828','74300',
                          '62526','40251','54896','59808','56748',
                          '54337','99461','76957','95430','46032',
                          '21608','88380','60080','77635','73202',
                          '64799','12028','43905','11928','87689',
                          '92894','52568','54266','46346','65192',
                          '67303','70470','76603','31672','44482',
                          '71996','53152','91413','17027','45641',
                          '63116','53602','80492','22678','89107',
                          '94258','17209','89965','74397','11771',
                          '98039','27125','35903','17393','20985',
                          '31215','85492','22046','18254','18946',
                          '82853','13079','48665','93785','64564',
                          '84749','28687','61413','89846','38002',
                          '68131','56112','74409','74656','39252',
                          '79121','42517','26175','54379','96262',
                          '99363','56729','50166','14186','55442',
                          '18289','13950','28054','25180','56907',
                          '59872','33444','21631','63376','28046',
                          '18642','52452','88664','65102','14654',
                          '72982','99462','38203','67352','99110',
                          '71731','71650','92975','68002','32272',
                          '66868','39176','21228','46921','12529',
                          '37933','12331','73818','92202','44174',
                          '59609','63929','14914','64347','51376',
                          '77561','14192','17608','74458','42033',
                          '57643','35600','32416','50982','15056',
                          '79496','10647','89798','61052','41839',
                          '12306','70453','54914','54785','81923',
                          '79031','52059','20863','28684','44963',
                          '34333','94228','70477','74417','16598',
                          '32586','62772','75899','11242','40517',
                          '45535','89745','26277','75412','38518',
                          '66677','97627','25513','96686','54291',
                          '56966','70307','35216','51572','39157',
                          '52553','70651','66932','20550','39372',
                          '76643','16854','81044','57407','96946',
                          '16523','53380','76853','45804','59693',
                          '27287','74543','27198','72778')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


