
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '54798','93771','74754','39336','76569','84264',
                          '66885','65052','59560','73616','41386',
                          '32020','54909','35957','16887','66193',
                          '95969','20066','19404','71341','61364',
                          '42744','52922','53021','35035','83964',
                          '25612','30633','50395','74893','19135',
                          '15121','81352','99752','51606','14202',
                          '80335','35657','64893','50834','46365',
                          '80272','92216','59274','26293','32940',
                          '43150','74793','66448','32253','42423',
                          '56324','10739','85074','55874','27802',
                          '61081','37787','32125','11964','55243',
                          '30020','58503','47402','17769','71689',
                          '69282','44546','27025','50489','62703',
                          '81339','14562','42128','72114','57034',
                          '68022','74901','96200','66260','34111',
                          '47607','36175','82025','14257','81564',
                          '88679','39600','26582','12763','96101',
                          '82630','39520','74558','97741','81694',
                          '83740','69455','51876','37891','68592',
                          '80804','11504','85987','51068','68120',
                          '57888','99522','32555','74212','92411',
                          '16557','17443','78885','86743','84829',
                          '13004','28601','89471','48137','69374',
                          '91004','15618','86637','36705','59675',
                          '60086','46677','53680','89343','98586',
                          '45938','46388','84503','35690','23077',
                          '30487','79402','14399','37370','59085',
                          '26752','11528','72411','69291','26254',
                          '28443','70918','60444','72064','79339',
                          '62250','56809','82931','16039','59137',
                          '60393','33547','85195','89000','44082',
                          '23952','51947','98875','20283','85829',
                          '26531','41444','45038','97825','73980',
                          '40088','32625','79115','99972','19507',
                          '16128','46007','35952','19637','26242',
                          '82774','27237','10284','98562','28471',
                          '96100','24182','19868','83290','47879',
                          '29706','47108','80232','19674','20162',
                          '51424','90566','27557','43147','15332',
                          '78207','20131','45631','40329','98482',
                          '40417','18055','12298','84789','24741',
                          '86693','71131','26723','93155','61411',
                          '39430','78785','20846','61682','45699',
                          '38063','25109','60667','13413','41699',
                          '38670','48369','30777','94500','71600',
                          '25976','64378','47853','94569','58348',
                          '28845','88328','58728','64486','63460',
                          '49468','32885','15565','41680','37714',
                          '59726','65663','81868','58139','81691',
                          '79153','78473','11270','58600','37513',
                          '24882','83114','45176','41564','58510',
                          '84411','74599','70843','27716','26635',
                          '21181','31721','35601','29418','24762',
                          '65504','45682','99721','98446','21361',
                          '92133','84183','94377','83979','14675',
                          '92408','81130','41727','97468','54292',
                          '42584','96537','82114','82311','28185',
                          '13636','41242','58506','72280','45396',
                          '81961','63096','93028','77595','80965',
                          '35621','50646','39760','72371','67923',
                          '51300','31225','59455','19818','71970',
                          '95892','62489','14973','74695','53481',
                          '72568','13650','39976','24152','47101',
                          '79266','52799','24290','71988','66080',
                          '82029','56994','72945','85280','99995',
                          '97707','85157','59192','66800','51864',
                          '61038','12211','73971','10493','13491',
                          '24690','99799','59427','20013','58802',
                          '72767','13429','94907','26269','30872',
                          '49524','77554','28124','94715','91848',
                          '54744','31604','10241','78793','95805',
                          '15717','46752','38802','15936','14381',
                          '76321','97893','12053','84290','19077',
                          '42878','70496','71780','59356','63661',
                          '87151','45922','79288','46877','96616',
                          '90309','82887','30819','16122','11550',
                          '70951','22039','61279','69526','25002',
                          '91309','44356','47693','65714','31516',
                          '35437','76079','57104','24005')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


