
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '91740','61378','87785','92660','65153','86175',
                          '45409','66023','57768','38064','44804',
                          '86503','21602','95318','25010','55177',
                          '44877','89299','11532','34407','28449',
                          '74067','83655','87118','82387','78005',
                          '41511','77726','54124','86888','34230',
                          '96308','83288','14378','57323','18159',
                          '84898','63083','68413','29304','87358',
                          '99807','55413','47009','55591','59475',
                          '23612','85124','19178','56779','97646',
                          '51737','76191','26331','27871','97189',
                          '22789','58181','49264','16470','34306',
                          '56873','65296','93251','75713','33995',
                          '38283','28204','11194','47972','37212',
                          '57221','49277','56837','83551','45321',
                          '79744','48982','47680','68179','15693',
                          '95935','77038','82918','61368','99222',
                          '27621','88378','74372','47323','19587',
                          '56645','52592','86247','38696','61616',
                          '41411','23916','86899','14529','31876',
                          '23560','68454','25284','75060','32530',
                          '95267','30300','19229','76196','60601',
                          '35778','46593','55044','80162','97763',
                          '55806','14267','51626','19312','71425',
                          '73295','31173','92355','89906','76322',
                          '24636','46612','15550','40482','60085',
                          '97605','65385','67746','14162','81728',
                          '64122','30984','63988','89545','49810',
                          '46725','75985','10555','70053','24032',
                          '66617','67517','14360','52907','19389',
                          '84394','74587','60418','49911','16148',
                          '82187','34850','29042','24170','82718',
                          '93105','70034','87065','19976','69687',
                          '59762','10399','69636','74885','74673',
                          '58316','79439','83050','90468','42206',
                          '58491','62931','65433','56669','99984',
                          '48060','51984','77661','99974','35942',
                          '54844','36672','84071','99080','75873',
                          '27649','76053','97332','80703','40761',
                          '95842','79622','48500','33626','65406',
                          '99606','32106','72303','52011','31543',
                          '94727','76393','18423','25172','77120',
                          '57356','60311','21688','42156','61063',
                          '68846','20525','61090','45038','38041',
                          '33079','54291','26006','19536','31818',
                          '36546','33482','60364','66940','14977',
                          '30059','29175','71077','17428','54417',
                          '93029','89061','32317','96688','32080',
                          '70514','64315','45971','40881','36819',
                          '60572','68120','76517','83464','38987',
                          '92107','73555','15898','99004','22333',
                          '51870','60068','79975','43998','59931',
                          '84952','96897','29406','41148','63497',
                          '43051','11597','42993','85803','61081',
                          '27997','72187','94556','83190','15362',
                          '29383','84596','77566','12294','43606',
                          '83201','11927','18682','56102','51639',
                          '36773','83165','93535','69769','99347',
                          '38815','74664','33439','24426','91538',
                          '42542','40682','65263','12574','87293',
                          '27972','95829','46349','58932','89056',
                          '51265','84698','46395','43959','51214',
                          '11019','29543','78563','35927','91087',
                          '72712','76281','21067','23714','60288',
                          '55068','98222','18720','53860','31705',
                          '38494','38350','38096','11660','36018',
                          '21376','90781','56200','32373','76002',
                          '92958','36225','78864','89109','59753',
                          '90680','85309','30112','66017','90866',
                          '61926','36763','54049','87710','44142',
                          '26968','67610','87848','75186','34128',
                          '98971','73500','95496','35954','97922',
                          '86158','74906','29359','24444','58459',
                          '56342','70170','38496','48740','13389',
                          '32841','27987','73859','45150','54641',
                          '64251','61757','71066','33469','21768',
                          '39824','25557','96012','14328','24036',
                          '22414','55830','18854','52081','21454',
                          '35096','79405','61293','42980','39163',
                          '44338','43945','31607','45417')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


