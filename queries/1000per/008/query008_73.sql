
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '18294','59537','41764','38311','44973','43494',
                          '45239','78078','98074','47144','91628',
                          '25074','50258','11576','75297','55024',
                          '63823','58749','67838','95672','83454',
                          '65274','35147','54867','98945','76707',
                          '37220','99753','56237','60678','85454',
                          '57663','88470','98028','63603','41751',
                          '13547','21330','13444','63514','46216',
                          '36819','71646','77153','63702','74635',
                          '74355','85163','41163','20228','72707',
                          '74495','36868','28536','61344','49793',
                          '49885','93132','32331','24971','75474',
                          '43055','10829','43087','34692','49770',
                          '90291','84718','24128','71425','31538',
                          '70793','65352','81401','44614','27914',
                          '14944','43224','93377','62483','95851',
                          '91330','92206','35551','47013','86848',
                          '19985','42233','80548','73752','71423',
                          '42318','55524','56363','35573','37945',
                          '83989','90877','70627','89845','44798',
                          '97030','53687','49972','33310','49765',
                          '19574','90897','76994','40438','86018',
                          '23088','43082','99227','82939','32271',
                          '11637','44667','63476','94349','14287',
                          '17280','28746','73177','81585','46151',
                          '53180','40532','26107','87112','16688',
                          '91395','89951','70367','40108','42477',
                          '95474','88289','78725','60892','14648',
                          '72228','11587','90236','67803','27829',
                          '59395','11984','90419','38929','19452',
                          '46111','14982','78122','43955','12320',
                          '96535','39721','72625','72365','49263',
                          '68353','85529','74072','13392','75833',
                          '51957','76761','12507','46497','92246',
                          '24499','43661','44220','58433','67230',
                          '13956','72598','28540','70386','81013',
                          '12845','16513','54098','28669','79618',
                          '71235','13596','41096','25740','69152',
                          '76596','10215','86137','21472','70430',
                          '74491','73490','29912','69544','37938',
                          '64170','27958','57686','89876','68398',
                          '81561','27635','30819','26381','52122',
                          '18462','16623','61855','57874','84467',
                          '62807','98714','49968','87233','21298',
                          '13453','73505','25903','66160','75204',
                          '73614','60626','61878','50962','82031',
                          '95881','84319','74484','50924','10287',
                          '80303','57732','60387','13709','14709',
                          '99687','12179','32243','97307','62110',
                          '84895','75581','11767','54941','78494',
                          '31131','47790','23304','52748','95957',
                          '35512','87730','17495','70075','79637',
                          '13780','64100','18901','65116','10675',
                          '91998','42181','70564','33842','98952',
                          '42154','83563','59977','24903','94710',
                          '13240','77583','16286','17121','39610',
                          '61066','49430','30382','44942','23118',
                          '54883','70610','27196','66887','82348',
                          '71850','56751','31487','48918','32728',
                          '15786','58941','53907','69732','76277',
                          '49675','62796','66089','87306','55710',
                          '42649','27510','19354','21568','98220',
                          '80359','97665','48650','76667','41940',
                          '17844','60290','60020','49177','81779',
                          '12660','64789','32624','64216','89274',
                          '55733','90156','69001','22499','18761',
                          '74991','40992','34401','93645','66183',
                          '29772','15670','47382','97701','98638',
                          '71017','64150','61379','82460','23942',
                          '45983','11497','32897','11194','40466',
                          '68058','99668','94341','27006','40048',
                          '85773','15926','30898','61517','24274',
                          '93542','73346','40732','88335','91820',
                          '16554','67541','83323','75358','83457',
                          '26612','21811','26784','71366','25184',
                          '84130','82385','93088','88640','90272',
                          '36296','16531','33292','94425','52426',
                          '91206','73261','56470','47636','35822',
                          '60375','65391','28186','91230','41598',
                          '16936','62848','60445','71196')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


