
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '36585','94190','88476','83445','58754','39332',
                          '89616','23652','42167','96988','97213',
                          '61210','17142','27099','63397','29425',
                          '99615','16667','72197','50756','15267',
                          '81882','50004','94598','66160','64932',
                          '49156','61261','86044','80614','62165',
                          '34407','90906','37952','18139','72018',
                          '94657','18731','40891','77900','13890',
                          '19568','88431','19686','93755','97917',
                          '63176','14959','23415','26552','18225',
                          '65972','92452','40266','99586','31529',
                          '24146','22937','13613','38054','89829',
                          '44496','53836','94772','11346','13077',
                          '85226','46035','44983','39056','25097',
                          '83901','58012','63112','80398','49199',
                          '23413','82878','33024','27774','46518',
                          '62993','47539','29012','73441','52448',
                          '17869','99299','88589','52987','20665',
                          '23624','69492','80215','22052','78962',
                          '37938','28284','26846','39357','96559',
                          '86199','33130','55918','88500','70410',
                          '59020','55047','72816','85506','48464',
                          '28882','57085','58194','39910','78446',
                          '15977','17903','63542','81888','69845',
                          '67525','86958','49063','24082','38885',
                          '24197','54991','93965','53420','23445',
                          '57596','97564','28700','43632','54340',
                          '27083','39271','77538','22471','80513',
                          '43475','49149','33037','26764','83698',
                          '45462','49792','95947','19598','50296',
                          '33669','61226','70518','90878','27831',
                          '73734','28164','12259','33555','72073',
                          '54616','73784','45796','57029','34190',
                          '41159','15493','97703','17847','74752',
                          '63569','40713','54790','20526','20687',
                          '35077','78686','26307','60359','66188',
                          '11010','49313','71776','81534','80196',
                          '49196','89301','13068','68855','14634',
                          '46782','91461','22195','24272','24269',
                          '33863','11384','18248','58364','45631',
                          '16816','33433','90863','11475','98034',
                          '24396','79760','70512','98757','12171',
                          '55229','73037','79872','73329','86349',
                          '89085','14969','64496','40364','35903',
                          '83382','13222','79357','34295','27894',
                          '52114','73182','75271','46162','74490',
                          '28175','72019','15236','56789','44346',
                          '92613','27116','15409','33553','97996',
                          '91570','80628','70762','94596','20580',
                          '52961','30783','18102','28313','67791',
                          '40373','22049','11868','56172','84231',
                          '22388','54587','59574','50819','50087',
                          '49746','28448','47424','44392','87895',
                          '83840','61038','29994','17437','63983',
                          '55811','87935','39564','28565','92969',
                          '39761','52115','79655','26445','59576',
                          '29542','79275','92336','84226','62834',
                          '33400','23886','53536','61452','82804',
                          '35598','54459','18267','32715','39409',
                          '77733','55928','37237','76179','68310',
                          '34906','52942','76504','65645','92089',
                          '29093','25630','82316','13496','77257',
                          '51606','31127','16120','17190','70747',
                          '74855','48371','14936','43205','19513',
                          '70920','67527','27677','16716','54127',
                          '77534','25146','92769','88957','21293',
                          '91893','94807','98801','48314','49042',
                          '78674','44456','89235','56852','13160',
                          '55804','12054','84084','66450','15542',
                          '75038','58542','86030','65066','11953',
                          '23622','28227','90398','42220','32209',
                          '86983','10703','48712','47280','27976',
                          '46147','54174','12151','38289','92242',
                          '66219','76886','84746','10324','11955',
                          '96888','83239','41200','73017','92526',
                          '90121','56003','80849','19246','42711',
                          '59111','71316','62181','34698','86558',
                          '56216','73954','81745','90347','55399',
                          '75616','40766','87899','48309','54229',
                          '58445','14255','83350','31061')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


