
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '51057','62056','20476','93908','51016','85996',
                          '90054','77351','65997','46971','52414',
                          '76906','28193','61892','56422','19336',
                          '88644','73373','35031','19232','73584',
                          '93452','11000','96618','24201','30904',
                          '62420','47052','53208','39528','73298',
                          '35724','94131','43792','27586','75711',
                          '72946','36878','75933','75844','62173',
                          '37991','71445','58657','44036','43673',
                          '27902','34225','87771','91036','72116',
                          '10058','80184','16248','53716','40995',
                          '73238','85672','74697','54793','92039',
                          '49831','62920','22187','89600','14272',
                          '89071','21540','79083','18688','29688',
                          '10324','59407','36028','98898','86309',
                          '67608','22033','34691','11784','93618',
                          '39167','69366','54763','31108','79756',
                          '43695','58379','37724','77440','10476',
                          '62140','91624','86129','36090','44411',
                          '30215','23229','30115','17870','95482',
                          '21108','47195','16745','57487','49784',
                          '36970','86072','42174','21681','89746',
                          '81529','61788','79586','66612','17734',
                          '46200','63027','52221','39517','56209',
                          '13169','29512','70715','86100','68257',
                          '24041','74729','20385','49544','59001',
                          '63932','29707','75616','15881','50159',
                          '98469','79008','24766','29840','39909',
                          '23739','21667','25634','60816','82682',
                          '93596','40119','38213','97004','81413',
                          '43676','31726','47585','64750','39154',
                          '68222','93625','96562','32255','62390',
                          '62804','93077','69958','71186','85224',
                          '46831','66397','99206','74527','63150',
                          '69407','65182','72274','47075','44058',
                          '17789','30132','74676','65855','44990',
                          '58168','34041','40082','96440','14055',
                          '85716','18082','51659','72747','41133',
                          '53403','58247','74969','79176','56757',
                          '60076','10831','19605','29206','91451',
                          '55721','74953','89701','25735','52876',
                          '22361','96222','72346','41409','67772',
                          '36261','10596','69995','42366','13495',
                          '85306','44054','38614','26149','30645',
                          '80315','28795','79969','11747','84679',
                          '90467','20414','94098','43384','85521',
                          '29937','71816','25153','43137','12155',
                          '32641','25678','75890','70254','62911',
                          '80574','29163','77397','20444','53697',
                          '65260','39088','14101','14395','57806',
                          '70119','92316','40833','47232','25918',
                          '44682','97718','76568','95545','93761',
                          '41750','57078','45090','78951','67853',
                          '75594','51377','22058','59343','24332',
                          '63260','24693','95682','14821','51657',
                          '59599','64457','55310','43184','54357',
                          '68018','86030','25536','37789','81289',
                          '72710','55146','47196','74979','38056',
                          '66688','97963','59831','95123','63971',
                          '39456','75318','46198','82692','54458',
                          '82621','29552','40343','50730','74629',
                          '22741','21537','51175','28972','94514',
                          '64630','53692','38053','62414','29356',
                          '90873','31008','41124','51073','73672',
                          '66592','24625','13710','14886','30979',
                          '15004','46325','81017','66732','57054',
                          '62343','26490','17503','11231','88338',
                          '98753','14199','46392','52750','40153',
                          '59005','70348','54397','51419','36606',
                          '88778','45410','98699','85192','37019',
                          '59135','72171','34938','75354','61046',
                          '29360','67245','13308','51481','92641',
                          '90993','10591','98669','93979','38360',
                          '42901','37944','33177','61249','29217',
                          '95534','43504','62361','24403','72229',
                          '49706','40932','91300','90236','90075',
                          '21937','52789','16737','86408','88902',
                          '87752','45449','63049','36639','74158',
                          '44750','25484','10186','94730','54889',
                          '63908','31933','92645','69307')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


