
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '52729','92878','17540','88398','92326','54846',
                          '80706','81246','30107','59396','53411',
                          '57538','69932','66852','83462','72660',
                          '26454','22991','18546','18586','18636',
                          '13476','14026','66402','27122','16454',
                          '76712','53156','21653','80964','19327',
                          '39441','29905','53087','89753','43026',
                          '16759','53207','34282','13988','88315',
                          '59255','75808','10317','63052','16030',
                          '41271','44633','10609','31044','64606',
                          '35161','95014','94379','42071','25737',
                          '34928','62555','32403','92673','39379',
                          '66940','91366','79125','65690','52421',
                          '86802','25249','34973','77849','93382',
                          '78039','74114','62120','11604','58258',
                          '43293','36444','37922','40710','58097',
                          '87313','68629','11033','59683','48010',
                          '38885','22374','65337','98006','44756',
                          '52703','21639','86765','60252','28698',
                          '99027','59709','44883','19660','18893',
                          '77398','63333','44854','49754','63724',
                          '29935','33994','40602','91500','67173',
                          '28079','87894','64192','16346','59137',
                          '87593','76656','93631','57054','63891',
                          '86376','12168','53750','98046','47536',
                          '13235','29841','64298','57304','34444',
                          '77653','89580','87609','41508','17337',
                          '25710','96568','30674','42638','45042',
                          '71720','30687','35029','74271','57663',
                          '86301','39602','68014','52719','67235',
                          '26252','97252','26822','33753','70638',
                          '35491','28806','31518','34796','92794',
                          '77280','88233','98652','82143','26621',
                          '29595','82651','17144','56569','34376',
                          '75506','63846','65745','36920','41956',
                          '27504','40992','49918','76665','69294',
                          '40137','60253','83097','28480','57471',
                          '43167','67384','25367','55893','97869',
                          '32048','97185','22083','34377','32254',
                          '26433','34098','90375','76305','17389',
                          '27656','85256','45811','70370','74244',
                          '19844','49475','67198','61601','68908',
                          '69979','62280','40868','27229','55040',
                          '52977','95259','40647','62878','10250',
                          '67288','11262','42285','63119','66673',
                          '37200','73483','12185','33916','57633',
                          '39003','58460','56626','34259','28131',
                          '67754','57246','60404','46866','91666',
                          '47673','52604','59575','95559','33933',
                          '55634','66292','71845','78376','43815',
                          '93581','61535','33553','88525','85258',
                          '17941','50381','46782','71050','46585',
                          '87009','43013','89106','70492','90124',
                          '77361','46349','74096','64064','73933',
                          '43375','35235','44220','88065','68581',
                          '83461','96569','87322','98479','33819',
                          '18550','15323','56269','67925','39890',
                          '43536','18524','23681','44830','26000',
                          '77861','28950','75756','89310','86409',
                          '40893','29206','49673','19882','45656',
                          '71667','39696','36479','74861','68568',
                          '93082','95001','40916','15358','81857',
                          '70142','10055','37958','70420','54655',
                          '22893','45197','68501','87653','23455',
                          '50932','30641','89229','91847','66399',
                          '91921','62685','35062','16639','89749',
                          '38160','91873','92106','46275','16387',
                          '76372','30935','69354','69113','56005',
                          '60769','15815','76507','91103','95496',
                          '31590','63487','29466','53849','86161',
                          '78525','83854','23134','75010','57934',
                          '62111','77397','83492','29272','85768',
                          '76517','78463','81315','73619','49960',
                          '21858','59072','33204','68563','22703',
                          '51814','30545','22635','72133','42984',
                          '25187','12875','39677','60038','34705',
                          '75388','49579','43399','49320','13979',
                          '12795','45236','62041','61497','40997',
                          '89087','73046','94396','57627','82058',
                          '23828','68669','79606','90165')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


