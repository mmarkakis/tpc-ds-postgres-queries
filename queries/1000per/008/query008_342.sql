
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '65936','25182','50303','60275','82139','54434',
                          '13590','76149','28292','54081','16467',
                          '40154','46507','17102','71866','26406',
                          '99724','68099','62329','70188','11847',
                          '18917','37283','83527','23825','66642',
                          '70465','31446','28556','18938','32863',
                          '96743','70238','35382','13899','15562',
                          '24320','11976','58991','40561','38060',
                          '94315','34784','63884','60640','32040',
                          '32609','77432','14108','35738','45502',
                          '20803','49802','17894','48933','10738',
                          '10394','20706','47230','64474','74553',
                          '65566','14265','53458','40218','15716',
                          '83549','35085','18281','34675','73479',
                          '84246','55648','86264','30380','46916',
                          '53163','65692','26624','99427','10176',
                          '83528','69488','80303','29210','47875',
                          '73128','94903','90491','30766','28432',
                          '74585','75377','83287','97810','16963',
                          '87917','32592','66997','54796','11799',
                          '13046','19626','49554','62544','16052',
                          '47234','38435','69054','94831','90851',
                          '33699','55683','61434','43215','56714',
                          '39233','75826','40256','70337','59962',
                          '99504','78574','53184','55541','56249',
                          '11081','21594','63264','64826','12687',
                          '63139','64937','94321','34133','29275',
                          '86911','10094','39419','37865','29525',
                          '33187','60456','34427','51526','16002',
                          '92961','63808','14922','12565','58811',
                          '16755','98844','77225','76282','63475',
                          '67473','52029','38942','65982','21726',
                          '51321','82846','90361','48223','75643',
                          '89492','89221','66265','11848','56572',
                          '55034','75724','59266','74531','48559',
                          '76460','67230','16419','13938','51367',
                          '84215','50105','22107','40850','43429',
                          '12392','27185','56844','55258','36241',
                          '62263','49139','36734','96974','88360',
                          '41055','87185','73673','32948','78773',
                          '62260','45235','48182','78648','92132',
                          '66472','91598','17167','77379','64128',
                          '33386','82989','27259','72486','60922',
                          '46672','21524','30295','30597','43239',
                          '77932','36637','92543','36578','88214',
                          '85072','55958','61960','23295','61075',
                          '23109','34672','82883','82839','89925',
                          '65708','62133','92525','58587','81196',
                          '21559','49399','31455','14957','63541',
                          '85592','18979','20783','86251','24770',
                          '89952','27437','22408','92530','56783',
                          '32899','16999','42222','49179','16593',
                          '32791','85488','65125','48508','68842',
                          '48434','83301','69096','97036','68729',
                          '31520','76818','42240','48470','30895',
                          '98324','57863','66073','83051','33360',
                          '60491','70425','49952','81061','76284',
                          '84262','14997','71491','86547','83476',
                          '96857','11149','81100','13555','30838',
                          '25804','56774','36784','13043','87732',
                          '94287','58064','96189','67402','25175',
                          '47009','13659','18594','81978','45891',
                          '46221','91440','80256','76796','68936',
                          '31774','34032','50381','73612','98022',
                          '47533','14340','59054','26457','73815',
                          '66205','13807','27028','73394','61594',
                          '68415','65351','26699','87055','17008',
                          '49361','77931','46102','91856','97265',
                          '20970','11890','78843','10881','57626',
                          '70847','29271','87763','26466','21164',
                          '25243','79746','28456','67800','13101',
                          '77210','51077','77547','64334','55534',
                          '30534','65268','68548','29904','83861',
                          '76106','94288','26812','70223','27130',
                          '20766','79914','48393','37364','98007',
                          '54873','91018','84497','59943','74154',
                          '33804','26815','51042','14257','17419',
                          '85120','16606','35582','41963','55579',
                          '28344','29478','90716','70385','32843',
                          '32420','93146','56279','45051')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


