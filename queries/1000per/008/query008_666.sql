
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '86881','88270','22428','82188','21558','15582',
                          '48158','58604','11202','21959','96672',
                          '21859','52092','89777','19196','94645',
                          '92305','85681','70343','79693','22149',
                          '64892','80093','50624','44474','51767',
                          '43397','91259','94806','13846','70718',
                          '48063','53817','36352','57223','42922',
                          '39651','16916','38989','15264','62317',
                          '22569','72894','58311','24057','20910',
                          '80460','19184','51654','47770','96305',
                          '44084','20601','78533','38381','18453',
                          '70351','38277','59800','17297','82257',
                          '35278','81674','62843','37071','50716',
                          '85924','84785','84701','41743','23531',
                          '42017','15233','25009','78000','11851',
                          '11339','21413','84612','70787','99819',
                          '66611','91016','15073','72210','73139',
                          '98983','53089','29190','60899','78279',
                          '68538','75899','15094','67326','81921',
                          '59333','71125','92684','24678','40276',
                          '74781','39270','76851','52754','81571',
                          '13156','85385','79453','76947','67297',
                          '27481','99063','50429','82264','79882',
                          '48348','24495','81698','58114','68443',
                          '85554','25678','49513','28914','90205',
                          '66279','23443','50249','17981','28733',
                          '94133','65750','90026','84203','33452',
                          '55491','25169','95470','30674','52111',
                          '98083','27633','90167','98715','10160',
                          '35781','91991','95229','98692','18835',
                          '65208','24715','17652','67889','30456',
                          '67457','50808','84542','15506','28022',
                          '42631','53989','47198','68502','94212',
                          '89573','44399','27036','18148','45056',
                          '21227','31478','26973','32911','84842',
                          '72785','61738','16795','89251','70872',
                          '92405','86071','45749','17426','19631',
                          '21243','99888','37577','88406','79000',
                          '38575','31569','77668','92697','17420',
                          '41048','36295','78435','86575','46533',
                          '25320','51612','26582','27536','91468',
                          '44698','72140','68786','32255','13669',
                          '65250','21374','67884','99426','74616',
                          '80456','63596','59427','11096','24474',
                          '45949','21031','14933','70595','87589',
                          '43199','71956','64822','61031','22435',
                          '49995','59013','39116','30594','32193',
                          '93654','64585','42683','24595','20781',
                          '62133','46126','75399','19998','96219',
                          '35624','19820','22840','80127','58393',
                          '40151','56479','18001','91886','95978',
                          '87906','46598','66538','30615','41217',
                          '54521','41787','93264','63836','74773',
                          '91222','91776','36292','95796','61684',
                          '78721','39978','49245','89861','16558',
                          '80944','15973','26622','46697','68633',
                          '59680','66409','54064','62845','58585',
                          '95600','94901','17914','96433','84710',
                          '68041','42172','93713','28227','48626',
                          '73142','67789','31944','76155','45232',
                          '62709','93762','52640','88163','86374',
                          '96241','98707','98673','55927','11321',
                          '65181','90578','92093','16525','51788',
                          '79354','73369','54203','61741','80793',
                          '65939','58117','61110','91135','32666',
                          '23024','22382','85184','33614','95743',
                          '38202','45793','87278','45283','16585',
                          '25342','20009','10119','16822','93978',
                          '41022','79884','66351','20510','46416',
                          '84395','19979','46584','50896','49573',
                          '75210','73211','37715','19829','11108',
                          '37608','35650','96708','28653','81992',
                          '42988','80752','44009','80889','55425',
                          '50858','60018','44514','78464','79435',
                          '45482','20297','76004','19428','34207',
                          '30490','20667','28395','90116','68554',
                          '72147','15726','58219','43605','44429',
                          '70302','60618','87447','90585','38276',
                          '99576','81244','26592','38115','55476',
                          '65281','50537','62175','76406')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


