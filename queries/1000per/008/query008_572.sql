
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '38624','43564','31461','34358','21878','80932',
                          '69986','75599','70539','22553','58365',
                          '51070','48822','78109','83266','94460',
                          '87158','70140','96732','82459','80798',
                          '62005','69919','84644','93140','56684',
                          '88496','15866','41465','94465','84439',
                          '14521','81628','27156','79768','96245',
                          '33018','84963','96722','83357','22623',
                          '32445','42791','47758','17932','37365',
                          '25379','89413','95946','47685','80566',
                          '19737','95853','59621','94637','19443',
                          '90171','50567','59554','86574','66357',
                          '57342','28937','54452','93778','35560',
                          '93044','12675','41113','34990','49020',
                          '53443','76699','12162','61683','45965',
                          '50808','12895','90060','20848','30843',
                          '23644','33014','19816','96381','76556',
                          '75222','90015','53193','57126','29456',
                          '38516','72788','96781','92475','22153',
                          '27671','26907','40147','92945','72967',
                          '28013','96223','41243','72041','89286',
                          '99510','23705','81016','64388','10620',
                          '83318','24055','31662','21197','35421',
                          '84066','43408','69702','96271','88862',
                          '76603','27708','63924','17383','77799',
                          '30687','71350','51806','70741','83765',
                          '21621','87527','28004','94771','58891',
                          '80647','33173','30584','97899','59890',
                          '87384','60615','65533','59743','23887',
                          '92467','11645','38777','80186','47444',
                          '56676','29479','75167','11761','78161',
                          '47550','56311','64776','19024','54509',
                          '75978','17312','67306','54041','82848',
                          '30220','66719','58787','64026','26789',
                          '27355','89185','55572','10003','38053',
                          '59296','50945','44459','70054','49958',
                          '88896','51081','53278','94162','19610',
                          '34188','64181','72165','57789','94953',
                          '21773','93525','63674','43301','51012',
                          '93093','22155','90188','74879','21048',
                          '96360','65437','27544','25549','87911',
                          '10767','86527','20782','87275','16652',
                          '53280','55387','77556','67546','60828',
                          '81584','55971','24395','31985','32582',
                          '72865','38035','27958','15855','67988',
                          '20071','10290','88835','97808','40556',
                          '34595','47789','11606','48551','87306',
                          '21991','80787','81840','35462','91150',
                          '29030','36556','30132','96527','77969',
                          '62561','46495','95191','77452','41554',
                          '14364','35058','73803','88150','95273',
                          '64126','91722','51536','83637','66750',
                          '72033','53021','45042','59715','65414',
                          '28709','61414','37477','67855','60173',
                          '26259','94702','63603','93621','72334',
                          '53185','49561','36104','88423','22720',
                          '28119','31794','70463','21103','83705',
                          '21149','70912','58065','49636','47403',
                          '66171','16456','47916','20335','94099',
                          '65818','74108','99932','70716','92051',
                          '34801','17683','66290','52902','92248',
                          '17127','47942','15971','92353','20009',
                          '36118','29561','54213','83574','72068',
                          '29736','65258','57292','75315','57398',
                          '95601','91782','90923','64861','44834',
                          '25570','91683','81095','76113','72713',
                          '95928','82743','64848','81172','75635',
                          '89920','43825','75787','72824','33328',
                          '81033','55780','64648','39014','25584',
                          '69927','90769','65369','48657','29211',
                          '96108','98878','45062','28096','43602',
                          '93937','99216','34303','41021','32283',
                          '43050','89448','13980','11961','65880',
                          '69992','49241','46457','99751','76448',
                          '18322','67670','32898','98530','47197',
                          '78786','33198','72704','76438','17208',
                          '97051','70465','77281','42508','60652',
                          '84446','26682','30170','11840','61770',
                          '87251','65553','18170','71060','62304',
                          '38134','76745','85236','16692')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


