
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '77338','20005','50287','27849','60809','14637',
                          '44026','24983','33076','74162','83444',
                          '84985','51699','98451','11517','89309',
                          '87950','33332','71022','50976','18559',
                          '56478','81716','19997','77866','29802',
                          '40013','50463','44869','64719','85507',
                          '37015','12886','83245','62477','50286',
                          '10111','34347','42748','71784','46486',
                          '25479','94905','51849','54918','58898',
                          '62752','34458','77474','40037','83609',
                          '62358','52112','20512','27346','27821',
                          '40455','94487','11408','77316','78895',
                          '82202','20633','62816','93966','40721',
                          '30847','97023','83881','64885','94424',
                          '38138','39902','10753','93864','77682',
                          '70362','56668','23307','95347','55097',
                          '77426','99726','56796','39392','38358',
                          '26004','62370','51311','70922','28999',
                          '24521','14708','30974','33796','25210',
                          '33066','98097','22005','70749','54376',
                          '36656','22716','42996','38522','89293',
                          '30208','52366','63149','43602','46665',
                          '75382','50808','25764','55267','93773',
                          '49882','28727','81525','21243','86319',
                          '36025','34452','82762','82500','82744',
                          '75839','18067','93022','89004','35065',
                          '37651','61364','49588','57931','50691',
                          '22861','18488','50681','29826','56883',
                          '77019','52231','88701','48134','81448',
                          '99647','22157','23914','70711','52202',
                          '47103','13613','45242','53073','19957',
                          '92369','69232','25211','99622','43570',
                          '65508','45678','60358','45261','73119',
                          '28421','46062','52751','91948','53031',
                          '66095','91142','29451','23994','15168',
                          '58289','24522','41563','94094','70958',
                          '84245','28474','44667','85244','61944',
                          '91383','12071','72774','68411','56009',
                          '39222','12265','39437','69560','77517',
                          '74073','74102','60755','29644','30502',
                          '69388','39411','95745','47635','84363',
                          '79987','61165','69108','85806','48544',
                          '19177','98632','87641','31147','41788',
                          '86855','24937','11442','28614','53701',
                          '63594','71120','36125','48386','94902',
                          '34380','49569','68170','52054','39981',
                          '88691','27300','62785','76998','14363',
                          '89519','69968','29647','44830','15623',
                          '79639','72677','58762','60176','37124',
                          '17696','63721','36961','41849','17192',
                          '13837','23247','73580','97444','63842',
                          '99116','74337','26291','53514','18297',
                          '66144','60315','49873','66894','41420',
                          '45959','53148','53195','63506','41333',
                          '44564','34631','38346','75792','87803',
                          '28555','49356','73526','10159','67939',
                          '51404','16550','87385','52919','66074',
                          '24136','33925','20731','51222','48349',
                          '30469','34567','33351','50699','39588',
                          '20373','81672','31475','27108','26948',
                          '24200','19157','61351','20572','49906',
                          '60557','14524','77460','95739','80455',
                          '19582','31932','97420','73115','95712',
                          '83372','66440','81768','97355','68760',
                          '29775','93592','85609','41167','84765',
                          '14546','11377','15189','80872','78830',
                          '66980','14636','93532','65275','41017',
                          '24753','77372','71440','69450','88770',
                          '70399','66088','64223','21730','54560',
                          '51179','15900','86658','56468','68697',
                          '92961','64565','18061','93676','89703',
                          '52434','46221','22141','65194','43551',
                          '83449','75553','11407','89949','50148',
                          '15959','10831','17123','32713','65659',
                          '39318','24362','71188','80599','36735',
                          '45586','34781','90981','83709','90057',
                          '76862','29758','24647','38509','39897',
                          '29211','82440','98361','27284','73860',
                          '36963','44322','21587','31301','81333',
                          '99760','18052','59640','67747')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


