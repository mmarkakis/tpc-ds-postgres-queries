
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '93407','87053','67994','72002','32580','12927',
                          '71423','53955','63957','33519','63460',
                          '37120','18486','31223','36620','36675',
                          '81209','87836','13487','46869','55994',
                          '65628','45998','34549','35382','78217',
                          '98579','14745','35517','58481','31875',
                          '83237','66865','50268','34112','59711',
                          '76091','84439','16005','65163','88853',
                          '43518','68736','34086','99808','35697',
                          '74572','18632','52734','68677','12298',
                          '47628','85236','39868','15758','38090',
                          '42313','62684','86119','89487','79881',
                          '11987','28106','89601','88300','51734',
                          '84767','70029','33414','53123','44241',
                          '25669','10526','73658','66053','95080',
                          '46206','32983','27763','16044','14393',
                          '42970','83784','76733','66540','38441',
                          '60869','35364','35980','92457','24643',
                          '65066','73612','18547','41541','68895',
                          '54424','66475','17877','26805','54925',
                          '34442','42820','44646','66734','14498',
                          '58673','51185','19326','27224','78446',
                          '79926','28533','42243','70178','73563',
                          '73524','69750','81204','54664','36592',
                          '32678','69537','88808','10109','89042',
                          '53092','15351','72550','34888','82035',
                          '86607','33427','51060','74846','86218',
                          '76151','51590','29208','56800','73155',
                          '46889','33588','61496','13552','57486',
                          '65661','53190','32318','35120','48231',
                          '34460','33180','13409','69632','99481',
                          '46156','44550','41116','99943','75224',
                          '18564','64725','51676','20592','41175',
                          '55293','36036','35084','78728','29159',
                          '66511','51348','28456','23200','97441',
                          '10893','63304','27072','34667','65814',
                          '70725','91668','95049','66462','49771',
                          '12705','86009','59174','78403','14512',
                          '40780','40903','82500','53998','84817',
                          '85386','95458','73657','44765','21967',
                          '73101','34839','93262','46583','29255',
                          '70720','51202','27003','72514','51793',
                          '41944','13849','97541','43005','98354',
                          '50625','55613','97488','61085','32804',
                          '43468','55640','66841','32036','47342',
                          '36747','43785','94800','33623','41688',
                          '11598','62772','10823','60287','73613',
                          '60637','38489','18473','98529','49909',
                          '57602','87033','10036','24392','88380',
                          '24844','27576','61703','82707','21024',
                          '88590','75776','70568','63885','80164',
                          '91074','40432','99575','69623','29012',
                          '91843','25830','12291','51339','40192',
                          '55427','90713','41781','13469','67836',
                          '49478','97109','38592','67623','19786',
                          '13100','28580','45636','74698','20658',
                          '17201','99544','40569','57789','21701',
                          '18464','41307','90184','72168','96488',
                          '37601','94977','42557','86072','77487',
                          '51527','79894','54668','24513','30581',
                          '88731','50824','46013','25610','55185',
                          '86992','12451','56580','50384','84769',
                          '29695','85798','72815','42087','67030',
                          '37364','15870','60807','72867','59789',
                          '12247','60923','63697','79088','42544',
                          '88561','63391','46549','55168','92340',
                          '58905','88909','28572','34712','52145',
                          '57408','88570','53091','10407','11751',
                          '90801','99574','27187','34537','75289',
                          '58746','28608','19855','74728','49672',
                          '88862','57203','67455','48534','19721',
                          '40231','28060','67920','95243','75754',
                          '77836','32307','30149','41650','62592',
                          '53183','56428','36335','83594','51481',
                          '74494','67971','62341','43490','19407',
                          '45722','79518','78380','35699','56627',
                          '11986','14580','48268','93713','66204',
                          '11943','16828','47320','73940','17575',
                          '23971','41034','54975','53811','41029',
                          '81475','35280','41559','40799')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


