
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '15926','94977','77434','10648','28486','26284',
                          '30626','94355','75286','24639','99104',
                          '61991','34966','77329','12048','28532',
                          '32134','65161','66398','30093','61407',
                          '80781','67277','30255','60811','12096',
                          '55815','79521','46921','18663','32930',
                          '38663','12560','77750','91597','82473',
                          '91875','50736','82642','38031','68518',
                          '13507','75274','10190','70579','21518',
                          '46703','94626','49784','71094','30334',
                          '63656','16208','62779','70365','64018',
                          '22930','29183','81875','90208','32131',
                          '18264','73788','86598','36791','73569',
                          '11091','16466','12679','49945','47839',
                          '12040','24928','95241','84790','76247',
                          '26038','88597','93042','83858','14737',
                          '61313','29141','84261','70415','86654',
                          '69799','93556','98486','54561','12712',
                          '25819','10836','79890','51934','22250',
                          '93094','17931','97552','47322','34216',
                          '91082','67109','89790','56471','81399',
                          '76130','65835','56843','86986','21451',
                          '60310','44458','27014','63970','60848',
                          '90053','63629','48150','27132','79789',
                          '81971','65555','21793','76564','25363',
                          '84873','71632','72130','11799','64706',
                          '55844','74118','10671','80982','52439',
                          '14829','21196','19562','83433','70959',
                          '69452','42310','42008','44157','35252',
                          '91538','74879','59343','98711','35261',
                          '13642','49786','39695','51045','64530',
                          '37345','93757','72845','31323','89270',
                          '37450','44369','45660','78484','38486',
                          '28152','62136','80499','99953','87278',
                          '68165','28650','96419','78579','56030',
                          '53635','63156','89850','67390','83513',
                          '96804','40556','32105','51870','58198',
                          '96708','23541','12336','80539','20332',
                          '34756','11414','52714','10384','64515',
                          '22433','22934','62436','92338','37397',
                          '14349','37514','51138','51175','95031',
                          '43077','63959','27684','98889','99397',
                          '20103','71372','86507','70681','37076',
                          '71462','43049','92496','60749','20658',
                          '72673','60511','35383','72527','90432',
                          '96655','44284','20728','66495','80324',
                          '14975','52799','59086','96197','60593',
                          '58657','84305','72383','39938','97060',
                          '18135','48027','96519','58311','14378',
                          '59258','42317','57519','31726','16507',
                          '35422','74263','64011','79830','95210',
                          '14855','71572','43511','17062','82095',
                          '15245','73797','83324','94476','56797',
                          '18812','83295','54650','21285','84814',
                          '67276','18859','94401','72133','83311',
                          '36173','71835','25006','32219','10391',
                          '21974','96974','98127','10707','29211',
                          '44938','55327','11433','46330','30392',
                          '10150','20879','73799','91852','36490',
                          '54508','75285','20039','38506','70847',
                          '27052','59286','68662','83882','75732',
                          '44221','53214','49597','97695','85412',
                          '97959','44061','35346','48215','30969',
                          '90514','90243','16603','25232','46242',
                          '67074','82823','35019','31142','72008',
                          '61901','56937','51575','23378','37037',
                          '20213','44954','63646','87955','95119',
                          '39728','76531','69520','51490','64604',
                          '24469','54359','84738','78768','27846',
                          '55348','59613','51657','82235','53163',
                          '66550','63449','24776','84969','61043',
                          '81857','43459','42062','38248','99329',
                          '10790','87528','76596','35386','75156',
                          '30696','50971','34990','23236','34611',
                          '52534','85550','13544','72382','49398',
                          '66003','37499','89113','40824','88381',
                          '36821','57446','17937','50552','37865',
                          '36693','36793','23302','62889','68959',
                          '31069','17003','58434','95746','59871',
                          '13963','94203','58395','62377')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


