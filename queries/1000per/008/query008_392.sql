
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '20862','20139','90549','82147','60838','71854',
                          '11846','81025','47795','33756','79989',
                          '86586','50323','68695','92143','94494',
                          '85221','26644','42845','25451','59761',
                          '98454','61127','84384','61809','56301',
                          '76331','77182','34687','27784','56315',
                          '42166','99315','49424','77693','91007',
                          '16155','24856','77867','59930','60715',
                          '81374','23842','47793','26194','89223',
                          '71395','10010','76015','95967','66309',
                          '40242','28822','30662','96437','96776',
                          '86027','14735','58550','81881','37124',
                          '38589','47022','13565','48035','42119',
                          '54929','24802','74963','92511','24883',
                          '27596','41457','54735','20786','54945',
                          '53783','16896','35625','77977','66413',
                          '57487','95521','73895','60138','78893',
                          '60120','87798','12480','17773','37380',
                          '17886','29798','83599','59027','34059',
                          '45555','15469','86905','83481','96911',
                          '30752','75959','57032','11413','59334',
                          '43994','64598','30630','67436','20982',
                          '63194','15356','80763','89224','13598',
                          '58397','64139','98264','74106','61256',
                          '49235','66394','47262','81885','79661',
                          '40062','66317','75108','29842','50492',
                          '61540','92724','87601','48357','79933',
                          '91649','55835','99765','14689','64751',
                          '53262','48270','78686','18790','60595',
                          '18447','97744','92940','66688','72590',
                          '35622','50976','12809','89575','47670',
                          '13107','62851','78857','14814','83830',
                          '42367','48871','14276','85098','16690',
                          '61390','32371','65057','46057','39507',
                          '37532','30954','50628','46898','14410',
                          '34896','19959','18240','38811','79327',
                          '44943','75556','34360','61564','34545',
                          '57704','97344','81019','98839','61003',
                          '86372','15792','12596','80192','16367',
                          '80951','99081','87730','31499','40508',
                          '46483','15916','54525','14479','29975',
                          '91559','69617','82138','54977','14465',
                          '79502','59154','56462','22219','29766',
                          '76851','73331','26941','49398','84525',
                          '95730','45531','34619','66692','18468',
                          '48915','12930','72683','34996','57741',
                          '44706','86046','57263','92632','34145',
                          '28558','32255','42411','67678','39946',
                          '26255','73060','81388','33056','53628',
                          '64495','90956','77023','51656','26890',
                          '51529','56473','18118','33011','83565',
                          '26081','44399','99313','57791','66840',
                          '31988','42815','97724','23188','94331',
                          '81979','49886','51190','51208','62887',
                          '34136','40078','62357','44358','23255',
                          '36892','63114','23557','50072','41974',
                          '84016','94303','33261','32965','57673',
                          '99279','25802','90680','21810','95187',
                          '69127','30790','53295','38878','54262',
                          '86940','15555','60074','88963','11013',
                          '61982','88103','55104','37173','76945',
                          '82083','62724','36188','33999','98632',
                          '45659','33743','72485','99987','81136',
                          '18097','57878','14035','82226','28364',
                          '15107','29822','90735','86174','46319',
                          '65507','69275','99642','99783','85489',
                          '61962','14744','99695','97050','90087',
                          '60306','41614','47389','39791','13867',
                          '47721','78799','68643','65615','90927',
                          '28664','54380','81137','92368','47482',
                          '72033','26616','36778','46106','56210',
                          '54771','71860','53158','60169','46984',
                          '60511','70315','95202','41316','89076',
                          '62260','56854','39709','97447','39163',
                          '10065','99043','47213','38766','84567',
                          '87554','74603','46268','31825','83398',
                          '57668','49121','64889','20527','85637',
                          '12288','31279','93245','50654','40452',
                          '54424','34782','94645','76452','56577',
                          '33292','62878','60230','25052')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


