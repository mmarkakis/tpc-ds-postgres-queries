
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '80682','53041','95953','41738','77155','96599',
                          '93914','51931','69540','12184','57815',
                          '15686','46387','99423','53707','26701',
                          '99573','18230','16285','44647','54309',
                          '36829','22722','21847','45766','33737',
                          '80782','94843','60738','38536','33528',
                          '10713','24110','40923','96823','15125',
                          '10226','33942','71157','45467','24287',
                          '65078','46329','10355','38252','30938',
                          '71688','74693','65483','43110','71032',
                          '88124','54300','12364','48846','57531',
                          '13183','71930','14124','75700','77631',
                          '34974','76586','77546','78119','70746',
                          '26749','28382','54059','78255','74673',
                          '56745','73599','33771','32648','99059',
                          '19829','23385','11161','15264','47784',
                          '45818','94119','60617','73113','10805',
                          '94437','45244','77885','84010','84314',
                          '12633','76288','31967','18813','96454',
                          '70183','71821','95279','47800','26972',
                          '75138','73921','26522','95535','95290',
                          '65725','71794','75001','67576','85972',
                          '86098','51049','55314','63646','81703',
                          '51087','97444','43786','78668','92150',
                          '72813','93182','27376','15807','37687',
                          '43293','54513','12125','54941','16716',
                          '55006','64235','60431','16319','42201',
                          '61163','67409','49693','52981','91336',
                          '39064','54139','97587','22870','38990',
                          '20040','65208','20565','71689','89613',
                          '53890','59309','40209','33127','93949',
                          '13653','94527','44256','38049','89880',
                          '89415','66146','68655','14738','19620',
                          '45222','77217','71805','87856','20371',
                          '11436','46066','32901','39147','36703',
                          '55152','41435','24863','27001','89805',
                          '88446','23311','22784','31276','18625',
                          '31173','66550','94359','95231','97860',
                          '10347','85579','67106','72294','78471',
                          '91787','84533','84870','68138','12897',
                          '56836','68410','33036','42719','77776',
                          '74324','67501','13207','13934','16877',
                          '32462','78934','18454','85204','75723',
                          '60842','83878','46334','61381','33196',
                          '51259','96314','70575','96513','13863',
                          '45160','90043','37150','75768','98813',
                          '74973','95422','92632','87064','89815',
                          '98692','93581','39678','80220','97790',
                          '71955','77890','43123','22796','15701',
                          '11545','94466','37758','25262','57490',
                          '15111','13246','43268','12865','35050',
                          '58274','71122','15089','84516','10295',
                          '11889','26556','40016','32659','22294',
                          '11331','24865','64168','16526','57511',
                          '29719','41251','17604','91238','94139',
                          '69668','71325','73328','17234','70704',
                          '35128','88041','87995','27502','95988',
                          '98733','17441','37602','89026','97619',
                          '43823','65681','11499','56706','46359',
                          '92514','69058','85221','24792','99391',
                          '51190','49112','75339','91056','84718',
                          '31191','94853','30961','19084','66624',
                          '36612','70241','41505','44830','74369',
                          '78155','23632','28028','83790','97253',
                          '28271','51970','60046','17470','56879',
                          '97883','56887','59688','90799','30322',
                          '94682','91626','11909','34527','66406',
                          '70519','30034','46392','46617','89486',
                          '48094','31677','38892','45517','12565',
                          '67932','18544','74272','91349','76059',
                          '91642','85310','75110','53550','29091',
                          '13382','35877','39961','29765','26037',
                          '72327','30037','90910','16784','84084',
                          '84587','47988','19029','26056','74124',
                          '60981','80956','97127','60126','41355',
                          '50307','10531','24844','20380','56087',
                          '18277','94080','36099','25869','83488',
                          '73751','76486','73518','24238','85874',
                          '36847','34735','89149','29561','93019',
                          '11735','88345','70943','10553')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


