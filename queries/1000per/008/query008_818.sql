
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '88457','43068','86149','11322','24144','47804',
                          '78919','60226','20538','61160','62739',
                          '41764','54280','51795','12424','98509',
                          '20991','63044','97337','21613','50150',
                          '55790','90311','98434','81476','78312',
                          '73153','41524','82023','16186','19407',
                          '15287','90062','60265','98652','57279',
                          '81297','89783','66043','21334','21313',
                          '35557','27301','77093','25144','70081',
                          '24563','67099','56931','97250','67640',
                          '11653','97617','58280','80467','89672',
                          '76095','95650','98130','78707','26425',
                          '78353','47537','34070','26821','94255',
                          '23163','99834','64069','53267','56849',
                          '79507','67327','80057','24988','19865',
                          '97095','29194','69424','86246','35946',
                          '97597','95377','36910','85402','85159',
                          '54725','96326','29574','56888','63420',
                          '98700','70472','55527','93464','20031',
                          '24406','17692','94327','66546','82087',
                          '68056','73605','74925','40391','12855',
                          '68569','25092','88656','78033','75688',
                          '15923','79962','31368','18184','44954',
                          '16484','58731','66820','79719','43267',
                          '16135','41618','21960','71733','76469',
                          '94703','11672','84635','46375','45072',
                          '86373','33414','87213','74157','99116',
                          '74028','78342','98348','13406','84989',
                          '95744','38241','81660','12134','37130',
                          '13729','98756','87189','10641','69028',
                          '90196','87535','92915','94835','84888',
                          '90123','82935','93698','52298','94058',
                          '90663','80273','54156','78061','70388',
                          '68361','65827','62849','51862','36799',
                          '69035','29215','46397','53073','35180',
                          '21792','47157','95051','57209','39038',
                          '79796','85329','16216','62827','58633',
                          '67715','83135','31690','93046','28814',
                          '10149','10610','44723','56609','20613',
                          '75155','69288','25691','99406','13976',
                          '47286','47144','59383','74839','36641',
                          '92063','23727','60971','54368','22943',
                          '24562','13330','88540','24177','99418',
                          '88330','80388','96554','78134','85684',
                          '99883','26281','57973','37244','74284',
                          '30400','71836','92769','53316','61512',
                          '14374','32212','92401','67090','52228',
                          '49965','71815','92073','50264','45295',
                          '29966','12623','69190','67184','79444',
                          '97766','36107','52090','31349','28948',
                          '14175','76458','69251','46196','54155',
                          '91485','86469','47060','94340','14393',
                          '37287','48297','92178','22742','86520',
                          '37789','52813','55253','45621','69340',
                          '46913','21305','70362','47657','27305',
                          '41124','65080','42491','20275','35234',
                          '73446','99458','80192','17791','91192',
                          '49400','87051','51457','87639','45538',
                          '13114','13276','65628','96293','92544',
                          '43098','37165','43984','64260','27637',
                          '97667','99405','52976','85131','22180',
                          '60700','15719','21851','31141','17507',
                          '54363','61977','52439','38919','55121',
                          '72040','35377','20799','78076','82050',
                          '46735','10182','46688','93059','16049',
                          '59349','86919','84206','85207','34359',
                          '19513','40959','57966','95473','57330',
                          '86045','26982','71151','75665','34859',
                          '65384','27717','98581','50667','16235',
                          '15184','38159','11755','93473','71961',
                          '13802','10393','55981','11165','19001',
                          '67430','65762','12582','79606','97781',
                          '87518','86732','80883','25258','27283',
                          '20443','60623','51364','58357','52341',
                          '20664','77848','59027','69570','88229',
                          '23915','82028','87982','33939','81299',
                          '72333','57036','32778','46085','24752',
                          '56827','62266','89386','93397','99155',
                          '95665','40160','97359','36408','37136',
                          '33151','47807','60860','72498')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


