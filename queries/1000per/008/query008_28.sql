
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '18833','21043','16498','67749','19107','51080',
                          '77327','18471','40755','13121','23219',
                          '71208','52797','61689','62689','13469',
                          '17266','13522','33524','64992','35594',
                          '60105','42313','78247','56109','30125',
                          '53642','30184','49414','31450','77957',
                          '26962','93497','84063','55610','65139',
                          '50623','46396','81564','70240','80086',
                          '93383','24921','58750','49995','69512',
                          '92313','12125','59572','69827','65684',
                          '11242','32220','32740','71728','90103',
                          '24603','70307','40591','61282','27648',
                          '81443','30408','26056','64870','54832',
                          '97510','68288','89708','90654','23540',
                          '79261','11884','71193','92947','60993',
                          '19485','80573','47778','16814','67463',
                          '63837','91339','82456','42109','16372',
                          '13916','33120','10331','35349','53582',
                          '79112','52954','62519','92408','23784',
                          '33813','32125','74411','63651','37852',
                          '38839','93656','76203','80999','13231',
                          '39140','86555','53168','42325','83751',
                          '55109','37800','45996','69446','92750',
                          '23289','44551','92667','13725','50754',
                          '32204','52761','18836','53059','33335',
                          '82132','47475','75143','14703','40022',
                          '42554','21384','22741','11867','51746',
                          '73095','60855','32738','23971','68450',
                          '70910','44233','17426','33355','89846',
                          '82653','30383','75664','40857','81788',
                          '75691','97378','80740','65415','32001',
                          '87636','60900','99808','58107','16723',
                          '54599','62724','11793','16731','63191',
                          '21457','86643','81250','73364','87349',
                          '54023','54765','44026','29820','96626',
                          '23191','11527','69193','64085','65928',
                          '99751','79342','40514','28512','65299',
                          '22858','20504','28649','94174','11461',
                          '27791','70917','72719','88423','27977',
                          '19297','40574','99279','38002','99265',
                          '53796','72278','10585','90896','24059',
                          '24442','37069','10294','70275','31673',
                          '47894','15035','30488','56644','89369',
                          '31401','86529','39194','48000','34820',
                          '66418','63825','18701','74775','52656',
                          '33402','21346','78632','63778','52678',
                          '14216','89926','27945','64641','59483',
                          '81633','19899','95221','67272','55332',
                          '28922','45532','34097','13217','55451',
                          '18880','94389','89443','87751','67928',
                          '30831','42319','18487','42663','81152',
                          '12165','63564','68003','15889','97412',
                          '32865','79273','80505','19601','91350',
                          '59677','14000','82185','65382','34130',
                          '70738','22148','83043','62560','11740',
                          '81893','31288','31225','77877','32318',
                          '46712','88875','28241','40493','75911',
                          '81589','31633','42833','96075','69123',
                          '51997','25286','67930','28286','49530',
                          '81240','83461','54092','66419','81333',
                          '78723','44278','81115','24872','46177',
                          '24388','21101','89139','80120','29944',
                          '62634','56902','92718','46570','32530',
                          '87631','92107','68507','59970','98204',
                          '19919','97251','49937','77796','76919',
                          '20348','81120','94696','99421','30242',
                          '78896','47566','62079','32914','95357',
                          '12328','98625','23353','88721','83649',
                          '71773','50383','10632','90664','65359',
                          '15205','32355','74879','36874','21749',
                          '83987','18095','79907','66556','94877',
                          '84528','43035','94354','47145','39819',
                          '93813','27042','23147','35463','21018',
                          '78054','14718','97757','36038','62540',
                          '20055','66396','24692','38823','11205',
                          '73891','47447','15132','45940','23685',
                          '60150','99025','35190','92539','32414',
                          '58774','58102','87188','66371','70286',
                          '78713','80533','25629','28992','85066',
                          '68332','43186','48414','74264')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


