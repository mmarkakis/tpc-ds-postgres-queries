
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '34693','93644','26834','92378','21390','17882',
                          '70376','40970','69399','21155','72154',
                          '55918','34785','65100','67882','84328',
                          '67904','44850','53866','13172','87207',
                          '43662','50413','68855','11095','12973',
                          '90143','54401','30670','94662','72879',
                          '18885','82004','99053','31760','79692',
                          '59228','47959','16486','90966','70914',
                          '60517','98832','24836','15635','24865',
                          '76233','87551','69873','54679','66549',
                          '55239','15996','13524','70628','11482',
                          '76056','24421','62503','91922','59546',
                          '61704','33408','20015','39724','65276',
                          '95146','78376','92345','50415','11160',
                          '70510','81705','76345','89061','36555',
                          '40939','33290','91929','42305','94950',
                          '91785','54551','59781','79465','83564',
                          '94983','10758','53341','70524','11147',
                          '68939','62627','35458','63200','21399',
                          '58567','83918','99504','48091','14317',
                          '94206','41243','80114','11386','92228',
                          '59169','62762','53442','91726','86281',
                          '80554','15124','76882','89062','59123',
                          '14873','36444','54450','15589','42823',
                          '15625','47859','24864','86230','66209',
                          '91435','63697','80773','69605','60298',
                          '11394','19466','92981','58660','88107',
                          '59834','12252','35295','24079','70206',
                          '87177','33411','40671','87563','69200',
                          '11472','70462','43509','77839','71608',
                          '60453','46093','21696','51353','44963',
                          '98653','33425','88684','54089','99477',
                          '39014','63265','39668','96042','98464',
                          '47009','21860','89841','10009','46883',
                          '97383','48092','24982','29746','90654',
                          '14355','84662','66247','39624','73963',
                          '78978','60122','20475','30918','39661',
                          '75481','53829','45651','17802','11957',
                          '15742','64619','41351','73457','70043',
                          '30108','52666','30418','63993','15236',
                          '51683','85193','83125','74930','34092',
                          '56447','34414','88104','37782','23699',
                          '88324','53477','57688','85878','95384',
                          '87873','35346','67819','47428','66346',
                          '69161','38899','45748','94962','26398',
                          '83365','20591','47589','70785','59855',
                          '46552','60232','82550','74820','85504',
                          '46324','16713','70512','60390','10217',
                          '85797','34801','60862','70569','87799',
                          '16413','90630','49780','17727','42596',
                          '41790','24850','91546','15781','53635',
                          '46733','70140','37733','82818','20019',
                          '87509','12887','83646','10623','79514',
                          '26170','32127','45615','64968','51743',
                          '61526','84310','63944','84478','70589',
                          '39467','70284','97025','12219','58405',
                          '53561','89388','18060','31554','59772',
                          '50598','33775','81599','98593','44518',
                          '40849','61117','59214','31011','82408',
                          '99229','25922','45610','18787','37182',
                          '93947','68637','50465','24615','99863',
                          '79758','43472','89421','66326','85615',
                          '89702','94198','45180','25464','70897',
                          '55187','32944','36759','39752','23258',
                          '52737','30486','30629','64103','86306',
                          '65622','25411','47973','85983','56978',
                          '92612','68152','64324','31892','36653',
                          '18114','91419','59794','28050','97935',
                          '68947','49664','80169','15951','24776',
                          '93897','79400','17942','39865','87575',
                          '96931','93497','70583','38941','82228',
                          '62504','83210','49398','36433','44926',
                          '28170','76962','65368','26460','65404',
                          '12995','96805','23975','21127','81373',
                          '88092','72748','26589','54018','82761',
                          '43078','34136','26948','15873','63059',
                          '24126','15623','76975','58919','40741',
                          '44594','90358','43858','31929','31121',
                          '26995','34896','56370','67229','77269',
                          '88979','53977','95175','72157')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


