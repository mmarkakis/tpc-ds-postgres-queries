
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '41350','50048','87919','93540','57197','42084',
                          '39192','70578','72554','23235','87787',
                          '53713','88178','84717','52734','44067',
                          '15260','40900','77613','46162','35869',
                          '45024','39529','48093','83093','32107',
                          '21596','15224','84444','83822','43036',
                          '37677','36428','53295','71971','97926',
                          '29534','27552','94183','59584','20686',
                          '57920','25481','19382','34976','72116',
                          '51088','64712','90229','68495','28200',
                          '48442','11874','54759','55388','24715',
                          '34213','73656','95812','35892','55664',
                          '35235','92644','87609','26150','61241',
                          '98910','28233','44530','43723','17410',
                          '98843','13381','73339','20693','77965',
                          '98548','55025','82131','40185','32087',
                          '30366','50562','30348','13072','70307',
                          '67432','18130','32347','57865','99577',
                          '62394','80875','97900','44171','75712',
                          '73883','75251','62806','80501','48800',
                          '34186','36784','39488','51323','35120',
                          '86720','51641','65014','26391','89384',
                          '12774','32043','53480','93294','56622',
                          '28143','14638','34258','65202','18860',
                          '95178','92761','39752','12864','62665',
                          '47822','72884','41785','44019','40339',
                          '30587','20840','22662','72663','48425',
                          '54370','51258','75554','90683','66634',
                          '18913','99174','61322','57166','58814',
                          '13221','46354','26944','88414','40028',
                          '16196','97171','26195','43625','82018',
                          '51148','87414','15476','73422','27626',
                          '86506','20378','10767','24550','54770',
                          '47972','28175','35405','19817','95587',
                          '70697','35641','49108','70357','49332',
                          '81455','59322','65887','46789','77470',
                          '95838','38830','88561','11809','84050',
                          '84972','78081','44242','32872','17402',
                          '16245','37598','90459','39250','72642',
                          '43827','30246','90632','87014','90489',
                          '75256','20626','78134','39014','45506',
                          '27402','19536','83823','17849','51361',
                          '93996','36071','52347','45621','97462',
                          '52430','55595','81015','97680','78597',
                          '97905','98671','53173','81559','79243',
                          '33462','50985','96961','69058','31251',
                          '82571','49974','79184','59165','27480',
                          '49431','76180','11680','20572','66357',
                          '99867','59524','73927','18007','34746',
                          '92541','90940','34799','35999','92442',
                          '65821','44716','29940','84933','41426',
                          '11425','91143','86473','98710','84796',
                          '39905','63618','30040','90600','92182',
                          '74134','87754','29098','95944','53839',
                          '45393','21590','45281','86408','49731',
                          '69147','29864','30978','22974','48965',
                          '14819','23720','38903','44773','60898',
                          '25508','85775','92088','13507','58063',
                          '10474','88602','58553','41372','95537',
                          '28079','49779','12755','96899','21477',
                          '84611','14484','65686','24431','87240',
                          '97920','13119','10977','70735','85213',
                          '67374','72037','41437','19933','36799',
                          '37585','83109','98485','25083','62981',
                          '50396','32019','78148','50369','39387',
                          '81026','74245','84034','10883','26041',
                          '81661','29304','31271','98773','98159',
                          '66981','37535','86219','11109','42218',
                          '34750','34274','67870','68600','23594',
                          '37268','33559','12215','89063','14776',
                          '88452','25788','32978','83668','85578',
                          '33356','23489','27313','15700','98334',
                          '18185','81306','58312','91654','81302',
                          '39072','25758','33826','36843','79723',
                          '12135','95737','80886','42555','17642',
                          '94373','14414','94437','53176','95160',
                          '97983','37296','32346','14994','67707',
                          '46996','35750','61137','53649','24536',
                          '73547','65895','96137','17079','10858',
                          '73592','10761','35180','11370')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


