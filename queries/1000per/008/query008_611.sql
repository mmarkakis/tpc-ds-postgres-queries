
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '93245','87398','18876','65049','54747','54264',
                          '32474','78768','18720','87794','32445',
                          '81963','10123','30719','94857','63568',
                          '97930','46296','95777','96510','81525',
                          '47254','98203','37539','96970','19519',
                          '81041','88313','54008','77744','39158',
                          '61040','64083','84599','39213','60244',
                          '96642','95298','37945','45679','69792',
                          '65397','23387','53467','60662','17724',
                          '44007','34130','76600','71166','29017',
                          '21719','22455','87266','66923','31952',
                          '99946','30735','18088','37538','71546',
                          '78133','49848','25454','18650','69188',
                          '40086','87844','35148','67340','11613',
                          '61752','68058','69506','47644','95720',
                          '13114','66868','84882','99427','46148',
                          '15628','84147','58311','76289','52205',
                          '43198','28341','19999','50155','78067',
                          '20341','92568','64029','17181','66402',
                          '26648','81282','64416','93568','21715',
                          '77796','76086','10718','90535','57754',
                          '86482','38056','22139','24107','37233',
                          '84654','31737','65360','81214','18554',
                          '77851','12251','16207','87213','91611',
                          '64550','97683','55863','20221','26146',
                          '14961','55313','21609','69297','44041',
                          '56073','61924','48259','96517','49599',
                          '49040','78202','22852','96378','74283',
                          '42255','78852','85839','83822','92481',
                          '47634','96727','62736','12038','95701',
                          '83011','53237','78658','31401','18277',
                          '65949','76473','51042','24887','95581',
                          '98602','58805','94520','22134','16604',
                          '17281','64766','93287','42702','56276',
                          '63274','40296','55890','32270','95618',
                          '16841','82976','77478','37513','11122',
                          '47371','36052','18670','49372','21424',
                          '41285','92050','18449','69471','47086',
                          '68545','11852','66855','22807','39630',
                          '47771','85050','57351','68281','61196',
                          '28354','48467','86740','11570','92364',
                          '85964','43471','28588','93700','57266',
                          '70296','32523','33884','30361','89813',
                          '69194','31112','49018','50884','73341',
                          '82082','20541','56320','14440','83004',
                          '26553','45473','66580','47115','27578',
                          '11137','77379','54516','41396','95128',
                          '47428','16189','16315','61465','72988',
                          '12782','57627','94650','76519','43861',
                          '59855','33476','76809','95732','13798',
                          '39688','61136','36828','82468','74969',
                          '91575','78889','95420','95682','87528',
                          '78624','25010','29275','80346','61167',
                          '94411','87425','41378','78346','60753',
                          '40790','94368','30044','26587','22187',
                          '24708','42508','76170','64581','24460',
                          '98251','30175','39609','24190','69204',
                          '56620','67750','51969','48245','40850',
                          '97287','70925','81275','93580','81542',
                          '64755','19158','47659','54745','12320',
                          '83161','40365','27609','34135','32391',
                          '86450','34270','27173','95367','13142',
                          '77900','14897','96760','35096','20810',
                          '43970','49876','15280','83494','28895',
                          '77339','40860','34065','35611','88466',
                          '25543','37120','67678','89251','59187',
                          '51611','92043','18032','13173','78341',
                          '66057','64373','45828','31908','61292',
                          '82041','23192','58908','68059','12446',
                          '15055','30422','71998','54190','40724',
                          '97125','34907','72920','46443','56979',
                          '75846','84731','50746','47760','41527',
                          '92362','50015','47858','91065','83243',
                          '88925','47085','42200','78787','88239',
                          '52797','55589','36370','89480','31664',
                          '17640','83368','87643','35436','88371',
                          '24791','97167','11257','52117','95106',
                          '20280','49166','53862','72374','86036',
                          '54501','70115','19329','18764','69402',
                          '28524','66127','87194','20673')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


