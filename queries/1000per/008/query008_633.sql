
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '67816','59909','57353','43744','59780','97364',
                          '91077','12110','85445','47560','66668',
                          '70173','96439','80128','51679','50181',
                          '10703','51312','90149','27303','28839',
                          '19275','39920','73914','13944','76067',
                          '49385','49674','75629','61808','83075',
                          '10348','36094','68395','72206','37141',
                          '48878','10229','34818','84074','13111',
                          '10012','80483','23738','44488','79759',
                          '25473','65652','90377','45758','66083',
                          '35633','56078','72844','69440','29688',
                          '91937','42942','50779','89728','95543',
                          '83698','77394','69817','46827','30248',
                          '36387','89148','22308','31143','32315',
                          '29822','69747','51747','38564','62653',
                          '48998','97399','57862','18182','53187',
                          '91190','47840','72209','95145','85020',
                          '71417','79260','75498','30852','33929',
                          '91430','18306','30122','17344','32234',
                          '16246','21530','21445','71469','82622',
                          '45214','21153','85085','43614','98839',
                          '96126','78224','74102','57858','27623',
                          '56458','11418','64466','72350','15775',
                          '39911','21097','90425','37692','69707',
                          '83226','96484','34440','19786','75957',
                          '80141','97934','90028','69485','26272',
                          '59008','10186','47868','76002','53854',
                          '53360','47946','48430','19555','76346',
                          '54411','88640','36465','77055','55373',
                          '95076','77833','76283','60192','77352',
                          '97841','91799','82730','58906','48567',
                          '75827','33612','23153','19627','35231',
                          '93755','85438','65330','65916','72804',
                          '19035','40429','34642','68392','17569',
                          '83347','37576','67000','94649','67080',
                          '47052','97335','83237','23417','94133',
                          '33705','99715','38725','32526','64232',
                          '82323','67634','50018','47055','59043',
                          '67643','45877','24481','89996','44086',
                          '86118','21663','63646','56360','41586',
                          '36820','65219','41886','71527','11813',
                          '62327','10196','55410','46898','76762',
                          '16142','43990','37162','95024','19652',
                          '59148','57359','57810','77585','90916',
                          '12718','23525','73871','17997','54029',
                          '22644','51200','64090','50304','67274',
                          '59178','31585','85436','79306','39014',
                          '42928','70168','53011','97638','73443',
                          '50239','73092','16329','27401','92920',
                          '59222','15758','43204','53180','97427',
                          '90482','55729','29182','44239','68554',
                          '13198','62742','87657','23360','57939',
                          '14033','39035','54247','20106','48505',
                          '55245','84522','82579','36631','58871',
                          '44109','85644','93058','72769','69816',
                          '65730','68298','98601','89006','83297',
                          '85509','86162','95286','41517','58200',
                          '45417','32540','25780','80882','86155',
                          '34435','96500','38422','52419','14790',
                          '91744','50041','73561','90522','91843',
                          '11433','41547','25928','32831','99825',
                          '43146','82402','36792','18063','72570',
                          '24646','20802','30102','83038','57210',
                          '25377','92107','60955','93582','47211',
                          '21683','16374','76404','28318','45841',
                          '16978','24874','67021','97718','66513',
                          '62405','21947','58424','49250','95852',
                          '92552','26402','52554','39903','85235',
                          '55783','63066','23695','89823','68006',
                          '68039','24833','74587','43485','75622',
                          '76010','74620','24467','54545','81541',
                          '96102','15307','38186','15968','74752',
                          '55402','38119','62724','99059','97007',
                          '39831','13400','70706','85624','53662',
                          '50275','57522','26082','95971','47546',
                          '95755','54828','10672','54852','20565',
                          '50216','76129','34109','49764','30919',
                          '28409','14141','60245','65827','27017',
                          '20090','95260','37167','99478','78511',
                          '71904','46295','77931','95958')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


