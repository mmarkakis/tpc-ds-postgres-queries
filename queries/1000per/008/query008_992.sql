
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '70162','28814','50670','34934','64040','87536',
                          '56632','96704','74656','90063','63220',
                          '25873','77162','24697','64973','23736',
                          '62780','24656','54918','96063','32663',
                          '75108','27765','33660','31565','77605',
                          '39115','37940','64082','95758','37999',
                          '15582','86177','69545','64369','76654',
                          '54922','20112','91469','26292','78177',
                          '77590','61900','39359','90440','53956',
                          '72244','99188','60213','53516','73639',
                          '59950','87119','72464','47260','87656',
                          '83222','78389','28949','14143','78181',
                          '30994','37891','99601','45957','13944',
                          '21935','93487','95044','95938','33440',
                          '50644','11016','12629','25501','33289',
                          '87701','57832','91562','79377','13674',
                          '53923','74301','90213','40376','79452',
                          '28532','43166','39555','90992','60827',
                          '68004','27059','86261','71520','46448',
                          '20738','66687','41445','77314','45667',
                          '80263','61394','31754','34506','50757',
                          '62918','56108','35440','78130','50695',
                          '25599','76707','30584','68317','38859',
                          '76445','17060','28594','78144','59978',
                          '51669','60688','81035','47770','29502',
                          '15608','38986','35536','89312','69720',
                          '30152','81826','21298','87695','39699',
                          '10753','70898','36486','56676','76791',
                          '60057','53028','32207','18299','51971',
                          '44658','83682','61168','65013','70737',
                          '86876','87089','25793','51171','69982',
                          '59549','51339','11940','70244','95047',
                          '29588','41742','48656','98012','18348',
                          '67436','41203','95902','81976','61378',
                          '99094','46671','83634','53580','65689',
                          '90006','48489','56285','57624','33170',
                          '36202','99447','10884','62707','77423',
                          '94972','39841','84817','46628','97314',
                          '96283','17486','92043','13936','14501',
                          '81522','84877','73481','54907','53880',
                          '81568','49430','88954','35178','91255',
                          '68343','56906','84587','33838','96532',
                          '38061','64244','12595','72458','39956',
                          '15134','36191','30882','48251','76500',
                          '60893','63447','89427','46895','59317',
                          '91287','90642','81409','75816','77885',
                          '21401','57777','12566','46775','72529',
                          '23009','11470','90696','39174','41627',
                          '36285','20916','63408','89807','81785',
                          '46966','53404','84814','63406','69843',
                          '75498','78212','23454','61949','48677',
                          '65300','88505','63136','50296','51736',
                          '49846','21331','52166','92745','29441',
                          '10355','19114','36246','80240','33689',
                          '66893','22384','67512','85340','49614',
                          '23799','69497','47292','51349','84133',
                          '71439','67184','15791','65030','82222',
                          '54718','42292','83434','78426','57895',
                          '67153','83502','82657','41077','37485',
                          '28694','43955','89930','62449','42044',
                          '43239','25284','68115','75550','83695',
                          '91656','31304','93349','23259','88578',
                          '62358','89697','83335','78320','69712',
                          '74279','38877','52942','78641','36198',
                          '76396','20365','57780','18152','54296',
                          '95018','91507','40994','91066','51389',
                          '94287','75171','82338','90379','60511',
                          '96514','25198','99745','81256','37970',
                          '35800','72388','36195','92039','81233',
                          '82088','38433','13062','31450','51813',
                          '52814','61715','41159','62640','85557',
                          '18955','31173','94043','71560','15040',
                          '40080','34470','77133','50578','29838',
                          '87608','37961','91835','52958','77864',
                          '33004','39439','45718','89010','60328',
                          '72209','49449','63438','71140','96138',
                          '28511','14433','16552','40501','55584',
                          '11281','43986','51654','30746','61727',
                          '95941','55481','17560','45767','84258',
                          '95559','41201','92558','23205')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


