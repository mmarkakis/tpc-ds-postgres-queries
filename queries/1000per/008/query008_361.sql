
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '94928','31283','64437','33614','18039','23191',
                          '80589','97616','13661','95973','69171',
                          '48147','38224','30320','69221','69558',
                          '82325','94166','53024','87853','51564',
                          '34725','47652','69888','17673','27450',
                          '63809','82728','53043','23192','77838',
                          '53336','36545','95114','92683','88572',
                          '44365','99419','45391','26322','66308',
                          '35169','52889','94885','31457','85566',
                          '81607','84747','35700','73987','53290',
                          '80656','98668','45538','54412','96944',
                          '48145','57202','28375','52549','61009',
                          '34119','15376','90520','24936','14285',
                          '39893','65016','34368','40354','91337',
                          '44994','35772','19906','47114','37635',
                          '45821','97278','22324','26097','52097',
                          '55574','75902','90534','28707','10021',
                          '65494','60651','63769','39331','12211',
                          '56162','88227','55688','27961','24897',
                          '92024','26376','30226','93132','28269',
                          '96754','54440','94175','41832','89706',
                          '11662','37740','33608','58991','41809',
                          '43240','30954','75108','73206','84833',
                          '55472','97509','67856','48690','88704',
                          '98447','22692','96726','62868','15058',
                          '54542','68067','70873','79196','61382',
                          '29624','30111','57569','85282','68885',
                          '98741','83740','59580','84324','90240',
                          '25253','18226','47816','57978','45273',
                          '94645','28010','64779','59522','49867',
                          '57712','16669','57761','20565','29638',
                          '20341','92606','70953','86579','10158',
                          '32222','78359','54525','66338','52123',
                          '99266','89415','15846','25407','87809',
                          '74759','45501','91364','14587','98070',
                          '31964','21089','71818','52875','46712',
                          '91695','67278','12335','81627','50470',
                          '92591','93895','12643','93246','67094',
                          '98181','62909','49839','87422','64863',
                          '15432','40705','89157','79925','40567',
                          '57245','19922','13040','84540','60345',
                          '91154','97560','96499','89973','84424',
                          '28389','85115','39545','51576','21717',
                          '54829','67922','63407','79298','59962',
                          '45381','34138','25966','13192','86326',
                          '72561','73648','59798','72530','45860',
                          '22454','98853','77133','29235','29647',
                          '93402','43027','77681','34045','71703',
                          '29118','39623','44610','98004','61087',
                          '75928','93060','62974','55754','24402',
                          '75251','64267','29733','77318','29253',
                          '28084','80164','76578','25936','10712',
                          '65090','63325','29628','67177','74335',
                          '93530','86105','71282','39165','42525',
                          '86815','13648','94499','59015','31311',
                          '79089','97668','63069','40476','88060',
                          '46781','77788','11669','84175','50904',
                          '25406','86260','34302','40488','23419',
                          '12426','78737','36763','47578','18177',
                          '89701','73610','91027','39086','98046',
                          '78944','39280','18024','23450','41008',
                          '56101','59556','15299','45104','17103',
                          '99321','17177','91228','48812','30910',
                          '78771','62051','32333','23075','96923',
                          '97849','76332','79036','62556','72949',
                          '80112','30154','15741','69786','74126',
                          '18462','93813','26927','35397','76469',
                          '31739','76134','17132','24257','19939',
                          '98524','70063','30283','93919','47151',
                          '12909','37427','10766','67937','21790',
                          '34353','78690','50285','99567','84913',
                          '88444','69630','23948','68235','19754',
                          '13753','50851','11515','77766','50822',
                          '35343','93167','20696','85994','38841',
                          '87842','64345','18732','49501','51773',
                          '54113','69979','28732','68185','51980',
                          '67861','21866','33352','49848','78769',
                          '78380','77602','62494','10546','80967',
                          '61439','92836','74820','61460','82114',
                          '85007','43464','46488','46615')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


