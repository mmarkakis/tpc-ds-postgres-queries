
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '99994','79162','64682','95790','18251','25158',
                          '92330','29060','49044','94509','42732',
                          '39495','31376','20154','57523','60750',
                          '75390','67513','39764','33222','61540',
                          '49876','46809','42297','45572','52684',
                          '63638','69975','55234','35335','52350',
                          '64198','35327','91944','38533','75990',
                          '27956','47224','35246','70686','63823',
                          '68474','39805','68891','18023','64126',
                          '53092','53929','42626','28711','63202',
                          '24585','81026','91768','16799','85854',
                          '82404','72285','11750','87796','51370',
                          '27060','56517','36728','89778','89037',
                          '43240','84689','12518','77763','54909',
                          '93513','70004','71564','38603','78074',
                          '59939','24219','19784','49698','82597',
                          '77874','63413','48072','54669','12619',
                          '19345','30152','44644','60636','56656',
                          '80378','41713','67372','59126','51450',
                          '58894','98491','28706','97385','51624',
                          '75793','13291','66058','50929','63891',
                          '11157','99827','41599','91693','12132',
                          '92435','66235','67327','22338','42918',
                          '52780','18632','26287','87085','18949',
                          '44986','66550','40892','74645','57128',
                          '29697','14793','42687','83679','51498',
                          '80271','42044','24956','57535','67057',
                          '50552','87405','76377','43333','64853',
                          '86368','95426','88370','18458','39870',
                          '23324','99155','46854','79480','74681',
                          '42816','66824','41377','46329','83314',
                          '91346','18598','41805','66434','61686',
                          '45720','40315','77268','44638','27952',
                          '91856','37933','68849','54347','21836',
                          '56978','47766','25815','33269','44926',
                          '56157','95739','56107','35939','14618',
                          '54577','41305','88151','17928','93375',
                          '80736','68593','76571','81329','24266',
                          '65060','71192','27312','60016','30553',
                          '51079','84437','86366','30799','97850',
                          '11033','92244','37602','48669','11375',
                          '75819','94899','10416','13551','63245',
                          '89919','21732','45583','22546','46927',
                          '67585','80006','74499','20560','31761',
                          '14920','23190','21119','30423','55976',
                          '78834','93123','29912','56566','70880',
                          '67712','79904','89317','94284','85071',
                          '86279','15922','27827','57580','64692',
                          '96024','86342','37825','45853','63819',
                          '55952','60149','30199','54165','79530',
                          '44238','80136','19612','19010','12790',
                          '67102','18155','79588','28791','67668',
                          '52995','71978','34961','19069','88945',
                          '55247','97634','69924','47886','26737',
                          '94772','20951','50595','97503','71057',
                          '53152','25474','89764','50110','55142',
                          '29202','35663','73563','22280','88685',
                          '10681','63806','34157','63662','22070',
                          '62313','13154','79332','72394','28755',
                          '87129','64389','94738','93757','82861',
                          '36605','13837','49023','39357','54081',
                          '93690','76486','70123','37656','40105',
                          '28663','73584','52225','79804','82239',
                          '86370','30908','50371','54965','81120',
                          '14180','30636','47093','17485','44240',
                          '85945','49316','93346','76105','44175',
                          '56817','35789','97910','19250','23530',
                          '62008','34413','71518','97568','47833',
                          '16372','96195','85851','31539','89800',
                          '48446','31760','93750','66570','92414',
                          '17908','31996','58333','39314','69491',
                          '32178','90678','81463','93409','65555',
                          '95399','63345','35866','58245','36181',
                          '25665','18820','89412','10990','76640',
                          '41042','91160','43145','47531','63171',
                          '35251','41418','49288','25968','68469',
                          '35952','30931','19087','88357','12322',
                          '94838','67020','97321','26782','35092',
                          '66076','78826','40869','96669','95778',
                          '55121','15156','49986','43039')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


