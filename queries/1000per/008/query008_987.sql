
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '90421','42691','19840','33360','80914','67091',
                          '43429','82366','81532','43270','36074',
                          '29399','62168','79692','11370','62137',
                          '20211','28229','33520','49397','84519',
                          '19822','20423','48320','35840','77277',
                          '40018','91815','15031','55096','35864',
                          '30953','39708','17810','20078','24565',
                          '32680','63742','26361','31209','41710',
                          '71803','16220','57382','17146','77501',
                          '82259','31854','69042','79708','89233',
                          '64071','83648','75905','80665','64865',
                          '30782','20244','67647','94390','34369',
                          '73392','26354','90545','97159','65524',
                          '16731','50021','48767','23607','64134',
                          '18392','35634','81152','50250','29811',
                          '77708','33697','69226','70390','84445',
                          '40561','36584','18642','66440','67785',
                          '47025','66499','88672','80335','37014',
                          '20136','89312','72985','56381','16506',
                          '53607','19717','57218','51214','21059',
                          '51993','53482','14374','12051','39737',
                          '29310','12957','19484','38250','26534',
                          '17520','27101','39809','99307','18638',
                          '14524','12687','75570','83591','75048',
                          '37231','17784','81838','54703','89135',
                          '74466','52426','45947','59847','42266',
                          '30199','85360','22090','86352','76231',
                          '83602','70169','49754','53515','81736',
                          '85294','87252','41988','30571','73466',
                          '74771','21380','82599','55082','21136',
                          '72376','53551','54477','55743','93968',
                          '57530','74496','36580','29091','17063',
                          '43507','73050','10256','92698','83085',
                          '11607','78954','20616','71173','64402',
                          '39337','24148','32786','53931','71198',
                          '16694','63018','74320','29353','61088',
                          '69655','45233','95361','99149','48203',
                          '19748','62763','31370','91702','73953',
                          '34752','52084','18425','72361','17583',
                          '28801','74561','25745','28452','58948',
                          '74811','30489','44730','12626','53734',
                          '40997','95706','52738','32340','84531',
                          '18539','70252','95082','59674','82009',
                          '62952','68752','76963','29648','61961',
                          '25561','33210','40363','92454','38150',
                          '25540','66054','54788','14857','98548',
                          '99747','22826','61423','43039','80151',
                          '69317','57800','85509','19138','62463',
                          '62316','13015','31598','97474','99631',
                          '78574','63898','21384','29800','28071',
                          '31476','59750','41467','91016','30083',
                          '24689','50935','71117','68825','34499',
                          '94651','44459','31313','66100','36022',
                          '71377','21257','77633','76914','21204',
                          '95044','34149','24210','53436','31697',
                          '37295','34314','69153','67777','68646',
                          '36473','28377','14738','94589','86040',
                          '43432','32898','16178','95396','32610',
                          '85115','44279','16065','23536','73235',
                          '51197','34616','72318','23790','56327',
                          '45491','19512','92107','17027','17184',
                          '97832','48686','62300','52849','77723',
                          '42582','49910','96192','20989','79811',
                          '64962','56704','82995','93585','42032',
                          '57247','60994','79039','21959','45625',
                          '99057','14875','39406','83064','77406',
                          '77161','46524','89323','50694','82809',
                          '42950','63833','84392','73211','71783',
                          '72057','73745','94838','26524','12361',
                          '69569','45100','15662','64178','57344',
                          '52025','22759','87144','20567','83452',
                          '37717','81121','40592','32483','52289',
                          '65134','80394','62304','56193','47199',
                          '61366','88799','94368','84952','94756',
                          '50817','37195','15130','55809','39958',
                          '32655','90385','53464','24278','92199',
                          '76243','94744','30189','10959','39343',
                          '69543','29821','74111','94874','96937',
                          '35866','68958','95334','99651','32137',
                          '37779','34367','35746','43389')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


