
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '82234','56731','60022','74310','88446','16754',
                          '84538','22585','14141','95552','83566',
                          '77687','31541','46829','61745','68834',
                          '91287','44021','21483','62081','73621',
                          '55746','72231','17041','73850','63605',
                          '75911','72082','45832','73302','60169',
                          '34543','22245','31031','28857','51082',
                          '51706','19839','87501','95560','58638',
                          '62016','74153','76332','38260','58276',
                          '74089','33256','30928','71112','32260',
                          '93959','85800','15297','67981','35255',
                          '82233','74255','66127','60442','93916',
                          '84643','28136','81864','52188','38531',
                          '25895','54926','13034','58245','72524',
                          '19608','63322','42178','96658','89770',
                          '89423','34874','60431','33455','30402',
                          '27199','38996','51821','92447','88191',
                          '50844','86414','37804','42552','60021',
                          '72931','37227','44243','77765','26679',
                          '80025','45100','73063','50461','49528',
                          '52247','22580','52223','99553','11914',
                          '94073','49931','10764','92078','26736',
                          '24244','53569','58333','56585','20680',
                          '29937','86824','60610','35707','25797',
                          '15637','33503','26078','22262','46589',
                          '85864','14614','11095','80846','38321',
                          '17896','94506','26169','25566','19763',
                          '13039','45737','99976','58648','23593',
                          '23375','87349','83604','61225','76699',
                          '89312','48996','79275','94396','50632',
                          '36050','25367','44507','22137','69664',
                          '18141','33693','16906','21033','85881',
                          '90335','40615','95255','34110','43018',
                          '71291','36136','92682','34181','36343',
                          '70070','98716','25277','81359','90427',
                          '95231','87635','22057','61770','39253',
                          '37343','79651','14201','92027','22592',
                          '60654','17069','87415','65367','81055',
                          '77035','23807','92275','62205','59290',
                          '82372','71723','69144','73010','97122',
                          '37728','41480','73586','97804','21872',
                          '15971','38625','91799','21411','28422',
                          '10720','16950','22552','43289','23618',
                          '73787','29440','35903','36045','99561',
                          '13246','95027','37665','86185','20859',
                          '37720','41514','64721','22530','21635',
                          '46193','95448','56702','11404','76280',
                          '95743','96805','81642','38215','87372',
                          '82967','71398','74799','21394','38031',
                          '18703','75437','55240','91816','78978',
                          '47819','45677','36449','87425','22534',
                          '70096','43252','93183','94523','47082',
                          '50898','33904','12786','13290','99255',
                          '70385','22806','40694','70585','48761',
                          '33908','83755','84160','40463','90784',
                          '83818','78597','99180','58016','28444',
                          '87594','86574','81364','68041','49940',
                          '50710','21649','66266','15789','76741',
                          '85447','78054','32867','98171','41958',
                          '22125','59244','95458','32807','70535',
                          '25828','64663','82615','70393','29188',
                          '43898','95322','86930','39317','45908',
                          '32800','92695','83522','52702','38352',
                          '72130','69234','92613','56643','62957',
                          '29347','66855','21384','98434','82585',
                          '93818','35470','72193','84283','81978',
                          '78787','37834','10090','41590','21553',
                          '78594','55040','67962','62871','90458',
                          '23917','38291','75968','56555','21144',
                          '14612','77451','34386','52352','77505',
                          '34763','19026','47963','73386','22637',
                          '73672','19098','30106','33041','66242',
                          '59225','83857','10154','40254','97510',
                          '88766','88351','68464','74531','22621',
                          '20583','79727','18951','53605','90955',
                          '49111','70198','17260','33197','82697',
                          '38206','62902','18327','12258','25573',
                          '71473','96833','53429','95955','87014',
                          '29313','55719','98107','23478','73305',
                          '88471','66885','25432','38651')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


