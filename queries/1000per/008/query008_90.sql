
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '33606','58456','84381','21713','27568','45415',
                          '88294','55237','44840','30792','59729',
                          '85112','87534','17584','19690','77881',
                          '65728','81856','95452','45112','96579',
                          '23190','60223','99399','11813','30623',
                          '59432','43772','41639','78060','77342',
                          '41011','18284','48084','46330','57434',
                          '47660','66644','74927','41434','98298',
                          '45598','64677','53691','35038','34121',
                          '26031','10323','87786','97347','95935',
                          '62748','72743','32858','20610','20308',
                          '33532','86423','90539','88544','24810',
                          '36220','56361','61251','55035','69327',
                          '33089','76258','79167','34245','39266',
                          '93780','17146','54589','13365','63972',
                          '48456','53272','33977','21261','91864',
                          '40190','55347','48764','38423','58225',
                          '90940','63037','20452','47454','63778',
                          '82572','49242','41913','97309','48455',
                          '69306','26421','82095','57504','97026',
                          '64877','47023','76520','89841','22886',
                          '87412','28973','36324','52658','64301',
                          '27694','96306','59243','96665','35678',
                          '19841','58182','45851','98619','68939',
                          '62982','23273','13391','90702','18275',
                          '85573','84829','46483','84794','30970',
                          '61518','25710','13784','93329','93897',
                          '20361','22548','74343','69658','34915',
                          '58682','36701','67899','84067','21476',
                          '49112','37881','76143','94922','30549',
                          '93006','40620','92225','98598','83451',
                          '78626','32193','32456','30845','89555',
                          '46990','24332','82649','96778','46459',
                          '33815','84871','47340','10889','21490',
                          '28524','88258','71695','34818','70953',
                          '69259','69124','94055','10190','69735',
                          '20130','70542','39108','38820','48712',
                          '56270','67867','75332','92907','17373',
                          '76012','73674','89193','97059','78776',
                          '46935','29594','38702','48168','68856',
                          '36737','43500','97677','42629','89583',
                          '57761','27863','30655','21122','37512',
                          '29391','83164','82118','66126','92383',
                          '18389','12504','93758','87649','41666',
                          '66443','15838','62556','54666','14585',
                          '18395','22653','48745','46972','10945',
                          '60511','83120','57480','49210','90888',
                          '19743','80517','77594','19069','80483',
                          '91687','57134','88371','35805','20972',
                          '62328','76975','49989','54513','93101',
                          '28336','47258','46054','52266','34937',
                          '32475','61970','97579','98463','32595',
                          '90376','89093','28273','69796','87499',
                          '34670','69610','46619','95698','67389',
                          '48330','86702','89033','80227','82412',
                          '20937','79431','63297','90975','62640',
                          '19235','84749','46492','48562','21382',
                          '27505','68723','38168','72490','43325',
                          '34607','84171','44370','39645','38803',
                          '64771','40797','88062','72937','61139',
                          '99325','56750','44307','53499','55211',
                          '64124','25916','87003','34192','59809',
                          '77429','11124','10202','82166','48600',
                          '76367','57253','70627','42092','27175',
                          '57900','82906','39434','11474','89138',
                          '49101','64538','55073','77861','53353',
                          '58957','48334','30160','97665','93308',
                          '21934','28976','66170','94292','69977',
                          '95665','86601','85572','99674','79598',
                          '31446','60561','59497','59899','15426',
                          '19855','12281','58170','21887','60676',
                          '39633','22764','99427','44099','23703',
                          '63746','33273','49045','33922','64498',
                          '29983','29906','69849','28384','92976',
                          '58806','43000','62924','88547','63173',
                          '49448','81139','92954','80554','51762',
                          '80506','61661','51498','23954','71020',
                          '25013','55623','45445','28124','25707',
                          '79064','40835','43469','11701','84735',
                          '73560','31528','81735','99139')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


