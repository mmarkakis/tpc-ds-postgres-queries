
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '71157','23270','92215','52114','60001','40798',
                          '97715','23984','25458','68174','23403',
                          '97875','89079','44753','46711','73118',
                          '94004','96822','94902','21243','49601',
                          '50318','15315','94154','47857','65703',
                          '76345','24864','21812','51862','29190',
                          '84159','88437','21010','97188','15595',
                          '40159','30670','61804','50733','69463',
                          '71174','92771','39220','52640','76595',
                          '68569','58661','15813','70275','68300',
                          '17721','96763','81938','21685','50524',
                          '11033','49036','82989','88742','17231',
                          '69350','77853','54454','88155','19622',
                          '77932','40678','92935','82649','27398',
                          '99848','10827','81566','54570','41271',
                          '36412','74108','87294','93485','81928',
                          '16687','21314','36099','49922','49207',
                          '10653','74789','59113','68787','20052',
                          '34068','13039','53236','23429','80987',
                          '64663','36234','10238','47411','90878',
                          '30603','85492','29138','31266','61389',
                          '78905','99257','27207','94358','89817',
                          '71512','72224','63168','29250','67628',
                          '90968','84752','47724','60907','41455',
                          '11525','55065','78348','27604','51045',
                          '26985','21072','17483','82484','37300',
                          '14705','29335','20887','56580','60212',
                          '91833','88298','14915','13300','28944',
                          '70876','27029','67982','52228','32125',
                          '83675','71045','74141','96321','26104',
                          '40537','20161','99781','95338','91915',
                          '10334','80716','12441','23981','79679',
                          '62053','28941','37692','43387','87716',
                          '88221','70941','46885','11158','70301',
                          '69156','87781','53852','73311','48569',
                          '34553','37858','37036','22463','87764',
                          '62911','55000','97851','48225','74622',
                          '60645','78031','62751','93268','18583',
                          '36794','76696','62466','81636','11936',
                          '42833','25572','45316','22166','73251',
                          '63946','43405','27699','71324','61964',
                          '64475','28656','32138','36173','41966',
                          '91808','20223','15505','96644','45555',
                          '79787','83657','17181','56237','41643',
                          '39952','36047','20733','13334','49072',
                          '35309','87973','46682','57250','34340',
                          '66617','14182','83763','41052','20591',
                          '77626','48921','46645','99691','12724',
                          '84017','40671','45873','49283','38657',
                          '98491','14774','29715','36010','78571',
                          '89368','87103','16164','18630','33081',
                          '78057','11284','63066','25979','61823',
                          '76005','83347','56480','29401','85367',
                          '27624','38714','75441','61626','23050',
                          '53754','40053','52160','20108','20964',
                          '24407','40091','31037','77952','81044',
                          '81187','89889','91011','89353','56485',
                          '29454','54278','25754','53897','21851',
                          '37568','24605','75581','88485','33039',
                          '16278','62595','51564','60302','43857',
                          '62037','22231','96237','13990','85612',
                          '47705','39647','40169','85169','11806',
                          '55640','44917','25932','46058','59009',
                          '36462','30303','71388','91389','29946',
                          '47987','61329','78509','52513','17805',
                          '60004','74475','71061','79188','66513',
                          '26766','46873','21990','67679','53110',
                          '20219','66996','42017','24203','69005',
                          '58472','49151','73165','46838','11590',
                          '78006','49206','87435','75494','30135',
                          '30335','40011','55256','80240','38111',
                          '73376','52742','77902','18266','57111',
                          '95198','98923','78098','35636','44638',
                          '99965','16166','32737','15638','26843',
                          '75567','92561','80424','65708','52944',
                          '41375','87803','76349','72914','33915',
                          '31809','92696','25914','58713','44813',
                          '75599','75572','35438','89966','20000',
                          '75393','59023','82924','33849','50354',
                          '14525','20757','74834','56707')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


