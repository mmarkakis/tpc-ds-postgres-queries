
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '73832','97971','74415','96600','49883','56518',
                          '25125','60271','28336','13126','88437',
                          '88200','26025','15962','41899','92940',
                          '52076','52821','51401','25217','99176',
                          '40185','33511','46043','20581','53815',
                          '47452','22203','96194','82596','86007',
                          '90424','46477','72641','60210','35179',
                          '74173','63507','46889','98251','40793',
                          '11150','42523','73551','30385','52151',
                          '98899','67784','89961','58349','20836',
                          '38895','33915','38996','74230','59204',
                          '67328','29377','73962','47958','42111',
                          '76180','89126','54922','60493','95826',
                          '21447','71586','26611','97485','76352',
                          '84424','95314','22402','36103','73289',
                          '28162','33077','40672','92190','70725',
                          '74855','85919','63378','41694','69499',
                          '42909','71347','80817','16698','31891',
                          '51973','98336','79366','20872','98373',
                          '74951','59468','27305','44354','11687',
                          '18265','25103','93022','63814','43525',
                          '20996','47166','11396','82252','68982',
                          '97204','36704','84264','18670','30138',
                          '35120','32876','24147','18997','24825',
                          '63960','93568','19163','91141','40465',
                          '76209','61953','70873','60095','97488',
                          '80165','14759','45187','21263','94318',
                          '45232','75717','56421','46027','58147',
                          '41046','27091','67277','29367','34573',
                          '54930','42175','46725','68221','25014',
                          '32672','73662','15659','53115','71029',
                          '13996','31756','56617','45314','30603',
                          '81659','63559','42613','30327','91722',
                          '52749','26545','90863','78166','98727',
                          '69492','47579','27179','95777','75053',
                          '53969','60540','96633','31028','73516',
                          '12019','78881','34998','51228','31097',
                          '35496','64397','10370','12598','95892',
                          '14712','17901','26141','41879','95328',
                          '80259','84229','64892','76541','74858',
                          '17028','68536','99937','64269','92478',
                          '22304','53257','41836','20150','64239',
                          '83580','55063','56599','15227','53723',
                          '31633','46134','67762','69672','78855',
                          '48140','59790','65333','61307','15114',
                          '93465','31774','70856','38581','26676',
                          '28121','50104','97832','22196','13827',
                          '95718','63903','52629','13517','17440',
                          '98282','19100','71036','24084','71613',
                          '46396','26955','16640','14131','76951',
                          '15004','92838','82689','73459','59183',
                          '62363','66912','69527','61438','15080',
                          '74580','36140','81676','30433','33909',
                          '85358','81745','25681','27040','65473',
                          '86805','80610','43825','95951','82026',
                          '21381','74747','26668','92345','83062',
                          '81029','47723','40537','34729','71855',
                          '99598','46123','58457','44356','21207',
                          '22948','46584','30502','99589','54796',
                          '83540','22753','47512','70529','68753',
                          '82611','87481','81753','31058','11221',
                          '69358','68391','99068','25391','22043',
                          '47002','10885','17783','37953','10913',
                          '28093','92854','72720','56159','48694',
                          '67299','34858','40853','15535','78225',
                          '23886','14784','76538','67766','28222',
                          '83137','40847','59191','11844','17122',
                          '12624','60972','34050','89751','32678',
                          '69201','81871','48483','10709','30719',
                          '82536','85550','95280','70584','47974',
                          '97798','13626','23251','20763','49934',
                          '99384','70218','86215','40884','33134',
                          '69789','22138','81445','26126','75374',
                          '77411','63969','82775','41069','31837',
                          '68793','64519','39808','44284','93634',
                          '16340','87921','30271','69551','76491',
                          '21262','22473','39340','86413','24851',
                          '82748','59764','97457','34821','60357',
                          '21124','74849','16227','43440','35798',
                          '48030','40692','26411','64051')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


