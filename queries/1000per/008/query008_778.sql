
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '52478','55500','80065','12247','72033','24026',
                          '49148','56315','73605','34710','95569',
                          '43586','89225','36456','49919','67845',
                          '79434','43152','25634','27740','48402',
                          '84705','95262','37427','29461','19651',
                          '85611','61352','62727','47371','16766',
                          '22814','90848','30446','21275','60175',
                          '81724','46076','43091','16054','86533',
                          '31604','30054','43076','60907','70187',
                          '52563','20680','47087','15019','65992',
                          '84673','77683','86215','29385','80570',
                          '91496','83833','37748','95907','69330',
                          '69799','31825','89028','28201','95551',
                          '67945','53038','28408','31349','64410',
                          '34264','81932','33286','22512','12549',
                          '51814','63009','43014','34232','20970',
                          '34870','94739','83051','58418','62322',
                          '54943','73208','24236','49284','48288',
                          '26188','15313','19388','45782','56279',
                          '17089','72838','29706','67479','23843',
                          '69976','64517','34222','65445','49716',
                          '58666','20375','43331','59893','36963',
                          '91284','65985','73117','80355','31910',
                          '67411','92507','28297','34576','19423',
                          '44197','79599','82102','87737','87360',
                          '76552','60308','57832','92073','90474',
                          '43123','23863','27461','94160','38705',
                          '42369','31240','48119','45289','67644',
                          '29599','25506','92422','48176','20949',
                          '63037','66281','14141','98898','12491',
                          '34832','25199','50383','20520','48827',
                          '88967','87709','39314','92260','87043',
                          '76853','49889','94514','47039','48586',
                          '24493','92059','46943','11697','99787',
                          '85423','95174','14479','69033','76608',
                          '31599','46122','94110','67367','65463',
                          '77383','73380','93003','80470','50665',
                          '34236','74216','52473','30650','72717',
                          '33933','21830','76370','66543','97332',
                          '58205','71902','11689','27908','73199',
                          '31268','20892','87752','13093','27457',
                          '97757','99391','45909','35676','34660',
                          '26700','84548','90558','11964','77038',
                          '15264','30724','75917','24050','91903',
                          '66944','41871','36690','29560','23658',
                          '58054','15162','85805','93754','54463',
                          '10111','56438','11414','33978','81875',
                          '95242','67726','94088','27411','46444',
                          '63527','85569','14779','35837','77955',
                          '19756','74272','39254','38545','18750',
                          '42400','81013','11683','62329','57207',
                          '31759','46501','46450','40342','51088',
                          '79673','33777','72627','12658','81760',
                          '49177','25877','66718','55562','96317',
                          '72923','55325','92379','33240','56357',
                          '82914','89027','79594','81003','34671',
                          '15752','58541','28165','33636','66467',
                          '55764','17247','88190','96402','14953',
                          '37655','52233','71791','51918','82812',
                          '38001','21861','44489','28244','14729',
                          '60187','30899','66177','59966','28356',
                          '91523','39477','93435','29986','75182',
                          '11041','99774','51128','88605','42258',
                          '75362','65620','13950','59541','97930',
                          '44156','45641','79351','16844','58230',
                          '20534','20956','83788','46893','79237',
                          '19008','86867','90625','13713','86762',
                          '68826','37038','84056','68556','78072',
                          '86923','51357','77821','73247','30092',
                          '61347','28770','72309','71714','23153',
                          '52178','31707','20824','13520','69598',
                          '44615','59275','82948','91658','31564',
                          '96205','78435','22665','51594','54956',
                          '89490','31282','34969','44304','57848',
                          '25578','49599','35392','39485','39705',
                          '67058','65805','23493','68791','39312',
                          '41598','74541','32725','46970','59804',
                          '39603','70967','29872','60211','48227',
                          '10936','77131','25264','82807','45547',
                          '91784','76672','34442','86273')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


