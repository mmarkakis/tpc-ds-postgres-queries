
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '29020','83090','14908','48287','30415','74698',
                          '90587','79130','25451','99636','50198',
                          '45815','22015','22545','95012','11330',
                          '59615','52844','25732','99812','47710',
                          '78973','53870','20965','30094','18580',
                          '62759','46777','18321','82717','41301',
                          '69266','43327','82726','16412','98932',
                          '28981','66119','43609','64255','17404',
                          '12337','73387','93140','23770','65497',
                          '22697','97275','29079','14703','22679',
                          '17995','37911','12596','39476','55652',
                          '71210','19208','39195','29406','35463',
                          '18563','52036','42183','71570','41020',
                          '36252','21153','11530','71746','28507',
                          '41066','23056','16044','13219','77172',
                          '87215','22321','63989','85792','89355',
                          '89866','24973','45181','63178','53741',
                          '48433','81450','95586','46825','35985',
                          '49599','24349','62272','54322','29029',
                          '24666','63662','25285','87030','39888',
                          '50815','76942','53408','49322','97649',
                          '91440','54815','84141','48674','82928',
                          '35208','72651','25903','78105','71582',
                          '33780','87996','58576','81114','36584',
                          '81077','33331','78818','84957','25899',
                          '51416','85542','44237','32736','28818',
                          '93046','30521','29212','76996','25896',
                          '79659','34371','19972','88542','90319',
                          '43463','23670','32765','94929','68383',
                          '99018','94645','90326','35458','36339',
                          '83141','72156','31019','84366','82046',
                          '45769','16175','14037','39651','62232',
                          '15642','56354','24856','21050','96807',
                          '61894','72739','20107','70011','83967',
                          '38644','95502','47394','64257','45355',
                          '70421','37215','18418','27501','41117',
                          '23130','18278','70167','37742','11885',
                          '77084','58306','21369','59172','67110',
                          '14014','36519','97126','98102','67177',
                          '95582','18928','12276','35413','26751',
                          '72464','27500','15912','77048','43737',
                          '79594','35446','54112','70661','13042',
                          '89401','17128','96651','45503','11372',
                          '49923','67663','25505','25520','54533',
                          '55174','47837','84789','34427','11056',
                          '48521','13778','80119','38050','22770',
                          '24614','77561','65147','13808','54488',
                          '36784','82095','27358','83379','19845',
                          '60034','65272','78192','38931','15670',
                          '27377','41240','41946','99254','26151',
                          '78204','69551','65851','78185','87614',
                          '28259','29138','78283','53502','76231',
                          '89747','86932','57266','40885','96458',
                          '75177','98430','79007','21145','54962',
                          '73205','61071','16821','51447','31619',
                          '67296','91704','66541','52513','39866',
                          '14909','52800','46536','21061','77577',
                          '93090','49925','11368','62928','53971',
                          '40477','65656','13354','12376','72025',
                          '30214','24302','85582','76835','91575',
                          '82331','24796','81910','29889','89110',
                          '18746','25671','28828','76480','24697',
                          '51723','23951','11699','27428','78624',
                          '63223','13935','69759','14471','94386',
                          '45456','16133','89095','98621','48592',
                          '40297','94390','66954','14726','92743',
                          '22173','67766','51509','58907','35946',
                          '38568','92338','71099','91777','94492',
                          '25111','37769','22735','92411','49086',
                          '59500','89610','15053','80375','69023',
                          '62144','20126','23133','84714','29891',
                          '45602','21252','38655','18907','97429',
                          '25454','28780','52188','40030','24635',
                          '42779','47613','55522','29093','80168',
                          '12826','82403','19887','74404','27672',
                          '60838','88642','77456','33293','18768',
                          '25416','66663','94285','17192','61180',
                          '96774','19373','39883','33716','60088',
                          '55645','75654','26296','97002','98464',
                          '42929','47770','54023','40105')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


