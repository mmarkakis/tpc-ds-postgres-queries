
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '11588','57665','55829','48971','35391','46109',
                          '90006','83253','52841','18014','44813',
                          '95607','71792','19029','56059','88802',
                          '69972','16382','60794','32230','79450',
                          '16192','14637','20752','41034','17363',
                          '29164','94737','46852','20266','67223',
                          '17233','59950','23997','31300','68016',
                          '87310','49643','60216','87932','68952',
                          '13966','52050','29482','97677','16326',
                          '11943','27009','47179','19685','62851',
                          '18467','97000','78218','42540','12903',
                          '66317','40003','36108','97016','20359',
                          '82814','55844','17051','54505','18517',
                          '88202','23645','35408','45708','91687',
                          '43242','62674','92356','67370','42478',
                          '65732','90939','88759','43288','98804',
                          '25994','72400','81327','93129','68910',
                          '43466','88035','14644','97008','53931',
                          '90772','71366','80309','35341','18571',
                          '71032','70629','30832','35916','40865',
                          '70344','79928','33459','99496','11427',
                          '19564','99857','40673','73450','86770',
                          '43521','18840','81628','81916','65017',
                          '52978','21136','15959','44554','55720',
                          '85131','85162','95889','63427','30317',
                          '97433','86533','42299','43511','59553',
                          '76174','26802','78365','55039','43808',
                          '46961','52239','35578','85454','39705',
                          '84964','82497','84894','49701','43723',
                          '86358','53351','77025','54474','59834',
                          '55064','56268','78527','20307','39254',
                          '80481','88709','58655','47818','45723',
                          '71094','44510','53228','13233','34985',
                          '22781','82839','54154','45426','15898',
                          '64084','22956','30834','98554','95446',
                          '18289','36251','39425','10831','83436',
                          '80371','88517','33917','98011','46535',
                          '98631','33021','21164','30605','96921',
                          '64683','19376','28038','39345','63945',
                          '52920','40672','38213','86361','77934',
                          '65511','68877','22827','83999','62701',
                          '78888','86530','70355','72988','11336',
                          '17952','18280','10878','59531','93229',
                          '65429','30089','74877','12433','33300',
                          '44924','55671','58097','63319','35383',
                          '45989','20797','77778','46730','99202',
                          '47442','97188','49442','95762','27863',
                          '88674','79334','21740','88635','98751',
                          '87486','91303','94087','63149','58481',
                          '12642','94721','31309','77905','69822',
                          '94979','49341','54939','90045','66126',
                          '89561','78296','61140','27160','82504',
                          '53063','72531','66479','25964','96086',
                          '65283','87612','74461','13675','38013',
                          '44061','86899','80657','42190','98506',
                          '83877','50359','90275','28305','91929',
                          '27397','58320','14075','75586','89808',
                          '26242','83917','96974','63881','93336',
                          '31004','37295','70099','38818','90483',
                          '28470','33918','28267','91900','94752',
                          '37418','70016','16435','25873','58630',
                          '78565','41769','70769','79885','85672',
                          '99027','16700','57609','30771','26858',
                          '47587','88537','76608','50948','10475',
                          '83705','54695','97575','26514','83279',
                          '21746','99900','88728','77604','85532',
                          '73599','93403','22516','26402','42451',
                          '54611','45616','40949','11126','30311',
                          '50478','99553','16068','52032','48580',
                          '87446','70562','74543','41303','41333',
                          '50767','84523','60624','73918','34550',
                          '76368','43996','35648','44526','52036',
                          '56190','43122','59683','42725','55089',
                          '93758','36053','49633','14462','59720',
                          '55881','66478','38275','41189','23692',
                          '37069','29655','37309','62543','58543',
                          '29147','61969','91515','16471','44256',
                          '60665','65768','40646','80595','29973',
                          '58157','77288','94499','62260','43519',
                          '62448','99634','81678','73212')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


