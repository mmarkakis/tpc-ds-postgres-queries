
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '14405','32156','21032','37312','12363','22183',
                          '43190','86530','27145','47328','98595',
                          '41262','73668','46795','43275','37809',
                          '80177','28533','24539','31837','81610',
                          '13480','70491','92429','37460','99281',
                          '16910','52056','23521','61700','92961',
                          '96074','97687','26746','39009','62275',
                          '46372','54632','26857','37956','18437',
                          '33457','29929','76748','12207','87466',
                          '70108','65974','32384','96323','44338',
                          '17291','27144','65379','21360','84720',
                          '40851','68732','81272','71456','65791',
                          '82786','80254','55355','10677','78360',
                          '92177','33656','97846','44143','82883',
                          '23695','45655','58894','46785','74182',
                          '56906','86868','92591','32083','32484',
                          '74500','36810','25370','72870','90906',
                          '86239','36071','87966','18934','97640',
                          '44413','59720','53670','69118','31474',
                          '20778','87758','28296','92194','56253',
                          '90886','78529','22747','40105','61400',
                          '15702','63920','98808','61143','97562',
                          '96184','67076','94873','38108','38507',
                          '72229','77986','33539','19735','93507',
                          '44650','85412','90819','15270','61456',
                          '95202','60348','11210','28387','28927',
                          '73538','46651','62373','14237','86252',
                          '81102','49186','93473','79089','11296',
                          '28336','94034','21811','29185','83852',
                          '62015','20791','37972','66542','22663',
                          '87213','78824','78173','94205','94392',
                          '91052','75439','42008','10292','47268',
                          '14007','19115','71401','41332','94207',
                          '91883','73159','12825','93592','12096',
                          '98509','72155','48052','34408','69453',
                          '10284','32230','10513','70444','27365',
                          '23325','67031','27182','72049','28671',
                          '86865','66393','72239','15350','38910',
                          '21546','40660','97843','58794','12497',
                          '97429','22075','68591','12721','15803',
                          '75357','68016','62221','57220','97180',
                          '89742','99456','18346','47655','46815',
                          '64261','37950','44986','60432','38714',
                          '19684','17280','86494','25994','49447',
                          '63615','21516','52145','43980','75666',
                          '47935','38951','25494','41893','83938',
                          '87761','89547','65253','90159','69483',
                          '51365','42254','61129','20896','89145',
                          '52134','90151','27201','40353','18753',
                          '24674','65670','88174','64877','94290',
                          '94671','60266','51220','98115','45463',
                          '33689','57314','41862','35047','55613',
                          '97521','69511','88901','96609','19845',
                          '88934','83008','37096','80295','90349',
                          '81500','32587','31144','16246','85056',
                          '22435','18666','95738','68670','99113',
                          '68348','35183','34891','20115','82680',
                          '67025','36637','87474','99704','22245',
                          '14744','65415','42269','88027','31822',
                          '90087','93103','13223','77374','88829',
                          '26577','97343','98248','33821','54565',
                          '36735','12712','44805','45353','31252',
                          '28890','92379','71214','48437','59258',
                          '21033','36425','58977','65203','86404',
                          '11089','67022','13188','36064','72000',
                          '37893','97057','31104','30043','18864',
                          '55034','20442','87132','57066','75533',
                          '10079','32975','84743','14917','99967',
                          '51113','67759','36116','74435','35696',
                          '79757','22116','74458','13489','37436',
                          '39801','88525','39874','78857','78455',
                          '20353','67228','96590','31519','63853',
                          '65216','14481','96760','26430','45266',
                          '40438','27931','89202','88277','18596',
                          '30918','19561','16080','77580','89292',
                          '85205','43288','20937','63222','78337',
                          '52681','48363','31195','56040','55314',
                          '22162','25863','92761','34841','43170',
                          '61062','46642','59194','13364','13778',
                          '55930','76906','34196','79782')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


