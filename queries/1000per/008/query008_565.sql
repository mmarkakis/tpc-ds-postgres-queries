
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '26278','93465','42282','77969','69670','13316',
                          '92752','36769','51875','32340','84888',
                          '82593','86610','86414','85861','91143',
                          '76505','50700','59068','98725','61947',
                          '69580','77238','85222','73020','29522',
                          '39295','61783','87329','84885','43298',
                          '27807','10662','71030','87532','61917',
                          '98966','21182','59448','58586','71564',
                          '92660','10899','65141','57489','44433',
                          '51995','34293','52577','89624','40337',
                          '73567','24820','73456','81978','12863',
                          '63372','57462','16051','71751','98629',
                          '22356','55373','66167','28219','75014',
                          '28986','76542','67666','98565','34686',
                          '47757','41267','58962','27703','20394',
                          '52390','97611','96803','69402','89898',
                          '87160','71117','86347','56462','91060',
                          '17490','56755','82528','22876','78908',
                          '25342','66731','17567','36751','66213',
                          '20124','66942','23843','21490','54149',
                          '89448','56397','83507','99254','59774',
                          '73546','34716','71989','48228','13994',
                          '68350','31543','26415','82274','51077',
                          '17635','82919','24232','42043','68753',
                          '11932','21116','49529','47437','30019',
                          '73139','69291','64170','17595','31163',
                          '48877','91836','14792','31899','80036',
                          '66233','42748','35958','69898','91973',
                          '85989','32143','77584','60568','46743',
                          '28329','82037','45742','81949','52423',
                          '65973','68694','32401','69677','51087',
                          '49086','49442','83124','88353','92728',
                          '31131','53978','97246','87396','83040',
                          '44065','26395','64104','40640','61790',
                          '55120','99515','92506','46233','35448',
                          '64636','61907','64710','90008','94978',
                          '64040','91692','87834','96302','14590',
                          '14210','42289','23021','17193','33015',
                          '28924','37370','72425','30434','94655',
                          '48712','80369','84681','24162','12983',
                          '57934','50933','48943','57775','38739',
                          '36125','46395','23969','55407','51527',
                          '87708','78289','62688','10795','46507',
                          '93733','44313','93210','30853','58340',
                          '48842','86477','30535','22106','53742',
                          '74604','92930','39136','93773','73637',
                          '87488','56153','46675','63517','46981',
                          '55554','16003','99055','59946','97804',
                          '46695','18955','19867','14441','94757',
                          '94416','59424','27282','89294','89781',
                          '33841','98388','91859','89929','82192',
                          '57336','76118','99925','36168','32579',
                          '29727','13429','38695','27149','59325',
                          '41810','47740','87620','15844','34550',
                          '37211','72430','48510','34696','62841',
                          '11508','17979','43485','38692','68336',
                          '95302','49474','99327','10311','66765',
                          '68474','23194','50431','90854','41880',
                          '35865','68619','85349','50972','34773',
                          '13159','39323','29653','72731','94376',
                          '88192','99815','91567','13290','33208',
                          '30766','40303','64144','51380','88352',
                          '78748','20308','11164','14722','57163',
                          '33873','36206','59024','15865','14103',
                          '82991','48332','69456','19847','80735',
                          '17388','61366','90618','75786','14710',
                          '67484','82982','32607','11025','38355',
                          '38783','60366','23931','47575','11841',
                          '41836','77669','98085','57941','95993',
                          '32488','98574','97292','80007','87093',
                          '22497','33226','10230','54309','82668',
                          '99367','40969','47120','15135','69701',
                          '22025','51290','69212','68170','56418',
                          '57285','60750','22079','74791','79719',
                          '61926','28690','32446','63838','48278',
                          '57254','74600','46620','68707','72483',
                          '54169','11903','12737','81433','73777',
                          '79191','16956','66055','99107','61574',
                          '23881','64126','79318','46575','32782',
                          '29878','59019','88468','21536')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


