
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '56657','71261','77577','96098','92789','47139',
                          '78850','46840','11484','38346','59225',
                          '96426','79309','38159','24962','94837',
                          '85892','94346','80634','63979','40399',
                          '62346','99506','62589','56704','40703',
                          '14119','76636','23609','76029','22201',
                          '42719','84116','80373','57070','36397',
                          '14917','26575','17037','14190','97440',
                          '68522','17221','84222','28661','19636',
                          '58360','25074','50721','65605','31866',
                          '49905','61685','99699','72494','20585',
                          '52346','42772','15250','25589','77832',
                          '83855','53379','37197','28668','48978',
                          '30924','14338','72693','65398','42451',
                          '14806','26319','64811','20114','71919',
                          '79289','98186','51773','77651','85096',
                          '44744','28879','63159','31831','52738',
                          '83527','55759','78033','39254','74644',
                          '29421','68497','19973','58551','63320',
                          '58019','61903','89258','78336','12528',
                          '47804','48822','54687','97107','61203',
                          '20578','76882','57130','59124','90540',
                          '16746','47846','38328','64396','32818',
                          '34029','76565','35044','98627','91324',
                          '29190','84369','86242','35194','36222',
                          '92028','37856','33018','69922','34120',
                          '64507','70425','18118','98134','54751',
                          '42632','78059','11082','35307','37394',
                          '56171','65991','41131','16738','91505',
                          '80747','86832','96996','96590','80886',
                          '11808','83812','72381','89022','68546',
                          '35931','46955','48099','39917','23507',
                          '25472','34722','48830','76706','55810',
                          '38820','32519','36613','88328','61965',
                          '23766','56521','18672','59138','15330',
                          '43849','80846','28428','24447','96358',
                          '81300','98247','20366','92491','72862',
                          '54632','14145','52863','87318','60958',
                          '60485','94045','96060','26592','51570',
                          '20148','19574','85809','84319','35731',
                          '52171','16694','15141','56702','21841',
                          '11814','51469','48302','44051','10842',
                          '79499','19419','61052','30902','54950',
                          '45361','47835','41331','26382','69669',
                          '22690','13057','73463','23296','96173',
                          '42599','64915','39142','78845','69110',
                          '60308','62247','29235','11536','43852',
                          '21779','76531','76051','93472','54964',
                          '70180','72434','66191','48895','28480',
                          '18573','17104','16449','67050','43391',
                          '97558','45137','35191','23369','15805',
                          '64951','38670','74626','84487','92687',
                          '98843','43871','58572','88620','67744',
                          '41348','93903','51596','63711','93461',
                          '73978','45908','94938','87171','30053',
                          '67512','95431','40455','41590','70265',
                          '65150','14010','55667','14904','73360',
                          '62585','53801','11158','45138','44333',
                          '34080','42539','83494','64898','50837',
                          '55277','85206','39146','15729','88784',
                          '74138','53506','41482','76881','20819',
                          '85498','90337','45595','51984','45815',
                          '29814','66973','51924','30369','38060',
                          '54525','83410','15090','31451','61036',
                          '19340','74983','67343','43427','63536',
                          '44859','55903','92481','50026','22898',
                          '80460','24125','87547','48801','58749',
                          '26948','52556','12750','52360','49036',
                          '61124','48594','66447','91876','62205',
                          '34817','24322','94840','33553','30289',
                          '80026','68708','90707','93189','42639',
                          '97264','25010','51915','19250','33655',
                          '54994','27387','34397','72835','26851',
                          '27370','13751','16840','46805','50216',
                          '40815','33997','99831','37870','37692',
                          '53805','60410','42027','47911','92147',
                          '67284','82578','33180','79994','59378',
                          '78008','34626','70383','86976','68543',
                          '92803','47842','27640','55175','62244',
                          '52790','69307','96533','70223')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


