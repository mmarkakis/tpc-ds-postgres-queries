
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '35225','25718','54469','30807','70569','76721',
                          '88151','61501','63976','51863','74891',
                          '76646','28171','40836','64551','25576',
                          '95158','91046','14568','10302','89653',
                          '59891','18339','86192','71519','64353',
                          '62065','99508','40790','34210','50247',
                          '52894','55365','62533','32288','41836',
                          '24941','73828','99516','63532','35677',
                          '99296','15344','12437','30205','24640',
                          '41098','19805','48169','71543','58267',
                          '26478','39018','25744','50304','15154',
                          '60384','31654','74384','77623','60163',
                          '42626','64399','39089','35171','89803',
                          '64897','34459','73039','51447','41701',
                          '74681','73331','89700','63246','59019',
                          '77523','18044','78413','61927','53130',
                          '52523','51954','71944','62449','91709',
                          '20802','64251','20079','25120','53142',
                          '91878','16674','58607','95485','92440',
                          '48345','18458','14561','33931','33812',
                          '60011','70872','81191','98085','96963',
                          '81642','56448','91103','70245','40059',
                          '42889','77231','23415','46391','29217',
                          '11516','50817','96670','16766','24107',
                          '18787','70830','50824','97369','86546',
                          '95594','34682','17359','92641','49937',
                          '23115','59803','71676','17505','89050',
                          '40350','41666','15039','62855','61030',
                          '72480','99176','90938','20324','83636',
                          '24634','24506','99083','33457','19691',
                          '53206','35004','42637','31036','39707',
                          '90282','35264','88221','76093','60554',
                          '55673','92785','33174','62660','98677',
                          '83315','63068','57332','71297','12237',
                          '12898','50524','94431','91824','77538',
                          '74584','27150','14723','34783','22533',
                          '30263','31439','46655','36365','54704',
                          '45721','37806','73471','73763','94312',
                          '31392','54253','70987','18518','62753',
                          '31012','18858','26370','17671','81914',
                          '83441','63942','75748','54211','95461',
                          '89790','32027','47157','56914','82252',
                          '95828','52827','34990','46857','57389',
                          '35556','30563','68104','86813','30787',
                          '15047','44426','71153','72642','52969',
                          '51052','87261','18264','14436','29512',
                          '30978','38248','34234','53806','53874',
                          '59516','39187','15791','21935','83517',
                          '72269','86381','19727','37016','60649',
                          '59053','54100','40476','95074','11402',
                          '55202','12113','77079','89890','30620',
                          '34991','74143','71219','37527','15578',
                          '71931','92851','14745','68752','10251',
                          '23256','56790','13746','35979','75809',
                          '29412','42100','81855','85194','13074',
                          '81578','32196','36417','76922','81171',
                          '69127','53467','36688','55244','42449',
                          '93978','71239','77301','74688','98136',
                          '88839','13091','28327','20402','98468',
                          '87884','71716','93804','57223','37365',
                          '12340','12202','41781','48647','61877',
                          '12978','27029','82169','28368','56508',
                          '88831','85509','24264','75806','72878',
                          '16565','23260','61864','69586','55922',
                          '80797','71104','84203','59446','74441',
                          '97775','18938','37935','74769','20394',
                          '52329','27344','19014','96279','13007',
                          '56065','79303','23862','14020','82302',
                          '71010','99612','65177','30500','13547',
                          '88442','86341','43913','14509','15889',
                          '30744','84094','60076','49590','64061',
                          '17823','92696','76197','39768','93174',
                          '10009','78398','43088','67566','15148',
                          '58297','24165','65242','93259','50284',
                          '62646','61430','72956','58467','74592',
                          '61075','76845','25815','17680','92333',
                          '21644','51800','65115','59784','19896',
                          '83260','30597','25543','31691','13377',
                          '38692','84205','43199','20440','71685',
                          '74020','88238','91232','23655')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


