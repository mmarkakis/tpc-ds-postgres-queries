
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '56725','27900','77523','92590','22902','54930',
                          '97651','19583','23547','50342','19726',
                          '45618','60355','82836','61404','33786',
                          '66169','65962','32076','55248','50838',
                          '14924','66470','30644','19550','21135',
                          '59510','98071','24054','43888','41115',
                          '65824','68308','30658','47891','84000',
                          '81529','58697','25583','98731','54540',
                          '78007','82723','39318','35811','46780',
                          '63855','31621','79520','45404','92537',
                          '30092','65998','28136','55737','55282',
                          '82256','75811','30134','63579','97529',
                          '87329','14002','12443','55009','62090',
                          '60173','37373','93994','88144','53606',
                          '45575','19141','29384','20762','61339',
                          '75146','53660','82586','55548','28350',
                          '37004','71035','59474','24000','92646',
                          '87819','78838','18104','23615','16742',
                          '23876','66222','34475','21650','68097',
                          '12129','34942','32006','58269','15478',
                          '43288','73979','97390','61184','19958',
                          '54433','44447','93414','51047','13497',
                          '52823','40438','67563','11246','29701',
                          '18418','39588','40052','54877','67132',
                          '43009','43578','33071','17006','12749',
                          '27137','44487','88808','20173','42192',
                          '34487','48837','37150','66631','13762',
                          '97810','29682','53458','18805','17321',
                          '65598','53301','73971','39936','84663',
                          '40721','53650','77799','93931','75836',
                          '37449','18976','44446','93974','25568',
                          '69064','71810','93676','39407','56107',
                          '52013','83413','94137','66497','20684',
                          '95648','42857','81231','84141','88723',
                          '48828','86723','83152','26136','54127',
                          '23269','19133','89655','53726','76679',
                          '27442','68764','56985','26944','43551',
                          '85509','76544','19507','71871','58650',
                          '44572','77619','92137','86286','85748',
                          '88008','47705','67193','89472','49676',
                          '80366','83239','35182','28127','48954',
                          '90322','95798','40723','14173','24199',
                          '87217','93714','87294','70236','82186',
                          '80725','13877','12342','93706','49622',
                          '40270','68228','25065','73772','43263',
                          '22828','17615','73975','90127','32924',
                          '28314','67294','89957','70502','98571',
                          '77788','37302','26221','89409','76208',
                          '44271','80172','99366','71931','78306',
                          '79007','38626','96524','53971','53153',
                          '60255','40900','37278','48232','33225',
                          '27296','46288','57151','36645','59039',
                          '13125','77139','62973','21667','97105',
                          '55122','71722','73762','78866','68779',
                          '58755','26028','39953','12185','95393',
                          '80513','38863','70321','69125','18139',
                          '22672','33579','42308','83107','13767',
                          '74810','35113','94121','77631','97452',
                          '92269','22095','99048','12038','64257',
                          '41305','51661','87618','87416','69942',
                          '78363','95492','89309','72657','12716',
                          '73455','32129','86747','71033','65583',
                          '13865','10585','91104','20343','73677',
                          '15013','45663','86080','33501','95748',
                          '47404','28355','65310','71146','26282',
                          '91779','30661','22334','75990','32053',
                          '10146','19466','36710','62208','59550',
                          '23749','14265','84031','83809','46093',
                          '20230','66424','58363','84102','20829',
                          '34529','38426','28140','80146','34447',
                          '81022','73190','37756','17231','18625',
                          '99011','76331','19174','10360','15485',
                          '35906','63205','24591','67685','77247',
                          '33934','19229','46096','64634','14663',
                          '28298','47189','40416','68184','59600',
                          '60558','72112','21682','95563','50782',
                          '60889','76502','72229','24356','11628',
                          '60281','76699','83548','52469','82513',
                          '56841','78933','98901','70535','62876',
                          '78063','26684','55820','22681')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


