
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '36132','66046','87319','43574','67161','10201',
                          '74987','16089','62073','61130','17692',
                          '42511','31115','21354','73858','23792',
                          '88502','61786','30392','99906','90743',
                          '67316','71041','81776','14986','79929',
                          '15310','60312','13020','83854','91257',
                          '15276','29137','67628','18674','43114',
                          '61801','72784','71958','19717','79179',
                          '60874','25859','75261','33824','22974',
                          '38320','25473','60100','73135','48137',
                          '39755','87639','77859','40396','72619',
                          '88238','49439','89453','98610','24380',
                          '88733','37470','55539','27429','32017',
                          '68525','55827','18216','49146','38124',
                          '63977','61399','83788','73474','13572',
                          '31493','54197','98906','35905','74928',
                          '85456','23175','90573','36238','11135',
                          '56163','78786','78855','94622','53874',
                          '32469','78543','36734','60972','14778',
                          '84329','36528','99362','83621','95748',
                          '66561','84266','96303','78722','21266',
                          '11959','99184','24673','10425','22930',
                          '15433','31162','77755','42026','97300',
                          '33348','73492','95581','82653','98420',
                          '53461','31207','78233','97131','90564',
                          '66664','15688','68793','33058','98762',
                          '65349','89820','89565','17058','30679',
                          '63280','35765','65533','90676','44527',
                          '90435','77694','57809','92990','65044',
                          '97107','23850','69238','34600','47392',
                          '93219','57963','96270','61777','82219',
                          '34649','35411','47127','88879','68613',
                          '83952','86975','78782','96210','51392',
                          '56369','60416','63680','59456','70122',
                          '13904','52916','23428','14486','28581',
                          '29695','12379','46466','64268','11909',
                          '79170','75124','43664','64608','28384',
                          '67473','10931','82083','95383','32259',
                          '27011','29360','72221','68433','13831',
                          '16371','57827','69290','88198','61386',
                          '84299','26073','68505','88614','14089',
                          '58403','44537','53227','46061','46990',
                          '91043','39261','49965','38021','87493',
                          '36288','11005','92003','61639','41193',
                          '48074','11705','96988','11185','69167',
                          '62570','77653','96545','15376','48689',
                          '50241','38643','79061','97083','48253',
                          '21543','47468','32106','40528','61007',
                          '55933','72421','43725','53183','25047',
                          '12119','62873','85151','31373','55970',
                          '99366','44759','32501','29399','51583',
                          '74279','54496','78809','86816','59507',
                          '95660','83309','23878','25235','12257',
                          '54812','28391','18101','29615','72490',
                          '83902','30085','26751','95395','48458',
                          '21254','78874','69484','53019','82318',
                          '78975','41933','73133','79044','35381',
                          '78065','10781','28273','89903','52304',
                          '49583','80267','87985','74345','31745',
                          '56109','18305','85965','47038','16885',
                          '27112','30667','62858','66508','39631',
                          '44811','58664','58178','95885','93485',
                          '92561','51455','28054','19873','73324',
                          '23321','56391','23604','14347','38532',
                          '86802','43491','30768','16382','25755',
                          '70086','88824','81885','12233','15928',
                          '54806','64089','75264','99171','28169',
                          '29514','11494','14342','77283','28062',
                          '68363','53454','62863','25189','29882',
                          '13744','70574','28454','59123','12281',
                          '95397','58484','25153','70434','91117',
                          '57760','24543','47079','41439','52279',
                          '12358','69123','74653','47421','73109',
                          '61882','66628','21502','49045','23423',
                          '42921','67333','10532','75627','18892',
                          '78699','36076','65741','25752','71114',
                          '92052','79362','55393','82585','28706',
                          '48013','53578','41316','95070','58090',
                          '67677','39694','98066','73155','27719',
                          '99705','56960','95175','77389')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


