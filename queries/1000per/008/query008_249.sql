
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '91842','37307','89597','84678','41529','94569',
                          '88065','73526','21977','54985','29949',
                          '98227','31086','70854','54715','60617',
                          '86311','23534','69571','42513','16644',
                          '41070','11474','36174','85063','58101',
                          '80939','75164','81284','67737','91612',
                          '90736','55559','58226','40428','32516',
                          '36359','13550','10274','53302','61758',
                          '79623','49494','17810','91906','20998',
                          '12139','31331','25246','36996','53931',
                          '40606','24570','57326','28059','13784',
                          '94232','84148','89284','70000','96742',
                          '77973','41450','84640','95300','62660',
                          '54747','12413','89223','63487','90471',
                          '97452','81332','76422','15831','29381',
                          '93318','78557','91356','21561','26845',
                          '64596','28077','59018','78324','25105',
                          '85960','72967','56645','85432','19661',
                          '73367','95565','26018','51435','85767',
                          '38836','30841','46181','39917','42188',
                          '77548','41172','68735','12969','16806',
                          '33056','85698','15673','27834','32572',
                          '55487','17183','73305','68871','84092',
                          '14294','66036','56329','36943','88529',
                          '99066','66301','58153','31378','93818',
                          '75676','24998','16132','25361','81078',
                          '53457','68589','75342','49546','92101',
                          '14051','48860','76730','63338','77107',
                          '44459','14083','93284','76270','33514',
                          '60106','52862','33901','21509','91026',
                          '58134','29193','58503','90737','14946',
                          '65147','36486','84265','78221','93450',
                          '32610','39950','29677','63794','67169',
                          '34405','54508','43075','97809','43109',
                          '92469','47740','79297','72150','24739',
                          '74473','73326','85087','49512','48282',
                          '44051','79163','11528','49726','26434',
                          '65840','43593','70748','54816','63993',
                          '86317','72931','46808','66098','37383',
                          '72850','49056','50635','80564','48746',
                          '72399','56380','69375','34877','48863',
                          '35178','50204','35844','33034','78331',
                          '85364','51458','32800','63349','39482',
                          '62260','75086','92137','31438','38153',
                          '82582','59628','14119','34718','15878',
                          '41457','84458','82963','48459','28075',
                          '66157','96433','50474','79070','77025',
                          '99813','74475','99984','73667','27387',
                          '14356','76855','75229','61733','45838',
                          '32565','22095','56426','61388','56056',
                          '65744','61623','73726','49677','27358',
                          '12356','53852','45330','83151','92547',
                          '85877','45853','12581','39377','96618',
                          '32321','59627','88345','48415','66907',
                          '98334','71037','87975','61297','85119',
                          '79129','36032','60335','91205','71896',
                          '78603','40164','94147','13156','98248',
                          '79565','53973','84714','16635','68715',
                          '59880','94904','98318','79279','19272',
                          '69000','42972','73855','80243','45294',
                          '29654','46119','98683','22228','37423',
                          '79786','85734','99989','41305','92636',
                          '40781','66668','27129','92129','41327',
                          '67906','83227','79381','60683','51581',
                          '41413','13831','30932','51975','67216',
                          '58249','93854','66949','81429','79891',
                          '80142','48732','68835','29183','19396',
                          '78607','47436','50351','31859','31265',
                          '37503','15867','20274','88423','99289',
                          '27071','76924','25851','56143','10737',
                          '13796','44340','97701','31421','45145',
                          '31442','81564','67472','92374','97124',
                          '12935','89292','40160','24062','18037',
                          '59359','87228','39531','46316','76568',
                          '46385','72712','10396','57548','74140',
                          '54844','36021','83378','31586','43986',
                          '36524','67563','49183','50186','90851',
                          '27469','73157','11302','11521','53643',
                          '86320','44186','64126','93046','31914',
                          '63152','85444','94000','47505')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


