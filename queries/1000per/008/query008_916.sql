
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '11044','27352','28738','70224','82439','20531',
                          '40777','66070','26625','53482','99309',
                          '67406','41865','68863','20354','60964',
                          '35129','71887','41292','99967','53652',
                          '96448','12859','81678','75390','66593',
                          '68731','34403','67149','83250','83235',
                          '18897','21700','39745','76066','72161',
                          '40316','47459','50103','55273','10877',
                          '15680','23035','40613','87369','98787',
                          '12069','19225','34140','41657','66216',
                          '34064','10145','63320','93759','73559',
                          '36790','87299','65396','12263','10032',
                          '64571','52829','46985','72163','75688',
                          '36434','55800','19599','29715','88321',
                          '21769','98927','23475','66097','43041',
                          '38763','85535','87787','98130','57011',
                          '94586','51468','79153','39247','24400',
                          '13486','14287','49961','97497','55492',
                          '68272','29347','63535','19959','65090',
                          '97186','27699','43085','89209','41560',
                          '56836','28866','19112','21376','90203',
                          '79926','91490','46686','54227','56852',
                          '29032','39049','79568','83969','26731',
                          '40304','80380','51625','35426','41266',
                          '12909','73655','18884','75060','11403',
                          '79191','33254','75769','79172','61538',
                          '30711','49940','89943','69201','36169',
                          '26352','36829','63304','33840','66115',
                          '53355','96296','16699','34307','96450',
                          '26990','28337','73324','39748','29484',
                          '76060','97063','75036','39707','88071',
                          '81368','73885','80969','36779','63155',
                          '71746','26679','91552','97453','74032',
                          '17550','74491','82092','59093','18696',
                          '95072','86854','27474','91804','82385',
                          '56040','31956','40561','15224','98917',
                          '58474','39278','46514','33820','34582',
                          '87193','99288','83600','95103','25715',
                          '18136','54547','85038','69908','68718',
                          '28484','73153','33436','98896','87412',
                          '22402','48277','95425','32086','83178',
                          '57847','67237','27263','70048','67087',
                          '45432','94315','62621','39452','98204',
                          '46390','21312','79395','76998','61649',
                          '51273','95890','40704','95930','36995',
                          '48662','47108','29401','68595','37745',
                          '26424','49010','54247','89970','16745',
                          '68036','71260','32475','48883','83291',
                          '70808','10885','71823','12537','53675',
                          '79531','15154','15743','83168','10634',
                          '38317','72462','87409','37419','98282',
                          '80915','21169','76355','95075','51109',
                          '27687','36381','19254','74219','29520',
                          '39651','35968','55146','96878','90051',
                          '14192','27946','76963','92376','73467',
                          '37182','65530','95243','85219','15992',
                          '45931','51551','87980','54718','30129',
                          '57282','47812','60796','18436','68696',
                          '28931','24221','47966','79420','77632',
                          '50120','57108','61664','88063','65874',
                          '11076','51510','74329','31395','35834',
                          '24842','95374','95311','95603','49107',
                          '32128','44344','30300','42243','45867',
                          '26817','82596','33485','48023','36453',
                          '10971','27423','50854','61796','67387',
                          '89152','79697','86018','86571','41331',
                          '96084','54049','38003','64606','62823',
                          '40015','55366','83460','12923','42842',
                          '94955','90230','95051','39055','26543',
                          '77747','80584','63034','58202','40366',
                          '76001','77226','33113','48188','51206',
                          '99088','23600','41661','61084','36965',
                          '95034','78699','42306','10917','74288',
                          '15717','62541','76565','17788','91448',
                          '63202','23547','26451','84034','48076',
                          '99663','10404','88507','11785','36048',
                          '57278','34466','23331','75577','32191',
                          '26241','68102','26889','24701','92998',
                          '50778','75784','91034','42767','12881',
                          '12944','10998','58569','41594')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


