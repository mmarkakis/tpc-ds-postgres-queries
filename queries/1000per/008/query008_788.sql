
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '19557','64143','53669','63468','55316','79919',
                          '72213','13650','55067','88143','88546',
                          '76538','96634','37256','68329','23325',
                          '81927','50418','90211','96790','65942',
                          '29040','11524','35198','57125','76051',
                          '52124','84069','20909','11337','24395',
                          '19957','65810','13476','48049','31969',
                          '41556','53988','82494','96316','53575',
                          '31174','43384','42194','28866','78491',
                          '39689','11624','64088','86343','81373',
                          '21732','58897','28739','86940','51492',
                          '61969','71018','75063','67347','63972',
                          '17795','65897','32095','58164','64611',
                          '16441','80742','94231','82836','65982',
                          '15403','26360','89580','44636','21853',
                          '88752','69814','92041','90358','49705',
                          '33816','64834','84987','95267','16165',
                          '82612','68833','33216','14943','86647',
                          '15257','16056','22617','87525','47895',
                          '12526','55716','68655','87045','46738',
                          '56361','44197','75735','88445','81251',
                          '43338','14694','41900','18941','74827',
                          '55404','30442','82456','41891','81011',
                          '22556','18361','57297','54470','76132',
                          '83448','18526','81292','72273','96307',
                          '51983','79602','73373','30324','88892',
                          '23188','47540','70315','46310','97676',
                          '95488','88651','87598','87881','96014',
                          '85357','65214','65456','38928','81645',
                          '19080','84329','65814','83122','45634',
                          '51721','61005','10911','41642','28714',
                          '91491','91278','89660','22573','31055',
                          '29820','94165','63992','13853','82327',
                          '82090','89372','73067','75538','48720',
                          '15008','66330','56243','65007','19701',
                          '70747','51084','63949','11341','92372',
                          '28053','20580','77389','38192','22134',
                          '37335','52162','74808','26138','76305',
                          '19927','64024','64783','40340','60387',
                          '98352','68805','34543','43607','32503',
                          '68048','65395','12215','28212','99321',
                          '90476','36657','81242','58629','70002',
                          '24001','30157','38106','56667','33977',
                          '45854','75664','52570','29885','30747',
                          '19507','93588','17872','16219','42829',
                          '31503','19936','92997','15799','38620',
                          '60485','82056','74142','15244','67833',
                          '87426','91214','26291','32123','22560',
                          '46037','19227','88147','29098','98184',
                          '52924','22679','96638','40882','21930',
                          '69840','62907','71999','92192','38018',
                          '19858','93382','63922','73047','34147',
                          '43402','77087','97151','63002','76063',
                          '83162','33698','98190','47810','72173',
                          '64948','16926','14592','90666','92653',
                          '94534','34898','17281','54942','99619',
                          '27155','78372','83023','49055','35298',
                          '77394','85057','88770','72199','28410',
                          '67598','59335','78560','12970','54798',
                          '93139','51906','75871','70502','23821',
                          '89899','38171','47738','45827','55244',
                          '48110','65252','40752','21391','82829',
                          '63591','95514','54459','47453','73587',
                          '85762','60679','93921','10024','58759',
                          '14057','50835','13193','68947','95528',
                          '91477','83143','69008','22275','42248',
                          '57773','59465','64481','21931','14297',
                          '87103','39467','83038','80013','39579',
                          '28265','79497','92563','84238','98935',
                          '58140','49660','80171','58042','90304',
                          '49295','75390','70615','39098','28349',
                          '27615','67076','73562','69428','24643',
                          '47125','94969','68868','48951','84435',
                          '77592','75311','31249','45697','55561',
                          '64745','12939','79475','86078','21733',
                          '42424','89582','29123','67164','64982',
                          '64721','59216','87239','96643','42601',
                          '64016','60015','15104','90340','59560',
                          '50625','28632','23668','71956','81720',
                          '69377','32931','27149','59229')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


