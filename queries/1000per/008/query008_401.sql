
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '41939','66922','89077','48364','32452','29546',
                          '64328','56481','13996','67860','20075',
                          '23930','68719','60960','41432','79683',
                          '25780','64101','98865','14488','66960',
                          '55531','32551','38296','79346','82931',
                          '31037','15900','32405','61171','80844',
                          '68323','72575','11575','68284','82706',
                          '28540','89272','87511','50606','96556',
                          '52257','14592','58802','46307','80858',
                          '16773','56489','84039','31722','79948',
                          '74236','18660','90354','34687','63621',
                          '63239','73256','96902','29184','63499',
                          '26700','79524','26761','84068','10051',
                          '53759','59495','30947','65524','41579',
                          '47726','14362','33978','25171','81667',
                          '99998','44257','49469','90627','98538',
                          '14549','34246','80320','11359','40627',
                          '95842','26551','60513','84961','11464',
                          '87390','71107','43262','32342','99702',
                          '78173','44465','67038','16431','16347',
                          '72803','72839','11045','74095','31773',
                          '46469','21753','99969','55088','73782',
                          '87777','97028','78638','99296','92834',
                          '67380','39539','21278','39516','96852',
                          '52489','35511','38728','81748','62996',
                          '54913','27695','86789','76588','71606',
                          '95105','66941','21917','59221','41668',
                          '88350','35166','68932','11213','46993',
                          '28936','91743','77849','58024','23485',
                          '77304','41517','59108','66409','10203',
                          '32141','17663','11458','61412','87238',
                          '33074','16830','33766','48694','90290',
                          '21747','69349','20978','68608','99004',
                          '29438','85482','67684','18367','57640',
                          '37706','25802','47210','96365','59009',
                          '10085','60004','84903','23062','39354',
                          '39333','94033','54393','40121','78864',
                          '13765','37927','22397','38220','27685',
                          '30133','12289','23769','22359','59382',
                          '39250','61705','80446','39053','64133',
                          '40864','61998','84552','98469','54449',
                          '77385','69777','70351','10706','86744',
                          '23442','81509','69111','37879','14595',
                          '33685','80132','25050','68941','86200',
                          '49063','75836','87106','85633','55864',
                          '31555','61274','75238','67245','14517',
                          '53248','39101','26509','35270','78773',
                          '31303','90508','11443','91696','28332',
                          '87377','90044','43964','82145','12015',
                          '53512','39828','44669','58571','97301',
                          '18225','69060','49222','87644','59407',
                          '55451','33582','74359','75721','46297',
                          '36071','61002','94660','74776','60309',
                          '15165','85677','88957','55616','62030',
                          '67716','42757','13359','36502','51360',
                          '47158','36524','96864','23157','64529',
                          '54267','70412','15698','39014','88392',
                          '29882','13277','97986','94288','23659',
                          '58305','20641','57833','34094','96147',
                          '36099','32707','76304','47235','54483',
                          '13955','27747','45549','23675','42568',
                          '13449','12254','92053','33278','27392',
                          '23400','89217','12211','20317','22531',
                          '58383','10885','23566','44792','36634',
                          '14799','14941','76264','45149','51614',
                          '99670','65270','96135','79657','44907',
                          '15569','66772','29172','79787','20484',
                          '42938','59658','10641','10190','50373',
                          '11117','99805','25131','83615','62854',
                          '38277','51062','74407','75731','38426',
                          '64719','37552','48444','74125','45017',
                          '35884','47804','88808','27117','80185',
                          '29902','70463','60461','64519','24213',
                          '74882','40894','54540','48582','85184',
                          '32184','45841','70876','81706','30852',
                          '63428','36238','98881','49392','83630',
                          '64430','11856','29780','66900','31703',
                          '51298','97317','66428','95851','93139',
                          '99201','66564','71707','17354','62740',
                          '15898','78999','16899','54982')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


