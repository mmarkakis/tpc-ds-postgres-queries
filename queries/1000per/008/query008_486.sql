
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '65904','71598','14961','53926','20598','80760',
                          '55191','99173','91684','56289','24664',
                          '62407','18727','95157','50306','17298',
                          '94493','95834','39576','98801','62742',
                          '55742','32495','47381','17903','77930',
                          '59861','81066','50809','92641','60598',
                          '79213','26450','18995','52014','93742',
                          '26012','78355','88274','59314','37616',
                          '55378','71375','96481','73387','94428',
                          '10037','80993','31649','22927','86801',
                          '48140','89533','81410','71222','83001',
                          '24339','86538','84607','25768','62375',
                          '27424','18990','44214','94945','12012',
                          '68670','18013','95134','10473','97723',
                          '59341','85568','30088','54724','83562',
                          '52714','25315','38718','57216','52324',
                          '42690','82347','29634','30089','98889',
                          '36687','14159','44904','26832','53582',
                          '55988','31047','83185','15354','11034',
                          '59329','55962','92662','99348','22085',
                          '46670','53403','77723','18930','25953',
                          '96173','58883','76698','55943','98652',
                          '49147','29205','35043','67196','80618',
                          '86081','94200','31100','47646','42110',
                          '47738','45074','65303','37796','26828',
                          '17977','86701','46925','54764','70514',
                          '33917','48675','59612','96540','11553',
                          '88514','51673','78156','31521','53038',
                          '71282','20838','95507','33601','52424',
                          '45259','23378','10259','96467','86473',
                          '20200','39560','40771','17594','49933',
                          '45603','71309','69136','92841','18469',
                          '51336','24988','75858','75108','94990',
                          '26577','73691','17349','23197','95469',
                          '80478','84918','82452','82539','39624',
                          '39942','45983','29384','16520','49983',
                          '30801','51559','94525','96635','78386',
                          '37536','55715','11149','97711','63096',
                          '48446','51783','51311','47806','38512',
                          '78536','27988','85711','88992','62096',
                          '18751','17068','57062','55104','90881',
                          '53079','16772','48415','51087','44202',
                          '42815','24256','75554','80255','83801',
                          '93586','31377','24999','85341','94046',
                          '42873','35284','44305','98947','87075',
                          '83579','38886','42964','48664','38507',
                          '57472','99599','25486','66092','40624',
                          '98847','43588','24229','75832','44133',
                          '95369','82792','88760','30722','27218',
                          '28106','81654','23921','89195','65227',
                          '86443','42769','50781','20182','59127',
                          '80654','72955','30542','49082','12636',
                          '72131','73376','56241','15718','17035',
                          '60982','96573','14088','17727','80035',
                          '92222','37628','96968','79507','90928',
                          '76570','49105','93534','20936','55528',
                          '20826','39408','90937','45588','62899',
                          '44195','54722','57723','54308','25339',
                          '34566','22162','76809','24415','84619',
                          '45143','70210','52821','11463','99619',
                          '75564','24348','58645','39829','26838',
                          '58918','43639','61899','62739','78710',
                          '10976','64071','14192','97648','20291',
                          '24306','83395','81602','35372','31755',
                          '35606','85754','87131','71318','89140',
                          '60684','96412','86060','36727','26100',
                          '22397','92779','54958','41389','50816',
                          '73138','23090','17417','65015','59786',
                          '17659','26211','40927','84499','72527',
                          '19065','79350','12911','88019','30036',
                          '29120','78994','38007','63631','89279',
                          '53273','91156','16441','80116','29533',
                          '79778','99565','64390','71751','82400',
                          '10014','47037','28342','52678','26970',
                          '24962','87264','87041','44967','44546',
                          '19262','76568','14436','16960','99394',
                          '97277','12560','98461','60264','35835',
                          '93283','19538','20703','60340','14004',
                          '49824','90457','57360','10763','14610',
                          '32497','47108','24761','90089')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


