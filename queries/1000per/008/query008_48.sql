
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '67106','38412','89421','63473','55647','47170',
                          '92652','60496','76745','81756','83428',
                          '19598','11274','17862','82794','93057',
                          '81606','96237','45601','55479','81794',
                          '13399','49310','19121','12319','41744',
                          '96497','63519','67752','37483','43291',
                          '96918','38500','89395','57090','15928',
                          '41487','27339','28386','78092','45420',
                          '90250','80092','30200','83149','97013',
                          '76358','81561','81079','91911','36323',
                          '93698','77716','10871','11142','41505',
                          '91627','59883','34087','31281','22882',
                          '77663','16127','43829','40740','41944',
                          '35746','43926','97542','16450','76786',
                          '76733','78679','76868','55101','14197',
                          '14475','34604','19452','49113','80905',
                          '14196','87874','68280','42240','79584',
                          '86777','86699','88492','56340','62345',
                          '33306','69274','25377','90403','88839',
                          '54914','88754','95657','67510','22102',
                          '78999','24036','89337','40402','87901',
                          '45721','33417','56307','50707','69829',
                          '76692','30452','53336','31708','59003',
                          '11361','76597','42040','56534','50802',
                          '31473','62844','16973','21346','65056',
                          '88381','79470','15193','35523','77422',
                          '82582','88620','10136','13704','11585',
                          '74733','60094','82952','87008','38014',
                          '73114','31176','94348','29288','39360',
                          '22595','24182','52891','52839','40865',
                          '30217','41358','51526','19690','36090',
                          '81934','88568','83844','96459','82720',
                          '51717','41100','76489','25711','88781',
                          '82089','25683','92187','11553','67111',
                          '66923','84458','89926','83890','29229',
                          '76560','25663','87977','79909','43623',
                          '87536','18366','55811','47251','32742',
                          '10928','66864','70015','77331','84933',
                          '82900','10101','95422','30209','22545',
                          '96093','10356','92330','33112','50820',
                          '25925','71481','13917','36882','33386',
                          '13236','98286','32945','47668','77045',
                          '88040','38801','28805','63784','36308',
                          '98699','31050','84757','90838','17976',
                          '86747','44460','81736','69640','15043',
                          '73370','65960','47571','36954','93468',
                          '10657','11234','83582','27660','82866',
                          '24585','40697','29742','97699','14587',
                          '79483','58865','82372','52171','15374',
                          '66445','77590','45103','32657','46184',
                          '63290','29448','79796','36837','27584',
                          '61728','53601','61935','48795','18824',
                          '38371','40356','34165','13081','54604',
                          '48234','71672','22148','52601','35437',
                          '25494','35428','33105','83959','53923',
                          '27308','18054','43758','17107','71144',
                          '97448','83054','14789','97192','19949',
                          '15337','46705','94795','14732','38598',
                          '34279','98973','11079','60516','44009',
                          '73627','89839','50399','58076','84101',
                          '41850','14909','10740','17461','81465',
                          '71204','30709','72620','11462','59527',
                          '89902','19634','10398','78133','29290',
                          '78349','72073','44191','61707','12136',
                          '91346','72897','11391','34988','35600',
                          '12302','91364','36380','31377','14179',
                          '88746','28210','74357','81435','22083',
                          '78472','44927','84442','95397','27751',
                          '63764','52444','20120','30111','48870',
                          '88027','74295','47883','65818','91163',
                          '14103','23247','34163','55995','48270',
                          '59519','57715','44289','68163','62111',
                          '34704','83849','46617','13267','15390',
                          '13497','55510','29165','27069','17890',
                          '88086','26941','78476','58129','24043',
                          '94385','43673','32357','99214','39107',
                          '29020','50054','12116','29049','48018',
                          '68618','99810','22533','21240','34997',
                          '84093','55731','23162','26827','16382',
                          '76425','92017','17307','38364')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


