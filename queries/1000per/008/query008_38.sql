
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '62779','58342','56863','13647','48820','36189',
                          '44171','28745','39266','35475','93364',
                          '78970','70954','22939','57705','72211',
                          '42911','29422','83260','48639','76408',
                          '36034','29399','38736','18926','20586',
                          '84213','17876','32143','54847','60276',
                          '67041','83633','36642','50543','13599',
                          '57092','96152','64777','33322','36783',
                          '37725','99022','11393','33793','66032',
                          '13862','88505','80555','93378','20525',
                          '43420','57364','93298','95598','16740',
                          '15471','79033','17711','37810','34451',
                          '35343','76767','86081','98762','60714',
                          '39123','50135','12044','40805','48424',
                          '38100','48306','31518','77195','43768',
                          '59165','37743','25098','66624','66772',
                          '99243','57561','92939','70446','66151',
                          '72764','27134','73177','73004','61491',
                          '11440','22838','44351','28274','33219',
                          '50319','60897','57160','71721','97177',
                          '20994','30230','49467','64108','89254',
                          '11632','65590','62683','16939','34042',
                          '10106','74463','75019','42590','55408',
                          '41674','49715','35114','11369','25767',
                          '94229','25869','50359','55822','68448',
                          '45742','21536','40361','76713','50713',
                          '16305','27937','10194','82869','14673',
                          '61301','73470','12390','36671','29386',
                          '11350','71626','29795','26227','39876',
                          '94946','47739','77239','38281','11165',
                          '92028','16187','60988','85935','21910',
                          '46383','98276','36903','36946','76702',
                          '32089','65378','62534','51423','88793',
                          '80473','56901','13863','73002','80107',
                          '98734','42878','48515','20984','88217',
                          '57165','72893','64614','86066','87307',
                          '48546','37336','96248','96995','66565',
                          '58845','86233','25698','57421','66243',
                          '23109','43327','54214','99964','30613',
                          '55370','49343','57355','43763','39146',
                          '64525','80815','34640','80030','79206',
                          '65010','59395','84792','15423','88063',
                          '62249','20611','62004','98428','82593',
                          '59007','38890','94825','67748','60676',
                          '96895','85807','78523','16479','56494',
                          '24541','68024','39339','41727','89802',
                          '44864','38815','81750','25340','78151',
                          '68234','39353','63018','13110','82563',
                          '88865','19311','37526','72341','23181',
                          '73811','95981','71214','11326','73107',
                          '48245','81309','84087','21594','37991',
                          '75387','45434','34378','68765','15687',
                          '46309','67209','53424','96757','26929',
                          '91558','46371','97622','21615','95391',
                          '40119','67384','38681','21571','23617',
                          '45695','77333','20929','64773','86389',
                          '89405','16568','73649','97596','34442',
                          '42642','42132','78288','62470','62442',
                          '45549','31874','40389','20667','36645',
                          '45322','40594','43625','44760','54339',
                          '51634','85819','76962','93631','74272',
                          '47852','74634','14269','94242','76213',
                          '80609','28620','57613','31422','87347',
                          '93690','94456','20108','67329','12278',
                          '16469','91334','93275','83638','77023',
                          '26999','53246','31380','89635','34281',
                          '77744','88583','95936','65697','66585',
                          '11037','85919','27262','11019','52277',
                          '48473','46045','67167','68250','72812',
                          '74284','41278','35928','84974','91207',
                          '85643','95437','66857','75899','92039',
                          '88368','55215','85026','18282','28155',
                          '55111','53609','93736','72230','79347',
                          '77396','25285','43490','49399','65607',
                          '79864','96550','83932','83468','74087',
                          '83412','33818','17160','84123','47906',
                          '77213','68297','28387','40444','15528',
                          '85778','22590','63344','58723','53477',
                          '65291','18882','32160','42234','96524',
                          '33586','71371','24169','48203')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


