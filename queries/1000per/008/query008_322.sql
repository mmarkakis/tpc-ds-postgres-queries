
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '70773','29033','70936','44793','97453','80090',
                          '31365','35898','89714','17093','97680',
                          '10395','98288','65177','46870','77367',
                          '58907','20851','77910','22090','17081',
                          '92083','78908','32419','37160','94701',
                          '94283','75265','74199','20478','26663',
                          '84847','85056','61845','58748','65992',
                          '81739','55423','29086','80358','77180',
                          '23350','51169','45206','64497','62325',
                          '20364','18876','62156','37315','23033',
                          '49085','64432','32828','26248','25312',
                          '12702','70129','40656','45967','58816',
                          '23030','32180','49969','84327','31456',
                          '33760','98613','47702','17123','92599',
                          '23422','61796','16322','38701','59213',
                          '94939','99821','74883','17276','38449',
                          '83371','31485','92011','20500','10582',
                          '78010','22480','76854','35464','22822',
                          '23314','85722','26184','40366','33255',
                          '61171','53517','30189','72146','46049',
                          '75703','67672','48049','19239','33024',
                          '93245','77855','38159','74777','75896',
                          '57324','84961','72790','67163','87753',
                          '30787','35124','44755','80305','81233',
                          '30379','77688','82842','91867','35837',
                          '14398','15395','83592','98162','79756',
                          '86510','75331','85597','32848','84778',
                          '10458','34441','66255','19477','24802',
                          '88406','34042','20343','88192','43205',
                          '56536','25546','81195','30275','32610',
                          '17631','50891','13698','21222','67850',
                          '92855','43551','50599','77137','39974',
                          '61701','78952','66113','68996','68610',
                          '54214','18194','29703','37751','12533',
                          '90672','36906','64722','97275','52480',
                          '13578','95945','89461','89056','61947',
                          '79259','64990','14041','99811','17445',
                          '31025','30896','22717','68854','14088',
                          '24777','22163','10189','49020','83896',
                          '12166','25087','14135','13530','31177',
                          '34915','12133','43472','55442','76022',
                          '36145','54126','83320','71078','77277',
                          '36642','39459','49458','92590','22810',
                          '62205','58189','26958','12912','12759',
                          '15260','56012','73977','53002','63080',
                          '94209','95516','44459','81464','85143',
                          '68496','77185','31242','59848','42508',
                          '59445','10735','42513','60791','78972',
                          '63870','36897','44405','42854','87329',
                          '75575','64532','73408','15941','32410',
                          '44580','50248','99774','20119','84765',
                          '94105','11881','88203','45764','75334',
                          '90510','93298','37359','66469','69618',
                          '88416','54675','11641','16244','72811',
                          '49774','45939','38716','18664','51211',
                          '47053','15559','69683','50322','71047',
                          '13320','77744','15378','82950','87944',
                          '91217','25790','47837','10728','89544',
                          '47059','10908','35862','87237','90895',
                          '24432','99594','17896','67255','79313',
                          '48576','61957','16513','97873','72733',
                          '63372','72359','47127','85596','78411',
                          '84123','30698','59933','70192','15305',
                          '69924','49269','31030','87500','16316',
                          '94954','10813','12364','34352','78035',
                          '80117','79100','19588','76980','87573',
                          '76830','64901','25308','40583','33050',
                          '86672','24045','21032','60723','64120',
                          '61299','92782','71356','67498','52535',
                          '98408','16333','54853','98488','75586',
                          '37014','79604','73110','16650','85713',
                          '49529','66180','68525','33167','77464',
                          '93099','89787','23402','65620','23901',
                          '55076','22622','26909','71247','71781',
                          '64815','87628','57320','95695','67991',
                          '95063','27234','91660','46568','83260',
                          '67476','54896','12073','61324','46686',
                          '56788','46858','45201','18478','78539',
                          '47077','21063','61488','72419','83519',
                          '96066','61525','38145','48830')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


