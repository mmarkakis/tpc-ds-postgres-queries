
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '29704','69388','84378','50190','63213','83490',
                          '77276','49317','26023','66759','68468',
                          '83965','62081','68953','12750','24158',
                          '37415','71414','82255','98762','92102',
                          '26520','46451','57231','42825','88540',
                          '27405','74960','58455','65261','85988',
                          '53252','53374','13015','68666','77647',
                          '84657','56630','21278','46985','78570',
                          '68102','81099','54269','30490','55890',
                          '92464','90983','44199','29006','26184',
                          '25348','79090','85788','62580','98522',
                          '77882','39147','75242','42584','37404',
                          '29711','17092','11074','53881','97402',
                          '55783','47634','41052','49179','67226',
                          '87392','56712','82160','43281','33446',
                          '28628','51287','33621','53386','74934',
                          '34020','43082','44361','64164','63762',
                          '73835','73502','19046','39446','48363',
                          '94539','59101','65630','43715','36072',
                          '42213','25442','91490','45895','93704',
                          '97197','94233','26770','34345','88129',
                          '20398','61557','28846','68945','80321',
                          '63011','53606','12806','26010','74332',
                          '96286','79543','34514','61393','86577',
                          '20850','94777','17817','65886','99371',
                          '48917','66353','86445','40215','40631',
                          '21046','99851','22576','81368','83776',
                          '44740','83327','57657','67035','43888',
                          '85958','32376','95486','37758','55225',
                          '30197','78029','89432','96709','90268',
                          '39508','37232','27216','11820','46178',
                          '23380','28719','85680','99067','62833',
                          '32891','94796','58704','80287','38857',
                          '91021','36650','50630','12514','20613',
                          '14139','70281','22109','22659','27621',
                          '71906','55739','94493','43468','47657',
                          '40346','23612','48262','53712','27476',
                          '23035','52196','17165','18618','51625',
                          '63034','57212','37668','87977','18039',
                          '47498','47733','32075','82038','73588',
                          '79099','44222','93033','80464','22823',
                          '20064','94489','62534','27940','84784',
                          '44567','91244','48381','77229','58476',
                          '64926','50621','48062','64345','94438',
                          '68410','20853','20550','11465','71208',
                          '11994','89060','52939','16719','14395',
                          '73727','29355','36694','94406','87597',
                          '19934','65412','27390','48518','58866',
                          '69965','38134','44571','37635','16163',
                          '90116','84160','50951','93090','63470',
                          '70376','88317','21291','65992','86081',
                          '12764','83421','49123','53708','55631',
                          '98071','60760','68350','50150','12252',
                          '10651','17441','78532','25202','54943',
                          '55408','24177','80463','75013','47702',
                          '48046','42589','55475','36070','28061',
                          '92296','13304','83269','29453','24318',
                          '39893','28172','88731','32763','74568',
                          '28122','40143','57966','40336','75830',
                          '46555','59581','40602','93912','18385',
                          '78055','20988','68973','28202','14256',
                          '90046','73275','79014','49626','22073',
                          '35491','74952','40946','15517','41244',
                          '32809','65620','24048','33238','67742',
                          '73144','15631','62729','51144','77885',
                          '63059','51739','53448','48781','63684',
                          '38010','91972','21207','64673','78505',
                          '35468','90579','60671','42420','23285',
                          '42676','89046','95722','50484','15315',
                          '85349','10957','51217','84654','27063',
                          '97357','97037','25346','73847','62622',
                          '37545','65579','18429','67883','81194',
                          '63888','61353','23426','41596','86454',
                          '27437','70769','41192','54798','60703',
                          '67802','51212','78726','87332','14274',
                          '17350','91764','93999','79470','27252',
                          '59607','35589','93086','20270','95970',
                          '24518','18507','44061','47339','69738',
                          '65988','60047','41618','93903','74862',
                          '40696','10784','35457','75245')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


