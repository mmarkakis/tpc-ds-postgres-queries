
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '41224','41150','73148','23301','86909','18088',
                          '13597','75445','18740','99513','93185',
                          '71020','93272','86784','19208','42140',
                          '68878','75426','54154','32607','41778',
                          '98607','92943','37663','75599','26380',
                          '51242','32882','59625','18999','89941',
                          '12767','12489','79709','71679','93862',
                          '39143','54346','48417','49903','17822',
                          '86750','87570','48637','53299','79875',
                          '99826','24592','90304','51449','40126',
                          '46794','49960','93413','63879','74837',
                          '46153','47395','25513','55706','44877',
                          '95160','34118','81916','41914','27712',
                          '52632','93337','96866','16956','49036',
                          '27958','76535','31410','51869','30189',
                          '59291','83165','11392','39472','32491',
                          '69184','99318','25773','28257','68648',
                          '15421','48579','42545','93900','53574',
                          '39848','11564','40489','58849','30426',
                          '30722','82629','19297','80962','23523',
                          '27201','66748','27663','88301','39439',
                          '56452','78617','66665','31514','72713',
                          '35451','93843','76824','31289','68691',
                          '77328','29258','98040','33314','75975',
                          '98308','13361','50690','95503','97274',
                          '92811','58689','53349','68497','42267',
                          '32309','76268','36735','25131','97915',
                          '89912','39847','26751','92037','33961',
                          '94947','14992','74378','62662','35801',
                          '43427','78773','90323','35865','43644',
                          '60333','74537','72270','60145','30876',
                          '58172','94861','45541','91142','87877',
                          '16064','79348','62173','29769','52415',
                          '44006','19819','57475','60866','63599',
                          '56559','67470','85537','23112','52568',
                          '81565','54110','78471','76114','98564',
                          '87602','56017','76624','10281','78579',
                          '34708','55829','67050','89302','56530',
                          '42132','97897','41993','90607','24851',
                          '39939','38600','59577','35110','15675',
                          '12976','68708','77861','44703','49711',
                          '50997','17329','97796','44231','24399',
                          '96654','84135','69634','45926','98946',
                          '17623','98851','92844','17390','59113',
                          '52644','10096','84526','80409','13062',
                          '30930','84697','98382','88060','55218',
                          '42837','90972','86457','38714','98200',
                          '93045','89989','74421','97376','26543',
                          '14150','31230','30846','20839','16438',
                          '44049','87805','83788','46045','75777',
                          '44240','65070','49439','76096','48965',
                          '80737','80551','14163','12168','11266',
                          '77296','82820','71266','25296','52445',
                          '57304','97895','28202','28590','14009',
                          '44186','77864','47372','38255','37728',
                          '74356','56480','83809','89625','21692',
                          '47366','90933','29894','18161','97626',
                          '81984','87031','19362','30407','10046',
                          '43343','51357','40588','33979','78469',
                          '70212','81030','38445','84238','30522',
                          '36549','95261','60040','46283','97256',
                          '54748','36407','99564','21425','43131',
                          '33437','29641','61785','78175','56293',
                          '35381','86256','55208','12879','44553',
                          '56594','45835','33084','98088','67922',
                          '89591','82558','84798','19540','93360',
                          '42374','80555','96509','71409','49718',
                          '10887','47321','32295','40641','56114',
                          '24624','88121','66204','11308','40506',
                          '48657','76430','64106','66268','13589',
                          '55619','74273','55415','68203','57619',
                          '73721','67904','70585','63478','36674',
                          '93237','35254','47224','16233','31698',
                          '86573','77438','35298','53485','91187',
                          '50027','39451','11923','66537','16222',
                          '73414','31916','69146','12622','71950',
                          '74497','24779','83982','15339','22271',
                          '37834','47606','36022','65181','60740',
                          '57939','41148','87092','34722','42329',
                          '50586','85538','90094','49052')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


