
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '53781','99475','39186','33411','36951','44632',
                          '89301','32300','77136','98441','28831',
                          '68351','76548','71125','88373','57664',
                          '55718','47058','73187','11868','27606',
                          '94892','44472','84091','10666','18517',
                          '95845','35973','40112','97558','21934',
                          '26023','22666','41762','81723','37691',
                          '95512','81760','78926','35812','68575',
                          '86155','12143','50380','76675','76545',
                          '24786','20066','18288','76652','51853',
                          '31391','69384','17573','75678','50039',
                          '68693','23734','22548','76962','74431',
                          '74099','55154','75466','99467','76294',
                          '57677','32353','38111','48885','60873',
                          '65906','18286','80177','68415','77712',
                          '21399','91616','64192','76135','38119',
                          '63920','19013','66145','70557','69727',
                          '63044','91778','23491','55228','66304',
                          '87490','24693','24289','73878','72905',
                          '65672','73592','11097','96481','81378',
                          '77688','51837','61959','49721','46677',
                          '97436','41262','97902','81959','97377',
                          '76665','25402','72543','44517','65380',
                          '17431','57513','49348','84243','20496',
                          '31900','26742','45073','66813','38885',
                          '82163','96490','81775','70650','36423',
                          '88021','81715','53799','12097','18416',
                          '49659','21316','52193','95570','85898',
                          '29600','75977','93184','14247','66338',
                          '93262','14073','92423','53098','65904',
                          '65440','61936','20840','69749','45536',
                          '19616','49862','58388','87414','80560',
                          '39976','39962','30772','87941','63408',
                          '35461','77395','69151','72747','98438',
                          '23743','57012','28561','63440','10012',
                          '51215','26299','21803','54669','74158',
                          '46370','14556','15632','56548','80997',
                          '52688','63122','32400','22493','44170',
                          '30939','27850','27499','26239','74983',
                          '60354','89102','95916','73786','51832',
                          '60859','34890','97209','36308','97807',
                          '78356','59959','96935','32100','75187',
                          '48247','95885','74402','56197','67699',
                          '67881','49802','54428','71380','73540',
                          '45576','41873','45924','18901','92578',
                          '25353','27772','51393','84175','18478',
                          '35145','94473','82194','10827','84351',
                          '84220','35102','89496','21886','55418',
                          '92505','49896','74696','88286','66467',
                          '82493','35919','13437','78457','64207',
                          '47394','50977','67155','60105','63461',
                          '74491','19225','95288','93805','63979',
                          '41414','28992','49336','47621','37326',
                          '21768','56506','98482','25713','80666',
                          '25153','59326','28732','46804','38376',
                          '85123','19972','90759','13340','98897',
                          '28547','92119','29959','97121','22433',
                          '26016','71073','55995','43094','11435',
                          '35243','13103','14249','78152','48003',
                          '90237','87361','83612','85648','78474',
                          '21507','86298','90160','95241','29721',
                          '58609','26182','23733','91686','45817',
                          '57264','55780','89458','96114','48795',
                          '57963','42659','68139','40658','82833',
                          '34698','72594','19988','11439','44757',
                          '94146','97256','95160','92954','69198',
                          '74248','75979','18228','12410','92480',
                          '98165','82776','74916','24379','14214',
                          '67774','75082','56365','11231','51607',
                          '70264','90618','37034','94164','38143',
                          '76792','39581','82942','13866','20133',
                          '17830','20393','16901','50369','91276',
                          '54172','96650','11075','22898','84812',
                          '82000','43588','97938','53649','77928',
                          '14906','50099','94403','94234','19296',
                          '32762','14150','70948','25609','49655',
                          '80465','70749','41778','64228','38212',
                          '92366','24140','87525','34556','41907',
                          '15777','27027','45275','80701','97874',
                          '34060','53466','70203','74459')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


