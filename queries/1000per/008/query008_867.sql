
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '11879','69065','97097','20901','97479','43972',
                          '72247','19845','41665','35857','51919',
                          '32362','45797','26780','51538','32278',
                          '85522','31213','21706','62327','40750',
                          '46254','68050','85684','94117','96060',
                          '74767','98959','45788','60192','71236',
                          '27369','57828','65668','52280','84252',
                          '52844','93182','34173','48029','12449',
                          '20250','66785','71927','27448','36046',
                          '82506','20826','27344','88351','34780',
                          '56586','34636','33965','80484','26725',
                          '79506','89314','86845','75497','15991',
                          '11328','47441','16567','52430','35143',
                          '31760','68594','93200','69093','67468',
                          '59185','49299','23580','33566','70388',
                          '73313','97190','98484','61405','87818',
                          '66579','65782','12170','34481','14973',
                          '35498','84472','66151','91799','80813',
                          '82884','57058','56405','80105','19029',
                          '36358','72187','29299','51096','52694',
                          '62395','78029','50829','41441','83864',
                          '73304','87033','27296','21172','79602',
                          '95969','78041','56137','33277','60471',
                          '48105','81723','16915','58914','95027',
                          '66065','78682','24955','43053','65372',
                          '18077','67914','32952','52637','45922',
                          '74428','47022','66298','45495','39360',
                          '49896','63551','27188','80947','86818',
                          '27722','15315','97636','97833','29721',
                          '99979','43519','29828','90664','92529',
                          '58107','24403','37712','25571','55184',
                          '99604','11691','73956','79352','75810',
                          '89621','54750','83999','53223','65801',
                          '86629','68090','57413','56501','90532',
                          '11742','99324','79925','89526','12163',
                          '41720','37090','77810','61512','54003',
                          '53572','73082','32875','35653','67890',
                          '54838','65298','13361','15577','15294',
                          '18127','75825','93883','22143','57546',
                          '20419','44517','23405','85081','74097',
                          '17915','88012','72871','77508','69878',
                          '20939','65322','81537','97251','70739',
                          '45806','63642','52751','33073','26941',
                          '24518','73361','19972','49166','24249',
                          '64068','56077','44559','60501','52775',
                          '83638','26710','17234','63458','14822',
                          '93166','96877','13853','52015','57399',
                          '22286','89474','41013','23354','72115',
                          '26958','12914','41837','80852','99404',
                          '24951','64797','43219','57434','60944',
                          '66532','51863','69159','50407','65037',
                          '29600','42405','34527','75457','29267',
                          '93302','68598','94260','51455','80181',
                          '89899','39541','17203','60026','62867',
                          '36377','42481','99276','39505','83191',
                          '70412','29319','50973','16910','48326',
                          '66199','50836','13669','69718','63032',
                          '47122','52860','80148','78587','91207',
                          '48414','27981','15939','49647','35650',
                          '67335','31606','41167','30061','14430',
                          '70789','68821','25191','25229','38271',
                          '21535','92893','30342','69604','84083',
                          '56351','44654','64561','70992','88101',
                          '71689','50091','13272','98358','22119',
                          '75213','86222','49257','30116','48001',
                          '53480','90521','42937','51090','66184',
                          '25325','45704','13259','83977','83748',
                          '53075','49220','18687','55112','28012',
                          '47337','71946','20784','86507','27587',
                          '70832','66763','26649','82539','67749',
                          '41283','63781','34321','55684','59099',
                          '50155','95922','46039','43783','28964',
                          '62969','19535','75617','25103','94473',
                          '95930','97032','79456','90791','98479',
                          '78278','59930','68588','30401','77796',
                          '40611','30168','59709','97161','51382',
                          '66657','80455','56178','13863','49833',
                          '23223','65909','86270','81175','66622',
                          '92844','32976','98950','78475','28776',
                          '11008','17362','63258','18890')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


