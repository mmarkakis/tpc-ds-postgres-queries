
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '13004','27865','22740','67593','52166','87654',
                          '14747','22247','40439','66323','23680',
                          '99319','19910','21194','65575','50638',
                          '64230','83122','58870','95075','77776',
                          '57375','74348','40810','79997','68565',
                          '53450','32568','33952','26051','28813',
                          '34737','26566','28969','89453','36159',
                          '13590','84560','64408','77461','65003',
                          '38792','16909','88200','96468','12323',
                          '54456','76453','65292','81270','24201',
                          '64920','83454','92535','64359','94924',
                          '95018','61606','66889','89124','54593',
                          '78941','90559','29637','42523','19983',
                          '93992','11184','15590','39268','37544',
                          '68007','15604','74923','26972','12278',
                          '14866','92647','43993','19513','54776',
                          '74503','93038','51796','79938','54137',
                          '16939','97605','26118','46212','53996',
                          '12866','41057','19341','13226','21013',
                          '12481','75148','42662','33104','53301',
                          '69367','62669','58136','72467','14615',
                          '58978','45881','84241','94684','48583',
                          '63220','95176','91433','30477','87872',
                          '81582','42631','48221','67180','79931',
                          '60759','36114','40579','29866','53268',
                          '22462','41773','29690','20957','36698',
                          '93043','35807','66436','92080','34657',
                          '69414','90952','13118','86126','66024',
                          '73511','45518','54807','52623','97155',
                          '78152','33910','25816','69604','31914',
                          '48581','64531','34467','70231','83796',
                          '31488','25058','47079','75937','15969',
                          '27225','90475','79450','79850','33939',
                          '22035','25590','15109','69810','86496',
                          '52070','44766','77422','33579','83606',
                          '72428','71132','98379','38457','56770',
                          '31631','75723','89421','61856','98185',
                          '77969','14979','64478','15182','50774',
                          '48616','83499','13495','25430','44753',
                          '35053','37181','88590','48966','79794',
                          '88046','97779','80566','28081','67823',
                          '65704','62607','13301','84568','43325',
                          '67464','21869','63982','93475','14585',
                          '61707','90245','25776','62899','82647',
                          '17348','63116','52094','71231','12798',
                          '26222','44363','73627','17045','94586',
                          '31161','99569','30046','27233','90724',
                          '21274','31757','52061','79453','11830',
                          '84259','36806','15427','12491','12527',
                          '98000','71544','94165','25888','63339',
                          '59224','16450','41202','28721','86823',
                          '64196','34562','22474','43312','22552',
                          '23834','44169','73184','22820','19820',
                          '84331','16766','92136','77788','90865',
                          '73926','45931','16737','51560','38970',
                          '85665','96573','10270','61720','58351',
                          '89152','91876','58260','23715','81889',
                          '68517','47030','18401','40471','21566',
                          '78332','24837','40808','70004','84313',
                          '71423','27716','40306','82128','55874',
                          '84110','73646','94382','35788','66218',
                          '13827','58356','75902','26681','55136',
                          '22311','26134','70652','12223','64348',
                          '20189','14831','43334','99375','47049',
                          '29679','41191','12143','69502','10172',
                          '15593','37112','52417','64524','49513',
                          '23746','68765','20595','66685','69618',
                          '16985','97245','80262','40255','58679',
                          '28304','19840','80282','16949','85365',
                          '30760','78495','19239','28000','94480',
                          '11022','60597','87334','57009','94856',
                          '45568','39474','86930','59759','95655',
                          '13690','81558','80363','33906','12137',
                          '87924','18522','17092','16709','56381',
                          '14162','67247','23095','57706','89361',
                          '63060','16493','74066','25480','46854',
                          '12086','67928','37879','74113','51165',
                          '46736','87500','43717','73050','31431',
                          '49921','44739','58522','35483','15382',
                          '77244','42303','80227','43779')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


