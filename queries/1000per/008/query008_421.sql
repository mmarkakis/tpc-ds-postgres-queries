
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '45425','41018','25223','39302','88351','44382',
                          '30609','49041','25079','92473','70652',
                          '77716','85639','64140','13666','95826',
                          '54642','31694','89148','84944','21221',
                          '85582','82899','67704','61311','72541',
                          '87991','73288','70533','53826','13787',
                          '39234','27836','45598','64605','97648',
                          '36815','92206','25243','50287','43878',
                          '66441','67820','14027','78538','85555',
                          '81895','81802','53378','43812','58498',
                          '21983','36612','34158','45915','51013',
                          '75088','19673','91008','76213','35029',
                          '94244','79967','24617','42260','58180',
                          '54556','15004','86127','41124','79261',
                          '70878','93952','52122','89296','72637',
                          '41744','67135','25709','93794','30879',
                          '93709','76063','42047','73176','62376',
                          '32386','86611','94293','79533','54439',
                          '23966','25356','73314','64965','91519',
                          '24954','18296','41226','27303','26373',
                          '20517','10924','49801','18909','61633',
                          '13946','78472','69129','68351','15808',
                          '37489','45034','51624','10556','51807',
                          '68919','47438','26367','34717','62761',
                          '24008','26847','56806','95511','14355',
                          '41097','75762','91965','81676','93612',
                          '87367','56851','31037','61191','67388',
                          '33799','75768','57411','59124','55354',
                          '60937','78620','15996','70003','87464',
                          '66962','95262','59945','40613','83316',
                          '31254','52045','11566','93988','22024',
                          '77040','45597','65318','15204','21643',
                          '62099','95009','93497','43883','93182',
                          '29057','92175','93644','93411','14293',
                          '46682','14959','96167','46425','74098',
                          '36060','74580','20155','30724','20556',
                          '27601','19619','81353','56519','28177',
                          '19027','86711','64950','37536','66930',
                          '14709','97389','15822','90043','44033',
                          '62499','77427','31718','37471','62629',
                          '30758','50130','71860','60047','54519',
                          '14079','79135','29398','59276','87007',
                          '33377','59905','77104','79712','82968',
                          '67761','51527','90743','11548','16475',
                          '78293','30397','76844','14301','61969',
                          '97004','62506','17612','85664','77790',
                          '45191','83474','29872','24338','87252',
                          '12394','25949','41602','30066','28061',
                          '15627','21442','72609','15091','96473',
                          '46055','34666','72268','22836','66837',
                          '76689','68846','82507','31679','58215',
                          '24301','86987','70499','10265','47397',
                          '48347','71376','56945','87114','81939',
                          '86767','99273','87782','75512','56787',
                          '71837','63771','36777','34036','43247',
                          '74845','17266','14910','74113','46736',
                          '98694','66160','44429','91458','29869',
                          '62206','76007','59443','78663','32588',
                          '48966','64333','52598','22063','12087',
                          '89374','78197','86643','39952','64448',
                          '80362','18328','47045','13645','91733',
                          '38155','77424','43069','74876','82540',
                          '15479','90357','83675','96106','59055',
                          '45999','14062','33922','69902','23161',
                          '96008','64565','80878','66527','66946',
                          '90614','12493','33508','78167','62656',
                          '24670','78899','64453','48955','20459',
                          '39450','74048','49883','23763','31751',
                          '56174','37054','32870','94994','11733',
                          '36433','95128','81229','56779','46963',
                          '27761','97331','87644','80343','18809',
                          '11285','77526','33398','48900','41180',
                          '44355','28590','15643','24697','86905',
                          '37373','54641','67776','97359','59418',
                          '52834','71291','85727','20395','43828',
                          '63520','30113','92815','75835','54237',
                          '69269','38554','95669','85701','93614',
                          '16192','83862','21048','93011','21070',
                          '31952','69734','11559','52717','63079',
                          '76294','59861','23513','37314')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


