
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '20697','30634','11356','55399','92339','71239',
                          '45120','67706','48169','89920','63615',
                          '12045','69829','88821','42126','67268',
                          '36731','58294','84690','55985','34069',
                          '17366','68675','56103','97724','65553',
                          '18793','61794','42511','74210','26029',
                          '92877','37917','24204','85788','53736',
                          '52867','75265','51317','53408','13883',
                          '63175','46224','45192','69849','68996',
                          '19645','28915','82199','53189','97014',
                          '37039','66591','62106','81211','27203',
                          '55703','99483','45565','86601','53219',
                          '35528','76073','70906','77238','99589',
                          '92049','91987','55456','63718','22170',
                          '53380','23866','27474','27979','90055',
                          '56762','80824','75278','41385','63012',
                          '90584','58635','89273','92226','50246',
                          '85175','63538','66003','99154','59294',
                          '76393','55349','38170','65191','36295',
                          '20083','18577','87339','56772','22203',
                          '99179','58100','94078','35379','75604',
                          '26210','49082','78885','63803','24678',
                          '26954','99917','47265','59828','66415',
                          '56741','25575','39180','20580','33502',
                          '47598','73081','70323','80649','22911',
                          '87194','31979','94282','94718','87845',
                          '45756','52182','49498','66996','89111',
                          '38761','95851','95522','35296','67073',
                          '66886','78053','21311','19991','96263',
                          '52089','32080','51438','83875','51170',
                          '62291','77893','83261','56663','99846',
                          '15165','71620','83727','47140','68987',
                          '68388','11255','39337','98678','36299',
                          '25327','56101','59987','29510','57627',
                          '80616','24245','63893','84802','41824',
                          '12091','75694','30933','37296','21209',
                          '74207','69600','59216','99156','31508',
                          '63688','82793','13767','32502','91787',
                          '78293','26227','53024','26283','83700',
                          '82190','40996','59366','68255','49291',
                          '18428','20187','22089','96428','57548',
                          '43696','38698','42896','86099','41021',
                          '56455','34353','98914','57461','16548',
                          '20278','93303','38575','24450','74964',
                          '77248','47385','84993','25769','19521',
                          '19046','59159','74304','39013','23093',
                          '70299','99652','95366','86352','35151',
                          '85315','90026','65265','93620','45549',
                          '80142','90217','99303','33554','82736',
                          '36865','91100','41880','48205','42551',
                          '77051','38460','81811','88023','34206',
                          '21242','18320','78709','70639','25659',
                          '68642','40502','92687','35025','57684',
                          '68409','91216','76128','79019','40856',
                          '31833','87457','57917','35951','97934',
                          '74180','58835','53346','89591','55033',
                          '76635','57093','12242','13397','12999',
                          '87511','19785','85629','48883','21308',
                          '23344','56165','22425','96482','90711',
                          '13743','19406','17757','88901','77514',
                          '32200','67014','30070','61398','76782',
                          '62586','69873','17250','78513','48027',
                          '87537','95349','35290','34722','46187',
                          '19772','70859','98522','76163','18798',
                          '64861','18171','11376','87603','13791',
                          '23409','77799','12941','53148','20818',
                          '91431','70496','32784','69003','98775',
                          '96753','17309','63575','39403','34236',
                          '63789','24832','58744','81268','82585',
                          '70101','50887','60608','30418','85020',
                          '67637','82509','38115','39252','34537',
                          '53245','98617','52746','12500','12771',
                          '62148','94250','28965','99521','34433',
                          '66502','51329','17861','49726','31065',
                          '82237','77693','70296','44881','91999',
                          '42035','45181','84523','69665','47161',
                          '63423','45630','41233','63118','21131',
                          '51178','73950','44676','26446','14405',
                          '52649','37316','14840','39072','81370',
                          '36324','57582','14746','76955')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


