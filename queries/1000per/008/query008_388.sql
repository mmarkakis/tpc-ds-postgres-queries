
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '31982','21649','76104','37701','60662','93572',
                          '99659','63932','87247','61009','17478',
                          '26847','31209','62021','97101','26219',
                          '78500','75546','62426','16457','51672',
                          '84962','67197','26213','57088','72751',
                          '22676','94704','67718','68440','97181',
                          '86701','41289','87338','18202','55893',
                          '85677','22381','13289','69276','71888',
                          '64700','96163','37121','44696','72451',
                          '45658','86366','98633','99894','31683',
                          '59386','39291','86021','45908','89130',
                          '86331','57375','48606','38442','73409',
                          '36630','55796','73183','64703','81368',
                          '32736','46440','12448','65233','85724',
                          '54214','87507','61124','76929','45879',
                          '31854','26280','97105','46360','11998',
                          '70942','37293','89025','13124','45751',
                          '40388','68331','22548','71787','58953',
                          '45763','34191','21634','66055','62211',
                          '51315','43801','21826','96452','20789',
                          '30854','92100','74250','21199','88313',
                          '74605','53860','58121','23003','20685',
                          '18015','35159','30561','78482','42325',
                          '70937','64168','36540','96987','66978',
                          '76423','74921','73034','45750','51351',
                          '48657','30639','72582','51493','67312',
                          '91977','46518','17927','92409','79440',
                          '61070','25712','34204','17842','92721',
                          '37741','20102','12659','63980','86061',
                          '42282','86399','56353','96933','59642',
                          '36579','30595','25619','14080','62417',
                          '28029','42033','35218','31208','99971',
                          '44723','49298','11061','48288','65562',
                          '52583','54895','64423','91568','28465',
                          '19628','62741','85546','70583','12885',
                          '18841','13256','87341','48772','76818',
                          '78017','61455','82997','90031','19698',
                          '52807','78623','55602','76556','10079',
                          '65352','21920','23241','49247','43086',
                          '68353','31364','31588','94333','42253',
                          '83372','67766','80389','73498','63159',
                          '91837','57814','28965','45503','53142',
                          '48054','53488','43662','50714','93230',
                          '79692','91363','93682','29793','37678',
                          '38678','41968','11417','53310','70462',
                          '76865','91226','12915','20179','58804',
                          '25849','35892','69614','11345','69506',
                          '13915','16910','44361','56800','15785',
                          '15592','40494','16278','48605','66048',
                          '34546','44141','10383','76559','60906',
                          '96568','63645','48741','72953','56267',
                          '35175','82236','49491','88490','73233',
                          '93644','60765','95807','23200','99324',
                          '86530','87240','43317','42217','78876',
                          '22089','77762','81451','27268','80995',
                          '75945','33038','84507','37395','83352',
                          '18178','94949','84652','92044','81467',
                          '53902','80171','45021','25997','54119',
                          '71689','61803','12225','89041','25747',
                          '85647','15684','31676','53578','96407',
                          '47199','72388','86159','33220','35575',
                          '92566','73925','28562','61500','36584',
                          '53437','84111','55572','58592','80110',
                          '61608','90659','39839','32327','50881',
                          '59938','96990','13062','92009','20372',
                          '56496','10084','43687','44065','42617',
                          '10157','30968','29110','68505','22374',
                          '68094','75911','74372','22287','87869',
                          '78069','71639','63486','16281','30750',
                          '66900','86278','29313','25306','95258',
                          '43833','57893','37976','20200','21296',
                          '88203','15060','68344','32723','95161',
                          '92982','33054','17022','94772','49568',
                          '56759','97728','24068','17678','72691',
                          '56827','43825','63600','81175','55845',
                          '38337','37771','73048','84128','59569',
                          '42061','65151','35209','22724','65234',
                          '59260','49437','75483','75965','89337',
                          '96137','52575','62632','96967','75628',
                          '96553','92668','96650','75137')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


