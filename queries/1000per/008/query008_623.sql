
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '81906','26447','39811','33814','52374','84120',
                          '86933','14450','26938','65605','95677',
                          '51338','54505','51322','36103','32260',
                          '14496','54156','40696','36294','72428',
                          '46604','13901','69321','61637','82572',
                          '11989','28107','34665','80964','67955',
                          '15667','80640','68342','12030','15094',
                          '48178','98884','94939','21316','46405',
                          '91112','21313','88335','87680','44544',
                          '88590','67703','68405','88303','38160',
                          '42712','17394','55585','14779','94419',
                          '46112','46335','94859','49987','75434',
                          '38435','11238','37597','77011','96408',
                          '60920','68598','53120','99738','37440',
                          '83395','14508','56708','73042','30715',
                          '53045','91374','92330','90385','18201',
                          '18546','52396','82626','86625','28994',
                          '30255','95714','99522','98589','83080',
                          '10074','54417','27529','72812','72753',
                          '37869','55933','43189','65874','27683',
                          '19048','27486','77027','13181','81039',
                          '19336','13404','75249','14663','10914',
                          '14475','81958','72261','81738','73511',
                          '93190','57259','52156','38395','86520',
                          '38725','23583','69090','55310','92650',
                          '37180','88770','47023','71454','63230',
                          '38423','44589','83422','81373','16788',
                          '49141','71369','52757','81157','24216',
                          '69402','69297','63563','88113','42897',
                          '87626','45272','22298','15236','10862',
                          '46856','78496','81847','10966','25441',
                          '92494','41613','88702','17051','25440',
                          '42374','42973','36067','27230','94782',
                          '72986','40514','81582','12164','27113',
                          '90399','84796','89354','72477','74782',
                          '26697','13457','73445','85599','63598',
                          '17706','17645','35206','81047','49581',
                          '55418','81383','27415','21489','99789',
                          '70870','56586','17485','93239','42319',
                          '94244','64974','61706','37317','48451',
                          '80734','13643','73095','36863','73732',
                          '84538','86617','23817','28701','48492',
                          '23648','96951','75856','12498','88501',
                          '79647','35558','84945','78134','53992',
                          '49737','97515','26739','17672','13711',
                          '86221','34137','95310','97345','17086',
                          '68735','45857','85858','52232','50396',
                          '69389','96589','33921','38416','88222',
                          '63070','70985','15640','45430','70040',
                          '29001','43512','93928','85354','44974',
                          '57182','68699','32680','74201','58155',
                          '37883','19863','48856','44030','79567',
                          '70524','37142','92920','26016','25568',
                          '95848','98356','72623','91208','51428',
                          '90714','67734','52933','24759','91598',
                          '71609','45746','12867','93599','22531',
                          '97520','29661','75831','81505','10570',
                          '69668','77483','79812','43609','60782',
                          '48820','86417','77240','93141','61899',
                          '84439','28434','35808','83433','73061',
                          '71846','49422','15520','79455','41846',
                          '23968','74539','35418','96329','29749',
                          '24676','36809','36138','56688','78488',
                          '50407','66980','89986','40893','90588',
                          '29062','40784','31480','16302','61099',
                          '92957','43087','72908','51163','38571',
                          '55665','75822','48953','71989','35020',
                          '39835','23949','92272','87535','72097',
                          '25301','44945','31037','82775','18444',
                          '57192','47721','95869','65950','65796',
                          '52966','14479','30460','23423','89746',
                          '57548','16040','35381','25376','42778',
                          '53880','28133','50501','23510','79145',
                          '19401','93712','29895','64948','33659',
                          '72769','33049','68002','63728','28504',
                          '40853','77754','82497','98462','90200',
                          '96046','61366','93066','35251','37563',
                          '90078','40247','18217','23418','21382',
                          '58039','19353','39125','45964','28640',
                          '66814','98009','27902','37402')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


