
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '34523','50311','56343','54466','45256','60022',
                          '77309','10255','98970','20868','42467',
                          '81721','43349','38143','33806','76020',
                          '41964','33390','53327','53125','34294',
                          '52509','90518','75796','41212','99494',
                          '97926','35808','48301','83713','99177',
                          '78686','54763','32780','64514','26590',
                          '59038','76587','70043','56465','17180',
                          '34884','19820','91002','94361','11787',
                          '28289','76300','63415','23275','15078',
                          '59848','61002','34538','42112','13800',
                          '71680','68370','18200','27609','28838',
                          '86690','26299','75754','31206','80799',
                          '16944','34735','85006','97652','49884',
                          '17491','63855','70996','70554','30656',
                          '61344','71721','99905','55060','27161',
                          '58270','45055','77905','29481','82909',
                          '44416','58472','56936','72819','38138',
                          '49042','36463','13001','33384','59737',
                          '28233','29302','89931','64216','48605',
                          '11699','23806','99133','82110','51881',
                          '80490','67899','59810','37895','17333',
                          '34778','15225','22855','10976','65617',
                          '46457','27435','18845','69581','77160',
                          '93772','60337','72142','72532','92346',
                          '49220','45332','44456','93464','81910',
                          '87193','65831','96269','41487','16278',
                          '15012','24537','43258','89121','33195',
                          '93511','68143','58969','91527','79113',
                          '55195','91696','72072','77948','96781',
                          '47010','44929','38591','67657','72490',
                          '17973','45163','38938','83668','40009',
                          '65678','97834','91174','75964','30392',
                          '46375','62237','81668','24458','20221',
                          '12570','64456','78743','35405','71343',
                          '37336','60263','65134','51633','96967',
                          '34960','85906','71188','27054','24425',
                          '17874','60719','19758','87088','25788',
                          '62320','16043','41297','35871','80750',
                          '14388','91706','73061','14940','70350',
                          '84083','97044','24544','20533','22071',
                          '26557','75541','35690','77436','36687',
                          '36254','72087','18487','60573','36022',
                          '87901','51392','94096','48713','63576',
                          '35290','53559','93833','24081','93405',
                          '90500','88864','73697','54442','62771',
                          '98852','86259','62376','72912','59408',
                          '25904','69837','53745','36302','42790',
                          '36699','93254','59228','97295','98905',
                          '89305','54681','38910','72350','45238',
                          '11383','95310','64552','62156','27703',
                          '65594','15358','91978','65799','59534',
                          '22231','27411','53774','81775','15970',
                          '65256','70041','58649','82310','16891',
                          '71699','79803','23326','42248','66313',
                          '48353','15559','38967','14414','65243',
                          '58847','27888','68808','12000','72574',
                          '85156','81620','33506','91023','88023',
                          '46019','34792','62577','33274','94501',
                          '59872','59777','77887','63029','96836',
                          '35776','45846','36422','35989','21056',
                          '99928','35563','16103','78088','80762',
                          '15226','35740','42409','25424','47135',
                          '75228','24606','60864','99714','66918',
                          '43910','74618','22089','97518','72114',
                          '53269','34154','38351','66365','88312',
                          '86044','52237','98252','64367','55872',
                          '95116','71428','16763','30652','68111',
                          '30188','23870','44198','56415','23944',
                          '29934','97632','31093','79028','55078',
                          '22854','95978','80454','19543','83528',
                          '10694','34855','79486','91026','25634',
                          '23472','56077','10890','50364','79522',
                          '50051','25443','87344','78688','99654',
                          '67911','86996','68496','64236','26553',
                          '84049','39604','42116','54128','68298',
                          '44862','23410','38699','18644','52609',
                          '24924','37903','55894','35307','36373',
                          '79990','69924','62301','55801','98785',
                          '77792','71123','32675','62481')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


