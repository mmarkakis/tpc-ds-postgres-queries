
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '78466','50299','55422','20365','88633','48412',
                          '29034','83455','68943','77249','13414',
                          '47230','45608','96860','84907','46997',
                          '96435','11918','75400','72736','45016',
                          '53738','36521','42482','48870','68372',
                          '20702','90799','64246','16480','72670',
                          '78599','22389','37864','76115','42680',
                          '49329','23558','45460','81701','87480',
                          '72604','18611','67503','43919','19235',
                          '33304','95312','59884','49725','88584',
                          '69113','99525','40392','96718','88845',
                          '37307','82273','54929','82599','71875',
                          '41880','20281','12108','10182','64546',
                          '52858','18355','18717','11572','26380',
                          '72695','40670','62903','94198','38785',
                          '32330','93836','45143','46130','20139',
                          '69081','79998','16509','38720','77762',
                          '45749','62877','53983','81913','53038',
                          '71068','33005','93718','93671','70866',
                          '24483','26035','51616','23227','58592',
                          '52762','34790','53388','47572','34565',
                          '92844','38958','88015','76342','83747',
                          '66316','38218','14770','95470','20834',
                          '64491','64509','40265','71817','42386',
                          '49422','24705','46781','49394','94900',
                          '17371','85995','67881','78020','22019',
                          '61047','67417','33922','14887','75827',
                          '65207','83656','79407','51047','23258',
                          '44484','57078','20769','48635','84305',
                          '16879','99499','16707','30957','99455',
                          '74050','22350','59635','67124','15971',
                          '56949','61371','85705','87100','24491',
                          '27546','38177','20155','87820','66325',
                          '97058','69705','57446','77416','12909',
                          '18067','51858','89820','43930','83785',
                          '17286','76929','76991','36128','57798',
                          '29268','98507','49447','28447','15411',
                          '49181','81850','67315','72853','96997',
                          '86716','97038','88094','23976','95737',
                          '71106','35762','96463','84241','26817',
                          '98660','53851','38740','79544','42977',
                          '38754','53666','99324','90993','39087',
                          '48850','91619','79434','15799','19118',
                          '73266','43667','21232','44105','78623',
                          '79452','20672','98852','16211','22873',
                          '12887','73123','83357','77181','10438',
                          '52827','40422','33929','35213','89473',
                          '15629','78838','28104','18608','50204',
                          '65828','40443','33032','31232','74704',
                          '59244','89084','59964','34326','66791',
                          '32046','13255','58230','86235','95696',
                          '61231','52658','14865','62618','24335',
                          '78587','62795','30727','21320','78042',
                          '42751','69624','14595','42278','90250',
                          '37199','24850','39690','38878','49250',
                          '21712','79877','47997','28520','56152',
                          '61520','79993','55472','72348','73859',
                          '77104','28711','77955','20753','85219',
                          '26587','29490','90490','70231','73271',
                          '12197','68132','57123','88792','21050',
                          '15456','46673','44227','91794','72917',
                          '38020','16827','63942','31544','96404',
                          '43221','85685','60186','68509','78456',
                          '25680','92736','83765','47576','64965',
                          '56755','97969','80304','16953','17934',
                          '65897','69512','12361','12624','36098',
                          '46252','59072','91238','83595','89613',
                          '55321','40732','41645','85819','72297',
                          '65675','45280','78652','95474','40596',
                          '97130','19128','74127','44400','76085',
                          '31480','52838','21032','38035','88233',
                          '24410','19397','29485','38457','91738',
                          '18794','33176','68717','27189','23186',
                          '28767','38106','95214','93893','36448',
                          '72979','68473','41923','87952','88449',
                          '47727','23789','70871','78553','53975',
                          '55547','52141','12276','24688','99819',
                          '97481','32900','78401','53375','33716',
                          '43977','14043','41679','62613','77098',
                          '43621','96109','38108','16792')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


