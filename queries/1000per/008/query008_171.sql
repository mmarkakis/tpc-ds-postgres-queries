
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '63317','69909','87931','67036','33870','80886',
                          '64434','80924','29237','67559','95214',
                          '93604','15813','92475','91546','71687',
                          '78630','58419','66037','24788','34538',
                          '34982','87249','25890','21005','35854',
                          '71625','93867','18139','98031','43657',
                          '20492','18499','93435','15839','61928',
                          '42540','52828','37325','61471','97896',
                          '24671','44278','69868','76695','58238',
                          '98725','68009','46994','99752','39028',
                          '26361','39934','64184','76693','75531',
                          '10234','99235','63012','59473','25240',
                          '94759','15467','74506','96064','14483',
                          '10701','26932','82649','88583','96451',
                          '61931','43348','91670','72811','70154',
                          '39423','82626','78905','49407','64300',
                          '48472','40104','19358','73086','88821',
                          '68810','39504','63621','60222','67327',
                          '89926','57639','74204','55675','40109',
                          '62529','22994','39567','48248','25079',
                          '47242','70810','33030','72910','45948',
                          '66422','72522','88682','36699','69979',
                          '79228','57519','92438','33696','21962',
                          '47084','40058','31549','10952','67008',
                          '55701','49271','46250','95215','25854',
                          '94708','15188','67621','62543','26804',
                          '78578','71841','79820','72797','26358',
                          '79345','67268','48508','69082','82378',
                          '71346','86181','72686','23952','76598',
                          '86647','86434','96899','94744','13942',
                          '25703','59386','38481','53329','64106',
                          '30368','65981','66425','12366','99241',
                          '25610','26403','62707','94679','25896',
                          '29916','17102','52045','40418','14647',
                          '22268','41028','39633','52683','97045',
                          '66179','87985','19765','96465','74047',
                          '77176','16477','74956','48699','78914',
                          '16537','87257','91757','30386','49101',
                          '41684','66060','92125','21100','53530',
                          '55786','13527','25026','65666','90961',
                          '93458','71109','72298','66089','54578',
                          '62306','84382','36968','91936','22775',
                          '92272','25126','39712','66783','93767',
                          '75355','33847','83809','35868','33290',
                          '15202','89234','93860','51406','33229',
                          '14443','88424','78500','74947','14236',
                          '80529','21240','77560','53921','94203',
                          '14364','87201','50403','11213','80372',
                          '70243','92016','14936','40599','20991',
                          '39734','67914','48848','56522','16213',
                          '37218','47639','58152','50447','79981',
                          '84532','45518','46101','84588','33719',
                          '97602','41376','91829','98132','27096',
                          '33531','22154','75790','56427','31443',
                          '62203','42199','73556','86843','32637',
                          '29998','67811','15048','53566','54635',
                          '11619','67342','32884','95085','43672',
                          '91709','56264','11890','99911','64220',
                          '21893','22379','21327','39798','71906',
                          '75729','29068','91978','29084','52783',
                          '19668','65232','43953','49759','56513',
                          '17345','90236','11036','85261','64050',
                          '82714','96680','49829','99395','46832',
                          '28775','52738','89469','32344','80542',
                          '95118','97391','22619','32128','90692',
                          '56979','32948','58919','40753','25978',
                          '47969','10738','95076','64015','25241',
                          '22298','21544','89550','24974','18835',
                          '80468','92543','81216','97228','90391',
                          '86421','33401','66826','87685','39757',
                          '82664','66712','50798','18906','38665',
                          '58665','28736','46396','39770','53188',
                          '36589','19439','72420','92996','94530',
                          '19065','88054','34798','30069','98213',
                          '44586','26485','12314','57928','80126',
                          '90607','26076','29529','16924','69499',
                          '98113','86734','58203','57706','23771',
                          '28369','44666','70418','80119','24858',
                          '96753','22272','11831','57187','36073',
                          '68042','14768','64928','66078')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


