
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '12555','36410','18890','42486','21963','59531',
                          '14393','87285','17227','24406','93867',
                          '22804','35912','85396','21830','97974',
                          '33112','37616','51773','48937','15833',
                          '22186','23894','95728','65421','29604',
                          '56917','23099','62994','25497','92315',
                          '56980','90413','16298','81969','71218',
                          '27611','55132','90821','78623','41645',
                          '96940','64584','93450','31494','22083',
                          '53473','24953','61778','58338','84128',
                          '48759','17642','76596','62592','59845',
                          '32811','83451','50631','60985','53520',
                          '61588','43384','33277','42764','24262',
                          '17155','55553','40613','74015','61007',
                          '27021','41230','82367','88629','15571',
                          '72156','70996','36875','24172','58502',
                          '30416','94534','15852','64756','12562',
                          '37400','77694','36895','20990','62336',
                          '56356','29053','80428','73078','98444',
                          '62636','76752','65024','68340','95496',
                          '57880','94500','35225','54256','81889',
                          '42032','43682','72668','67391','97727',
                          '20890','38297','43669','63744','89202',
                          '65294','32828','89624','14835','40615',
                          '15656','66968','78128','26190','16904',
                          '37860','96786','82435','91312','32423',
                          '87789','19725','81973','55638','62827',
                          '76388','46592','65019','83148','99408',
                          '42168','11630','11511','60830','94919',
                          '70812','39782','36527','84158','54510',
                          '37514','87620','12247','74236','79022',
                          '80153','34452','23749','66355','33093',
                          '12328','90272','21235','67610','68473',
                          '81762','50192','21586','34115','99321',
                          '51233','87224','71973','94912','30895',
                          '34787','21546','16611','45424','79950',
                          '99187','12560','19319','37265','74348',
                          '57613','67113','45140','88026','33099',
                          '23829','18916','62816','32145','44515',
                          '59023','74804','72070','60720','98065',
                          '37525','52764','65471','38955','86281',
                          '39912','51420','97876','68164','35282',
                          '23323','90384','33772','53043','92408',
                          '95920','50704','14709','85874','96778',
                          '31732','64947','82906','99499','68975',
                          '12332','73514','25546','17450','14230',
                          '82741','89344','96613','22106','22184',
                          '91609','61268','27535','23867','72432',
                          '31672','75579','59072','47585','72060',
                          '90322','59833','34890','12534','13994',
                          '12072','39504','31881','73922','47177',
                          '54333','26348','57476','53993','47109',
                          '33359','83575','87695','70637','83853',
                          '15042','84332','24073','66119','91359',
                          '26151','54152','94584','61895','22956',
                          '51605','10239','81743','19239','97205',
                          '87756','50287','93092','78153','32231',
                          '55735','45723','31506','67640','23199',
                          '53607','61656','32687','17991','86368',
                          '59946','43217','89953','69415','89376',
                          '55542','47782','89933','30470','30534',
                          '92963','11453','42887','93101','30337',
                          '52648','32540','27140','99920','62632',
                          '29188','97311','99284','54449','82477',
                          '93979','18758','81731','10498','80012',
                          '74340','33740','30091','44205','79189',
                          '33634','63222','64991','83977','65906',
                          '82137','64058','35963','92700','38381',
                          '28312','38741','76939','96270','25196',
                          '14984','20485','88593','81388','37798',
                          '85882','62359','54418','84092','90383',
                          '26289','54963','60514','48146','23551',
                          '88129','95578','47014','40152','61973',
                          '41856','73844','96705','66545','93270',
                          '55549','35513','80042','69876','97105',
                          '80233','70529','17543','97610','63538',
                          '91820','49137','58305','50392','79507',
                          '16615','80609','43148','85240','38632',
                          '73068','40293','11687','36273','71298',
                          '36928','60347','72248','42711')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


