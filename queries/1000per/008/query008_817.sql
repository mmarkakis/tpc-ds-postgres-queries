
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '39554','52087','60957','57672','47327','54200',
                          '55600','80372','57239','10891','93214',
                          '71450','75796','51701','79268','94056',
                          '32651','97826','43331','81575','68085',
                          '56075','88435','64590','95917','40207',
                          '21290','86009','57154','69366','72185',
                          '38836','46445','36082','56687','73357',
                          '58934','96513','62551','66770','72964',
                          '66262','86528','94835','99179','57369',
                          '26919','57596','79541','63733','24034',
                          '39054','91093','96192','75692','74971',
                          '59607','87711','89853','90066','15020',
                          '23236','52623','66938','99218','59594',
                          '52831','35813','48523','93466','19412',
                          '39343','44619','59723','24506','38148',
                          '38415','16427','20685','65470','11113',
                          '36109','81372','61960','58051','21329',
                          '58796','46308','64372','88946','39247',
                          '23614','39449','85278','11326','52667',
                          '88756','68601','20912','90537','97378',
                          '90764','84037','10403','20607','44012',
                          '30671','27499','41398','11121','21144',
                          '13579','74135','37077','53787','43856',
                          '78126','66612','90381','72762','48413',
                          '75663','50979','81178','99500','67021',
                          '78670','19163','34046','66699','78912',
                          '68420','49008','58677','62710','70076',
                          '39509','75706','23798','43614','72372',
                          '91544','49995','45338','43442','32245',
                          '34366','48743','62582','79576','15695',
                          '54970','62980','65260','87601','15818',
                          '17388','77577','61373','38070','71686',
                          '27281','56861','43524','27577','60492',
                          '32271','19595','67083','59734','77946',
                          '63843','45371','39827','16109','89784',
                          '76444','55510','62282','84786','79005',
                          '34942','86604','44513','93439','64431',
                          '48910','94973','61674','97579','21212',
                          '25477','60844','45517','72424','49273',
                          '69196','32958','74591','35150','35056',
                          '33767','92901','67651','35637','42827',
                          '79404','78630','76696','86754','74144',
                          '26439','55159','13390','14924','64189',
                          '31987','64036','42896','42389','89613',
                          '11404','43876','79334','87544','80511',
                          '69298','53026','45002','79090','76708',
                          '81814','79890','25136','37773','23839',
                          '50342','72214','89311','19338','61636',
                          '72927','87256','96055','23965','60240',
                          '32269','20622','71305','74043','81354',
                          '47621','74940','68664','86897','95250',
                          '62358','27685','58390','38517','76013',
                          '48232','21374','98816','61296','35746',
                          '16638','74764','48285','95471','27546',
                          '66163','71133','45803','53413','97397',
                          '44866','33324','36442','30117','92966',
                          '52426','83272','86040','78737','60219',
                          '14174','84046','13193','93143','56410',
                          '61292','58359','20549','56011','98327',
                          '17929','54436','53597','77335','92027',
                          '88092','97058','87014','15266','43051',
                          '99785','36207','66581','45411','19812',
                          '61122','25245','85835','53522','78440',
                          '88155','50368','77270','42963','94346',
                          '64724','84357','58456','59183','36215',
                          '54302','28119','79303','56998','46199',
                          '21986','15826','78509','29735','87098',
                          '48793','98465','64240','20442','50129',
                          '90548','29143','41206','74209','55221',
                          '60031','70568','80888','71494','52079',
                          '49083','55231','92387','68967','38537',
                          '91206','39558','79517','91948','73385',
                          '45270','95374','65997','11828','20426',
                          '20659','20303','36360','16614','16070',
                          '78797','13265','81019','64607','86486',
                          '98504','70440','93994','42602','39626',
                          '53938','41726','31617','55656','28342',
                          '22347','96124','60288','47145','18975',
                          '96013','65239','71911','86738','93491',
                          '10811','94409','46512','53659')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


