
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '79145','52228','47944','63864','53023','88358',
                          '94637','82965','75702','34601','85116',
                          '77987','88686','51725','47298','73009',
                          '24833','38843','91188','52734','39392',
                          '60838','42365','73081','44697','23324',
                          '54533','29149','42435','84600','97166',
                          '95768','64001','15662','19289','33489',
                          '71528','88198','59718','60805','25397',
                          '65546','84676','77458','62510','37111',
                          '81578','17751','51380','96086','87401',
                          '94991','70950','85812','64774','71738',
                          '62646','75789','96129','96306','43915',
                          '10749','25046','73093','91800','33038',
                          '42078','31561','20533','11107','83151',
                          '48263','30423','24882','57765','44438',
                          '15213','67322','39011','17859','11559',
                          '24350','23174','44465','60999','43638',
                          '76500','22813','22670','25169','29743',
                          '22371','30704','22297','20216','89753',
                          '38935','57620','49293','91383','73241',
                          '35619','51058','18696','69629','91804',
                          '92355','42478','33189','51213','56611',
                          '20702','82355','95351','77483','56033',
                          '99749','68056','45459','11709','84171',
                          '45045','57092','33545','55018','44955',
                          '69111','81703','87340','18420','16033',
                          '62097','13733','96995','86732','16169',
                          '83809','33587','30718','27095','48612',
                          '35807','40658','65188','99662','49297',
                          '90885','38345','88217','74650','71750',
                          '18216','79572','42099','16142','84202',
                          '42824','40165','86086','85322','73460',
                          '71935','44212','52461','48768','20838',
                          '17370','14996','76791','74106','47572',
                          '38762','53034','47642','81941','43319',
                          '41763','97743','95925','63810','55841',
                          '66005','50789','32124','30854','84257',
                          '48291','95651','84521','29308','66596',
                          '88824','64963','93074','14955','48902',
                          '26060','53227','98737','96553','15154',
                          '29442','88904','94068','91948','55505',
                          '92810','11913','45551','32934','18330',
                          '48489','62824','87685','79495','27610',
                          '77053','40938','45546','37422','13320',
                          '48217','86551','42406','36402','88949',
                          '10356','32971','49325','97173','48159',
                          '13486','16006','11375','57842','50907',
                          '24130','94807','25563','15288','64370',
                          '16012','76203','86685','85026','74945',
                          '29592','19860','22656','80813','36628',
                          '13954','26664','67813','52863','95659',
                          '46904','81848','77573','86451','64452',
                          '56372','36949','27417','78765','75078',
                          '72992','83446','69716','15536','61220',
                          '50195','59242','21760','62470','73036',
                          '24906','24295','66845','21685','20163',
                          '60543','33838','45918','13379','26950',
                          '59954','68466','64757','18434','60733',
                          '80755','99578','37362','72972','64430',
                          '39523','41341','18589','61733','85980',
                          '80772','80447','39722','32060','12534',
                          '97697','57832','78293','73673','89844',
                          '45711','88348','70336','31838','97884',
                          '89255','62212','34208','77387','60600',
                          '29406','67734','15307','49091','74406',
                          '50823','31194','52263','50709','51998',
                          '82075','74230','18646','63880','36542',
                          '68377','92624','64904','21856','53264',
                          '94690','73384','81518','61535','77562',
                          '50995','93408','55929','57745','20144',
                          '68891','20541','39035','27721','12307',
                          '70949','24590','87861','66938','82958',
                          '78823','70110','50992','23934','47518',
                          '38789','74080','86041','20858','29203',
                          '83932','87080','84731','56510','69279',
                          '89989','56860','94346','60185','44037',
                          '68027','67999','31226','30986','97050',
                          '95310','18274','74674','38145','57132',
                          '23167','59654','53249','14279','28454',
                          '52894','62658','85925','26872')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


