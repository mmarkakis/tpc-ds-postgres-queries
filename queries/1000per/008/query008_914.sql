
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '65670','98310','37837','46101','75598','33893',
                          '67942','67694','56720','78614','88849',
                          '75866','90975','94819','16465','11180',
                          '14575','74070','50562','20367','67503',
                          '81703','30239','96059','13005','28590',
                          '96362','27791','62795','73773','60405',
                          '43320','31279','74668','81208','14200',
                          '28269','30874','81847','10249','35904',
                          '73115','98506','72057','27332','10380',
                          '82868','43027','53271','79562','37683',
                          '53499','59133','97129','31545','48714',
                          '16018','48339','12252','42944','38793',
                          '40149','40576','28461','28674','61397',
                          '55018','87343','11938','34131','54727',
                          '82948','83045','88978','41623','61222',
                          '36771','70873','38897','92713','39992',
                          '46618','73235','99601','99515','83898',
                          '72224','54399','44032','25604','77467',
                          '50110','90070','24730','96087','80235',
                          '82935','17291','51749','39555','93245',
                          '62984','76480','20702','88234','35122',
                          '37685','89879','58595','12297','42589',
                          '97923','11359','63484','62253','66371',
                          '73094','84943','53571','97642','61813',
                          '83896','40109','84846','37170','47458',
                          '23907','84507','56206','95651','32308',
                          '60096','43291','85079','40259','35443',
                          '12055','33412','40895','61902','53370',
                          '77226','13595','93489','91211','43208',
                          '67354','86178','94686','98893','75608',
                          '73704','83494','12086','36974','72163',
                          '95967','86183','85530','76661','27034',
                          '93677','20113','73255','18125','87034',
                          '43447','12559','18546','23955','80789',
                          '86941','28651','41526','70647','60120',
                          '25099','34990','30126','87379','96769',
                          '33828','72728','81667','50569','12080',
                          '97903','10046','26075','96045','12145',
                          '64878','16772','28812','22046','91541',
                          '66702','76528','76995','79729','82004',
                          '12361','35402','89352','42322','90787',
                          '76943','60723','44593','81429','72611',
                          '49625','39997','46927','57766','27723',
                          '92320','10275','31862','94350','46750',
                          '99343','15829','38986','72239','22509',
                          '55861','52202','27032','37335','82614',
                          '37389','80480','89385','89178','61604',
                          '54574','19078','38931','33829','54751',
                          '68988','80477','89803','14025','25905',
                          '37362','59349','33926','84241','86644',
                          '99665','29011','46083','62797','80761',
                          '92780','97592','30983','56709','83943',
                          '80759','70872','21981','43523','68369',
                          '13605','70464','35146','61783','94098',
                          '92864','13566','14423','97679','56059',
                          '67441','35524','58291','38127','80275',
                          '33599','60361','56430','57313','83608',
                          '14967','19718','98756','94821','30161',
                          '44677','78238','89586','16115','41089',
                          '14579','51776','19328','29841','80701',
                          '60982','51101','21071','38799','86271',
                          '79924','33107','88155','37534','40022',
                          '74286','13913','31045','50934','19177',
                          '17718','65752','68982','47472','24958',
                          '18782','27698','28860','74854','36095',
                          '29280','34654','13302','21601','86389',
                          '94917','96994','79771','25243','23941',
                          '56402','61079','52825','97332','69657',
                          '42090','26073','87400','53151','25824',
                          '96030','72894','81162','42098','49036',
                          '62380','59406','12102','76213','24071',
                          '15760','51722','42850','30749','17729',
                          '45636','84398','46658','17534','44431',
                          '19720','90755','61677','49025','56512',
                          '65935','55358','44377','30282','96075',
                          '13629','58206','56797','84659','17376',
                          '57107','93101','85979','91222','27226',
                          '32106','62651','67920','85360','87051',
                          '47437','72373','43276','80935','49944',
                          '75824','48099','71155','29833')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


