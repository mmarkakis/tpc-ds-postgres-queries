
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '62279','84495','47922','90538','32151','89545',
                          '57593','43372','13001','87092','92561',
                          '19414','75349','89374','14757','60093',
                          '51174','59993','40758','68489','66398',
                          '45275','85424','75810','81042','91258',
                          '62686','25639','77159','58743','84517',
                          '41847','26359','41583','73997','37911',
                          '54989','21724','94067','80335','51584',
                          '89642','36132','35188','54323','39902',
                          '14551','68645','61226','91329','54428',
                          '19131','67313','81339','87962','77485',
                          '85169','44312','85748','51863','89649',
                          '75094','72447','62019','82654','43623',
                          '60098','64289','23302','82230','78483',
                          '10375','79877','37457','40205','46667',
                          '10548','58371','53897','98631','79004',
                          '81793','36821','44684','50701','34298',
                          '16187','18172','54172','29776','88183',
                          '50733','61572','89429','14212','19938',
                          '71163','36794','50854','96010','17456',
                          '46299','37459','59468','19452','94905',
                          '64387','33293','49422','48930','86239',
                          '47213','73311','44100','27414','15591',
                          '19262','86036','83118','76362','22241',
                          '83849','89034','45356','88442','47055',
                          '23821','84364','57418','62457','93792',
                          '69829','25466','94947','80258','22643',
                          '28443','57876','91377','84228','64744',
                          '54241','90275','26340','52191','59358',
                          '75714','75122','92175','20152','82538',
                          '22221','40864','57833','72042','72307',
                          '43551','23911','92791','73510','84605',
                          '53923','44044','25610','27532','84518',
                          '23157','49180','79588','58751','60791',
                          '40242','58762','91740','34846','51867',
                          '65962','32281','32548','53332','22484',
                          '55592','69105','69522','98292','68770',
                          '31429','91119','58588','33263','68498',
                          '34534','15494','37734','63750','77014',
                          '55851','20155','30012','60031','16346',
                          '75528','43914','31807','10837','98356',
                          '17180','12523','36571','12781','49043',
                          '83220','47482','87313','81697','88469',
                          '84491','98916','52402','25482','94727',
                          '11322','12816','61396','92571','69265',
                          '94674','59991','14518','64003','92215',
                          '88584','52717','64212','25685','39147',
                          '51536','73430','57927','21752','22652',
                          '50119','25179','72068','72361','92569',
                          '77621','72935','88398','51221','77568',
                          '77304','53828','95014','16847','69405',
                          '25755','34501','69754','74203','80036',
                          '79266','27091','73786','90988','44705',
                          '21970','51596','65546','68419','75631',
                          '72732','51461','15780','40193','33154',
                          '71641','22818','75364','18768','42434',
                          '53877','10453','77518','90364','93876',
                          '98155','37654','34882','66968','77682',
                          '94419','60004','53519','37208','77889',
                          '45674','56487','94768','18333','52872',
                          '89449','55988','15618','18329','71270',
                          '74184','61266','19542','24181','37622',
                          '93401','79162','92745','41987','99950',
                          '24900','12958','16529','22886','28926',
                          '33064','35230','26827','37902','63774',
                          '38587','65505','11971','98787','95283',
                          '12168','75207','57193','41963','78003',
                          '21701','10141','50036','51572','43678',
                          '94522','90222','57486','47779','18704',
                          '33688','33170','21793','26707','32737',
                          '18395','66055','95313','39937','72305',
                          '46673','94434','79792','63782','99110',
                          '71575','70944','38094','72827','13025',
                          '39431','68372','67451','93708','34470',
                          '59616','42681','10648','85504','71313',
                          '51751','44982','81595','36614','45864',
                          '61822','18948','70219','88658','45172',
                          '35052','34368','16868','72492','69062',
                          '60511','61316','49303','25012','74894',
                          '59902','37984','22285','81394')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


