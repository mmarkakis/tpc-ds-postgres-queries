
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '12261','78015','81305','93815','10903','97559',
                          '22507','67883','43087','23546','73748',
                          '60703','94743','40547','35999','29859',
                          '61099','12305','62506','53877','29521',
                          '23687','55059','94423','36691','78958',
                          '25277','21966','85726','90431','71725',
                          '83804','25605','47552','24961','49596',
                          '90790','57775','60038','57586','23594',
                          '93943','65085','21963','35904','88488',
                          '48756','69129','78291','39691','42854',
                          '29661','38189','41503','92169','39716',
                          '71951','90359','25358','40909','93789',
                          '25167','24263','92008','38497','50501',
                          '65416','69157','49747','30848','53020',
                          '76476','86352','37029','62677','99656',
                          '68082','99765','43508','49243','57617',
                          '23362','43609','41619','88810','82381',
                          '98919','73433','15347','56238','81660',
                          '49860','98697','19129','89691','72272',
                          '34466','27677','18147','99320','21421',
                          '71467','11208','54521','24667','36484',
                          '88831','56537','93246','62690','93942',
                          '69579','85157','24392','89975','40077',
                          '88398','98376','37363','66988','92362',
                          '66432','77821','69755','79775','65640',
                          '12338','52626','87722','66806','13426',
                          '90957','60085','20562','58635','67267',
                          '89803','53604','32387','43942','84514',
                          '86481','44361','15888','79077','28320',
                          '84856','45434','30895','48476','17299',
                          '92837','60133','48452','87871','79358',
                          '46448','93851','98508','80766','63823',
                          '33794','85196','68735','23596','11202',
                          '88066','85231','48213','49174','62929',
                          '10165','27382','53484','16561','35699',
                          '18812','54247','89168','38276','14990',
                          '86342','15632','82177','66363','17792',
                          '76931','11966','82982','80927','72250',
                          '39428','11894','16638','28543','63198',
                          '26839','21952','43495','53119','46154',
                          '82095','19072','15016','14164','18392',
                          '47040','56626','23552','91574','11637',
                          '69241','78423','88665','33539','85829',
                          '11141','10027','31212','10820','83192',
                          '89516','42026','13180','61032','75057',
                          '83812','95295','79709','20396','75929',
                          '77221','60966','37377','14074','93966',
                          '21145','26296','21465','22198','87388',
                          '57635','82635','30168','78577','32204',
                          '72752','10069','86218','46973','86987',
                          '57577','12582','59233','37266','26390',
                          '81798','23229','68901','21616','79534',
                          '47573','66997','70984','31380','77331',
                          '65568','48238','30240','85375','96443',
                          '97426','34017','21770','74355','40102',
                          '77350','75543','40225','53639','65877',
                          '76865','85049','81532','54057','83710',
                          '57156','37114','96651','93696','99846',
                          '90151','89859','21299','68054','78854',
                          '78356','57216','32343','14683','93876',
                          '75008','38511','31567','98216','50345',
                          '49956','50507','80271','45716','52894',
                          '22527','27724','54751','87752','95197',
                          '78673','53233','11269','18260','64832',
                          '27613','66024','96566','21687','29265',
                          '26252','92636','86267','55581','77033',
                          '50932','37727','11136','64123','35832',
                          '40387','41642','17140','71261','89790',
                          '61367','57962','13435','78132','65673',
                          '97936','28597','61316','42604','51017',
                          '86905','62422','15017','76706','93602',
                          '65346','27087','93377','68736','67773',
                          '45351','66564','36610','57676','65405',
                          '90049','85328','60410','50635','84200',
                          '77557','91709','62150','87873','98037',
                          '23969','67332','21911','51400','60816',
                          '22333','56043','56357','45064','31156',
                          '10303','94722','93152','58132','29256',
                          '21611','33013','41317','94578','10644',
                          '37062','18699','70652','87703')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


