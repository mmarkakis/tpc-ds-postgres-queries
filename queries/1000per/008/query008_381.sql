
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '11156','21773','72437','18728','15345','73492',
                          '24349','93309','67359','18145','77047',
                          '79861','29426','75611','36308','41539',
                          '87579','71732','87510','36432','25168',
                          '19339','40677','36206','41278','90703',
                          '71205','77555','94432','89155','59722',
                          '38877','52341','66854','57819','47185',
                          '96165','13082','55585','97013','60436',
                          '32714','91541','13638','12478','92707',
                          '31824','31461','32300','87157','68685',
                          '29321','76971','39615','19126','42699',
                          '99691','53425','69536','45237','71055',
                          '76830','55492','15896','91966','69000',
                          '45781','44756','56611','62036','67983',
                          '12592','88872','80865','15510','19360',
                          '78246','89627','35317','85702','52221',
                          '74153','91553','82001','85200','51225',
                          '33284','95734','33189','74432','74681',
                          '10314','21231','61920','44016','96179',
                          '67163','11124','28729','26451','44045',
                          '24432','15367','83427','60439','30679',
                          '71161','43736','89124','68257','28602',
                          '69317','78717','32597','56484','92925',
                          '18911','17803','47473','38351','97559',
                          '44261','16531','34261','34379','23312',
                          '49431','14706','36012','39091','88830',
                          '87905','92838','54885','90415','90184',
                          '54560','77468','49958','39436','79506',
                          '71609','99534','99670','81612','45275',
                          '52323','98012','53866','96742','65193',
                          '66378','29207','56871','41344','56219',
                          '35516','31936','63368','43670','92498',
                          '16840','66959','90809','46600','61041',
                          '63223','85691','83773','16175','19408',
                          '94499','88075','54448','93379','21523',
                          '35020','34874','87649','91496','20934',
                          '56747','13172','20150','51695','46127',
                          '60646','54880','35083','34417','77055',
                          '21823','80565','93932','60550','59215',
                          '70083','45504','73698','21583','69255',
                          '19409','71151','38507','11781','94834',
                          '57126','34145','22910','81288','38772',
                          '28092','57091','16136','33113','55486',
                          '71048','39024','28442','54694','19471',
                          '78045','95419','60457','45598','56266',
                          '81032','96166','95600','21392','41644',
                          '61286','34562','30645','26178','18069',
                          '84065','86146','71844','23299','43369',
                          '54269','66650','95405','56468','80758',
                          '24201','29843','84532','92341','60630',
                          '36202','37253','37017','90768','11208',
                          '15371','11876','38140','61064','26346',
                          '66658','90543','54378','95449','92654',
                          '72283','58755','87283','83894','82032',
                          '60549','87765','97214','19313','66851',
                          '45789','93438','15969','18951','43198',
                          '17408','45985','15449','44720','66230',
                          '25598','63422','85205','15191','51317',
                          '74309','26994','60086','88958','11786',
                          '94315','95601','78597','53460','90588',
                          '88319','14008','64121','14618','45093',
                          '51461','58391','49035','60035','96421',
                          '19803','81893','98661','47200','40799',
                          '98686','92745','95378','55639','35171',
                          '85429','66772','92713','23770','78624',
                          '97244','58946','42794','87833','55540',
                          '72742','31870','69977','56394','64991',
                          '20907','59418','93536','38574','98828',
                          '50336','58275','68276','30022','36579',
                          '26182','10063','99965','10513','80755',
                          '20147','87383','15415','62556','57890',
                          '90249','24624','98302','98947','54690',
                          '88743','10937','43105','11969','35828',
                          '62985','72772','15754','92801','81924',
                          '94798','62123','18875','19519','13388',
                          '87960','63374','22818','28419','13759',
                          '15426','94383','81962','56123','54162',
                          '88331','91818','87934','38259','43820',
                          '53534','11080','66840','42307','36082',
                          '15440','74878','10189','62926')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


