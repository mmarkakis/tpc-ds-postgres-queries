
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '48096','91155','12913','41399','20525','71424',
                          '32815','43667','41331','27925','24028',
                          '61727','53962','91567','67693','37098',
                          '16753','85534','19061','21934','84692',
                          '33870','44393','96782','36534','13766',
                          '88872','74389','31196','40690','84615',
                          '18174','33386','66178','41200','16789',
                          '66090','72972','19423','96921','45679',
                          '70007','53790','69008','64734','49312',
                          '67285','62889','39426','21584','17152',
                          '27636','11666','21511','22108','47349',
                          '94444','11590','74567','29043','24991',
                          '57931','41091','18553','70587','79532',
                          '56021','30990','48596','44268','20594',
                          '71977','66520','97613','81903','91101',
                          '90977','66685','97754','46174','29136',
                          '76997','19973','62279','43433','74690',
                          '89649','85290','98597','12313','76213',
                          '71288','21267','66281','30909','90766',
                          '92559','79732','51568','62195','29416',
                          '71039','71226','76251','91875','84385',
                          '29056','47180','15441','17459','42034',
                          '15913','51381','95132','52737','40234',
                          '90622','93953','21614','51236','13252',
                          '66574','53770','21007','78395','72554',
                          '81935','35758','57766','10216','64241',
                          '51329','79633','60952','89970','63096',
                          '90573','51508','86000','26952','77110',
                          '64924','10763','27098','75449','89374',
                          '82220','39595','63262','98952','13821',
                          '67600','48933','49314','62178','45735',
                          '81410','31562','44807','40727','90692',
                          '90265','70831','28453','95697','85356',
                          '21288','80031','49354','38270','27929',
                          '41340','75613','87413','77965','77855',
                          '69233','91608','76887','93923','56544',
                          '67094','33488','61383','20027','21094',
                          '94972','48071','14473','70597','59476',
                          '13110','49418','57527','45113','15359',
                          '48587','50099','98312','58975','69745',
                          '75943','82382','76692','50549','86339',
                          '66394','52400','78961','63254','33004',
                          '66348','84686','97773','26950','62346',
                          '62746','88986','35740','41564','55087',
                          '93455','67960','53351','13503','58686',
                          '28077','82004','81245','85722','90575',
                          '10823','83741','24067','99152','35078',
                          '56292','47871','65319','12085','77416',
                          '14023','55915','88925','50744','62171',
                          '81497','82187','81556','51239','42395',
                          '11537','78072','81927','25304','73064',
                          '83571','63805','98808','59980','91518',
                          '19071','81743','55343','10130','77742',
                          '70465','76748','49734','67935','57229',
                          '57714','70592','60602','21324','19587',
                          '80253','86398','51717','72689','49688',
                          '20509','27670','72268','88558','24704',
                          '97034','34698','68078','23194','59965',
                          '64245','84795','72061','31987','96302',
                          '47592','74323','95719','51893','36168',
                          '65809','82058','69159','33001','54250',
                          '55585','12307','99920','30417','42495',
                          '77514','81699','63709','49158','28762',
                          '38933','32527','27948','64259','56657',
                          '39193','56448','50212','51990','64368',
                          '97111','32312','58375','61560','55920',
                          '48658','23065','73652','46645','74585',
                          '98787','45812','41593','66190','60393',
                          '83270','88136','92955','38725','78517',
                          '51344','97632','15706','58040','99094',
                          '33623','47688','58788','80319','26770',
                          '48168','31200','33363','73987','59261',
                          '56866','98161','46385','41956','12523',
                          '73781','19058','79879','49668','17715',
                          '86316','96213','28404','34355','72854',
                          '70179','27138','84684','85351','12622',
                          '15104','68323','79706','31948','85590',
                          '54333','85646','74173','84618','40372',
                          '43523','85637','69812','56100','18239',
                          '38026','79342','16499','11792')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


