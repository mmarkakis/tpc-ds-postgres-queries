
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '72785','50070','17029','39606','82265','78766',
                          '65064','41447','84397','17118','27353',
                          '94219','18492','60138','14428','22424',
                          '53330','70195','43729','35362','50442',
                          '79525','42065','57336','24368','98289',
                          '92088','40717','88775','36640','10071',
                          '51955','23404','63262','76872','96804',
                          '58316','38716','61379','47640','26133',
                          '81017','35793','23765','23384','60111',
                          '50900','75137','10066','11066','71541',
                          '12474','35108','26006','75014','12455',
                          '92678','27283','69085','55009','94214',
                          '60845','80944','43237','35986','70540',
                          '97678','53176','86797','40921','58991',
                          '17404','82410','86637','26020','95760',
                          '48758','52188','91176','81003','80276',
                          '49609','76021','92264','44759','53463',
                          '62146','42939','35622','93284','38762',
                          '98295','60806','70910','43492','56950',
                          '47186','52171','61590','12467','42548',
                          '96343','63526','26222','42331','70836',
                          '58889','93544','18972','22542','30066',
                          '47393','98654','91400','75339','83679',
                          '79488','65935','80341','75355','56774',
                          '56410','84075','11240','70220','60451',
                          '67680','90760','35525','73073','22415',
                          '66528','63334','73365','23579','20294',
                          '46419','72838','82462','54042','15158',
                          '77030','34490','81316','49324','10235',
                          '66029','40758','40342','66401','52565',
                          '81465','88807','39668','19132','90553',
                          '27282','40863','96314','14942','11540',
                          '93704','22760','64766','63509','23341',
                          '89641','78629','38490','57355','12634',
                          '21876','74526','24288','83555','99350',
                          '43548','75061','70221','33562','27019',
                          '80687','84497','47766','55172','21740',
                          '76468','91746','27387','86139','25430',
                          '33482','65074','88214','82638','93151',
                          '21629','72235','58656','72660','65029',
                          '96307','41065','10592','66187','43922',
                          '20893','65572','70840','49944','43381',
                          '42709','47201','56984','84631','59800',
                          '32185','85514','49851','10866','61208',
                          '31399','71917','90899','91308','69387',
                          '29202','81195','48980','12536','81418',
                          '37718','28332','68809','21445','61062',
                          '52525','81450','99527','15732','79319',
                          '98573','62392','66508','55977','94570',
                          '68977','51425','61599','30428','92981',
                          '74079','95893','44724','43153','29856',
                          '70493','74423','81004','76710','69766',
                          '71919','26668','37613','67795','68856',
                          '36576','80582','74183','30942','83669',
                          '56300','31390','56312','13943','48741',
                          '30420','32936','26075','91767','27955',
                          '81633','67279','13648','17926','11800',
                          '75481','34991','35463','44728','14776',
                          '28554','54795','76056','59642','77887',
                          '10903','70642','63292','68883','84095',
                          '25458','54486','97038','87655','33179',
                          '88286','69773','65874','63435','94080',
                          '67286','12396','25104','32782','15622',
                          '45942','35207','39800','55036','33977',
                          '66523','58267','43886','21725','45739',
                          '26501','62639','57743','22939','61914',
                          '14912','73757','23445','85938','58373',
                          '40775','90094','64321','61740','87145',
                          '58691','28762','11562','68862','74880',
                          '70852','51433','44197','47243','35970',
                          '69170','73840','47800','82328','49981',
                          '37000','36641','82329','47505','19610',
                          '12540','43753','41969','57228','48504',
                          '50822','82927','12318','45554','36779',
                          '18672','46677','37345','23466','43248',
                          '86573','46958','38037','64542','59219',
                          '39276','52998','51769','56731','79297',
                          '68627','76795','52666','19502','91915',
                          '51255','73683','66294','23767','90183',
                          '85028','75876','29440','39438')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


