
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '36199','93248','24399','33174','65926','51668',
                          '21835','46407','60582','26227','95104',
                          '75991','33423','32406','61658','44846',
                          '62610','21999','28469','64124','80209',
                          '12361','46678','54078','35497','55342',
                          '43202','14581','72054','32971','46218',
                          '77836','51978','35384','45558','11615',
                          '28871','57554','57756','59505','35919',
                          '40975','83077','98924','86425','47994',
                          '11019','88597','87966','56671','19607',
                          '52622','75813','26031','23489','77753',
                          '41726','42035','17729','36692','78898',
                          '62092','31856','46819','76351','69177',
                          '77559','69901','82292','31375','97270',
                          '79572','31345','54575','13186','89819',
                          '12981','99182','27615','16495','36181',
                          '33112','98607','53718','97578','85190',
                          '26808','47496','83104','51198','59848',
                          '69048','94449','90301','85201','53379',
                          '93751','40804','28093','54064','22798',
                          '63034','81835','49069','43322','68261',
                          '89891','22995','98766','18782','63771',
                          '54492','28628','27855','77287','68431',
                          '26339','27250','76233','30502','68079',
                          '60816','57308','84922','52589','83429',
                          '21994','74812','61144','24174','18978',
                          '60338','30717','45294','74279','90967',
                          '17373','81850','87566','83952','12687',
                          '50876','83782','37179','75614','53881',
                          '97245','58952','45227','27451','85655',
                          '81043','84823','55191','71290','84083',
                          '18256','72950','30155','72790','79120',
                          '82230','66562','88087','16878','28194',
                          '54433','90202','46174','59275','67707',
                          '81201','46981','16654','92431','83958',
                          '54331','15225','51744','50005','26059',
                          '73522','17613','73569','73002','10927',
                          '45443','48740','65222','83710','48501',
                          '51050','54279','72812','96233','13982',
                          '29387','25194','85433','14957','77406',
                          '42208','11873','47863','38752','37700',
                          '19864','28918','97884','27661','53181',
                          '44898','51743','44940','65157','64441',
                          '93467','45516','42902','46417','23470',
                          '41754','84424','35484','71984','10756',
                          '49585','42407','83521','95096','13976',
                          '53974','18513','43122','67247','76716',
                          '71289','27020','87026','44969','59301',
                          '94438','48484','89058','79731','23604',
                          '89227','11738','31259','61842','29203',
                          '51457','11560','82064','84273','70773',
                          '80155','96862','91709','26280','22385',
                          '41940','92565','80512','58016','46838',
                          '59227','50063','70803','73700','96129',
                          '54950','38592','75798','66723','68544',
                          '74201','32180','29381','85560','72914',
                          '87540','84992','76935','93442','84256',
                          '12819','10126','35174','60974','84717',
                          '28475','74501','56674','88027','91508',
                          '52838','52857','50437','19327','75217',
                          '69412','95264','42740','66871','74672',
                          '24134','66720','34612','55237','72566',
                          '38391','28282','40300','93008','47796',
                          '84520','64256','11097','79998','41322',
                          '43817','67177','17515','99047','79866',
                          '67937','29008','74825','53915','88958',
                          '27805','79827','74709','37952','83025',
                          '41600','97480','94288','57361','46381',
                          '46150','11125','86178','30439','34926',
                          '53116','33201','50599','24511','43106',
                          '35824','56995','24860','88083','49060',
                          '96193','92613','37512','32031','38468',
                          '19776','56184','96061','16373','50141',
                          '72418','76116','52993','13914','21765',
                          '94765','26999','19522','35333','34369',
                          '22628','98366','22604','35597','68845',
                          '66634','22387','71330','43807','32206',
                          '22185','65059','39089','76732','76778',
                          '90865','15483','88415','80759','25566',
                          '60856','83450','52059','34132')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


