
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '48591','22424','74453','16593','11339','62786',
                          '47208','67917','96468','39542','97233',
                          '56625','23496','65096','97344','52431',
                          '71931','17372','35577','11370','63569',
                          '24392','60866','57252','41006','57393',
                          '41223','97248','90277','75066','27897',
                          '15901','21690','64674','98619','84373',
                          '85162','44376','70458','90307','12825',
                          '85021','91589','72899','67174','99437',
                          '70935','18616','25273','84158','51145',
                          '88044','52563','94761','87051','53780',
                          '66387','73670','49943','27352','29044',
                          '17905','18065','70793','39410','71216',
                          '43081','50589','18978','37319','58173',
                          '73653','20536','17076','23137','68645',
                          '11990','45165','14135','97400','49254',
                          '94506','72344','85871','58764','46539',
                          '64566','60816','73283','76356','52561',
                          '43338','17040','35831','21514','35989',
                          '82226','53377','22699','94838','72493',
                          '30064','19042','33133','46654','39695',
                          '10048','29164','81039','39529','84556',
                          '64334','18554','75149','25218','78438',
                          '60840','28868','76188','55183','99839',
                          '50505','19157','73730','58627','85106',
                          '12503','25878','66332','83884','69115',
                          '75597','92787','45926','70174','10136',
                          '62011','58710','91497','16627','62701',
                          '81443','33852','74172','99291','19822',
                          '99883','74340','73556','83339','85508',
                          '14668','41133','70177','89584','73917',
                          '29500','53604','65020','56960','69623',
                          '56005','43759','34694','56069','79183',
                          '58240','29594','77186','52190','40996',
                          '75077','64169','98688','16412','28214',
                          '53648','69318','22481','55334','34000',
                          '90923','84629','60869','35884','12458',
                          '54998','20034','68041','75681','24767',
                          '24250','58990','68742','44476','80178',
                          '73190','82467','99818','90038','72600',
                          '22807','98046','82227','28297','99503',
                          '46706','91769','17296','17327','64827',
                          '95531','39998','33543','76508','59708',
                          '23965','89299','87511','82582','80260',
                          '12545','93961','80823','59250','59819',
                          '76600','41368','43226','50499','49391',
                          '34747','80564','46896','50443','76844',
                          '78479','70192','63971','47812','65760',
                          '23927','63917','85937','65519','91050',
                          '84699','74715','80046','17169','79368',
                          '66101','95397','64237','77830','24095',
                          '82658','88079','98426','29761','91523',
                          '45603','98586','32061','40104','10201',
                          '42371','56017','28116','91109','18038',
                          '96194','87699','21965','14544','63499',
                          '10432','84956','74162','52915','26432',
                          '67767','11844','34572','11272','63539',
                          '64160','61566','27153','18935','75244',
                          '48998','38225','14471','17694','91220',
                          '46643','79227','98621','15987','83796',
                          '60775','68260','91009','34831','72257',
                          '28126','15445','31776','72741','33867',
                          '21101','63040','18869','41961','57124',
                          '41238','31630','29562','97878','28934',
                          '63942','29599','41067','69295','95034',
                          '13331','20075','53113','51498','81194',
                          '55067','71136','36318','27970','65413',
                          '79349','43445','28810','61289','88780',
                          '60056','10764','92978','78701','70460',
                          '76728','93885','69940','76072','30635',
                          '54113','98228','61866','94232','27399',
                          '17821','68232','40585','36213','72925',
                          '98737','39534','21552','41681','68887',
                          '92061','44403','73207','49509','14681',
                          '56103','79122','66322','97493','27611',
                          '66883','10206','41337','45371','68967',
                          '55061','89738','37497','80147','27389',
                          '89928','89974','59893','21301','16336',
                          '45658','54507','20537','62319','79445',
                          '58842','45748','28951','57140')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


