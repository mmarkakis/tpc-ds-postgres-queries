
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '46756','62647','54463','81096','94934','43482',
                          '51465','30261','24591','12569','87750',
                          '88857','71597','85135','55066','85132',
                          '82656','48468','44163','22811','30646',
                          '74144','18029','29603','71487','29765',
                          '40649','28585','61476','63704','53631',
                          '60362','63067','78730','26981','20167',
                          '10186','59024','91998','94612','40989',
                          '86539','49533','90564','83431','10513',
                          '59138','32508','10534','71118','75452',
                          '94226','88239','46465','65069','84326',
                          '62454','64793','62605','69474','43393',
                          '86775','84887','81266','98206','95459',
                          '40360','25469','67272','98008','51177',
                          '52978','74827','47348','66158','38727',
                          '66732','10237','24120','93879','93886',
                          '24766','89367','59835','44282','11590',
                          '50370','23010','18500','98683','95718',
                          '46874','17278','65543','45330','28327',
                          '81395','94427','67305','89540','49378',
                          '79706','87429','78368','75650','41040',
                          '91218','12427','93129','27941','27013',
                          '14097','62358','46117','25409','32341',
                          '96777','57732','57984','24224','27049',
                          '87780','73294','46035','34349','30868',
                          '62011','44233','81259','32326','32089',
                          '18026','12632','85401','47711','61131',
                          '36042','78513','71480','92937','69432',
                          '31047','29122','57047','93214','69068',
                          '66183','57918','69380','90465','44121',
                          '17051','94812','85844','54267','60437',
                          '71050','22730','75473','21425','89878',
                          '55776','57866','53557','28789','49107',
                          '86093','33119','18761','17036','20807',
                          '81976','83004','10758','16950','29799',
                          '74998','92502','85870','98548','19365',
                          '91008','14775','46189','87862','57795',
                          '84441','80750','33880','93146','25811',
                          '70408','75467','60809','43463','40339',
                          '17524','63557','81602','70832','96265',
                          '55826','69842','22440','63150','72404',
                          '85568','65536','77832','97846','53096',
                          '63429','30015','74338','21636','50926',
                          '85502','26747','82242','91196','76695',
                          '36923','70925','80864','98727','13802',
                          '68469','16737','98240','87629','87944',
                          '84630','20928','66595','12597','80526',
                          '11088','95979','24821','84594','97759',
                          '16821','66236','91510','89587','67732',
                          '44215','47923','52193','41182','87251',
                          '92888','61549','83972','18664','49581',
                          '64102','14166','10790','81784','35239',
                          '15439','15503','55774','70493','44884',
                          '99271','68824','26763','59699','23525',
                          '57442','79617','36043','97215','18043',
                          '76910','67810','12985','77115','64857',
                          '73036','49140','12304','94674','39553',
                          '71195','49345','26497','91746','66986',
                          '45107','65201','79455','92054','17266',
                          '89419','70425','89984','29972','73766',
                          '53136','36398','71076','90479','74441',
                          '14125','36373','99634','56216','82637',
                          '72989','57777','17384','50593','73204',
                          '24570','54109','52539','83301','99366',
                          '91843','67957','50522','82351','71042',
                          '52215','25209','86402','19487','63167',
                          '29058','25929','85614','80039','86240',
                          '37469','70611','71356','37516','26810',
                          '69396','45222','18726','30958','48157',
                          '12248','75725','14443','52124','24209',
                          '67050','57419','70615','22880','74979',
                          '30509','26815','14225','35087','30642',
                          '19596','39679','55899','94634','73650',
                          '15694','61865','91177','12952','62846',
                          '18930','47776','14075','74917','26996',
                          '66240','35309','70177','53549','29405',
                          '74510','32170','92014','86592','93543',
                          '14879','75232','37008','47587','61321',
                          '41508','78529','12968','89685','20151',
                          '16518','36979','99155','64151')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


