
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '26120','27788','52290','64147','11854','91618',
                          '72440','54883','39610','82272','38450',
                          '32483','27214','19693','98657','27213',
                          '93181','42178','64987','88375','80314',
                          '13680','51807','65258','79218','19809',
                          '16127','94708','93746','15243','37195',
                          '52013','57245','50412','16083','18376',
                          '84908','92072','59042','22066','61730',
                          '72094','68736','68057','24968','36228',
                          '58815','76252','90974','15011','49365',
                          '50410','18321','97561','71372','75759',
                          '47114','38210','50379','66420','94201',
                          '86362','24335','48143','20142','15849',
                          '48361','87967','20461','22249','49623',
                          '42440','95712','26995','89839','52451',
                          '43035','71510','37170','61337','69844',
                          '52097','31356','94604','46839','13818',
                          '47768','89178','21074','92264','72905',
                          '21785','85770','34116','55628','80779',
                          '42531','11417','64753','78257','92112',
                          '67876','51672','38197','21611','47416',
                          '65213','45634','95622','10668','66166',
                          '28552','63284','61182','34313','62724',
                          '50369','26317','76692','51462','28799',
                          '41415','47769','88077','18565','40085',
                          '56505','44388','54649','37924','83238',
                          '92711','99245','99076','17827','56671',
                          '99739','93462','33833','30127','27549',
                          '64484','73005','16380','11910','53511',
                          '55356','56989','72002','88687','29137',
                          '97453','62103','42377','64892','27886',
                          '36942','12085','48004','83870','15744',
                          '42662','30681','94115','31635','95527',
                          '43663','65832','12553','41763','76525',
                          '67379','77182','71256','69891','72578',
                          '89671','26933','30051','23115','66682',
                          '80044','40912','88918','27248','39670',
                          '92633','89557','40902','57408','98183',
                          '57369','53870','40771','14126','26840',
                          '11286','63288','65494','49993','66513',
                          '24822','55815','99405','92511','45831',
                          '84433','75485','97462','72160','51084',
                          '95564','28779','98897','15774','50592',
                          '79427','25795','99277','36178','50957',
                          '15747','74208','79523','50538','30906',
                          '26610','19308','17601','65204','27015',
                          '65442','43241','58096','72581','86958',
                          '95348','36469','68554','41193','25604',
                          '77976','98851','26725','91729','95248',
                          '53395','20282','28542','68087','18646',
                          '63082','30809','30364','25074','88313',
                          '72972','56138','23823','64096','42194',
                          '92223','81432','65713','68873','58592',
                          '52151','32664','56059','55218','99766',
                          '55600','18427','47298','88765','84229',
                          '53957','49111','64609','39683','99481',
                          '54736','44845','90521','44746','31426',
                          '24779','68794','80762','71969','59061',
                          '96147','10310','37682','53907','37407',
                          '22648','47801','35402','19178','95824',
                          '57692','96839','21532','98331','86857',
                          '98051','63122','46332','61345','90336',
                          '34976','25030','29808','53962','88706',
                          '95088','26437','19600','80278','94886',
                          '76375','16888','22464','77359','66353',
                          '75771','85702','69805','18900','67398',
                          '42067','84154','86843','47547','19152',
                          '28612','19866','35828','24899','86394',
                          '87814','65601','69255','68315','62639',
                          '37453','11784','68808','75542','57570',
                          '62337','82796','85647','26240','34533',
                          '13981','13297','52113','78082','41483',
                          '41245','80901','55876','58508','96816',
                          '61971','44529','48658','18008','56794',
                          '34515','80487','71163','22357','47010',
                          '74689','96002','94674','26334','81033',
                          '51177','61265','49899','60427','22499',
                          '78748','14059','51058','68034','64002',
                          '58237','51044','82220','10084','57291',
                          '23783','78084','73015','59748')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


