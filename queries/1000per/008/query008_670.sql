
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '82697','52872','86930','41965','86521','24003',
                          '19192','64124','53185','45052','65941',
                          '34236','27574','36363','11192','72809',
                          '44423','13428','57695','76905','74052',
                          '96073','60594','51044','44314','44904',
                          '57426','83854','30532','41348','66076',
                          '44552','45134','40535','79212','98167',
                          '79995','11544','35224','12320','85775',
                          '79727','36707','23797','86613','59776',
                          '98610','83626','45364','17025','15658',
                          '31520','43737','57920','86302','15342',
                          '24872','22685','70700','76527','61592',
                          '45328','17084','96962','11184','77372',
                          '97070','36866','24278','35535','49801',
                          '59007','43401','51375','80308','38042',
                          '60584','18132','76334','69337','10181',
                          '92158','96231','29282','95251','93939',
                          '26814','68218','75196','52515','19383',
                          '18395','52497','79725','36072','58099',
                          '33402','11166','78869','64217','13297',
                          '80764','72929','96032','52568','49197',
                          '53452','61057','96629','62483','98264',
                          '39482','75519','83114','55241','45198',
                          '26529','21980','87721','64863','97391',
                          '46484','28493','92167','48644','38670',
                          '52616','46461','16939','45224','44504',
                          '51270','31249','89860','16350','29119',
                          '40462','42093','66886','45535','66326',
                          '60814','59779','57022','17201','22860',
                          '36285','71749','12379','86607','50582',
                          '15190','70124','99828','43021','35464',
                          '37023','75908','36981','60360','12879',
                          '87699','67598','85900','65242','87691',
                          '57217','64064','44377','83636','63589',
                          '51241','96389','40626','63298','72280',
                          '47766','52511','28329','46612','14810',
                          '84299','80139','80152','20303','95186',
                          '85958','97978','83817','29971','58840',
                          '45411','59344','91555','59888','25576',
                          '97594','77486','28494','13043','67283',
                          '16445','99798','28063','38497','44455',
                          '25862','48987','22125','30126','15455',
                          '67302','88758','11280','79375','52472',
                          '91223','98799','34228','91297','83270',
                          '50795','31355','41030','24310','75096',
                          '28933','99111','58740','29872','87709',
                          '61948','34976','13135','47703','65314',
                          '61589','84659','33220','14295','39794',
                          '92597','89191','37223','91984','98406',
                          '34701','61207','17869','33948','60951',
                          '58613','86802','63870','65966','75744',
                          '18692','14724','93952','10390','28737',
                          '85341','24811','28867','13888','16844',
                          '26609','72011','19999','54257','15456',
                          '80343','94417','87028','35863','87860',
                          '88687','52569','63264','58657','71781',
                          '87571','36119','72122','85064','44300',
                          '18664','59830','63124','50687','32137',
                          '37128','15388','57031','40101','63707',
                          '70191','31987','46131','78507','37643',
                          '41661','12593','62287','16229','97408',
                          '67305','67204','28553','45039','32551',
                          '10611','52402','25386','71231','40087',
                          '54877','41689','60100','14443','22414',
                          '43201','37312','75454','43514','59989',
                          '46906','10114','75259','39515','22556',
                          '32256','41512','61902','84028','18515',
                          '86863','49747','17288','73676','11411',
                          '32054','17569','67032','14362','67240',
                          '62327','83190','74822','23770','79654',
                          '47189','72482','76215','51920','61983',
                          '46121','83055','45297','20698','96119',
                          '18612','15386','79736','54945','48786',
                          '89841','76668','22552','57982','74794',
                          '50144','34879','97416','37358','44424',
                          '39491','60722','41563','12636','75481',
                          '67579','10124','90663','48020','38936',
                          '10642','10303','29696','15793','53649',
                          '78450','60427','61578','57714','12103',
                          '66255','53052','48548','39154')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


