
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '93994','48527','33892','69991','55615','84572',
                          '90860','65488','41863','72811','81530',
                          '10937','25882','42568','83016','34478',
                          '73230','57005','53391','98138','49649',
                          '23697','24633','99848','29439','99886',
                          '67671','53343','15686','33348','85340',
                          '70622','28918','33384','12744','44308',
                          '35219','96588','57762','19088','52933',
                          '20184','39703','68421','69575','66795',
                          '71143','99895','54370','74332','88659',
                          '89185','29578','39317','39371','69876',
                          '19668','37889','16833','49418','88576',
                          '74123','86703','67011','86149','97906',
                          '39364','43519','81512','18570','63250',
                          '17005','41418','42672','36211','74006',
                          '35461','22314','53973','97006','84651',
                          '48057','29717','51324','70702','24235',
                          '58852','84521','26449','61974','73085',
                          '39689','93670','42820','97454','10270',
                          '33747','94004','44911','52719','62278',
                          '29879','13907','41015','73825','75871',
                          '76741','50201','36015','71544','38075',
                          '71095','76376','51500','50257','25433',
                          '75163','53917','43899','42816','72832',
                          '52137','87011','63989','68107','72896',
                          '86480','36785','45473','34747','11620',
                          '68076','69833','12824','45187','59640',
                          '30059','88260','41419','72890','78459',
                          '96977','84801','28261','51612','28838',
                          '39033','87627','55344','44971','60448',
                          '18641','64122','83330','25625','20329',
                          '70449','51981','84473','77808','64332',
                          '64061','42584','57137','56088','27993',
                          '47466','61332','15027','36358','55770',
                          '74953','72836','58624','52074','15340',
                          '98084','36387','18476','44239','70324',
                          '71962','14915','16517','14169','90963',
                          '49458','45258','81694','52619','35250',
                          '76674','44094','97891','34379','20784',
                          '53151','49602','66805','99334','32503',
                          '61565','92810','50522','25100','54884',
                          '82007','46741','13011','20759','90434',
                          '61885','66386','21214','44915','85082',
                          '35491','44366','23371','41609','93671',
                          '74564','54048','20519','53385','59812',
                          '85531','65559','86880','12324','88893',
                          '34537','13420','51762','71261','70629',
                          '87320','98436','68266','41086','96979',
                          '29614','52339','53092','31749','51530',
                          '60649','15332','64683','81504','43364',
                          '87246','48498','91134','38617','77831',
                          '76885','23050','83337','67737','15828',
                          '30917','22198','42378','21387','67280',
                          '51457','85048','51466','72094','56993',
                          '66313','51322','54854','57720','50980',
                          '49114','91638','33966','10849','51722',
                          '80936','34955','99139','18298','68512',
                          '79429','16957','92005','29431','75568',
                          '88958','13295','55303','14861','21750',
                          '60713','35720','10077','69015','59009',
                          '73036','21434','68631','70045','21771',
                          '99853','47406','11528','23622','63944',
                          '37976','59430','69326','60129','39060',
                          '45087','22311','99692','96940','96605',
                          '43176','12325','44217','57174','59339',
                          '65132','56618','16329','63266','35471',
                          '97110','81874','75987','82785','98650',
                          '10211','97955','11001','88045','77438',
                          '33334','67604','87796','10221','19608',
                          '86235','91025','43617','14777','18878',
                          '59020','54230','15888','82282','16036',
                          '47816','63056','49591','63588','30050',
                          '93029','55309','79603','76540','26425',
                          '61548','91890','65469','60875','37339',
                          '63302','90431','16956','36846','72456',
                          '10650','78833','66300','72657','10720',
                          '71826','82495','17024','16606','93393',
                          '47280','45422','22935','61424','55109',
                          '30542','98467','44777','99629','74476',
                          '33946','58926','23649','25406')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


