
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '90342','76265','20484','56843','98753','37302',
                          '13208','64838','47755','78495','97591',
                          '74938','77075','82114','12150','60853',
                          '68595','76550','35621','70366','29597',
                          '31779','60006','87826','22617','43117',
                          '44381','94982','51510','58418','79899',
                          '50868','87909','73887','41806','52064',
                          '98288','16715','50400','89270','65914',
                          '18002','24460','26948','15140','99064',
                          '73738','83434','38862','58524','51126',
                          '90772','59755','87767','48285','36641',
                          '20395','32109','45247','21754','78029',
                          '56822','81194','77765','66392','20146',
                          '57956','55590','74987','28138','89059',
                          '32461','81796','67786','40866','17387',
                          '65786','73443','24856','12773','58362',
                          '88110','16179','95196','83412','22986',
                          '36425','72239','72039','92108','32908',
                          '63807','55536','13078','74767','59362',
                          '51829','36919','30591','16490','18595',
                          '83075','21224','94644','76918','37849',
                          '22261','46294','79690','33819','62993',
                          '88128','58087','27560','95280','29540',
                          '80173','98950','56398','72258','15895',
                          '47433','49198','15572','85273','81225',
                          '24276','68006','70698','27320','28764',
                          '95348','68242','53516','38628','74697',
                          '13614','18020','93613','10028','27994',
                          '58970','63638','94035','52533','56178',
                          '89968','24814','30672','37470','96859',
                          '93403','27617','88524','94850','33475',
                          '37092','45230','59084','50835','97707',
                          '58347','70848','78459','83745','95432',
                          '70566','92888','93822','40606','73314',
                          '38751','31671','84014','23605','38315',
                          '34647','48125','12250','76444','14972',
                          '36980','10509','52797','16464','91662',
                          '41820','14391','69698','92190','21571',
                          '12823','15799','26022','33227','85381',
                          '16565','88664','49839','36937','19429',
                          '72270','79735','38542','11060','21794',
                          '50620','87946','17605','40800','57983',
                          '75442','76679','34982','20962','53215',
                          '19246','46586','23572','40998','43440',
                          '45650','57189','36864','58186','65443',
                          '20831','19166','15691','20110','83660',
                          '86569','44499','22501','35674','71203',
                          '66031','68337','83463','35696','58541',
                          '66259','18902','43617','32387','15238',
                          '66673','76059','95815','39682','77776',
                          '88460','22084','56651','41657','96429',
                          '10961','42364','56445','79139','22500',
                          '89214','97177','75127','63395','98516',
                          '29281','35974','84337','57854','13598',
                          '51385','57737','29207','30889','60550',
                          '84756','15319','44184','76841','98611',
                          '29032','74259','95550','82801','68243',
                          '16139','90786','20065','34941','77548',
                          '62052','74116','87287','41687','39616',
                          '18085','49387','59087','39333','15690',
                          '13689','59344','29865','20752','49613',
                          '67451','86226','97422','68258','93219',
                          '34336','68042','95062','20705','96367',
                          '96407','15394','21244','25938','90266',
                          '77922','71424','29951','77816','66262',
                          '28862','22558','58410','43504','86952',
                          '35499','54756','98158','20590','22576',
                          '32643','21036','93275','50350','63863',
                          '16277','41561','34398','53584','36410',
                          '29083','40628','12060','96198','73213',
                          '83621','42155','33413','68860','16410',
                          '36335','81475','54679','65878','38486',
                          '35351','10409','84503','80032','34295',
                          '90921','40871','85986','36923','98038',
                          '81042','35059','32254','91851','74078',
                          '86356','19495','52173','59811','99361',
                          '78184','65612','93262','51517','47729',
                          '64515','29450','85112','78711','98667',
                          '25014','23779','83916','96803','79481',
                          '25848','35868','31766','66074')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


