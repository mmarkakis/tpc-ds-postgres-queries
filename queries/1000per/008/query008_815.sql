
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '68666','30397','49391','85434','72349','44167',
                          '50750','81517','90831','85957','39704',
                          '19770','83149','32216','39129','55401',
                          '59342','14304','25856','10826','77966',
                          '28806','65754','60423','94241','60691',
                          '98710','85589','73498','12644','91342',
                          '33661','18462','64363','43657','96327',
                          '31773','67280','39739','23339','23876',
                          '10211','63974','62387','39239','81152',
                          '40840','76069','45588','73649','85642',
                          '13474','95914','58167','68134','56612',
                          '30569','23368','71387','61677','76169',
                          '34629','56375','98881','11573','45472',
                          '34669','74818','97703','87748','79646',
                          '70932','77342','39314','75375','41939',
                          '86265','42240','91793','75860','11904',
                          '29446','70190','45035','93646','61555',
                          '30988','58633','92665','12637','10457',
                          '12764','88997','87154','10946','41765',
                          '71587','49091','14646','13501','48345',
                          '95699','43750','92124','16842','57593',
                          '54363','71318','50361','29459','59782',
                          '13476','21108','61608','13523','15968',
                          '41774','36032','37537','31347','79972',
                          '32804','85378','10398','86029','86124',
                          '10876','53028','79355','32620','24879',
                          '45578','26853','66204','92876','66537',
                          '70311','16875','97583','44696','18407',
                          '93239','49769','75261','87711','41749',
                          '77016','79258','73132','25010','51358',
                          '35384','85820','59540','27955','58023',
                          '94399','83677','69109','48576','76635',
                          '79148','77853','61494','53811','91445',
                          '43899','56498','27588','42922','54397',
                          '14345','90974','77142','87981','12947',
                          '89061','12908','90469','47861','88135',
                          '29593','90849','52294','37088','11458',
                          '59124','98623','15437','57437','76115',
                          '90146','46418','11762','43821','60136',
                          '29783','51145','12309','80920','10362',
                          '50078','80612','54919','69354','49134',
                          '54914','50216','23715','56316','14248',
                          '94673','48652','55427','73852','56489',
                          '61787','19542','11999','52721','65993',
                          '33911','50110','97552','83922','29497',
                          '36711','96752','80284','70112','28107',
                          '90834','28785','97352','86910','89552',
                          '48516','64056','88597','33125','86110',
                          '11590','11594','70338','84182','58993',
                          '38248','85694','57806','56136','97291',
                          '75026','53483','45502','10506','60593',
                          '19239','83602','34837','40231','80631',
                          '30061','42610','32820','29701','62565',
                          '62799','21667','13226','68808','71795',
                          '72920','87992','99932','73085','16656',
                          '35345','69759','52102','32582','36434',
                          '97002','63498','25516','61722','29203',
                          '24016','55848','79630','91318','26793',
                          '92839','48305','14838','52981','88266',
                          '36518','28713','41855','93383','11244',
                          '68903','80394','23705','32687','67083',
                          '85155','75587','68779','32952','21097',
                          '13975','39288','84876','54308','43867',
                          '75107','60671','54487','89719','53201',
                          '70326','58800','94095','18602','20622',
                          '40882','36485','77119','53429','99644',
                          '68893','64657','24091','61958','99364',
                          '13044','12367','16421','53401','73150',
                          '92591','10270','11176','91154','13625',
                          '36962','60741','92557','29430','12232',
                          '17747','61122','90176','35713','75500',
                          '82790','92754','38352','66899','37033',
                          '44278','16012','65435','84353','61878',
                          '78757','94557','29155','95589','87967',
                          '16337','13714','29875','66560','55931',
                          '54488','35538','50467','97381','40654',
                          '14184','91115','28631','26542','10884',
                          '92710','18631','99316','29152','53484',
                          '22333','86409','35581','85290','63919',
                          '59636','80560','13740','16721')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


