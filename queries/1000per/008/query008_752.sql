
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '35684','30347','96268','81664','44035','58433',
                          '57372','88322','28674','11749','44540',
                          '72433','31678','44801','33313','43105',
                          '55243','50674','21293','92914','11941',
                          '74341','38816','40374','74666','90398',
                          '28430','41081','68067','16554','80441',
                          '26969','39713','59140','83229','44695',
                          '56389','42544','14080','13909','66093',
                          '12689','31180','53177','18942','45625',
                          '65278','26947','41076','63091','45516',
                          '28583','96767','25431','31086','59252',
                          '44644','84901','15755','17226','67987',
                          '72413','51181','66640','96723','11375',
                          '99059','54187','94856','22467','98910',
                          '69620','37997','81784','40099','15049',
                          '21106','20402','38250','51002','52157',
                          '51558','93962','41804','31378','56059',
                          '49017','27562','11030','81098','11967',
                          '67129','37420','60529','15960','59654',
                          '77492','12655','94825','12503','45803',
                          '24063','33550','86244','79939','32929',
                          '15690','53736','76882','48994','19320',
                          '89866','19932','94244','77872','40370',
                          '69500','29397','59531','97523','68477',
                          '37893','29171','31065','38347','18940',
                          '84450','15882','31020','87199','44314',
                          '68282','12529','99562','17522','62670',
                          '41293','92353','86104','98018','78767',
                          '23826','15995','26732','50136','49454',
                          '36803','66543','62150','99828','64556',
                          '74779','56748','24310','93837','57031',
                          '41417','36353','44833','38746','26418',
                          '20930','19763','67541','15991','69200',
                          '57208','63323','16405','74580','51912',
                          '86819','19478','89996','41121','42990',
                          '72239','40421','10813','21690','13230',
                          '95158','61172','29481','20017','35943',
                          '33001','73532','21574','29687','87490',
                          '57756','35664','87662','78924','38246',
                          '31407','14418','56779','33425','59162',
                          '32896','39468','22586','88985','17328',
                          '96395','82137','90496','92065','20861',
                          '65894','60875','30583','12709','86105',
                          '25630','89510','24266','26535','71306',
                          '77694','46303','18517','63379','41731',
                          '15541','81107','22103','34783','20956',
                          '99100','80844','51072','91771','85911',
                          '33795','81072','13154','19760','16791',
                          '14258','89391','19657','11569','87612',
                          '47441','43647','61588','62970','44896',
                          '24440','85762','33265','87039','57946',
                          '22401','22331','63608','16304','63082',
                          '38359','21597','42977','92631','56201',
                          '65184','94557','22770','20537','48763',
                          '40972','87430','14364','88905','73067',
                          '76458','42102','77014','77431','45393',
                          '79237','62620','44016','10205','92054',
                          '84052','16652','94444','88852','89870',
                          '47820','33955','32482','55402','58552',
                          '46404','31310','24547','70812','36043',
                          '36382','89287','45594','68814','61307',
                          '70951','68310','58710','93325','14612',
                          '21794','73942','82315','82902','81161',
                          '34855','61290','18215','77578','25848',
                          '79578','99924','31312','39588','31853',
                          '19334','75686','83233','87079','57171',
                          '61452','22517','76604','35277','85159',
                          '44249','22075','33299','39917','41716',
                          '37545','31616','29455','16343','18062',
                          '43572','44043','26897','12920','64393',
                          '13681','90341','52491','16563','96012',
                          '62642','18075','39026','88541','10558',
                          '86886','28231','96658','46208','41136',
                          '44646','80249','56783','72515','30844',
                          '32906','59822','99010','20518','21766',
                          '49736','69061','95653','75540','27186',
                          '15152','81197','36867','86287','52530',
                          '55041','51516','43371','99147','41008',
                          '69142','27683','29309','45387','48877',
                          '42349','98146','10404','78892')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


