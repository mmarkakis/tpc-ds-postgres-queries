
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '92878','82154','62785','23052','10230','24353',
                          '14996','26881','66470','33124','93852',
                          '25615','48916','50023','68550','48357',
                          '31752','48744','25628','80933','38878',
                          '73720','76379','78958','12422','72229',
                          '62235','51944','33106','39542','53943',
                          '76271','93349','92107','94629','99621',
                          '47530','81516','21512','98214','47887',
                          '23294','93332','54917','10549','92532',
                          '44702','31070','22969','59080','92022',
                          '39858','11264','94884','52088','55788',
                          '88320','62945','30548','50327','44997',
                          '13516','15304','35460','92953','33005',
                          '48854','60258','10243','42766','12584',
                          '64796','16210','92983','75821','86404',
                          '93715','92747','90186','65566','62304',
                          '55502','99463','79598','71079','66807',
                          '58583','54944','54951','59116','89736',
                          '43926','92639','49743','43507','84199',
                          '39291','59076','40647','26375','49094',
                          '64738','16646','24421','31622','93356',
                          '12534','52080','66182','47719','72582',
                          '36801','11011','11322','28460','11018',
                          '20927','36983','45628','89461','50705',
                          '20053','72230','55328','68903','71654',
                          '60979','13178','68275','28480','30187',
                          '84549','76848','54857','10093','78038',
                          '40210','69461','40676','32081','51982',
                          '83817','36402','13775','51247','33653',
                          '24453','78309','45895','57649','43869',
                          '41789','71974','51410','98402','88962',
                          '60028','47948','28149','18605','92592',
                          '32197','38739','64138','62150','15215',
                          '96770','99579','72129','39052','67841',
                          '93030','85841','50448','26923','70385',
                          '77941','41654','19492','35679','47752',
                          '65159','88231','50265','21940','22944',
                          '74206','78446','18337','23954','65761',
                          '79549','77574','60792','23146','79730',
                          '36311','20507','49241','43681','68597',
                          '92118','54881','98636','48349','42876',
                          '57803','67177','95259','18526','36612',
                          '83590','69722','28395','18500','90821',
                          '34373','65000','53489','54037','92901',
                          '58127','52892','33670','92287','92189',
                          '28384','35116','57949','31061','85785',
                          '86503','22852','76035','69040','85385',
                          '86656','44874','71431','13646','49957',
                          '18950','99153','97519','61128','28313',
                          '94015','43178','12515','58572','49919',
                          '80099','81181','33564','22489','83130',
                          '52325','98717','19687','86444','41972',
                          '43318','52699','41798','51496','72598',
                          '70983','17587','71096','24508','99660',
                          '82240','35645','56515','78730','81207',
                          '87656','22457','94925','18614','99509',
                          '10002','46500','23302','11114','66863',
                          '50744','40306','84425','56983','53799',
                          '50890','82073','86476','27892','29620',
                          '36586','97405','51414','34021','19846',
                          '87159','96895','67259','36065','99499',
                          '94983','62470','96330','83630','85642',
                          '41460','88512','83078','55175','83610',
                          '81143','75890','90926','38372','69690',
                          '38537','86003','56129','52588','11490',
                          '65513','99822','19555','15360','46482',
                          '75093','19586','78515','85156','51266',
                          '53540','52053','84951','58335','38994',
                          '74537','17868','64180','80556','60667',
                          '47820','96387','66660','18220','49276',
                          '17098','38317','42311','89254','34779',
                          '34335','38558','90139','48185','86326',
                          '89291','58367','94260','53204','82935',
                          '97864','62998','29941','38405','62545',
                          '81342','64823','29455','99339','92418',
                          '27244','60828','79887','91179','84436',
                          '51746','25725','47651','44741','59429',
                          '73775','15094','53893','42999','14346',
                          '74680','27862','23661','47305','16367',
                          '36351','94379','81621','62149')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


