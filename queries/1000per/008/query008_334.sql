
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '90150','57780','58211','89030','36078','50033',
                          '67910','16760','92876','48950','15642',
                          '28243','40014','97646','20410','61116',
                          '94047','57936','95808','31324','25403',
                          '49859','38515','81237','84956','95310',
                          '51797','12175','17641','70618','77314',
                          '60316','46982','90426','34985','93931',
                          '49080','58519','82542','11359','25569',
                          '19848','49936','44928','33189','99420',
                          '91382','86259','59293','61520','51878',
                          '13275','82024','71947','42664','63758',
                          '95090','31232','83168','33829','92704',
                          '70408','55795','10516','85687','13219',
                          '19167','65726','93045','19758','55253',
                          '45443','42872','47808','50728','32068',
                          '47510','78591','56801','90522','11384',
                          '61097','55394','38601','35471','17620',
                          '81463','53829','50011','57261','45903',
                          '11166','83083','50342','90039','39564',
                          '24120','24872','86325','62441','95984',
                          '47711','42798','22198','61330','91152',
                          '13590','88845','55078','67114','18607',
                          '39247','16902','82574','54707','79237',
                          '83477','48143','76637','57425','64843',
                          '35143','33452','12719','14437','26573',
                          '73429','93756','23467','69081','13528',
                          '47724','26934','71174','90713','95037',
                          '59827','94598','51091','85817','75936',
                          '69472','23490','21610','58001','52951',
                          '89265','12714','31805','67422','57382',
                          '23232','49757','58744','42220','98548',
                          '29536','55954','81576','62224','69012',
                          '39779','69945','88459','10500','52341',
                          '46378','91014','83112','67896','95189',
                          '22681','70303','43580','61687','26576',
                          '86802','74662','65505','98246','98589',
                          '11430','10416','93162','85909','97093',
                          '35861','53217','46779','18036','60383',
                          '89624','87740','99681','61922','84150',
                          '43961','65567','37861','67664','75213',
                          '53312','81319','50588','43254','39242',
                          '84997','52516','71704','62725','86380',
                          '57545','16397','99607','46261','81387',
                          '58562','25364','45419','42271','36561',
                          '79774','66497','38217','28371','93070',
                          '86860','13740','37905','31388','15796',
                          '94299','63745','57561','30636','54382',
                          '44250','29604','67418','86907','39764',
                          '85115','78921','34449','72773','53845',
                          '27886','93168','17198','97395','32402',
                          '42541','46472','93919','41677','76058',
                          '88416','71945','50888','23046','66109',
                          '21461','72109','13358','26862','83456',
                          '17304','54444','53963','39045','76241',
                          '43264','99489','68344','34953','27057',
                          '74664','43335','31249','73237','20613',
                          '55096','55633','42497','23953','13439',
                          '72212','47288','96892','10672','17430',
                          '46590','94784','90151','53022','38879',
                          '92521','40441','40159','15409','39183',
                          '55589','24821','47886','51628','45535',
                          '45517','83214','85885','74963','71510',
                          '70294','48182','55121','82521','76298',
                          '35192','90654','57975','93921','74840',
                          '86624','14766','11617','67318','99334',
                          '44082','94492','77112','87536','76448',
                          '24019','23258','85326','25212','54422',
                          '11061','73011','13007','70935','81594',
                          '28548','89080','38214','30205','41091',
                          '53692','37734','18041','10132','88599',
                          '57445','34482','33597','22406','98730',
                          '46208','55638','16352','29414','54315',
                          '84654','84552','61314','80335','10571',
                          '70382','61256','56180','26883','91820',
                          '80836','65202','88275','71153','48056',
                          '33252','32418','83869','91444','35945',
                          '53234','68629','78565','73991','47442',
                          '31433','47776','24061','33094','34268',
                          '51655','88779','34544','17008','90156',
                          '13763','14227','14349','23743')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


