
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '15337','63544','87719','85481','21653','13352',
                          '40761','89399','81461','21584','74267',
                          '46315','27184','95574','28539','86793',
                          '62483','74841','94902','55676','45334',
                          '80001','24367','55853','14713','81169',
                          '40134','51144','35836','49840','47010',
                          '14835','17639','69949','39156','30207',
                          '34654','74940','52863','24088','99406',
                          '66816','68185','22842','53356','89339',
                          '74753','31749','88881','41494','10588',
                          '69931','81951','23187','91653','54778',
                          '14448','64645','95367','59622','46818',
                          '66653','12183','73723','58886','49858',
                          '26252','97860','60199','60700','95659',
                          '82909','30388','88564','84422','68839',
                          '80331','60627','97932','28278','94205',
                          '72539','89707','63307','60628','12873',
                          '14646','77378','69805','25894','64955',
                          '57425','38313','63242','15593','86467',
                          '53728','95141','68064','48236','80556',
                          '81545','77213','87491','36353','77061',
                          '49801','90788','59499','93679','44553',
                          '29006','78528','53410','23103','49607',
                          '77184','27907','57282','15599','46600',
                          '53784','90051','53605','23539','75205',
                          '67358','93607','98549','64539','61396',
                          '17032','39469','63885','10923','25124',
                          '57511','90098','25608','27241','40482',
                          '82701','17035','59143','80513','87718',
                          '53056','32893','96009','53004','32739',
                          '83906','52202','78639','77364','16822',
                          '61687','23413','54123','81698','60245',
                          '98860','11996','15156','13302','13959',
                          '97279','96561','66778','95512','52682',
                          '24474','55304','17788','40868','86907',
                          '54063','74314','80190','62443','49738',
                          '53198','51248','43648','58381','61272',
                          '16330','84283','44729','27631','15608',
                          '37093','86108','47531','74032','55787',
                          '36593','50915','61356','41438','34336',
                          '60189','49696','67294','28710','85930',
                          '80253','74995','84374','73328','48318',
                          '77109','64700','19819','80524','21105',
                          '13226','72556','72091','18193','95732',
                          '79584','69042','53305','33093','65650',
                          '24909','10475','75762','46954','84184',
                          '69313','45994','28986','39041','78325',
                          '42977','89612','45422','29614','64154',
                          '42706','45770','28286','98474','27269',
                          '73153','57292','36054','69715','73276',
                          '47127','79989','60287','96383','34874',
                          '38530','13501','61170','14865','86648',
                          '61912','29219','39955','79605','37430',
                          '85093','13208','42617','36657','75032',
                          '95631','25034','93409','60131','26376',
                          '35298','42465','92347','30317','44011',
                          '70390','50271','63167','92456','51919',
                          '95597','45914','78497','89143','63610',
                          '89402','85935','53351','45074','85468',
                          '42926','19715','27133','97124','50275',
                          '39394','83509','98533','65984','96002',
                          '82949','62688','69543','24916','42614',
                          '15023','98796','39150','39998','96361',
                          '57983','70193','34951','31874','62002',
                          '94868','66858','72267','50801','95162',
                          '92948','35726','91063','96078','33331',
                          '52142','48625','64574','96527','51602',
                          '35052','30862','37193','20518','39830',
                          '58745','35823','90550','72102','55358',
                          '88056','53602','68901','35247','46140',
                          '62724','42043','91432','35492','37740',
                          '10539','33529','69109','47080','85148',
                          '29557','65361','78878','48198','98183',
                          '44947','43741','87652','35590','63690',
                          '87334','90030','34690','57933','71680',
                          '68808','32886','77353','59334','91941',
                          '14660','84895','80933','63846','52822',
                          '92496','15022','70205','49237','14447',
                          '13148','35323','76071','32269','65996',
                          '36282','42419','91797','68549')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


