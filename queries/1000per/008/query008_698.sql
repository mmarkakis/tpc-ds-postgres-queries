
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '90689','90131','18488','91624','39858','51117',
                          '17975','66983','56659','12212','48314',
                          '40479','47284','27131','68354','56015',
                          '18076','29187','14235','44894','63425',
                          '73067','85473','50761','60761','62064',
                          '99535','31107','66476','78863','46068',
                          '90734','94825','65497','87342','77376',
                          '79398','81965','55406','61527','22222',
                          '63753','23751','23775','61143','53884',
                          '38879','62784','97274','81776','82741',
                          '27028','60006','71286','56056','32739',
                          '93663','63413','17028','85358','90201',
                          '13140','10852','85923','44932','32927',
                          '27777','25655','17922','44753','62338',
                          '20565','20161','30076','13165','75054',
                          '83051','36285','62979','14076','78192',
                          '60862','33046','57534','59108','58794',
                          '90813','23423','50238','22184','84127',
                          '54307','48008','10800','28369','64039',
                          '65789','78000','93150','39162','61875',
                          '74844','43182','76919','76565','43804',
                          '29428','40840','16935','33316','19649',
                          '25587','43444','51468','71676','99694',
                          '33567','16692','58198','64401','61681',
                          '44891','93904','27050','88318','70133',
                          '47095','58652','64849','62919','85527',
                          '56950','69914','57525','24629','85350',
                          '84860','73312','57505','45526','99271',
                          '12090','32063','82922','79765','75494',
                          '73774','51079','64592','19512','43527',
                          '58105','65355','89216','56660','21562',
                          '36200','73534','60281','47448','60189',
                          '30891','66527','55569','40953','79515',
                          '79728','50774','78644','17146','39885',
                          '87723','49041','13418','43136','79287',
                          '61925','87558','74170','39624','93934',
                          '48637','56443','30405','23430','72443',
                          '23469','14171','12508','74320','85170',
                          '25102','32875','20527','12764','77295',
                          '77635','86727','31336','56881','46537',
                          '26001','59171','17539','30438','68216',
                          '51324','48700','20231','13802','93432',
                          '56495','38363','20773','84947','15153',
                          '50459','96397','97766','11856','68511',
                          '44565','16628','87053','82996','79362',
                          '11239','58543','49735','89648','33182',
                          '66599','74891','75771','56944','69115',
                          '13296','69550','23373','56764','38759',
                          '16731','88167','50608','24385','18470',
                          '11142','51519','16037','68436','99731',
                          '71713','90162','56139','45939','40140',
                          '30886','36921','68047','50537','93174',
                          '42026','67485','22217','31562','36586',
                          '22101','23830','25933','66634','50539',
                          '67774','69067','95764','45042','39584',
                          '91603','18174','91077','40934','39037',
                          '28069','70945','27427','81516','69306',
                          '59705','49781','66629','82134','91245',
                          '77375','84003','34807','34880','59720',
                          '88685','27064','40721','53392','78373',
                          '97593','54023','43410','36936','51508',
                          '50406','56332','85242','77241','84392',
                          '79193','28885','80776','67361','66617',
                          '70644','43672','62801','45207','47649',
                          '11755','32440','43939','21501','77066',
                          '91086','64302','50990','41057','37092',
                          '27598','38309','54990','60907','51319',
                          '40869','29157','42824','39720','31093',
                          '60518','74564','56380','75134','25386',
                          '19441','84256','11532','89005','53853',
                          '49758','67258','89984','54715','74164',
                          '54165','12115','54019','86194','86275',
                          '14770','24148','67475','67905','32984',
                          '15994','69255','73514','85547','82363',
                          '31729','19402','60163','67551','76364',
                          '42196','90715','74697','67886','81128',
                          '70070','13526','71358','25856','78341',
                          '53920','34941','58204','35792','49279',
                          '49846','74656','83469','94442','86030',
                          '32388','74099','62131','90967')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


