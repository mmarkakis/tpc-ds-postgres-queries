
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '14768','43325','59864','73190','90520','22429',
                          '57067','78499','75608','52175','93139',
                          '97468','54484','39230','19322','70121',
                          '35217','92913','27628','60401','92101',
                          '21188','92385','72325','52352','85310',
                          '54337','25283','74017','72906','80280',
                          '72143','31550','79616','79513','83593',
                          '49767','98539','77607','76258','82089',
                          '19289','75899','78453','28335','16283',
                          '38820','31067','54038','78536','17985',
                          '56664','50722','92739','96512','66876',
                          '55300','38754','54943','48340','98542',
                          '35948','32914','88196','67189','44568',
                          '61586','43419','84698','15813','89425',
                          '56008','52085','12275','51862','55514',
                          '42074','80417','76779','62497','29583',
                          '32011','47975','57727','14826','65857',
                          '76933','12578','47624','26615','68680',
                          '13021','53037','34784','47708','45911',
                          '83847','62007','41431','99308','52204',
                          '55790','16677','95414','42569','65318',
                          '64146','24196','76051','18591','33964',
                          '10317','71365','82699','61558','12318',
                          '92001','87571','64198','49746','60372',
                          '91193','22816','55940','44158','51649',
                          '56701','54178','64482','75445','10008',
                          '89562','34094','10408','22366','10882',
                          '18056','88010','92652','55345','74148',
                          '54821','85309','45502','44336','50417',
                          '39112','40534','18096','92843','31393',
                          '72200','43474','46036','12699','25671',
                          '45133','46061','95526','12779','16560',
                          '83804','48611','71157','24982','54011',
                          '10377','61805','87229','93360','27769',
                          '85207','33575','84159','58794','16586',
                          '50628','77328','38889','20205','89301',
                          '27930','58483','60721','17056','99165',
                          '86300','49796','80519','24803','35924',
                          '87822','59268','75322','38294','92207',
                          '13588','35981','14342','91539','90433',
                          '92332','66047','39637','36597','23688',
                          '48036','86114','66960','52626','30813',
                          '74862','65974','62003','75736','31491',
                          '42045','89342','19232','40808','33583',
                          '72863','32147','81873','58863','41237',
                          '93427','46943','33843','94760','31831',
                          '56726','13285','58711','59706','57069',
                          '76112','37770','20958','90236','34028',
                          '43023','90545','22041','31122','24655',
                          '71773','12057','96456','96095','38893',
                          '70126','10872','54965','60039','94963',
                          '70142','96301','65126','76864','23757',
                          '36975','99500','59344','79949','28944',
                          '88390','72545','96784','73129','22092',
                          '19777','43568','67725','20547','57214',
                          '84699','66519','39333','62639','59040',
                          '54952','64021','97958','43243','43709',
                          '72081','73282','90184','89668','77515',
                          '21128','97508','39221','44529','84604',
                          '40210','54096','97706','59870','58945',
                          '96436','47672','63278','47497','21862',
                          '34569','80801','92928','46298','55076',
                          '38908','79299','94268','30066','52253',
                          '72987','28518','79581','12866','18929',
                          '35390','98110','69340','23703','83513',
                          '23991','24398','50128','23590','14725',
                          '87868','58443','31481','46700','17192',
                          '94876','98070','82457','54075','60811',
                          '83634','83775','73689','99681','55537',
                          '79865','94857','14131','12331','70988',
                          '37176','75202','78052','41018','36137',
                          '40925','53777','66772','47827','58218',
                          '96901','31441','43656','91390','62135',
                          '68264','71519','95738','26869','88830',
                          '12536','88834','57654','57882','31213',
                          '74064','23099','48329','86527','96399',
                          '97940','93365','19657','66073','86809',
                          '99643','29749','58173','37832','26854',
                          '99938','81081','65117','96827','32709',
                          '54639','38608','78410','73956')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


