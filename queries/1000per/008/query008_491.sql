
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '89505','15734','29368','87135','34652','53063',
                          '33412','34398','11474','28510','46152',
                          '92968','71338','35626','90229','99684',
                          '97092','74114','62831','46293','60891',
                          '12201','97437','74589','18100','91657',
                          '54378','90610','72970','17705','90630',
                          '98471','94398','46482','14467','23765',
                          '34730','53971','11223','70297','17794',
                          '88078','70025','83724','37821','11604',
                          '14242','56648','13616','67048','53933',
                          '39420','86480','45146','84746','42792',
                          '81683','68849','68611','96018','43525',
                          '59146','23362','78422','18983','61677',
                          '68235','53006','85368','55460','48278',
                          '70843','40436','83692','84099','86883',
                          '61762','63081','61581','46576','96402',
                          '76378','23781','68796','27678','14800',
                          '54936','21086','88684','39828','39398',
                          '52401','85831','33068','92992','80670',
                          '27803','99423','87687','33315','66455',
                          '12061','83796','69399','54456','87850',
                          '61588','61101','84699','33172','68782',
                          '49688','18013','12140','75169','79094',
                          '61166','67568','54431','91387','31208',
                          '41934','93465','66150','86228','60394',
                          '71448','87500','51089','16547','25656',
                          '54207','74073','51754','72398','30049',
                          '14912','33679','33706','22778','67409',
                          '20311','72777','10259','60384','81624',
                          '73833','47682','25932','91577','19562',
                          '29439','50459','72545','28724','18884',
                          '41737','95225','15125','20470','37817',
                          '62652','25349','69161','27911','43040',
                          '80042','87663','76891','51427','75526',
                          '81059','43415','60192','36940','47804',
                          '28764','39558','82705','88901','46418',
                          '89798','79503','77056','10542','20011',
                          '23926','96154','13300','94663','80471',
                          '59087','31879','72312','56655','92809',
                          '44223','40878','52282','60596','36049',
                          '77209','36427','71202','33141','68233',
                          '60723','79489','64369','19804','81733',
                          '67254','61908','49997','56759','92831',
                          '85108','34403','77808','12521','44170',
                          '53671','80073','12278','18115','31280',
                          '21545','53788','50808','22323','77850',
                          '42254','42399','37844','42054','60780',
                          '47970','63429','31890','45651','94501',
                          '85177','48501','88669','38705','83859',
                          '94584','33334','88980','33723','73987',
                          '17827','89806','30852','34633','54024',
                          '45185','31632','81408','59299','35807',
                          '35724','89304','86169','59308','57384',
                          '99638','39335','44585','11162','80987',
                          '14495','96252','21366','76890','85720',
                          '18448','72267','39061','43671','31732',
                          '26837','50183','43905','70813','78715',
                          '15904','49710','45892','76537','25565',
                          '10098','36467','33803','39032','99308',
                          '89991','76984','73388','12973','12531',
                          '68998','23744','71388','26632','79926',
                          '21796','42849','84706','70831','90744',
                          '82963','24991','68069','59418','69186',
                          '43721','18745','16403','51096','18692',
                          '24285','47044','89929','27000','83461',
                          '42930','41404','45121','80038','36178',
                          '67881','38116','75342','12494','38429',
                          '54373','94977','23404','30265','85121',
                          '90143','64243','12046','62089','41016',
                          '64285','17742','73393','80832','27977',
                          '99408','48731','57694','27883','99604',
                          '31432','16065','30121','46814','61678',
                          '71989','68033','83897','83992','48196',
                          '36769','62990','56511','16402','61654',
                          '22023','25260','22437','88356','35131',
                          '61172','49242','49039','32147','78811',
                          '30289','71095','88442','39411','91091',
                          '88276','87182','84907','77927','58071',
                          '73473','51603','26650','42457','43838',
                          '42960','93411','26542','43911')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


