
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '86020','13437','52668','19249','93868','81030',
                          '23615','18274','66852','54991','51677',
                          '37248','96626','23072','33603','88361',
                          '61011','39796','72182','44437','65346',
                          '29276','15332','99788','30086','94364',
                          '76241','64639','61966','81251','46001',
                          '25370','28078','49718','49215','33773',
                          '62654','42871','72342','56791','35151',
                          '47828','61548','38659','14464','96363',
                          '56313','31104','13039','77780','54693',
                          '40321','18147','90350','17429','13407',
                          '92558','21642','89047','16322','83058',
                          '65747','25250','67661','71803','88485',
                          '76357','53974','59519','66454','69557',
                          '60781','83519','70553','19612','21905',
                          '36276','39375','14423','87183','96570',
                          '38567','32225','39353','63665','44789',
                          '92619','55866','74013','61507','59053',
                          '99641','45857','86031','48400','85831',
                          '46470','94487','58387','34602','70283',
                          '49565','19216','87855','86387','14560',
                          '21381','39881','45447','78645','96426',
                          '19396','25215','14263','14780','72594',
                          '55669','93894','10925','23270','11910',
                          '33699','15672','97639','68373','45150',
                          '30860','10750','22692','73644','98454',
                          '11768','35451','67113','56166','91770',
                          '61032','11904','61686','66087','62988',
                          '84794','71181','24722','70957','13921',
                          '67013','79576','42683','97287','27616',
                          '13929','36204','96267','57740','39706',
                          '19716','79307','95853','69878','35881',
                          '64706','24304','10654','46959','37384',
                          '93131','45862','56077','12116','51542',
                          '73344','31385','52734','31545','35170',
                          '89628','62596','97566','85066','62851',
                          '90163','79061','94087','68454','28717',
                          '45319','15374','54045','83306','74157',
                          '43157','67331','48377','62326','42716',
                          '76267','42676','51352','70497','38276',
                          '57429','66931','49438','42220','86696',
                          '48147','16471','66097','72714','59743',
                          '16648','21879','94255','85275','29670',
                          '11680','72563','22709','86537','24899',
                          '87830','45704','86234','96019','51243',
                          '39690','98098','31920','18959','95125',
                          '27492','33123','20780','89240','83571',
                          '32524','86510','12460','79668','39066',
                          '21326','49769','36368','83768','34244',
                          '32390','40086','70494','85007','52384',
                          '68575','92547','64409','77841','51474',
                          '90351','50224','37696','53408','92433',
                          '15587','78791','29642','73393','98379',
                          '34012','64094','70789','42076','65537',
                          '97959','87661','86538','89654','74676',
                          '51497','88509','76943','51351','94041',
                          '78972','40511','59818','27549','84176',
                          '87012','90192','71455','64575','14051',
                          '51583','86998','30479','32053','75819',
                          '54021','36795','92495','62496','53636',
                          '97715','21081','48405','92774','24715',
                          '69977','53292','43819','40287','38578',
                          '26160','36015','64341','48985','99733',
                          '25737','68110','49463','90311','98642',
                          '87565','35282','88037','46543','23700',
                          '30145','52262','96288','18436','76507',
                          '39813','99405','41749','15873','99486',
                          '34703','37202','50967','76071','52482',
                          '32802','39148','68093','47077','27563',
                          '43356','19503','62238','85657','49994',
                          '48636','72551','71924','45929','56472',
                          '10958','68803','80066','37927','30813',
                          '35115','31312','75854','16659','39652',
                          '73064','14008','28781','98050','20270',
                          '87304','42367','33293','80319','47292',
                          '92622','67859','89897','96857','27878',
                          '93728','13361','14569','91148','12258',
                          '13532','45573','83823','59775','57995',
                          '14152','37375','54836','93106','23522',
                          '53045','14059','32270','55798')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


