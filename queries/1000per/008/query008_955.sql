
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '32813','47494','14353','61345','36374','37974',
                          '76082','70679','44155','28647','33722',
                          '49162','54095','25312','17192','24297',
                          '33527','84375','93917','76572','44279',
                          '65009','62765','19996','23991','83101',
                          '70413','78121','94069','43280','97552',
                          '62492','29577','59087','13995','99021',
                          '49474','25082','50705','39224','58775',
                          '49538','74470','60516','71093','94740',
                          '93186','31198','26128','25200','79836',
                          '57404','57228','41293','53964','27197',
                          '63233','30261','51256','74330','37933',
                          '36054','18208','73509','95767','93870',
                          '35972','56055','86012','65139','57026',
                          '31313','26747','62360','74996','86213',
                          '53672','56940','30632','72587','40539',
                          '11886','58862','36515','69754','33281',
                          '11076','54707','93739','85266','87505',
                          '74617','88019','98047','34426','90940',
                          '11283','83367','78657','15228','65857',
                          '17301','25359','66970','23125','33032',
                          '13528','57796','78949','47716','30037',
                          '61360','29912','68090','95667','38070',
                          '27090','24322','65617','83504','80996',
                          '37945','15622','51445','50875','43414',
                          '49764','37749','58706','86720','53877',
                          '60871','90302','21892','19194','48607',
                          '12078','54585','14103','14744','28217',
                          '68317','46687','78523','71947','73009',
                          '96196','87511','74462','47744','85923',
                          '99293','57948','89102','17662','65913',
                          '95784','40506','70490','31993','44085',
                          '90608','78316','75620','26455','92611',
                          '39106','75383','33567','57739','99116',
                          '34478','30247','53685','60960','56473',
                          '45165','14667','80755','91022','98114',
                          '85663','27760','33353','93050','96190',
                          '21900','34315','15151','64265','82425',
                          '19309','74189','38383','20470','13083',
                          '58873','73943','43035','81891','88525',
                          '65734','92799','33705','20603','18349',
                          '54820','96929','12944','46189','75950',
                          '16100','83010','39446','41219','83808',
                          '62517','60423','36081','83757','78812',
                          '54307','61113','72531','23292','71032',
                          '71013','14822','38925','81166','13221',
                          '96056','59640','54570','69774','20021',
                          '72501','13768','60201','22130','67934',
                          '11574','62883','68263','65982','97736',
                          '20913','20767','38455','11142','12079',
                          '44776','12565','60386','74910','43760',
                          '88954','32303','68155','24227','24631',
                          '56406','64388','59506','23217','60612',
                          '34788','32955','31566','32807','82295',
                          '47843','97827','20727','79471','44803',
                          '55972','66025','50886','88550','96318',
                          '39286','72610','82814','96440','94074',
                          '91308','82412','73174','86017','98577',
                          '14585','44964','43485','94839','72264',
                          '14184','49822','62788','74669','83866',
                          '93195','73275','52377','15566','33524',
                          '42903','70030','67322','14769','94441',
                          '84444','47950','77417','88205','11569',
                          '29856','59782','25636','59218','39799',
                          '72221','66605','51733','49738','59996',
                          '37812','18887','44999','21766','23703',
                          '63514','45574','98650','81726','80574',
                          '61033','82643','90467','12514','12469',
                          '78260','18154','85967','61949','58719',
                          '83721','35621','91396','29753','79255',
                          '57992','76557','82730','48969','85135',
                          '44057','56366','92322','51715','38100',
                          '22028','93863','52030','12467','95472',
                          '58736','19934','13532','42634','64740',
                          '63263','76638','42314','68192','98043',
                          '30751','45182','37025','75029','46010',
                          '76552','93286','92605','85305','67429',
                          '77875','92200','77110','14589','22464',
                          '72073','66261','51078','76103','31968',
                          '43751','64086','31625','74780')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


