
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '73164','54632','22270','41018','88530','51646',
                          '33144','33683','34328','69741','30965',
                          '84026','95606','43369','41523','83826',
                          '28374','66341','74859','85597','88712',
                          '97640','95959','91265','43190','23532',
                          '38229','35522','20813','37181','46498',
                          '23681','98747','17924','99865','17823',
                          '34241','39982','93423','28049','40883',
                          '76820','91507','43574','35024','53605',
                          '91977','48781','49333','21688','59264',
                          '98194','75591','96127','82751','23006',
                          '98145','13578','84907','76268','62446',
                          '58959','35021','16878','22748','40529',
                          '54949','14650','53692','86530','74168',
                          '53462','50635','39137','82085','93087',
                          '63341','32890','92234','70562','82063',
                          '70904','42874','85633','61106','15403',
                          '32122','20658','11614','43384','96822',
                          '30239','99127','97306','89303','25431',
                          '68867','12760','74393','13697','82038',
                          '68969','77008','14022','82880','84635',
                          '78601','48250','95938','86881','46445',
                          '96715','94943','37576','11704','47665',
                          '24578','72429','60823','93296','48895',
                          '82308','21020','77926','92348','54462',
                          '75803','64296','86080','20014','26585',
                          '97235','71548','85461','70532','69425',
                          '57395','45763','17638','58889','12661',
                          '40647','22054','86821','34641','37842',
                          '48301','77336','15049','34940','19801',
                          '23347','57141','49927','16422','15822',
                          '61000','11637','55090','85628','32783',
                          '39818','53541','24397','60786','31144',
                          '56527','70516','40395','10984','54918',
                          '86851','79894','72983','75457','51612',
                          '28036','57230','75776','83584','86733',
                          '25385','10714','83261','93439','13352',
                          '36114','23450','43936','43383','21963',
                          '93966','10781','26745','27970','60970',
                          '83455','16153','48089','69358','97214',
                          '99886','22744','12543','61013','77415',
                          '32461','48520','43780','75650','37242',
                          '85113','63619','42275','83623','65186',
                          '49746','12317','40377','70031','79465',
                          '51423','98523','60005','42791','54838',
                          '82630','31170','94306','16884','64345',
                          '60171','18257','38294','15515','44566',
                          '63206','18096','25599','28282','72053',
                          '91861','58259','29697','97054','65910',
                          '84581','33654','53347','85979','54962',
                          '15938','54842','70253','84018','32078',
                          '96867','23883','79642','77091','62492',
                          '72191','98226','16192','25818','40979',
                          '28451','59056','97406','88709','27357',
                          '22919','76553','52319','55359','57927',
                          '23362','48091','15969','34186','47497',
                          '89575','59517','24939','89481','91574',
                          '80703','81744','90243','29959','71748',
                          '40938','35221','83013','34691','21299',
                          '30944','29607','53230','75460','69088',
                          '14351','10862','15366','25640','77759',
                          '95058','56154','47095','95649','29149',
                          '51748','20086','94367','38385','48864',
                          '38454','29164','99678','55539','19545',
                          '38020','61898','30876','32067','66806',
                          '94955','15387','11587','23800','31522',
                          '19214','74488','44154','40631','21085',
                          '65084','99413','34178','88007','14083',
                          '18798','95764','46263','64378','59270',
                          '24838','76616','36311','55527','11438',
                          '93606','86905','65689','58645','27790',
                          '83747','21630','60309','16795','44109',
                          '43856','67171','66531','87364','86898',
                          '17147','81178','37579','64808','42753',
                          '88105','16303','93572','42893','73484',
                          '55097','12698','36305','25865','36510',
                          '97715','63157','32451','75605','18514',
                          '89403','49334','35842','45148','25655',
                          '82262','60820','68027','69959','63784',
                          '80411','47862','15866','76799')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


