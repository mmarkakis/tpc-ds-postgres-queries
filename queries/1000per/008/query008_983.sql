
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '97240','72280','36184','59437','62624','71923',
                          '75868','53607','33480','29048','96097',
                          '84691','20668','49477','34256','77457',
                          '65994','35635','81075','30512','15231',
                          '37092','45156','84800','78387','74811',
                          '18156','46509','89312','82622','63642',
                          '97572','77230','55534','83945','62805',
                          '60083','38858','83785','50947','34054',
                          '83880','51611','20919','12704','94447',
                          '34236','64715','62450','32422','85737',
                          '23928','56959','37403','87735','10908',
                          '36282','24078','67388','73883','31745',
                          '35167','99612','85480','46127','42608',
                          '20330','93289','40375','90483','58499',
                          '62924','70151','24065','35673','67104',
                          '73360','88682','56707','37048','18091',
                          '70137','93218','11080','92453','13412',
                          '85363','86871','37736','68096','99901',
                          '22312','66729','27642','48285','35866',
                          '91944','78252','73409','40134','60806',
                          '75672','21357','53462','98074','13908',
                          '97620','11329','21246','43025','61568',
                          '68379','43763','80482','68002','81682',
                          '71036','12227','50463','68164','21480',
                          '69628','27784','25278','34754','86125',
                          '29913','62774','84607','61417','48096',
                          '56827','66178','61785','19420','75642',
                          '42313','62684','47367','59819','58754',
                          '59012','60104','30824','37383','76024',
                          '86622','40376','20840','50505','17656',
                          '78633','33005','54491','66117','90647',
                          '99701','48879','62313','32886','74092',
                          '30504','77280','52140','80239','82560',
                          '32621','51821','74952','11427','64605',
                          '39025','50930','84616','55540','87938',
                          '44057','49245','97025','94246','44265',
                          '83823','99065','11639','71849','13594',
                          '90058','14605','48252','97096','46273',
                          '12907','67818','40775','31396','35221',
                          '67878','28266','38805','28953','65009',
                          '62318','83499','79674','35723','23683',
                          '27270','30709','86668','75256','48016',
                          '32039','21330','42320','23367','86204',
                          '16217','29157','29109','46810','20355',
                          '50521','41278','86549','25046','29852',
                          '19271','49635','75667','79508','18445',
                          '77403','19352','62332','30833','60295',
                          '55002','26730','15236','81446','33025',
                          '42106','73071','32427','55962','60001',
                          '49321','69697','58322','51711','77262',
                          '50306','93842','41263','13678','60803',
                          '25610','29636','34593','56056','65860',
                          '66641','18190','55063','42248','96614',
                          '65723','67522','39883','43046','84218',
                          '63660','88635','47419','62250','46655',
                          '25097','66174','12455','33860','34566',
                          '75813','67797','87454','79404','74628',
                          '15181','46560','85540','59879','86423',
                          '79401','36582','23716','89293','80654',
                          '93182','78388','43123','61176','70114',
                          '56366','99235','49571','63376','26515',
                          '48472','43647','21947','90913','77547',
                          '30366','73638','78906','44323','77073',
                          '79327','16315','29919','13373','38556',
                          '91913','79846','50482','35487','13865',
                          '12692','73330','20452','32727','68572',
                          '65536','44154','92870','13153','28483',
                          '84156','36546','84991','37892','39708',
                          '27296','11018','75420','60091','45926',
                          '50038','54395','33351','35143','70128',
                          '60347','68474','49741','86463','36092',
                          '39223','70745','57186','26373','20924',
                          '33299','33178','44913','90151','23641',
                          '55918','60522','15566','92353','83832',
                          '30984','15618','73091','67956','49173',
                          '58104','21268','12164','65303','21745',
                          '41941','48787','16165','97345','95459',
                          '71142','67960','34172','83963','74253',
                          '57933','39739','19286','10694','79546',
                          '27008','37103','85259','26302')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


