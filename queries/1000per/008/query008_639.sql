
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '41852','39021','11839','99673','55895','97032',
                          '38238','45288','57199','14165','51222',
                          '46649','37809','75367','63546','44149',
                          '79800','61536','21145','86747','93521',
                          '86169','78909','28239','16337','18828',
                          '81968','11967','75638','69029','19987',
                          '62935','76982','92061','46112','97572',
                          '70950','66519','41791','29697','63269',
                          '39699','75528','71057','34071','81535',
                          '70667','58409','79284','57763','99737',
                          '35826','43741','71777','15497','61736',
                          '30082','67075','67457','38508','20096',
                          '19664','28829','54719','20894','16280',
                          '30661','91583','84314','93981','76634',
                          '57948','11893','92787','56766','42443',
                          '60254','94876','88708','51536','56070',
                          '86477','81710','43574','43306','63098',
                          '47230','37049','43488','19505','25521',
                          '20890','54096','75317','36434','59940',
                          '12322','43048','48003','46080','90389',
                          '67660','96744','91657','97804','10287',
                          '11703','88878','11056','83774','48885',
                          '33531','62467','37215','89879','67685',
                          '22380','48891','30822','76192','35382',
                          '27923','81253','32204','73368','94607',
                          '34474','48388','15408','38011','29125',
                          '46926','27394','92951','48842','50194',
                          '51334','14922','41410','60770','91921',
                          '36573','25015','53117','78283','43639',
                          '26099','79912','38355','20026','79651',
                          '56251','62577','99935','21616','28995',
                          '27528','26138','36798','12135','16692',
                          '50061','23743','89309','73004','77862',
                          '26218','68102','33904','72679','65084',
                          '67345','51210','47941','40961','90500',
                          '12986','97843','92389','17970','89898',
                          '76127','44963','29871','79742','19460',
                          '59140','44474','36091','94350','74677',
                          '88549','33545','24447','67447','40974',
                          '34882','73717','75197','97680','90690',
                          '43881','81394','97979','66609','98794',
                          '74202','42800','29166','57479','64995',
                          '76384','81585','53615','96357','72527',
                          '97007','79111','76573','90502','22715',
                          '68861','48813','31418','75807','95776',
                          '36690','62780','91045','23486','75167',
                          '82978','28994','45196','73270','68811',
                          '20668','84677','45680','27143','86277',
                          '49281','23888','87345','16585','96252',
                          '41738','51491','58437','58280','42330',
                          '13567','49926','20643','36575','92533',
                          '74055','53021','35646','61647','45623',
                          '46769','17222','99045','65361','89559',
                          '43349','19214','60876','44867','67031',
                          '31708','59159','78409','81101','20827',
                          '38282','46986','22132','68377','14758',
                          '19793','45231','56668','52637','79347',
                          '91554','28647','49708','63021','21366',
                          '47759','51602','12934','81862','85960',
                          '81199','41498','37062','48131','11100',
                          '39652','51893','66387','28414','37455',
                          '10309','55200','85773','53774','42140',
                          '59948','96411','15546','66081','64151',
                          '64290','62127','39008','60927','82949',
                          '87823','15693','67892','48227','46056',
                          '73896','66623','69519','30090','83768',
                          '85063','70982','65171','14410','14935',
                          '79528','41676','28224','99617','17227',
                          '58765','14756','11976','47092','78352',
                          '17743','53571','34097','94982','36052',
                          '88858','21842','12889','10808','79663',
                          '54358','91285','85969','74649','22291',
                          '82705','53062','44062','35716','23315',
                          '25740','88696','51091','61282','56472',
                          '72570','10846','86615','72400','81161',
                          '18392','84656','49192','79869','83647',
                          '99114','80676','81871','84075','25461',
                          '75276','88219','29037','59703','47387',
                          '85768','38873','77456','42560','46509',
                          '51295','44584','53876','63636')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


