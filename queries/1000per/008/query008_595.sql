
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '64918','13074','31291','19541','82000','54214',
                          '80492','79251','25958','22692','94312',
                          '46221','37138','58023','20336','18038',
                          '83892','73556','48246','83089','87004',
                          '51304','31480','19415','73501','46337',
                          '69176','73777','75608','35016','58161',
                          '13244','87397','10544','80478','94911',
                          '41991','58621','65269','83603','53062',
                          '57622','77746','21738','60771','45783',
                          '64160','30893','53065','56116','33455',
                          '33564','44125','79988','67607','38302',
                          '89353','52623','62800','58400','28479',
                          '71995','94124','59791','31822','19605',
                          '41471','60736','59066','25241','69895',
                          '25843','62000','70564','36763','21947',
                          '25319','63169','29465','26170','27820',
                          '19286','21333','94629','89941','27713',
                          '34476','10349','57392','78747','79668',
                          '17247','38648','73298','53828','55939',
                          '52504','97842','17065','79714','85263',
                          '42878','55014','36344','25844','97782',
                          '32625','70103','28090','22370','69809',
                          '64187','66308','89644','74144','11376',
                          '76007','61777','27773','60101','71483',
                          '36979','42346','13183','30416','63063',
                          '57451','44419','64999','64922','72099',
                          '21710','69594','16389','20775','90798',
                          '54706','38196','96761','81482','87287',
                          '34686','10430','70363','41575','56007',
                          '45744','61224','41712','88644','43790',
                          '39691','26860','22559','24667','47237',
                          '80581','99821','43552','93002','70054',
                          '36017','98946','81680','76183','27546',
                          '59585','18522','54248','60083','13085',
                          '39791','29547','27981','98887','27580',
                          '56211','35298','31358','81382','47562',
                          '92721','37006','67881','73349','34943',
                          '96089','67326','49180','18509','51758',
                          '64102','58007','75102','53488','45442',
                          '81975','74631','94861','31813','90499',
                          '44872','34647','67086','80852','47077',
                          '74515','25647','94294','45322','84847',
                          '23963','21290','69180','74674','11571',
                          '43233','27585','49415','57271','63049',
                          '69316','90389','31115','70061','68459',
                          '46141','56632','47503','55097','45598',
                          '10594','83498','33178','24096','41526',
                          '53155','19529','28646','62052','25081',
                          '22441','79139','29626','63064','75654',
                          '88737','96215','71878','82328','64574',
                          '95426','63570','40125','32187','87391',
                          '58331','93587','46886','32184','68852',
                          '92373','10354','49088','72064','51321',
                          '51024','76261','49192','27608','54049',
                          '65246','44491','54862','39795','50390',
                          '97338','30929','15507','47556','70695',
                          '30538','16475','46721','76446','34171',
                          '62232','39191','65486','49753','48319',
                          '97840','99322','29647','64679','47494',
                          '12481','55691','86721','92954','51925',
                          '32603','77518','73296','37461','45861',
                          '56319','95517','79099','14322','18923',
                          '58721','39913','34010','35541','99444',
                          '34396','35142','28013','79806','53658',
                          '29161','40424','56570','67254','84568',
                          '92191','86117','28156','14054','75340',
                          '94340','31636','39160','29276','17697',
                          '84855','33654','28041','47831','88141',
                          '65671','17493','86625','48820','27555',
                          '85558','63992','15552','43628','52164',
                          '84896','80534','46490','20989','62782',
                          '65934','97762','30608','39746','83770',
                          '75323','24394','80724','68247','98052',
                          '52639','58038','88222','63294','98234',
                          '34347','52304','85391','13633','47206',
                          '94216','93573','54027','11170','40637',
                          '62103','23587','79764','17277','81762',
                          '86513','59768','85430','59651','46880',
                          '28193','13632','45639','72914','23609',
                          '43898','76724','21137','23303')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


