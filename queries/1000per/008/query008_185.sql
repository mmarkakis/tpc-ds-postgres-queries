
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '48036','82287','35492','44153','48953','54132',
                          '44580','32763','38244','29037','40199',
                          '20349','41306','42412','11260','27146',
                          '76078','57962','18820','73386','94276',
                          '82558','69590','44374','46670','21987',
                          '88682','15019','67851','16123','92599',
                          '32493','76112','22599','56921','15660',
                          '93125','99169','96946','43890','41674',
                          '47015','44848','37400','24576','10251',
                          '33368','76639','37940','99833','87606',
                          '38489','11392','91937','75261','70653',
                          '78495','21811','47336','23979','39492',
                          '18635','18608','22916','40217','47059',
                          '57925','81300','84576','72331','18040',
                          '42254','16419','11848','50772','57912',
                          '56487','35802','65553','67026','99388',
                          '92226','88738','36739','58784','25768',
                          '64673','10430','55990','74094','29723',
                          '90826','83517','82009','91668','47064',
                          '38341','91929','30167','20191','89397',
                          '31126','45922','81319','53352','67034',
                          '54822','56065','17149','22516','61264',
                          '47464','32823','59153','74137','19074',
                          '80737','51039','85793','30101','29632',
                          '16381','59557','42103','40827','39156',
                          '27335','51445','42982','34277','82063',
                          '85055','88832','48078','15495','57058',
                          '84648','26285','50002','14660','62029',
                          '29619','78076','18634','89407','17963',
                          '96001','70773','37451','84720','55346',
                          '95407','74349','39950','36192','30513',
                          '27363','54292','99893','65561','76316',
                          '13648','86541','89071','82226','49211',
                          '14235','89452','95891','29591','61999',
                          '44479','63431','99870','63255','96601',
                          '73483','56240','36484','36119','63190',
                          '93352','73250','62130','67637','15867',
                          '11227','89842','12905','96210','53891',
                          '25055','85530','18071','15622','49823',
                          '35543','44287','86951','50820','36679',
                          '13980','97196','50417','69274','98645',
                          '16974','28660','46948','96810','27098',
                          '10028','33770','86771','76898','64357',
                          '52859','56516','92854','13755','86891',
                          '90786','89873','26917','75102','17380',
                          '26138','82604','24531','54627','22518',
                          '66236','13644','51305','82794','80842',
                          '22222','82988','66705','29782','33018',
                          '61656','15357','71901','44004','64502',
                          '55857','90833','24113','72620','85559',
                          '92188','44284','96294','85276','66708',
                          '46435','30164','24133','47105','55297',
                          '83220','15292','75765','38837','76785',
                          '50108','95742','90523','40670','71127',
                          '14399','88784','23524','89943','97021',
                          '96244','18237','88482','86593','41115',
                          '84482','95029','11794','83481','13189',
                          '93681','85360','33765','82586','94596',
                          '85509','18435','18978','89791','76712',
                          '56488','70355','69373','37408','90427',
                          '26996','15666','51828','56811','87408',
                          '45779','99617','47969','40598','16651',
                          '11140','98026','78206','73936','81478',
                          '12960','38875','26393','15956','92362',
                          '85165','20873','39726','93265','76026',
                          '84682','10691','67100','11853','87034',
                          '87628','32736','16820','94858','90270',
                          '59305','84893','29234','71620','75958',
                          '25148','47441','46393','40200','40391',
                          '62339','36052','66615','63942','79844',
                          '13481','18415','79678','28768','40974',
                          '64991','71941','27445','49781','25071',
                          '11254','64704','61856','56904','40253',
                          '72069','76402','95529','52945','52132',
                          '86763','64523','95072','18076','43248',
                          '50777','49910','66987','77503','42567',
                          '47816','49790','96608','45482','87355',
                          '41142','98014','21592','67470','31811',
                          '33265','33778','72039','30819','33419',
                          '73431','91074','67432','36060')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


