
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '51656','99270','45887','62891','76223','89800',
                          '35374','24386','74037','72909','56180',
                          '98962','82924','36608','24915','20430',
                          '84451','45595','74713','60766','34168',
                          '57948','27559','43410','89857','53987',
                          '34624','17005','60198','76112','15375',
                          '60773','24606','92260','58103','87136',
                          '79806','61336','27542','58917','83779',
                          '88410','60426','89625','39731','74048',
                          '63582','93914','66691','73140','54032',
                          '75003','88399','12256','27802','38125',
                          '89960','13476','57863','70735','85441',
                          '80521','90925','12430','88967','35758',
                          '32425','36526','93225','30741','93363',
                          '55516','49470','50754','89615','74382',
                          '94980','79975','55912','21449','42549',
                          '34497','63604','10772','67725','93324',
                          '22322','52642','68156','80540','49114',
                          '98519','64261','47877','84760','39685',
                          '62098','96247','33127','34647','79625',
                          '76071','51499','95586','79858','22481',
                          '21695','70852','85162','63015','45700',
                          '85591','27724','70451','50663','37273',
                          '21730','85163','36525','68269','86966',
                          '90658','64312','91445','62436','80043',
                          '77947','97802','12730','33628','85267',
                          '65009','88338','83020','26749','60027',
                          '76973','27445','18321','86947','53169',
                          '98456','75567','91632','34147','77734',
                          '91587','16563','49222','91648','86575',
                          '69505','16447','72206','13958','27643',
                          '79902','29144','50996','23882','93253',
                          '19351','47808','68863','16969','99786',
                          '92797','70483','91602','69399','37875',
                          '81846','52911','60680','81597','78529',
                          '10019','69851','20799','43241','94419',
                          '63207','67406','73585','23338','45899',
                          '37570','30476','59959','34903','74968',
                          '68801','62905','42044','17286','38228',
                          '66344','79664','70845','38047','14258',
                          '79374','43806','60270','48032','21043',
                          '56437','55042','59865','64891','13672',
                          '91670','61871','81038','86061','85889',
                          '41361','96555','76106','52252','79976',
                          '25816','59124','78719','94781','88031',
                          '82468','68787','70867','16671','68504',
                          '43755','26333','96906','88413','89525',
                          '91776','84162','56815','32682','34725',
                          '85812','57043','77542','96521','52169',
                          '68935','60644','35528','65891','23571',
                          '29074','61612','19471','30938','45161',
                          '19148','56397','52400','51679','74629',
                          '89657','45298','97874','63946','24943',
                          '25437','70757','60097','54458','19791',
                          '48774','57291','94015','79765','82287',
                          '61290','78676','80830','60107','12250',
                          '17427','22394','99361','61334','36455',
                          '80441','44720','35162','72558','71687',
                          '60360','58096','42994','31328','50775',
                          '10693','37320','26375','94366','43163',
                          '53553','82475','17742','25190','95969',
                          '19986','29046','61581','34713','95247',
                          '80146','83288','44615','16043','58906',
                          '27411','16314','65786','61015','84846',
                          '40118','93956','74052','63422','39864',
                          '11572','70335','56917','89457','22359',
                          '89488','84504','31898','86834','72078',
                          '95351','26277','81104','11539','60777',
                          '71536','26103','50278','59787','95271',
                          '12757','82097','29192','92846','35053',
                          '54436','61313','34214','36650','15808',
                          '98665','85730','80520','98868','68489',
                          '35807','83905','51535','18141','65070',
                          '97170','50561','28354','42969','30962',
                          '17144','97583','18786','84412','73314',
                          '52525','90794','93887','69333','35247',
                          '48384','11889','76575','61490','60856',
                          '13775','26132','18362','96099','35429',
                          '10368','29789','73556','94498','37942',
                          '31876','67403','72676','28906')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


