
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '37431','60799','25861','35378','63712','13412',
                          '88281','32300','78805','72753','98028',
                          '44792','71316','69182','45647','22991',
                          '97321','19165','24476','77735','65857',
                          '36017','59076','76655','15406','97642',
                          '80952','34325','72316','78890','33396',
                          '55156','74102','38116','55187','16136',
                          '54277','91707','50562','20990','91045',
                          '16528','46775','44769','79882','91749',
                          '46047','85354','78053','28364','64171',
                          '72860','95029','68431','27371','75874',
                          '40430','41112','56303','12192','40356',
                          '37143','34279','16627','59331','54780',
                          '74972','62174','45789','74515','65003',
                          '15234','97936','13228','59801','42370',
                          '25539','66434','62102','57750','42682',
                          '24939','75350','84181','30221','95331',
                          '44588','23394','67833','83164','52723',
                          '70110','97774','32402','63564','71732',
                          '46117','32609','73619','29948','38953',
                          '12529','49809','42181','17509','14438',
                          '95095','80291','31833','21263','71225',
                          '41354','79916','45059','87281','96053',
                          '49218','97922','67806','60675','79146',
                          '90375','87717','64237','40334','16246',
                          '55301','88920','54178','95753','32646',
                          '67973','57924','64686','96449','71951',
                          '23962','96396','59991','11688','90690',
                          '21364','32175','10611','37195','88242',
                          '51326','27158','31297','87860','37383',
                          '18635','86586','31671','30155','12133',
                          '86364','96904','64793','28029','71216',
                          '98146','60450','99800','12705','33638',
                          '87700','23553','82936','21087','77946',
                          '56244','60327','38150','55305','24063',
                          '81413','90777','87903','66165','68569',
                          '53885','83958','85126','13139','12538',
                          '92100','45291','23479','91743','50841',
                          '16464','58162','22931','89966','59310',
                          '36454','44006','64884','98092','87848',
                          '98629','16467','87606','50899','74662',
                          '74786','16681','66039','77904','44859',
                          '13101','13844','26515','62873','23692',
                          '89747','18629','21445','49683','54871',
                          '95656','91011','60715','96020','70635',
                          '38063','89897','20897','51372','98553',
                          '14044','28542','44504','83058','11752',
                          '25902','82782','75644','98446','16476',
                          '95010','14848','46543','87313','50364',
                          '53314','21035','90056','79652','81312',
                          '93450','97656','50675','88557','27298',
                          '26509','40755','33435','33928','75150',
                          '27248','81414','75811','86605','29045',
                          '82512','74038','98439','83204','71347',
                          '67837','97266','24994','33061','57613',
                          '77085','54252','76971','11503','59830',
                          '96181','55331','60150','35008','14864',
                          '61386','74321','48505','98002','98656',
                          '26753','69652','68958','48620','78830',
                          '56875','33859','56554','94153','71167',
                          '55543','31048','97047','14322','49557',
                          '28122','25932','38543','78993','13096',
                          '82647','70197','66954','84504','39973',
                          '88302','24524','60469','13563','61546',
                          '44451','29386','66231','72994','47185',
                          '25460','53435','93503','56901','50533',
                          '12700','56680','70317','88786','64282',
                          '36025','33418','25272','15944','10457',
                          '15160','40539','23039','20749','58682',
                          '64407','97610','14929','25750','59288',
                          '94696','31104','57593','30079','41359',
                          '36624','72788','11705','27190','78132',
                          '38548','77998','17067','58054','11866',
                          '53248','85785','24682','34958','32649',
                          '12576','58667','50327','48759','51233',
                          '66213','55378','47230','10506','97340',
                          '43082','87597','41230','40752','79230',
                          '81955','37657','69065','75384','26613',
                          '34992','42313','31680','39205','62635',
                          '42239','76545','85674','61663')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


