
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '92795','25030','26255','21635','84401','45896',
                          '96233','19105','42683','32335','30387',
                          '93403','61543','47055','17202','12787',
                          '46914','76816','57824','83609','59792',
                          '82756','17383','24584','47034','90764',
                          '72071','99845','34462','47218','19985',
                          '68770','14860','86670','63869','52115',
                          '19087','77867','79453','37954','85567',
                          '57095','34032','96703','67576','41753',
                          '50067','59039','67551','43420','24941',
                          '29625','82538','12013','75863','60046',
                          '47986','75239','64045','39741','22618',
                          '88888','48198','98756','11250','47715',
                          '61259','98366','30326','24426','80291',
                          '48110','93386','19432','31339','40554',
                          '24076','84207','87448','17286','95794',
                          '66672','11472','20728','44668','49250',
                          '77669','23224','38881','80583','77955',
                          '13375','94245','95341','27672','12933',
                          '10105','94044','68614','32739','79949',
                          '45489','63753','28590','70446','24931',
                          '52469','65039','50308','41018','14030',
                          '69069','31194','20611','53741','67169',
                          '64623','56767','71357','23677','81223',
                          '13012','78533','43353','80066','81358',
                          '89788','32261','63458','12136','81176',
                          '71520','51950','58970','56942','33523',
                          '60816','30222','95908','56572','35279',
                          '66153','47540','52106','96387','36190',
                          '94516','15942','14095','92638','77561',
                          '93809','47522','18954','31973','58893',
                          '79465','61024','50676','37621','75036',
                          '12061','64380','74989','11465','22682',
                          '75160','54142','84605','70028','33764',
                          '89379','84391','37874','35589','39733',
                          '45941','32493','67837','47963','33663',
                          '57191','77468','97675','40786','55095',
                          '56938','84549','31337','57366','12719',
                          '84540','95358','37341','58447','32741',
                          '96414','21861','26622','22481','81175',
                          '26141','60359','87886','31026','33901',
                          '61736','68155','73580','60172','46292',
                          '73472','19866','13903','31237','82444',
                          '39021','17890','95643','87383','55690',
                          '27320','14506','94920','88762','84900',
                          '21117','98507','73538','57807','10238',
                          '17303','82110','78610','64419','14430',
                          '76058','24122','79515','13182','26165',
                          '56504','22159','87765','97681','27103',
                          '55958','96618','33400','36515','43633',
                          '48760','58172','24803','71363','41697',
                          '63199','35590','96300','20885','27319',
                          '69893','62881','86523','41788','41759',
                          '27671','77170','77219','96864','50117',
                          '59236','97389','15452','45537','54602',
                          '53949','20255','66965','78102','33670',
                          '64978','71793','24497','92553','29267',
                          '88535','32837','57460','75511','25553',
                          '62698','12167','60702','92745','55848',
                          '67562','37741','40146','60793','90670',
                          '96133','51628','80609','45121','58945',
                          '90449','78825','77587','41716','37776',
                          '63852','59770','25415','33162','21824',
                          '52638','95847','34202','87063','77873',
                          '14178','91479','45427','59601','62947',
                          '58739','20719','88765','11468','59519',
                          '83192','72977','46853','68292','29095',
                          '29834','21778','16289','99052','95209',
                          '45749','33579','15680','62128','22517',
                          '91702','98731','85202','53884','10188',
                          '69086','30954','89644','76610','45421',
                          '59358','60817','61919','99176','58716',
                          '93470','95725','66030','21212','49217',
                          '83997','39069','96858','73998','26272',
                          '28289','87520','25357','19751','15281',
                          '28582','55330','68178','11709','36440',
                          '55028','63799','84675','90631','22242',
                          '31297','57015','96611','16292','70365',
                          '98342','78394','41216','78715','66958',
                          '44107','46412','44366','13383')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


