
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '35133','84712','44566','37284','21939','24822',
                          '65364','19821','75193','62587','79550',
                          '63663','15320','99381','73534','98786',
                          '61906','99484','13159','76781','96268',
                          '56784','75677','87147','18025','30975',
                          '48754','19731','56368','20366','25925',
                          '28344','10872','88649','76708','26835',
                          '91093','51149','91725','46505','45310',
                          '70079','48485','50089','56984','78046',
                          '26818','65038','59615','89179','49359',
                          '27839','86151','67815','96782','24641',
                          '34628','12627','48843','11731','53874',
                          '59863','76501','90225','16440','71278',
                          '52101','19716','44989','78062','93576',
                          '45049','59310','34234','25875','37146',
                          '47913','98464','93440','90418','90586',
                          '86250','92916','42973','25793','74555',
                          '57268','59803','60795','23956','52625',
                          '20474','22870','52732','73537','76145',
                          '67624','81166','87093','71442','51873',
                          '76511','64638','49109','36341','86544',
                          '50812','65560','39329','63488','66821',
                          '62773','20367','60182','82586','31029',
                          '42684','95550','50578','71294','27451',
                          '51028','28587','53405','36941','13679',
                          '80293','15696','76625','35684','62504',
                          '75956','48391','91180','61960','98245',
                          '23346','63376','53237','93844','55468',
                          '90334','98735','10027','92005','17918',
                          '33663','29992','25216','80711','84262',
                          '11041','34747','64632','48022','21157',
                          '63730','24707','79782','80579','80548',
                          '49222','54872','17948','25768','13255',
                          '37059','28907','51107','66879','83956',
                          '32003','33810','75634','90747','53800',
                          '13067','48264','25968','23546','62347',
                          '64996','36049','92491','14586','19267',
                          '74466','68023','86432','29090','46537',
                          '18823','88664','25066','63294','26856',
                          '13623','27237','12195','67032','44949',
                          '38238','15090','80062','68470','53517',
                          '46032','25121','25511','38961','40426',
                          '12750','11423','78580','19876','79881',
                          '25725','32487','11804','69839','26869',
                          '84174','15632','35833','43336','94720',
                          '91883','23361','70632','15128','47589',
                          '56670','13385','21621','51036','49831',
                          '76602','22551','87265','37318','69151',
                          '92638','57834','83114','60297','24704',
                          '88503','54491','29692','26826','93541',
                          '79835','93616','34790','32988','58633',
                          '67974','43866','39923','59213','82834',
                          '18564','89023','43305','49135','32265',
                          '17740','86701','47583','57394','19748',
                          '25765','43554','47437','31616','10816',
                          '83736','62578','23794','99019','67488',
                          '38007','89212','10945','69576','34524',
                          '53870','59664','52645','23997','57549',
                          '32479','51808','56020','60284','86590',
                          '40578','50075','44029','99438','17351',
                          '55001','40834','77166','51794','25479',
                          '73692','53507','90078','72847','53970',
                          '13212','80764','73529','54363','58013',
                          '46146','23963','52925','26191','27409',
                          '21216','68144','52667','42816','99387',
                          '37697','35431','27668','67040','11153',
                          '48837','72455','14743','23977','42488',
                          '31666','79428','87546','41121','75724',
                          '76105','42326','47532','52967','61682',
                          '24341','67413','26703','59826','78419',
                          '16138','78523','67771','30887','64641',
                          '40914','10665','52428','62746','80800',
                          '55266','63325','26110','91817','88443',
                          '88090','19955','19498','35407','70354',
                          '25752','72232','36171','39319','59232',
                          '79370','12117','19100','12233','97279',
                          '78205','32054','61057','61967','41111',
                          '66628','30479','63086','71435','73585',
                          '95650','29448','58585','22041','58332',
                          '76288','68707','14502','65451')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


