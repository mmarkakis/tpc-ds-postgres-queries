
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '63144','32373','94148','67308','21529','17837',
                          '56110','70197','79990','97462','82783',
                          '26256','18402','20898','57109','64111',
                          '31323','87640','44729','70472','87568',
                          '81573','65784','37415','15432','26308',
                          '75334','67809','83599','97580','61031',
                          '31737','14815','98118','18957','72813',
                          '72359','94935','96877','20196','84704',
                          '88545','69415','14773','50469','53996',
                          '11077','11846','74251','62937','11015',
                          '85096','23811','42297','49014','33293',
                          '78003','46054','49239','54093','15519',
                          '80381','35104','85505','43662','21895',
                          '93908','72636','41694','75735','98181',
                          '23164','63422','59304','75083','35363',
                          '87331','91101','27345','18655','39932',
                          '89982','64786','33946','62072','54297',
                          '59713','51094','89289','98487','90376',
                          '79347','92233','78161','55047','23670',
                          '21867','72960','50877','84961','90300',
                          '42472','90411','43633','95228','47235',
                          '22044','51791','56941','90626','57240',
                          '97920','58009','24165','57174','77566',
                          '90792','14726','77969','12956','59611',
                          '44586','98200','46316','67481','60274',
                          '68298','62877','48641','85748','91297',
                          '64653','98259','50027','30848','55408',
                          '17040','83949','91991','39837','30918',
                          '87911','98331','97999','35342','72521',
                          '16938','76493','99014','66892','29985',
                          '38746','23167','16894','93035','58678',
                          '89706','10955','73166','47192','20464',
                          '11444','58287','33362','44698','99641',
                          '25028','29456','68067','55745','35076',
                          '54620','18586','74483','48526','23742',
                          '88569','49705','50052','53641','58176',
                          '85384','18299','24245','40369','34435',
                          '11930','74336','55950','46921','65713',
                          '86791','60967','55828','15151','27422',
                          '53131','68640','12456','21291','33621',
                          '55462','93329','15237','47859','93393',
                          '77758','54843','22956','10582','58113',
                          '18680','31464','62360','66752','43897',
                          '28350','30323','53183','65631','11055',
                          '45344','33499','92364','56232','45276',
                          '92620','21970','82275','65057','84933',
                          '87986','85329','79104','95389','96501',
                          '29025','97114','36671','23015','39924',
                          '85663','28073','68038','92913','46056',
                          '24481','29526','69801','83342','46442',
                          '54642','79100','62191','58078','61717',
                          '51776','73939','63826','59491','93117',
                          '11446','48016','60941','78613','29161',
                          '14438','39604','68327','79986','71058',
                          '29029','22329','88716','97568','79693',
                          '22563','16759','17484','59422','11011',
                          '36538','55397','91788','35715','24847',
                          '14624','14431','83428','26327','50020',
                          '98153','63241','79433','11150','10331',
                          '16199','42964','40553','75877','97351',
                          '52812','97081','74715','91714','59591',
                          '57950','90069','99449','30853','77307',
                          '77576','88819','18322','58117','10016',
                          '43781','64558','13339','68420','35607',
                          '65052','21059','26440','22448','82136',
                          '20593','60781','12199','88053','83914',
                          '25491','16264','62723','14646','43352',
                          '24017','84365','72237','76401','62337',
                          '19101','21069','69128','36228','69747',
                          '91668','26828','27166','48892','82489',
                          '31772','11008','20927','79233','12959',
                          '89196','77456','19933','83548','34582',
                          '33737','59751','23869','51342','18848',
                          '27527','58204','40256','84106','95703',
                          '39706','46219','48634','51642','88119',
                          '57229','99826','68671','23834','81297',
                          '25901','94076','84286','95489','26225',
                          '97067','98242','45866','74850','68597',
                          '10720','89644','90148','90073','59531',
                          '73930','66295','95372','60572')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


