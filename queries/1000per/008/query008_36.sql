
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '75469','55647','18047','76975','96719','49121',
                          '59120','77333','80418','17202','16076',
                          '76048','35762','18327','76773','41352',
                          '39189','24695','32202','86362','27027',
                          '45643','25686','19013','36341','87566',
                          '68536','71665','48878','88228','38180',
                          '34758','47038','87274','27914','83637',
                          '55518','67192','34563','82829','70104',
                          '67445','31834','72366','63114','18710',
                          '65656','32522','96933','62595','59300',
                          '38136','72488','45325','60883','11901',
                          '48319','82360','28566','51835','62796',
                          '69567','85181','90149','75000','30901',
                          '26332','58740','20485','40262','22271',
                          '59131','22884','25248','50410','67213',
                          '51960','12779','97306','76352','70091',
                          '79384','79969','32334','88354','96360',
                          '18155','15532','22553','16684','84225',
                          '84678','46669','91330','32047','75759',
                          '53722','15830','31359','46459','33746',
                          '43250','97602','80373','86279','55885',
                          '43503','87679','83989','53260','35102',
                          '61929','24730','72086','39207','38750',
                          '83768','52097','74775','67851','23701',
                          '80146','60115','57632','74103','92207',
                          '33319','53393','82539','87198','74209',
                          '27294','43767','66854','36381','75470',
                          '84060','49830','61645','79740','14880',
                          '41094','38655','96981','73225','26375',
                          '68539','65955','67012','72284','63061',
                          '74079','45809','42938','11732','83452',
                          '59204','81984','71961','33738','78662',
                          '53808','44505','14500','27738','19224',
                          '44581','72497','72787','69316','84623',
                          '14390','11308','16747','37829','16792',
                          '20178','17454','32772','96901','65415',
                          '68551','86236','94292','86759','25576',
                          '95250','54058','82724','66017','54776',
                          '85582','46144','80160','49387','73809',
                          '61779','64787','68295','25993','72534',
                          '74087','10929','45068','78254','14333',
                          '49102','13118','71963','91296','47407',
                          '73430','61751','45381','13360','79959',
                          '41995','89964','74135','98517','32464',
                          '41568','89077','88588','28903','59447',
                          '44567','67506','52451','25729','71632',
                          '31898','88437','31999','87248','41103',
                          '14173','25740','43722','36652','67973',
                          '73995','59582','67863','61686','76190',
                          '57761','50761','45017','46823','54388',
                          '98559','70069','18715','21649','94412',
                          '77394','93180','17752','89342','36663',
                          '10779','95401','21502','25871','59839',
                          '23542','66656','80423','71792','76001',
                          '42750','48791','75222','30092','14191',
                          '29846','74138','64973','96744','85819',
                          '62862','37256','69513','82909','40337',
                          '34915','62169','98300','35861','39187',
                          '34388','79304','19730','53922','10686',
                          '92457','96980','29633','20953','39277',
                          '52037','45814','89494','54129','44692',
                          '54244','26143','31771','62104','65517',
                          '58643','97195','29704','79253','74212',
                          '25506','63641','50689','90602','44697',
                          '97291','47826','57303','93077','50350',
                          '21327','17382','50011','84895','44942',
                          '73451','87537','17150','62605','74900',
                          '58042','26792','63152','32998','79941',
                          '34538','46121','33820','78751','13177',
                          '79618','84649','76310','47518','35173',
                          '11358','36796','37621','40821','18146',
                          '16799','56584','97883','21385','79351',
                          '47899','24767','57048','27982','14787',
                          '15156','25261','41246','21064','52338',
                          '13650','88223','38718','95300','53082',
                          '13089','31077','73312','13769','63261',
                          '64706','79798','19191','86904','44701',
                          '79025','43308','40257','37655','39345',
                          '69538','74650','81459','61721','18207',
                          '10768','18537','99024','26258')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


