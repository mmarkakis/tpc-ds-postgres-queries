
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '20923','33561','46089','33526','31822','33398',
                          '19509','49136','57600','62450','75129',
                          '83286','41510','84601','37276','89612',
                          '57276','15267','10950','38421','98582',
                          '56506','44263','22910','56560','44051',
                          '93998','41115','54528','71999','66162',
                          '11774','68458','32033','47412','43142',
                          '48742','64470','71405','15784','16055',
                          '74293','36525','35012','98910','39547',
                          '25612','72315','75842','86557','82125',
                          '42742','75105','38998','17168','28157',
                          '45423','59170','84285','63270','47225',
                          '97034','15795','91534','70754','46802',
                          '96119','96270','18044','80765','56439',
                          '92905','10053','90968','58501','16937',
                          '31802','92819','36372','73889','47753',
                          '97995','19280','42965','49847','29202',
                          '34902','98999','99801','71944','18261',
                          '87765','50551','91848','50702','31726',
                          '98123','14479','99210','42996','36942',
                          '87302','19616','41624','54939','45174',
                          '22702','78331','56682','79012','70547',
                          '81328','43025','71545','50417','81942',
                          '74327','96573','31981','48128','47674',
                          '26755','39543','83243','66167','35129',
                          '45934','24204','75945','81761','55893',
                          '45378','76076','26678','17820','23478',
                          '94360','59836','43853','36817','59233',
                          '85490','34728','31135','90347','82602',
                          '50300','61808','84622','91491','30151',
                          '28033','16861','54493','35799','80384',
                          '91613','25711','65038','41672','18869',
                          '33383','34912','54138','59296','74957',
                          '87292','21652','86533','86171','25607',
                          '81579','58006','47267','92536','83587',
                          '79421','63365','80909','23854','57959',
                          '19109','58235','64730','37173','89391',
                          '70623','37395','81941','62327','51876',
                          '35469','81272','47137','19433','59038',
                          '30478','17980','26895','76646','85927',
                          '57661','34996','67417','31167','13696',
                          '93161','82982','27599','29435','94758',
                          '47057','37941','71050','95531','63545',
                          '59703','16307','69370','21444','29427',
                          '59164','18768','32329','28976','14540',
                          '22708','45454','19115','16715','30657',
                          '84699','39585','46239','48161','57339',
                          '68889','91224','33769','28087','60569',
                          '10562','39109','47819','52407','59625',
                          '52050','41218','87980','77480','59714',
                          '13342','78261','20475','36146','50574',
                          '87904','22325','70940','80218','39126',
                          '35413','67222','26812','13581','49506',
                          '15285','12931','30908','97690','23554',
                          '53440','35997','50907','83451','27603',
                          '90717','46754','25138','98623','18843',
                          '97965','75450','97068','39177','49552',
                          '94872','47713','55839','15332','69428',
                          '62621','98827','64033','89986','91480',
                          '46713','94119','14639','24317','13080',
                          '11574','90081','30412','23104','88887',
                          '87498','76082','47706','54572','42548',
                          '96983','84610','49840','63295','45265',
                          '94098','21398','33474','74304','24495',
                          '33716','23616','35968','45641','17064',
                          '41409','63761','67278','99817','80334',
                          '27438','44368','87697','37798','73320',
                          '52519','95334','92640','52489','55916',
                          '29097','54625','85239','41305','58553',
                          '63366','80073','95732','11568','72736',
                          '27713','84522','74385','65899','12359',
                          '58150','45921','81439','96021','42917',
                          '65200','71583','29350','42773','10787',
                          '31444','28187','58798','49725','90529',
                          '83607','41701','73483','94085','85660',
                          '17011','45239','43258','13935','95857',
                          '23737','72512','92581','76966','42285',
                          '40378','17551','89642','16241','84826',
                          '71320','86890','86796','81636','56839',
                          '90817','80942','80357','58473')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


