
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '66193','83720','91293','30885','41205','48286',
                          '58050','57909','41347','37399','35024',
                          '70412','69015','27869','49899','51104',
                          '21470','57040','78682','13014','40294',
                          '55325','65527','18123','14706','76036',
                          '11098','85372','33888','71996','74872',
                          '98084','49264','79143','93827','98776',
                          '37079','18348','77910','48830','25751',
                          '18964','88222','75294','93575','67147',
                          '48645','27724','60169','22695','79087',
                          '83785','52703','72040','22157','59912',
                          '51418','68721','47408','30210','47742',
                          '20924','70922','39840','46835','92702',
                          '10440','57594','40420','36434','98072',
                          '49902','89444','90170','16647','52523',
                          '15385','99703','72554','23960','98940',
                          '44585','14753','75258','83730','86851',
                          '89366','12286','16303','15882','52770',
                          '48677','68185','45610','27141','88272',
                          '86564','47867','95666','90297','92923',
                          '15224','79355','59610','77718','93271',
                          '84512','84383','18836','69846','77161',
                          '18799','44166','72187','38039','50068',
                          '86029','19236','91165','37571','31109',
                          '58527','42146','52761','91126','11580',
                          '84855','78646','72560','29175','62766',
                          '35520','69937','85317','63000','16466',
                          '31240','70766','56512','20525','94733',
                          '18368','23924','77035','71157','13805',
                          '89492','90372','26272','81472','82307',
                          '28263','42925','48539','19751','77559',
                          '74007','79902','42592','21815','89942',
                          '84706','32079','87477','20210','61257',
                          '54224','98148','46029','21212','48789',
                          '42883','17916','56055','60752','93907',
                          '84854','37075','14821','35847','70774',
                          '97616','62139','26498','88321','59265',
                          '27271','73207','72769','58517','16420',
                          '89070','89663','48416','83185','26447',
                          '45992','83415','46536','52742','84812',
                          '60177','48561','31368','58623','41761',
                          '41480','68634','39562','61828','36104',
                          '98286','60208','52878','76168','14029',
                          '42733','69858','20214','72432','71428',
                          '34703','40866','93138','86267','88682',
                          '68690','18764','59012','12585','62970',
                          '95245','57054','20627','78519','70101',
                          '73994','20686','17135','17412','24498',
                          '56438','13350','20182','44825','97794',
                          '43678','66440','32707','91765','95579',
                          '19743','80309','54720','89887','57048',
                          '78944','45496','66671','21526','64279',
                          '91461','74819','53079','35796','50283',
                          '91346','98667','16533','31533','88887',
                          '86264','60265','53651','27049','95139',
                          '21148','55469','23838','12294','14838',
                          '33757','35313','54000','65555','48131',
                          '97362','72138','57137','51508','92384',
                          '51853','17700','43610','95213','37169',
                          '69755','72265','84517','46420','96630',
                          '39200','51576','44461','75032','51424',
                          '28313','41419','91079','78548','42270',
                          '17908','77361','17470','30091','16698',
                          '58565','29949','40831','79981','81278',
                          '46537','19312','23526','40302','49566',
                          '24505','24272','42890','70188','42765',
                          '77213','11350','29809','91744','26148',
                          '21973','25591','28219','77799','17885',
                          '31712','69515','84633','95208','54968',
                          '89528','39170','39213','57338','49210',
                          '38395','75172','99321','40573','85081',
                          '21916','96515','90893','23976','51431',
                          '17691','76730','43396','23265','62224',
                          '21327','38755','97468','81117','66406',
                          '95924','76021','30982','82352','73044',
                          '63401','87306','22128','22182','73214',
                          '95858','57847','62060','87578','84417',
                          '13614','68941','69189','71445','82174',
                          '44423','38547','49995','21769','72768',
                          '18483','76597','50239','83979')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


