
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '65173','17209','79081','31453','20793','55849',
                          '99405','33762','30072','45110','97080',
                          '65980','36064','55749','43052','36477',
                          '85386','14946','42061','67776','15261',
                          '54376','37694','38994','28532','48689',
                          '24729','91782','11156','22556','17593',
                          '57353','91289','99132','35327','25893',
                          '24002','11005','87623','13606','11109',
                          '49992','19309','80688','41694','54272',
                          '18851','34949','51371','44709','34768',
                          '11033','80932','73942','81371','20876',
                          '94713','29031','60698','42975','71890',
                          '23843','94114','13434','79006','51660',
                          '86126','91142','86586','99608','44623',
                          '45516','87838','16226','40815','33584',
                          '94778','69900','49921','31702','27142',
                          '76045','51109','24393','58351','81061',
                          '11811','79399','82810','28899','60992',
                          '22583','63668','58587','34851','74844',
                          '90344','47837','47913','73358','20589',
                          '24989','94530','90378','80146','52659',
                          '13087','21213','44690','75723','63311',
                          '65015','72129','28305','83179','27697',
                          '22280','65920','98566','31399','28681',
                          '46256','60540','12597','24721','97089',
                          '88030','25950','20002','65875','47163',
                          '54621','83805','85980','23533','82133',
                          '61382','82296','43087','99429','79346',
                          '57449','15771','78156','68579','80032',
                          '81757','67147','66489','45664','17908',
                          '11602','36582','47777','40580','90894',
                          '89347','77754','71385','29944','36100',
                          '71520','86827','18166','18316','25388',
                          '20966','90593','57370','97163','31266',
                          '42965','37258','86135','54784','20288',
                          '50249','59163','29797','94872','70438',
                          '66167','27399','31391','40601','91853',
                          '60024','88639','52225','89744','23927',
                          '65913','95767','53150','69798','36311',
                          '53634','51414','72306','30332','55017',
                          '49118','44959','98356','36411','97270',
                          '88857','96774','39718','85070','48096',
                          '94095','27774','64051','58782','35270',
                          '74217','85872','93260','95321','60476',
                          '44470','62855','92584','31241','37285',
                          '73056','89681','95344','31226','65318',
                          '37243','56225','23619','53193','55800',
                          '60614','86141','30391','43418','21791',
                          '35606','80506','23092','94864','29864',
                          '83672','35065','19159','92956','83547',
                          '13438','25372','77814','30142','13061',
                          '27981','20331','18935','10561','31827',
                          '53032','21387','95380','31142','38884',
                          '42310','78682','34481','62915','51581',
                          '50316','55053','86037','91956','13452',
                          '27435','56296','21209','81923','31137',
                          '47783','70470','99983','27346','95219',
                          '89052','14513','37861','63876','70626',
                          '93159','65988','12511','56854','67011',
                          '47262','34235','81143','90373','78618',
                          '56510','93236','57571','49328','43011',
                          '17063','64317','51123','97577','55724',
                          '55089','59384','97810','61992','50749',
                          '28458','66201','43697','47112','60653',
                          '72905','89645','36216','32303','83834',
                          '98866','80869','77983','71220','17379',
                          '90800','58590','88143','19773','52950',
                          '50050','21000','87028','41799','66914',
                          '45039','35690','19578','62709','10601',
                          '71499','28589','55354','47426','47654',
                          '13889','23283','10728','97337','28163',
                          '22920','37434','45517','65365','47983',
                          '25172','58370','98214','90813','41632',
                          '30954','77142','42987','95731','72431',
                          '65648','27076','91187','71349','36093',
                          '60771','48432','16700','86882','48823',
                          '24558','85876','91316','67583','25814',
                          '35088','30463','70884','47870','20639',
                          '36263','31351','32041','72363','53128',
                          '33159','29794','46214','26880')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


