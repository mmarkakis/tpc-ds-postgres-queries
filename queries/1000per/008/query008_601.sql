
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '35145','96815','48838','50914','10293','29641',
                          '19999','57668','36088','93222','17975',
                          '34342','94740','82959','60455','46891',
                          '88580','90614','30558','87523','15364',
                          '75566','17812','11601','52746','15236',
                          '12267','92911','87354','61250','94791',
                          '57770','10443','30185','21907','12232',
                          '80215','79369','63044','71192','74730',
                          '76233','93063','45887','54360','54790',
                          '97978','37137','42336','44098','91539',
                          '85922','18625','59727','49172','16136',
                          '74989','91938','54848','18867','56852',
                          '58418','64493','89614','67995','38214',
                          '46579','24570','49570','82155','65866',
                          '94938','75976','70906','69866','99651',
                          '18689','37987','39945','67866','37849',
                          '31304','11114','11474','33886','24916',
                          '86839','31600','10587','49469','69115',
                          '33458','57540','51670','24609','85948',
                          '76213','25448','77975','56304','12203',
                          '44953','40211','45793','35184','26029',
                          '58791','78460','54424','98344','97145',
                          '36391','28123','59991','77175','19735',
                          '83760','50894','28133','67621','78923',
                          '20700','91839','10872','83905','23692',
                          '19519','35599','59030','20003','60915',
                          '66799','65521','32530','73273','60926',
                          '71121','38300','17420','74012','96482',
                          '64827','69075','57988','68109','62362',
                          '24932','13880','27455','74092','39920',
                          '44312','45559','74560','87645','19954',
                          '13950','51657','49293','14568','53246',
                          '42269','11732','26028','97269','79171',
                          '71876','10087','63621','87259','40162',
                          '64600','95998','17282','88648','54615',
                          '92795','68629','92576','10159','80270',
                          '31204','57271','88001','21310','47693',
                          '59943','67599','13146','78446','63475',
                          '50802','77312','94183','83606','17467',
                          '73546','24029','86701','72171','36396',
                          '12691','52190','83277','13409','63154',
                          '55010','99830','27116','17087','63581',
                          '69063','68114','34403','94423','45297',
                          '24258','56729','36399','28642','12135',
                          '42626','16897','49905','44246','57736',
                          '57587','26340','11571','51216','39128',
                          '41977','53375','33662','33229','28289',
                          '30142','68882','83594','12323','98702',
                          '75823','52757','12837','48071','98386',
                          '23118','59561','49884','76470','68372',
                          '84240','54670','24749','36347','63060',
                          '71306','95012','73481','73740','67144',
                          '26870','41885','14775','22560','76859',
                          '18178','58387','87540','77527','51904',
                          '70474','17354','96845','72708','45807',
                          '78077','93046','56359','59494','53927',
                          '96661','74395','98036','64380','94588',
                          '95563','89245','65975','94795','86943',
                          '42485','91874','68143','70987','17249',
                          '22584','59043','44305','20325','11907',
                          '83402','19585','58088','22812','15955',
                          '48945','62103','38706','76604','74450',
                          '58424','35707','65342','19602','89205',
                          '77360','75482','18174','79551','93223',
                          '37637','51600','61748','10651','70097',
                          '53247','13764','22556','35131','57472',
                          '21235','76030','97869','86915','51333',
                          '91553','37395','83714','67320','65918',
                          '51616','64780','37706','75020','92530',
                          '65353','86957','84947','85787','76703',
                          '56029','98745','28569','38879','35518',
                          '15787','14803','14582','22409','46141',
                          '40990','82018','35653','35156','51924',
                          '36737','97715','34082','29249','45434',
                          '71134','13170','24304','53934','60464',
                          '36306','61285','21559','68687','31037',
                          '32402','47924','51755','27914','21714',
                          '85237','19555','74080','12882','76014',
                          '72306','37390','23011','66000','25159',
                          '89872','52283','42912','61434')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


