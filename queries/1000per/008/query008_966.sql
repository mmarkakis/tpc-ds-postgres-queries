
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '49507','48976','71253','18645','83988','47055',
                          '54839','37219','53459','54221','20282',
                          '93630','91308','52837','32449','95504',
                          '63163','25207','63712','73508','68647',
                          '17544','33669','92993','52795','86458',
                          '56118','13688','96175','17543','60266',
                          '26256','39858','85272','49479','53651',
                          '31020','92790','43557','13104','82505',
                          '56442','28606','99498','15375','31251',
                          '48921','35998','47105','54951','10959',
                          '13636','71840','63417','63341','19562',
                          '86555','41887','97604','60153','69225',
                          '96001','15668','90819','23008','95233',
                          '77523','42160','26834','86887','13587',
                          '32504','95419','42306','40728','14964',
                          '40741','89370','95292','28178','10255',
                          '40914','94329','71362','32906','49361',
                          '81127','57801','92400','84161','92245',
                          '36819','74962','22479','57292','37846',
                          '34031','64436','19551','84182','76342',
                          '19274','56045','34588','31657','37307',
                          '89634','21340','15968','53093','67431',
                          '63435','23009','36693','65428','47143',
                          '29889','77028','76257','57296','18800',
                          '79522','13305','43498','96547','89928',
                          '99510','93744','15686','42909','10471',
                          '37317','17959','51562','77001','78457',
                          '82464','76844','95468','56348','64039',
                          '30973','42554','95257','15626','37114',
                          '15313','22767','78851','75387','76855',
                          '93378','48965','47519','80289','22228',
                          '85069','30198','58292','93934','62503',
                          '35698','98005','52340','65712','23054',
                          '96882','49083','54064','20518','76386',
                          '36244','37309','66763','40035','85489',
                          '62095','22981','22726','30355','76764',
                          '99861','32482','64103','60138','41285',
                          '99645','80779','29952','91559','49406',
                          '75595','50000','26086','52604','61113',
                          '29383','36659','26463','17895','43660',
                          '78608','77963','17153','81852','32028',
                          '30335','85140','75889','41609','50178',
                          '73027','34159','10130','96878','57815',
                          '74378','50749','28602','78363','79488',
                          '96724','73571','23596','98213','61939',
                          '89999','55846','88795','13177','17980',
                          '49709','20469','98879','22376','39661',
                          '65038','64558','98493','24194','50669',
                          '57016','93772','32324','20161','78499',
                          '43943','89531','14630','67819','67198',
                          '21498','24147','13993','32166','20182',
                          '16632','51756','44537','62065','86793',
                          '30075','52034','28910','33145','35494',
                          '83544','80247','21418','36711','78277',
                          '89887','47807','83686','41835','44683',
                          '21559','32940','65176','25157','74506',
                          '59010','83985','80946','74536','49359',
                          '52258','62178','59063','50010','20795',
                          '30727','43858','65130','60958','85097',
                          '60415','81882','42164','35742','49498',
                          '56053','17071','30540','21659','50308',
                          '45376','24576','57473','50556','24397',
                          '15117','28917','92813','16932','63392',
                          '95298','45353','20626','93094','20475',
                          '67978','40324','78056','70058','75186',
                          '59067','47688','39419','89958','70804',
                          '42816','21071','81024','85492','52661',
                          '27137','96332','50451','76403','82059',
                          '37905','29703','16313','71120','23345',
                          '82021','97632','14573','93052','79735',
                          '59810','46662','97994','38355','14350',
                          '88091','12912','88174','27554','81528',
                          '48556','52920','80401','33731','88617',
                          '95724','22667','81205','89390','17736',
                          '47071','53693','63386','39564','58368',
                          '72325','37648','29761','57834','97471',
                          '95161','51325','80763','32159','43435',
                          '80476','76587','88437','99344','87088',
                          '53536','49905','95450','27711','89502',
                          '35373','27764','90604','86762')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


