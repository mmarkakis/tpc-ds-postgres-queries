
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '31187','35323','79863','61646','69740','88668',
                          '99246','10697','84146','99099','47537',
                          '53759','56681','24654','40802','25533',
                          '23441','59029','92004','60327','40697',
                          '12651','77444','84252','69658','86957',
                          '90816','57854','20680','20123','21069',
                          '56676','40581','43998','50460','22509',
                          '79324','57131','14208','29651','37443',
                          '11824','49252','88542','42736','88302',
                          '26360','66406','11116','25959','86918',
                          '64508','44360','81013','90683','28898',
                          '83671','96234','30565','37130','86158',
                          '46934','55800','46679','35281','24562',
                          '28232','13178','25430','14656','17761',
                          '84384','49354','71434','91337','69018',
                          '29690','76622','49664','69982','78477',
                          '35419','51237','53891','84857','92872',
                          '71294','37630','46484','35907','38609',
                          '89193','43462','36239','36646','18587',
                          '86720','85435','76963','12205','16382',
                          '94689','23731','61140','70610','44880',
                          '96986','15215','97290','75487','24346',
                          '83345','50033','48987','94727','23139',
                          '45374','86771','50093','31955','95495',
                          '29899','88565','52525','72507','20847',
                          '88355','68829','56188','35309','83362',
                          '21066','72914','51713','30178','25535',
                          '99272','46456','22958','22437','52664',
                          '69180','36541','49142','16595','75684',
                          '81185','72714','78917','22471','39835',
                          '31289','25466','47854','19207','21072',
                          '86530','80644','90945','72615','14205',
                          '97194','66477','80838','77979','34546',
                          '37714','27066','58097','92971','46781',
                          '92530','34746','51636','22632','51628',
                          '24435','66858','28985','86841','41369',
                          '62635','63970','56471','41886','70896',
                          '49564','19761','56255','27488','67056',
                          '21086','75590','47937','20957','63810',
                          '62295','46637','69984','16686','23874',
                          '76227','67941','52294','55199','46426',
                          '10340','14396','47164','31908','97050',
                          '76134','77289','35553','60787','13647',
                          '21668','54818','47426','84514','77069',
                          '94194','55988','60590','72148','90576',
                          '66375','99401','93045','41831','33924',
                          '20072','88635','34980','37887','69363',
                          '86463','14567','39753','61881','87387',
                          '37327','12689','55499','44322','13918',
                          '48278','13708','73970','14709','61636',
                          '20266','95736','82664','79198','31818',
                          '69998','29637','49501','59337','80038',
                          '51539','92281','18048','39420','60591',
                          '16710','94381','85168','88546','78089',
                          '72910','59178','97339','56840','28855',
                          '40757','29729','53327','33488','90298',
                          '68757','13631','27483','84818','32926',
                          '97259','13710','76330','64630','55688',
                          '71486','27893','17873','67753','84501',
                          '76590','71209','30422','10957','70899',
                          '27722','62879','96319','99821','79796',
                          '29173','75693','88926','55886','13437',
                          '35422','66524','83387','28307','69863',
                          '22975','61464','18218','24049','81235',
                          '40777','34567','60957','24010','67053',
                          '39809','28917','82146','11450','26970',
                          '67681','97802','33066','31301','24442',
                          '58912','33270','57792','45354','60499',
                          '20635','88255','33436','21338','40318',
                          '54919','89769','19020','91455','23962',
                          '50199','62786','44858','61863','89497',
                          '39904','10274','80766','55838','69160',
                          '72971','12230','79729','69115','43557',
                          '71193','94071','17228','51249','55040',
                          '65404','84214','46845','91332','65865',
                          '42658','49356','62589','63054','63983',
                          '59300','12896','23555','77176','11170',
                          '56477','29360','10527','83368','20263',
                          '71282','68127','67885','46641','13583',
                          '11919','71091','92277','68392')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


