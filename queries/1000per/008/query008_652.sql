
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '49800','60775','44906','87770','34647','63759',
                          '72098','12741','97520','40367','93525',
                          '96258','82984','64147','96662','98211',
                          '46521','25010','73968','10489','73104',
                          '16794','66154','63913','84554','99565',
                          '71233','71119','52500','98260','49825',
                          '20463','60462','93263','17585','36714',
                          '34955','14131','41350','54608','26177',
                          '89318','58281','97377','67007','51102',
                          '85297','92243','14437','86321','79620',
                          '62353','15692','34223','73786','73159',
                          '39328','10897','29978','32765','93206',
                          '65283','39495','74792','14195','67868',
                          '82380','81495','44426','66623','89855',
                          '47572','45354','94629','44566','80139',
                          '70554','50897','82576','97341','53534',
                          '48852','23806','99447','20595','36775',
                          '39943','33808','88864','12878','95301',
                          '55389','76914','83427','50996','94308',
                          '14750','86395','86655','26941','59657',
                          '37099','97212','63474','62367','32507',
                          '82103','11875','25442','40472','15424',
                          '26046','76877','60883','20331','72338',
                          '79403','90059','24009','15654','16408',
                          '56184','41022','13068','37543','20766',
                          '38129','90994','85838','31293','62460',
                          '11779','84243','55508','58643','70831',
                          '76613','40853','70826','71827','30395',
                          '45131','14430','31471','50234','28137',
                          '87956','69813','85962','94680','13509',
                          '25750','69349','89589','71497','95603',
                          '91554','61826','19668','91753','66829',
                          '22464','68633','34222','92991','58896',
                          '21343','19781','67541','62995','32380',
                          '99156','67703','91366','51238','89390',
                          '42553','77388','69783','99778','57509',
                          '39702','44773','52900','77268','59049',
                          '34441','89256','53117','98678','75759',
                          '73265','10817','34416','32400','30237',
                          '54811','60806','39379','58819','92026',
                          '81750','75939','85486','79818','27321',
                          '78622','54036','97663','75301','47032',
                          '19079','81178','19785','54340','96158',
                          '33647','78935','90119','42862','12371',
                          '60601','61530','44700','34492','49341',
                          '21187','68774','55301','17940','13559',
                          '95189','31125','78834','55569','18530',
                          '92432','43279','64254','36813','47982',
                          '45023','94345','93534','74895','53192',
                          '49195','50571','19610','76374','98639',
                          '81820','42155','20655','82616','23366',
                          '34108','97943','16385','71219','14797',
                          '37835','35152','78291','66631','47581',
                          '75275','57532','32809','41944','62171',
                          '76464','44297','79034','31712','47204',
                          '40023','99404','16554','58898','92774',
                          '33375','96010','75760','14311','82965',
                          '73659','98422','20211','46326','69788',
                          '11056','24555','66291','52429','99108',
                          '60281','96371','57875','74732','33595',
                          '49713','72221','40365','85750','13049',
                          '57036','34412','76371','69609','96141',
                          '14910','96780','51380','51891','43039',
                          '31421','98476','28101','53373','84439',
                          '99181','81073','28716','68580','48615',
                          '26975','79162','62987','97976','21326',
                          '41388','16785','61603','12331','41591',
                          '21836','14149','18925','50847','18444',
                          '45060','34014','67834','93134','45342',
                          '65636','54183','77336','86524','86146',
                          '43656','28496','70657','90494','38161',
                          '61556','15020','53997','57998','75395',
                          '34542','61491','22176','64005','10178',
                          '11860','18208','66738','82398','32539',
                          '50411','22574','98776','89009','75476',
                          '79761','88978','86175','25679','78919',
                          '53348','86253','22565','72495','75771',
                          '88279','86808','73951','74445','82779',
                          '63532','37741','90570','12682','60622',
                          '27977','31780','67246','96077')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


