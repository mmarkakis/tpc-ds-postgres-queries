
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '81155','91905','69558','35748','30381','61081',
                          '22701','50151','90536','88852','95165',
                          '97500','23676','77747','26943','81615',
                          '99500','69590','77178','53323','61269',
                          '45518','65206','20138','65987','32300',
                          '35259','15979','37230','90402','52631',
                          '18539','82634','90556','19024','66691',
                          '88163','35327','35803','19894','11147',
                          '30739','16584','85540','74529','75438',
                          '33116','47317','83842','51385','63802',
                          '98869','98165','46772','93259','35798',
                          '80390','82021','35651','82930','86012',
                          '60023','29022','71669','25646','53436',
                          '35178','80475','33075','65339','12611',
                          '17150','92375','42386','89212','72939',
                          '81745','83402','28207','26402','73397',
                          '16710','88000','96568','37222','89556',
                          '91382','35604','57179','79176','47477',
                          '22743','55631','92319','47452','40752',
                          '79134','10266','62532','24472','92172',
                          '93140','25513','54469','22792','82055',
                          '82715','12328','67748','19319','70839',
                          '44172','97000','48670','97131','75771',
                          '76423','46139','78738','41175','60957',
                          '47967','18220','12031','95355','21499',
                          '67154','53168','16364','98538','75365',
                          '15763','27324','71663','33786','25864',
                          '39249','57774','22993','21533','82560',
                          '56484','33378','32449','66314','76186',
                          '15149','34524','58460','55060','53981',
                          '91747','26355','57894','49190','89426',
                          '76673','24646','65666','20615','72312',
                          '27737','45220','90452','14945','47342',
                          '95506','40833','10693','22125','68314',
                          '68286','43559','73857','43373','63230',
                          '13840','59608','18707','20292','77210',
                          '35943','30112','12305','66212','52417',
                          '42377','64040','26778','10870','33435',
                          '83444','19307','74043','33095','80168',
                          '69382','26327','76253','48594','66449',
                          '53762','65340','78710','45081','11332',
                          '35323','65921','64653','96920','34480',
                          '12833','36025','92159','32406','83391',
                          '82883','34741','46691','96253','61186',
                          '86639','21099','73934','77309','26274',
                          '66815','43324','60995','93528','40452',
                          '96089','95388','25963','83817','48173',
                          '41315','72980','26969','48395','70996',
                          '12741','13391','33682','75056','37899',
                          '20618','26953','97126','31047','79400',
                          '13394','51591','83743','39682','68831',
                          '24237','34290','21442','86750','74953',
                          '82899','10339','96796','16836','10223',
                          '76010','83737','63957','66151','41779',
                          '94213','99036','74819','89684','19777',
                          '60039','75263','58105','98616','87081',
                          '92694','66146','91727','61222','44374',
                          '20019','57950','77034','74443','15390',
                          '74549','57294','90127','39620','47265',
                          '26252','81616','75770','75349','85292',
                          '61396','86240','90161','53803','92598',
                          '66352','68130','35945','95991','18387',
                          '68175','45427','99131','88176','37562',
                          '71950','23171','91659','64159','74414',
                          '88848','52105','36083','34958','30012',
                          '26178','47903','92307','74456','41145',
                          '18704','60356','97967','41639','88813',
                          '22252','45413','45259','96056','10506',
                          '19854','56938','59536','64430','31521',
                          '61194','87621','82779','84470','72412',
                          '38105','51695','36790','18727','22918',
                          '93521','96636','56699','64515','81323',
                          '33918','62479','31548','78541','24776',
                          '11255','51481','32172','50051','44849',
                          '68359','37215','87224','52885','41170',
                          '95964','62456','25306','98898','14294',
                          '51900','69394','85085','55551','77808',
                          '31112','34212','44401','58116','57057',
                          '89799','61677','37089','23888','91736',
                          '50003','85939','89367','58020')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


