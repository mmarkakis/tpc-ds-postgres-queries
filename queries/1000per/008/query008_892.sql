
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '56055','52650','44658','59916','74013','11149',
                          '95938','29826','11175','65447','61309',
                          '68234','19603','79267','64632','62379',
                          '65334','60995','38586','57824','21245',
                          '82128','43439','36993','32524','54203',
                          '78418','64242','24846','80641','76627',
                          '74105','22198','93536','55172','28430',
                          '46548','43969','85148','55731','97059',
                          '12895','64959','15646','55032','11919',
                          '36376','41062','32676','89333','87317',
                          '25290','85228','63011','83596','81050',
                          '54135','15701','89589','52630','26594',
                          '51736','99563','56588','47250','28614',
                          '48751','17462','35283','41585','84723',
                          '64186','73832','27893','93510','45762',
                          '23320','90047','17656','11204','93105',
                          '76196','61630','74516','34412','56070',
                          '34374','48434','88291','38803','36297',
                          '34460','48267','68289','32834','62461',
                          '60391','88835','51774','20028','23240',
                          '53517','55264','35774','44680','90205',
                          '42466','73736','74712','70870','29250',
                          '10372','20927','98860','88123','18151',
                          '23671','44548','16052','81545','23548',
                          '48514','31401','85360','65255','86563',
                          '22835','45742','39539','84638','70443',
                          '32132','93729','67789','87704','77394',
                          '65406','11517','14414','58081','93762',
                          '28356','80691','16962','95832','77696',
                          '39851','15423','64116','43033','35857',
                          '85900','90918','70615','23457','88290',
                          '64507','22913','11837','26726','22321',
                          '40146','76510','69312','62475','16218',
                          '58374','28246','44491','73034','36726',
                          '21112','84673','41580','74496','99315',
                          '29312','60545','16011','40357','29580',
                          '46203','82283','19728','30172','98797',
                          '26658','65593','37592','87815','18111',
                          '41478','79676','88565','86244','38742',
                          '38618','12844','53476','83250','99140',
                          '23953','32332','51845','27750','35595',
                          '11789','66147','50429','73389','48777',
                          '70281','10877','52304','86267','41320',
                          '20274','59398','97096','16234','27583',
                          '77668','45521','99921','84300','31511',
                          '82773','89830','82124','97189','58043',
                          '77160','41997','61085','87573','92833',
                          '72103','62188','23614','57452','70285',
                          '80528','88733','77293','24050','10887',
                          '50606','32234','70955','14305','38349',
                          '29798','14418','61178','56086','40579',
                          '26283','19641','30197','64658','79876',
                          '99151','58404','91449','84079','93178',
                          '65264','55518','87740','30254','38973',
                          '15595','56579','96607','85507','46209',
                          '50913','71889','23277','87342','13339',
                          '10102','19664','14045','71703','89361',
                          '67270','45786','71226','43473','42352',
                          '45396','47198','56012','69332','34304',
                          '36668','92492','92245','20070','12767',
                          '45430','39884','80407','87571','78159',
                          '29090','59353','28836','45940','93937',
                          '29485','35226','72455','56511','83175',
                          '50150','81321','70809','20134','83394',
                          '16583','86589','21071','25529','19717',
                          '55677','53574','13910','64620','36268',
                          '68189','64365','50255','61705','78099',
                          '44529','48101','77371','48928','86936',
                          '76563','99944','35553','75999','11792',
                          '98867','65880','85307','25737','19418',
                          '68586','98863','52693','72606','56339',
                          '97714','32039','65048','53268','79930',
                          '30576','78687','57629','73600','90218',
                          '88797','89084','39762','41257','80568',
                          '61924','31706','24144','36553','42595',
                          '48840','10001','50935','90640','32073',
                          '85162','35054','24133','84035','14471',
                          '80969','16533','82860','69362','10724',
                          '53837','48886','81426','26018','18496',
                          '16263','76417','12218','43414')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


