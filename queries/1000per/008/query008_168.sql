
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '89304','49849','44017','30884','41599','21532',
                          '89597','65053','95026','98349','60301',
                          '42158','31454','68636','69099','17738',
                          '77270','27046','78306','25212','59301',
                          '93999','41620','77458','99109','81357',
                          '37683','50892','77211','99882','95263',
                          '58769','68858','71603','60540','65803',
                          '91058','35396','27194','59754','27708',
                          '75588','37203','45938','66690','29688',
                          '59435','92230','97130','85140','83011',
                          '32939','89748','66681','76236','45645',
                          '37940','85777','52911','82853','39498',
                          '33988','88754','56040','59135','62869',
                          '88182','77899','42884','68403','19883',
                          '39936','50887','57442','18676','33510',
                          '74076','95611','20213','47162','12757',
                          '75385','85012','89115','10174','58913',
                          '99712','44338','25575','16666','71590',
                          '11204','36436','16537','86502','64675',
                          '51424','39962','81202','94433','15242',
                          '87672','56916','30386','30741','45456',
                          '30109','80761','11001','61356','43323',
                          '36588','23383','11541','86911','20513',
                          '95950','78277','94555','51627','34254',
                          '93292','30378','24471','30893','56420',
                          '60800','20412','79155','10797','31792',
                          '22426','12202','30475','87042','46865',
                          '55617','25978','51551','14526','46968',
                          '76249','10752','80780','51792','87373',
                          '25198','79456','96592','58297','58000',
                          '61292','66603','21939','59257','73464',
                          '40115','68254','78546','71954','53075',
                          '38511','27458','86169','57016','52981',
                          '31654','96570','26267','28756','79384',
                          '85467','43334','67195','15869','66629',
                          '38629','81781','98577','73450','15362',
                          '99981','96361','78712','37095','59814',
                          '50264','59480','11328','83554','14643',
                          '25592','55907','28924','58677','71549',
                          '67089','28978','83607','30581','56872',
                          '37594','84571','73346','12212','22175',
                          '12253','87222','66807','73856','64201',
                          '55980','98478','69901','82587','25307',
                          '27532','74711','53182','92334','71035',
                          '41358','59622','88441','28792','38557',
                          '40193','67206','37919','69811','31269',
                          '66697','67430','32134','29876','21556',
                          '79040','33295','83350','64794','92138',
                          '25819','61659','64007','22299','14070',
                          '44212','93137','49502','10789','44605',
                          '15149','88639','14687','31264','70588',
                          '86277','82667','63404','69737','22649',
                          '33200','58150','70838','97743','25573',
                          '48003','80864','47730','56931','47490',
                          '35048','93488','56434','88092','76023',
                          '42175','91836','30783','15947','83387',
                          '73079','79188','44226','71877','23466',
                          '35481','57182','41217','95119','17065',
                          '41988','23055','42358','52087','60745',
                          '55081','14758','28947','35594','59119',
                          '79638','23692','62220','29648','45262',
                          '82119','51868','63021','95965','57670',
                          '39706','42802','74943','18204','65122',
                          '45602','91241','50863','61725','38334',
                          '19554','44860','17736','60069','59854',
                          '60430','17198','25562','27785','68279',
                          '68078','85328','76325','43819','13538',
                          '69233','38170','53558','22279','12785',
                          '28017','15637','77402','81722','86812',
                          '14899','44390','19401','43972','62926',
                          '65636','51415','19615','52835','53097',
                          '10608','19530','37962','82193','56797',
                          '63669','88040','18013','94560','30448',
                          '27811','13010','23845','82301','21834',
                          '30345','77317','16732','73074','76170',
                          '45426','51734','45195','64349','77649',
                          '15493','20789','80272','14668','21036',
                          '64640','81475','36541','41968','49870',
                          '76252','95576','25742','50630','54170',
                          '61412','82995','24362','93931')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


