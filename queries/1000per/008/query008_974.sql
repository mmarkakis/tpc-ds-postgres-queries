
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '49237','99456','70965','95975','26434','47966',
                          '78279','23352','26702','30357','16168',
                          '97757','78978','97480','17340','51653',
                          '90900','95108','12163','39240','65993',
                          '86850','38741','58869','68684','61028',
                          '59554','79736','33514','46494','60418',
                          '35225','66783','36496','74379','46295',
                          '21859','58696','11336','56819','31541',
                          '69106','65091','61929','53188','96121',
                          '53578','72444','85437','41161','74297',
                          '78143','86723','66065','71881','68024',
                          '76002','55341','66693','37094','25868',
                          '66837','10121','17500','84276','39341',
                          '50951','23359','58974','46414','30803',
                          '90004','51111','14839','64532','69641',
                          '19500','22508','85754','10927','93132',
                          '29135','14207','28870','10791','75797',
                          '21921','25214','10276','44382','55349',
                          '90888','28265','37719','20975','84469',
                          '95777','91099','24972','80518','27796',
                          '70126','14070','66519','68918','94636',
                          '82162','92798','74193','62266','24813',
                          '99170','84638','75824','35021','78270',
                          '71829','77180','66862','85497','48506',
                          '27093','15302','30299','46951','21860',
                          '52281','29793','43557','99059','30254',
                          '43521','81940','35218','26612','80959',
                          '43443','32846','52195','48265','79632',
                          '25854','31150','48190','43288','98345',
                          '18346','80542','31517','88050','93831',
                          '15409','35366','92806','96923','98410',
                          '32618','86014','96526','40986','25545',
                          '10871','39596','81844','61985','25335',
                          '93744','44789','53247','34666','19279',
                          '52867','24687','26787','19793','98999',
                          '25586','21711','79122','81705','24879',
                          '45961','99204','33288','82839','88399',
                          '56993','76769','62566','87825','97577',
                          '50875','36301','49351','43846','11975',
                          '27682','52018','23551','53518','36110',
                          '86129','22338','32928','20525','12709',
                          '96521','63500','37005','95982','98443',
                          '93037','25255','10542','65863','47574',
                          '55675','74444','98422','84914','69952',
                          '92451','74013','80760','31974','92302',
                          '93949','99684','85120','51329','95319',
                          '70348','54283','86853','73895','47720',
                          '46807','47688','30580','47218','16221',
                          '59244','64992','36398','30391','95869',
                          '79214','26610','26596','29581','93419',
                          '49320','80338','26498','22459','74167',
                          '10736','76240','69759','19633','81883',
                          '68671','83329','54643','18793','63463',
                          '28050','99060','45719','48289','22244',
                          '71482','22874','22266','92929','60887',
                          '56903','55649','58887','63326','84807',
                          '65735','31859','41233','65573','77966',
                          '78052','22146','47646','78698','84228',
                          '40640','88764','81614','22730','28054',
                          '52452','41997','24887','13698','26953',
                          '30644','89799','18103','87654','11931',
                          '10595','44619','10242','20255','95207',
                          '90065','28389','45071','16388','11029',
                          '11152','44013','32362','33501','63844',
                          '81475','73350','82539','55367','37610',
                          '96659','96085','96028','50184','29212',
                          '39008','59360','73050','42529','67219',
                          '40509','36046','30787','30943','82499',
                          '66843','66136','94518','73272','62484',
                          '46198','59222','60681','60746','13967',
                          '52925','59577','35059','96321','81751',
                          '57937','52906','25659','99593','18510',
                          '89747','45275','15611','81525','27338',
                          '33529','10148','93014','16864','15449',
                          '71923','52850','50139','90132','43578',
                          '81358','43625','57796','31710','57009',
                          '57173','95559','47921','51188','98485',
                          '25492','74557','59144','37547','95596',
                          '23036','88184','10040','27517','95608',
                          '87047','54950','94951','19669')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


