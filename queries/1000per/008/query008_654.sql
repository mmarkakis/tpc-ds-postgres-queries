
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '19135','76435','36777','81876','57164','85768',
                          '48619','64072','98991','88789','51947',
                          '67942','60541','87403','68671','96013',
                          '72219','26775','29122','62626','27514',
                          '86434','69524','84962','76874','92712',
                          '33651','24447','13350','81907','94096',
                          '12555','52028','54811','97422','58456',
                          '65987','60864','13882','97194','47569',
                          '23838','83489','18301','79098','83928',
                          '79428','91656','32425','25751','66743',
                          '92845','74456','95949','47615','20654',
                          '18108','36643','21654','11401','86638',
                          '47414','70382','89076','12233','49437',
                          '19609','68383','99414','99436','75016',
                          '37121','36988','61274','84456','47338',
                          '24376','16561','34498','52150','56961',
                          '27742','44457','54146','33558','95642',
                          '61150','56966','33848','44525','72617',
                          '84001','61074','84667','71091','15920',
                          '29984','75791','89574','57269','40640',
                          '10775','17781','10668','71200','82463',
                          '76062','20862','30321','69430','21000',
                          '72659','72064','66903','21936','47696',
                          '80281','66161','32056','76505','19269',
                          '35294','72282','97959','99254','70640',
                          '47403','54381','87461','67510','58857',
                          '43717','70987','12226','82729','30250',
                          '45597','26795','71723','86496','92343',
                          '99433','21514','86879','97608','13109',
                          '42600','27531','30912','23110','27741',
                          '33626','97073','90925','62127','83152',
                          '10700','86788','98106','85870','26784',
                          '22178','74815','49892','72591','38937',
                          '90753','32830','91854','53407','76755',
                          '72097','58185','80934','70540','46811',
                          '33000','55764','73512','39881','13329',
                          '20689','57338','57466','22633','68308',
                          '59461','75449','20415','59745','61051',
                          '48755','58088','81344','63027','84674',
                          '68061','16953','82421','92910','61672',
                          '12645','53311','32137','92715','56690',
                          '48685','50316','70142','71603','79128',
                          '76068','41792','83264','80037','31111',
                          '83209','99956','20368','32876','91690',
                          '83631','58992','64488','67358','41701',
                          '74975','13668','85940','87321','82716',
                          '94576','13157','72596','48707','50906',
                          '75379','33435','81952','42421','35973',
                          '82358','82296','36937','59563','96696',
                          '42209','76711','81947','27914','10225',
                          '40592','77901','90473','93142','33006',
                          '54544','48426','35404','27578','43529',
                          '28724','55336','88263','36338','97681',
                          '53094','81271','83879','68692','49032',
                          '84201','62214','91025','93263','10078',
                          '48239','42521','23733','38591','60998',
                          '71195','36477','95779','46447','17894',
                          '52362','72056','53032','41342','52032',
                          '16735','96648','89266','74817','56100',
                          '51431','65944','86570','37680','32521',
                          '36861','72114','44388','19000','36867',
                          '58104','14728','46199','70069','93557',
                          '42130','77219','40839','50625','73171',
                          '44266','41260','42611','40747','25922',
                          '76405','14394','94519','99869','49811',
                          '48706','78053','80547','37364','17181',
                          '30586','55904','93636','56751','50054',
                          '70930','27679','77168','56888','41022',
                          '63818','32322','54214','53095','12551',
                          '27908','86077','39846','92095','22444',
                          '85086','63281','66760','83895','59462',
                          '23757','47653','30940','57595','35063',
                          '20729','75641','40808','98077','62802',
                          '13183','14740','83133','56554','28934',
                          '23054','28100','37315','20002','40977',
                          '43583','90694','42815','44455','14120',
                          '56216','93411','46943','29236','62231',
                          '58265','29483','81943','83986','53562',
                          '19230','39227','53497','71897','76395',
                          '43003','89739','59456','95533')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


