
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '52403','99576','73577','49376','98316','59294',
                          '80251','36468','88424','78039','34533',
                          '74545','43456','67642','70103','42609',
                          '20325','26915','79387','41419','25505',
                          '28684','13355','91783','88098','49789',
                          '77573','79488','53738','16535','64231',
                          '86102','47988','44741','21561','65336',
                          '48825','31570','76650','20958','67473',
                          '56464','36773','18044','61269','16813',
                          '16155','12185','48858','95544','95907',
                          '51966','52351','48274','34239','12339',
                          '90261','27740','44676','25254','18337',
                          '82551','57422','66566','91400','28951',
                          '52695','43266','61587','11042','11253',
                          '49999','36322','48343','22048','73121',
                          '68701','20089','17626','27011','47871',
                          '84928','17428','72700','42946','95141',
                          '87210','32523','40191','71730','90558',
                          '18085','26039','31504','45665','74121',
                          '70781','86919','83705','11335','61568',
                          '71661','56095','70790','23373','41069',
                          '36201','50708','29752','49221','63590',
                          '98266','73612','85995','44047','98552',
                          '17314','77748','22727','12269','31947',
                          '29975','48008','13262','39760','91545',
                          '62250','53219','35450','59135','88660',
                          '38863','28585','66503','30994','33639',
                          '45076','59834','97200','66075','78141',
                          '43927','15741','93932','89782','67897',
                          '24457','10292','34986','82721','12594',
                          '87443','99685','45229','92105','71704',
                          '67587','38612','48313','81433','28818',
                          '11993','33474','88892','89963','67045',
                          '67148','16021','51295','18837','99957',
                          '98193','72689','23913','66915','96890',
                          '72579','12683','64390','14825','20711',
                          '36456','10674','32263','48268','82998',
                          '35149','57222','31398','20411','35900',
                          '99477','89255','24636','69883','30561',
                          '56927','46997','83235','80105','38246',
                          '15603','48212','83504','35260','39433',
                          '54240','84183','41472','46556','87361',
                          '91979','79110','81746','46964','41238',
                          '29374','56054','51336','58772','90956',
                          '15763','64298','95479','72764','51436',
                          '78428','96280','88864','58356','25330',
                          '15755','43264','61861','20625','96679',
                          '50409','65101','34342','85829','31860',
                          '30693','89936','36825','12939','22579',
                          '23989','10613','32185','47438','82919',
                          '58860','90428','29725','57399','28104',
                          '53850','55082','43300','19271','72558',
                          '50999','70730','57488','55941','77510',
                          '94092','45306','99783','49548','17345',
                          '54205','70203','76616','81277','25690',
                          '66277','52665','72043','96274','84809',
                          '87881','24233','45355','10558','65347',
                          '60442','23455','52718','10003','82531',
                          '79941','50260','86713','88122','86530',
                          '68893','51993','79962','89220','23619',
                          '54302','39645','51185','59102','54835',
                          '33313','55167','40490','45881','44166',
                          '34262','96064','37139','65684','98281',
                          '37148','90142','76055','94555','13130',
                          '90450','67841','90271','33362','79972',
                          '45404','74989','24683','45251','70631',
                          '80906','90954','71134','58093','69144',
                          '32893','93065','32807','80945','33706',
                          '51370','13327','94132','92349','36025',
                          '68193','47600','76528','78405','65570',
                          '19248','95310','26728','77341','72801',
                          '31629','73599','52991','11992','30823',
                          '10109','43868','82160','71196','39708',
                          '30999','94521','76680','81019','81350',
                          '12914','44188','66605','52591','44836',
                          '60197','82080','48039','87527','31220',
                          '63822','61310','18108','40599','89364',
                          '30761','27317','23344','24232','87711',
                          '53779','22823','81807','55270','68649',
                          '12442','67321','72734','24102')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


