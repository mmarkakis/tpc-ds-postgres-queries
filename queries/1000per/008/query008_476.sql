
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '90973','17550','87669','33540','74172','37795',
                          '48524','65160','39316','29345','14127',
                          '56397','79556','82672','44534','70741',
                          '29757','66555','63736','23789','39439',
                          '99462','22402','23600','17757','34422',
                          '79493','60352','39388','30803','57455',
                          '47937','24173','89410','90378','80545',
                          '12141','59507','97086','34419','71264',
                          '39889','57838','56811','43027','99875',
                          '28336','25257','52679','57929','42493',
                          '73885','59904','93726','98665','88537',
                          '77760','64614','23164','42503','47158',
                          '87682','37233','57990','72303','93843',
                          '47986','26969','95991','78085','44588',
                          '78704','46906','51534','80707','99283',
                          '67231','43320','23653','67593','14363',
                          '89859','42209','27325','50944','77534',
                          '54260','89951','14563','13312','79654',
                          '39755','86546','11274','73270','72532',
                          '32142','93390','40300','95777','12909',
                          '70367','89669','56288','84412','88717',
                          '87564','10730','96224','14946','61424',
                          '24657','21417','24576','28427','97866',
                          '17270','88139','12276','65879','15705',
                          '60395','21823','22466','89582','21356',
                          '44371','27022','96149','57376','44531',
                          '99651','68633','86443','61631','90705',
                          '60235','98837','68919','47674','60972',
                          '44803','41744','54610','25601','87716',
                          '21715','79656','72351','30777','87449',
                          '92918','91559','73097','78999','62092',
                          '45139','11115','32203','63606','43459',
                          '41283','93198','65552','26158','30322',
                          '45133','11811','62769','25203','77479',
                          '31426','24058','59348','84310','77518',
                          '90545','15522','44589','43135','78829',
                          '63301','96915','68852','80505','57242',
                          '47922','23918','36130','54618','94423',
                          '36844','76293','69105','20001','51802',
                          '74469','35517','83462','34496','92763',
                          '54643','20683','45142','15855','96467',
                          '64300','65356','68296','14586','27523',
                          '21020','75011','37319','65454','79401',
                          '79071','86036','42898','55036','34175',
                          '39492','19964','92292','70105','99683',
                          '40398','81183','26610','99296','49550',
                          '26661','54402','56025','22993','20254',
                          '42675','35363','21349','76295','75704',
                          '38060','62661','66692','23432','65713',
                          '11236','15714','76580','49741','66247',
                          '72710','20784','85152','31896','88119',
                          '30352','97105','68705','20184','82744',
                          '29040','67335','40323','56431','19152',
                          '54594','38258','53868','19413','53047',
                          '12120','28063','61152','37140','33292',
                          '82194','68802','43587','61376','65194',
                          '45023','95453','94135','85847','30059',
                          '76817','27892','98243','30173','86691',
                          '22125','62832','25168','25841','29351',
                          '75523','42628','25012','19273','28944',
                          '76448','65071','92870','57575','78264',
                          '51365','84943','25174','60442','84793',
                          '72432','97326','42781','16574','34407',
                          '88232','30463','21899','85356','59305',
                          '76113','57226','56732','48932','34150',
                          '28612','91672','95996','27122','74762',
                          '64556','48900','43943','12231','77536',
                          '34942','35185','23491','87260','42710',
                          '77612','97323','51008','65019','60180',
                          '67119','96280','39853','83169','94143',
                          '61585','98694','24893','54423','81727',
                          '18961','98745','51096','52496','95149',
                          '31264','27038','92844','53934','86290',
                          '89935','21623','71171','23017','20832',
                          '67876','45834','69005','28341','69287',
                          '78498','71540','76334','55331','10253',
                          '83626','43699','77980','92239','62124',
                          '75100','44784','78189','87215','70715',
                          '35314','25461','99007','93082','79809',
                          '81001','46360','25767','12246')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


