
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '19539','20376','23102','20547','10095','98818',
                          '50789','63669','31883','17848','87856',
                          '21062','18384','30046','48741','74319',
                          '14488','54211','23001','66505','28130',
                          '76151','62799','66211','71465','94434',
                          '90541','40091','55880','33354','79981',
                          '68672','71520','50964','65241','27248',
                          '35075','25227','35716','24362','71179',
                          '51840','31323','19999','91868','45652',
                          '89461','39031','32061','87848','87091',
                          '25736','76698','82099','98588','26887',
                          '39087','32608','87243','96203','89449',
                          '17875','83794','78947','79458','30729',
                          '25792','17412','83691','28384','29071',
                          '26144','17664','99322','89579','48650',
                          '46372','63335','76198','97593','29237',
                          '56982','68523','83865','82744','72433',
                          '72730','29338','64648','63497','82398',
                          '91497','73034','94319','51691','97149',
                          '90996','79560','26218','15584','99421',
                          '71197','86142','31661','24495','21903',
                          '23489','42274','79516','78161','58313',
                          '90041','19543','20846','60980','19621',
                          '90302','24340','29958','39129','83322',
                          '55769','36927','17430','98341','41645',
                          '19788','22689','70251','94514','74477',
                          '86197','58960','44829','83385','58865',
                          '50344','75953','25733','37798','79743',
                          '12703','42157','17263','34632','86354',
                          '35311','98042','89653','13267','79659',
                          '59145','66948','46760','36775','82450',
                          '10645','43187','91884','46061','48833',
                          '51714','55004','31768','86374','52256',
                          '75494','55833','48807','91959','72488',
                          '50754','87694','81942','60875','86502',
                          '69580','38498','34464','25146','16316',
                          '14929','26080','68577','91080','30193',
                          '91720','27862','20175','32944','99309',
                          '22930','89381','76451','20037','10668',
                          '49096','21174','54203','63893','59726',
                          '44884','25054','78705','75351','82652',
                          '80351','35125','84668','53630','17862',
                          '77392','80025','57492','49685','87527',
                          '16631','31993','56735','88978','30585',
                          '13411','14171','62576','66921','39876',
                          '81565','35220','30920','31770','21037',
                          '14952','72745','61292','66381','89718',
                          '30045','49464','73726','97128','68440',
                          '80165','73071','24605','50308','84393',
                          '82201','78290','29157','96694','42988',
                          '36827','59267','90871','97298','13806',
                          '45593','44958','58171','10762','21234',
                          '33748','22841','95765','25136','58111',
                          '39838','25741','96755','11982','58274',
                          '41124','96883','82868','24064','92154',
                          '69000','76637','28409','50019','85488',
                          '93899','93136','65329','66321','90563',
                          '79883','54057','62174','36264','29152',
                          '50046','61555','75395','28105','50093',
                          '16725','70224','55176','35090','27822',
                          '74469','78782','77192','99892','34149',
                          '86503','78622','78508','72732','80174',
                          '49851','40048','65286','53567','17286',
                          '10350','69181','21904','50838','62866',
                          '15222','21345','51722','59124','82663',
                          '18338','90817','34110','83267','50650',
                          '13459','90632','97806','89765','88390',
                          '62027','44270','84775','83098','30941',
                          '40029','21147','75491','77107','42508',
                          '14249','57179','62813','34517','21007',
                          '18093','91356','44216','71213','64409',
                          '31551','36534','57640','91662','12608',
                          '54269','37323','38441','54348','81460',
                          '39716','74100','23228','67882','62048',
                          '26916','23362','52291','10568','42661',
                          '15484','41103','46298','78274','98139',
                          '29937','99043','30285','60964','40658',
                          '94435','81609','16276','47679','21716',
                          '39055','78360','61231','23180','87391',
                          '61397','49829','77600','37961')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


