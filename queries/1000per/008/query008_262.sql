
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '94051','10037','49946','40449','62996','25089',
                          '21659','47354','19039','69452','37666',
                          '76005','49318','64104','47961','19093',
                          '82576','17841','66617','25613','42856',
                          '96300','85664','33530','29826','51703',
                          '67107','73574','47600','59333','70473',
                          '72970','70662','22939','86730','33654',
                          '13470','63156','82291','97734','53438',
                          '66648','23463','81083','13606','45060',
                          '30531','86850','23156','75218','75102',
                          '41905','24946','83799','21402','74095',
                          '81455','64052','68033','62486','44967',
                          '59763','67088','38614','35942','99817',
                          '27275','39596','41339','68714','84982',
                          '94088','34722','50269','42818','49250',
                          '46375','37012','25599','87188','66942',
                          '34870','25449','32426','15878','91382',
                          '77919','28154','39437','30965','92382',
                          '98101','29009','88589','20493','45018',
                          '79658','22826','39376','25604','79222',
                          '14389','48117','46494','15985','31688',
                          '71763','76414','39784','80130','34291',
                          '47392','95845','14050','51255','99363',
                          '43467','75306','94262','75558','32085',
                          '66537','25247','53885','23740','71623',
                          '60777','92690','77786','47083','34891',
                          '80792','98473','44407','64097','49191',
                          '65823','59481','27367','37845','57752',
                          '40565','46526','18643','78457','78900',
                          '52441','26589','57109','80950','27876',
                          '94608','69802','88898','15747','95952',
                          '52402','92729','84372','27713','90424',
                          '20598','20034','83819','80343','40265',
                          '91941','66300','39870','38020','24895',
                          '73735','20217','99331','71582','65787',
                          '17567','10731','30445','91817','40805',
                          '41907','12983','91676','71102','81438',
                          '35892','62947','64148','91438','40961',
                          '94995','15283','79271','83106','94178',
                          '35515','52617','75130','88852','29483',
                          '13903','65127','45872','78159','88055',
                          '92846','22498','80926','24008','49179',
                          '78475','77714','74226','47117','37259',
                          '21383','69779','72554','44198','58248',
                          '94471','29289','75948','82525','78556',
                          '43367','24046','94997','70985','64813',
                          '91588','77893','34260','61837','99185',
                          '80218','20273','41292','28024','27587',
                          '45103','81441','94079','32831','99559',
                          '18573','11671','96410','63151','56443',
                          '62263','43259','91158','65856','17722',
                          '17155','47616','85307','52201','50434',
                          '87879','46097','65304','52673','45663',
                          '45685','13826','36878','55808','69955',
                          '60191','30162','12375','72348','29252',
                          '91686','27080','24481','99286','91682',
                          '41937','43558','41419','17135','63268',
                          '40845','45373','55346','94392','83408',
                          '69871','57797','91500','47840','44847',
                          '82163','53873','19414','43522','51168',
                          '63472','21884','17860','43734','11664',
                          '93314','36124','92197','24256','42714',
                          '18470','41988','50375','65669','90283',
                          '14884','56289','83989','89472','47668',
                          '65239','49474','90634','50119','45095',
                          '91022','16480','92230','43968','38187',
                          '50559','50822','60622','38627','46090',
                          '12663','48374','66150','26798','11466',
                          '37594','44128','88425','81597','24449',
                          '77776','46964','85017','42458','45700',
                          '62171','36751','63274','34356','62327',
                          '57968','15477','34501','36799','34384',
                          '46365','15306','22409','20908','56699',
                          '41060','26408','12812','43296','29978',
                          '83171','84923','21347','88630','90627',
                          '44628','56972','14849','42564','89710',
                          '42824','11214','22411','71340','29800',
                          '23485','34847','22292','22069','32811',
                          '45151','88538','64431','68296','90946',
                          '50263','78239','27740','27416')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


