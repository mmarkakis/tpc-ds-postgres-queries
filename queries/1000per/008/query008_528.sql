
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '78140','84692','95957','71502','20443','92513',
                          '13724','53599','99513','94133','39039',
                          '31574','86083','72622','84544','69088',
                          '40708','40562','47084','66498','69068',
                          '63480','48739','26792','26727','61538',
                          '41906','33513','86346','59412','22467',
                          '68386','70510','38467','89842','43858',
                          '58627','38110','39700','27473','84057',
                          '57198','42828','90913','62066','72154',
                          '93079','90589','84592','66850','77193',
                          '41861','22047','65401','41514','33035',
                          '99161','57374','40913','85986','42596',
                          '18014','89516','75936','69490','12255',
                          '99752','96182','59102','73566','42528',
                          '20732','91388','95214','79520','45787',
                          '10220','49785','66040','94966','47518',
                          '82060','87495','43096','49027','73027',
                          '24568','43743','95457','19628','28437',
                          '46041','45265','67043','66365','49245',
                          '71783','19900','56722','82677','88222',
                          '13659','13765','81564','71608','68110',
                          '81627','97540','81147','96455','47101',
                          '30534','63505','75646','88964','56788',
                          '40061','31855','46064','70447','52816',
                          '79985','39873','92631','92356','37040',
                          '40971','80823','27461','91124','69626',
                          '30120','22974','14839','38363','36650',
                          '57059','29111','16405','83670','70411',
                          '36192','71870','23363','24874','44290',
                          '77838','19962','63431','81376','92662',
                          '31155','94410','44514','44655','93495',
                          '34861','38447','26022','26922','52628',
                          '52075','79375','27061','52710','34593',
                          '57970','86582','95317','54335','30680',
                          '78627','15261','54723','28596','64722',
                          '73636','25858','64984','72401','51830',
                          '96121','69723','16045','36829','50935',
                          '54614','90862','31260','43886','42777',
                          '59731','49597','45870','96442','67740',
                          '32416','32658','78131','47228','69677',
                          '71526','44096','63662','62943','10754',
                          '89993','48985','62907','60377','35502',
                          '65645','65480','80766','59215','53495',
                          '45091','48037','60909','82280','15348',
                          '56880','31145','47885','92471','51661',
                          '74773','79643','71791','23411','97937',
                          '54061','32554','32247','82934','64630',
                          '85149','88988','42080','27358','41690',
                          '48774','53779','80131','90901','76066',
                          '21379','54744','46350','56081','62411',
                          '64788','26010','92289','90935','67889',
                          '45638','12602','27558','49871','77535',
                          '25600','68586','92369','45089','69155',
                          '53880','74054','30503','11652','51675',
                          '86613','49533','76248','10115','17291',
                          '19874','22246','32078','79709','53563',
                          '38045','92489','40601','39479','65387',
                          '73560','10736','97785','21709','40782',
                          '41566','18431','81010','49919','87202',
                          '25107','61420','30551','59116','32082',
                          '21965','71805','86168','92775','12109',
                          '17587','53431','54741','61023','63610',
                          '41097','55587','69070','42567','33105',
                          '33538','83954','96546','97499','36083',
                          '79797','77903','88257','66011','82139',
                          '17110','37178','99974','90912','69077',
                          '15464','96963','54220','19023','16823',
                          '78851','88234','45705','28063','17919',
                          '80283','62459','60517','20967','30138',
                          '80722','23651','20762','66285','56038',
                          '62697','22752','83729','80816','59085',
                          '98968','58895','10222','38535','50970',
                          '64595','10023','76601','99443','24974',
                          '93378','64981','32544','60784','11854',
                          '31390','35868','60771','58857','84307',
                          '63608','17233','61160','90203','81176',
                          '88663','29425','63995','89087','85510',
                          '31811','33277','17466','49174','98665',
                          '59049','32637','95973','24301','84891',
                          '49454','46352','89245','52672')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


