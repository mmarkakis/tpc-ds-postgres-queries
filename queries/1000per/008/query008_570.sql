
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '94483','87017','73402','73903','37237','88650',
                          '15358','86888','81069','44932','44037',
                          '57063','36478','26822','47844','52586',
                          '52808','45771','91111','44872','97799',
                          '56065','66996','88536','32937','53587',
                          '21845','91701','47358','46567','11600',
                          '55288','69114','64355','37496','11714',
                          '59328','93251','12116','45941','91619',
                          '74968','42886','86080','60482','20785',
                          '27360','25197','32098','64299','64528',
                          '75945','38061','23209','13266','28895',
                          '58987','82905','95368','36753','72437',
                          '29794','66204','89916','68508','72287',
                          '45292','79105','74952','86449','69640',
                          '37798','51818','78578','51227','28910',
                          '45668','20192','42783','54704','45988',
                          '49895','22256','86737','29147','53742',
                          '72703','25303','67590','28269','89116',
                          '29838','29368','75794','84411','66159',
                          '61497','59405','10119','80859','60573',
                          '61489','13316','39014','92508','21554',
                          '55039','46431','21267','53254','83754',
                          '61810','64373','99614','84289','13338',
                          '57836','95276','71903','75831','46101',
                          '24570','88190','75713','23327','43670',
                          '56455','32285','20788','60826','38192',
                          '73061','59312','92653','40795','15721',
                          '73301','12828','30560','80875','98569',
                          '80663','20728','98312','37953','27842',
                          '85848','45218','75843','40658','94510',
                          '17244','76200','14327','52530','47884',
                          '46326','66066','60637','73334','88258',
                          '45164','15022','39462','21953','43653',
                          '90786','70969','97864','92876','21533',
                          '25009','22739','64015','44165','48945',
                          '86967','85631','84766','84203','55528',
                          '26994','86788','43362','12462','24208',
                          '81534','52339','34961','74102','81098',
                          '96897','55418','47363','23619','30187',
                          '20154','40904','87080','69082','88860',
                          '70436','97296','31188','89998','43335',
                          '79485','46733','78413','73835','52122',
                          '16227','43087','20116','91370','32685',
                          '67351','13703','22795','92477','31222',
                          '63054','37503','59710','81136','80477',
                          '72685','99808','26686','85835','98496',
                          '24062','56209','71106','80617','46094',
                          '29451','79086','26679','25963','53638',
                          '19181','10043','55002','57420','80767',
                          '23878','74422','53255','16538','99764',
                          '75460','70406','47499','63757','52410',
                          '69648','91319','49219','84542','40527',
                          '84628','72320','77789','96018','61125',
                          '48170','90386','20942','75528','55338',
                          '96642','21807','29324','33509','66763',
                          '91851','58143','59136','57491','97648',
                          '41603','11068','79987','41039','44000',
                          '48090','17995','14838','97798','70242',
                          '88919','51452','30566','11274','61010',
                          '61592','24031','17963','35687','39752',
                          '82712','46152','43605','66163','46257',
                          '29595','16396','58283','45200','90964',
                          '13722','85015','17069','17998','48339',
                          '73225','31758','82245','21083','80042',
                          '22289','56462','69714','86379','52068',
                          '99746','24443','32250','10013','60179',
                          '64417','29944','35488','11272','97503',
                          '47340','33289','26812','13413','43399',
                          '63534','24461','31798','64310','97761',
                          '70336','90040','26917','25996','71557',
                          '59061','20598','61920','67189','37893',
                          '41579','64865','30476','96527','70058',
                          '81985','13806','81010','31063','81336',
                          '45139','28320','98217','40515','33160',
                          '16237','15814','65060','21099','68857',
                          '38118','31913','34470','39398','35236',
                          '88701','86707','21021','64861','13787',
                          '41949','82927','56643','10419','98598',
                          '45298','22158','35633','36480','78091',
                          '86361','33303','95067','39782')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


