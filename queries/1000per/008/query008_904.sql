
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '80959','87894','16247','14863','26694','15307',
                          '13689','69726','79599','59751','54374',
                          '78117','81060','22752','81924','36642',
                          '36940','80081','39376','57994','19350',
                          '36621','35337','86495','90720','89087',
                          '95572','75661','22239','13253','33885',
                          '61099','77091','23050','31443','72741',
                          '70809','79101','11875','42440','13086',
                          '16440','50133','12997','92059','52055',
                          '92450','64897','58389','59786','98637',
                          '95396','32720','29188','89305','12713',
                          '45141','58561','89899','94707','75369',
                          '35753','27283','84697','49626','32787',
                          '60884','80594','24260','83563','20014',
                          '75573','75713','15445','92139','49784',
                          '81341','36819','82223','72967','92623',
                          '41377','28453','81001','87070','33891',
                          '87735','95661','31862','24021','80084',
                          '84333','92134','76267','71861','21297',
                          '76439','59169','24428','97407','95284',
                          '47049','67813','49678','65860','89343',
                          '98395','86928','75015','13333','26361',
                          '92420','13583','71067','76769','50861',
                          '27951','71225','47880','88119','71855',
                          '70613','39116','68401','68428','98588',
                          '53076','24611','84978','75190','56995',
                          '63721','76934','17930','96751','88352',
                          '56336','55404','60755','38813','29747',
                          '99732','97565','84807','20297','58254',
                          '35953','94861','72498','19333','25115',
                          '47333','59427','16149','33115','86896',
                          '65988','30736','65619','54200','69636',
                          '40039','77850','58321','33377','86547',
                          '34630','46484','30621','42760','26554',
                          '35734','45281','54576','70395','15218',
                          '80677','28480','34324','62748','85858',
                          '79866','80984','49787','73730','25101',
                          '23269','35663','15803','24619','78403',
                          '27453','81984','97006','66954','70754',
                          '35461','61212','16082','67213','19055',
                          '22212','34561','24186','84904','48187',
                          '46346','40563','82599','99696','33563',
                          '64915','81592','55652','86574','52049',
                          '61314','57458','83157','43279','65870',
                          '95547','14149','57034','40401','45106',
                          '74829','39890','74663','23720','47866',
                          '22050','90956','56427','81080','20832',
                          '65813','68774','72358','62956','69968',
                          '75657','32244','49159','96395','33554',
                          '64340','73330','10302','74194','74382',
                          '43125','27069','26341','86710','37773',
                          '61074','35937','58255','98323','85103',
                          '52286','25375','14372','36492','58872',
                          '62373','84573','70523','98983','20378',
                          '36156','31804','46963','85521','31311',
                          '40175','55931','30594','38636','98421',
                          '89214','21869','73708','57293','19459',
                          '98606','43083','53272','84988','50910',
                          '64290','48079','67687','32588','36716',
                          '29663','45085','96562','29176','39439',
                          '89172','70575','26660','20736','89998',
                          '97817','16097','95740','51099','43394',
                          '64018','36905','26362','27768','37001',
                          '76325','21746','55456','36798','81935',
                          '96212','37559','92646','75588','54364',
                          '83392','54657','88880','84144','25729',
                          '64902','92206','76251','53780','12122',
                          '45001','13215','35432','55201','88491',
                          '73936','46933','19796','84406','67547',
                          '25750','14147','74701','30389','93412',
                          '61918','28825','87672','93439','63951',
                          '92944','77303','16623','61541','27376',
                          '76495','31410','92500','69945','11168',
                          '10253','56814','87460','57662','51336',
                          '18246','86197','25944','23295','22030',
                          '46566','95434','58317','51270','71241',
                          '90379','91975','15212','70005','19832',
                          '58379','71644','96177','58425','45718',
                          '39266','51191','84167','20872','55026',
                          '93595','41420','19853','56069')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


