
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '16089','35135','65094','18533','98062','68513',
                          '13689','83398','18087','69503','34111',
                          '64230','10361','12925','24462','41200',
                          '21850','65974','68029','94246','49830',
                          '65575','92375','90233','18352','34744',
                          '79047','65875','87160','19845','92565',
                          '66659','51176','57368','50945','75284',
                          '10925','70720','71030','76150','20592',
                          '31617','63253','83229','51555','30777',
                          '25690','25865','19033','51521','33789',
                          '59935','54790','72071','61313','68968',
                          '93584','97410','18460','64614','32473',
                          '42458','59867','61787','17945','18855',
                          '90031','94097','97775','94043','84681',
                          '41329','86579','80573','16852','22072',
                          '51553','43099','27793','96244','32429',
                          '24175','34231','54721','19734','22332',
                          '27835','20671','65590','69295','82070',
                          '83687','37847','54632','45265','89629',
                          '18908','50822','80659','58094','95078',
                          '65402','68286','34629','80237','60264',
                          '52912','82765','91480','89538','13476',
                          '24455','15341','18386','90050','98534',
                          '73770','11289','39999','85819','67609',
                          '76700','14953','20863','42186','70961',
                          '81404','57149','41360','47122','65582',
                          '21043','55317','16064','96530','11881',
                          '48171','39234','45533','68250','11023',
                          '69450','72723','75313','85004','66406',
                          '69546','97951','82977','41662','46698',
                          '28082','47313','39824','61430','41433',
                          '86598','81518','61861','21871','41201',
                          '14939','91113','70491','38308','50167',
                          '60562','59064','25184','92467','17815',
                          '56814','81730','91954','35888','41350',
                          '83785','37632','45001','45129','38776',
                          '94277','30168','71172','12920','32466',
                          '39478','89179','49143','87745','51531',
                          '58095','24075','71738','58464','52424',
                          '92185','18688','61661','35060','66011',
                          '98692','12633','24136','18165','22213',
                          '12933','80360','21296','78690','96820',
                          '99507','14866','26683','36316','37335',
                          '13457','35178','44232','52593','90001',
                          '15042','58914','76174','66488','54844',
                          '42022','91395','14505','63870','54550',
                          '21156','66774','50348','76740','30713',
                          '82281','93255','71352','84305','80094',
                          '51074','45332','99818','33384','89100',
                          '38560','20417','83872','13381','57925',
                          '91951','58558','40550','85492','14827',
                          '21072','60100','56890','16437','85273',
                          '69809','52537','64973','10966','41510',
                          '30227','41308','72660','63299','20240',
                          '90320','81465','63402','31383','72756',
                          '74654','11485','99185','86456','53023',
                          '58102','45406','21293','70916','71883',
                          '21874','92926','91898','78163','61004',
                          '52411','10140','53030','53928','52309',
                          '82960','32359','31877','73402','69550',
                          '32589','66524','23838','60902','19052',
                          '57512','32530','26537','37785','45697',
                          '63813','20324','58070','63608','69392',
                          '26236','38433','99662','39515','62077',
                          '24300','34261','54806','63097','94795',
                          '35885','60699','84848','23914','45521',
                          '99810','56978','20195','67800','81645',
                          '43761','46846','43766','45780','12606',
                          '56577','89474','22024','59341','24305',
                          '22612','51035','77153','39106','71583',
                          '69251','49763','46584','61271','55824',
                          '75457','63393','35632','30256','53848',
                          '49238','83119','19696','76093','53658',
                          '72763','47907','93534','17687','27040',
                          '40287','49539','88322','51530','53381',
                          '34543','14283','23749','57333','99916',
                          '27653','23250','66686','58236','49171',
                          '61560','99117','49663','35668','15690',
                          '19948','13436','34269','99995','17989',
                          '70774','45147','61127','49486')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


