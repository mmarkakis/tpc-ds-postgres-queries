
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '79444','39570','27200','66893','50547','17552',
                          '84544','46535','26363','48832','13110',
                          '65763','84224','92109','22788','70036',
                          '83964','13488','22751','99054','17980',
                          '82380','87018','90089','69825','78249',
                          '40364','34536','46169','51631','23378',
                          '64100','88551','52898','53706','55509',
                          '82693','95677','10097','64191','35313',
                          '21376','95232','95235','69170','62252',
                          '48261','88882','10224','32109','85750',
                          '75023','27112','49155','84182','63430',
                          '59448','67594','65045','52638','11934',
                          '31435','54875','89907','44920','79546',
                          '11402','99206','91556','54898','84660',
                          '96250','19823','55676','76574','15916',
                          '59256','50488','63106','71718','86089',
                          '99903','15050','76868','66799','88902',
                          '31261','13993','93833','59782','91961',
                          '23624','40380','30846','82954','86524',
                          '70255','33081','62205','28000','56536',
                          '39410','54201','84548','61181','78710',
                          '68869','41894','99543','65542','29170',
                          '37295','61389','54653','87585','14504',
                          '62385','23771','22543','39470','10663',
                          '87822','47712','37119','57922','94536',
                          '81406','23422','20406','59281','97886',
                          '56788','48655','42748','17104','85223',
                          '84898','90323','93936','80059','15722',
                          '86895','33332','55079','20985','65411',
                          '55171','89945','70704','55338','25483',
                          '34641','93637','41958','70068','39519',
                          '21981','54953','92160','77921','87162',
                          '25898','94901','60741','44208','73653',
                          '93496','36181','62235','85685','56093',
                          '21443','73226','48688','94133','65728',
                          '83441','18581','46752','64681','93083',
                          '30655','32567','37178','70414','34714',
                          '62591','98481','37799','92389','33095',
                          '13316','74403','56275','96984','32261',
                          '91395','19917','63129','34496','11962',
                          '24057','31799','43820','33442','42857',
                          '85368','35020','36345','97655','21763',
                          '70724','61574','20851','28663','12223',
                          '17325','77509','34954','87655','31934',
                          '95032','81592','12820','93294','99260',
                          '95423','23301','64264','58032','45251',
                          '33959','95640','52111','45004','99045',
                          '18680','16357','55618','19938','88343',
                          '21745','10925','35294','15034','71368',
                          '50942','60032','30657','94005','50186',
                          '27464','63348','65317','39337','54999',
                          '35638','30416','18616','81643','70527',
                          '40691','93492','43050','62374','34214',
                          '94091','73260','70860','13501','54695',
                          '82810','18879','16858','94240','21228',
                          '89713','87327','15666','18676','27700',
                          '25579','70148','68119','52160','96020',
                          '87044','81424','37136','61525','83027',
                          '72164','42563','25459','27623','55703',
                          '66883','88363','80562','21384','67420',
                          '54814','84554','76618','65351','83288',
                          '63527','84307','67971','45359','13148',
                          '44450','53618','92176','71089','88492',
                          '52045','85551','71421','27951','57712',
                          '39772','62004','99216','42656','83620',
                          '47808','48485','48767','77050','84940',
                          '94989','52578','78820','10618','75970',
                          '14966','44634','61435','58946','59768',
                          '98160','54279','92066','22397','78381',
                          '97208','12177','42723','22133','33617',
                          '31847','66965','93977','35606','38606',
                          '61378','29167','69112','64324','91375',
                          '23685','83112','35352','81190','77410',
                          '16810','25976','35939','70808','36881',
                          '42239','36958','92298','24386','14263',
                          '49150','22478','70004','88441','30369',
                          '82893','34258','48802','65715','79359',
                          '94169','97159','48632','55792','92040',
                          '28118','62047','55478','10243','99328',
                          '83217','41600','13598','57571')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


