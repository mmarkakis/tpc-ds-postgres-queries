
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '59553','14242','15946','92244','11284','96462',
                          '45097','97220','37494','80131','44634',
                          '10755','51803','37270','45832','54871',
                          '21284','27985','75289','10465','55979',
                          '85171','24543','51108','63409','90224',
                          '98285','61584','11227','52535','96183',
                          '61447','51370','76450','22838','13633',
                          '10074','53980','71102','62957','90304',
                          '34447','49064','47995','64505','19548',
                          '25602','76711','15959','40191','19876',
                          '61613','69413','12458','88800','47192',
                          '36433','41810','10220','46408','61227',
                          '56845','12706','62506','53004','88833',
                          '12343','69425','38503','71389','63540',
                          '91001','43893','38742','97554','37251',
                          '62764','66005','71139','50208','66525',
                          '85043','78032','72862','74392','39564',
                          '19188','53492','82574','36910','62755',
                          '33490','60548','34495','66625','66246',
                          '86895','48464','51120','14338','20999',
                          '93028','50734','20108','17880','58736',
                          '50557','21179','97262','91808','85733',
                          '36885','56725','30197','96047','46123',
                          '62886','50283','30762','47300','78553',
                          '86344','28269','26239','36655','34130',
                          '49163','64063','21619','70359','73632',
                          '68426','89951','17481','17943','54491',
                          '96068','94000','53978','93489','96544',
                          '62950','96190','32237','86790','91326',
                          '95670','21055','90097','72605','37180',
                          '59664','62092','65488','56610','75918',
                          '26514','91754','78804','62147','54530',
                          '38695','50342','54229','95760','32390',
                          '36095','13302','56375','20417','57597',
                          '95658','31972','81455','73723','12546',
                          '58570','71815','22017','38744','99674',
                          '38475','25910','48095','29252','81377',
                          '24232','96027','12816','21033','86917',
                          '44284','93488','26333','74382','70440',
                          '79707','54879','75965','50967','90921',
                          '51850','67567','31504','43580','16266',
                          '64046','73846','48493','46888','19160',
                          '54237','87494','83723','57934','41947',
                          '87143','85618','24500','50820','71758',
                          '69163','65191','11706','29450','40306',
                          '76354','77718','70343','86239','10494',
                          '84986','44250','47018','52796','18438',
                          '74479','79788','40763','34770','24264',
                          '21522','34731','98023','21368','11618',
                          '85754','91999','88646','43555','30630',
                          '35459','72378','43740','29620','46691',
                          '60090','10198','90699','40741','16451',
                          '91200','15837','60244','14827','40322',
                          '87039','58623','83389','10331','71430',
                          '18319','78011','37524','27337','48216',
                          '28156','67655','68684','13622','13525',
                          '14115','63932','72781','58599','70321',
                          '47652','96731','21558','91589','27336',
                          '48859','40264','59271','95933','63682',
                          '38732','81901','70399','79847','36954',
                          '33775','35419','14195','85486','98763',
                          '49328','51729','17811','30274','36113',
                          '65292','26954','87101','54022','28553',
                          '79022','39941','53456','41684','47160',
                          '69805','18399','35479','24270','45237',
                          '46560','93891','61164','16512','67076',
                          '45851','90867','68953','25360','93390',
                          '27151','14053','37503','42127','55281',
                          '29971','38818','85785','10716','79704',
                          '26926','42649','34183','79978','97349',
                          '73910','93400','73622','72858','67707',
                          '32752','41804','99725','70065','24441',
                          '19344','14000','53278','56580','33848',
                          '79414','23463','39314','75201','16510',
                          '84661','33715','13773','65316','14904',
                          '55376','42911','13183','87674','33973',
                          '56806','14184','98759','15392','57727',
                          '39193','48034','40808','82133','68516',
                          '99409','90965','37068','49771','32720',
                          '98021','32135','39112','61190')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


