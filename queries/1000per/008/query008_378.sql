
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '56056','85007','40177','63941','15804','57129',
                          '12333','41877','37907','60969','55019',
                          '39579','66500','54265','44927','45942',
                          '71780','23621','20613','16679','34682',
                          '41789','44300','32588','11691','23466',
                          '65508','60711','46322','48237','84253',
                          '53147','34149','31706','68257','49790',
                          '10932','62887','93727','57018','51413',
                          '26670','99034','51394','42643','10910',
                          '93662','69508','57072','96008','19469',
                          '48185','15665','57198','92059','97419',
                          '44098','93440','38997','70416','64663',
                          '95909','86188','87195','16784','70108',
                          '29863','26559','67081','73307','98482',
                          '95495','93550','53974','51800','69317',
                          '97603','89299','50570','40497','24810',
                          '53709','85485','67535','15775','38370',
                          '94518','38876','41089','40862','70445',
                          '81720','25514','37810','42951','59763',
                          '24926','28447','37295','26564','48150',
                          '23739','54079','26337','49810','50205',
                          '65294','59146','75818','12461','92623',
                          '10899','65185','30896','81413','37539',
                          '89594','33656','75106','16015','23317',
                          '86570','75544','82827','71616','67356',
                          '41017','96194','51986','29933','42137',
                          '84037','79904','22822','55018','73800',
                          '39654','44949','84986','71427','44089',
                          '64068','40580','20273','68703','41676',
                          '14631','36114','58731','94763','64696',
                          '37403','63136','53621','53006','24166',
                          '53809','19830','59452','63965','66072',
                          '72111','26450','49416','41160','66481',
                          '27092','15610','29223','84316','35668',
                          '10209','47573','71426','51100','58272',
                          '99710','38868','82207','82605','51277',
                          '25401','52803','95162','76491','38098',
                          '13731','88259','42761','92527','96983',
                          '17948','44553','29166','77122','16348',
                          '13550','34915','50061','69915','11606',
                          '29683','39180','82461','78680','40547',
                          '61859','72930','43126','81872','94384',
                          '58547','47054','66644','34892','61716',
                          '53428','59497','67849','23306','32345',
                          '42194','70952','29353','93520','27793',
                          '65360','56657','17046','65376','24035',
                          '81150','42380','99552','30504','37126',
                          '23293','10189','46220','42937','95950',
                          '31903','95445','48668','14374','64770',
                          '91224','73767','24954','70828','17362',
                          '27331','17287','59095','25161','66043',
                          '90029','98053','52853','37740','49494',
                          '89347','35970','29960','74588','89549',
                          '44522','23676','38477','70083','67805',
                          '67363','71848','43339','55926','85268',
                          '66236','94862','71759','62835','20634',
                          '97549','45088','71832','30739','48478',
                          '79093','43409','31057','24729','85672',
                          '67549','12666','18462','89335','51200',
                          '98543','77854','78996','16603','45822',
                          '90009','59386','81924','47434','64317',
                          '22425','89517','11052','86711','70037',
                          '15338','12538','98207','47253','54918',
                          '50037','42552','11248','75120','79498',
                          '39875','16786','94541','93146','49007',
                          '93689','13880','49528','88850','97436',
                          '23889','41259','99223','93920','52375',
                          '96489','89248','45352','34312','59244',
                          '31300','72359','37002','41171','15160',
                          '93155','89796','36119','87876','90560',
                          '33457','66745','91433','38472','92615',
                          '89396','87887','63921','15806','94010',
                          '40337','57869','39133','16115','15742',
                          '76608','69227','94743','49533','19006',
                          '71982','43632','63629','34434','15144',
                          '15532','28243','34741','55841','41309',
                          '35985','71564','47580','86343','81583',
                          '68283','67657','29730','94016','35350',
                          '40631','94271','42490','55566','97913',
                          '41184','82735','38024','86556')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


