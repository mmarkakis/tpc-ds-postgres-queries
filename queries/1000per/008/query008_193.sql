
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '84435','99476','99815','90203','37509','29638',
                          '30329','55805','45596','42012','90830',
                          '54822','41640','78072','68437','78181',
                          '49379','87527','53565','71531','40179',
                          '96927','32863','74472','97592','90528',
                          '17032','90176','70236','21379','15736',
                          '23480','70971','92734','73035','35592',
                          '19023','19842','75546','66512','80018',
                          '89564','45203','14888','38532','67824',
                          '46446','76513','50897','22184','85965',
                          '98059','83611','64413','41607','70394',
                          '33248','83748','40150','30834','79457',
                          '76299','28277','64394','92769','69662',
                          '93683','15014','43119','39868','81007',
                          '13442','41144','35787','89225','87142',
                          '55436','21015','10787','57708','59854',
                          '89673','26449','36378','64873','60488',
                          '80382','55010','51121','29551','79441',
                          '12280','69138','29834','46571','10403',
                          '26573','10184','71647','16063','32149',
                          '46933','93443','64793','58614','90885',
                          '95987','91930','96933','29734','28028',
                          '33401','28157','92813','15340','32405',
                          '34276','53756','91045','27187','51460',
                          '32408','57045','88730','90082','45771',
                          '50813','21930','14950','92073','24255',
                          '93689','94501','70964','74732','88325',
                          '23159','44198','61063','64499','52236',
                          '92230','96058','18351','52001','32430',
                          '45149','47202','16843','27259','13929',
                          '45215','91231','67591','94709','46921',
                          '42186','86020','78781','56060','62951',
                          '61933','21198','46113','43686','91391',
                          '42924','32664','56188','10368','53988',
                          '49505','37357','11587','42630','74440',
                          '92674','30140','60310','84948','61279',
                          '60867','44380','72682','32780','88859',
                          '13518','84215','98165','22753','21757',
                          '24315','29128','72571','31547','49242',
                          '65611','63213','63442','96948','23636',
                          '86516','66584','23730','41019','51792',
                          '69433','45324','34798','59679','90627',
                          '48906','52579','39797','83380','19879',
                          '55629','42191','92076','46926','88448',
                          '79233','26600','36330','79517','34361',
                          '32046','67492','85405','72735','40001',
                          '10807','52829','17818','88944','55670',
                          '42877','89571','62381','15576','70838',
                          '10676','33337','42515','57291','81360',
                          '10570','91500','23079','43773','66698',
                          '26899','40850','55721','72315','56257',
                          '15295','72657','11877','57688','94229',
                          '58242','46485','63405','72075','16220',
                          '63991','29515','25275','77982','66880',
                          '69539','77250','10121','71602','18433',
                          '93175','77878','74178','13333','55648',
                          '56611','87054','23763','28206','74905',
                          '29023','77080','35390','14862','37506',
                          '25083','95355','61266','99078','87884',
                          '65044','55793','97240','67061','65297',
                          '45140','74564','69585','25323','86568',
                          '94869','97362','52519','99767','72618',
                          '10965','21207','54675','38597','22763',
                          '93894','71285','15433','46844','99861',
                          '53881','77309','24193','91918','15632',
                          '53834','83088','43917','37759','18143',
                          '15410','83772','68874','18869','82880',
                          '77630','36213','94305','11114','74630',
                          '84822','68476','90077','89961','49822',
                          '91458','76573','55530','18369','82132',
                          '32425','89785','48373','48544','57933',
                          '75445','65754','22202','40402','72375',
                          '47855','51275','23046','93131','20729',
                          '80142','26310','73058','71907','22784',
                          '42685','25773','26770','91052','12743',
                          '87031','78184','76510','72050','40623',
                          '58464','87221','97197','15006','39554',
                          '63931','18675','80591','38091','48213',
                          '51349','85939','21221','18705','63833',
                          '27260','99848','37711','76272')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


