
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '66170','65188','60342','88721','52669','33857',
                          '85729','10497','86395','87581','14062',
                          '76641','39143','90884','87393','32681',
                          '81296','12722','52259','54976','58798',
                          '86003','38696','78125','30906','82156',
                          '21424','80109','93502','49201','53168',
                          '52344','41100','21131','98420','51883',
                          '45144','44683','90640','16765','94016',
                          '84489','93962','93627','49754','89204',
                          '65032','83743','35305','37691','85789',
                          '99653','15390','70927','45272','29570',
                          '48158','88814','74300','34629','49891',
                          '26288','51063','36289','55183','48307',
                          '61694','72564','77352','35960','52415',
                          '96053','77600','96875','50014','14692',
                          '58295','85743','15810','33515','18890',
                          '22253','24790','44047','86008','96747',
                          '46539','40709','24092','26795','38085',
                          '94510','18610','98555','90558','85962',
                          '82174','81111','61134','88372','49446',
                          '13615','15194','13668','81225','96665',
                          '75159','13999','72988','92925','61346',
                          '56124','41256','37308','12143','34129',
                          '28510','96869','14345','37183','89012',
                          '66971','31146','24170','72398','51647',
                          '29010','80854','22310','62230','92858',
                          '70024','78440','28661','43874','94745',
                          '21035','30639','20748','64359','82051',
                          '54176','50001','52921','55461','69907',
                          '19598','37422','59535','37212','72757',
                          '22901','32195','38673','21374','50461',
                          '92787','81210','18030','91761','19952',
                          '79893','37767','54431','74919','28251',
                          '68046','84140','78348','99225','63534',
                          '44515','31037','42505','77828','28128',
                          '19373','48950','18378','34208','63105',
                          '59923','38254','90159','53444','34092',
                          '32828','22798','40639','29056','23920',
                          '85079','91173','34504','37021','76172',
                          '30877','93623','12595','90956','81691',
                          '79955','32920','10279','56912','39484',
                          '23941','88595','54493','28976','58262',
                          '43649','49024','16876','82026','69739',
                          '39864','51431','59675','63066','29773',
                          '95349','11566','62917','85523','97552',
                          '38694','42729','31855','21443','79534',
                          '71288','39664','33815','54721','82466',
                          '82931','77699','37905','55252','19923',
                          '85699','45036','73604','70571','83260',
                          '58117','39466','51289','83054','59368',
                          '96866','75540','91014','38870','90893',
                          '26268','80947','94717','15452','11916',
                          '96120','73012','54753','66738','95513',
                          '58823','55417','47011','81745','19409',
                          '81493','30584','10898','52125','67643',
                          '69992','77182','76282','47852','58813',
                          '23094','23538','65613','77253','81717',
                          '36285','74112','76002','88374','43460',
                          '77304','28709','75226','47042','38407',
                          '12395','71233','57368','23609','26397',
                          '89502','74500','85536','47603','83520',
                          '57016','15128','36614','81514','43828',
                          '62430','93744','10179','63040','11804',
                          '49596','70034','33220','85884','28148',
                          '43453','43021','16036','78268','76451',
                          '36973','85516','53560','30646','69231',
                          '41913','78785','37930','97375','81860',
                          '57655','75685','73209','87410','29951',
                          '86007','23497','18142','14528','70824',
                          '14998','41329','47066','44936','90173',
                          '25662','88547','34168','12073','89337',
                          '88700','14064','84624','60594','30821',
                          '25229','46252','22190','32232','70827',
                          '46253','85735','73680','88911','14421',
                          '50747','62688','12652','97986','61293',
                          '36978','37260','59881','39845','37390',
                          '82238','49243','95362','65714','35585',
                          '17052','90940','51115','51610','82634',
                          '47351','47306','39729','17100','30280',
                          '76791','31885','53252','83113')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


