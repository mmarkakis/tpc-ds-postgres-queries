
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '30902','59484','86616','83689','11761','67005',
                          '60095','21552','46272','49522','80822',
                          '37360','46577','20848','50978','26834',
                          '53846','92305','30240','28751','46082',
                          '39617','85630','73248','72470','73936',
                          '50710','84610','16655','81410','61452',
                          '11296','58916','90725','54635','81027',
                          '86376','72318','98117','74497','52614',
                          '25557','37338','30352','45874','73255',
                          '64221','49838','68414','78455','97456',
                          '73857','59667','91320','95328','85539',
                          '91363','87142','10219','75579','25107',
                          '93945','26801','66033','26725','13397',
                          '36687','28788','17330','91970','42981',
                          '41909','57653','19747','55701','46668',
                          '95287','48854','44196','67971','31683',
                          '31177','31530','95366','77041','52906',
                          '83706','94983','89527','79599','36532',
                          '52369','35333','77764','33233','17978',
                          '75327','10828','78135','76175','18904',
                          '66551','54338','62878','20999','63721',
                          '24176','75333','72204','63016','93850',
                          '76826','90438','89105','39054','62096',
                          '10955','33009','80341','30696','13637',
                          '36454','54595','35407','85915','74515',
                          '44099','18550','10555','67819','64767',
                          '41428','89985','55391','94594','71666',
                          '61070','33249','36184','88365','21363',
                          '53839','88280','65385','79990','52026',
                          '94904','54271','93702','70610','93457',
                          '81915','77635','12243','81329','42371',
                          '60271','16209','45173','61906','17602',
                          '42266','82772','28124','95682','81711',
                          '16020','84495','85569','56408','16097',
                          '92875','53961','10634','50056','30219',
                          '93026','20324','79944','25519','78892',
                          '82888','86510','52210','89330','19515',
                          '51895','41637','27122','50125','30550',
                          '36312','25995','56889','63256','97245',
                          '12366','13282','36657','98262','84019',
                          '11140','92428','49581','81715','55252',
                          '44682','67246','27786','55880','28547',
                          '48504','95431','29735','62455','19640',
                          '94089','94654','80464','70098','60749',
                          '80605','83937','50003','11378','58760',
                          '48805','50685','39485','86719','21183',
                          '12707','51648','61806','37516','81437',
                          '14734','42359','65982','29725','69065',
                          '30836','10460','59010','14353','75226',
                          '30177','70624','67388','29559','41341',
                          '25953','33345','68634','25349','13805',
                          '11727','81479','42610','71931','15992',
                          '78267','31727','31967','35755','72458',
                          '92802','73498','36469','96074','88112',
                          '50514','59881','94507','46673','80342',
                          '34754','46614','68619','80786','94344',
                          '29645','49245','76837','91458','11325',
                          '29173','10185','10612','55823','95358',
                          '36959','45369','66036','75435','64144',
                          '87616','87681','49346','94003','95245',
                          '79924','53809','51556','79338','98893',
                          '15358','13348','36582','98986','28886',
                          '16642','90123','20144','22519','18121',
                          '13955','10886','20392','83095','48134',
                          '93513','94326','87612','88999','39914',
                          '14791','89946','72044','32726','40679',
                          '21247','77925','19953','61314','99219',
                          '41385','28146','40609','98558','59069',
                          '14185','82605','19230','97866','73601',
                          '67323','46080','27747','28769','98266',
                          '62566','44663','18382','67461','50143',
                          '55553','44111','37810','62684','74920',
                          '88337','25387','36395','50350','13563',
                          '95314','78423','82344','84689','37358',
                          '97736','87633','54396','60994','61110',
                          '56488','81234','10029','54262','20849',
                          '99635','25161','34307','13993','81627',
                          '39783','80702','66436','64450','21134',
                          '49638','70176','48414','14178','53217',
                          '26222','35532','85784','77319')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


