
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '12129','49632','23045','71342','53336','71506',
                          '62287','66531','15557','94537','73385',
                          '53261','39358','64353','95602','93367',
                          '94150','51386','89268','51931','37559',
                          '54804','87624','54698','46000','41078',
                          '91598','81786','46117','73627','63746',
                          '34773','74822','56939','75536','33301',
                          '62665','38795','29978','25323','24936',
                          '19717','51210','30325','32836','96559',
                          '88398','52232','45588','55551','54572',
                          '28617','59270','25832','32670','10972',
                          '45374','14236','98459','32895','18185',
                          '90596','71728','72921','10414','60236',
                          '93202','52192','34933','51227','97148',
                          '80945','68490','12127','18295','15796',
                          '34104','57925','91041','77570','13371',
                          '20685','76955','82570','98839','79927',
                          '80373','87405','52185','32706','21058',
                          '70537','27800','39024','32541','27004',
                          '84225','40994','63189','25105','86440',
                          '18310','74279','88573','97543','40018',
                          '77104','78784','42122','48617','42646',
                          '76865','25351','27570','11943','66040',
                          '53112','69714','57834','27298','14534',
                          '28163','15007','47104','83088','94874',
                          '98090','92540','32362','58209','20301',
                          '50678','85827','40806','18787','34430',
                          '95174','37078','50964','79619','47942',
                          '73321','56000','38232','33105','80977',
                          '17883','47205','65148','56601','92521',
                          '95471','23761','45412','81057','32907',
                          '67460','11870','64974','94978','55512',
                          '68573','88440','21604','17574','12538',
                          '42831','74906','44211','48271','30882',
                          '70662','66419','24783','41172','83338',
                          '93981','81499','25218','48163','50796',
                          '79354','57592','50871','48465','21995',
                          '57081','61716','47109','51606','73241',
                          '83737','67380','88104','18714','63428',
                          '19481','60148','51563','39099','77162',
                          '96283','66608','96515','29341','89457',
                          '62937','34017','82976','82892','83426',
                          '10127','38862','66190','75113','15917',
                          '57173','68877','37754','61021','43695',
                          '14296','64590','54211','60864','61036',
                          '64516','71439','43486','89119','31072',
                          '13517','84348','51345','79575','99606',
                          '23121','50199','83791','23260','37014',
                          '20860','33638','91700','75875','27437',
                          '50253','57344','51748','81708','83713',
                          '51075','55975','26161','63572','53164',
                          '32311','27872','92070','28949','45806',
                          '71332','97406','56829','31820','35672',
                          '10749','73125','51312','53090','63155',
                          '86179','83707','19956','60391','57762',
                          '44457','48526','49368','75147','18058',
                          '22892','90379','59599','63342','99625',
                          '49524','54719','58449','63311','58541',
                          '58588','17667','56519','43413','84412',
                          '51231','98007','63266','95317','65383',
                          '45289','23278','50909','92187','82951',
                          '83070','55176','12578','25818','10655',
                          '87106','33213','14272','34366','93949',
                          '12898','13000','47546','74351','71021',
                          '39951','71215','40750','60356','52595',
                          '49339','67811','24639','64327','29359',
                          '61155','59719','53628','41051','44265',
                          '10113','87871','56545','47140','15771',
                          '19337','41037','36108','30509','40418',
                          '38462','63728','49394','60358','15991',
                          '62641','44431','42737','81967','34322',
                          '61710','89104','47707','67198','48725',
                          '17286','36633','67244','44350','53441',
                          '45899','11776','59499','10332','56588',
                          '17726','28283','87526','39371','91605',
                          '77797','81789','65462','84301','68724',
                          '24105','57466','13046','12414','76909',
                          '85206','43678','59771','67344','88409',
                          '98823','40340','35370','38101','98526',
                          '28405','60318','67877','57001')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


