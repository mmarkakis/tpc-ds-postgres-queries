
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '64651','19842','19760','83602','86521','30118',
                          '42904','20705','51633','11813','60329',
                          '43817','17199','86761','18559','76517',
                          '60170','32301','35162','87062','33138',
                          '21622','80873','27072','21167','58154',
                          '68108','37321','96378','91785','24267',
                          '19330','34260','20453','40223','87103',
                          '58401','74674','38528','15458','34356',
                          '90364','22565','22797','93456','66264',
                          '14664','47065','50257','71435','28402',
                          '69295','21443','88554','46363','84216',
                          '32416','66363','93890','82735','84984',
                          '56713','67808','64979','90011','52183',
                          '71294','15673','93578','74503','29339',
                          '76077','25211','32108','76657','58801',
                          '75786','58293','86163','21404','27274',
                          '63273','44845','87638','32815','83490',
                          '99645','46469','61825','22976','72405',
                          '81615','98588','44004','66492','78701',
                          '40408','55124','94696','35516','47106',
                          '58932','46651','27883','82411','39124',
                          '83570','75990','91727','42514','13048',
                          '81368','83867','41501','89525','45078',
                          '11163','10865','47163','98529','24714',
                          '24441','85071','54530','48686','98927',
                          '37021','60950','40774','17146','76126',
                          '15050','85112','34826','86268','37596',
                          '94521','68179','31942','39702','87138',
                          '54764','64057','61384','80742','55220',
                          '45350','90555','53265','92647','36174',
                          '57314','86261','67952','79761','63393',
                          '77681','94860','67718','20797','66324',
                          '38628','13812','50442','97480','65794',
                          '60418','83054','74186','65735','98868',
                          '95105','38271','56216','13606','71666',
                          '78907','92080','27224','33889','71673',
                          '95667','39378','13647','10415','69931',
                          '58706','46874','92719','36946','58044',
                          '49702','76189','95087','90579','30869',
                          '96972','84862','90816','59599','25883',
                          '14232','45019','98645','93765','74185',
                          '23234','62475','46230','98043','22095',
                          '92756','21560','51388','54044','82936',
                          '50377','47565','24076','44913','73531',
                          '42320','89214','50986','55132','87324',
                          '67509','72893','89033','97101','64379',
                          '64021','72000','83057','71867','80372',
                          '12643','72172','67824','97708','88347',
                          '77500','59714','13791','13387','72590',
                          '20831','97969','62734','82539','40508',
                          '77165','37003','10807','71464','30306',
                          '79108','48863','84081','39600','18481',
                          '42240','96533','60800','34200','97379',
                          '63138','75995','12213','81631','52793',
                          '94157','31935','29197','26068','79228',
                          '84819','99126','93643','99786','45443',
                          '41631','12048','35370','41198','24598',
                          '56706','33145','52149','41985','45825',
                          '47790','38467','61128','78110','17776',
                          '57144','69935','20995','48707','88906',
                          '47231','93640','21961','37580','46240',
                          '61607','31213','16955','90420','91826',
                          '30692','17771','70748','46035','58569',
                          '74647','21956','74831','50071','10252',
                          '65712','96082','23228','48005','35489',
                          '98345','56259','13071','25088','83911',
                          '19554','40159','90652','20185','34224',
                          '58081','82725','67265','60014','85720',
                          '43238','78013','86029','78456','42401',
                          '84967','30231','44652','13917','24756',
                          '43125','79290','25660','55805','36759',
                          '10058','42687','64514','79933','71214',
                          '60066','52125','23395','48665','23124',
                          '92315','65611','83688','54208','16451',
                          '98581','37512','95808','15497','51378',
                          '99456','93029','82788','28605','96015',
                          '86599','16409','56981','39998','66552',
                          '61739','65773','63148','23932','34923',
                          '62143','79375','73918','87383','27816',
                          '56181','90071','27904','14307')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


