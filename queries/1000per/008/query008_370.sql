
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '59521','96391','73786','87761','54389','36158',
                          '25271','10782','20304','72609','16655',
                          '47900','33527','38779','60860','72566',
                          '45243','96551','47861','56013','30908',
                          '51036','44564','18912','62438','36122',
                          '96349','37506','40734','81071','17365',
                          '75080','82355','84910','53269','43452',
                          '56772','55781','20918','50136','63484',
                          '67997','15257','69004','67519','46105',
                          '61166','97622','89768','91813','79052',
                          '80822','73171','28808','13218','33899',
                          '27971','53979','87375','55530','14883',
                          '20516','64925','74871','51665','21525',
                          '28621','59924','23285','40365','87346',
                          '38595','18129','97479','61618','32175',
                          '73113','47211','39918','60885','89182',
                          '69788','91808','36690','18453','42819',
                          '75563','36912','44204','18584','92153',
                          '53164','57446','79531','44205','72704',
                          '10401','60124','54665','83922','89164',
                          '77147','87992','81909','52759','58506',
                          '87556','48155','30460','83889','53232',
                          '19161','38911','53964','68700','36969',
                          '46871','76106','58469','88655','79109',
                          '78533','78414','54435','39163','72437',
                          '40590','19421','64029','27731','57666',
                          '81297','52621','47276','69189','97855',
                          '41349','72362','55767','34123','54495',
                          '15922','10730','73540','13396','33531',
                          '25772','22242','10564','43697','23225',
                          '65520','79756','90449','73243','11106',
                          '14135','31886','55540','58018','71249',
                          '22532','85752','80366','39725','79455',
                          '83221','42577','42944','14679','16438',
                          '66542','81501','77430','36831','63827',
                          '87714','53659','22343','47101','13250',
                          '74207','31925','52958','70234','63936',
                          '52051','75099','93879','37336','20507',
                          '57736','43401','66113','62720','80159',
                          '64232','23457','88984','66830','97253',
                          '68237','11243','74371','34732','11720',
                          '81688','23295','80980','77918','72935',
                          '97186','54734','35490','83018','26218',
                          '34947','68564','94501','47850','80979',
                          '87583','82753','30753','81454','66659',
                          '71995','94748','47810','59094','15534',
                          '32298','25256','83218','81650','11554',
                          '16179','36006','34888','67870','72687',
                          '74791','78420','49549','10978','30463',
                          '31442','63265','58581','28928','43921',
                          '36887','34724','53800','14992','22843',
                          '21281','58783','45952','14890','54756',
                          '62751','32134','76645','38097','98763',
                          '38491','80997','60101','46066','77618',
                          '99063','75283','59551','77577','34260',
                          '71611','53590','70962','84087','92582',
                          '97310','69364','32700','95257','99716',
                          '26633','70016','43323','92553','64572',
                          '20869','30076','38995','33862','69753',
                          '80284','53768','98979','40186','21625',
                          '53629','15346','77227','59793','30002',
                          '33073','46434','12060','67960','45995',
                          '16271','64457','97025','75246','36547',
                          '17594','68194','98079','56649','89951',
                          '59825','73202','58882','43573','26340',
                          '49459','98933','74153','57789','44677',
                          '14058','51939','35884','44081','78760',
                          '72727','59871','90205','64187','44787',
                          '88254','58838','40703','52948','95315',
                          '63091','57825','39988','39955','10666',
                          '89984','41619','62644','55446','45198',
                          '61817','32524','82473','35685','22710',
                          '55440','75473','85460','83972','39951',
                          '79250','53605','90407','61477','19330',
                          '65710','75590','73859','31054','39560',
                          '59136','72724','33615','29478','33090',
                          '72555','79718','78060','64013','66205',
                          '66492','28773','39811','94842','82117',
                          '87840','20985','61603','11973','86530',
                          '67820','61412','33636','44798')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


