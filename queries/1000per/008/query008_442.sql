
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '88883','37635','54794','98789','45281','94733',
                          '89756','49058','58518','36803','96093',
                          '53132','28554','33018','62086','70067',
                          '33394','30113','91734','25146','46511',
                          '51185','63867','38895','48263','83299',
                          '15906','24849','17109','40644','41801',
                          '17956','14665','64353','93537','30657',
                          '52532','58707','10368','99287','24892',
                          '90423','59491','98459','91514','95903',
                          '91171','34555','41620','19405','37962',
                          '27914','50044','26365','56383','78868',
                          '86192','73364','57735','29703','22905',
                          '82157','75166','82174','60634','23745',
                          '45168','86960','21959','66189','46998',
                          '22377','93753','52990','43020','77109',
                          '93005','35771','40963','45138','20239',
                          '30641','89561','86366','21931','26654',
                          '20910','61355','11397','87623','81912',
                          '46352','80703','10020','63229','49734',
                          '45974','77094','65245','16229','44470',
                          '65363','61778','21679','27180','43350',
                          '99672','28151','72274','98415','94437',
                          '63713','46942','26568','99723','33316',
                          '50977','29348','29125','46037','14940',
                          '59876','43178','39203','43068','98795',
                          '55835','91337','51729','49008','80857',
                          '48030','23520','51528','33700','20213',
                          '93794','84688','53946','69262','25034',
                          '79752','38239','98648','46924','66375',
                          '39183','10449','53235','97262','83580',
                          '53112','88145','68996','83117','55049',
                          '63397','47125','78561','31805','98635',
                          '84767','11227','43492','37414','70595',
                          '63438','72374','95392','98157','29058',
                          '68274','52783','50447','79123','49916',
                          '23920','97778','23095','16483','52976',
                          '77890','93674','33619','97869','29971',
                          '30821','84404','27450','14309','59328',
                          '79805','92262','86836','83074','61012',
                          '40070','50280','27651','99540','47236',
                          '83295','58872','36191','27741','27210',
                          '48564','80141','73732','79697','51901',
                          '22931','42824','93916','15611','35611',
                          '84423','43476','94475','82229','77782',
                          '10748','61084','92291','26847','54622',
                          '35758','32567','29855','22583','71848',
                          '55198','32111','70771','42540','49261',
                          '98241','31557','60191','87721','18925',
                          '19808','15667','61968','17096','13838',
                          '75431','52481','45055','58284','39897',
                          '59502','88681','33046','44164','20470',
                          '92328','12356','20723','41487','27590',
                          '94458','16987','96425','43911','77285',
                          '42144','54081','53839','52440','30081',
                          '22741','44837','87638','32930','93014',
                          '66741','79992','34763','63896','50643',
                          '55840','86125','80468','36745','41204',
                          '91269','89276','27602','70445','33101',
                          '71958','48919','14167','90413','86456',
                          '10239','63095','90178','65884','64378',
                          '27361','74204','25445','23765','90933',
                          '46882','60704','64504','43115','23909',
                          '52236','97639','15281','15942','66725',
                          '39329','49304','54614','27573','45543',
                          '32369','34361','15131','10019','29064',
                          '68523','67437','27689','98167','14881',
                          '70746','47551','86577','68378','54681',
                          '39880','98005','39319','77598','63673',
                          '84594','14550','80309','42927','39785',
                          '22809','41941','57056','20064','16795',
                          '47569','25111','91599','26879','57966',
                          '82430','92971','84843','65745','84623',
                          '55730','62571','26287','26835','42973',
                          '59554','68805','52114','77811','76491',
                          '58914','66963','77822','99613','90591',
                          '25286','75264','32862','38552','20446',
                          '41765','69892','82774','14420','15900',
                          '57654','66967','46008','40280','47219',
                          '23972','66955','89537','93628','71996',
                          '77307','15203','66619','43475')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


