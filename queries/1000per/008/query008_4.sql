
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '32490','80133','59564','27233','31195','74873',
                          '49881','13892','86207','75229','65896',
                          '23072','22835','33052','72756','87398',
                          '45674','48994','39431','20846','66681',
                          '65151','94085','37562','17374','40551',
                          '46813','27027','65540','25438','68986',
                          '63254','57831','66390','85787','19152',
                          '74046','33775','52283','21619','36554',
                          '67172','54289','45204','80935','43344',
                          '64283','30424','34055','77848','35728',
                          '25600','97795','76654','19815','17081',
                          '21040','97661','41336','36523','37437',
                          '28645','35340','51449','93082','79408',
                          '35536','60725','19517','10373','64505',
                          '43894','89282','47657','49668','10230',
                          '45233','23784','53712','22443','75091',
                          '55094','19397','90929','17945','48661',
                          '64741','97815','19675','13063','80566',
                          '89785','15734','67718','23645','98852',
                          '81276','26639','35287','20813','71390',
                          '22970','82989','91358','35225','25402',
                          '91462','10654','13987','14795','64804',
                          '63781','49236','65485','17910','95923',
                          '39071','27201','68045','25588','17939',
                          '43782','74656','46429','32012','37539',
                          '85167','24503','50296','13486','84526',
                          '24023','22302','93280','68039','88738',
                          '41665','16136','40887','77281','88472',
                          '43699','49458','84968','27482','54271',
                          '61812','11596','10198','75859','59166',
                          '13824','54360','24990','40678','83853',
                          '18308','77081','64728','54301','39240',
                          '22549','88564','86354','19498','45730',
                          '60561','84545','28627','69495','22716',
                          '64853','76113','52205','56548','96326',
                          '68928','14901','96908','72550','40769',
                          '68253','85910','41588','57779','32502',
                          '73174','36235','19833','24542','37097',
                          '16758','32271','23538','62335','10019',
                          '97239','98318','15239','57446','42865',
                          '26330','83840','37114','11286','81632',
                          '12544','92809','43767','78584','83823',
                          '15036','63713','47975','63902','63292',
                          '25430','21182','59057','86422','49121',
                          '40027','81419','43925','20524','87983',
                          '21822','68191','76417','93014','63909',
                          '86640','30566','16176','50935','42919',
                          '51350','11631','85160','84840','64709',
                          '90765','97089','21806','16816','68294',
                          '39747','60921','35749','95100','51838',
                          '11721','33857','76555','58545','31814',
                          '87804','47999','69497','91498','17845',
                          '45225','17567','65864','50319','57774',
                          '77123','83613','50464','17503','40533',
                          '99960','94458','80012','49246','19702',
                          '67202','71266','43596','90358','54703',
                          '38674','16511','13010','84297','80138',
                          '50495','59286','61377','82813','84072',
                          '10775','92602','23383','78574','51189',
                          '99628','37223','40927','82218','67970',
                          '60622','75356','14696','86530','20282',
                          '73480','90684','82414','30411','79303',
                          '73396','42212','30379','11648','96036',
                          '33147','83350','10603','63986','53794',
                          '66233','12557','61902','58867','11765',
                          '49301','85512','64079','71983','55686',
                          '14321','31747','42910','51179','48814',
                          '98103','90450','44160','66586','82162',
                          '82087','28216','93605','64647','81083',
                          '30520','39257','77366','58370','95989',
                          '11154','83201','92181','50984','95103',
                          '67822','45454','71812','33151','14137',
                          '84208','71044','66111','66351','47974',
                          '78642','71186','39450','83373','80020',
                          '14803','54550','48784','44462','26683',
                          '84275','79531','88149','85090','92941',
                          '63518','40347','54000','55782','85163',
                          '12516','66948','36635','26691','28575',
                          '83438','69170','30158','90030','52806',
                          '51997','63427','10649','42552')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


