
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '62545','88968','52442','77847','97946','75395',
                          '23161','15293','70289','41547','35482',
                          '86250','82690','50613','87164','79849',
                          '89851','52243','15268','59268','46627',
                          '36575','86322','65861','28133','22815',
                          '91577','97225','30271','30478','84258',
                          '62461','85356','37238','64906','57819',
                          '77748','41458','42612','13382','94500',
                          '15784','22487','52789','42870','91722',
                          '64105','52117','95040','11698','10309',
                          '37622','35726','41009','51532','18174',
                          '30162','75827','10758','69374','59553',
                          '90903','46293','90606','58366','13419',
                          '38424','56004','55647','73445','53431',
                          '57448','33404','99217','68994','45122',
                          '64484','74123','27632','48939','55776',
                          '27628','69667','88493','79149','33535',
                          '19757','33406','68340','85632','15410',
                          '52930','79997','75608','55296','18610',
                          '96661','38060','32743','23041','57704',
                          '27824','49566','68086','14904','20146',
                          '69211','30494','91676','16356','66816',
                          '35525','58150','93979','21333','72312',
                          '99279','61914','89882','23472','89701',
                          '98623','86275','65890','11793','37133',
                          '47837','92529','50365','65735','54193',
                          '44445','46025','34005','31561','92220',
                          '31175','34689','84420','27730','99630',
                          '99595','19452','56664','50786','51541',
                          '87926','65032','49522','63436','36815',
                          '65025','88780','95416','48274','79803',
                          '85179','92558','36272','12149','99979',
                          '41583','22284','42154','50252','55319',
                          '45300','33740','22958','84900','81505',
                          '67931','54605','81735','58386','93043',
                          '35238','87200','48052','70324','41673',
                          '90430','59317','58583','70707','20753',
                          '68823','50572','88817','26437','70127',
                          '90731','24130','61245','66644','42622',
                          '76629','56179','73769','45203','77713',
                          '28190','36098','49708','10104','20015',
                          '14361','38990','48820','44625','45934',
                          '22993','11317','84943','37556','68149',
                          '28450','21502','14942','68420','21476',
                          '53795','51295','11194','52417','50053',
                          '70837','62285','15582','79204','99637',
                          '19959','83140','81721','42264','96651',
                          '20322','95901','44289','59184','75940',
                          '27968','92411','61639','76504','71378',
                          '99941','65830','42371','30931','35293',
                          '12398','68637','72975','15842','67968',
                          '91624','11507','84290','92102','63612',
                          '32217','35699','44091','12467','87203',
                          '70928','50265','68061','61240','40315',
                          '56542','42499','87740','10524','43655',
                          '99473','86726','59620','62815','48116',
                          '21402','48526','73711','26761','31192',
                          '57386','68730','56223','58445','11169',
                          '42191','68664','11493','40293','44774',
                          '17928','62773','81398','31524','33339',
                          '26177','88051','33493','21794','72274',
                          '18685','31323','67773','99661','94659',
                          '36350','45912','10340','43301','95899',
                          '83785','25854','27806','71742','73114',
                          '64294','32594','83779','83826','37720',
                          '34587','15323','93991','74875','99434',
                          '57807','95210','34853','13395','32072',
                          '48270','21256','37064','79989','93135',
                          '56749','64645','37146','92765','17242',
                          '41443','54100','75717','83452','32627',
                          '13825','85082','73366','42814','26772',
                          '80699','80353','35629','67121','15873',
                          '49457','16116','80012','57788','37613',
                          '71469','28415','97995','32227','11150',
                          '50089','53706','10982','84346','53670',
                          '74452','75226','18286','63255','96029',
                          '14802','40224','18538','10820','11321',
                          '29027','30924','77877','83354','73728',
                          '91590','32382','37258','15838','94508',
                          '50312','72763','96098','76010')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


