
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '11499','55684','60278','81105','51756','10208',
                          '71326','55188','49891','20862','77883',
                          '97596','52250','73134','39704','95408',
                          '38180','53508','20271','78542','11500',
                          '13553','84224','81153','12767','99490',
                          '48960','42284','53515','86753','55448',
                          '96668','98624','46351','18616','85430',
                          '75893','41297','49361','97963','39648',
                          '83484','25083','11722','20277','26078',
                          '55762','96633','39185','53312','82011',
                          '50608','66685','71512','31860','57437',
                          '29702','55126','86557','38266','74983',
                          '79887','74052','72597','34309','16914',
                          '11595','98408','97860','86443','27816',
                          '20468','13110','52519','72034','40412',
                          '51892','21021','55660','49124','94571',
                          '77284','89534','69998','38228','81470',
                          '12129','91422','96646','80033','52915',
                          '97420','38909','66940','38120','79359',
                          '25113','75936','20438','33885','38988',
                          '30391','52828','60697','64430','50833',
                          '96012','18479','61413','59561','62490',
                          '47979','10197','20809','48383','52336',
                          '48694','15458','19701','54044','74521',
                          '25736','82635','60940','24093','59824',
                          '12544','22359','72396','86901','68952',
                          '23189','85290','41613','55634','10524',
                          '73080','60874','53911','83146','79873',
                          '53981','12765','20626','64639','24180',
                          '12847','40111','40249','23165','60993',
                          '21480','50179','13034','11562','95088',
                          '17376','70430','39538','92988','95035',
                          '36481','91277','44455','34687','82281',
                          '89715','19529','92261','98304','19350',
                          '46745','90324','39990','32011','68833',
                          '73807','58233','73986','67674','76803',
                          '65620','75638','72536','18316','18783',
                          '67752','95768','40621','95662','46236',
                          '27382','65851','43559','81782','55064',
                          '41718','14536','63164','73444','37513',
                          '13949','99310','38296','73010','25635',
                          '90753','32487','16921','93152','46829',
                          '71566','21555','47710','47799','51325',
                          '49754','93325','14514','16639','54208',
                          '50116','72364','65957','49218','41588',
                          '95570','13479','12432','98614','47393',
                          '18999','69425','68476','17764','39323',
                          '73463','80469','60029','87932','65260',
                          '43332','36732','31832','44674','30890',
                          '36287','58721','67245','51515','11014',
                          '10160','61021','14674','35017','64717',
                          '28012','53993','33261','15545','50429',
                          '20781','19738','95466','85691','73331',
                          '75594','97012','17208','45094','54801',
                          '69935','94056','40841','82115','18716',
                          '28321','76131','11142','27583','88996',
                          '66980','93002','17039','75147','56179',
                          '16003','51650','11443','31953','95194',
                          '62644','38553','26341','50887','86290',
                          '67365','78046','64159','47759','63823',
                          '31763','67216','78756','68693','72340',
                          '62434','63534','66229','18310','34390',
                          '58535','27772','32696','20590','77398',
                          '62617','22426','74101','30426','21252',
                          '35685','21680','21835','32775','81811',
                          '18281','32060','38209','60049','28851',
                          '82013','21345','63008','28302','47856',
                          '39724','16540','88328','86191','73481',
                          '64299','62986','79399','39097','22091',
                          '50189','63226','75855','48137','76875',
                          '12303','51558','20196','40852','35427',
                          '70658','94341','53721','38219','54257',
                          '69254','24805','97636','56778','32670',
                          '27752','24709','70337','56082','55352',
                          '20185','93940','60157','15914','40990',
                          '98188','98881','95033','39128','22242',
                          '20491','14061','29623','57954','15986',
                          '34277','15886','53938','86997','12931',
                          '71919','59564','99326','84555','20086',
                          '27130','31238','37671','11811')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


