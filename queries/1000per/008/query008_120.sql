
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '76019','28847','85906','33277','65193','64468',
                          '41252','75679','89907','86499','67848',
                          '43544','80435','48824','45518','97656',
                          '65968','11171','63890','80932','70102',
                          '69988','72348','14615','36006','24750',
                          '11921','58005','68761','41898','72659',
                          '58066','48193','93962','28670','21648',
                          '90966','37297','75462','25976','31575',
                          '70332','58764','44997','60218','56658',
                          '60538','47533','88265','15367','95946',
                          '59117','88652','34362','47103','73289',
                          '97990','69572','37217','87853','98960',
                          '77598','79865','34393','82407','41752',
                          '10618','55988','14998','22484','50160',
                          '67266','43228','21621','60942','93045',
                          '57407','78732','14798','67845','86347',
                          '89515','69320','13645','46142','56480',
                          '51733','84305','32679','43795','16049',
                          '84907','88470','99816','33241','40344',
                          '82761','84876','28116','70510','97159',
                          '78855','95475','20202','28826','97276',
                          '13705','98950','70215','94902','55412',
                          '15001','21393','27925','13906','83866',
                          '76644','15907','97555','96940','99998',
                          '26711','30683','13113','48625','71238',
                          '55055','55686','89212','53304','10361',
                          '67641','86933','53974','26094','78786',
                          '66914','39115','33256','25876','39748',
                          '88404','51005','66067','78715','12204',
                          '53557','92846','52215','97540','59113',
                          '12300','16139','11261','16859','87212',
                          '63052','83349','11832','99079','77968',
                          '26045','45136','86899','68202','54707',
                          '65021','10443','75836','47612','52335',
                          '96901','81407','53516','61331','19960',
                          '82962','76025','95941','58662','77930',
                          '35937','17622','50094','84414','14460',
                          '77887','71586','88158','53913','37514',
                          '74373','57481','69960','91750','54898',
                          '98114','78146','76015','64845','75341',
                          '84874','91122','46727','65672','63534',
                          '94774','33127','18643','93473','66351',
                          '28630','20884','49698','56427','99361',
                          '88311','14823','61438','79348','71652',
                          '11989','25798','19405','25900','36342',
                          '95869','54731','42993','44492','53981',
                          '51543','84233','91282','63664','72330',
                          '71958','31887','46831','35052','14908',
                          '40320','83445','26570','90742','39196',
                          '29712','26699','37279','16035','89896',
                          '20122','70969','32683','55706','64896',
                          '30411','65853','49385','14219','11329',
                          '33435','94110','82307','73636','39466',
                          '55705','93519','11067','72935','17372',
                          '34527','18377','63590','74066','68657',
                          '84628','62234','45406','66673','71906',
                          '21464','76069','47111','56340','63282',
                          '24683','65179','72830','26943','22637',
                          '27659','48250','84949','78250','95924',
                          '90113','35516','58428','35865','64245',
                          '81786','81099','79076','40723','40420',
                          '38603','61403','13301','32959','84561',
                          '30249','45978','21681','38829','10949',
                          '59003','42804','29743','75699','91521',
                          '90021','23976','97533','17303','45306',
                          '52179','92408','72484','82268','32582',
                          '56182','85449','59409','64651','88290',
                          '34841','12614','65174','35371','23418',
                          '34571','85664','73611','75975','75589',
                          '84994','63548','81901','87805','58356',
                          '24192','29891','42760','82723','57251',
                          '50794','74960','43673','48545','18389',
                          '35131','71905','74567','99253','76565',
                          '48339','39334','41436','76561','44965',
                          '97657','97360','68930','28605','88418',
                          '64728','65908','11492','10712','65283',
                          '51082','85719','75721','72321','60138',
                          '82223','40981','73126','86166','19424',
                          '32902','18735','84827','43392','46927',
                          '24853','51973','30786','11121')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


