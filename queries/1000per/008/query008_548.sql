
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '19595','55233','46791','55000','92564','20953',
                          '90996','34226','80268','16880','70490',
                          '16281','37188','83249','66161','56457',
                          '16570','27501','20332','30961','34269',
                          '76895','27565','26591','95208','86358',
                          '96261','75519','44064','32164','64939',
                          '18903','28816','86725','39131','23140',
                          '47446','68538','67891','76940','71277',
                          '73183','72453','93020','69288','48230',
                          '34192','17611','33097','19685','34918',
                          '49469','68888','23715','70431','68256',
                          '42601','42991','96669','99013','93357',
                          '70711','46467','49486','53576','34597',
                          '29444','83821','23072','19371','62898',
                          '40012','64412','35616','31393','67413',
                          '67199','91146','63806','19494','22522',
                          '70632','66357','82407','56832','15441',
                          '92535','71084','64187','61411','84719',
                          '55738','69551','58501','56056','27547',
                          '74064','82618','71198','13778','35395',
                          '51474','49661','24229','32516','74052',
                          '87804','20407','98910','52922','34465',
                          '53280','69379','14224','48287','10549',
                          '27490','78998','56758','94937','12324',
                          '59132','48564','87796','60522','96759',
                          '28964','13702','55147','76737','82264',
                          '68677','22101','31791','28198','16557',
                          '24155','92536','54745','74269','40954',
                          '38063','29871','11308','10333','71426',
                          '48058','33192','97884','82938','70207',
                          '90103','65055','56668','61433','18126',
                          '69787','68598','86658','66866','65064',
                          '95134','46480','44077','10553','44997',
                          '28114','85464','14890','95761','57013',
                          '10144','83741','29243','15097','89681',
                          '80146','17242','95845','16394','97482',
                          '98278','48673','51195','94146','67803',
                          '29329','68328','22121','83998','33660',
                          '30451','87879','80236','75286','39891',
                          '25678','37523','27791','19523','44458',
                          '45949','93704','30368','34133','56530',
                          '34262','38258','25293','22985','97943',
                          '14607','55989','76947','90719','88265',
                          '49644','22707','77261','56057','62906',
                          '55117','87826','32891','89554','85347',
                          '71486','16037','59789','32046','12653',
                          '84263','65790','83410','15656','48904',
                          '62093','81047','51225','35201','40355',
                          '79561','37562','19882','51905','34582',
                          '24919','45788','94749','92828','90666',
                          '73966','12141','27649','24217','83343',
                          '10183','71709','85844','82902','53072',
                          '67255','41412','18735','49351','58511',
                          '72797','24110','70905','29200','30430',
                          '26178','51812','44174','84997','29445',
                          '56584','70233','24557','98231','58869',
                          '18228','38853','19922','80307','92677',
                          '35504','93427','25333','91197','13950',
                          '77740','37035','66519','43554','20998',
                          '61177','26563','77166','90664','76010',
                          '86217','75070','89252','74756','15658',
                          '57719','38430','20241','46388','83085',
                          '82343','88285','51187','38086','18357',
                          '81546','14166','86537','17315','39234',
                          '44284','44934','66674','88155','78218',
                          '52395','52137','52770','52891','76908',
                          '98369','83711','51065','61209','40840',
                          '25691','55577','84989','36625','32877',
                          '81806','57352','65016','43461','33064',
                          '23878','50543','30767','52785','13032',
                          '73158','41808','69856','26756','45680',
                          '42535','34125','79446','19329','90968',
                          '83696','43744','68049','32403','84859',
                          '20105','40092','54878','74098','56801',
                          '13583','52250','57096','28975','53752',
                          '84483','26894','90028','46462','30656',
                          '29461','51404','73166','16695','29708',
                          '17916','85973','81577','74264','77443',
                          '92736','82690','84994','10076','11069',
                          '83802','85671','42496','64205')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


