
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '21527','25571','83385','21612','51145','68793',
                          '46627','77833','64947','26081','14296',
                          '84915','76230','30610','93473','25402',
                          '37503','13342','46097','12549','47951',
                          '85969','37336','61003','28422','46688',
                          '20197','29146','92463','27718','60765',
                          '32048','11747','60808','97573','39002',
                          '37360','22956','78784','50384','65596',
                          '61839','40878','77591','13855','56316',
                          '45219','65042','87015','21076','46424',
                          '76644','34796','15638','93525','61123',
                          '27950','40201','59438','13925','46794',
                          '89316','42126','71964','56989','41137',
                          '32637','60343','59559','90393','35139',
                          '98175','46464','35503','83095','58850',
                          '41762','67772','76089','45710','11233',
                          '64131','22253','88255','42998','65131',
                          '86732','80051','84935','22735','84756',
                          '71274','37038','26453','55020','15095',
                          '74909','22647','48553','60392','93661',
                          '49028','35907','72265','30126','99173',
                          '22375','15137','61854','35429','73855',
                          '29557','62877','58664','80840','50249',
                          '53464','14732','36229','94061','55000',
                          '43870','59269','41150','76356','28892',
                          '64657','37586','92296','63198','83002',
                          '96746','86486','48474','91524','61102',
                          '73852','82763','16182','21300','36219',
                          '79515','24298','90562','27020','77158',
                          '58173','17101','12505','58912','25020',
                          '20441','85852','61738','37173','25832',
                          '98924','36451','33781','18972','24097',
                          '70125','11400','59954','54409','78566',
                          '46750','50470','10850','42968','21489',
                          '99541','88535','91615','69933','49338',
                          '63976','86773','34867','67656','45532',
                          '85783','81783','31426','47943','71312',
                          '53387','41936','20208','97675','34668',
                          '17585','37961','17214','33756','89015',
                          '33659','54450','51883','48341','83726',
                          '88390','27518','68300','11319','44931',
                          '90777','46664','82223','23752','96908',
                          '41757','82147','57787','40685','11974',
                          '64520','55116','63240','43432','99599',
                          '79161','81091','39492','17667','30591',
                          '49785','97847','35427','88321','98114',
                          '89173','27222','58312','53835','75913',
                          '36235','21007','75695','32900','17121',
                          '76583','27557','96857','37756','54080',
                          '59932','65578','99447','14323','88437',
                          '45976','60498','63386','64377','92162',
                          '92356','74301','66861','56451','45809',
                          '45500','20359','13106','34306','91979',
                          '44462','37225','44013','26899','21969',
                          '94491','22717','16517','30078','46513',
                          '71387','53540','84133','28147','32654',
                          '59449','32961','47833','11284','52787',
                          '83927','35900','25215','43995','23152',
                          '36211','10599','85447','46712','96789',
                          '59139','29759','90742','72763','10865',
                          '43842','66791','53906','84824','82074',
                          '61662','54607','78306','85290','47363',
                          '14463','57213','36538','67912','62196',
                          '87804','67976','86521','69279','82008',
                          '37479','15803','28275','31355','45948',
                          '77778','79890','98986','65514','44349',
                          '46204','44060','75091','39463','14248',
                          '98561','97916','67336','19054','67371',
                          '66528','50319','90378','47517','64827',
                          '24135','42888','89240','99588','23512',
                          '96343','30963','39860','86680','62800',
                          '63275','65957','91333','90714','66774',
                          '97540','79915','78144','48885','33958',
                          '36881','10320','18755','54491','68989',
                          '72438','76764','91829','79812','23346',
                          '36142','53291','67544','65783','81704',
                          '31398','66722','10506','18642','30754',
                          '50552','57655','57982','66202','26521',
                          '98164','36169','48729','42039','42055',
                          '79963','67296','56806','25891')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


