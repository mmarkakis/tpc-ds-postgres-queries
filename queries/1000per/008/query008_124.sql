
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '60949','70695','90002','57226','76704','99795',
                          '43373','65818','80821','50185','85482',
                          '14002','48107','38578','30932','94774',
                          '89317','61853','82298','63214','94239',
                          '95930','20390','64632','71712','85317',
                          '34953','83832','47357','18467','46258',
                          '62790','84348','31351','84160','14854',
                          '62126','40768','47643','64711','62952',
                          '62836','84650','13598','20405','89367',
                          '65568','94459','45459','89935','98282',
                          '76942','39037','65510','24362','25470',
                          '43942','14296','53942','20250','80228',
                          '82130','16836','17565','51082','62633',
                          '61667','18019','85038','56344','67409',
                          '81730','40030','38173','23184','35805',
                          '92310','72614','33142','97548','28443',
                          '61763','86712','25529','34382','67941',
                          '25956','81342','61034','42298','91371',
                          '17662','27293','42634','42195','70035',
                          '40942','90125','98603','61438','28655',
                          '46549','79957','61805','27860','54224',
                          '50018','55301','16856','40139','70091',
                          '40019','81719','20058','44771','25215',
                          '96692','51832','46031','18999','12272',
                          '68720','42961','74192','44895','68411',
                          '35011','36257','67597','31558','13890',
                          '99512','26481','65384','16318','93653',
                          '12575','97847','95593','16254','28757',
                          '99726','24204','64616','56399','75747',
                          '56373','90767','80536','44217','42591',
                          '67777','91904','94583','74294','68247',
                          '74970','14034','46064','21158','28704',
                          '41970','31377','76049','67813','98133',
                          '57534','14489','38586','12951','98724',
                          '36998','93805','27816','96556','43199',
                          '12941','48624','89170','78140','80819',
                          '98362','13771','39837','36601','94535',
                          '82173','63363','76092','96699','94318',
                          '11348','74504','90632','81678','93200',
                          '72200','79898','44378','13677','99062',
                          '69184','63552','42434','62480','12916',
                          '12557','85793','82955','56722','17126',
                          '91453','25970','56190','23357','20564',
                          '98006','38068','28679','17314','84658',
                          '92522','51442','40036','49395','28691',
                          '89181','11363','30263','74349','71394',
                          '67989','23800','16827','68973','77059',
                          '52854','93344','78638','21383','24839',
                          '44290','43546','91149','27675','22645',
                          '67884','62275','74191','44076','77509',
                          '97792','24144','29168','25975','56696',
                          '71095','81820','53910','15184','27202',
                          '20487','27559','89278','44624','53553',
                          '44954','25777','30076','19040','40570',
                          '58937','24586','11542','94162','46992',
                          '73903','48441','64174','10420','86913',
                          '98425','38735','61417','28957','89692',
                          '23578','52968','47391','35941','91339',
                          '83311','62597','68281','45829','90633',
                          '69129','97122','48631','63493','87060',
                          '76431','24778','25574','39544','66153',
                          '30790','92168','18674','51417','52605',
                          '53227','45676','14911','40839','70093',
                          '70403','93451','47982','97731','69834',
                          '66234','32588','20591','24554','19116',
                          '61407','65965','47055','68466','93854',
                          '25219','93745','36421','71510','65835',
                          '76012','79553','11616','68589','19398',
                          '99340','19681','81416','15312','51173',
                          '50292','74152','85020','66655','35269',
                          '11581','30673','89424','69258','34830',
                          '96427','79400','71474','58373','48286',
                          '37209','70644','64317','19930','10412',
                          '97577','49808','43780','82605','65126',
                          '49823','25680','48607','91507','23715',
                          '73609','97050','92904','62181','43506',
                          '59372','78632','18249','94991','56797',
                          '31469','81837','39381','73173','61288',
                          '59986','12649','82000','86334','83648',
                          '91566','27386','23262','45725')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


