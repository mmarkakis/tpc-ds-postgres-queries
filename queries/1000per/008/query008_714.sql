
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '66612','80067','69558','90688','98716','16362',
                          '62516','13025','59742','39545','12296',
                          '95197','47415','42388','98269','36482',
                          '22297','96148','26386','88878','58847',
                          '40770','30089','36137','12441','65125',
                          '44420','37607','98202','14337','50588',
                          '59731','71706','68571','15552','58977',
                          '88011','67830','13165','66817','97572',
                          '20584','34884','46927','62565','13528',
                          '79352','67983','47218','96438','22678',
                          '43687','12969','95628','51506','59187',
                          '49636','37167','10632','95324','91136',
                          '84191','97342','25439','15608','69372',
                          '51715','78015','88672','60807','69879',
                          '53988','17667','62731','96541','95295',
                          '60087','94285','35839','95048','63082',
                          '80716','29215','78695','10819','77980',
                          '19039','59683','67129','67645','16826',
                          '82338','73739','98844','92616','85956',
                          '21381','54661','44593','73444','37192',
                          '25061','63715','25713','33709','18551',
                          '44292','98605','27208','18855','49086',
                          '22789','86555','66282','46088','66035',
                          '36176','75765','54841','17370','49159',
                          '24928','20666','52622','33087','89110',
                          '24059','93641','84375','77538','85183',
                          '53355','88281','33194','12130','65347',
                          '50176','15124','74390','78761','54488',
                          '78016','45790','77436','88297','89509',
                          '28699','76542','67671','57202','17269',
                          '80419','82856','96049','33389','43857',
                          '19197','56467','40854','88502','49039',
                          '68041','59029','20173','85657','19179',
                          '72461','49799','73648','16367','30194',
                          '44567','72484','24441','52011','20239',
                          '30739','24695','52564','72737','96958',
                          '21597','91448','76961','90346','12807',
                          '92002','49215','81760','63630','77457',
                          '98060','36523','50777','11787','89685',
                          '20971','37606','38810','75515','16498',
                          '86755','62732','96611','15000','28828',
                          '75418','59122','12818','98027','69030',
                          '21929','74666','89690','69867','99114',
                          '86711','55568','83010','21967','42662',
                          '67127','16886','55625','35488','32843',
                          '88979','23525','75026','69086','60204',
                          '63713','17039','13692','15775','77124',
                          '16987','38837','56547','73471','87450',
                          '91143','81173','95710','55956','35319',
                          '73993','15227','59983','27972','38160',
                          '53814','17251','35297','14733','47139',
                          '28710','59275','59933','21353','56308',
                          '55815','82989','18706','97749','68510',
                          '98649','74121','11372','96882','87231',
                          '84915','90786','98432','74775','27975',
                          '27857','11999','12498','59272','56786',
                          '99125','46520','60263','17803','21133',
                          '37780','94300','27161','54598','41263',
                          '65605','11069','94353','85401','88683',
                          '18271','74347','44714','64129','37258',
                          '49922','25468','95167','37555','99048',
                          '37345','13090','73693','52261','40244',
                          '53361','89342','84925','50706','14063',
                          '16771','98030','30592','14994','73566',
                          '64875','72090','32480','80824','77288',
                          '23088','81357','79552','33208','52743',
                          '94852','89291','56698','76048','75825',
                          '36089','89541','33358','69866','68309',
                          '67924','62452','40733','35388','46625',
                          '88153','28316','32218','48101','47614',
                          '67788','48056','13645','52570','64281',
                          '11303','94424','57419','82435','50491',
                          '26305','54732','44427','34798','51573',
                          '89149','28290','48057','44279','33805',
                          '42920','20618','39395','62588','61645',
                          '16651','64331','34309','27495','20510',
                          '33286','98780','83631','41442','36916',
                          '92834','10447','48910','97078','51662',
                          '18780','42948','23493','74243','74863',
                          '51726','79428','24043','90148')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


