
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '10674','67522','79475','28984','58582','23525',
                          '88431','39265','93356','87564','55277',
                          '15331','89715','73565','97470','35890',
                          '85106','56332','13275','60014','50151',
                          '64381','77762','63566','39067','43894',
                          '97871','46738','45248','82553','75574',
                          '50183','13958','91194','75640','13259',
                          '38118','62971','31466','44456','99544',
                          '43495','59480','33075','95122','65544',
                          '54281','98351','70145','81795','21915',
                          '35065','17320','55873','58985','85810',
                          '28531','56987','75875','75351','64368',
                          '13966','14678','73668','80162','12107',
                          '10669','42938','13187','33979','25271',
                          '41047','20552','46049','65021','20606',
                          '89524','76710','49218','60861','57085',
                          '15512','26391','33965','45626','36234',
                          '81450','66701','82476','86605','40720',
                          '76489','52657','24216','40791','63266',
                          '67545','35870','21312','79205','80070',
                          '77648','63251','84209','24728','98617',
                          '89356','70007','35692','95702','56883',
                          '47304','14475','95800','67740','63398',
                          '58625','97776','26201','43382','13090',
                          '63640','65227','15827','23731','86136',
                          '20105','52818','24770','35643','43243',
                          '78757','48522','35141','12524','57228',
                          '16152','92309','10952','98537','25025',
                          '64973','69646','34062','81586','71059',
                          '16104','45652','55671','61774','39501',
                          '63820','32213','78848','85561','77388',
                          '18536','80947','21114','24525','63427',
                          '78833','36747','25602','37133','79950',
                          '59248','82881','99864','45517','76721',
                          '45395','67254','13835','10927','57688',
                          '69420','42104','53319','84140','78980',
                          '53917','90461','15108','79042','92560',
                          '99650','61186','12432','64396','58197',
                          '16760','77011','45245','43156','85478',
                          '53299','28684','38243','17126','89111',
                          '70113','88509','49522','41000','44756',
                          '41228','39119','41788','91265','94508',
                          '92637','58747','93793','14550','87568',
                          '86457','12562','60066','39890','34563',
                          '93949','24946','40235','21387','59434',
                          '48730','98534','46056','76781','44665',
                          '64340','22853','32628','22586','88795',
                          '94712','21100','48231','21987','20284',
                          '39287','31911','61469','35658','77719',
                          '93280','62954','65799','99120','17260',
                          '84096','94881','68017','71280','89784',
                          '56304','87030','30387','16779','93112',
                          '69688','24730','73591','46930','32572',
                          '34025','55916','33580','43850','66625',
                          '50279','93400','77656','24847','47075',
                          '52327','83848','59738','12100','85527',
                          '28670','75617','92042','50394','43487',
                          '12938','64773','75451','74123','72786',
                          '40313','44524','83852','15526','75117',
                          '91296','37359','31923','11688','90255',
                          '43468','83677','49118','23458','87353',
                          '48888','58171','82566','98301','25144',
                          '13045','78152','51486','92820','60739',
                          '65969','53602','26273','37755','89923',
                          '94756','74348','41451','85419','56508',
                          '10651','62464','91428','77914','96779',
                          '80191','90475','82664','81138','24864',
                          '58423','17533','32843','95968','49180',
                          '26412','87546','32782','43592','33427',
                          '11240','61624','10254','60962','84104',
                          '90740','55862','28681','19111','15384',
                          '32554','30173','35058','98562','69952',
                          '21351','10614','55247','66876','36865',
                          '92216','70541','72686','51694','81535',
                          '92091','65313','45942','69907','57623',
                          '50003','24960','32997','97397','93151',
                          '46129','82192','70598','30667','29783',
                          '64828','80051','70950','18932','69662',
                          '81458','14756','67861','51901','99810',
                          '15661','47926','95462','87947')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


