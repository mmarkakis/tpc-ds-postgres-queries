
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '24774','74270','47619','77594','33067','86747',
                          '72133','64735','68855','56881','82435',
                          '62010','28193','23213','71812','29826',
                          '11984','95484','18658','86197','35911',
                          '92556','68084','70221','96218','38524',
                          '52294','55826','16282','55832','89114',
                          '59778','42230','80448','71361','29546',
                          '15578','34724','71373','14549','90039',
                          '63979','20276','75147','95602','60295',
                          '87219','27846','99039','83960','64674',
                          '54363','45359','89635','56977','53075',
                          '32084','32315','66428','24599','21394',
                          '67690','19427','99018','24154','60824',
                          '57393','95985','57147','31257','98839',
                          '94988','71100','15190','84576','58987',
                          '44367','13328','29415','11666','34621',
                          '40436','72591','45890','18016','81595',
                          '69342','96517','99596','33034','80945',
                          '64209','13013','33500','65760','31297',
                          '82482','77069','68416','95544','29963',
                          '70104','12552','13192','11486','39422',
                          '64358','57662','81543','38659','11558',
                          '88395','61381','14714','32705','44452',
                          '75049','66822','20858','83870','13419',
                          '22009','58159','12277','60412','48300',
                          '21624','16803','93590','31827','71772',
                          '46064','95090','79907','74003','61175',
                          '55401','76434','65660','62605','97568',
                          '95598','87309','85344','30616','71970',
                          '16157','31179','46830','24607','76508',
                          '20063','16832','28970','45390','83380',
                          '42905','95864','46810','72876','15539',
                          '55120','71986','50456','86120','83833',
                          '17747','26499','79053','24360','59366',
                          '41223','77201','45008','63153','47772',
                          '17072','27043','95376','15814','88751',
                          '28802','79793','65021','85402','69266',
                          '99618','16889','49672','62249','51662',
                          '48573','39493','63107','38628','53595',
                          '76209','93162','18496','13714','43600',
                          '22165','42610','78582','54457','72670',
                          '18755','40304','58501','45832','85927',
                          '39069','84946','89440','41151','91711',
                          '48671','54319','28639','27748','34521',
                          '51066','13016','19344','62398','45947',
                          '61757','57358','90948','64010','22545',
                          '27333','73382','32229','54586','16992',
                          '39431','60021','86206','63008','84423',
                          '96340','88567','28906','43698','71792',
                          '61466','58816','53229','55876','79799',
                          '97488','44226','61063','17657','28381',
                          '99932','31684','50064','38425','46769',
                          '83472','88506','99214','92472','70649',
                          '72326','77171','94320','39341','21860',
                          '72862','56171','46219','22812','93668',
                          '55117','52673','76216','88848','85664',
                          '82817','35469','27323','24346','16003',
                          '93914','91083','55146','68208','78262',
                          '99497','25733','16615','22383','49072',
                          '57467','70401','36495','86027','67138',
                          '66021','36955','39405','11101','34880',
                          '12874','71575','16870','78816','91979',
                          '42020','65778','87048','60486','65146',
                          '56967','24227','47004','91045','43226',
                          '21764','91268','43783','80995','93232',
                          '47947','29771','48862','70332','84134',
                          '79960','88353','94197','34112','89095',
                          '77639','94193','69084','15991','65347',
                          '44610','56189','77606','86136','32201',
                          '81603','58020','38982','86021','40544',
                          '55545','46503','24663','98062','15995',
                          '97813','70673','91957','91166','54707',
                          '59416','70918','78297','70498','50811',
                          '86706','16182','84048','35593','14519',
                          '20564','27357','98329','21767','49228',
                          '23954','30590','65756','45244','30191',
                          '87319','78403','60403','57689','54979',
                          '24964','62032','65836','80048','46628',
                          '74133','76867','25614','97332','14263',
                          '16026','12743','48709','84118')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


