
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '41897','24933','84649','20135','82892','99653',
                          '43071','83503','38449','12427','20965',
                          '42948','89050','62448','68194','31485',
                          '17072','26254','82529','36828','31246',
                          '34763','58516','14938','65275','93965',
                          '98838','18905','41478','41440','14432',
                          '45407','26118','58062','76224','93637',
                          '29444','44561','60692','22269','25772',
                          '86055','42081','45756','51651','82802',
                          '74696','83135','56241','27016','37217',
                          '97925','66738','22905','58561','32239',
                          '71990','16872','70479','38661','21409',
                          '73531','86296','44003','59516','61760',
                          '73205','35418','29919','20830','42092',
                          '41337','75133','39934','25475','77377',
                          '73472','90568','56806','10346','13840',
                          '68740','26059','75650','49578','28622',
                          '12886','26302','39506','62244','53703',
                          '17766','67956','75228','52516','58707',
                          '62700','85652','43974','90124','75716',
                          '93289','28332','83149','86568','99812',
                          '79652','95952','80513','71829','86194',
                          '24731','90463','67406','65050','81125',
                          '13824','27344','89325','11278','92444',
                          '26957','37253','74504','39349','65577',
                          '30709','37204','40532','60269','97565',
                          '68390','43060','85702','35731','48977',
                          '52996','83647','98684','83407','29305',
                          '48252','52744','53263','37473','16181',
                          '80750','86432','71667','57897','77563',
                          '82716','72202','13481','10384','42961',
                          '36947','46283','24177','27701','60379',
                          '85921','44761','25029','21901','40332',
                          '40546','81490','46807','95188','56586',
                          '47176','86573','99299','48961','44660',
                          '65131','54358','52288','79290','88254',
                          '43069','32369','44479','30359','87675',
                          '22196','54659','97585','25800','50426',
                          '95754','14255','21560','41336','46934',
                          '39004','17794','75165','23635','99157',
                          '60419','54008','78700','57247','54043',
                          '10858','14225','12405','57956','62556',
                          '50478','86357','49090','32028','20631',
                          '42512','33340','88117','76962','75512',
                          '10368','19131','26603','67207','78293',
                          '40512','59052','29163','16703','92924',
                          '46352','21752','32085','21744','91794',
                          '18358','62298','95627','54059','26737',
                          '49239','36437','83564','90046','19865',
                          '56546','63139','30316','73339','21674',
                          '73915','59024','91525','81013','69217',
                          '57370','82622','73300','39439','58659',
                          '10063','79573','53776','25292','99322',
                          '54384','69737','35684','60980','58393',
                          '41116','85716','84495','62770','98526',
                          '41527','60576','37932','22520','33465',
                          '37399','79381','54973','88190','92723',
                          '77675','19424','69078','13881','20968',
                          '30409','64538','22537','64649','90088',
                          '15189','13486','18779','34773','94723',
                          '80306','62438','90241','66870','74989',
                          '66345','53066','98739','99570','76917',
                          '29166','11867','52037','91198','98102',
                          '18446','99772','15048','97859','35894',
                          '61584','37830','72264','81759','81688',
                          '39882','24474','25414','81944','99381',
                          '87837','15397','35772','10616','61895',
                          '68613','79307','70779','47580','58255',
                          '58118','60314','51487','80532','59905',
                          '16931','17684','49602','38595','73094',
                          '22931','25683','84340','84446','11522',
                          '75739','93654','59223','28151','74244',
                          '65808','81396','68299','10979','34808',
                          '98968','80209','21084','14308','11065',
                          '98293','59445','87315','31300','47281',
                          '72703','33120','68200','14881','10484',
                          '53134','69983','55712','49696','72588',
                          '43919','25020','86602','18843','42812',
                          '59646','68633','20085','48046','13710',
                          '26137','51179','59342','40832')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


