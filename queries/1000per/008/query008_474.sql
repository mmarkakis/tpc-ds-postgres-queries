
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '15328','57611','87404','77022','30896','68849',
                          '27435','47068','77537','19317','84605',
                          '81786','79551','68114','26484','85204',
                          '44374','26392','19698','69142','80702',
                          '34703','85510','93305','91554','53482',
                          '38307','60520','33480','88668','93802',
                          '85554','18121','86295','49803','98881',
                          '51188','56398','87186','30352','41918',
                          '44004','74884','12868','80692','19045',
                          '66860','12254','43845','69769','30521',
                          '63429','80768','64735','49994','94643',
                          '63367','97270','31692','24964','34340',
                          '65887','41971','83175','32829','10654',
                          '86211','48335','23234','77570','27506',
                          '29357','75069','11017','58683','26041',
                          '76712','15357','86096','49043','63379',
                          '90862','13677','31376','66829','65035',
                          '77419','18092','62145','13876','75685',
                          '68622','56039','13265','35503','43942',
                          '56737','71271','83388','75979','28088',
                          '79672','69740','45731','77249','17485',
                          '19800','64678','61121','21596','86002',
                          '81436','81863','80052','90127','24644',
                          '75727','61313','27754','63308','72811',
                          '60018','45985','73797','47225','78383',
                          '79694','52394','98123','66058','29338',
                          '14260','70321','29045','18525','58931',
                          '87234','31027','58896','85965','40247',
                          '38330','59335','21650','64481','17082',
                          '97944','51961','39097','58441','51870',
                          '43336','85011','28922','52152','57860',
                          '53114','98082','55257','26915','83018',
                          '87504','62745','10467','97141','26637',
                          '92449','32086','18802','30314','18731',
                          '89546','50173','39579','50630','21027',
                          '38113','80540','86306','89309','66700',
                          '78392','70682','38041','20229','83743',
                          '82973','57147','19819','52075','35875',
                          '73700','68525','12320','62082','60978',
                          '46287','25537','23313','30251','40363',
                          '35702','24114','39064','41186','25505',
                          '46989','38244','82242','13603','18632',
                          '12756','27850','86460','60075','53455',
                          '66122','95724','94140','38673','11728',
                          '65658','45182','92799','83461','24463',
                          '65294','80389','83264','26144','84807',
                          '48938','89635','26594','92334','16791',
                          '82159','89533','24884','44894','81647',
                          '44732','35944','15801','77171','53002',
                          '53564','40967','79008','24117','19997',
                          '19051','39767','43364','89185','56157',
                          '22980','33959','78380','61493','41681',
                          '95039','57880','55820','55847','37011',
                          '15044','68919','17178','38821','40304',
                          '70473','89816','96635','64795','67592',
                          '41272','11754','21632','58740','84061',
                          '11724','99022','97721','57593','64588',
                          '44133','23962','22773','18290','51266',
                          '48697','87215','98095','15725','76069',
                          '78943','77741','70325','81787','51372',
                          '73216','99264','89256','17483','83182',
                          '43643','84916','26591','73413','73223',
                          '82504','96994','12934','37239','21798',
                          '17495','12646','55883','90785','27469',
                          '47756','99330','42271','21758','11905',
                          '91495','99455','73666','43169','90251',
                          '74561','66016','21640','15154','80753',
                          '23823','92179','22486','83714','62570',
                          '27303','98036','61790','13721','28827',
                          '10150','20431','36428','82786','96789',
                          '68823','93917','12365','49614','19783',
                          '61100','24302','37057','53308','25052',
                          '49264','60885','58440','95692','56914',
                          '66437','48615','57695','78653','41106',
                          '80244','44232','66265','42668','48019',
                          '66463','99001','30747','30656','14972',
                          '89247','78234','33695','28570','52143',
                          '23580','70510','44407','31563','89646',
                          '82380','17216','25628','61453','40170',
                          '24269','12134','39501','91531')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


