
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '78332','18032','20230','84741','36062','86624',
                          '95914','91178','99787','14767','19270',
                          '22782','11708','22341','41751','54731',
                          '65655','89639','35964','71661','20180',
                          '68239','91324','90149','45353','42795',
                          '91401','15788','19555','91342','53569',
                          '65673','58742','50466','86898','99511',
                          '50621','65183','17126','17527','48659',
                          '95859','43180','60508','71093','91522',
                          '65533','61983','35577','30804','39390',
                          '72489','35369','22071','73974','75667',
                          '37065','38083','72897','87036','21606',
                          '47949','43493','93092','26904','75941',
                          '51327','34195','84605','68353','37760',
                          '88081','67174','27116','93920','19184',
                          '97021','68937','64546','64912','10116',
                          '77479','93213','46766','98165','42890',
                          '78524','36022','24932','88280','18997',
                          '83067','73656','71843','76735','97110',
                          '53125','49460','82939','30740','91710',
                          '90120','80119','25190','61363','13822',
                          '20042','70286','60402','93039','18360',
                          '85525','53223','20820','47455','14881',
                          '52007','27697','45417','71838','58408',
                          '76590','87586','94998','47755','98748',
                          '29815','86900','18419','22718','89053',
                          '20505','46139','34062','95779','67812',
                          '97028','36626','68752','59803','49292',
                          '41512','78734','96687','77492','15266',
                          '53279','30574','77246','56409','95356',
                          '71230','69070','29188','54184','55797',
                          '87958','80114','64717','13638','11414',
                          '78592','56927','39081','51585','54806',
                          '47362','27302','72148','97312','46902',
                          '15164','38796','83271','21652','35953',
                          '97938','11145','45932','46060','17574',
                          '30475','40924','17579','62848','22864',
                          '97948','61600','56595','47753','82885',
                          '24180','69190','91130','29752','98812',
                          '80060','41496','83728','40110','53339',
                          '18655','28859','58490','43641','71163',
                          '39978','83961','78882','69668','70841',
                          '57320','61205','16753','36328','75125',
                          '16265','58311','83735','60128','41385',
                          '77650','24623','28746','98596','73096',
                          '43351','69500','11680','67713','87963',
                          '86677','79115','67335','98907','79453',
                          '75912','55273','61933','15081','96537',
                          '59411','59365','40458','24299','11580',
                          '59812','72994','36501','36390','26231',
                          '86078','46534','48392','75745','84682',
                          '39649','14028','38205','40790','20876',
                          '39089','53024','18879','94523','71610',
                          '84933','32004','89548','98282','33788',
                          '32541','57131','50015','21011','43930',
                          '85739','41094','82305','77984','98020',
                          '76923','91457','91588','38373','81302',
                          '18383','59016','12302','41615','89115',
                          '67747','36937','19000','37213','43730',
                          '71780','16779','98511','42135','24395',
                          '39953','14205','99164','68926','44074',
                          '27422','26947','68415','75513','53849',
                          '33882','51368','37375','42254','25246',
                          '91388','48472','76981','64251','88708',
                          '95066','99554','13149','10792','15136',
                          '24730','52818','74039','75000','62461',
                          '94190','54110','27879','78435','67260',
                          '50066','99655','36401','33951','39123',
                          '77214','62342','63974','96312','70947',
                          '23549','86093','92114','38871','57763',
                          '56194','70059','32901','96565','57594',
                          '35071','64814','20901','31272','12433',
                          '14614','41874','84852','48697','97396',
                          '88227','80523','95923','75812','11588',
                          '37430','10242','16688','30846','40463',
                          '84405','72617','26072','15411','54623',
                          '15858','34602','56193','36449','81076',
                          '56596','63509','53424','44138','78803',
                          '89722','82323','55220','16894','26357',
                          '13608','71680','43250','70487')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


