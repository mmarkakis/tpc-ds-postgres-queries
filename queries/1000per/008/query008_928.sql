
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '45643','70151','57375','48331','23079','79272',
                          '14330','54428','36909','61473','41471',
                          '98834','72555','50737','29198','85455',
                          '83181','28117','66169','21880','53059',
                          '44684','67058','87059','28773','35225',
                          '86765','21726','26160','75791','66848',
                          '57226','41232','83703','40120','19764',
                          '43327','17324','48235','79756','84404',
                          '57617','67742','42271','16745','56670',
                          '76638','11398','39897','42168','43366',
                          '56654','14777','30617','81802','22397',
                          '11296','76231','80113','22238','39276',
                          '76674','36642','35591','91557','88650',
                          '13773','69434','39660','88472','71047',
                          '43564','22375','75920','59534','54457',
                          '79054','81356','71526','12103','65274',
                          '13490','56751','31101','11548','66680',
                          '93172','44900','62737','95759','30263',
                          '96422','29757','60800','23318','65024',
                          '45236','57740','71926','29771','95735',
                          '26975','72102','13729','50740','65125',
                          '40898','16446','57754','24308','84488',
                          '99617','84745','11275','78963','54583',
                          '91723','65830','92219','65518','74541',
                          '74415','99835','58169','54646','14370',
                          '36348','10652','41801','95167','12810',
                          '65783','22866','55782','81754','76330',
                          '21183','95066','90099','50283','84882',
                          '69456','78246','98336','67123','35399',
                          '21749','38023','37808','57958','31348',
                          '37727','87709','27982','31765','61794',
                          '42882','28620','12251','23524','82029',
                          '97243','95019','76283','85318','20209',
                          '10337','60275','90327','20905','24786',
                          '88762','17156','73123','22276','34361',
                          '57803','92562','17062','75884','99938',
                          '35868','43940','66890','16008','18357',
                          '46783','85653','57301','19379','69438',
                          '81816','82278','86324','76822','88555',
                          '60355','49421','94274','76593','46172',
                          '44084','62060','12180','29134','44134',
                          '75711','56242','47307','88020','83828',
                          '44688','36535','83170','20131','90805',
                          '64457','15603','64930','15779','84017',
                          '78285','54877','83666','44077','42298',
                          '95400','22211','75904','55824','77581',
                          '73424','45838','87255','37002','67841',
                          '78409','55224','95844','55247','19657',
                          '34724','61738','59987','71949','70311',
                          '55388','76163','73542','14104','98649',
                          '33772','44357','31802','94955','45423',
                          '48856','92254','22957','23512','80118',
                          '89106','71353','53871','15473','65222',
                          '55803','93143','26225','27011','40975',
                          '33016','55249','32286','57106','39369',
                          '96410','52770','72902','15424','59731',
                          '26333','17473','69447','14001','68394',
                          '60881','26721','24517','17429','13759',
                          '15431','86347','10660','14073','28287',
                          '26212','36509','54883','88665','14214',
                          '67862','55434','99761','31948','91160',
                          '36779','91271','59172','14858','83137',
                          '16486','58479','16898','78208','95090',
                          '14318','84219','22951','56650','38723',
                          '60589','18648','91715','51035','43181',
                          '55375','45909','49442','78352','41317',
                          '30698','82628','49231','92528','42017',
                          '10249','55049','29229','93475','90727',
                          '19067','58883','76676','66188','19142',
                          '61590','37973','99576','24236','84374',
                          '52151','94705','88638','84826','86998',
                          '37189','34148','26311','97341','35297',
                          '40850','54910','28578','47498','83287',
                          '62650','26584','72500','54466','10747',
                          '64709','93278','58480','40936','66616',
                          '96303','72126','93776','73691','71499',
                          '55797','62860','25027','55284','82717',
                          '79310','33805','21613','31030','62541',
                          '19907','15920','60551','18946','54706',
                          '64439','28870','63884','12666')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


