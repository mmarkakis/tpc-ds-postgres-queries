
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '77212','90667','81481','92085','29044','67464',
                          '46705','57776','68045','93745','57436',
                          '39120','38294','10840','98886','43497',
                          '20400','77485','20246','52224','78512',
                          '69574','38191','67831','72956','62500',
                          '15520','15778','95798','43244','31394',
                          '54356','33119','20178','27768','40652',
                          '15728','75892','94904','70821','68823',
                          '48950','99022','91734','36356','69534',
                          '14681','31205','26675','13900','11461',
                          '12703','47484','38102','19566','61922',
                          '43733','75334','91941','23203','89827',
                          '56356','39434','54100','59472','47272',
                          '93058','43129','39436','83043','67108',
                          '75100','83811','77749','61962','13566',
                          '64481','96849','43186','42542','21851',
                          '78365','49053','16051','86206','29699',
                          '35151','45636','83953','88037','15696',
                          '14676','31993','84917','62778','66344',
                          '58568','41495','17186','22077','57532',
                          '71333','32495','57947','61802','99709',
                          '20606','83869','84567','80412','79895',
                          '37889','79633','84396','93045','78317',
                          '36876','66322','57780','51202','92747',
                          '16446','20010','13834','96447','74145',
                          '22608','51390','96450','87710','23475',
                          '54191','93954','43264','38703','81615',
                          '30452','92896','22465','69840','42691',
                          '97383','77388','79175','71501','75102',
                          '24022','81813','68152','17766','71909',
                          '35323','94368','74798','89065','65798',
                          '29970','62167','20318','47028','39442',
                          '60329','51709','85626','37466','43385',
                          '46430','67438','65024','64119','99515',
                          '57317','83944','70461','33845','50072',
                          '64208','92285','28420','26364','10973',
                          '50807','70667','34395','84606','59552',
                          '65515','84189','29952','23502','64143',
                          '60277','98509','22776','77806','35635',
                          '16590','45003','25927','44314','24270',
                          '97804','45663','72000','10880','69694',
                          '30453','56825','11511','31086','30940',
                          '40966','11636','22692','70183','92215',
                          '10571','72360','25051','10088','84854',
                          '80986','61945','83242','67416','14179',
                          '57498','64542','78260','93564','10617',
                          '34040','94069','13617','60192','85042',
                          '55843','82822','59370','32625','69515',
                          '92116','14852','78894','67727','65344',
                          '59923','35223','21053','74677','93375',
                          '17143','37315','16819','75904','65232',
                          '53020','14945','62601','61997','47500',
                          '90869','11939','56231','67974','79069',
                          '50446','19415','84512','21821','34533',
                          '34154','38040','35008','29100','14565',
                          '54763','16457','76814','27771','15656',
                          '55629','19835','46712','23747','10703',
                          '56411','45559','46031','17812','48472',
                          '73516','90241','32522','17834','11980',
                          '39522','92750','10307','62966','21932',
                          '17724','77238','78282','30106','41230',
                          '87419','23652','10040','28965','13668',
                          '38577','66865','24631','27344','65709',
                          '26289','52588','36671','68354','76011',
                          '77278','52311','73757','31890','97322',
                          '55554','97534','94452','90692','98624',
                          '48607','72093','18794','32543','28819',
                          '90776','53672','56676','42920','24454',
                          '74406','33834','37427','18517','75020',
                          '54001','67498','39519','35652','89797',
                          '37966','96544','20681','32366','83321',
                          '70426','59828','90318','33958','20308',
                          '10465','56536','43288','86280','23526',
                          '40149','57764','94792','41636','17753',
                          '85031','31003','64024','46333','95235',
                          '87508','96348','46182','91396','65600',
                          '50488','88457','65838','62486','32415',
                          '60895','72379','52456','19300','13394',
                          '72754','91110','71980','68544','37104',
                          '46204','33319','78501','94314')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


