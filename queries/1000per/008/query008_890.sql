
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '16629','91628','83156','23529','58564','27930',
                          '67759','82612','39662','36895','42389',
                          '76796','77584','55636','59974','14959',
                          '37190','21521','46536','17787','29474',
                          '33389','40788','68562','27333','12181',
                          '48085','19333','37244','26308','42724',
                          '47325','87566','14832','60098','98959',
                          '66022','33487','54222','46068','89050',
                          '98203','85307','21806','95940','95688',
                          '46141','62257','92740','47978','21575',
                          '56258','56816','69595','33517','24521',
                          '11312','22031','82776','42235','92528',
                          '68073','93511','43512','52691','55428',
                          '21592','88269','57421','63847','54838',
                          '38793','94512','21519','80682','55768',
                          '14384','61658','44299','43784','47601',
                          '74085','21361','90661','51753','11804',
                          '88589','81875','84598','39001','75569',
                          '70919','20816','80327','17023','51043',
                          '84655','46541','91846','94214','18545',
                          '32996','21488','50330','67890','31907',
                          '35868','46410','77417','39747','60769',
                          '15958','25623','29174','37977','45172',
                          '70013','53097','58306','52753','42063',
                          '60063','45876','84159','79740','20063',
                          '36889','76676','97792','45329','93307',
                          '22931','78016','10189','71827','61214',
                          '89676','44140','82725','59177','85288',
                          '18560','63995','22565','35592','92429',
                          '67695','11762','56084','24760','23663',
                          '53161','92473','29747','80240','37551',
                          '16571','28672','89692','62315','14508',
                          '52835','86657','61234','70143','55583',
                          '54786','64105','35442','70158','22972',
                          '43679','74245','74193','18835','92350',
                          '47776','71200','11171','95184','77213',
                          '73148','78134','19694','99222','20285',
                          '20652','13229','11459','32860','15025',
                          '93959','48777','46399','16551','55553',
                          '54443','20926','37086','35587','70354',
                          '15358','93344','42077','63615','22063',
                          '22587','10083','24885','60913','34773',
                          '64729','81909','32248','50473','24352',
                          '63987','75351','27444','61738','63501',
                          '46152','10366','71569','13280','73290',
                          '25323','71885','66001','95979','26902',
                          '38478','86710','43970','79010','55380',
                          '61278','42681','82915','66721','16719',
                          '64043','55969','13197','95829','61882',
                          '42859','60413','60167','38274','49707',
                          '47740','40383','38739','33607','37006',
                          '84775','31718','96678','59282','21171',
                          '69283','92125','69692','75037','55486',
                          '73755','92746','17967','37618','52338',
                          '48996','65530','12968','92900','14753',
                          '80299','86439','86106','53418','25289',
                          '42144','76839','10492','61802','83030',
                          '65854','34607','75866','29979','43002',
                          '88272','63350','20996','97029','20061',
                          '18585','13950','81924','81986','80813',
                          '65999','30273','65653','33118','60959',
                          '65696','18296','57410','43740','64108',
                          '57522','68142','18368','56964','51992',
                          '25386','97356','85377','40808','84827',
                          '43051','98082','23065','96485','76649',
                          '34292','93100','40701','71682','25454',
                          '12425','81047','37344','91815','83337',
                          '33440','73195','38526','89481','13868',
                          '81545','32070','44391','27723','78090',
                          '98208','43968','72458','96526','98271',
                          '90313','33661','51169','58372','14642',
                          '52820','12075','44374','24603','47459',
                          '25926','25272','12788','78767','15581',
                          '30352','89155','77630','68388','18625',
                          '44666','22894','26840','70527','96124',
                          '78079','84409','43237','87704','58667',
                          '92376','79351','29077','53770','89958',
                          '33961','21511','72090','69669','28533',
                          '24403','47121','11014','32299','82453',
                          '85839','32867','94967','45828')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


