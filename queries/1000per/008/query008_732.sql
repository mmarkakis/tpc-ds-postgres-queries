
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '33660','11771','30614','71676','57849','60930',
                          '23080','76564','13270','58360','77130',
                          '64630','24521','87208','25042','60104',
                          '72517','94282','85722','11728','53234',
                          '73220','19019','86465','67865','10503',
                          '87593','90348','20612','78830','38306',
                          '24236','99512','95075','44958','66084',
                          '64757','86177','41186','66278','40127',
                          '36575','74515','62738','96991','39787',
                          '29719','52407','10157','96735','13691',
                          '62150','70503','40783','85806','92148',
                          '84400','29054','41694','42326','45814',
                          '89295','62311','17791','51915','53379',
                          '48644','62478','23764','37804','15766',
                          '28072','98069','48498','48560','98630',
                          '47311','53765','56379','70741','39249',
                          '78283','73670','41319','32896','95756',
                          '51291','74715','95201','21943','63227',
                          '79957','68180','50659','57323','84850',
                          '61824','57460','82758','48972','55062',
                          '73076','62142','60044','54861','60342',
                          '15004','18394','87134','29543','42652',
                          '28407','59169','52816','56823','99314',
                          '62485','78079','87056','45171','49398',
                          '45505','72243','90705','46668','56696',
                          '71105','59372','30332','86512','40279',
                          '55352','92884','13122','67249','36599',
                          '65737','53872','90345','42152','32462',
                          '61075','82761','73372','21951','17535',
                          '88480','87764','69945','66846','73594',
                          '41883','78474','98055','13066','92579',
                          '49645','41899','53591','40003','85106',
                          '52932','88373','77540','13490','94459',
                          '71034','53573','84757','78618','59036',
                          '42598','26574','86311','12202','36739',
                          '42472','43293','35842','48048','28532',
                          '63768','88638','64400','91093','44919',
                          '84992','96486','87228','12107','28254',
                          '74743','51516','28107','57316','88875',
                          '10417','65895','29982','64859','55454',
                          '86876','91300','31272','79753','65014',
                          '30781','99655','81451','88647','60748',
                          '92983','92713','37661','33514','71948',
                          '31035','52442','36395','85742','48773',
                          '23708','19048','76633','27356','93698',
                          '44806','39863','43272','89989','80558',
                          '68095','64876','38190','11653','89016',
                          '75294','15988','30062','66732','34910',
                          '52839','74300','56401','90624','90962',
                          '80114','37637','96685','17111','83651',
                          '99943','65747','24935','39912','93882',
                          '92995','12443','79598','67060','27548',
                          '67751','38707','18344','46655','82733',
                          '61030','34962','92755','91791','65063',
                          '94518','47548','55104','70091','51515',
                          '72836','70902','66352','79104','31798',
                          '72240','14744','93009','95735','50077',
                          '51168','36011','60432','51966','67271',
                          '23736','25370','43022','37992','77834',
                          '46739','17294','55772','33245','60689',
                          '90658','72476','15709','34100','84499',
                          '86505','56984','41360','87653','33359',
                          '52481','98241','89297','91487','85182',
                          '63592','75383','81372','14278','75048',
                          '18382','28068','68975','96445','83201',
                          '61457','68956','42214','13082','54482',
                          '76164','95101','92207','22481','45562',
                          '15959','15761','98323','61055','14728',
                          '62560','44639','31346','66175','14923',
                          '49131','10427','31292','79290','15759',
                          '60252','72217','64384','79511','46263',
                          '43851','53317','37579','75415','68222',
                          '78339','52867','28696','65402','27845',
                          '11074','21793','99367','24434','75366',
                          '84396','62215','76998','81386','82781',
                          '63789','47062','26057','23049','93864',
                          '17937','73148','30903','87986','51380',
                          '22747','49806','14842','88656','57055',
                          '87826','90650','31632','59772','47220',
                          '32866','63795','31940','85405')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


