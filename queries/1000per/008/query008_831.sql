
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '27217','14148','65800','12158','58931','56087',
                          '86197','64271','94437','17249','96191',
                          '46430','36938','89979','66900','96975',
                          '13061','99857','44789','14717','36399',
                          '84660','71705','92271','34013','69180',
                          '76969','10261','89074','82163','98143',
                          '69781','81135','58394','78278','47458',
                          '39561','69405','22248','78584','57010',
                          '42259','89285','73425','52799','53840',
                          '76878','92139','81652','38587','86181',
                          '87967','69210','13963','46936','87365',
                          '16333','66301','33187','61593','78742',
                          '93430','91139','31196','92955','88479',
                          '36797','54371','78676','59018','37660',
                          '84642','68704','16468','43081','96738',
                          '38899','23292','14739','83475','31308',
                          '60386','40064','99551','79383','97995',
                          '54625','11125','42282','32590','36679',
                          '20293','51872','10913','77789','79775',
                          '41106','87025','53645','25869','54092',
                          '89977','93698','46472','28325','34189',
                          '51141','69949','98366','59064','14958',
                          '57678','87024','52070','71410','61845',
                          '82237','34198','80851','45176','12318',
                          '39986','36815','74135','53696','34799',
                          '21234','88611','74133','21149','29267',
                          '87463','62265','59061','78892','68183',
                          '75316','94031','53126','10693','47779',
                          '50860','75540','39438','19763','47914',
                          '72376','81968','81605','46806','73929',
                          '51009','48418','24744','17238','38424',
                          '81514','77712','37925','25377','98921',
                          '44736','51782','36494','76157','21950',
                          '76039','84672','71911','14812','48588',
                          '77163','68765','78747','10398','30901',
                          '74044','47639','56866','58734','81476',
                          '10692','81253','10657','37229','57836',
                          '88301','18046','86838','42736','25880',
                          '97794','93813','51859','90276','51324',
                          '16823','45360','36041','57758','41041',
                          '59182','29891','51914','88553','93741',
                          '84717','33777','44685','22187','96098',
                          '71294','19160','71217','98008','91398',
                          '73689','64493','96308','65980','96861',
                          '15809','37489','56483','44030','99319',
                          '43740','75694','21450','18700','28598',
                          '80859','53119','63421','61296','90463',
                          '97399','67266','83666','69719','94732',
                          '81075','31905','92652','82151','80376',
                          '21240','78465','89807','58015','27191',
                          '89542','69421','76145','13056','59289',
                          '99596','93696','52194','63790','79869',
                          '79558','25096','43444','57233','86009',
                          '15950','48697','91697','53268','57305',
                          '33022','80278','72480','85560','32908',
                          '36176','30358','76446','77670','11684',
                          '42851','78317','61002','31405','55447',
                          '67799','55197','22510','32461','19525',
                          '11449','75597','56494','18030','49631',
                          '59920','61723','34148','89463','92986',
                          '45732','77534','84742','63606','11576',
                          '68465','67790','43717','66968','49571',
                          '43515','62938','92792','47795','18082',
                          '95151','54270','56389','52538','38523',
                          '21350','56012','28292','93367','32109',
                          '79238','95915','18106','11530','88363',
                          '53636','43744','62910','14576','61904',
                          '48630','69509','73075','46228','90719',
                          '93556','38410','81728','63322','73755',
                          '45884','65974','62751','39938','42759',
                          '57167','42860','39040','39298','25716',
                          '20945','63571','23798','60433','62430',
                          '63524','46541','66666','78870','94582',
                          '21428','77402','67541','28153','39788',
                          '60359','40906','44737','33842','82006',
                          '57581','71751','33639','60571','49898',
                          '75616','72848','37021','87715','39520',
                          '35187','20326','83047','87850','71242',
                          '61547','85101','74959','28714','75901',
                          '77604','45877','75217','88097')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


