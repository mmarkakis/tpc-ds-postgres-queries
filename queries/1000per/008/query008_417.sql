
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '54618','53533','72606','98615','63561','11633',
                          '98367','11450','51736','39584','66516',
                          '37767','27118','92640','57154','63686',
                          '46914','82278','76339','47307','26450',
                          '42388','79969','38688','62256','93606',
                          '91325','26152','39250','74329','38937',
                          '91151','34335','93727','87698','27859',
                          '34345','63727','63215','82411','91187',
                          '64705','14862','59554','86492','50815',
                          '15233','71086','80992','67038','92109',
                          '45770','89535','76385','14251','14281',
                          '24243','68891','39495','98877','12111',
                          '50209','71964','59281','55113','50027',
                          '92905','97413','59198','97252','53144',
                          '69541','78722','93075','89294','18461',
                          '12961','23098','46074','86531','29693',
                          '15786','41945','38716','72320','45117',
                          '48421','59611','44146','23715','83076',
                          '11036','87435','86709','60922','71119',
                          '70511','68230','18335','32157','13410',
                          '65723','11667','36178','78785','27440',
                          '22785','35695','79728','28019','30697',
                          '58068','56410','15638','77039','65879',
                          '27265','13487','96881','12999','15182',
                          '78089','32798','93270','39073','61192',
                          '20225','91587','71102','94238','25388',
                          '15507','36471','45897','85095','94580',
                          '43611','71835','36204','77045','55789',
                          '53815','81803','36960','10273','73753',
                          '88222','40407','59736','40848','10509',
                          '78263','27688','98982','67195','10504',
                          '54005','11817','31027','17564','43406',
                          '75629','31616','37769','51884','55200',
                          '88658','39724','32147','80667','68946',
                          '26703','41689','85925','23810','29534',
                          '53794','77716','48704','45012','79135',
                          '90474','36230','87868','98506','82572',
                          '32312','21974','61645','34357','19042',
                          '26497','98473','78757','39558','32044',
                          '12057','32425','92454','20312','13558',
                          '11043','30589','73158','11875','59033',
                          '91480','66046','73296','68964','38634',
                          '97550','41457','16465','77539','98528',
                          '41739','86388','10227','84432','20754',
                          '92523','33643','78931','84361','40328',
                          '54142','99824','76207','64744','18432',
                          '23228','51082','94452','62850','87105',
                          '25821','58460','52512','86811','23889',
                          '77641','88101','82208','31527','18026',
                          '18287','48301','59456','27018','44852',
                          '41773','86018','85121','63884','42280',
                          '79683','33337','54256','80253','29178',
                          '65728','12473','10940','94144','31692',
                          '92840','44280','29501','11490','39431',
                          '52506','27258','54337','30149','59069',
                          '81430','61020','82702','62982','80243',
                          '68098','97427','85627','90892','79385',
                          '10541','33569','98887','38704','52680',
                          '46492','17347','92138','29567','82480',
                          '12067','76340','31480','86953','15878',
                          '62827','40706','31157','36750','42682',
                          '68065','56734','22129','26359','73892',
                          '57765','12570','97432','26790','14007',
                          '10523','73686','81198','57407','23067',
                          '61149','88065','60503','56809','61845',
                          '70083','11923','20869','95038','20973',
                          '16445','13059','39943','93703','21149',
                          '57661','62141','29364','48551','48879',
                          '80841','77731','65449','82995','50893',
                          '84823','72266','69592','62859','68335',
                          '52970','59669','25091','27381','26060',
                          '55129','69995','89162','19150','93323',
                          '42306','93434','14139','68632','48848',
                          '44119','13240','71087','15645','17936',
                          '26733','42815','47131','74488','48722',
                          '16519','98239','26419','72797','43352',
                          '20646','83561','18017','37324','67217',
                          '22937','33256','46621','46279','66329',
                          '83456','78459','59708','82592','96526',
                          '33286','39175','94679','81717')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


