
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '99891','27208','81464','52873','25143','88366',
                          '84496','84069','42069','88062','29217',
                          '90666','92416','97567','42939','48157',
                          '22542','52134','83312','23332','51681',
                          '86045','44142','58402','92234','55905',
                          '94050','54232','35416','88324','24604',
                          '24521','10094','54231','62904','25837',
                          '85535','87792','65276','72198','17373',
                          '35544','14577','93398','38079','44929',
                          '17269','80999','39755','40514','18191',
                          '38223','50705','65514','66893','16539',
                          '59691','86288','84642','75278','68643',
                          '69798','70656','44549','81726','17720',
                          '17698','21056','65050','56138','57694',
                          '72685','57540','18818','30875','42405',
                          '51267','69848','47582','61355','42748',
                          '29527','85460','44848','91878','66318',
                          '10601','52540','75267','11350','22736',
                          '65117','28994','91481','66477','58461',
                          '27406','89989','89095','58149','86090',
                          '52666','37247','58585','94907','55985',
                          '11301','67393','69881','66604','50196',
                          '68204','23957','93453','82557','41848',
                          '60088','48536','92638','43776','25886',
                          '91029','66681','54864','71309','14423',
                          '19815','83526','90877','68790','90284',
                          '64531','54132','24542','21589','71294',
                          '67772','37781','35421','18640','45636',
                          '26742','31288','64711','13543','35338',
                          '30984','31358','63068','74242','78143',
                          '73381','59906','31693','10489','47633',
                          '96334','28184','33354','81122','73748',
                          '23448','14783','56018','61520','68243',
                          '79175','66964','87903','49800','46590',
                          '87631','21845','87690','85193','97030',
                          '54868','63243','16962','15700','94589',
                          '60897','92452','36777','68303','85976',
                          '73929','92810','53246','89347','23404',
                          '19499','75364','14647','65108','27318',
                          '60208','23770','64164','93744','37027',
                          '51088','83980','86682','46172','45570',
                          '59335','28843','96172','79467','33274',
                          '74990','37847','18488','31774','34728',
                          '29728','75476','40602','62028','28158',
                          '95119','17598','90527','93760','94966',
                          '63908','25851','55016','84181','97652',
                          '81278','63118','10606','60367','82128',
                          '84301','70453','70505','47965','86433',
                          '77176','61884','60739','42587','68690',
                          '55836','84067','60943','50750','95309',
                          '56607','40686','22301','45962','15271',
                          '20452','13851','97005','39443','43070',
                          '41180','37003','27411','58738','39699',
                          '36756','94422','33840','94784','76391',
                          '89553','29369','47480','76065','24341',
                          '65408','32877','47975','89715','85707',
                          '82504','43148','72730','13974','66214',
                          '84801','64427','11248','61986','49974',
                          '26198','30884','82886','27293','95313',
                          '26751','26930','68403','57597','18078',
                          '20105','10173','27941','58915','41922',
                          '81771','22663','79705','56029','57125',
                          '18824','90033','72576','96880','33345',
                          '46579','38256','98245','67296','65910',
                          '32629','32165','27644','78190','44328',
                          '39704','18667','37103','29344','66592',
                          '92693','50499','44133','80746','96092',
                          '16205','63967','52168','35646','33800',
                          '65917','40985','67127','48005','98741',
                          '80539','60197','69090','41952','65271',
                          '95577','55934','11297','23867','17265',
                          '64262','48262','95009','95033','10040',
                          '89311','76080','14558','46046','18558',
                          '50617','94918','98716','92179','95885',
                          '92926','76347','79027','45635','21342',
                          '31824','58391','29710','51579','90909',
                          '92824','43900','71135','34459','57667',
                          '38395','48216','47233','19111','98955',
                          '94027','97391','60801','74413','36037',
                          '88547','18744','61149','37024')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


