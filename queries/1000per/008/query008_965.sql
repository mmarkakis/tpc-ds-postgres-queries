
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '78639','83653','16401','77322','36161','69380',
                          '84211','44573','14892','64084','38027',
                          '91509','41371','23739','60867','24259',
                          '65457','58875','56854','90469','47541',
                          '82664','28995','71370','23101','83251',
                          '91005','60730','89703','70626','49024',
                          '83897','18696','21291','21295','98029',
                          '16245','18389','38525','70919','75152',
                          '64547','62855','47549','24406','41997',
                          '84890','56153','30357','58531','31267',
                          '78673','76071','91053','53136','66311',
                          '12779','36524','62643','28441','69878',
                          '42765','24397','68420','76446','93356',
                          '91284','47401','77902','41341','98735',
                          '45341','47603','58264','68709','89821',
                          '70542','98729','36345','73445','42648',
                          '32409','94590','11104','79096','81048',
                          '92904','85660','93720','71106','86521',
                          '62335','24541','92222','49189','78181',
                          '30180','53726','96727','38628','41975',
                          '80969','82501','20804','34306','47150',
                          '94208','51532','44951','94971','20725',
                          '57349','19151','22993','76155','98331',
                          '13138','47186','53679','48963','48856',
                          '57017','45941','98631','42311','78532',
                          '96172','56360','66700','60247','93924',
                          '14266','44218','24172','76896','81472',
                          '68825','76050','70505','77401','93036',
                          '39936','52553','50785','77268','49344',
                          '23187','29467','33537','68087','52429',
                          '16950','30519','46641','51001','87781',
                          '79895','66527','28754','34921','40651',
                          '67233','19232','32979','76416','77451',
                          '39372','15690','35830','78242','41776',
                          '12879','52012','42229','78254','26182',
                          '60798','53475','36352','93725','36430',
                          '24770','10285','25688','13568','45059',
                          '76844','27245','19040','42374','68198',
                          '67349','71892','40772','27501','65425',
                          '59654','93601','25972','86387','63334',
                          '83531','95078','68842','54001','89331',
                          '61811','65396','32899','65283','30980',
                          '50385','91375','77819','33377','27557',
                          '19425','61689','49535','22839','16880',
                          '34795','40477','44501','76092','84493',
                          '39989','38212','62995','45298','84273',
                          '16129','91439','61252','45007','78701',
                          '54239','95834','65242','84632','55886',
                          '59204','33404','86467','98549','26820',
                          '69252','69348','38858','19282','54257',
                          '43932','66938','16890','42848','41485',
                          '54029','57244','80736','48267','88346',
                          '55694','39924','70766','80703','49029',
                          '32316','84771','65245','73354','50486',
                          '93922','28665','41586','99660','73308',
                          '56818','25799','20483','35926','61279',
                          '79461','36969','18922','89648','55801',
                          '97725','42422','94184','16693','12702',
                          '33629','67730','40139','96835','21769',
                          '12862','64099','10145','87461','26678',
                          '60840','78139','78590','31561','25777',
                          '47843','52886','25596','19447','13167',
                          '12659','33484','81421','53560','83263',
                          '17732','51678','94610','74588','80585',
                          '76789','27990','55937','72038','73282',
                          '98224','22346','21884','46199','92026',
                          '10375','45753','15113','30345','61646',
                          '85195','76010','22824','61357','56417',
                          '96139','86071','61079','77103','67029',
                          '47049','79259','25442','25887','28559',
                          '58918','15611','45741','81748','96580',
                          '76352','61404','22365','72562','94988',
                          '96402','60219','65428','33186','91248',
                          '37027','81872','33310','57595','70861',
                          '10839','22052','82228','11077','69141',
                          '38932','86563','58931','98133','66056',
                          '57381','17766','88200','18229','68878',
                          '34007','20607','82879','14673','70367',
                          '52768','87265','48263','93721','68964',
                          '59268','38434','44885','70409')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


