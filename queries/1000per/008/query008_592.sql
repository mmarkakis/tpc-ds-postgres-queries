
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '55454','34743','11801','89231','29161','59521',
                          '75823','23423','92423','90750','39252',
                          '44241','79949','36925','36915','73686',
                          '30313','67779','31929','26733','43085',
                          '31675','36471','41632','16444','58270',
                          '72705','99582','20592','75627','22287',
                          '50599','24439','91575','71991','53840',
                          '52138','86674','99892','80502','54989',
                          '74046','85634','49555','82871','95428',
                          '94619','79752','11533','65277','11813',
                          '61914','61432','46893','77323','61322',
                          '55623','85111','34651','30857','45419',
                          '74812','37778','98859','50211','35203',
                          '65363','75532','89788','59349','57446',
                          '50576','28413','47965','22321','97591',
                          '69698','91508','50111','86019','66430',
                          '41396','59871','17664','89886','28695',
                          '64834','57541','44027','85706','60521',
                          '35811','99586','87128','86111','19230',
                          '77990','72818','98613','86865','44897',
                          '76921','11810','84454','36892','61722',
                          '10469','53116','55719','92049','79884',
                          '37589','14441','97806','60411','26379',
                          '69824','32220','82613','29125','85540',
                          '58509','66638','82986','53006','87995',
                          '29614','29636','28179','23650','74318',
                          '61264','56729','50137','62489','77667',
                          '46907','75381','68997','17384','31046',
                          '93109','47736','41630','96225','54199',
                          '40312','72040','15991','60454','55680',
                          '52901','82359','22373','47886','32045',
                          '83517','67754','30486','45251','49590',
                          '59063','38997','77957','24730','92619',
                          '51406','81012','43170','99262','94740',
                          '91911','53999','46734','92004','77443',
                          '68063','43722','84541','10283','65125',
                          '22624','88361','97021','85374','48322',
                          '69157','25246','24687','52822','16559',
                          '85565','46020','94093','34664','18119',
                          '50216','19041','33292','33827','63164',
                          '28197','25341','26597','20638','81671',
                          '49966','78511','40761','90487','74694',
                          '43416','27838','21068','65549','82814',
                          '73369','23025','44273','75255','98623',
                          '95038','19051','62877','78810','91825',
                          '54634','66052','35042','37055','87818',
                          '65206','79515','33974','59582','31301',
                          '36325','92261','16141','14305','41774',
                          '55279','29024','31607','87634','89740',
                          '58331','67464','96922','49865','14892',
                          '91736','71465','80286','69389','22360',
                          '96803','60190','58687','53489','98334',
                          '22568','93301','10939','79534','53105',
                          '71444','99735','86008','46658','99398',
                          '55501','32687','60763','37610','67619',
                          '10177','67050','88907','63484','87125',
                          '61497','96162','87054','40617','82572',
                          '83769','93587','88251','99852','31676',
                          '57356','31185','71589','24652','52057',
                          '64896','17113','46974','74942','59822',
                          '69162','60465','80417','30484','37098',
                          '23252','22010','22209','66603','40126',
                          '86392','82853','72820','42814','75471',
                          '43999','60189','46724','77219','88261',
                          '11968','67634','98643','60800','64481',
                          '48640','35636','29208','67087','82408',
                          '19030','79749','82116','54669','77328',
                          '18951','81172','18240','70987','95868',
                          '93471','13767','68300','34485','13518',
                          '21674','80229','16202','23060','98524',
                          '57374','30416','22353','18815','40811',
                          '85092','51762','98519','50733','51361',
                          '27688','53593','93488','23925','71621',
                          '19683','20988','50549','82440','24077',
                          '88122','84439','86440','59033','85208',
                          '97888','73891','99962','98725','72602',
                          '73414','29937','95059','91013','69878',
                          '94105','45334','46713','75463','75452',
                          '88030','65008','23899','35114','63042',
                          '56040','23450','48588','62165')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


