
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '15405','20107','23082','21474','14888','91237',
                          '27263','47964','79541','87657','19881',
                          '46301','68273','27733','40745','57694',
                          '42937','63128','76190','44156','59874',
                          '29872','11319','87449','48800','79053',
                          '68674','99617','48490','32772','81629',
                          '58914','44631','76924','78682','12675',
                          '58715','51845','38934','48829','44398',
                          '52791','80432','90116','81128','39142',
                          '26818','49889','70383','49128','72231',
                          '83950','94908','22317','31709','30860',
                          '62345','57479','20752','41643','66364',
                          '20986','87326','28210','72955','79785',
                          '10826','61887','36698','62519','37979',
                          '92210','20967','90132','31071','43512',
                          '86882','83604','60772','48311','90770',
                          '62522','65233','38559','75254','57221',
                          '31824','85751','99678','51276','45816',
                          '80263','88538','28347','36376','33693',
                          '65862','18805','12964','93273','46352',
                          '65094','46817','59500','40266','85942',
                          '87602','77588','67576','48679','39189',
                          '35352','21224','47785','45509','99672',
                          '38888','60409','12783','65193','84235',
                          '42406','49065','36236','28913','39728',
                          '59438','85781','56294','54078','79354',
                          '17934','35933','83460','15774','65423',
                          '97604','28104','72010','73656','40070',
                          '26505','92827','92466','18691','94263',
                          '27067','68487','54071','55218','77917',
                          '33901','70923','71801','34730','31566',
                          '72294','93436','58170','95725','98403',
                          '44961','89610','53730','34655','60502',
                          '97220','13808','35786','95013','21818',
                          '15144','20290','46202','11102','16623',
                          '19007','56522','52059','21406','21483',
                          '39154','34244','49992','59696','44286',
                          '36538','28517','67039','63755','25982',
                          '77604','59113','94771','17619','81368',
                          '33963','25866','77139','12879','53623',
                          '43100','26144','33070','63627','51090',
                          '11168','90872','92066','11882','40262',
                          '15963','16367','79799','42655','83904',
                          '55359','93026','29196','44047','33835',
                          '32659','48666','22793','51527','71336',
                          '34261','75049','54489','85709','64000',
                          '73737','57230','45780','37723','10254',
                          '61085','29857','18002','80927','64909',
                          '36973','86021','32297','28119','68851',
                          '14099','16271','17221','56226','45092',
                          '31289','21657','66949','27468','90776',
                          '17038','85020','43437','92600','15736',
                          '39516','30877','29169','82894','53573',
                          '66652','50996','41170','11330','52524',
                          '39376','50563','39575','46749','75151',
                          '86102','19205','54050','28560','43754',
                          '77781','24390','35731','42895','16243',
                          '94396','31954','25218','64109','89991',
                          '43104','82139','94767','64802','83387',
                          '60233','77975','62443','64797','68173',
                          '22191','38653','52174','21539','60837',
                          '66568','16003','93432','47396','71939',
                          '68943','79372','39143','43952','52648',
                          '82232','49569','38226','38547','22390',
                          '61871','55372','82739','75451','51594',
                          '69132','97212','18531','15976','83250',
                          '88722','28454','26010','68980','77847',
                          '28493','40918','85714','84422','42582',
                          '44853','65848','44867','64518','14928',
                          '63492','63734','46009','60748','31973',
                          '83739','78428','82972','48269','47937',
                          '89626','42147','27250','53823','24698',
                          '62357','72878','15449','53843','41589',
                          '18020','82898','11189','45130','84475',
                          '39042','87166','57515','44377','11306',
                          '52702','63665','80887','73151','80317',
                          '16240','84301','36260','27909','30465',
                          '36465','18955','63669','41597','15392',
                          '17436','36604','90393','45447','91561',
                          '94134','18447','50199','88469')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


