
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '85615','96083','26907','60380','52613','24563',
                          '39686','57696','39209','62182','19560',
                          '24359','99514','70894','43183','86890',
                          '48868','29099','78242','90682','46207',
                          '80537','14442','61794','12566','65609',
                          '10081','91037','59326','89552','30276',
                          '94609','34088','38367','23520','55384',
                          '55329','87047','37905','45529','63528',
                          '16831','69929','48602','15246','66539',
                          '89771','61698','20055','33162','94267',
                          '85138','65221','98345','21625','51174',
                          '72512','78809','51869','11478','49971',
                          '33896','57795','79174','17516','36032',
                          '45989','19972','39476','25267','89117',
                          '73191','53973','54649','26696','91712',
                          '89077','54602','80590','66922','59540',
                          '56133','97820','64019','46395','31607',
                          '80852','79003','46846','23916','22453',
                          '50807','10290','44094','22836','81335',
                          '23100','70857','82279','74412','67542',
                          '78303','68412','96070','49278','43670',
                          '29916','86177','78948','88277','41301',
                          '17732','67305','33487','50286','44817',
                          '99057','40296','64674','69125','34779',
                          '75851','78337','85054','21797','24965',
                          '11678','31271','39883','84646','66497',
                          '17630','96758','82019','55625','28956',
                          '78673','17213','88079','56616','30034',
                          '21294','50877','33220','37760','28779',
                          '57854','26850','50641','46341','46086',
                          '50161','70345','17298','40562','60486',
                          '54836','62319','82675','90683','12929',
                          '57857','60381','79147','64350','83100',
                          '93395','98766','83332','67912','27577',
                          '87289','45351','22702','98615','86210',
                          '85537','87856','80374','25842','40347',
                          '76789','24978','50415','71788','50210',
                          '92472','37962','42913','57768','61389',
                          '24709','78076','50431','67933','22857',
                          '50820','23373','19531','18515','39994',
                          '63844','89205','64246','30547','14111',
                          '56460','59908','42097','18269','20399',
                          '47568','13050','44135','95194','70276',
                          '65896','76093','83753','23791','95290',
                          '70796','32032','19217','48268','38486',
                          '29630','38872','46525','51637','63467',
                          '33178','87482','27038','51870','49143',
                          '52175','84176','85283','37329','58074',
                          '61302','84703','45088','48792','71021',
                          '56731','77382','26669','87519','89213',
                          '38587','68021','44083','44167','25381',
                          '28256','32670','38231','36692','27228',
                          '68636','94740','95836','72901','92873',
                          '79050','25173','87614','21577','57905',
                          '71772','69414','96603','88587','97588',
                          '32121','90840','33588','67735','50804',
                          '77087','80619','34705','80252','73513',
                          '83607','48235','80467','41821','88096',
                          '27649','50711','72475','16518','13169',
                          '52917','79183','31504','93088','96297',
                          '69528','40492','60250','81947','95201',
                          '65271','32645','13049','44294','13897',
                          '84151','17020','10990','49546','36252',
                          '42375','60273','33927','37678','39462',
                          '11652','77894','15879','76684','47388',
                          '63470','77004','17357','43099','11365',
                          '50737','74364','15723','26548','13667',
                          '84834','58423','78973','80658','36253',
                          '49414','18743','83377','79729','96421',
                          '64320','74941','30646','53113','31888',
                          '10307','21914','38667','79321','29088',
                          '65091','92429','15364','55434','84172',
                          '82023','79624','11137','66659','86669',
                          '91127','44312','66232','76327','25864',
                          '14307','94676','40685','31635','57051',
                          '23594','57391','94981','75890','12891',
                          '53719','60709','67965','21037','51058',
                          '91284','87015','46245','72300','17401',
                          '28396','22627','68347','82999','23369',
                          '95828','54886','13808','72799')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


