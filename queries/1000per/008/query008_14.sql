
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '74285','86603','97367','66387','35562','76550',
                          '79242','94464','29206','81560','67918',
                          '22542','62872','65898','79955','34929',
                          '67190','45369','68447','59372','73153',
                          '26454','96871','59288','35532','36001',
                          '66272','91285','54609','26523','11912',
                          '49682','57178','11756','28607','60306',
                          '60871','67480','44027','20160','29421',
                          '94183','22546','90765','26712','34661',
                          '45381','90734','36748','90840','73115',
                          '37339','32912','37968','94020','93374',
                          '21560','19287','88891','94369','61076',
                          '48717','38632','36571','64404','38970',
                          '56384','48661','60634','12115','63144',
                          '41825','93697','71054','88742','84445',
                          '19244','69872','62743','15794','24993',
                          '10153','20564','96204','82179','55697',
                          '55502','88284','46085','41806','69260',
                          '76759','39999','91063','13184','42482',
                          '61848','94698','65906','68583','48706',
                          '49187','37106','35443','81910','92314',
                          '97058','21670','94764','32290','38727',
                          '76254','70515','77316','49802','98430',
                          '23711','37850','70708','61007','13058',
                          '87027','35124','41153','40636','67665',
                          '46329','96047','17912','67500','97592',
                          '21280','62382','12078','60529','14309',
                          '43341','14414','99132','10995','60017',
                          '96792','36132','68102','78674','92994',
                          '45033','60682','25982','12472','83844',
                          '65701','29057','26656','94581','69077',
                          '95652','42936','69345','29267','16758',
                          '10396','82704','41615','79728','38198',
                          '81798','72466','42823','26966','88326',
                          '40940','40826','55134','56757','12826',
                          '47904','23965','55919','49332','92123',
                          '22135','51729','40186','84354','92578',
                          '94880','77998','90110','71384','82594',
                          '79746','25094','52442','21088','15660',
                          '80330','32233','23321','69743','15690',
                          '92039','15728','95220','26069','74302',
                          '23213','78618','61601','39261','60369',
                          '68746','37007','86362','77049','25530',
                          '59569','36102','42378','82825','38074',
                          '56591','88667','74736','90636','70368',
                          '68173','88348','75784','22614','78101',
                          '66412','32246','10450','51731','38998',
                          '87942','96815','76060','44850','89395',
                          '97930','10093','86296','77100','88118',
                          '95360','12003','21551','82723','24635',
                          '89577','71001','41963','58792','50129',
                          '90777','31500','89783','41351','60848',
                          '44622','23255','66210','30376','36140',
                          '75092','29264','55151','20880','46286',
                          '98392','32865','17356','22658','66554',
                          '56558','36699','74442','16698','61385',
                          '96129','17439','82597','83231','65645',
                          '82238','97089','53034','95292','12278',
                          '91538','55495','81965','55549','85615',
                          '68419','98067','14827','86536','76191',
                          '79817','41499','83033','45539','35001',
                          '92831','54424','51884','51513','92766',
                          '86098','35182','97172','96188','87937',
                          '10689','64767','22949','81257','24125',
                          '50303','44623','37543','71433','58007',
                          '37465','53613','65647','22483','36574',
                          '43298','64475','84763','89015','69508',
                          '36734','38754','25074','73161','96442',
                          '38271','42014','93282','36450','15329',
                          '72977','25536','56523','31573','28953',
                          '42144','27522','38848','74157','82501',
                          '40080','54772','40937','71198','49495',
                          '33755','96530','83384','55233','87696',
                          '63337','87561','67995','73964','29814',
                          '82056','58146','99194','60268','93639',
                          '15617','49945','46686','92155','21189',
                          '25753','30954','38853','78791','66299',
                          '62869','34098','84622','21549','36139',
                          '64101','49766','51169','39141','79645',
                          '85437','91205','52508','49059')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


