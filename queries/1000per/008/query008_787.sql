
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '46572','81438','44271','75333','16049','22105',
                          '75942','17278','24367','33936','10895',
                          '92051','19350','82962','11050','67376',
                          '87717','75256','91259','28758','60853',
                          '46396','71595','88698','13233','65820',
                          '92155','15717','19321','67212','87643',
                          '84661','28705','64667','99718','58507',
                          '23688','76505','79192','37899','14313',
                          '93760','72402','95037','96208','67079',
                          '92396','21250','68381','55949','68274',
                          '36351','30626','35655','48292','33676',
                          '43407','83283','59887','75679','81301',
                          '79775','24721','16781','38370','16331',
                          '45475','95727','62321','32286','64572',
                          '75742','88216','59330','13411','20638',
                          '23492','66230','21853','29094','20000',
                          '57882','30467','98460','99824','16713',
                          '81025','76928','62219','92573','48797',
                          '86291','81202','16925','57802','81774',
                          '19874','55315','99878','89087','59848',
                          '75427','80184','84401','20035','50780',
                          '53677','55600','34457','18409','38639',
                          '28519','51255','92786','11462','23884',
                          '22609','45917','67763','45672','73219',
                          '89354','10897','38907','32922','35676',
                          '35322','48433','14042','14127','93001',
                          '65622','46291','41233','32269','22605',
                          '36425','90070','76905','33111','81755',
                          '67184','51682','77077','31932','78065',
                          '92649','54377','31518','33966','69878',
                          '45732','88331','59967','47334','14481',
                          '62915','88186','98246','37838','59970',
                          '21090','20784','36357','34960','82992',
                          '32847','35049','13859','49359','54531',
                          '24264','93188','19798','56436','78948',
                          '69234','35273','69399','99415','38991',
                          '39124','25015','99917','71683','59076',
                          '91195','13145','49860','73667','33200',
                          '55244','18680','34734','80726','17209',
                          '60373','70607','31256','80658','98421',
                          '57111','82000','60581','20048','16373',
                          '14435','89454','63325','86388','35362',
                          '15971','96742','63827','79209','77123',
                          '20589','48096','25685','34832','37237',
                          '76907','88458','90172','58644','45123',
                          '19703','99795','33190','74674','11871',
                          '97230','54237','20308','86303','84363',
                          '48529','80800','81543','62151','62114',
                          '11295','58828','70960','50667','99870',
                          '34854','54955','54725','61361','55651',
                          '60390','54194','80738','30835','91517',
                          '81768','42699','92514','49905','35541',
                          '89676','82177','40533','24795','49355',
                          '69645','81841','26669','91710','14794',
                          '28138','96806','77075','85831','35696',
                          '46556','64778','53656','77454','95433',
                          '94499','42987','31273','72711','49257',
                          '98338','15895','25571','25430','55739',
                          '66182','28243','83025','77943','42709',
                          '57813','74734','94239','23378','83618',
                          '41567','83485','59208','28657','61712',
                          '66211','36366','85926','64574','72601',
                          '64622','82629','32019','13111','68516',
                          '61542','52792','32424','35413','48001',
                          '76049','26544','35436','29015','22558',
                          '90225','82225','13450','50516','99842',
                          '13730','51526','74207','18840','42288',
                          '51528','93986','59797','23284','98165',
                          '94628','73184','84440','50131','29311',
                          '25829','67964','85183','79601','25452',
                          '65489','54224','82999','84055','30962',
                          '85256','80681','96781','83444','19627',
                          '17943','45029','10487','91062','30203',
                          '16576','90776','13823','97594','18432',
                          '61069','95411','30587','89149','33358',
                          '31644','70324','52471','52448','78809',
                          '16415','39490','33800','71845','49924',
                          '49654','88275','99879','57896','21814',
                          '65911','31693','77613','76668','45377',
                          '26009','50570','16851','64476')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


