
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '84627','81992','95656','54578','53665','47505',
                          '58096','69827','60607','16644','52077',
                          '26375','63069','39255','40477','93083',
                          '24434','16046','38649','19758','56150',
                          '31135','93873','88385','79690','23610',
                          '30283','24661','90972','64299','70055',
                          '98766','49697','95905','95536','67626',
                          '61112','24028','28903','27593','15023',
                          '66158','79365','90228','17625','33935',
                          '95160','66587','41165','11511','22760',
                          '31185','22482','63451','31700','67670',
                          '57532','61346','42078','65264','53547',
                          '40259','84106','87709','49253','61040',
                          '91790','32241','42697','42487','46394',
                          '31655','62107','24177','54628','98223',
                          '72512','16139','94305','49407','38246',
                          '31363','68599','70429','67649','35982',
                          '96829','22977','99315','77905','61478',
                          '20100','50898','30791','96110','51698',
                          '74256','29924','95542','27907','72264',
                          '28146','48137','97517','84793','15091',
                          '69215','43679','11175','73629','62738',
                          '36506','24443','90634','23584','46129',
                          '62735','13241','42267','86401','42955',
                          '85907','95590','44228','19526','74098',
                          '45578','51634','90900','39691','72272',
                          '53493','92643','54359','66496','54169',
                          '50487','26561','61960','25052','48517',
                          '73028','63804','33355','89071','30718',
                          '69530','13311','64859','52788','56891',
                          '39910','91003','44838','23864','96129',
                          '36383','58786','37926','61119','84949',
                          '83363','63761','21181','91310','34414',
                          '44091','52590','19492','65974','76375',
                          '21328','62530','29658','31847','15815',
                          '22930','79480','29206','25775','85101',
                          '40877','90274','58810','73961','64466',
                          '40112','40403','64289','44794','90380',
                          '83641','92485','60205','45724','82224',
                          '84770','46915','83804','99994','61448',
                          '99410','81753','51192','76520','14063',
                          '36052','26549','14550','31962','10426',
                          '32097','60604','71391','54633','98545',
                          '20507','90127','59532','51412','25132',
                          '88053','66415','87326','32503','89968',
                          '16739','80010','72975','70264','45837',
                          '40147','97168','76907','52745','84062',
                          '57984','43030','75826','18551','93473',
                          '52060','55085','35272','81068','82524',
                          '65704','66714','52879','29531','73318',
                          '68785','62295','98089','98256','83870',
                          '75905','88823','54155','17361','39956',
                          '80238','56434','55865','50382','56894',
                          '60349','69372','36173','24193','43159',
                          '53886','66759','62976','67097','50927',
                          '42551','37359','91704','28412','76126',
                          '41602','16019','14383','27291','82375',
                          '56081','85008','11423','76348','77150',
                          '20524','43119','96255','85570','99454',
                          '76058','18888','36680','75765','63474',
                          '63970','81961','90587','36164','73363',
                          '60168','57332','27281','35762','37093',
                          '29415','41823','94284','12107','48910',
                          '44341','48726','61771','22056','62802',
                          '18078','89881','54516','84122','16044',
                          '44070','60684','47852','79791','22365',
                          '40538','44215','18771','23277','65770',
                          '89452','77948','89683','44480','40265',
                          '30388','26430','35220','20674','39576',
                          '44502','85492','66798','84782','18797',
                          '52583','62069','27460','60291','93722',
                          '16413','14055','88508','92796','97299',
                          '91414','93468','94630','88674','23274',
                          '99335','80699','64976','71454','91234',
                          '88035','71397','72397','66901','42512',
                          '88211','74310','70654','23691','63077',
                          '73482','60290','58761','59607','81913',
                          '21288','87264','33085','49828','75371',
                          '56464','76830','46807','16308','82167',
                          '22338','95636','99197','15818')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


