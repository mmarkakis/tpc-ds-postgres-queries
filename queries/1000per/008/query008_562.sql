
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '94367','75492','89905','32425','50895','83643',
                          '23886','65317','13321','76000','29323',
                          '14489','84104','30778','22137','36222',
                          '90411','80130','21561','86564','86330',
                          '16004','49392','27055','80415','98885',
                          '22921','18258','90704','96527','38903',
                          '75777','37621','44139','70168','79789',
                          '23419','44016','98097','91367','25220',
                          '13889','48763','43855','17847','19007',
                          '31720','11322','57074','57811','14732',
                          '16988','16300','69903','39895','84069',
                          '50125','34357','68819','34333','13395',
                          '62805','85169','91751','89982','46409',
                          '68795','25743','83900','45651','50244',
                          '21612','44997','67148','52109','78414',
                          '26824','81496','54612','59673','58171',
                          '88645','72351','15203','45632','76827',
                          '49917','58906','40698','85938','47189',
                          '67427','19986','98429','55730','11758',
                          '93826','84638','11800','74462','27886',
                          '53313','70487','30464','78290','33879',
                          '31470','17719','30192','33835','48648',
                          '25990','57186','56697','93176','39256',
                          '98489','78228','33164','67116','41670',
                          '21418','86838','40656','72223','22413',
                          '97280','19323','31083','22026','93679',
                          '85549','37593','76150','28038','13021',
                          '94083','94541','79123','61286','90223',
                          '68427','13724','85898','39388','63481',
                          '51169','93108','53878','29372','32365',
                          '49169','16584','14546','66297','18355',
                          '67950','45018','68132','57953','43698',
                          '93449','46319','20791','77195','93746',
                          '52191','45909','80643','12844','51803',
                          '49696','99368','70152','36251','14447',
                          '64124','25942','97823','72926','38428',
                          '47255','38011','26537','68292','89590',
                          '45184','70123','87466','95638','89358',
                          '28345','50090','90664','38096','43334',
                          '49911','45958','95216','98376','62201',
                          '76675','42683','22800','86107','32674',
                          '86161','59821','96532','45311','74749',
                          '48175','40645','61437','33563','15666',
                          '49402','20766','45458','14934','24800',
                          '87533','12102','45894','35787','97712',
                          '51586','64322','58499','49269','13305',
                          '16587','78329','60016','46076','53785',
                          '43315','57379','77553','48522','19159',
                          '99903','65010','50841','71327','54958',
                          '29402','96492','48330','22206','76086',
                          '19853','18086','21037','23693','74983',
                          '71964','56162','62472','14759','40203',
                          '36212','60446','10948','34053','96202',
                          '77615','29954','19901','31992','49076',
                          '88641','87256','26404','45440','36098',
                          '46236','61746','34586','26452','61684',
                          '85453','47918','56293','24993','63826',
                          '76904','15706','74565','15515','62356',
                          '18538','36516','52516','10624','66679',
                          '12841','68404','83375','16903','83909',
                          '93630','80390','86915','48093','94351',
                          '29700','74986','56018','28915','95029',
                          '76419','89543','98023','58732','75399',
                          '96974','10847','26608','41153','74520',
                          '47958','40982','70432','12097','38661',
                          '35038','77913','24293','74750','38690',
                          '66916','45872','97412','21183','86899',
                          '53343','30641','64866','73953','13942',
                          '59819','86261','41470','91504','16677',
                          '39458','15866','52665','61924','77993',
                          '87408','65034','25998','70646','60248',
                          '10739','33965','71059','73141','97611',
                          '30359','49505','70311','26066','24762',
                          '62471','60641','59985','88323','67665',
                          '81104','15242','50775','37791','60708',
                          '86859','30738','59363','90072','59255',
                          '65268','52625','59685','72297','63766',
                          '83537','55053','89942','76660','43401',
                          '96428','29944','61084','90189','60008',
                          '59311','63125','42933','61943')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


