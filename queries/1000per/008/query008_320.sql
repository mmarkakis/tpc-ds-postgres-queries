
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '25902','25955','57406','68860','30000','93669',
                          '35553','13386','91730','21843','13198',
                          '48848','41946','63055','58162','29034',
                          '92790','30776','34154','40418','31954',
                          '41382','25234','77017','43425','82938',
                          '86808','80755','39563','27073','75722',
                          '73756','60860','22452','46208','93281',
                          '85860','35693','67822','24105','11593',
                          '80921','65957','34136','96422','73854',
                          '55724','49538','92074','75913','94590',
                          '52706','60789','31713','89682','70597',
                          '93374','24505','70672','50993','42439',
                          '61186','25573','27427','96997','46528',
                          '99270','89144','39338','45817','37920',
                          '17216','38019','67081','66160','69227',
                          '17981','63016','33731','48210','82536',
                          '51222','49273','49531','74028','90108',
                          '98867','75239','10450','12794','86788',
                          '46032','41999','98953','22842','77846',
                          '83244','65444','10617','54649','41558',
                          '29731','96043','69638','74672','76114',
                          '26329','75533','96934','61689','66463',
                          '75115','70943','63695','98580','70417',
                          '39978','45293','61143','29036','18006',
                          '17640','49168','50757','84173','98773',
                          '30780','99224','79403','29623','42664',
                          '89622','69781','98893','67977','91414',
                          '51697','28282','34718','26746','30142',
                          '33138','71719','77956','73631','51479',
                          '79550','99877','90785','69091','53082',
                          '52848','76089','33300','80612','19359',
                          '13564','74835','67729','15112','16944',
                          '69282','70073','13423','67654','48246',
                          '13096','49834','91352','41774','32999',
                          '49219','34664','75924','99483','81781',
                          '43660','51836','95570','99913','82753',
                          '13107','50435','47015','25126','25118',
                          '47398','96270','71147','92277','15328',
                          '41289','22846','74852','89993','68390',
                          '17034','17394','12648','75820','87662',
                          '21880','26964','63002','38368','17627',
                          '75685','23874','56215','33880','20239',
                          '86706','14207','28656','60619','67107',
                          '67586','55670','58118','11747','83712',
                          '99865','57056','72269','10434','10964',
                          '99948','47025','53862','71314','31680',
                          '65468','98268','95201','42216','89632',
                          '71693','93142','72045','80716','99780',
                          '62268','60120','45900','84743','43724',
                          '58110','84201','83258','52262','65532',
                          '71617','40116','51162','39382','62392',
                          '85358','94011','32473','43412','35438',
                          '43123','36552','44925','82509','17040',
                          '85081','71469','92267','82972','32319',
                          '97097','24703','73478','91691','95916',
                          '13451','71156','33619','98195','45743',
                          '58529','72341','28925','83391','54740',
                          '28572','99720','87565','99454','70010',
                          '65148','67989','17376','50868','26866',
                          '90404','90152','99363','83234','11277',
                          '31272','51648','39342','24237','67808',
                          '33865','96164','42736','55748','68683',
                          '74597','52340','32137','80314','53522',
                          '36780','49136','36684','82911','11339',
                          '44084','53745','38211','88064','98148',
                          '60538','38765','48528','81291','93302',
                          '84622','28033','39135','65247','70411',
                          '53600','33371','19023','51514','60356',
                          '89886','30033','50473','42242','12657',
                          '11041','69776','18687','33494','34051',
                          '14344','42029','30498','28696','85692',
                          '22320','59219','15643','54389','89917',
                          '17713','93744','50930','65105','49547',
                          '20954','97343','35555','87304','18256',
                          '85886','91430','37369','13696','76048',
                          '94375','62022','41187','75944','78462',
                          '80984','86344','69778','31607','57078',
                          '64089','11892','71278','22871','29102',
                          '25913','90063','10092','72181','98584',
                          '85565','14856','26314','76726')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


