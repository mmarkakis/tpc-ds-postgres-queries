
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '93150','42648','36792','56207','42364','19825',
                          '96047','52055','91852','47266','21550',
                          '88000','20115','15471','95413','18811',
                          '27223','57752','44756','95182','87550',
                          '95711','74266','89769','28201','29720',
                          '77214','57969','71580','30264','88819',
                          '52745','22604','92421','23023','49579',
                          '18036','48549','24967','15381','38548',
                          '95756','23512','43460','21468','21231',
                          '38674','35318','91312','45263','16820',
                          '85303','57565','41135','19803','35455',
                          '21734','20512','31283','74472','87695',
                          '48892','57905','64013','97122','31469',
                          '31302','16846','44648','92839','75278',
                          '87452','96230','55458','71405','48788',
                          '96177','45714','40673','97445','80116',
                          '91674','84009','29923','81447','24824',
                          '50624','12790','94783','36177','61268',
                          '77035','49151','19535','89669','40465',
                          '59580','61774','84483','52054','99720',
                          '29487','86985','41442','79423','98208',
                          '24224','34801','66769','85489','49963',
                          '59483','24741','93420','17248','37191',
                          '84544','17961','18893','74830','44812',
                          '22252','31593','58555','57800','60581',
                          '95368','35490','16814','49397','75359',
                          '99408','94126','12269','15377','24553',
                          '41891','96912','52795','47249','45295',
                          '49419','56954','80217','36608','27065',
                          '83140','81123','34853','94754','74125',
                          '21967','88306','79576','50048','51482',
                          '67258','14136','95382','71145','14253',
                          '95752','57811','27156','38764','89261',
                          '85541','79218','43112','56029','49779',
                          '59317','28177','52595','73440','90699',
                          '58265','40862','63959','43943','48606',
                          '90633','46095','11767','24176','45707',
                          '54492','57648','29084','52906','28059',
                          '64894','24976','37002','50887','89713',
                          '98573','69106','50247','70360','66336',
                          '58437','27841','90447','79353','77546',
                          '36097','59944','48789','51364','46850',
                          '42282','24199','91874','93884','39170',
                          '95913','35080','35473','44040','62410',
                          '97135','83202','75440','21992','98737',
                          '15434','64025','33857','58607','91410',
                          '25167','34750','52279','69697','22735',
                          '50314','87027','65505','56170','94005',
                          '34195','29638','69054','66569','91525',
                          '88063','68710','79253','98450','35314',
                          '74881','89341','91144','68359','44384',
                          '88519','47576','56242','48196','10610',
                          '64495','27062','38574','90799','15081',
                          '62971','76576','26518','85474','96888',
                          '12138','34510','78539','12948','40402',
                          '73844','46091','24206','22872','25773',
                          '45570','85571','48354','70781','93115',
                          '97924','25844','28920','44933','33171',
                          '89346','93746','50203','67019','19963',
                          '74186','31577','50547','69534','97570',
                          '68335','74488','80628','11242','11613',
                          '79360','77383','39549','13519','19401',
                          '61670','66175','53628','46060','25128',
                          '51464','22112','63886','78230','80355',
                          '93620','54703','12191','52104','26254',
                          '24785','36504','12774','53981','24546',
                          '97370','94634','77742','59973','98863',
                          '44354','81284','15916','89541','29922',
                          '53058','68888','14807','53556','84031',
                          '45841','79731','46744','66441','86799',
                          '50977','77606','71195','32194','42982',
                          '87569','75119','67143','74519','79345',
                          '52747','68144','29234','69463','64698',
                          '21598','45458','34325','52486','28614',
                          '76265','46364','13985','65689','71811',
                          '35652','72229','25015','51284','85895',
                          '25060','81116','13563','93744','84655',
                          '94184','67999','36674','45541','47917',
                          '78987','16966','74916','90553','70135',
                          '97916','57012','66419','51044')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


