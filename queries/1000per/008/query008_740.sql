
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '78272','16191','24000','53441','45980','53453',
                          '36616','90809','85643','33698','11928',
                          '88972','13853','56007','18407','70759',
                          '36027','44317','46657','40825','76724',
                          '75380','44358','36909','54765','70193',
                          '68755','31853','70296','96634','50512',
                          '21479','69857','85509','64811','10120',
                          '59027','66674','43008','86379','63829',
                          '81846','88516','87148','15321','38854',
                          '15718','43328','88540','80155','64519',
                          '66528','73497','64054','89566','77818',
                          '69149','26761','38188','37089','99715',
                          '67996','55636','62789','62439','16673',
                          '55571','34128','38826','52060','42031',
                          '51469','23522','45359','70889','28977',
                          '42066','14645','93791','39153','31908',
                          '27272','99536','45817','53606','60010',
                          '87655','31796','13956','44025','93695',
                          '54348','48833','83160','30214','36812',
                          '34415','91792','37051','62261','59012',
                          '94677','52773','26406','31689','43567',
                          '39878','36135','97633','59199','82974',
                          '88246','60373','50891','34163','78511',
                          '30304','11974','95839','71201','64606',
                          '75054','42418','81874','66827','81356',
                          '21490','29766','42222','14959','73499',
                          '13503','98590','27251','58566','89492',
                          '51999','70805','12268','61165','88858',
                          '92888','22300','29630','71838','56824',
                          '79672','52527','67779','33854','43313',
                          '30989','14855','51427','99987','18109',
                          '98305','12831','80773','82733','76898',
                          '95904','55733','58444','33180','37995',
                          '43498','89714','56218','83895','36785',
                          '60679','74068','73215','63952','44244',
                          '26450','84633','78414','26106','12670',
                          '82700','64133','26578','39059','60467',
                          '25618','23170','36602','62780','66733',
                          '17493','17793','84537','36097','37368',
                          '89260','93643','19631','99391','89091',
                          '80805','31481','33610','68027','11248',
                          '31802','57751','33478','72490','35901',
                          '51380','81980','75929','37940','21943',
                          '12401','86727','61260','17343','69835',
                          '67294','79473','49228','53629','81145',
                          '87248','28258','95700','75871','99424',
                          '52903','23276','18372','44829','96173',
                          '55474','66014','52141','44484','66623',
                          '92849','77589','21342','95954','59082',
                          '42302','29765','28392','11778','71933',
                          '19131','62720','42938','69864','35264',
                          '31469','61545','14114','53298','74663',
                          '80604','15031','94773','82941','23828',
                          '29418','30533','18702','39836','89487',
                          '72702','73247','85858','93546','13075',
                          '97667','20766','57888','34126','84478',
                          '28006','31397','21331','91507','75482',
                          '92004','18472','95863','73963','16842',
                          '21214','78794','57864','66588','84801',
                          '79642','93079','19934','99172','44408',
                          '59527','31755','23177','69677','67978',
                          '26756','90455','82356','17082','49381',
                          '43079','64711','90088','89722','66270',
                          '59497','74551','53942','47835','68608',
                          '42675','37726','21508','79512','34198',
                          '78250','71496','66433','82626','66162',
                          '22587','83187','71574','19493','99684',
                          '94109','44156','61038','57958','35959',
                          '46644','49980','24124','38434','66572',
                          '98349','86587','49305','13042','89765',
                          '52921','73680','74033','25650','36107',
                          '22733','75698','32649','11724','27817',
                          '41998','27927','18651','17202','84911',
                          '94156','87828','94258','95195','87365',
                          '41301','68252','34486','62001','22856',
                          '39974','71744','74503','19744','38384',
                          '54870','37859','48930','51939','18536',
                          '21151','46396','98509','26645','50735',
                          '81719','52717','39382','41621','27147',
                          '50294','47035','26798','49612')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


