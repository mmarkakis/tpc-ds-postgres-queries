
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '63870','95290','22494','28392','96569','50983',
                          '65087','72483','58743','86890','85027',
                          '33087','29192','27154','67430','58848',
                          '37516','18807','99700','69107','49076',
                          '56159','46845','19893','91350','93284',
                          '34299','74909','67659','95757','11263',
                          '20608','59213','72653','45057','28389',
                          '78871','75945','64717','98678','21882',
                          '64779','98838','84693','46287','38680',
                          '43464','80308','78337','49835','31164',
                          '57609','71003','63358','79732','69899',
                          '53453','14893','28219','72849','33016',
                          '85980','77766','46558','36208','44938',
                          '99831','67970','82831','98413','25205',
                          '91767','17747','72244','54137','41370',
                          '92710','90769','71983','39996','11729',
                          '92257','30982','31041','68550','39421',
                          '20392','99578','29980','44452','56189',
                          '63698','42147','79758','25699','30102',
                          '47667','14104','28762','53584','53737',
                          '65370','67612','36861','53437','89361',
                          '64565','74479','61720','21685','66516',
                          '39519','42662','80200','41534','15270',
                          '42078','60949','65245','81218','48097',
                          '51626','67404','95566','54276','88372',
                          '76790','18792','68817','73122','87397',
                          '91083','54019','58409','56040','57801',
                          '54781','28815','26684','63885','18677',
                          '68864','37370','60676','80972','34429',
                          '20695','51691','79062','16381','59218',
                          '77307','48075','45274','92863','66795',
                          '16329','47199','54906','44744','67423',
                          '25316','43570','65996','21633','97368',
                          '11445','62035','63618','12103','38222',
                          '25953','16302','34654','41548','97234',
                          '46055','97642','85837','98701','10367',
                          '26055','66076','89095','84196','45856',
                          '14305','95702','34014','23432','52718',
                          '51085','75511','19420','11373','98137',
                          '24021','77018','18167','85257','91358',
                          '71587','57445','81882','70261','35051',
                          '70196','13040','38775','24895','93909',
                          '48195','33408','95030','90178','63236',
                          '64044','83188','85609','50878','45519',
                          '48770','63839','83613','91119','96352',
                          '64072','78715','80427','56444','32363',
                          '96035','17703','40506','38317','91193',
                          '18877','94279','91171','13521','20239',
                          '69493','80755','69937','68832','24304',
                          '79828','72491','75922','98345','75540',
                          '84712','44692','12853','23923','24249',
                          '55999','89356','68649','41869','67547',
                          '74296','78642','82601','44633','86618',
                          '41352','64908','78382','50424','61106',
                          '12998','45389','10475','59913','27995',
                          '87499','76522','18136','35748','15162',
                          '72945','10142','99691','28132','50225',
                          '36218','59835','54857','78125','99592',
                          '19288','33119','64548','45607','42723',
                          '52688','74670','72210','10389','77022',
                          '91355','69956','34464','25662','84945',
                          '43222','40455','35150','35614','65694',
                          '60380','59674','11574','62497','67169',
                          '33763','73344','59960','59338','42760',
                          '25705','20395','16814','36897','74516',
                          '26016','37792','77703','88084','55490',
                          '67542','76710','44972','89309','40376',
                          '86748','52600','47347','15150','11860',
                          '60519','11949','21121','93445','76188',
                          '81870','18368','74768','74119','46142',
                          '64680','85791','33133','31405','58810',
                          '66089','82218','86427','73671','22697',
                          '74433','75462','59327','80201','23367',
                          '29080','96078','56281','22081','24378',
                          '95005','93477','51187','70868','63547',
                          '78143','47601','42753','82861','86368',
                          '56068','34460','81754','23266','72013',
                          '58660','60151','73586','88823','31298',
                          '77799','96138','37707','31421','40425',
                          '48366','59003','18470','16881')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


