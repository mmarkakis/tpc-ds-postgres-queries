
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '29902','11244','52917','69967','19122','46083',
                          '69218','16860','89648','57978','24134',
                          '60557','43736','54871','89418','15904',
                          '75133','63282','29865','87651','73831',
                          '45589','34966','61169','32937','27888',
                          '15192','54274','99140','22437','76540',
                          '52034','36328','78730','37511','71803',
                          '35201','17642','41788','57614','65019',
                          '69771','37806','43588','67759','10997',
                          '85472','42933','13427','73675','88630',
                          '10279','42041','53257','66365','48767',
                          '25953','35042','72863','42903','70428',
                          '36968','82125','99116','51317','62512',
                          '53132','95064','91907','85650','16157',
                          '44696','75837','15769','50833','60716',
                          '37401','74997','24805','42121','26063',
                          '77645','43926','53045','64150','76710',
                          '24022','29210','58048','77912','43625',
                          '68496','49530','64357','41483','94825',
                          '68230','91794','11752','28877','47668',
                          '70077','33255','81665','83611','48211',
                          '43747','10578','88725','30603','74745',
                          '77786','25974','74715','89928','13139',
                          '58170','91345','58740','94030','49094',
                          '73349','69211','86632','81110','96881',
                          '19861','43158','56495','51406','37648',
                          '22105','51633','32161','92672','20328',
                          '75249','89105','82705','62103','83196',
                          '27743','31174','31411','98085','24757',
                          '48220','76456','70642','55474','22397',
                          '21683','68943','24682','99346','90416',
                          '60668','93719','61837','63158','25537',
                          '48183','30444','79815','23267','87489',
                          '22092','46640','31348','19915','17188',
                          '69108','54861','61155','82855','22177',
                          '32585','65222','98122','64278','71723',
                          '39086','37743','21282','41177','94598',
                          '30088','90188','70218','38651','39332',
                          '40720','75359','42137','61116','36466',
                          '16784','11958','87276','70656','99744',
                          '31606','93868','34207','58479','34694',
                          '50559','24664','40395','22904','72456',
                          '88430','16493','18912','27238','32476',
                          '16474','60432','47897','35057','86163',
                          '23929','96057','74986','26627','61859',
                          '71751','46701','68413','92254','65498',
                          '38018','34990','36441','96118','98326',
                          '48085','46366','11215','16228','24113',
                          '11866','24570','34666','98628','96148',
                          '85267','50456','99922','96541','86124',
                          '99705','12803','58282','10491','52466',
                          '67734','10481','21198','19026','25575',
                          '62468','22627','16978','31241','60310',
                          '71418','93831','95622','90281','22330',
                          '23978','71927','76801','27920','38529',
                          '72891','52747','46819','15247','19729',
                          '26472','83025','34290','46323','69500',
                          '63533','54908','50143','39432','57156',
                          '13822','90217','46860','46455','30174',
                          '61990','55767','89525','82834','64848',
                          '26880','11739','52625','56965','56693',
                          '22853','15698','51422','15036','67743',
                          '84109','67977','44750','18339','60267',
                          '24284','68564','75302','15288','55020',
                          '58892','83585','26912','90623','70822',
                          '85569','83959','93974','27707','80090',
                          '85894','31210','20881','27611','12032',
                          '73186','24086','37886','36895','50233',
                          '32945','57604','86929','30359','99247',
                          '39909','29576','13953','55459','68497',
                          '97459','98255','66636','88719','28732',
                          '65187','18510','19650','78981','73642',
                          '61102','71459','97672','79444','85160',
                          '14502','83653','97776','99348','47664',
                          '33280','90660','39984','91705','91431',
                          '54251','59666','49237','58660','41974',
                          '92762','54387','24948','36900','91176',
                          '39253','75443','47030','63097','67366',
                          '66321','24272','79864','34613','42603',
                          '29720','46377','27678','67064')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


