
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '55419','90877','33864','18782','84461','53906',
                          '33387','36312','52445','75598','36033',
                          '95827','11730','69605','37859','39293',
                          '21669','24105','64939','95987','52486',
                          '89603','56370','87400','90273','13811',
                          '85272','73429','40504','46775','34124',
                          '62317','21785','14572','90445','37652',
                          '15180','67356','84599','77360','63856',
                          '69505','82685','23805','81540','31899',
                          '45706','18721','17723','22268','70879',
                          '77506','76901','75024','56111','42561',
                          '65942','61722','97283','75359','32167',
                          '71434','57508','23061','68001','38572',
                          '57590','74290','53268','91924','96220',
                          '69398','34043','98354','54171','24358',
                          '29870','83249','22312','94625','29574',
                          '31189','88843','10151','60197','96526',
                          '15830','82936','81952','65708','29531',
                          '23038','46919','31072','72157','25761',
                          '58890','76585','76289','80053','86400',
                          '94009','77310','91121','77707','78361',
                          '74360','97636','38248','34963','16365',
                          '88850','11214','92132','65166','46291',
                          '79800','32837','95536','17038','93521',
                          '46148','23691','36151','27018','53818',
                          '60017','59320','11637','17580','14057',
                          '23912','75276','74375','84836','94885',
                          '15766','78741','88101','19008','22145',
                          '36933','10287','94561','17870','44811',
                          '81670','43342','17765','15490','25805',
                          '98076','65278','16260','66634','30441',
                          '65662','19226','20122','31004','10094',
                          '19918','41071','47588','94772','40815',
                          '48146','13307','62822','56607','65417',
                          '25429','59780','29623','10031','52751',
                          '14984','58849','37469','97117','69922',
                          '74203','29207','82247','48794','49515',
                          '88421','76910','54623','92266','47829',
                          '67029','48251','67323','15248','20877',
                          '61821','48345','91692','62397','74978',
                          '62731','83226','97294','33627','35812',
                          '30838','52819','89707','80761','47732',
                          '70638','62423','78832','40472','56578',
                          '61384','28517','52894','86897','58855',
                          '25553','14080','74677','91893','50679',
                          '29309','66963','93966','63584','51675',
                          '99064','42635','74731','62979','64151',
                          '82683','62146','84886','90380','30952',
                          '26400','28725','84143','66024','96780',
                          '37342','73458','42217','34926','66324',
                          '56707','12968','59052','60966','93250',
                          '74817','23800','30384','36561','95080',
                          '10584','20335','50792','10936','46096',
                          '81393','49350','32360','52687','25682',
                          '23280','22413','94886','15622','76758',
                          '53071','81377','13843','19353','42613',
                          '15006','18184','46861','15573','41254',
                          '82405','62486','25786','35730','45412',
                          '92858','29500','84395','75245','20622',
                          '18035','12889','18348','56822','85213',
                          '96546','86839','27402','42448','73214',
                          '70347','43853','58970','66907','31566',
                          '51876','90899','22616','30932','54469',
                          '83684','48970','16902','22935','50254',
                          '32611','34850','32935','89693','98765',
                          '39846','47550','25339','13020','44614',
                          '63003','43225','84945','11242','12801',
                          '42851','43798','69952','80451','95733',
                          '70901','38372','45904','65962','50382',
                          '85144','29696','32528','82123','53658',
                          '34004','80311','50573','42931','13634',
                          '25807','85505','74293','40267','37143',
                          '26220','54515','41131','37060','15415',
                          '61752','47484','27893','22309','33737',
                          '19546','67824','41836','22101','65843',
                          '49878','40497','38538','89201','99780',
                          '68662','35209','71937','35493','27932',
                          '62206','40692','80142','31868','17033',
                          '60508','10192','62573','25629','98106',
                          '54595','39827','88627','63982')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


