
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '37958','92098','31128','48578','47773','77708',
                          '43328','32616','35021','51719','69449',
                          '98895','74070','97726','95970','78888',
                          '79978','97337','71169','92283','24416',
                          '19455','40793','34657','98176','34227',
                          '94786','83997','73394','67827','54926',
                          '66450','39878','69808','68059','65729',
                          '20839','27195','12574','61649','20036',
                          '37904','96786','58448','84867','56654',
                          '75727','53141','74324','71349','29392',
                          '42953','97138','95274','54920','41651',
                          '86186','80600','44359','57734','99454',
                          '48756','14891','46047','36215','64068',
                          '82711','93473','47141','17009','21008',
                          '36880','84814','56792','37202','54755',
                          '34423','61943','54124','73029','58484',
                          '98577','50622','36788','88260','51125',
                          '31192','35752','90072','24854','67818',
                          '50791','84534','85669','78014','24812',
                          '14826','75107','25035','87952','50555',
                          '74921','54692','64595','41149','43968',
                          '89377','85215','93295','93664','33655',
                          '35378','47712','89265','69981','71399',
                          '19620','99751','75058','64939','78628',
                          '53049','94344','47016','43791','59150',
                          '12528','69824','34755','55263','63628',
                          '19401','29826','35526','82886','36840',
                          '45155','27271','65322','74808','78309',
                          '40296','68712','34486','93459','51263',
                          '52889','27029','61462','43475','91425',
                          '48164','89383','23652','86712','63620',
                          '13838','53597','61139','78327','49669',
                          '29346','50255','85904','55359','47022',
                          '62142','91794','63429','30802','51782',
                          '49673','56910','78513','81663','67325',
                          '60740','60079','87928','22031','92605',
                          '38131','93224','93853','48345','51846',
                          '75153','17293','88698','81012','85860',
                          '17175','81076','64647','67180','97628',
                          '93044','64933','46533','91965','53662',
                          '76033','44812','59061','64967','49231',
                          '90109','45029','19363','75530','84551',
                          '62253','14461','11669','76283','27121',
                          '12229','41922','24754','16570','90506',
                          '70423','56906','63023','86302','60331',
                          '42919','98177','36943','74794','57209',
                          '52626','34039','35353','11695','54045',
                          '99662','42247','87634','93157','20807',
                          '30363','77206','71771','36569','22646',
                          '63960','34783','29601','64614','23623',
                          '68262','75203','93284','76112','37509',
                          '43336','40121','23541','14038','66444',
                          '69852','74560','16301','85160','44785',
                          '65974','62291','10565','28474','79255',
                          '67568','38418','70640','16141','48258',
                          '31676','68196','33416','99306','44892',
                          '97205','18178','74845','18830','33977',
                          '19702','38903','35634','73769','88930',
                          '46831','53244','33631','51107','95143',
                          '43790','71933','54880','60379','74147',
                          '74472','75980','49081','44052','94560',
                          '56714','99717','10189','34055','96051',
                          '27950','69322','29078','10823','62564',
                          '79874','14310','85004','11711','48132',
                          '42631','67847','56315','59753','10605',
                          '45468','63993','24938','30428','43274',
                          '96666','55910','83850','14544','59656',
                          '29503','39005','97520','72962','14202',
                          '36765','26916','90454','99928','96865',
                          '31787','26650','52355','70645','44507',
                          '16718','49213','50581','62368','84686',
                          '86369','26821','91990','63914','72317',
                          '99932','35908','36694','71767','50240',
                          '82917','11198','81234','35612','20452',
                          '33442','90263','99269','14550','99847',
                          '32337','19674','32071','32574','29771',
                          '48693','55006','64207','55083','45804',
                          '75782','94471','11850','63415','85032',
                          '40649','98049','17532','16550','61003',
                          '57775','27588','49507','74983')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


