
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '10772','67760','38948','56325','88168','99034',
                          '36285','55596','35319','87410','86897',
                          '40327','34603','50184','12967','91965',
                          '20573','35999','41501','64137','61960',
                          '73262','97480','85532','61490','22881',
                          '55428','92923','26337','77460','98928',
                          '94804','50901','78308','38360','86734',
                          '93861','44038','41591','83480','49996',
                          '65980','79003','96167','18911','96161',
                          '88255','85911','82923','48332','62626',
                          '91369','35591','24720','22919','52115',
                          '21941','74217','60833','95519','88622',
                          '18612','52842','61171','96774','60640',
                          '51309','97391','41849','13924','18031',
                          '61767','43545','51041','60055','83056',
                          '74383','27827','16125','49161','16129',
                          '12308','55425','36110','93333','90911',
                          '20221','29993','43416','17165','45246',
                          '18684','86538','61538','84420','15834',
                          '17871','15801','93592','60247','94595',
                          '67817','93834','79569','73261','87516',
                          '80227','72151','81289','11821','41357',
                          '13240','46472','61412','22853','35909',
                          '26913','51529','64463','69393','57208',
                          '26899','84427','32595','62420','76733',
                          '67357','11174','78756','14750','64585',
                          '65204','31206','20049','66487','81849',
                          '82263','55934','89290','57620','69571',
                          '22158','61154','19890','74583','39931',
                          '90700','13503','21197','48560','61100',
                          '44602','72648','55848','78027','85262',
                          '60454','20506','57957','84524','90107',
                          '60661','20446','12833','45135','95442',
                          '62000','31214','86495','81077','36642',
                          '82557','72750','23404','77233','52539',
                          '66928','59343','13376','91368','62362',
                          '83166','39900','37161','64982','53433',
                          '75413','48085','44481','97444','11462',
                          '55292','71628','60678','34304','29339',
                          '29101','50789','11659','56805','82896',
                          '48609','70658','64797','49704','30709',
                          '70502','68265','75252','52921','76068',
                          '81186','49374','61939','87226','71004',
                          '64531','82881','73551','70625','16060',
                          '35612','98725','88126','36978','62386',
                          '99029','33646','24079','18333','81080',
                          '72300','63849','63276','71896','29646',
                          '11273','97493','23066','31525','89205',
                          '40383','42889','82164','65492','63375',
                          '66535','32597','72652','84483','74149',
                          '68828','42735','63992','25653','40248',
                          '97367','12873','71270','23519','56026',
                          '48452','98308','75135','97812','15670',
                          '13414','47037','53361','17884','16158',
                          '94525','24357','31432','48132','50138',
                          '66268','39701','90913','18907','91628',
                          '10868','98172','62521','46147','18572',
                          '63056','23666','58373','72837','47255',
                          '40490','86396','91209','23970','69242',
                          '83132','42587','78822','42168','11857',
                          '50309','45379','14315','50349','45720',
                          '50612','80732','68133','53738','81946',
                          '63735','64971','69290','86999','85939',
                          '97696','39155','29176','89186','21472',
                          '37668','93325','13099','84607','16649',
                          '91185','44788','84259','84707','18092',
                          '31997','18743','52239','28123','60047',
                          '47020','71374','99040','63080','49808',
                          '70130','94048','75199','83689','74032',
                          '76309','96865','87868','14013','11655',
                          '84787','65545','92361','77073','21910',
                          '12704','95051','66944','26777','87056',
                          '96489','50917','90117','14195','51212',
                          '61191','26464','74254','63358','40036',
                          '21995','91635','90468','27525','41141',
                          '59243','90827','48500','20162','67288',
                          '19617','65436','41782','79778','93624',
                          '85280','42981','16819','46105','11847',
                          '64850','77578','50271','11442','67636',
                          '52252','82220','17718','47675')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


