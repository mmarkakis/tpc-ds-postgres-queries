
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '74458','38547','83991','35158','98346','86567',
                          '95940','48015','65497','74345','33345',
                          '86177','48131','74709','80936','61122',
                          '97114','65201','94534','91397','82038',
                          '41167','49263','38220','40788','56807',
                          '78237','14418','31245','20540','73343',
                          '54335','30013','43276','81324','20740',
                          '97522','35624','28300','20280','35295',
                          '34123','61470','99293','10119','33951',
                          '22116','39837','89653','58557','23569',
                          '51675','36068','20471','36831','83970',
                          '11602','76587','99700','57328','84520',
                          '51947','89564','55233','50167','39692',
                          '40406','30772','79234','62522','14568',
                          '14984','42697','89300','66461','95655',
                          '23661','11607','48858','82713','53971',
                          '15161','39380','87264','35702','77841',
                          '60071','43399','46943','29124','78892',
                          '16185','84450','84989','15512','39014',
                          '95851','69877','74870','48837','14639',
                          '15506','74912','47628','73795','36439',
                          '82985','34244','22914','67936','71166',
                          '91470','97082','78595','60010','58560',
                          '79363','75609','81338','72386','95754',
                          '72034','38582','91417','63496','85491',
                          '82870','53864','71009','99661','71721',
                          '60744','11782','97284','97018','65410',
                          '36153','35547','83653','16173','70313',
                          '69301','58160','11674','50740','56034',
                          '45245','40881','65315','69553','68518',
                          '38735','98699','39662','64957','43632',
                          '46893','23111','37584','55544','57731',
                          '28466','94167','48235','96850','35709',
                          '50295','35779','92759','36220','10929',
                          '45568','48480','12442','97764','62275',
                          '81931','39700','95911','26491','26057',
                          '63365','19449','62103','69782','75883',
                          '75465','91947','32803','55476','94382',
                          '50701','47466','90799','25375','33072',
                          '18406','85076','87693','35521','18232',
                          '88671','21041','22508','24565','38287',
                          '93972','75984','42013','74978','13052',
                          '80384','27321','45683','96389','67520',
                          '53339','17480','94073','31510','88412',
                          '39062','29153','98739','14426','98029',
                          '74721','58773','83832','37800','77548',
                          '70079','22834','25086','10937','22241',
                          '30125','24649','40251','33726','36189',
                          '84312','44772','60950','52049','45984',
                          '47840','15895','42867','91507','33380',
                          '15084','81023','77908','11550','16099',
                          '11194','25147','84137','78071','22152',
                          '20526','38992','76323','80840','43174',
                          '75215','37338','52466','68837','49539',
                          '99776','77474','84735','15334','57336',
                          '63458','41690','16634','69786','56108',
                          '61508','19498','28390','41043','14990',
                          '33260','37911','78307','38863','89370',
                          '61579','58106','61477','74435','90653',
                          '20546','51435','55324','72105','27509',
                          '48715','74452','24592','25394','84190',
                          '89150','60777','54635','96430','97511',
                          '82928','80532','64864','49218','55560',
                          '70872','81308','73600','14690','31048',
                          '89183','56896','62917','32618','38873',
                          '58137','67022','83954','29053','14615',
                          '95059','89363','62029','86571','16100',
                          '83984','97797','52752','27394','66882',
                          '83285','23264','58081','84485','77327',
                          '41891','20017','54218','65401','57481',
                          '65608','78062','93896','30175','32482',
                          '91595','26583','31897','41393','72730',
                          '32405','10074','37308','32264','81512',
                          '32124','95025','95573','15144','50521',
                          '22150','55859','78170','85435','22223',
                          '86977','59989','67740','11052','97042',
                          '55932','82574','85138','66142','89914',
                          '43778','15889','44542','80620','91475',
                          '49965','95040','48981','23654','47929',
                          '92310','28545','98603','47265')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


