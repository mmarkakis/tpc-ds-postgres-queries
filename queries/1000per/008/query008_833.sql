
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '83331','88810','20070','78312','88004','79503',
                          '32044','80212','41155','83774','80116',
                          '65077','13994','96545','83833','30002',
                          '19867','30429','58186','41397','48050',
                          '98359','36244','88946','53595','34155',
                          '48872','96547','86862','73314','87492',
                          '50162','80388','86518','86737','12366',
                          '60770','72444','82735','43641','47694',
                          '55133','73675','39668','99276','94016',
                          '12932','36357','73764','11753','26942',
                          '29385','46366','91160','65233','52295',
                          '81485','33367','62029','20649','32170',
                          '82185','12602','57834','43467','52591',
                          '76016','85448','61695','80849','47095',
                          '36164','58098','28130','48762','29362',
                          '31668','47898','62932','17119','45809',
                          '84482','87675','41973','23453','88710',
                          '89076','96881','45849','39896','87852',
                          '45950','67150','77452','27001','66743',
                          '53193','60702','69984','84535','42750',
                          '54850','39350','75544','64442','70955',
                          '19989','30975','48387','52793','77821',
                          '27683','56766','23057','53856','12096',
                          '29228','12589','83425','93267','40769',
                          '95981','35511','11812','51838','53688',
                          '71114','36037','52136','38524','96651',
                          '36486','59274','45712','46458','69993',
                          '76486','34514','39395','22745','31838',
                          '24259','97062','62316','25134','69906',
                          '14482','79885','24759','54018','63590',
                          '42275','36639','44535','50817','16976',
                          '20119','18420','33438','60049','20424',
                          '68259','17568','63948','53075','17177',
                          '80486','54313','83407','13907','40491',
                          '96088','91689','79550','72709','22194',
                          '60270','23784','94870','47919','53548',
                          '73461','78857','58374','55929','35811',
                          '99180','73067','55109','24315','19912',
                          '47727','71109','45434','48965','29837',
                          '38829','46776','51649','48321','26808',
                          '58133','91157','85220','11969','83959',
                          '56903','21903','79316','44730','23010',
                          '85444','48680','24036','40019','78169',
                          '36539','30480','79588','29852','15468',
                          '21536','97106','62176','26685','35690',
                          '29166','22940','66011','57945','25907',
                          '40542','79943','79532','95112','73584',
                          '60621','43735','66615','52489','11607',
                          '44056','28153','59082','45797','75374',
                          '59253','91276','56182','47701','69287',
                          '37032','12842','86996','84010','33751',
                          '48769','79176','44613','69015','12275',
                          '25589','69875','89029','85893','53903',
                          '93827','50454','52333','19705','23095',
                          '46436','27276','24583','96010','32979',
                          '43513','95435','85364','29420','95522',
                          '43425','10172','94358','85372','19783',
                          '63167','18193','50146','75913','87137',
                          '37278','56120','18378','54437','84655',
                          '58888','24571','48774','92398','89400',
                          '59068','21481','80610','29041','38719',
                          '78166','65304','67453','64610','37708',
                          '28917','67200','45063','79229','16209',
                          '95927','88882','60948','52470','93955',
                          '34753','86754','14747','70558','85253',
                          '54082','92370','86083','86596','13428',
                          '10318','39145','73371','89584','21954',
                          '42639','92699','33884','89249','95555',
                          '85906','72838','65413','34142','55784',
                          '72945','38269','92818','59754','80667',
                          '90617','75117','19385','95026','58261',
                          '71016','21991','23379','35180','96368',
                          '74980','90488','81891','60223','22177',
                          '22885','31231','77533','78067','10033',
                          '88610','60709','92686','79549','33494',
                          '52791','58491','58740','99620','71712',
                          '33563','35461','59084','70506','46727',
                          '13818','65751','12299','16567','65624',
                          '68016','58902','32673','44355','66556',
                          '57470','48689','18793','56454')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


