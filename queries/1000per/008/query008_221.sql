
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '89400','24091','40276','64175','59340','44605',
                          '98579','31209','17643','16285','44242',
                          '68611','13533','98520','56298','51970',
                          '35953','72997','47740','84841','49201',
                          '80218','64837','42280','82170','76377',
                          '73903','37657','78928','22588','33747',
                          '40557','77033','45134','65706','38258',
                          '61037','19297','24125','69018','61006',
                          '93758','42214','46868','54610','19519',
                          '96724','73446','33058','57963','81984',
                          '55561','14392','99954','68974','80509',
                          '33898','70229','31762','46329','38370',
                          '10154','17215','24586','77263','78188',
                          '18018','95690','24329','37678','87059',
                          '80508','83306','15005','95898','55167',
                          '96922','19393','74104','75170','81236',
                          '47730','83565','75506','15311','13780',
                          '38304','31239','35385','49581','35484',
                          '67395','99726','79752','61846','30020',
                          '49549','31954','62031','45144','20097',
                          '43017','18914','61059','35507','65925',
                          '28509','31533','90771','10292','43079',
                          '56302','31107','75974','56433','54787',
                          '91029','76896','81088','47250','27192',
                          '45734','84304','97146','28091','59141',
                          '91758','83811','30330','72983','38979',
                          '12585','92831','97236','84047','11800',
                          '97658','71606','40939','85666','27061',
                          '95341','28543','19862','70141','24504',
                          '79782','47509','93449','60348','22426',
                          '20171','57093','32134','57600','52990',
                          '53088','20709','24421','21475','40472',
                          '87343','66273','81177','47225','23014',
                          '37772','30314','45961','32271','69262',
                          '66877','56646','54031','57440','21771',
                          '53210','18212','71628','91149','92743',
                          '21345','45762','86035','17847','64325',
                          '45398','92777','15001','64449','26741',
                          '77865','61383','69620','49391','39999',
                          '87273','31795','45078','41577','42629',
                          '97538','65834','96800','22736','69553',
                          '39545','74043','12155','86413','64047',
                          '33389','34036','33286','81954','41203',
                          '63557','57674','24314','29637','12278',
                          '11547','89913','62197','48972','72497',
                          '17421','93671','15254','51644','32063',
                          '59045','81925','77905','33749','75361',
                          '28612','35448','84759','31892','41453',
                          '10166','78199','84330','32584','77636',
                          '44628','60477','34603','33268','41493',
                          '43480','98791','52615','29026','39979',
                          '89734','96473','31622','27393','30955',
                          '58355','68353','60319','96201','47543',
                          '78931','33560','62674','83714','39385',
                          '61964','56514','42967','31997','40109',
                          '39603','69156','15695','34253','30187',
                          '98607','76878','21323','21309','36452',
                          '83891','55326','82482','27271','74921',
                          '26443','67470','37721','61536','37452',
                          '86221','92173','37253','58071','29582',
                          '15338','56594','88238','25477','16705',
                          '87623','47288','73362','64061','86539',
                          '30728','57420','45978','96132','11727',
                          '70566','35531','94905','32988','34669',
                          '33565','31922','59361','84726','83872',
                          '44024','89494','63566','17001','31818',
                          '15744','55381','35752','52366','49936',
                          '29929','13060','76647','74611','94277',
                          '69235','68190','90725','59186','52404',
                          '62303','66446','58479','73561','25112',
                          '30208','47931','82042','37629','72463',
                          '74703','10831','79074','69101','37867',
                          '62474','26638','51705','85785','36518',
                          '91687','72669','29262','82644','45913',
                          '40088','44402','48106','28789','90066',
                          '29180','43314','68743','25434','71091',
                          '11113','20241','31761','62836','71604',
                          '49718','66445','48734','61962','24987',
                          '61688','96259','24794','86414','13935',
                          '52213','16246','50228','60809')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


