
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '63040','47500','94172','31193','35426','68676',
                          '64381','40279','91122','90375','16895',
                          '39702','97712','62630','12623','43357',
                          '54029','49203','92516','58048','67340',
                          '28430','95799','71485','83602','95899',
                          '80173','23288','70614','76187','35251',
                          '59311','31628','71932','73234','97489',
                          '78820','52641','46107','28551','64370',
                          '12761','73760','11425','22893','11344',
                          '43577','25879','31398','28998','74756',
                          '22568','88182','70665','74453','13355',
                          '85764','14825','62156','93503','11027',
                          '48867','54691','55726','66482','69586',
                          '31614','53039','20797','14078','14985',
                          '80734','51303','57916','71765','47628',
                          '49112','11541','29978','12690','22700',
                          '49329','16787','64761','42035','19206',
                          '77785','31370','88571','54050','61118',
                          '44092','82659','14130','29285','49445',
                          '79750','99864','90746','79522','18469',
                          '92032','24168','22298','47772','33924',
                          '49423','10791','90106','47531','11564',
                          '19986','79572','25663','70565','76869',
                          '59901','12409','99958','67819','69606',
                          '69972','94135','71277','87435','49060',
                          '34694','59812','28932','25232','28308',
                          '47499','75720','94295','84982','70543',
                          '78678','45342','18974','23438','63454',
                          '81916','49093','20175','20711','69210',
                          '20677','69189','69762','62951','34031',
                          '26995','27125','60263','75750','33045',
                          '75173','25231','61285','29499','96731',
                          '10396','25500','53660','22292','84717',
                          '30455','13351','78691','12351','39547',
                          '52484','69892','70301','91484','81897',
                          '28242','98238','99157','59389','73525',
                          '31941','40702','55009','46429','43762',
                          '73725','71858','19740','61467','77905',
                          '27315','81746','97007','59426','74882',
                          '46816','75717','55535','99670','96402',
                          '18129','77363','34929','60432','34265',
                          '84786','17713','14964','87329','66436',
                          '81125','95574','63958','63945','67927',
                          '35712','79457','16829','61720','37649',
                          '12978','21956','55228','92748','35374',
                          '94564','60880','52743','98844','20236',
                          '78134','38959','43248','24593','12518',
                          '75477','57940','92433','18554','24969',
                          '42147','12151','76849','14445','14557',
                          '77078','24248','45298','81761','94702',
                          '96741','16840','23232','37555','99702',
                          '20465','89680','47872','50924','68442',
                          '79161','84494','68458','57932','40476',
                          '53955','37876','32440','43128','17751',
                          '98176','52479','11546','48049','12347',
                          '14886','25347','27122','87441','92073',
                          '79775','67812','89788','56407','27065',
                          '59865','20097','12022','37689','64792',
                          '53204','53126','98601','90711','58451',
                          '47090','25331','62923','32844','95125',
                          '62981','14375','45593','99500','53752',
                          '90982','48373','46999','31300','79889',
                          '45754','27278','96843','86384','81987',
                          '89589','95028','25596','43562','15782',
                          '51112','86770','74301','77588','99338',
                          '20588','37517','10657','80602','68857',
                          '41392','24036','49782','67282','57669',
                          '51716','20475','89775','78212','95547',
                          '80537','44134','67524','67331','69826',
                          '65933','38750','63257','54010','42063',
                          '79030','64215','99589','57464','92397',
                          '70770','11304','64264','19255','76397',
                          '58801','60068','97451','69579','26511',
                          '20117','35666','70660','53550','32114',
                          '45006','53494','49799','60957','99099',
                          '78892','58419','53504','78901','95128',
                          '41867','22508','64276','90669','54454',
                          '12784','84963','44154','19686','42799',
                          '42187','84154','60028','58264','33573',
                          '76315','95378','56512','28423')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


