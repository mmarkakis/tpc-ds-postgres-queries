
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '71700','75674','78217','75832','23283','89950',
                          '22414','25052','40201','55272','63273',
                          '85410','83491','41612','46629','74021',
                          '19095','83107','44601','34414','87929',
                          '28397','13932','90646','23752','94917',
                          '68109','79208','94970','23796','65403',
                          '32732','45771','16277','10751','81903',
                          '80965','37487','97296','62032','97453',
                          '64298','88997','97895','95549','63271',
                          '95991','50143','39062','46007','40083',
                          '93686','87734','90955','17699','70482',
                          '89960','99172','36743','24916','64704',
                          '74933','38372','44348','25149','57475',
                          '39429','32275','88582','25132','74185',
                          '31191','63280','99973','74541','45845',
                          '96179','15408','21444','71691','58569',
                          '11021','80538','57845','86252','10593',
                          '46067','53593','31252','86639','52480',
                          '20975','98609','38305','26511','61078',
                          '90850','49794','84713','58269','73747',
                          '15888','98689','33876','31993','54344',
                          '68135','31429','53172','87565','92037',
                          '93902','65135','76749','28219','93156',
                          '19382','54875','20980','83157','25761',
                          '39485','79964','10201','60646','18532',
                          '24721','77063','49393','25486','45075',
                          '84969','76004','43271','17413','57775',
                          '36054','75985','95174','65518','66870',
                          '97119','93887','58624','56393','75936',
                          '81770','32306','81039','49885','85478',
                          '36168','56895','62311','94840','79896',
                          '98618','17067','58987','72958','94828',
                          '39635','80713','51442','59455','91459',
                          '45344','38638','84484','15993','72507',
                          '37429','91894','50686','66277','47534',
                          '91438','51389','16701','28446','85221',
                          '38567','25630','96724','94617','79854',
                          '37720','14054','91190','76836','96016',
                          '98121','12542','96481','10392','41707',
                          '74950','95715','82876','30454','64812',
                          '36088','29381','36302','30982','35422',
                          '16520','16990','33550','19062','81833',
                          '50475','88976','28390','32793','78450',
                          '50016','63369','97065','97741','25635',
                          '81216','44173','74581','88195','82668',
                          '19641','54660','23246','30456','15696',
                          '32111','53950','40578','79188','63300',
                          '14207','88553','80863','24487','47049',
                          '10889','73306','73716','86003','55907',
                          '65907','81538','63905','18622','72038',
                          '73005','66331','25209','28201','33210',
                          '22375','24793','22570','53753','10000',
                          '95844','48465','34265','20281','98011',
                          '56811','44259','98727','37601','52964',
                          '44285','66579','59540','40233','92411',
                          '13555','18005','80646','79836','42923',
                          '74385','14898','31601','64873','76531',
                          '77428','59505','60487','28656','57759',
                          '70498','81018','89415','73874','51447',
                          '62158','78788','36706','60736','87675',
                          '38670','98342','39683','65321','54235',
                          '82830','96673','99495','71582','59488',
                          '16634','91398','16475','76711','71433',
                          '79158','98269','99323','28015','97860',
                          '56162','96100','63543','66043','96345',
                          '25617','19866','55280','51180','29576',
                          '82163','41342','60065','63730','27226',
                          '81413','91712','35947','80740','65914',
                          '36413','59882','18262','28931','18575',
                          '80248','56941','47127','11903','53091',
                          '12186','46293','81853','96865','93146',
                          '68520','21486','16593','26769','16024',
                          '33116','50598','13031','79402','51723',
                          '21696','87086','50856','23757','22739',
                          '50943','96945','80118','26074','20064',
                          '66626','45513','73408','73273','53824',
                          '72605','23401','54586','59863','26002',
                          '18938','72479','43780','15100','45773',
                          '79226','78094','88956','28643','17661',
                          '36423','93162','26687','92368')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


