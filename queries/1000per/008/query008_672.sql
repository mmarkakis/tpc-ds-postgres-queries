
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '23221','22697','92897','24984','38426','10692',
                          '62529','34382','43437','96816','86727',
                          '36978','57712','82628','79173','99709',
                          '53390','52570','53993','43778','61047',
                          '84450','42671','12443','27442','12937',
                          '12064','26856','35269','71823','87145',
                          '10843','98935','56122','20073','87741',
                          '29609','26091','28523','43786','62462',
                          '98351','93594','72892','96426','42650',
                          '51705','64040','41575','95219','46993',
                          '17038','25023','44521','13461','40949',
                          '91143','23771','77539','61017','66939',
                          '90424','99634','55099','31275','23789',
                          '87371','44847','69815','96601','89773',
                          '59477','56871','69738','96904','51906',
                          '19487','10170','67528','26962','19011',
                          '23827','96045','40538','19193','74681',
                          '28438','68189','77671','25874','37768',
                          '98266','18689','88841','41241','99293',
                          '41813','81079','11369','96120','99071',
                          '67351','54987','14601','29800','49955',
                          '40728','18834','86265','88039','67248',
                          '73688','87864','12907','88921','21559',
                          '84287','65767','76362','26037','98113',
                          '60904','49283','95712','66438','36805',
                          '40417','46897','31028','49277','63556',
                          '82742','47758','45268','75149','43777',
                          '32774','33869','10031','65738','13494',
                          '46356','41730','40021','12985','70033',
                          '79935','10362','47278','75446','13848',
                          '74759','67885','85151','83279','89615',
                          '63459','14382','86936','59542','54256',
                          '85644','14425','72329','66612','27593',
                          '72384','27123','82828','28187','56010',
                          '85592','64460','25651','18709','84245',
                          '70871','43538','69561','28998','38694',
                          '83737','93781','63085','85517','32292',
                          '98001','26957','41391','55374','12261',
                          '73374','14654','34513','77253','23189',
                          '14221','34037','54464','22598','92723',
                          '65984','94295','98298','46206','28773',
                          '21557','98579','89460','94586','29995',
                          '12253','33977','55903','48269','50315',
                          '67975','83874','69273','23129','21837',
                          '65687','93008','70317','52710','67117',
                          '20071','75104','57618','78876','70610',
                          '20323','55945','25493','84897','91227',
                          '27127','91722','93231','58173','78405',
                          '51484','22794','95962','63412','56921',
                          '76615','83009','30625','10968','16166',
                          '82625','30446','75036','25049','40833',
                          '67963','92928','83948','87092','80729',
                          '87772','38808','48043','73239','73550',
                          '22461','39326','55052','53226','61007',
                          '84214','37659','62148','71238','31262',
                          '49121','38353','75177','46325','17188',
                          '19968','30346','74001','27585','53159',
                          '16630','22867','78429','31123','82485',
                          '58486','86797','38765','44306','32395',
                          '95348','92116','87909','86556','92079',
                          '39511','57829','99282','79171','71712',
                          '77733','46175','69093','96022','27147',
                          '98342','69217','76991','58091','50537',
                          '24572','71580','35358','44820','16900',
                          '23844','72875','40588','53059','96511',
                          '59909','43185','48087','22643','94473',
                          '18862','49435','63632','38129','50301',
                          '47895','88080','79560','73236','88978',
                          '52683','32939','56684','26544','82645',
                          '32064','91999','48784','50632','63587',
                          '10368','20402','42848','32013','77052',
                          '25659','15691','25411','71411','84260',
                          '73691','23848','71177','70780','15600',
                          '62276','89820','32098','29702','93588',
                          '19118','47445','98094','50475','73915',
                          '31050','67939','33570','93081','16551',
                          '36360','35157','82871','30829','94823',
                          '11047','44709','71978','70819','79756',
                          '74083','90188','39092','97748','84071',
                          '49037','68760','93132','37789')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


