
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '39813','52010','86263','73471','32592','23484',
                          '56351','46348','82189','40057','10290',
                          '23225','91699','75348','86189','92898',
                          '42945','13078','40663','52246','67764',
                          '38843','51089','16882','61077','80424',
                          '91925','40997','12677','44712','39329',
                          '24013','55327','42147','99450','92121',
                          '13713','93856','84343','75855','33695',
                          '49410','15739','59523','70049','82356',
                          '92713','45058','68321','76347','13698',
                          '54720','48676','89239','46022','14005',
                          '90921','29856','18481','35942','23379',
                          '36802','43634','13026','64191','14011',
                          '70993','82777','40002','14042','52624',
                          '69022','67267','58601','75718','70133',
                          '30204','18182','26340','39224','95699',
                          '92650','67141','39506','82203','60903',
                          '51395','34580','57707','78677','65470',
                          '69415','80289','40160','30161','93615',
                          '12085','38958','96807','92546','36510',
                          '66659','92693','19107','14302','21316',
                          '57484','59325','28313','66394','15406',
                          '51981','40674','53269','66987','97421',
                          '47346','68710','73053','24069','95641',
                          '12379','84173','97343','91399','63642',
                          '40257','41643','79961','47568','57834',
                          '28424','51653','33075','82653','11543',
                          '93802','94704','19286','34246','54426',
                          '75102','58678','60663','29556','73407',
                          '58455','13805','18915','45189','21599',
                          '45144','68969','64916','90657','92069',
                          '89619','98571','63388','44897','54131',
                          '15497','86246','22425','19682','12746',
                          '52836','23987','80347','18361','40118',
                          '39135','86462','20138','91550','57042',
                          '94459','55536','76060','40494','33658',
                          '56915','49570','25746','14086','83931',
                          '11215','75323','22410','15251','22839',
                          '87031','41924','45729','11110','36427',
                          '84683','32384','38065','38975','99358',
                          '11521','70021','41051','41077','78549',
                          '12722','26917','71995','74535','91579',
                          '96161','73805','92684','43165','90003',
                          '70378','39383','75612','35267','92643',
                          '21220','51774','81298','45148','30384',
                          '59063','31572','46592','40537','28693',
                          '73837','40672','56049','37142','61209',
                          '40551','18936','87200','41665','31504',
                          '13502','37613','38700','30052','86568',
                          '37104','42709','81523','98137','70846',
                          '33767','96391','67300','46264','96988',
                          '75487','57054','85310','79232','54663',
                          '58442','50053','20000','87643','52867',
                          '56716','74334','18390','71817','63832',
                          '69617','72226','10395','49265','50490',
                          '49630','40585','19131','77343','46135',
                          '11714','59077','12720','52476','36675',
                          '97020','67595','20483','93172','62918',
                          '94521','52730','84205','91025','68761',
                          '36563','11536','10929','70984','95593',
                          '94686','74942','96002','17384','18854',
                          '54918','72752','35578','18057','67742',
                          '77406','28257','48615','44995','21490',
                          '93241','95537','31676','90200','67983',
                          '47843','55095','68987','16357','25604',
                          '39105','25434','29292','47827','23460',
                          '98229','53421','77094','87524','94967',
                          '99021','82027','18704','64991','98020',
                          '24626','26938','92656','37908','95558',
                          '52179','58648','87176','34167','64042',
                          '78805','88032','69576','10279','96319',
                          '89486','57282','71297','81954','28888',
                          '16921','13507','77798','90895','18533',
                          '87448','59598','61771','80353','43000',
                          '10508','83822','56007','87764','33594',
                          '78860','69389','75730','18458','33979',
                          '90787','76394','88475','60958','34437',
                          '26508','44101','65151','12799','74822',
                          '65713','91156','73983','18689','70222',
                          '76386','45681','50796','42702')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


