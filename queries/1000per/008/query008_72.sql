
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '99022','39069','23524','10621','68047','11184',
                          '97398','24699','65308','83071','71135',
                          '46518','62452','66801','74520','70103',
                          '57812','43145','86505','88351','87550',
                          '66328','42075','87387','94577','43816',
                          '94867','15709','85433','42760','73324',
                          '29059','18463','13746','65334','11576',
                          '12905','14365','90702','16819','56955',
                          '11751','70664','27371','31804','69719',
                          '66959','19783','83861','95448','62156',
                          '38012','58442','25426','48923','38599',
                          '27960','30646','82766','24121','37811',
                          '40741','85489','81041','68208','71855',
                          '74377','71330','87982','45821','68391',
                          '81907','24633','31940','22202','88080',
                          '58227','85540','37207','43333','42661',
                          '50962','35258','89218','40387','89061',
                          '90945','69199','81180','87419','82561',
                          '71335','99791','56278','77870','54213',
                          '53724','63218','58194','36022','81683',
                          '98774','43306','48789','75413','36413',
                          '11542','52811','99518','17216','14586',
                          '68401','14685','84845','90865','71321',
                          '77644','66255','68187','97871','44315',
                          '73722','20095','83605','71538','43462',
                          '38985','61316','20346','56718','37431',
                          '33462','84107','98238','11714','84394',
                          '74042','35473','72990','72221','95829',
                          '31083','27884','54327','28649','18860',
                          '41752','79623','73761','76734','18378',
                          '17368','44146','16831','70836','82091',
                          '61304','14988','19293','34122','32718',
                          '22734','15416','79243','92655','21202',
                          '26066','41397','29623','23863','17876',
                          '79601','36334','60887','79622','19790',
                          '48554','53615','77941','56961','88932',
                          '82314','82608','82698','90227','61447',
                          '57700','16302','31499','77907','36712',
                          '34368','85261','81264','15269','90791',
                          '85971','95208','42382','64418','19403',
                          '92493','54992','32733','44596','98679',
                          '16301','63887','13979','69134','60156',
                          '26188','45021','88555','42326','81296',
                          '37712','19164','53135','95439','91573',
                          '38614','12748','96495','33673','59090',
                          '21501','81409','21710','16236','73843',
                          '96188','84177','48128','69130','71463',
                          '70340','11780','11659','79769','71255',
                          '20072','88758','71965','17315','27891',
                          '81937','67884','36644','75005','52436',
                          '66942','12193','78140','91804','11756',
                          '25767','98780','49091','78532','51206',
                          '66422','97020','71937','68540','69525',
                          '51811','70021','75418','75434','25053',
                          '29375','62828','28814','43405','14291',
                          '81891','18998','13994','66389','38335',
                          '47541','44562','75091','39832','37938',
                          '18481','17406','28410','73554','84669',
                          '16766','68219','53840','36527','70100',
                          '58400','29786','16697','56346','92810',
                          '54296','13166','96939','35305','81400',
                          '79116','30171','56991','28768','90785',
                          '94174','73307','28518','32567','26609',
                          '70532','61826','16675','54781','31862',
                          '98258','21425','84494','98029','81835',
                          '50189','69592','19269','76729','34200',
                          '89875','33369','86660','13205','92463',
                          '83709','82549','96542','90270','23618',
                          '18440','15814','44714','72346','29942',
                          '78288','90138','63476','73005','14413',
                          '97592','75394','79830','74840','91724',
                          '68977','30964','48919','28262','91121',
                          '72308','27109','53474','73919','58808',
                          '27808','15470','59988','81294','11640',
                          '76210','15195','89623','48830','83236',
                          '37280','45719','90536','62359','43287',
                          '84676','42920','17994','71087','78243',
                          '89939','55749','65279','73518','34608',
                          '34580','94143','63167','33769','34474',
                          '86290','22648','89471','27220')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


