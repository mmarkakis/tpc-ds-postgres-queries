
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '71513','56228','73677','90798','24959','93749',
                          '29531','14180','95639','10557','26810',
                          '12637','74130','50381','43739','39971',
                          '38045','66492','57167','73721','23468',
                          '82899','89610','23152','95283','25025',
                          '91459','15375','12091','34724','41169',
                          '40759','65852','35215','78729','85567',
                          '20546','39501','11984','49397','35997',
                          '94325','79044','15035','32551','54527',
                          '76569','85806','70121','66118','34666',
                          '86084','78113','99091','92977','60393',
                          '38528','95197','43450','35167','29628',
                          '10473','69581','28476','96138','44098',
                          '74030','83511','43088','98978','44142',
                          '31013','59679','78182','92463','82374',
                          '56597','49182','16326','87843','84859',
                          '10061','51872','92379','77786','93021',
                          '74797','23435','42859','58963','34800',
                          '69110','41910','91776','81778','94425',
                          '68752','49900','70280','24574','46224',
                          '63333','51623','59139','21658','36287',
                          '28447','97231','76323','22689','16870',
                          '14210','99106','21986','45518','95774',
                          '93971','52475','21335','63065','92505',
                          '86284','77695','68686','52730','85214',
                          '64184','20494','95918','22995','11639',
                          '13313','18941','54397','56214','93149',
                          '17612','51729','89167','89776','18350',
                          '34865','50957','78842','56293','46984',
                          '17246','13265','14741','90615','65022',
                          '38990','89286','35706','57887','62925',
                          '52895','81539','93052','18214','15156',
                          '31420','65978','46638','68935','65579',
                          '26194','38060','94074','56493','34811',
                          '78922','53453','83610','62869','29520',
                          '48584','26263','27008','73192','11401',
                          '73059','94007','53900','46290','22730',
                          '44534','83406','63232','64693','30030',
                          '20206','21923','57667','32031','15124',
                          '78659','63831','57690','64600','65604',
                          '88045','55571','88901','81251','68692',
                          '99509','93817','54857','81966','55645',
                          '52855','23828','21792','30674','13419',
                          '70870','37302','16837','97399','94168',
                          '23258','11604','86494','40809','42139',
                          '76128','79373','74332','48541','77993',
                          '63615','55785','83962','10951','42803',
                          '50124','23187','66931','27145','95384',
                          '50308','75177','41622','11711','79943',
                          '62697','91231','91219','63730','78046',
                          '89415','66552','66427','42678','45555',
                          '87631','62864','69384','75170','82696',
                          '69244','84079','83690','17511','24964',
                          '33957','28601','78824','27059','38781',
                          '83244','61513','98778','41785','18053',
                          '93001','31629','60184','23847','65887',
                          '87642','49561','15972','17171','42138',
                          '57670','86620','56279','88204','25657',
                          '11001','89401','83330','63713','39586',
                          '57617','61165','83490','69825','27584',
                          '41109','48841','82858','35441','71622',
                          '51081','78508','75120','88963','68799',
                          '27429','20381','57892','20237','47951',
                          '90819','71549','95578','11994','15374',
                          '58960','77836','68613','20472','27981',
                          '25331','28566','80621','28472','64713',
                          '18800','36096','84313','56815','19061',
                          '46983','50152','59392','79608','16662',
                          '99692','22855','33504','87571','63256',
                          '57162','82361','80959','62783','43660',
                          '45734','27858','15328','49101','68731',
                          '50670','70201','54904','63519','11723',
                          '83753','12151','48799','21706','34563',
                          '54962','72787','16924','31305','86471',
                          '37864','39533','84723','94560','13589',
                          '89594','35469','10267','17749','46302',
                          '28693','19984','98333','48382','95290',
                          '82012','51789','20912','29162','21257',
                          '82535','94824','87353','40204','64447',
                          '32681','19386','43443','33459')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


