
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '64632','76324','18286','18536','81565','46269',
                          '61435','95284','17786','60139','40650',
                          '44587','44138','17608','14506','25933',
                          '84285','26768','33423','74612','54075',
                          '55764','96127','94485','93329','10019',
                          '27295','33610','36823','23456','18148',
                          '68208','20684','70998','18407','83460',
                          '95382','71285','30669','35274','26313',
                          '72158','72419','30880','46229','90094',
                          '31940','54256','25000','38782','35417',
                          '86018','42313','91566','44659','89955',
                          '12517','77264','55072','48072','11835',
                          '57518','29989','89658','78136','95987',
                          '56966','85286','57452','95988','78441',
                          '14788','13016','17201','38531','36794',
                          '89216','18741','82717','43015','46146',
                          '30390','67371','88613','90922','25891',
                          '77218','71393','67139','99346','20093',
                          '40142','38163','57230','88366','77760',
                          '94400','85746','97795','96314','96815',
                          '21531','40777','24578','34951','60282',
                          '39338','95921','62567','41050','69796',
                          '75805','31128','69497','36300','93299',
                          '24166','11673','64784','17162','62497',
                          '68918','81647','87431','62172','11717',
                          '83124','98758','56020','13324','76478',
                          '62345','75353','81753','34866','22474',
                          '92209','74774','23084','56200','90453',
                          '63322','28852','98284','67328','82298',
                          '20888','44665','43722','95030','57279',
                          '29248','70949','42682','85984','54598',
                          '60331','24135','20495','68826','17246',
                          '28340','99079','37144','88274','29957',
                          '81068','50282','81438','43765','43979',
                          '70688','39759','59096','70051','28036',
                          '41373','56068','33993','90316','22341',
                          '87852','60917','65315','49670','86617',
                          '26183','43490','60691','15107','25294',
                          '32672','12549','69938','95831','85375',
                          '29549','48577','99391','13005','42614',
                          '95038','68556','59696','56013','24379',
                          '58561','32381','22189','19540','99855',
                          '81614','73535','94022','55109','76250',
                          '39129','56672','13849','73050','24100',
                          '28603','93903','32112','21102','69309',
                          '81967','40456','84822','77365','12145',
                          '81255','51030','76018','72050','41477',
                          '88529','50840','77804','79843','30024',
                          '42072','19703','31910','49885','80348',
                          '15208','20426','22103','21984','98881',
                          '12550','55279','24620','35175','18848',
                          '57161','26981','14321','34051','11184',
                          '38276','41679','72285','92076','30737',
                          '58110','82369','62632','61511','20340',
                          '15693','77425','75653','40695','17200',
                          '26450','19060','36182','59200','13581',
                          '21569','84665','62953','23056','72228',
                          '63105','28139','81493','96175','11564',
                          '70480','30540','95952','64648','95228',
                          '11972','95543','17428','22812','37179',
                          '86970','31222','29302','38950','32755',
                          '87640','22607','83336','54115','75801',
                          '41641','66847','49934','86910','81556',
                          '43667','30715','77515','87890','16921',
                          '72153','64585','63984','19055','22179',
                          '78116','93265','28231','36470','21243',
                          '81264','53834','21285','56650','44448',
                          '40856','89623','48679','22027','22759',
                          '12776','38966','16541','27438','58869',
                          '92791','68087','62493','44685','27425',
                          '95395','24708','80853','49869','56152',
                          '80401','87676','17724','61002','40469',
                          '31699','21289','44797','85453','60006',
                          '72755','19065','83420','17928','44601',
                          '89332','41036','65016','67296','58879',
                          '10670','30318','91765','23903','46447',
                          '41828','19010','95082','86044','97693',
                          '94384','17316','53998','46897','38358',
                          '71977','38057','59723','51438','46636',
                          '94625','32481','32258','79746')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


