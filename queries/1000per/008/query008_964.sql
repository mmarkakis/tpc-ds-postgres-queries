
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '69772','48070','71924','43975','76544','13660',
                          '40910','54605','66297','59470','63755',
                          '13931','40280','42767','25155','33692',
                          '77018','72558','81491','38574','61868',
                          '71169','70358','61491','85980','80917',
                          '49644','52309','16381','45764','68802',
                          '99596','41647','56701','51038','96529',
                          '91262','78978','50213','90673','75924',
                          '16131','12500','60865','86661','62960',
                          '17991','33182','38486','78875','39199',
                          '14972','28432','87351','58742','26034',
                          '73968','12729','12823','70015','70659',
                          '32067','40431','32049','53636','59536',
                          '63495','10782','82268','59623','14299',
                          '77066','27707','95255','77602','73108',
                          '34837','91938','92506','69204','18565',
                          '93090','53657','20341','68790','19204',
                          '67492','19242','52714','14757','13112',
                          '43205','64095','39758','46229','35277',
                          '90325','86978','21484','73805','77516',
                          '79393','64486','37657','20938','13588',
                          '48145','13244','13706','46352','62104',
                          '51728','51827','15028','14414','27373',
                          '99511','98556','47419','27413','90401',
                          '62850','76332','34333','99533','41798',
                          '21070','64638','37780','59958','67921',
                          '63724','29309','96136','23600','90099',
                          '23070','71817','75535','31077','92258',
                          '30686','41879','81841','42523','35012',
                          '51578','62510','60790','36361','42738',
                          '12940','88043','51713','29345','20955',
                          '33154','63462','57431','38324','94658',
                          '52547','96285','30383','55798','98488',
                          '25279','24446','83225','89945','18430',
                          '92585','56553','20776','99372','24755',
                          '22593','19806','72510','34507','60089',
                          '81037','27428','59700','24093','54920',
                          '23309','76614','92831','38323','69069',
                          '27753','89391','82682','75488','42637',
                          '82163','90694','72228','90070','64469',
                          '65456','60717','90303','30121','25257',
                          '31645','52087','75238','99386','25058',
                          '78465','29951','45414','64544','53653',
                          '37860','24644','69965','12952','90713',
                          '13116','24273','95238','21832','26523',
                          '96138','89779','85164','99616','36463',
                          '18232','47042','59677','79685','22470',
                          '65174','68821','72449','73664','29766',
                          '57820','67981','36466','26237','20575',
                          '54879','18621','37669','59104','67255',
                          '93061','96178','74652','48409','63560',
                          '39389','79262','82631','74043','38832',
                          '40709','36770','83392','72789','31053',
                          '99578','65222','30781','40517','12188',
                          '39883','39028','16566','18029','57974',
                          '13666','95965','59773','58693','43052',
                          '99565','52542','85586','31081','64410',
                          '49805','74651','56700','18362','27368',
                          '30538','62192','43880','92243','12888',
                          '92471','19223','35869','52438','81514',
                          '18427','87507','80082','57616','18146',
                          '24776','59532','19566','77721','42170',
                          '76889','35631','40090','54737','11671',
                          '51066','92944','12800','42259','52440',
                          '96581','19123','55640','40072','64171',
                          '50688','12428','36438','72451','17768',
                          '87001','25811','30688','95075','55273',
                          '33699','42760','22879','25754','22132',
                          '79813','90836','89216','17824','83461',
                          '27342','71887','88800','59581','96297',
                          '40570','39211','14048','70847','66326',
                          '63192','17501','18255','94364','80170',
                          '48049','56066','95489','91470','57825',
                          '74731','29455','16773','46127','19940',
                          '79955','59413','29473','68897','35084',
                          '78754','33643','95760','63635','78841',
                          '74244','73899','69681','26786','96344',
                          '51289','85645','95921','44238','99274',
                          '32742','85892','82931','18384','75246',
                          '53175','66988','10951','73304')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


