
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '29373','80484','25575','36920','11710','32506',
                          '33266','28112','25332','63231','79557',
                          '11042','36995','31583','87115','54179',
                          '94849','61240','47857','68528','19871',
                          '11611','59338','23583','85011','36797',
                          '93440','32297','77198','10478','68827',
                          '66411','88272','71809','22048','78645',
                          '56305','69243','73492','91718','56711',
                          '51156','11966','14702','67103','28111',
                          '89166','21303','35442','29709','68947',
                          '13913','76357','26320','50979','82742',
                          '53579','17208','11486','51967','90385',
                          '42831','37516','67898','53852','93186',
                          '59577','34006','85405','82330','10921',
                          '25321','64861','66265','81778','36402',
                          '48748','97896','41704','28315','11824',
                          '13849','38843','91074','65440','54681',
                          '67660','99057','14731','82426','20335',
                          '79799','37083','72569','41317','36196',
                          '49692','19973','64467','85154','73942',
                          '77805','39396','89442','95287','65088',
                          '27371','37323','15851','41883','42854',
                          '43389','43446','59014','87491','60562',
                          '11198','13593','78266','29645','83375',
                          '76168','85713','86713','60319','73105',
                          '79989','63162','94505','80624','66762',
                          '88132','81116','62531','49496','23248',
                          '94426','66891','28069','90562','59038',
                          '40898','15397','40000','28893','12137',
                          '57844','96151','36005','12296','51587',
                          '48487','88337','17518','79478','78345',
                          '69397','14869','92470','68005','85683',
                          '25554','96829','72245','18875','68668',
                          '75860','35765','39012','17745','74722',
                          '85115','62180','82040','80390','34775',
                          '41745','25755','78579','87352','91489',
                          '32627','27809','37163','76459','98977',
                          '20255','44813','33417','58453','77371',
                          '35604','56287','21082','90576','21604',
                          '50238','41920','91491','23323','33267',
                          '71941','81187','37764','35991','95873',
                          '40885','49938','85013','64897','89843',
                          '67271','93456','17054','17907','55059',
                          '68424','68685','59913','40771','90631',
                          '24356','22382','88056','68178','22240',
                          '27993','40713','20010','30918','69808',
                          '42699','75087','62661','65363','74489',
                          '10127','52277','76943','11924','12621',
                          '16874','69201','20425','26205','46758',
                          '23337','85136','56609','67515','80959',
                          '32762','86972','57720','73229','64620',
                          '85668','33479','58443','72286','76883',
                          '41171','24028','57767','40135','98690',
                          '14128','89001','37770','73056','67816',
                          '40149','52493','84077','54755','68297',
                          '43919','29754','84700','39350','57895',
                          '29154','72176','44870','85847','86932',
                          '90029','52164','20764','58891','16121',
                          '57413','48014','25639','16647','12942',
                          '14526','47321','77481','92327','56898',
                          '55536','41684','10449','98792','18254',
                          '65335','24293','22525','58776','83276',
                          '20795','65975','97276','61251','28571',
                          '28862','96702','30244','94101','18552',
                          '57579','67469','55610','27818','89081',
                          '96470','43072','84083','42306','10511',
                          '29973','43698','52853','46172','47594',
                          '60116','32775','91736','27036','70384',
                          '68889','69371','41350','45505','65844',
                          '87708','27934','32821','74406','31362',
                          '48875','51332','66012','54930','24474',
                          '12776','28951','15832','29898','85479',
                          '36160','55739','60038','26767','47812',
                          '39378','72526','28276','97335','19683',
                          '95809','76712','98276','10305','39230',
                          '57388','76393','61940','92713','75282',
                          '77884','68343','39017','29741','40370',
                          '87993','96356','42054','56413','71317',
                          '95852','50899','77442','98566','39941',
                          '70262','54390','24228','25577')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


