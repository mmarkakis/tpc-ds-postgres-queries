
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '98949','56907','31419','42815','56739','43338',
                          '95302','47753','11357','40908','13191',
                          '99213','31010','99563','92687','65966',
                          '79216','55622','17818','75096','83147',
                          '14545','73752','52614','42776','63602',
                          '83899','78215','79581','43357','11221',
                          '16297','37652','71148','61856','19724',
                          '50082','72389','54728','93271','46055',
                          '32620','96504','49229','32187','91931',
                          '61122','16099','25729','84062','36526',
                          '78618','54328','28978','25495','19444',
                          '75810','98335','19998','55109','85914',
                          '27302','11519','93450','21602','46397',
                          '81937','30575','21307','81435','42551',
                          '98112','26590','44765','72878','75757',
                          '67461','38132','31202','16017','71353',
                          '97910','14840','16229','54940','15687',
                          '80723','66447','67469','79563','33171',
                          '73310','64109','46816','78412','10102',
                          '32342','66220','29638','86001','74222',
                          '38032','95745','69561','74606','31873',
                          '51210','25518','13438','10050','19639',
                          '38960','37029','16696','79442','38319',
                          '14819','43041','93540','98618','42544',
                          '73040','14548','82478','43447','46962',
                          '27254','99444','48825','88886','88113',
                          '68755','18666','93182','49568','36914',
                          '29045','69871','75527','89905','17191',
                          '26751','31255','59570','51692','47722',
                          '90335','64918','80605','44898','58404',
                          '36401','51849','88921','42747','93372',
                          '75524','47264','66041','37919','10223',
                          '54388','15670','44740','26978','68132',
                          '53564','14778','47454','57325','76840',
                          '63153','25126','46673','10919','81877',
                          '66092','51161','36570','26379','74197',
                          '91566','15202','14725','52088','66853',
                          '13824','54901','14051','53950','41835',
                          '89260','85628','50988','71864','47659',
                          '16492','70305','31517','21003','84285',
                          '65977','74086','69151','61987','72284',
                          '56086','61914','98175','46987','41096',
                          '90199','75466','64299','61757','15535',
                          '40829','41050','95361','84923','50862',
                          '40259','55883','40577','62618','43354',
                          '85302','43641','93876','41739','99399',
                          '21657','93314','93309','89370','30016',
                          '33034','49074','97273','81142','80036',
                          '94627','75584','26258','77785','37482',
                          '45192','19402','65240','71275','80454',
                          '51125','91757','75512','62775','83416',
                          '94074','65317','66303','29615','37830',
                          '85297','86528','59611','21175','91305',
                          '78735','51205','57418','98537','21324',
                          '61961','44896','89939','83691','92456',
                          '33151','24741','17860','57890','36100',
                          '17778','34337','92000','29979','49663',
                          '31138','39378','99642','20304','81346',
                          '46287','59368','35514','79310','35316',
                          '10355','50583','58478','91049','67949',
                          '83779','13746','26698','95966','99546',
                          '10122','96805','22731','90603','17239',
                          '29328','44097','75910','13209','57320',
                          '18240','58840','50542','33376','46637',
                          '61413','11870','70903','42441','88106',
                          '13422','69158','93306','28566','64420',
                          '26289','28909','38291','49086','25377',
                          '78793','87355','36753','15067','40018',
                          '41176','18932','44913','22376','54961',
                          '23645','42017','36201','81942','58177',
                          '63558','54798','90692','46416','31395',
                          '61583','70403','80245','94171','38979',
                          '89666','90428','47716','26290','93639',
                          '41805','77002','34802','69270','90192',
                          '60228','48483','21697','47541','21763',
                          '11412','34637','47248','28716','33409',
                          '52667','30013','97396','48335','98665',
                          '52201','92389','19989','75400','92745',
                          '48008','19262','31214','33121','47458',
                          '75735','80385','96482','90753')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


