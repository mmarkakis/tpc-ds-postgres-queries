
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '12984','71158','30862','52046','22847','76272',
                          '49193','79817','66093','19169','87029',
                          '37785','37658','60384','15055','60498',
                          '13530','96810','23415','15720','41856',
                          '49718','28189','55545','20725','17587',
                          '40903','82778','73980','65967','45970',
                          '93266','95297','14852','10287','41481',
                          '51247','74050','93252','18448','63465',
                          '49116','42398','10045','36909','83507',
                          '90495','75822','87512','81032','78017',
                          '71610','79243','11438','80388','21690',
                          '18040','70266','85553','86522','36029',
                          '58304','57852','35571','98604','62122',
                          '46222','80591','67223','52299','33326',
                          '54651','20779','69980','79836','19947',
                          '21509','43888','20266','75881','50738',
                          '52624','11647','41460','74970','46802',
                          '95649','88808','20170','79790','24085',
                          '81483','71992','32088','39893','98552',
                          '11461','96639','94909','50547','46794',
                          '29940','89650','20602','12007','58834',
                          '16514','62717','73121','64898','90703',
                          '95385','74023','75841','38358','47911',
                          '48627','83500','41548','35140','23108',
                          '27304','41733','32421','78650','45733',
                          '52666','88098','90585','87609','14074',
                          '22173','68348','71357','21610','58292',
                          '70991','51700','14385','97041','57600',
                          '87048','16592','81343','64015','32259',
                          '89141','36946','99936','19387','80367',
                          '89706','18855','91255','23851','23914',
                          '85956','73772','42042','98384','87924',
                          '52430','99552','99123','49738','54916',
                          '33510','66674','11617','32255','70669',
                          '64446','45880','62773','21858','58590',
                          '47084','71613','49991','38527','26182',
                          '99420','93070','25637','31137','74726',
                          '73743','51304','53563','10149','35454',
                          '80363','10576','85879','44346','14452',
                          '86278','20525','80922','82512','54042',
                          '86739','82989','65157','37556','13286',
                          '83584','21597','45150','30631','60258',
                          '72925','78765','91937','50174','32762',
                          '43687','23359','14962','42251','86580',
                          '47478','33365','28436','94377','61498',
                          '24685','25422','76749','40194','58261',
                          '77883','76160','84165','71301','44558',
                          '90472','18357','68916','36441','84626',
                          '11167','60497','65356','55322','99431',
                          '70828','95878','41746','77089','34908',
                          '31900','62098','59276','54838','58717',
                          '56623','48562','53301','62618','88848',
                          '59382','15954','27066','24145','42059',
                          '88075','42188','26037','72773','18171',
                          '59379','17649','79575','10060','31612',
                          '47638','43195','91377','89826','24076',
                          '36763','20883','21428','74486','64125',
                          '90266','44456','18283','82677','39256',
                          '49837','68012','39330','56969','42698',
                          '85781','42705','53154','28327','98135',
                          '43486','48209','34458','51366','25952',
                          '86226','19301','74406','90858','54638',
                          '17747','21154','39864','24158','34179',
                          '35808','36246','80292','84365','28695',
                          '19502','95279','46342','62304','65738',
                          '80219','11396','85393','63793','96418',
                          '98547','86338','44392','55375','85987',
                          '82526','15637','74059','79367','85629',
                          '22220','12409','27993','24320','29847',
                          '34449','67320','54594','78860','42172',
                          '59061','66290','80839','63211','11391',
                          '53758','63173','28945','33127','92674',
                          '78591','86574','57082','30780','33262',
                          '44318','35062','97718','65209','61868',
                          '74758','23139','35863','59892','90719',
                          '22692','58230','30383','33347','64631',
                          '31494','25934','23149','57741','74455',
                          '60210','69125','14321','68921','50581',
                          '55356','70256','94427','73746','81992',
                          '77491','15278','91117','44426')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


