
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '81024','38753','22911','38373','65830','31774',
                          '97425','31617','11282','45465','70443',
                          '14256','39234','50230','21437','68974',
                          '83394','61079','12169','42999','47520',
                          '68904','41216','33049','37036','39247',
                          '64500','14975','21581','40422','50715',
                          '24865','98903','92590','28847','69329',
                          '36823','93762','75434','43848','56642',
                          '85145','94966','18273','29718','32001',
                          '33361','40466','62040','14936','39797',
                          '52240','28241','88841','34923','80178',
                          '85023','32050','58683','17976','23244',
                          '64216','43747','39251','29797','35935',
                          '85217','25076','14638','55440','83463',
                          '18804','98391','98592','21876','29161',
                          '31440','75316','27226','38183','92687',
                          '38977','60716','30764','14151','12778',
                          '21643','72905','67901','73885','94623',
                          '20309','72072','80750','58806','41851',
                          '83905','59530','63205','48804','84675',
                          '16046','25168','99893','22467','72069',
                          '11591','64937','41917','35996','84992',
                          '61058','78582','14311','43395','11908',
                          '66446','53285','46371','42687','45647',
                          '40256','93849','34793','31197','16667',
                          '96487','23070','37649','62367','38250',
                          '71921','12394','22175','33304','70676',
                          '79886','28536','21943','74817','35298',
                          '31578','57695','25421','58668','68494',
                          '99009','79668','70853','14296','48751',
                          '14734','49252','74646','60337','45621',
                          '43256','51423','70671','59049','41004',
                          '66856','48673','41595','83051','84165',
                          '28641','58997','26551','53832','95150',
                          '11153','27488','12254','32890','46997',
                          '48694','18323','86506','43049','94932',
                          '64117','42508','58177','57089','85551',
                          '80143','52627','98191','17101','31260',
                          '76544','83362','68741','51362','63739',
                          '83354','14768','27278','87329','96432',
                          '16904','23197','42857','49999','38299',
                          '23649','99146','83502','64926','90778',
                          '15118','29174','34241','74376','16962',
                          '22979','50005','19589','95041','96472',
                          '44547','32106','76853','77015','46019',
                          '62351','68947','89837','34826','74608',
                          '85036','56199','42456','68112','97413',
                          '19118','26912','14149','81782','16351',
                          '32412','22990','42577','91363','36635',
                          '49497','76768','69542','88688','93827',
                          '34329','79567','84517','50692','42308',
                          '60415','15122','82943','12129','28212',
                          '69945','71631','59454','21567','83162',
                          '74706','93201','50965','81393','61920',
                          '36648','72172','66725','36000','85180',
                          '26072','75688','72176','37021','78765',
                          '96312','13986','14388','12386','57321',
                          '47003','99050','44467','42413','29790',
                          '49720','56377','69672','96060','56052',
                          '43790','87872','15741','19045','38853',
                          '54209','12765','99428','94073','45429',
                          '53422','13672','81516','57396','29361',
                          '34371','63994','55119','86268','75365',
                          '39499','18154','92781','34723','10134',
                          '98764','86726','26597','75743','73525',
                          '97309','90259','31666','53342','45939',
                          '11786','72745','44881','16852','58770',
                          '42758','29509','91166','28478','95364',
                          '65292','53279','75777','17269','32290',
                          '45323','18430','56670','17930','59243',
                          '70583','20650','79651','33843','65510',
                          '43663','76013','42870','94055','56864',
                          '16430','33637','80349','68215','26351',
                          '42042','97326','53110','28191','22354',
                          '56556','31518','13815','35479','31393',
                          '44507','82843','52786','33962','78332',
                          '49968','31877','67725','43901','40442',
                          '68822','35401','87634','32693','66620',
                          '94275','25541','61361','81066','49636',
                          '13917','53805','19066','35956')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


