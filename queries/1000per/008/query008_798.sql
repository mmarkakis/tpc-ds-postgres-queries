
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '46739','15172','10962','57086','22940','63614',
                          '92400','22718','57918','81894','99394',
                          '60533','53504','88427','72535','66983',
                          '69371','13207','11279','85638','46202',
                          '83526','29634','89756','42124','74165',
                          '65337','39399','90420','74685','83239',
                          '86457','76532','64336','93718','78778',
                          '11789','33858','33575','64399','52330',
                          '70029','40549','73809','64267','57201',
                          '51677','88915','35137','22185','55992',
                          '36279','18620','17173','82358','73922',
                          '22309','65497','70720','68807','70484',
                          '33933','40768','20784','97465','96654',
                          '11415','65831','21623','21904','14126',
                          '24448','94857','53163','61126','77022',
                          '62714','48912','73557','83223','18774',
                          '40866','43236','70537','44657','96588',
                          '39615','90229','80800','31377','45510',
                          '22923','59191','86855','61585','99478',
                          '71421','50586','20808','96841','57215',
                          '48390','27990','19774','66657','20087',
                          '65418','34780','33538','99847','36035',
                          '17486','24342','87453','94144','47753',
                          '38675','29756','42658','76567','65594',
                          '94223','23981','93683','97715','80883',
                          '65033','28178','92332','71673','39226',
                          '88360','95850','58993','58368','76362',
                          '14106','60906','17564','22773','84954',
                          '91751','95679','42574','51540','62492',
                          '59438','26085','10252','15030','84401',
                          '79467','93207','57388','93612','23964',
                          '70749','74748','16631','89492','75623',
                          '61361','36549','21182','42688','27505',
                          '61367','11466','39822','37640','59119',
                          '40233','37287','75811','17846','99010',
                          '93122','54639','32451','30545','22660',
                          '46309','29596','23516','40276','33786',
                          '56802','35716','63154','51279','72699',
                          '91554','19112','75921','17036','34979',
                          '70724','31168','78772','96739','31437',
                          '56533','85347','96803','89817','15722',
                          '22115','38519','51804','99980','76523',
                          '35719','82409','94639','34395','50273',
                          '87388','57015','33626','97517','32689',
                          '11037','27712','14260','94683','73432',
                          '25534','81001','58803','17368','63373',
                          '92226','34396','85746','90048','73993',
                          '79375','46233','99094','44570','47858',
                          '28101','27194','84639','64041','58983',
                          '50550','53976','46122','32715','61551',
                          '33562','68691','76626','76820','60624',
                          '63100','30770','17231','88336','58172',
                          '92160','79544','92439','48293','10990',
                          '35418','85116','50324','29725','34226',
                          '50931','56534','69361','47115','20570',
                          '99596','34696','76148','39766','39467',
                          '85698','58984','85199','14281','34231',
                          '68501','77083','64365','35884','35043',
                          '83027','94026','90244','16292','75818',
                          '50202','60429','73038','94485','33879',
                          '95591','57305','75563','90246','96779',
                          '84892','78544','53561','52780','80496',
                          '18393','36269','47622','45521','98065',
                          '25086','85315','64136','16083','22380',
                          '93943','65783','39484','34925','39261',
                          '35069','21945','77909','78378','11023',
                          '95717','34363','93875','60265','84097',
                          '10862','87326','56466','18207','50633',
                          '55101','83048','16263','13274','62109',
                          '97958','47382','73180','66584','32889',
                          '89083','27639','12487','61617','75374',
                          '86139','67972','44390','37170','29092',
                          '13529','76502','29470','19661','12462',
                          '72394','23257','39733','76948','59135',
                          '24836','55959','85975','84724','63072',
                          '59912','89731','34520','37886','71548',
                          '98992','54416','30951','11120','48518',
                          '22889','63744','67776','14951','63988',
                          '14668','28955','43723','31979','31191',
                          '19426','78935','47481','96207')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


