
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '56767','43282','19188','71723','40014','30445',
                          '14680','91510','42827','13942','88121',
                          '96512','75466','99430','75109','56169',
                          '14923','86914','29151','38906','57910',
                          '38887','69776','19003','20642','71126',
                          '32106','99606','10686','80324','95613',
                          '38185','76929','24686','50700','65014',
                          '59641','33707','31919','76508','25919',
                          '26745','59291','11766','51620','38817',
                          '19637','85692','82493','44764','96903',
                          '55260','21103','54345','59589','39620',
                          '95687','45936','49376','53709','96835',
                          '28614','93457','96119','71603','67363',
                          '66473','80678','18912','99744','32957',
                          '75653','75493','35632','47755','47495',
                          '97598','25737','17823','60152','78325',
                          '90791','72278','67333','11379','45623',
                          '68785','75696','76470','20361','23859',
                          '59859','66171','64956','66303','11043',
                          '33417','24091','35226','53907','64621',
                          '72742','80117','88039','77288','67155',
                          '97296','36403','21182','73947','93766',
                          '15451','41916','49949','31459','11844',
                          '26916','73729','96629','73376','70995',
                          '66238','91502','90710','33034','89958',
                          '87475','11618','79747','38604','46462',
                          '61227','11805','75405','68173','72483',
                          '58570','18228','76926','68735','74822',
                          '52705','31137','81783','29887','25151',
                          '85686','42556','75211','75618','92035',
                          '87885','71430','21876','58321','77435',
                          '97871','99003','87820','78750','98998',
                          '25572','28807','16512','57086','78172',
                          '10895','27630','78127','39175','62162',
                          '14659','22180','83956','24948','39878',
                          '21148','29150','12017','86849','29644',
                          '12651','20402','16679','53825','12872',
                          '48134','80040','66405','92573','52771',
                          '85713','32349','61736','48082','11019',
                          '44373','78250','63576','99281','72219',
                          '63589','16702','87663','66098','89213',
                          '88970','58299','79156','88785','48120',
                          '50510','85122','31753','18259','51280',
                          '17703','53164','47068','13337','92331',
                          '58247','12918','48867','96260','16970',
                          '13543','78464','53788','42816','31369',
                          '47909','47255','47319','47252','20594',
                          '92796','24124','39197','51711','74084',
                          '76978','79164','77858','81023','46326',
                          '97368','30780','57451','39420','34112',
                          '70060','15178','42516','45796','84034',
                          '66514','63483','98928','44754','66986',
                          '43688','24171','35466','33966','21552',
                          '45733','18760','45007','60461','37499',
                          '87026','30403','73075','25915','20408',
                          '10094','72985','98482','57701','94312',
                          '63634','88133','46629','72533','73086',
                          '57593','53846','61893','74462','20858',
                          '81954','81109','53101','49170','77109',
                          '38184','42810','32290','22728','86326',
                          '61609','44155','46311','74666','73691',
                          '19928','49484','99460','61077','85724',
                          '74739','93269','47352','49167','95855',
                          '47299','88672','51096','67709','42909',
                          '73664','25770','85709','53338','44825',
                          '49770','89928','40926','81697','81327',
                          '80681','59126','74141','64387','63938',
                          '13720','23773','69108','44157','57721',
                          '39179','96623','24950','95126','99017',
                          '27871','77941','73469','24385','99282',
                          '86355','19295','11124','90197','24202',
                          '64625','43464','66355','78231','59615',
                          '32852','18999','92262','15086','29693',
                          '19959','15523','99893','61914','25923',
                          '96239','35644','52980','51003','84728',
                          '66415','14920','18941','57547','68904',
                          '24146','14165','57208','31641','91884',
                          '27985','74506','58135','73254','37101',
                          '28446','58499','82790','30514','40215',
                          '29584','19330','33787','27957')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


