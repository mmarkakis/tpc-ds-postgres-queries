
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '87329','86954','99003','64173','95803','74996',
                          '57542','19705','84240','90860','11840',
                          '79596','62303','91605','61858','58791',
                          '39795','64969','15465','57633','17535',
                          '73495','95307','52397','96156','93506',
                          '60438','48682','65654','35745','19975',
                          '16572','96517','28693','18278','42063',
                          '96320','93829','47705','81935','98673',
                          '45642','98149','51942','74973','70619',
                          '77977','30005','86502','95088','73614',
                          '90286','12831','43376','78164','73814',
                          '33134','71594','53447','40635','63060',
                          '54029','23429','31290','16801','59991',
                          '44049','74948','67716','42640','49444',
                          '96856','63520','55537','58596','64150',
                          '68243','50765','56052','74279','87100',
                          '54917','84737','73487','91897','62421',
                          '27334','45654','36735','35226','31039',
                          '84807','79031','55801','91835','72712',
                          '24520','11195','79472','54040','94426',
                          '21234','34246','56446','25251','68962',
                          '53653','60049','97438','40223','96172',
                          '73655','50986','73244','24139','81393',
                          '44103','90869','44327','56925','47848',
                          '51978','93337','86137','81571','21820',
                          '44868','61600','78397','54855','82391',
                          '52463','42419','35765','80960','57506',
                          '82486','10609','80899','78118','45396',
                          '28010','44936','96030','52573','25456',
                          '93349','86557','87253','97823','55587',
                          '30740','41922','34572','32684','91812',
                          '29241','64989','95972','87451','56648',
                          '97487','10724','72668','71317','23204',
                          '47341','45130','69773','66919','66157',
                          '29914','69782','41542','23111','95751',
                          '97266','42079','74329','66805','80328',
                          '27441','64652','91349','35821','65546',
                          '18178','98985','44511','29013','66400',
                          '33647','24687','16215','71815','69221',
                          '72355','96324','88377','94479','49318',
                          '58808','21943','59251','83415','73730',
                          '43738','37565','16401','33258','42430',
                          '80658','79556','91346','91389','10066',
                          '62371','73518','90594','51893','97563',
                          '89089','90058','60686','15571','92396',
                          '54023','85862','38047','75787','75537',
                          '78648','92014','42358','67536','54419',
                          '52233','53384','72489','84022','97347',
                          '52844','64855','60461','87956','84913',
                          '21611','90948','35742','29040','55559',
                          '40827','20144','57904','33955','93701',
                          '96591','22472','46458','19872','59585',
                          '99856','11775','25914','87773','87942',
                          '66783','12966','52500','19546','68067',
                          '76916','34613','87909','89555','85982',
                          '94974','13126','57089','48131','88811',
                          '71462','66848','20899','36660','72275',
                          '75794','82221','31140','18907','54560',
                          '57330','13000','79511','42106','85857',
                          '38674','59746','55714','49463','68532',
                          '78888','50659','11824','71343','96052',
                          '59122','34842','43782','78385','40331',
                          '38165','19752','86549','13333','19615',
                          '36428','11719','68121','85714','47094',
                          '36520','26449','99751','81200','90344',
                          '40620','67665','74924','65974','20638',
                          '25254','84276','36590','92624','37354',
                          '93826','93403','85918','36419','66064',
                          '64139','38109','48497','25338','88748',
                          '28996','90222','43051','40205','88535',
                          '32244','80477','63511','33362','75824',
                          '54640','86983','41362','22834','82204',
                          '60932','27418','95454','65385','63788',
                          '72273','24855','21202','29871','40035',
                          '20814','75860','29055','93865','81108',
                          '34815','51430','21600','97620','46526',
                          '95820','71373','23514','82998','10161',
                          '51713','46995','23190','12127','39821',
                          '54987','97335','98572','77433','14956',
                          '70811','19919','17610','50387')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


