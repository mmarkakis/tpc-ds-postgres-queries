
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '95644','70137','64474','83882','74677','36655',
                          '35536','38811','67628','13878','81042',
                          '69621','53414','21789','68875','29917',
                          '39433','19002','19327','95186','59792',
                          '86735','16319','59641','70248','89570',
                          '59521','39798','41463','32199','21913',
                          '90977','52671','17868','58884','66792',
                          '30732','33155','15084','73776','47028',
                          '22492','37347','60957','15030','86627',
                          '66839','37169','90660','60074','29183',
                          '99891','67963','24410','88991','59747',
                          '42168','33355','38942','43887','67110',
                          '35581','23505','59648','16328','63613',
                          '63277','98514','58969','46650','31010',
                          '90775','85694','72643','92865','50785',
                          '12716','81151','52409','51215','42975',
                          '95258','23012','98054','54782','39017',
                          '16084','36094','79837','61043','13395',
                          '12126','11204','29142','42167','69109',
                          '13595','86573','61131','99520','29365',
                          '99046','37270','72526','43313','60569',
                          '37239','57506','30913','96965','27621',
                          '38814','11584','18638','64460','15025',
                          '41862','43916','14407','23020','99291',
                          '18490','28625','78321','93806','90282',
                          '15495','39748','84566','67467','68037',
                          '69448','81688','98209','25629','86163',
                          '26280','21994','82383','99133','55485',
                          '67045','58315','90777','72806','61435',
                          '72556','63604','10679','10360','84309',
                          '17049','44698','38123','35819','16698',
                          '45721','25146','90845','58485','29837',
                          '98967','47833','63648','83252','55983',
                          '56584','66131','41032','30303','14699',
                          '61289','53938','80241','18301','63314',
                          '35667','53786','84576','73149','70685',
                          '98004','80295','68328','14153','40815',
                          '88557','91903','37490','54888','70249',
                          '15122','71171','68025','63472','45565',
                          '58069','68014','27760','22641','56120',
                          '84577','36833','79162','49642','43170',
                          '26577','17161','99906','49447','32727',
                          '64967','56187','50491','35084','52791',
                          '40945','78115','80153','28997','53511',
                          '61180','30345','73401','75282','90914',
                          '61526','11087','44932','29517','95869',
                          '89640','78918','34585','19661','47593',
                          '37976','19668','72971','76132','65182',
                          '16506','90089','38685','27675','82454',
                          '63623','83735','47787','59840','20451',
                          '50452','38557','88979','91502','68613',
                          '28318','86126','85473','81288','32161',
                          '12434','50633','26001','51196','75472',
                          '67166','75277','37603','95202','97093',
                          '75783','90367','67638','71355','54390',
                          '10850','36958','63216','49153','63419',
                          '71163','10250','45055','82990','47421',
                          '54124','37933','92492','70631','87603',
                          '32434','73258','19922','65369','82908',
                          '95246','25039','19140','24422','70108',
                          '63014','27258','18989','65582','53393',
                          '36661','10700','49368','40899','27346',
                          '52823','11800','73448','59832','12923',
                          '74648','58537','77257','22879','83877',
                          '19731','45614','11187','42971','52340',
                          '79747','43043','73270','62965','38693',
                          '18103','39629','13202','69797','59526',
                          '59263','99490','62906','16444','33403',
                          '63190','67575','64005','14239','43554',
                          '38792','59342','52478','13550','35831',
                          '99899','17554','37948','91609','72312',
                          '86686','83548','72672','28977','59100',
                          '99926','95712','48225','92327','33086',
                          '33356','62916','47876','81754','66738',
                          '64256','83100','92846','96607','11940',
                          '10537','73250','54549','60477','85764',
                          '75945','60487','68992','52402','74004',
                          '10017','67552','83547','25373','50532',
                          '30351','44326','84881','65367','87243',
                          '50099','79876','82272','25177')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


