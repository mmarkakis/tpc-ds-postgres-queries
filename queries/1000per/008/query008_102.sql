
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '23351','43390','80162','20532','55466','52262',
                          '80856','82206','21414','62120','20061',
                          '52577','92293','79723','59141','17090',
                          '39136','81787','69955','70644','31365',
                          '69857','40829','32388','10673','92485',
                          '16005','26569','81120','53667','43825',
                          '78706','71966','39865','33848','65851',
                          '92512','86719','60831','57969','92326',
                          '23977','17513','75005','65283','80571',
                          '15807','69729','76229','81629','26725',
                          '62762','70364','61970','72653','50010',
                          '79879','14354','75558','35494','91166',
                          '13241','36666','99764','49404','24575',
                          '39311','75854','27880','76857','50280',
                          '12628','65929','63212','49970','64424',
                          '19552','29835','83602','75993','70135',
                          '11945','96210','41113','50654','83381',
                          '40110','14599','63314','58772','81394',
                          '34420','31736','99205','10393','99316',
                          '33418','17929','15338','34665','72061',
                          '16886','77811','19074','42411','51015',
                          '71138','21876','69143','93406','18857',
                          '71513','30334','24237','94990','89752',
                          '39153','56897','58679','89349','69883',
                          '69746','92983','36553','20842','21635',
                          '52786','63914','68158','83762','11577',
                          '34156','85338','81258','91296','62866',
                          '25025','94805','11712','88451','48420',
                          '14834','32480','76778','36485','69782',
                          '81898','83090','10988','35791','34143',
                          '96001','36164','89405','39451','36297',
                          '28461','11838','73028','82818','49767',
                          '41712','74928','36328','19325','60406',
                          '84231','98716','81872','71587','88212',
                          '26256','73493','38070','15801','58854',
                          '19313','14080','46902','29135','69269',
                          '72830','90900','85378','90955','93021',
                          '81640','52859','28520','38668','53157',
                          '91426','63602','77146','24086','40081',
                          '48174','76667','63180','70038','61817',
                          '52143','75532','19659','18185','77745',
                          '17366','30737','87899','49460','15477',
                          '40134','38382','37026','15557','67356',
                          '13706','51747','40665','59681','38430',
                          '23527','84367','65009','40622','43271',
                          '92945','66573','48936','42798','10837',
                          '48847','58707','83824','37278','65514',
                          '33194','14129','13702','68192','22098',
                          '40261','45248','56638','75927','73256',
                          '48614','39542','28488','91937','18776',
                          '10296','21422','47459','93897','63105',
                          '17605','43373','71286','33554','85636',
                          '84852','28283','45375','75006','11133',
                          '80920','85435','85608','70244','40767',
                          '12947','38086','87864','76700','47546',
                          '75883','19929','73852','37634','62341',
                          '41679','30266','23775','91848','22757',
                          '22648','37099','42340','64666','22364',
                          '99211','14420','81785','57053','71172',
                          '41772','55584','50548','92260','85800',
                          '25640','91662','50523','42457','58569',
                          '55321','58963','48223','13080','18184',
                          '18893','43485','88126','53403','63434',
                          '48995','37579','77071','46107','28141',
                          '14170','15886','64953','34500','24500',
                          '31086','13944','89316','48890','20484',
                          '95447','97984','11767','96146','71470',
                          '14933','79631','80935','57214','76656',
                          '85479','16876','47896','87200','64516',
                          '62521','68713','76599','44333','60474',
                          '87091','32358','54972','29679','29090',
                          '80287','63452','34911','70046','45695',
                          '71703','82369','17424','92192','47853',
                          '83751','57376','25378','71993','11784',
                          '43387','76266','45782','80362','56781',
                          '16658','30347','81902','79381','39284',
                          '41799','38373','88267','11033','79368',
                          '27340','44339','74675','67134','28612',
                          '25545','20779','58067','12712','38145',
                          '68506','67735','48399','13954')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


