
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '76326','33014','12198','50309','76245','63759',
                          '16387','44310','13852','68905','77235',
                          '76468','47862','82473','82900','92885',
                          '31904','59757','30349','11741','22740',
                          '98227','47935','49978','54359','79825',
                          '96960','45529','26005','97798','57615',
                          '63868','63121','82679','46337','13344',
                          '18421','67092','97925','78537','97263',
                          '23731','35767','58028','45082','57051',
                          '89999','42035','44242','80054','13422',
                          '91258','95496','29268','22283','73516',
                          '50799','59119','50397','61470','63755',
                          '88938','66025','79533','89240','59593',
                          '48812','67236','75830','83286','27910',
                          '88111','90985','23216','97707','38102',
                          '51287','31272','89299','21948','79286',
                          '41551','34978','18547','62581','18018',
                          '61586','15720','50412','50704','61054',
                          '65569','36938','96073','60347','51618',
                          '28390','87967','25583','38107','12173',
                          '52874','52390','79640','27928','30529',
                          '36165','19103','17182','17359','55092',
                          '91637','45222','59088','80769','74496',
                          '95158','84134','30023','45734','61239',
                          '73794','44659','84239','66418','75160',
                          '79904','28427','20267','27356','68759',
                          '49471','76309','21222','14889','35178',
                          '35915','41414','11495','99170','61137',
                          '86737','62096','74337','22895','92523',
                          '70466','66562','54674','76254','43526',
                          '95561','16431','98234','22606','41794',
                          '30586','11054','86823','29808','21645',
                          '51526','69971','34290','91232','58542',
                          '10363','10048','75289','50242','60404',
                          '73005','48651','19898','45681','77939',
                          '36194','46966','52850','47484','26050',
                          '84825','72693','77446','49850','32448',
                          '40487','42934','15522','77695','33744',
                          '92217','86085','72006','96899','52465',
                          '29538','40845','47344','41996','42085',
                          '85467','61537','99745','51090','42742',
                          '91518','57029','59033','41983','28555',
                          '49255','93571','31683','18589','49002',
                          '62827','17313','21091','36501','98917',
                          '10247','59165','69487','14034','93637',
                          '58547','50401','82089','55619','43743',
                          '66958','44743','22562','68667','26523',
                          '32717','21255','84113','99627','86413',
                          '25425','63066','66197','68620','39605',
                          '52176','92634','27599','40846','42952',
                          '35775','44981','53535','67046','59052',
                          '12418','42935','84050','39328','87589',
                          '84072','24582','48558','59850','40427',
                          '23050','20747','40592','64878','40519',
                          '68339','99230','66498','71586','99514',
                          '28948','21886','68835','41608','89227',
                          '10789','25135','38982','83301','10171',
                          '31251','64089','95438','87065','94254',
                          '73986','47807','38816','45716','23080',
                          '69714','10530','55121','18723','46431',
                          '56087','25656','24272','81217','13206',
                          '27515','19555','44068','91803','61181',
                          '65319','34734','58359','97434','11671',
                          '22196','38117','10180','81739','74226',
                          '58963','96210','73777','55175','68110',
                          '66369','51398','91271','87061','39541',
                          '50366','48967','95246','71523','92455',
                          '40769','38337','69743','45236','89329',
                          '28846','89086','46038','31237','20311',
                          '25843','59806','58189','20030','46053',
                          '92872','85002','41638','61748','21807',
                          '55223','13337','21858','64082','85461',
                          '16238','60331','54162','32484','55901',
                          '99449','86376','44500','71715','36605',
                          '27948','52719','52336','80509','62452',
                          '51687','40609','68808','43620','20010',
                          '85954','19784','28286','27475','77168',
                          '71620','61893','56085','39015','43879',
                          '70712','12166','40586','79560','54488',
                          '94109','20755','13070','59824')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


