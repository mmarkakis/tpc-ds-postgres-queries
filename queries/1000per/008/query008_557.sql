
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '60541','34389','72858','29530','93545','98470',
                          '34792','58486','40014','11210','80596',
                          '60804','88311','44484','69224','79153',
                          '16488','31437','12956','53158','66023',
                          '88868','82706','16127','68363','12237',
                          '25036','56683','24098','53867','11738',
                          '14484','90773','21322','20391','12371',
                          '45559','13836','19047','93090','51751',
                          '83402','65668','31931','89588','64337',
                          '28473','40667','43367','10585','11628',
                          '20680','71910','43085','20653','29479',
                          '83829','20715','93134','93229','44990',
                          '16647','65273','29285','50429','88384',
                          '40469','50874','56774','78260','32367',
                          '16045','63754','64752','78890','56375',
                          '18370','29533','35374','99116','87128',
                          '39938','65392','41375','73886','13412',
                          '29179','76726','38665','43372','65233',
                          '44101','16755','74479','82015','12299',
                          '65742','33118','88367','51791','96078',
                          '89993','96754','32341','45358','84874',
                          '76338','53209','71090','79271','96916',
                          '91260','60625','13970','14956','89788',
                          '69874','37400','71120','74608','28183',
                          '42556','75620','31282','77852','66618',
                          '63099','65576','86887','97057','73829',
                          '19315','15139','82626','27901','42473',
                          '36832','19382','79637','28918','38663',
                          '30796','28446','59523','58329','43525',
                          '25686','11456','99994','51611','63585',
                          '89735','18427','36346','36529','58034',
                          '91619','29076','36561','41833','60241',
                          '98524','62980','54437','64042','85299',
                          '10847','78195','50859','62321','33527',
                          '86607','60478','93487','12213','68538',
                          '52591','36694','79974','34075','85929',
                          '48570','68349','43983','79080','12999',
                          '21413','11069','76975','33002','47747',
                          '51681','45762','42339','98672','22596',
                          '82190','45682','21673','70752','14446',
                          '29652','27167','95545','38669','62388',
                          '52208','13646','84349','73022','24032',
                          '30831','65042','39214','56328','17061',
                          '24870','61097','63692','22927','90190',
                          '79528','43119','44418','89002','26261',
                          '66437','70836','44056','65155','43196',
                          '72903','45226','54503','30099','93410',
                          '88591','68900','64966','18902','50974',
                          '27789','67102','44397','22056','52536',
                          '26810','25804','48709','12402','38789',
                          '52975','76243','70900','65594','54293',
                          '81720','32723','72987','69942','73064',
                          '74127','37948','89302','50475','13105',
                          '77215','99045','25966','50189','60604',
                          '80911','75761','59230','44072','70709',
                          '73729','45373','56904','76416','22010',
                          '94730','32199','18337','23766','52452',
                          '55452','17306','70937','19521','81565',
                          '98058','88216','99380','75426','37940',
                          '45288','80818','55171','84612','25625',
                          '21543','30035','33315','28505','83228',
                          '34097','13966','90594','43635','11972',
                          '72521','34936','88505','25384','89624',
                          '22759','66533','62179','35029','76888',
                          '77795','28672','67509','97155','10827',
                          '74648','15984','90675','59965','80660',
                          '77931','26528','55503','93061','58838',
                          '93374','58130','78072','98840','10923',
                          '67507','37920','95029','46719','74533',
                          '89442','94378','18982','71460','88240',
                          '55359','53313','58659','26645','62418',
                          '22310','71938','79205','79166','32424',
                          '63849','37836','87973','53885','46348',
                          '23202','17892','84932','79047','53733',
                          '25371','16597','66596','31903','58401',
                          '11147','69936','33751','42580','68330',
                          '56905','26193','55198','95701','12244',
                          '31075','62698','96808','88840','64509',
                          '12290','44079','41964','98473','95022',
                          '60546','41162','10653','57502')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


