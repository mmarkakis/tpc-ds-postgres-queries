
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '63022','78012','27969','52257','77149','91414',
                          '56281','38691','24782','36250','70552',
                          '70157','20967','18539','27107','42577',
                          '30910','26542','79356','21782','39370',
                          '84935','87026','86338','15340','22896',
                          '10308','51428','25816','83396','31781',
                          '99978','65758','38657','14840','25848',
                          '66533','59499','54229','60280','61019',
                          '38060','37464','29336','30814','97257',
                          '98293','30014','46379','97609','34796',
                          '82689','59155','29443','75456','61543',
                          '62395','47064','88859','41528','86589',
                          '37797','39615','14823','80917','92584',
                          '67177','23007','25274','25220','86204',
                          '64536','86195','55370','31121','49664',
                          '78667','83609','73432','27848','97527',
                          '44786','49211','74884','77105','87207',
                          '81672','76967','96053','50114','60777',
                          '78189','97195','64456','70566','52971',
                          '62740','35867','35104','11813','38683',
                          '32438','54351','26242','62233','92978',
                          '62437','40192','45848','84845','64356',
                          '27332','44122','73053','88017','83742',
                          '28247','54200','88266','27328','38203',
                          '65970','67698','76625','65269','48114',
                          '45698','83817','68243','57513','80541',
                          '22690','36409','32677','20631','60004',
                          '18087','47045','23936','17247','80009',
                          '57406','29229','26298','35790','84688',
                          '64271','63301','28820','24998','67270',
                          '25584','20465','62989','49481','93711',
                          '17041','64745','59733','32367','86793',
                          '49550','64156','29932','63854','37294',
                          '72589','19025','93964','84802','64727',
                          '44311','67135','37287','64469','45506',
                          '43081','67246','95660','27074','67967',
                          '11675','39139','79655','93386','14906',
                          '19269','84585','36786','69679','69304',
                          '67067','63452','66441','31657','49721',
                          '36717','90460','68962','71540','83249',
                          '99680','39123','72591','70700','10890',
                          '82239','23496','76487','93501','67155',
                          '44954','77380','61252','53077','41455',
                          '29137','55932','87587','78149','39041',
                          '89293','54165','46165','84494','64852',
                          '46741','21732','19840','73283','62770',
                          '34185','34978','39652','72745','65333',
                          '25711','20084','98331','55184','28374',
                          '19158','16182','35364','33850','16895',
                          '76006','39484','58256','73043','55176',
                          '23560','58719','42249','49097','63162',
                          '57121','36578','83715','20816','16787',
                          '50239','57106','43482','10576','87630',
                          '65120','15036','62036','36980','13508',
                          '20812','23383','77595','11338','95194',
                          '70069','75979','59593','27763','90282',
                          '42372','56539','97079','76445','26144',
                          '32841','82371','59002','53771','17326',
                          '89735','76044','10101','11433','74507',
                          '81837','59944','64699','89807','79553',
                          '15107','64620','27098','95769','46460',
                          '56555','11586','54162','87972','66895',
                          '50616','84062','77382','49668','35493',
                          '25875','52435','88005','31816','44692',
                          '40016','39155','53232','30817','73904',
                          '50058','17407','67212','57195','71045',
                          '94293','72647','21185','69410','64723',
                          '85214','16419','35326','96447','66770',
                          '22503','82674','85500','93104','53751',
                          '53052','98517','26888','20458','14601',
                          '96060','55288','78169','59072','82694',
                          '44215','56860','64973','84181','38181',
                          '15819','62050','31201','67192','14813',
                          '84854','86852','10432','87083','70825',
                          '31082','96223','89584','19036','49683',
                          '78204','46736','74782','77434','19450',
                          '85931','76653','96453','79409','17231',
                          '80230','14553','81064','57856','78732',
                          '47941','31766','41908','80685','79527',
                          '92518','36537','93052','16217')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


