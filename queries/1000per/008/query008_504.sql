
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '84097','20961','18245','52977','33555','68760',
                          '83618','76050','42401','35846','62160',
                          '71429','34018','69719','33809','91359',
                          '19715','26864','54669','23766','19733',
                          '98092','41908','90087','44844','82771',
                          '36773','22392','16147','18961','33049',
                          '80918','71453','33583','25419','66913',
                          '93837','84751','79861','15183','35786',
                          '95991','47890','25450','63888','52129',
                          '82939','28673','14854','41064','16719',
                          '29105','36853','15900','44264','59328',
                          '39983','33174','68751','34472','42362',
                          '29652','72241','13002','92689','23700',
                          '14769','96479','99525','66332','97925',
                          '72411','46818','46038','68917','80312',
                          '52581','21054','19208','44525','84413',
                          '14950','82825','95958','74407','72608',
                          '62817','98488','31190','18605','80450',
                          '26229','10281','36115','24359','95501',
                          '46877','88012','53481','84711','31326',
                          '21676','80982','15675','95930','69450',
                          '26565','11190','48369','68232','76059',
                          '29707','57771','86405','33690','69410',
                          '66046','15367','77503','50016','22580',
                          '77693','28695','87758','19426','79501',
                          '21449','85025','62439','57047','38348',
                          '15428','52761','95127','30171','27411',
                          '20668','79928','33759','68280','74206',
                          '42069','29779','40802','91488','47007',
                          '89219','11916','67913','58792','64560',
                          '58228','81406','94113','56994','45008',
                          '25670','34056','81788','24299','25064',
                          '89764','60382','53147','51582','13193',
                          '16911','26495','33938','69668','81812',
                          '94442','76590','47618','50611','12711',
                          '87493','22505','88772','59137','79564',
                          '87423','30991','58118','35612','47465',
                          '48069','81798','11717','43783','22659',
                          '86941','92080','99118','71272','87516',
                          '60879','44988','43055','49227','42041',
                          '28526','34193','98889','70379','45120',
                          '66921','95362','35572','34195','74268',
                          '92344','46032','90547','96814','17177',
                          '46543','45509','83555','97024','12987',
                          '66847','91451','73258','14891','31625',
                          '72430','66724','15636','66862','38498',
                          '28917','84601','49072','41540','82131',
                          '15703','51362','21601','19975','93725',
                          '70833','71485','47555','98999','45136',
                          '23100','74723','23475','14274','86773',
                          '89374','44295','61092','75230','54869',
                          '21281','47112','39731','94758','22275',
                          '72540','82622','94563','24157','36894',
                          '28070','56005','20612','48545','78354',
                          '79450','77189','96156','33070','55454',
                          '63242','50320','44078','25985','69706',
                          '97076','93028','40417','64900','75992',
                          '22370','73696','56443','70456','24233',
                          '78599','66589','57506','40995','84048',
                          '82564','58342','38448','14343','98477',
                          '36864','88485','24729','42923','89015',
                          '40681','62927','17006','75392','77051',
                          '84882','50162','60940','78789','22186',
                          '85426','66508','61685','80425','47464',
                          '46061','42404','72187','68749','48588',
                          '91632','60103','59613','97104','68223',
                          '98193','14073','39807','50861','32111',
                          '14005','16437','70918','98732','68355',
                          '18817','15218','26468','49922','27644',
                          '91405','33804','95974','79033','37527',
                          '91272','18691','77831','18543','17181',
                          '94426','96020','18502','24214','22740',
                          '26897','97898','36163','53151','32421',
                          '83432','50233','82341','73925','29093',
                          '95227','59984','27804','52259','22546',
                          '72583','45675','94260','78167','13045',
                          '49425','93333','97404','33506','72569',
                          '31690','66522','94579','72320','81448',
                          '49469','54975','75908','25316','70686',
                          '15811','59344','41250','13527')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


