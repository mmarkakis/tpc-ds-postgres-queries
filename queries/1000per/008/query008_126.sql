
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '96048','33340','80184','31951','82001','53648',
                          '70861','44498','81682','82199','86193',
                          '94743','74920','84959','67251','49331',
                          '29235','39477','20908','68967','78970',
                          '78251','92063','69722','29800','22269',
                          '59836','65785','69969','68792','79338',
                          '71089','88487','28983','25494','81316',
                          '62550','88923','18590','26664','73213',
                          '19800','30781','59277','36263','88134',
                          '17971','75111','34823','35051','41549',
                          '17840','29447','24062','81158','31496',
                          '84667','18541','69352','81001','32253',
                          '70708','36695','35113','22514','66774',
                          '40366','71077','54655','27975','58391',
                          '13892','94152','59511','17087','10020',
                          '10944','44562','34833','47885','28937',
                          '14918','10570','38170','14240','78300',
                          '50930','75519','93197','19215','61322',
                          '82191','12600','10115','28111','15353',
                          '63345','24950','26972','41360','96209',
                          '49187','40758','41234','25079','33770',
                          '57415','91710','32779','18072','25845',
                          '56339','82908','90607','27626','42904',
                          '51281','83913','15558','55583','51422',
                          '87281','11522','48487','24539','54304',
                          '14366','56907','96791','65266','20443',
                          '72087','75459','21147','20176','13177',
                          '80708','76761','78694','71312','71981',
                          '81673','84874','30259','38811','69839',
                          '12714','22432','62280','94219','16775',
                          '47398','89740','50344','43311','82089',
                          '53052','13699','94858','60063','72807',
                          '32092','43992','45805','79119','96646',
                          '53701','24709','50230','69350','10480',
                          '14649','85297','59182','11727','40371',
                          '70313','88937','12379','68045','74622',
                          '15103','62475','75049','47321','94878',
                          '69191','10950','74661','96999','34836',
                          '91747','11800','20254','72240','23269',
                          '69193','97571','84210','17325','49840',
                          '78086','93004','74900','16318','46450',
                          '78223','78652','40220','91993','15996',
                          '89521','25875','14233','32619','20588',
                          '54365','60183','21121','95047','53186',
                          '54133','95885','55277','67678','91650',
                          '89071','92491','31634','14041','36629',
                          '64018','33414','61642','36540','72347',
                          '62969','45525','14868','54233','58084',
                          '37069','74769','24659','90665','40485',
                          '62748','99237','29230','48061','13221',
                          '85518','63639','26322','83233','16998',
                          '96910','32331','42894','36604','68175',
                          '23770','76164','83240','59141','57524',
                          '29593','96705','65028','50784','73362',
                          '90742','85664','29096','81156','32406',
                          '92912','45145','26176','69427','59061',
                          '76652','16654','69487','62209','47601',
                          '53463','71980','74332','96555','86719',
                          '12154','85738','26241','94908','76080',
                          '34963','31089','98010','55513','56953',
                          '88987','79760','62439','67660','69853',
                          '80032','51813','70787','10615','82983',
                          '81763','46116','57155','24307','43460',
                          '12521','68055','88046','87988','10197',
                          '45709','69720','43637','44195','45704',
                          '85290','64318','37595','61172','77307',
                          '39247','70650','21055','99939','58698',
                          '87376','37930','87591','52684','89657',
                          '59479','17764','10313','47481','17482',
                          '31131','51841','59233','56681','89275',
                          '72302','79595','60911','27256','89911',
                          '21850','61224','60635','89936','35417',
                          '68672','56295','17854','55144','41617',
                          '76656','29467','23753','41781','38931',
                          '25422','92344','50361','63911','75457',
                          '12780','98083','15522','43916','10143',
                          '97881','26451','78579','90871','92379',
                          '14060','18186','18810','74814','70987',
                          '14034','57338','89080','47053','99333',
                          '84855','83823','97906','56012')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


