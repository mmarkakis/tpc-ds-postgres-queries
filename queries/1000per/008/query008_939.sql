
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '48556','34745','89436','99218','68988','12884',
                          '41709','84903','69333','96493','14812',
                          '91623','86566','73789','19825','80135',
                          '72506','71753','26632','77431','72728',
                          '96580','38419','24275','41703','26983',
                          '71674','59608','69025','15874','70321',
                          '38050','19828','96635','52890','36632',
                          '95791','52232','32351','26941','72063',
                          '37117','97910','21171','84514','61289',
                          '91153','11097','11082','58174','20631',
                          '82212','46782','65116','23763','48561',
                          '27357','46383','36036','49323','12182',
                          '81596','67115','29998','25431','14392',
                          '70260','93524','51235','58383','10550',
                          '46182','30735','68443','91171','82422',
                          '21848','67459','96251','82824','36265',
                          '16357','63126','78916','54886','68216',
                          '87649','74578','44284','64895','62634',
                          '71407','50653','21282','25595','76015',
                          '71523','49626','68221','91251','35439',
                          '39648','42232','67341','52870','52254',
                          '17865','56631','38384','75905','49287',
                          '53524','34024','29188','42973','98331',
                          '97554','13819','27777','50692','39305',
                          '73986','31698','83357','63569','65280',
                          '10851','82334','46554','27437','63810',
                          '63997','82616','17126','97061','25853',
                          '70969','39291','35770','89586','19884',
                          '33438','14762','41740','85922','88051',
                          '33374','58152','47221','88122','85514',
                          '67986','43158','68065','79017','58492',
                          '23846','61314','37021','52641','50321',
                          '49242','28596','78380','75523','17985',
                          '15418','78195','71874','64836','91350',
                          '64246','14904','98218','15734','23940',
                          '59848','51797','45906','77336','36910',
                          '84713','91261','39695','63494','28053',
                          '53129','88139','99929','96512','80330',
                          '39879','87616','93250','32760','69352',
                          '30766','50472','31903','15055','30772',
                          '94551','33234','85879','13641','35634',
                          '12826','58713','47559','58409','87359',
                          '19626','95677','38846','53049','91986',
                          '85850','99013','56636','55997','52048',
                          '59687','19036','32627','11966','46286',
                          '95893','77478','47431','39131','32201',
                          '17765','91807','59151','57526','68050',
                          '57550','96429','71593','44041','32757',
                          '95527','25826','62076','80949','24012',
                          '60053','24277','73752','94664','37992',
                          '26791','68496','30921','92438','13775',
                          '10484','21079','92523','60332','60455',
                          '46044','38147','83342','76113','36215',
                          '73280','87503','68244','54839','65270',
                          '90492','70173','30207','15882','37867',
                          '64513','81405','71102','57086','83436',
                          '78837','54279','38781','65186','99609',
                          '44088','87932','42894','89541','86185',
                          '27479','35684','26680','17364','16659',
                          '62372','54451','54265','54655','52092',
                          '30653','34968','50833','52570','62494',
                          '77454','50402','23556','43145','29492',
                          '38868','93096','43912','86823','32079',
                          '19336','76033','37300','39007','80318',
                          '36110','71077','90914','65042','59375',
                          '44507','94718','47652','10268','91045',
                          '31644','17694','36026','24251','68917',
                          '18304','32592','80176','62101','55964',
                          '75165','13256','20983','63741','81873',
                          '14911','52931','20703','70497','78615',
                          '40950','73214','37589','26247','49654',
                          '60657','92902','28574','53866','64144',
                          '61216','11529','18615','29740','37388',
                          '43933','11245','90050','42869','79372',
                          '82052','56191','16908','44999','86486',
                          '14756','57938','71542','30005','55207',
                          '18449','50489','31174','15783','13691',
                          '39118','96385','80421','91599','18490',
                          '98195','71305','82576','88196','30013',
                          '96567','32364','18585','15606')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


