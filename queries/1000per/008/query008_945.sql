
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '14863','17470','88484','87853','29397','15745',
                          '89090','79938','20888','98262','79239',
                          '53892','13060','43294','50254','51542',
                          '68818','39414','33118','18799','63935',
                          '21707','40386','17636','80885','30811',
                          '37145','55437','51980','26787','75951',
                          '94490','97323','90896','11272','64050',
                          '50403','94140','29725','61186','61906',
                          '53433','24593','21907','73739','88182',
                          '56081','25971','21453','83522','52488',
                          '54389','18728','16080','33863','52345',
                          '16183','62626','24624','22150','63683',
                          '72936','65718','11286','88465','31605',
                          '94591','22577','92090','50540','11785',
                          '71841','14438','19420','37664','93818',
                          '13218','60935','83664','35443','91148',
                          '52763','99257','58824','91764','32290',
                          '62442','45243','44997','18936','37312',
                          '52145','52837','13950','69788','16629',
                          '66812','34218','14195','61611','48562',
                          '31244','51990','97210','63884','98999',
                          '21789','24794','10737','24558','56403',
                          '42283','24055','73947','97416','96355',
                          '41498','70423','15897','28616','68518',
                          '80600','14931','87012','39892','32428',
                          '88681','60549','93771','17102','73653',
                          '27235','33881','57384','54070','74362',
                          '13630','30998','38625','57253','83861',
                          '90082','12087','79998','45100','38276',
                          '50652','29165','22934','40786','16986',
                          '75469','94779','68736','25737','90269',
                          '68536','35613','40174','59566','26082',
                          '40396','40071','57321','19124','40744',
                          '96462','23999','57351','50814','88498',
                          '73494','33229','17947','91493','62687',
                          '40425','16334','96257','11584','86275',
                          '81494','63346','91610','97867','49956',
                          '27049','13800','53689','64847','75166',
                          '72500','82340','24871','61846','17311',
                          '24641','24100','75549','33356','15884',
                          '71839','94244','61701','41545','57991',
                          '12982','52399','20820','71402','15082',
                          '99261','85954','49538','83449','38459',
                          '66096','86409','79720','22919','55913',
                          '25359','38116','64825','43136','84330',
                          '68083','43030','52547','72654','66768',
                          '43054','39074','33416','99278','50705',
                          '77168','85566','29111','75372','24483',
                          '72990','54696','55220','44423','16001',
                          '88315','71256','57514','56642','31725',
                          '73424','69941','97172','84404','36202',
                          '96826','73532','93332','33660','40857',
                          '17184','20248','55328','75575','31975',
                          '21694','80857','81496','85790','30418',
                          '88856','94954','29574','12079','42246',
                          '81373','95302','96079','80778','20338',
                          '53676','86373','50722','84384','43498',
                          '81796','34198','29547','53559','67910',
                          '51212','91767','92491','64902','66466',
                          '56719','52620','12024','69413','74917',
                          '23751','97811','63804','44513','24597',
                          '21720','60245','38690','11487','53788',
                          '60704','19846','26901','99929','39784',
                          '93558','16287','75303','20267','31188',
                          '97180','17526','26652','30707','87969',
                          '46350','62841','94196','96293','32994',
                          '34652','24141','97092','65734','56826',
                          '31219','84490','26782','67462','74746',
                          '73140','77874','93290','98989','36867',
                          '35197','51601','68937','31412','59836',
                          '70344','57120','53144','86807','37065',
                          '59039','39449','28395','33112','84072',
                          '58701','96176','78857','56578','70757',
                          '39489','96692','52060','88169','72519',
                          '24566','21140','25147','73566','97018',
                          '82694','52822','24758','94932','13274',
                          '69480','78873','39124','97750','56344',
                          '48658','68666','77624','95786','44563',
                          '15789','56143','21110','17410','79402',
                          '69673','78554','33140','12691')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


