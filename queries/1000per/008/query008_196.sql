
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '49459','45832','65732','44597','19102','79987',
                          '15358','87662','71305','67769','27722',
                          '23731','10221','45148','36513','56871',
                          '78198','54591','89111','95764','73176',
                          '26910','88247','19157','99373','24669',
                          '39210','50795','16202','58026','13234',
                          '92781','95382','40748','29443','42351',
                          '76006','91338','14122','49413','66261',
                          '94999','42886','96090','22762','82312',
                          '98228','98674','74353','48505','49014',
                          '46307','48772','99952','89617','21403',
                          '44862','20871','24803','81737','57578',
                          '61923','16961','41949','29195','42377',
                          '76377','95367','59949','86515','39724',
                          '33384','85154','20668','11825','93452',
                          '97406','22310','60705','46585','55947',
                          '52820','24968','59769','42190','14547',
                          '96161','73349','30525','83756','40672',
                          '52345','43059','84897','30433','88007',
                          '78966','74456','80107','89500','80831',
                          '25512','54378','49716','64904','74802',
                          '67212','34286','10192','64991','31866',
                          '58891','99361','12477','67116','52326',
                          '43533','15748','54683','68427','64453',
                          '46534','90794','24965','91121','83898',
                          '18784','15527','86566','89132','71421',
                          '15463','72505','86368','90820','97090',
                          '37980','18173','59407','43768','99857',
                          '23550','30096','33310','59285','26902',
                          '48643','74306','50300','56124','78213',
                          '74800','91326','53110','45407','30726',
                          '80911','73818','47715','83840','33010',
                          '65415','90088','84566','18187','10051',
                          '58447','52607','67378','16349','58004',
                          '45907','31253','95384','49501','97765',
                          '38979','26039','59355','91836','54391',
                          '17480','58470','73344','26757','16404',
                          '22346','21967','20423','46265','53799',
                          '59273','11009','95435','47492','67091',
                          '59811','68168','27979','23721','56642',
                          '15278','29292','93141','89256','29995',
                          '66005','69111','43727','86837','82742',
                          '43626','47115','80128','83481','32759',
                          '75552','34001','25803','28203','60681',
                          '29389','10459','94895','63160','94379',
                          '94339','42304','45011','10372','40274',
                          '92466','33197','81267','65017','92769',
                          '40129','37205','14174','53407','79360',
                          '23113','47889','56410','12069','59405',
                          '97604','91472','97579','33522','13584',
                          '25432','27597','27983','90439','88674',
                          '52017','77254','70530','92643','16456',
                          '61853','16328','80438','26874','10660',
                          '61695','58015','96207','71445','49080',
                          '20954','28294','18786','12133','63630',
                          '59145','45453','20296','94428','48467',
                          '42196','89967','77214','22999','33702',
                          '26162','24064','76157','99805','19228',
                          '39474','63196','62835','39682','42255',
                          '62668','47540','75671','28275','56735',
                          '55778','36367','22600','47814','11393',
                          '13476','68068','59133','23335','70803',
                          '95087','51952','51590','98204','25357',
                          '61371','53427','60402','55029','95958',
                          '75371','36047','54841','39410','59151',
                          '79293','61831','27866','95642','71833',
                          '66775','32190','50161','13693','85025',
                          '27899','41562','70421','20010','41107',
                          '61864','99713','75958','64416','50838',
                          '86608','84185','65087','55038','13996',
                          '25638','16936','28127','64754','94578',
                          '64493','44071','34583','99791','36276',
                          '22246','17093','87043','95148','95231',
                          '36580','82370','34673','33464','23081',
                          '73446','96201','94780','28979','89441',
                          '59068','69102','84504','99845','43482',
                          '39211','94398','67808','37647','91827',
                          '40267','83411','45831','78275','89923',
                          '96277','70900','34993','47384','25903',
                          '54861','84920','43683','74765')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


