
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '38156','50544','20322','52294','74812','49017',
                          '67452','95477','44922','95732','87256',
                          '81555','89048','15987','67256','14674',
                          '55784','44856','63942','78319','52946',
                          '54895','78454','49048','13478','74506',
                          '78508','27909','50940','95231','31347',
                          '92034','30079','51784','56616','25421',
                          '15357','36006','95078','19768','39743',
                          '77996','67634','72041','39881','94100',
                          '31748','30526','16764','53922','63971',
                          '62257','74448','12875','88834','55854',
                          '10254','53722','60604','73684','43781',
                          '71869','77480','17700','47485','62749',
                          '69893','41620','81051','24267','11550',
                          '65845','43993','58151','77685','42740',
                          '41998','83552','74978','29011','18988',
                          '53583','32127','16369','83266','44487',
                          '47948','79624','10641','38700','42467',
                          '17823','25571','12632','33167','56102',
                          '42436','40138','95233','76199','45316',
                          '29480','52809','65767','44367','83879',
                          '98662','70991','59485','57883','97416',
                          '46613','78681','69797','94064','33050',
                          '69759','28559','85968','77925','77906',
                          '78959','70814','36734','75381','49561',
                          '12013','81337','30522','77681','15824',
                          '67568','38088','57718','97983','50146',
                          '30238','81870','98093','90305','55334',
                          '79439','36877','50433','72769','70062',
                          '56880','25097','25573','37892','30277',
                          '53747','14000','21226','97805','89253',
                          '62757','40737','50858','84936','73063',
                          '74529','18699','89370','40769','17243',
                          '32775','70790','31890','65547','97502',
                          '47118','69901','57531','42517','50194',
                          '82917','13115','95186','46183','91176',
                          '46550','54943','39477','15156','54553',
                          '18385','38445','89827','97872','78938',
                          '74522','65866','32319','88003','44766',
                          '77646','97001','69775','88308','51121',
                          '77869','62975','19517','84122','49507',
                          '42914','68887','63087','20059','14987',
                          '80403','39920','38464','45833','18007',
                          '19995','25023','34432','50965','99602',
                          '87181','75231','28227','15811','95294',
                          '92152','14115','19114','91236','78700',
                          '94055','13975','96579','70707','89060',
                          '22428','70397','15220','47971','53656',
                          '47639','47407','73440','88719','73912',
                          '64741','46791','28354','27713','27757',
                          '93573','78312','30862','63490','32413',
                          '58777','16168','48578','78200','39402',
                          '24249','20217','71638','47176','62966',
                          '49808','29009','25493','46697','78500',
                          '67564','32721','19360','37990','16940',
                          '96382','15594','17191','48941','69633',
                          '50647','59621','98537','31555','96992',
                          '92623','95604','57721','84950','37622',
                          '98085','84925','22102','44683','98659',
                          '20249','39246','15318','72385','98037',
                          '63523','59360','41127','57088','26408',
                          '28444','68537','59370','26239','11495',
                          '13501','91483','69047','78854','11043',
                          '88564','94738','24929','72305','11802',
                          '56891','27256','62305','63221','82563',
                          '92241','78073','17085','73497','81727',
                          '98442','63966','84661','76426','25025',
                          '54294','31190','79978','85240','74101',
                          '62048','27103','22300','67693','39455',
                          '18347','84521','97126','41989','36138',
                          '27462','79037','16275','97863','73548',
                          '63022','43829','14781','95184','74484',
                          '27138','36539','23392','86075','32165',
                          '46664','73406','37551','12349','76359',
                          '46842','20500','71669','56463','62802',
                          '23200','71474','92417','70368','98720',
                          '47475','40015','63504','28211','93658',
                          '80511','85478','85671','76924','62798',
                          '90331','83751','46645','10302','27036',
                          '56672','19396','66975','15751')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


