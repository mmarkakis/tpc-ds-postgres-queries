
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '48726','57760','36040','24148','77863','48020',
                          '33973','15589','30180','23500','57837',
                          '89792','53792','21624','37374','29250',
                          '74303','28354','67985','90051','36793',
                          '32930','57623','61703','68943','46579',
                          '87494','75983','22079','49768','21841',
                          '81280','58753','82137','31753','61474',
                          '93530','94990','49762','96347','71923',
                          '80137','29046','16817','12114','80846',
                          '25596','64762','93228','80562','37516',
                          '34855','72985','60129','38232','85259',
                          '38178','96438','97418','17291','58110',
                          '86675','64628','80475','55291','67683',
                          '70535','58091','43874','79964','13297',
                          '62166','11980','44604','15756','60366',
                          '10258','10886','44895','70053','22180',
                          '67562','20910','14160','55264','24689',
                          '79752','97879','38252','52975','18635',
                          '66954','24109','69712','56378','89669',
                          '41945','56561','89562','54209','87681',
                          '11748','49873','92076','11576','56737',
                          '67102','86844','71274','31219','66392',
                          '96951','71671','65989','37735','52220',
                          '20458','30038','62968','24390','16986',
                          '23431','20145','57887','61105','25496',
                          '12999','35697','97192','74738','56496',
                          '46895','17817','81235','59302','16089',
                          '65506','58914','43095','81555','10148',
                          '73012','22841','15316','19532','86960',
                          '29593','90257','90642','31950','46940',
                          '22847','67093','10111','60117','60329',
                          '84235','80411','74655','43395','27300',
                          '70823','91332','68908','69938','16036',
                          '35574','87246','39594','85164','94062',
                          '54514','66961','51847','36016','60213',
                          '71648','17521','58365','11571','65912',
                          '60429','46565','68774','62517','16369',
                          '16899','67819','78510','94723','59772',
                          '14056','33823','36599','26074','40412',
                          '34786','92743','64398','78004','72634',
                          '44489','21265','83811','18180','56627',
                          '22068','15704','76273','59600','83414',
                          '49132','13185','96494','56658','28423',
                          '41222','91200','89442','68457','84884',
                          '67214','41141','31998','43320','67951',
                          '86455','52650','99867','65478','95514',
                          '57431','83401','41534','55917','45883',
                          '15841','24774','25628','29905','91891',
                          '54418','83208','55809','55631','16911',
                          '83658','75851','34143','20378','69738',
                          '56060','97472','59785','67917','59307',
                          '41965','32234','94878','97254','38317',
                          '63379','48933','56347','85514','20647',
                          '77037','87734','95067','70601','68182',
                          '21521','59971','64576','74630','65903',
                          '44914','84041','74314','91771','43276',
                          '77747','21823','78073','53403','60776',
                          '90128','70785','16917','92180','60778',
                          '45175','61332','68974','11343','67137',
                          '93544','84978','80197','89844','61942',
                          '65074','49999','96339','28399','50310',
                          '50579','72783','20339','35593','87376',
                          '77389','69490','94683','49968','72737',
                          '67891','92212','73140','50458','64356',
                          '16450','97575','20126','99126','23102',
                          '75166','72754','11735','56169','90673',
                          '98351','82242','61808','34671','35478',
                          '34116','52973','55212','69414','88296',
                          '16201','26770','12423','22136','98190',
                          '36422','97212','81695','44224','88017',
                          '63435','19608','21538','51135','59511',
                          '43304','21913','81533','84665','62607',
                          '45967','65226','43722','51753','57732',
                          '55326','44803','65439','92148','52539',
                          '85476','59798','42596','93664','17864',
                          '14391','46366','50001','45824','56185',
                          '93413','94722','35920','94052','42350',
                          '24142','40746','93789','86504','32647',
                          '62110','41092','26386','29890','45378',
                          '17584','71596','15319','87790')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


