
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '31373','71178','23218','88565','64850','38347',
                          '81867','86474','10904','85003','53099',
                          '98952','94681','15557','72923','75545',
                          '76812','87993','69635','21086','89026',
                          '60882','48654','71637','73003','16419',
                          '55758','82420','22009','32530','97913',
                          '62067','20934','61933','60612','49729',
                          '91576','74913','52757','43032','89050',
                          '61132','42691','19288','76661','68284',
                          '13649','32567','56005','77966','28287',
                          '94029','23251','68983','57572','59759',
                          '17573','47103','90568','20258','65322',
                          '52079','26440','76587','59166','79918',
                          '12183','10220','46234','78000','53177',
                          '32100','50750','40271','71852','78242',
                          '74325','76849','88984','33145','66389',
                          '56781','82722','46880','81788','93607',
                          '57338','20793','27876','63547','18805',
                          '58933','93829','52194','41625','38889',
                          '95027','79244','97204','20692','30560',
                          '32776','87456','56578','56975','29096',
                          '58319','59457','80539','31903','48836',
                          '89833','89767','99520','66571','72192',
                          '84966','41676','22024','96296','17916',
                          '98010','85578','43974','29646','58511',
                          '11735','95471','21742','51857','65659',
                          '37139','90599','19866','12827','68842',
                          '21075','61480','98850','24129','74732',
                          '84359','56858','36395','22859','15040',
                          '14118','63011','58995','94719','53162',
                          '10498','35453','84903','64429','65173',
                          '39012','98370','60406','20693','52508',
                          '61878','27120','82740','78987','21554',
                          '24452','45783','39489','27183','61326',
                          '58461','14685','14520','50491','92082',
                          '78256','96536','34219','25561','76891',
                          '49053','89323','19832','71404','29296',
                          '68451','24235','26295','35800','71872',
                          '91400','21995','61662','17880','23800',
                          '13457','75318','81385','24696','94314',
                          '10754','27979','72271','65184','68433',
                          '81733','67470','14156','81535','25744',
                          '58707','90824','61401','91994','56972',
                          '67145','73328','24676','68339','48684',
                          '82263','98866','46126','92659','95333',
                          '31648','13933','53789','38030','95914',
                          '61180','46993','31756','30164','40774',
                          '65781','70509','35595','95166','26008',
                          '97325','79005','16883','50846','59667',
                          '75054','15710','38873','42127','17949',
                          '79118','40429','88978','12478','27711',
                          '44173','37940','47559','31043','77509',
                          '71976','59944','98071','88608','37345',
                          '86219','50302','72261','10013','75662',
                          '33763','29451','12230','69667','38108',
                          '24970','80873','96212','27777','53704',
                          '64628','90722','64840','88748','99613',
                          '11245','92890','58519','53614','90911',
                          '64031','49619','14014','60345','38919',
                          '62129','77138','25990','97537','17733',
                          '41898','82689','97449','40613','20139',
                          '97897','14725','64668','29865','10050',
                          '25098','84666','42227','64141','55170',
                          '26275','50552','54639','38228','52924',
                          '46917','27794','15723','21331','72320',
                          '70500','65215','69742','55518','47168',
                          '59875','22307','21705','95047','28146',
                          '31921','28453','11078','18718','93891',
                          '28223','37922','80129','81380','49003',
                          '30842','46674','24811','50009','78572',
                          '89144','53919','99439','46043','35865',
                          '93922','66016','74232','93995','45560',
                          '23633','75154','22180','65344','21567',
                          '94565','86984','68478','25803','97876',
                          '80795','98123','40264','76034','57922',
                          '47839','39204','62985','20839','17815',
                          '27079','82587','96327','36583','63740',
                          '27395','99883','28264','81750','39972',
                          '75653','35869','32796','88575','48109',
                          '18587','56412','64288','19553')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


