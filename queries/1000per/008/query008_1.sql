
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '94211','79992','17147','73350','95552','95964',
                          '55561','83503','95291','81886','67803',
                          '14005','15352','35939','69788','69465',
                          '26210','94717','45717','20504','90727',
                          '73919','46409','31148','78856','51952',
                          '56658','59186','20236','39664','25479',
                          '78594','77585','48999','26659','40979',
                          '73998','58749','32169','88111','42206',
                          '17735','61235','40770','90216','73431',
                          '50635','94649','28503','62223','48465',
                          '98660','88750','62881','71150','74395',
                          '65573','54385','27053','75005','87100',
                          '46144','45752','48173','56128','44719',
                          '13165','47448','46589','98083','92734',
                          '59191','46743','32303','80247','49119',
                          '87663','28609','27220','75773','36942',
                          '88769','31029','11970','65289','54157',
                          '39828','16573','76507','11253','86979',
                          '93912','46157','41126','73708','43288',
                          '84025','93128','25843','83277','97822',
                          '12152','60970','20713','52014','13766',
                          '12054','67524','33300','81540','48540',
                          '34617','13904','20941','94950','41828',
                          '25750','42074','23769','80831','69469',
                          '94240','81975','91729','70390','66360',
                          '31770','51726','21985','90413','37770',
                          '89417','36432','11876','30715','40941',
                          '52138','25940','18308','41432','27325',
                          '32918','25864','68460','82185','33659',
                          '50905','45481','23148','84826','23289',
                          '64959','33374','75583','98214','40895',
                          '60252','68911','86559','47921','91792',
                          '21767','16714','36192','57781','23460',
                          '84556','95705','56373','34965','71858',
                          '67078','73474','83617','62740','31550',
                          '74359','90454','61357','79723','62749',
                          '69805','61783','48116','67366','32388',
                          '58504','99336','74644','85173','46041',
                          '28570','53752','44252','54305','67674',
                          '86596','97055','37196','54915','18790',
                          '32477','91830','24899','30659','69429',
                          '95386','41803','68146','90045','16572',
                          '65641','19959','43400','65967','11384',
                          '57058','73504','95723','95544','79738',
                          '52586','35436','39511','90114','67467',
                          '72042','93043','36460','68016','47066',
                          '36386','50886','59969','67561','96727',
                          '38794','40261','99622','68122','79229',
                          '61578','93750','79261','55336','34752',
                          '91425','74438','61232','39795','62410',
                          '39956','60094','57080','31815','35656',
                          '94130','65256','50034','96324','55887',
                          '69118','50706','19297','64728','14124',
                          '28972','68872','25699','61631','43656',
                          '84696','44847','55497','84007','53896',
                          '33193','63127','50002','92416','82870',
                          '72477','74061','97137','55994','26823',
                          '52147','78636','82211','29813','55691',
                          '54536','38580','60289','80266','81486',
                          '37739','58338','73713','16747','96061',
                          '29870','50644','69262','22387','58433',
                          '55314','60475','21391','14081','11028',
                          '69126','12943','68242','61807','55397',
                          '30981','49541','49422','60652','59552',
                          '44648','52906','74398','53160','27696',
                          '35803','19865','86380','13454','20648',
                          '70423','69100','45747','53046','71352',
                          '47386','23475','16902','18566','59929',
                          '28020','41953','59232','91434','57898',
                          '73452','76395','87527','46974','97877',
                          '20274','69056','60363','38187','10194',
                          '31880','18201','31666','38224','81782',
                          '62771','49892','17579','80473','80507',
                          '92101','93259','65722','30057','61776',
                          '38037','65719','66683','44040','48584',
                          '62751','90127','24971','44330','65895',
                          '29111','55957','53417','87081','11164',
                          '40693','48761','34746','11925','59373',
                          '61194','29863','53584','94406','86488',
                          '23160','66428','40619','14250')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


