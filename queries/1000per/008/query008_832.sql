
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '27088','65337','18854','58873','88728','58199',
                          '89400','74069','16592','32610','53987',
                          '62110','48949','65583','19322','70103',
                          '56612','80584','90463','59701','27534',
                          '91563','55251','47109','12592','85595',
                          '13051','48466','52499','32101','98649',
                          '11172','88845','25526','11281','58896',
                          '49853','65678','63887','44177','77770',
                          '32508','54422','30023','57031','24972',
                          '29768','78393','79728','64386','67467',
                          '35418','53877','72379','89340','51313',
                          '34498','45716','46013','84906','49264',
                          '56055','71221','10571','27342','36319',
                          '80024','61289','28746','18314','79222',
                          '16934','71341','38959','97008','36842',
                          '42472','24529','49279','93227','40462',
                          '10990','17720','26866','19264','38398',
                          '34349','23901','83394','57906','19601',
                          '68290','89532','81242','87477','81222',
                          '42987','93371','63935','34982','56278',
                          '73729','84750','31377','50935','47060',
                          '28836','87655','41693','99391','64656',
                          '70863','16036','15529','12809','44499',
                          '91522','36500','86344','39666','99839',
                          '34158','36259','83866','78859','98192',
                          '38987','40025','76145','47405','11408',
                          '36015','47926','73829','38157','49774',
                          '58663','80850','23514','28215','81990',
                          '52730','80233','62612','37509','36978',
                          '23525','92928','40070','50724','64522',
                          '37229','37005','27072','85421','19738',
                          '58769','91897','70102','54621','78032',
                          '96101','38830','30218','34017','75337',
                          '91720','88116','37368','87692','65014',
                          '67093','96660','50915','11035','46612',
                          '21301','65533','55314','98128','87770',
                          '46569','39729','96530','85068','36661',
                          '86212','99052','10779','90324','70994',
                          '12475','91322','75675','47462','73088',
                          '19243','57294','41021','22705','38563',
                          '93853','80143','60664','86456','66047',
                          '63177','73481','67870','69003','95341',
                          '85737','83240','92655','79078','93362',
                          '87820','85599','86463','29692','77319',
                          '65022','82163','75843','77474','56415',
                          '44065','84687','79605','51417','80779',
                          '85123','37194','73557','17625','47568',
                          '64369','51524','79200','10883','95742',
                          '46810','70078','16524','74891','63848',
                          '76618','24891','31732','14879','72830',
                          '93645','22183','28089','55787','91103',
                          '91917','98556','38441','97721','84689',
                          '52957','26533','25643','93525','13060',
                          '34566','20147','57203','46119','71654',
                          '59679','26151','47013','15245','23428',
                          '95034','97009','53376','12104','71330',
                          '15413','53183','33805','35857','50113',
                          '91727','15459','36042','15976','20754',
                          '96022','71796','77947','70288','46396',
                          '79833','18101','45551','57552','98070',
                          '14945','14471','13936','58569','52311',
                          '99054','80604','49927','35718','41167',
                          '52273','84144','40955','59279','80978',
                          '25671','53028','65655','48917','84087',
                          '29719','89080','19455','17440','85520',
                          '66574','62831','63377','22843','75437',
                          '41894','69624','66533','52180','14562',
                          '67247','87890','10254','72074','13296',
                          '59487','55636','79549','98516','37193',
                          '50653','29862','98581','75520','89036',
                          '85872','13945','21962','51240','46077',
                          '80381','81961','32025','36741','35080',
                          '25487','40453','15256','16489','87553',
                          '83631','89898','60724','12926','50038',
                          '55884','23265','71081','55349','21415',
                          '79426','39490','89968','18561','31248',
                          '41606','29401','46393','49197','39470',
                          '96648','46811','71666','29449','63128',
                          '24153','68857','20562','34662','12458',
                          '79985','86725','81945','29314')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


