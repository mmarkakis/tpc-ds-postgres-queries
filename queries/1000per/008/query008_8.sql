
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '77661','12172','48633','30522','77516','47593',
                          '42736','13431','60328','51004','58830',
                          '73231','71595','92456','44605','64787',
                          '50000','56786','59080','41562','41317',
                          '26178','77460','24505','44648','61157',
                          '13884','60939','92187','63308','18653',
                          '73267','76681','88231','91314','74382',
                          '75606','29255','83554','46014','65895',
                          '50527','19535','23406','50114','61466',
                          '71101','73924','91310','84787','45297',
                          '25515','68057','15152','86347','88689',
                          '86473','50762','73297','21927','92168',
                          '76750','42285','63085','87127','94952',
                          '35208','42352','86699','98853','55431',
                          '94022','59292','39267','10988','14027',
                          '88033','31548','64656','64512','18602',
                          '10987','11720','55625','19973','52110',
                          '62644','78897','99512','66942','53325',
                          '70523','75029','18193','47516','96854',
                          '81962','81713','91216','29121','80380',
                          '40713','15209','50902','22005','14580',
                          '29238','73890','30936','29189','97505',
                          '24818','64230','91895','38383','19044',
                          '38267','16085','52139','48122','95943',
                          '13984','64043','14978','49016','97128',
                          '93772','14165','91610','38123','34007',
                          '69476','76457','72132','21390','47749',
                          '37146','84573','63802','12827','60529',
                          '76981','57559','23016','93676','56982',
                          '86490','36898','92619','33273','51562',
                          '35923','10366','78029','60253','22718',
                          '85212','15723','61055','79099','22567',
                          '45156','61470','66324','29587','34043',
                          '34227','53678','21955','39619','75643',
                          '51511','40586','90275','44572','42544',
                          '43791','13860','44862','39928','87728',
                          '94568','34480','70964','98578','44326',
                          '45839','66931','42597','98820','52995',
                          '72960','70171','79195','16334','65832',
                          '58766','29846','57002','28957','88020',
                          '43307','50922','38774','15259','41193',
                          '61960','62508','35487','26330','45824',
                          '92253','23296','68030','31515','19769',
                          '40502','71085','54574','36213','56352',
                          '55190','82114','73270','48477','41413',
                          '30645','42093','78603','91322','51853',
                          '47847','49129','26639','45520','52677',
                          '85032','79762','83843','37492','88618',
                          '21246','61452','27527','35458','95902',
                          '31273','62479','46299','80444','99543',
                          '89604','86602','89989','97557','95208',
                          '90174','47678','29040','40582','96188',
                          '87296','81077','14110','59332','79030',
                          '36974','87957','31422','74945','73824',
                          '77574','34618','80026','75507','70507',
                          '48515','95175','76862','42324','92637',
                          '88631','87734','88877','49347','86828',
                          '95755','77909','41381','35294','20519',
                          '64833','22968','87085','53177','89833',
                          '59398','17607','20589','38856','45237',
                          '61536','34481','24375','96936','46029',
                          '57685','35229','39688','50903','41271',
                          '89837','76868','97935','65752','46213',
                          '25002','88792','76658','84635','23513',
                          '93300','49474','62205','45199','38889',
                          '63170','62794','92784','55129','89426',
                          '18462','89987','14644','98666','97414',
                          '65282','25277','34067','12478','78150',
                          '46564','60063','23990','74238','16654',
                          '91228','28010','67934','82207','79409',
                          '52936','54861','80268','74848','16098',
                          '87271','71472','29436','70919','99727',
                          '50661','25684','60808','36672','78116',
                          '75339','12832','86047','68857','14486',
                          '41324','54118','84326','35624','19798',
                          '56221','75850','72679','66290','55722',
                          '48721','91406','39882','46691','10489',
                          '53674','62555','64484','70113','67138',
                          '87273','10558','79037','20966','84340',
                          '52873','91404','53064','57042')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


