
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '44880','33785','25831','55714','72301','85278',
                          '11571','49404','99534','78105','10370',
                          '36357','47758','40922','33953','57709',
                          '79405','15391','43785','89297','54988',
                          '36325','81473','28387','63001','31773',
                          '92047','42003','51656','57646','91472',
                          '66932','84716','13645','26049','77293',
                          '20370','75750','46728','67172','43238',
                          '94646','22401','41572','82493','56294',
                          '89568','68350','80787','81394','84311',
                          '56560','82335','24960','92850','21787',
                          '12551','65643','97426','36174','95335',
                          '21387','23271','57317','38447','51536',
                          '38094','70312','31689','36114','81235',
                          '89718','68189','20103','27149','28760',
                          '76095','62679','63239','51727','42900',
                          '39598','80716','96304','17299','13112',
                          '54562','67764','16416','40992','63890',
                          '61525','30150','46103','12451','28958',
                          '74534','18225','97008','16929','32529',
                          '42090','27594','38369','92190','19423',
                          '22889','39921','39420','14827','76470',
                          '88224','94234','27521','99543','15732',
                          '23518','10586','50706','93447','58181',
                          '60485','69970','91267','27324','76721',
                          '41550','43158','31099','58389','44701',
                          '11160','53627','26701','25703','43501',
                          '40990','13979','89059','30151','60730',
                          '13174','82965','41202','27903','37937',
                          '49208','52551','30348','96780','66003',
                          '94996','44270','10878','45240','72151',
                          '95057','20803','51156','43442','88823',
                          '83825','39013','63499','43537','18162',
                          '91591','10950','26184','64651','74886',
                          '12967','81933','46220','59523','52952',
                          '83633','54940','60287','90869','86745',
                          '57205','74329','83411','94015','52754',
                          '79799','59258','37237','47754','40981',
                          '17900','57015','91289','65185','34564',
                          '61034','12248','64084','17587','54238',
                          '42921','88954','68130','86520','25711',
                          '15793','70180','93775','97629','88982',
                          '35988','22414','25761','25910','47559',
                          '11710','90410','60608','73482','33490',
                          '88285','10008','20266','83764','20513',
                          '75461','94600','94160','82665','40779',
                          '17835','76768','58906','72059','43918',
                          '52529','83150','77377','71857','56799',
                          '93800','95164','29624','62448','57442',
                          '45189','39280','21294','29248','13195',
                          '73801','41154','27930','87232','75241',
                          '72629','77912','70998','24598','60431',
                          '24904','47918','98593','25998','76973',
                          '89738','71462','78781','13454','77309',
                          '75185','59779','71088','39127','54156',
                          '71136','26223','71431','58603','66360',
                          '24158','76858','99726','16165','77813',
                          '44077','23905','45734','67900','62248',
                          '47280','23523','71840','44914','56226',
                          '45077','15205','39085','46823','24099',
                          '36241','43714','76641','74267','65566',
                          '16291','97913','87150','53655','84583',
                          '25318','28988','87827','41836','64708',
                          '30802','89280','29307','96881','15348',
                          '97316','83748','61460','10253','79165',
                          '97776','66953','92729','37307','25945',
                          '91998','95911','95047','14520','74731',
                          '99850','32608','41771','67203','88760',
                          '23765','65609','48546','58259','87723',
                          '52956','66145','22144','89600','15338',
                          '12688','18746','39144','35273','73070',
                          '73103','18587','99675','50893','18513',
                          '40892','53379','79540','66726','73818',
                          '76029','90675','97517','26531','81443',
                          '64489','14921','83102','72476','46299',
                          '47219','39287','13061','63026','49976',
                          '67782','15349','27120','50969','98903',
                          '92644','18199','56916','64905','90393',
                          '82099','32491','96213','70551','48793',
                          '77475','52504','75422','86049')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


