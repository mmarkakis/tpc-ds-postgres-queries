
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '66937','73596','15282','35093','75992','98197',
                          '31525','93943','15621','18301','38111',
                          '81618','26653','14827','32120','21389',
                          '43880','70330','64336','42280','17763',
                          '98312','42424','14430','57617','91781',
                          '94117','40198','84572','99196','93045',
                          '97511','54078','64147','16484','16299',
                          '74028','80926','83642','81108','49566',
                          '23796','48506','32954','71297','80111',
                          '62394','14493','33142','23079','59380',
                          '93176','87834','43799','61751','99110',
                          '59299','57785','15537','14978','62159',
                          '82252','29337','27213','22569','84996',
                          '42332','32407','93819','69820','89909',
                          '10831','31292','33058','81613','41435',
                          '11878','34412','60059','53270','47477',
                          '29953','49022','58054','96832','41883',
                          '82750','11318','28387','28424','56889',
                          '54317','70705','42223','10084','29922',
                          '11015','52047','63317','83785','46560',
                          '96660','19851','11922','66875','89672',
                          '72595','71963','77787','85483','16695',
                          '73755','86523','99105','88002','62809',
                          '79951','63219','67346','24767','61279',
                          '17727','52960','56705','62172','88176',
                          '10787','11559','10559','96935','94341',
                          '39699','73255','36792','57117','72262',
                          '48150','65940','68773','35012','26947',
                          '98228','81589','46512','30007','68470',
                          '86547','13063','32099','78960','70402',
                          '95779','95919','23870','99161','69051',
                          '73694','38623','66632','19125','79253',
                          '79701','46311','33622','38175','15076',
                          '72510','82038','85566','30902','14179',
                          '50460','15926','23486','59107','59073',
                          '30354','49882','75672','19791','80019',
                          '36544','57501','91863','95992','48702',
                          '52229','67042','59908','14730','61455',
                          '19487','63361','50175','99206','73032',
                          '58603','52248','40655','99541','87060',
                          '80628','29567','48182','70614','72627',
                          '90527','83659','20390','26731','83970',
                          '65549','24313','46191','24289','66641',
                          '48578','34573','22513','52812','76717',
                          '33894','57616','82224','19893','86135',
                          '88351','98667','34929','96790','43747',
                          '14241','57947','36817','49202','33287',
                          '82145','26419','47077','28104','36721',
                          '54269','73468','73522','85986','44172',
                          '51685','22672','10530','30214','51013',
                          '92542','88238','62267','20477','38548',
                          '37098','52102','74372','98368','13350',
                          '93255','37596','94337','26662','62371',
                          '40702','45889','73863','56274','68104',
                          '53824','63298','10560','17074','26869',
                          '77058','91099','93417','65975','98915',
                          '67331','29851','56666','87353','24120',
                          '46710','85705','21302','20057','32037',
                          '71401','77438','80608','15851','49471',
                          '44470','83051','17688','33691','10230',
                          '67553','84052','75804','73728','85063',
                          '11030','96273','92971','58382','47319',
                          '34382','88183','73172','23868','85964',
                          '36859','31673','57131','14777','47232',
                          '61362','18159','62246','23494','63039',
                          '67549','42539','14096','40632','93698',
                          '24833','48327','97676','72173','33457',
                          '69622','60290','26816','58893','21862',
                          '59533','52807','29813','61720','87462',
                          '75268','90423','89181','69905','40937',
                          '10879','76101','46455','85794','39540',
                          '49363','14423','12276','43148','34051',
                          '95384','21469','19193','98591','75586',
                          '40729','25501','93121','51633','70766',
                          '85330','83868','24879','11994','67529',
                          '36569','32264','18614','36350','57147',
                          '80541','49692','18736','67151','64861',
                          '42693','71629','92077','81573','74424',
                          '45316','31622','67591','72680','81431',
                          '58585','65703','95419','79904')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


