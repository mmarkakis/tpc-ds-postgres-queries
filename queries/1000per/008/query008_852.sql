
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '96860','13218','10289','30491','19715','96344',
                          '72405','45149','41302','92875','55262',
                          '70063','26800','90890','72921','48865',
                          '82440','96742','29830','26316','35995',
                          '51967','73276','80556','99023','25412',
                          '47784','38907','44597','67371','54993',
                          '87090','89869','23959','12252','55945',
                          '81539','91484','87013','61319','44099',
                          '98607','26756','68091','25263','96789',
                          '31182','42427','36007','79097','78953',
                          '36773','96693','32756','71661','94288',
                          '47036','68852','38448','19730','21462',
                          '10733','53041','18065','28681','68557',
                          '99386','80997','76741','26026','63880',
                          '52078','63985','81294','40161','91180',
                          '22130','30981','60765','93305','24696',
                          '50092','61994','11308','31245','10961',
                          '75018','20778','23156','64880','90389',
                          '73519','26058','18887','96006','57568',
                          '75114','77685','92324','65023','32199',
                          '58552','51590','64679','77272','97192',
                          '87213','97025','68252','67154','72243',
                          '25760','43106','39209','37441','93327',
                          '85418','60173','18119','22589','23678',
                          '24713','51809','18841','79711','51197',
                          '21431','33449','25585','11981','48828',
                          '50452','60658','52888','94323','55285',
                          '62022','63885','81618','21930','92724',
                          '64236','54673','17480','41146','44149',
                          '47760','65263','87980','49287','81446',
                          '31109','80153','50609','61041','50815',
                          '29999','58896','77909','15376','16391',
                          '89391','96976','63999','92120','26164',
                          '75994','80663','64950','55433','62727',
                          '44940','93564','71299','63571','67842',
                          '23982','39729','19035','90220','93665',
                          '36154','64750','59819','43293','93156',
                          '37684','12018','36756','79837','65597',
                          '94464','91098','77593','21394','98936',
                          '90271','47614','87396','75408','14233',
                          '27849','98041','97570','19544','74402',
                          '77692','72164','38128','47362','60863',
                          '38265','94387','10288','12572','55552',
                          '59493','22459','85922','89310','10771',
                          '23054','34782','39482','61455','88756',
                          '24505','24882','36307','37249','91780',
                          '79187','64172','70298','70360','13576',
                          '18568','33472','23820','56509','70233',
                          '75546','57666','60558','83325','25167',
                          '95484','48627','96532','14954','76792',
                          '77694','44993','38983','83284','68743',
                          '78461','91181','52501','18060','72505',
                          '51360','39038','70922','42840','34438',
                          '75891','46179','28082','76542','15927',
                          '55095','39927','58787','40585','32432',
                          '84966','19736','62426','96997','72558',
                          '17403','49595','33128','16427','35880',
                          '49449','22220','75137','26973','43559',
                          '35144','43782','82530','32641','65578',
                          '57724','89018','17925','24875','54620',
                          '78984','54460','71510','23679','17128',
                          '23613','96819','98403','31483','45358',
                          '94597','44058','75719','96900','85675',
                          '92382','24551','75687','10901','14844',
                          '63134','88173','56211','19085','30851',
                          '90896','21923','74228','98945','21943',
                          '81450','59688','31140','28771','98057',
                          '70412','49369','34529','57784','92940',
                          '29218','51258','53617','52212','19535',
                          '60635','97631','30062','43123','34494',
                          '98465','70849','44266','23597','72993',
                          '33428','46025','76578','91950','64169',
                          '30416','77764','77101','71383','21443',
                          '26290','69644','66615','88405','71893',
                          '90148','50615','28316','15857','99221',
                          '76089','91141','60643','83465','83681',
                          '21337','98711','95629','45081','18483',
                          '13907','40328','16530','17443','90821',
                          '59265','13222','63122','74219','78368',
                          '82630','58222','62150','87607')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


