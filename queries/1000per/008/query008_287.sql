
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '20700','82640','97548','99273','35592','61437',
                          '97123','97314','54071','84232','13032',
                          '66973','35940','35764','70276','91369',
                          '93344','44551','57673','76868','98727',
                          '96063','31699','15637','78215','92235',
                          '56414','29813','31281','87888','61246',
                          '94925','34458','90618','90530','46993',
                          '47466','27355','27335','65075','69185',
                          '34660','83512','90281','58706','37088',
                          '76644','93733','33267','65499','75718',
                          '58775','92849','23156','85676','66191',
                          '89710','78704','23268','83219','93707',
                          '18118','10408','62402','45438','33245',
                          '90248','10518','58513','95758','61100',
                          '50777','67958','49647','94405','32494',
                          '77919','98073','96729','70284','32170',
                          '42531','90121','75609','57369','70451',
                          '29474','40727','58091','15352','22936',
                          '70651','87563','52058','26098','45760',
                          '62642','62282','58383','85568','90191',
                          '27091','61446','41390','74733','56824',
                          '89575','67179','15744','70639','53187',
                          '53040','66068','27520','21356','32571',
                          '40505','16384','81209','97286','15165',
                          '48299','90999','60713','55858','61730',
                          '13490','81642','32219','31343','46268',
                          '10019','71397','21045','31341','70112',
                          '68707','13245','54247','55348','80570',
                          '60273','21072','42475','96674','29674',
                          '27358','76527','47450','25588','19702',
                          '70559','11685','67414','75250','26027',
                          '16254','41466','60749','21889','91604',
                          '22559','31673','67168','24732','84564',
                          '81378','25497','53906','50268','46282',
                          '58047','64916','23684','52301','10383',
                          '72174','25565','23618','29223','71618',
                          '89624','59610','60304','60146','65092',
                          '33065','78230','96850','29652','86981',
                          '50577','93618','71471','57792','42344',
                          '71468','25430','49373','15954','82043',
                          '95624','97788','39435','84172','82241',
                          '30468','31422','49779','23200','29625',
                          '28712','29419','45665','18141','62658',
                          '55009','73825','41440','61085','66165',
                          '59950','39263','44634','14961','10273',
                          '87604','52026','54708','62429','19798',
                          '29757','31347','79833','14418','75362',
                          '21389','69040','91529','90696','18385',
                          '58478','29305','60262','88253','98302',
                          '16776','16691','90364','77331','20031',
                          '30687','41490','39830','83807','19456',
                          '71806','42311','63151','53143','47174',
                          '82344','39777','48579','25451','41404',
                          '43657','17488','87415','70785','87306',
                          '86044','88065','28744','12501','12674',
                          '54079','67012','34809','90362','26967',
                          '40666','22566','20158','94487','58526',
                          '59410','27250','33963','37819','53142',
                          '40789','67006','29928','78970','54843',
                          '72152','96983','64276','55175','26271',
                          '17570','19653','38959','13509','26717',
                          '24775','71766','23003','82856','73508',
                          '62303','65375','51623','49273','42247',
                          '43261','44358','30975','77166','93689',
                          '85867','57435','83418','89486','88521',
                          '76364','50260','23012','44893','73628',
                          '63519','84205','21302','87371','44481',
                          '13890','66540','82691','63392','10671',
                          '51406','21849','78175','84309','36719',
                          '76106','62530','45098','82792','30462',
                          '18690','83151','97063','27946','16249',
                          '39958','96585','42842','36354','77175',
                          '38888','48048','68498','67038','47863',
                          '69159','93177','22767','16484','18682',
                          '73794','91062','50409','20942','56406',
                          '80909','51779','62296','17593','95736',
                          '19748','23647','64589','51802','74470',
                          '25622','30391','60441','69212','78979',
                          '67950','64111','75529','47039','23370',
                          '45050','18544','49418','44337')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


