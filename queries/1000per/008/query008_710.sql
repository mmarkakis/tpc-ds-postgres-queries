
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '63910','57281','80297','23587','49231','24362',
                          '56707','26968','26212','42419','38178',
                          '23534','76439','32000','63111','74328',
                          '78931','85625','44474','95810','31086',
                          '29460','77202','38897','82363','45007',
                          '87577','90248','45674','10794','60610',
                          '68111','28587','10820','45681','94169',
                          '44576','50431','73819','40295','63537',
                          '83712','70826','27238','53728','90435',
                          '86034','27426','49756','52584','40522',
                          '90282','75753','99997','14276','20446',
                          '79768','30696','98644','28790','40507',
                          '86345','32022','84347','38250','81465',
                          '55809','23339','69176','80168','83280',
                          '67108','88628','78117','88335','43025',
                          '97491','25606','21299','67693','69670',
                          '41232','41475','33656','46104','74474',
                          '30534','73787','53039','92487','78952',
                          '46554','87399','16576','75512','13527',
                          '34510','48746','67714','70382','26000',
                          '69713','45139','55215','44041','87694',
                          '93189','47170','65820','72700','48991',
                          '22292','48874','97691','92463','31656',
                          '69395','92391','48526','67560','18329',
                          '13349','28514','43239','51409','37261',
                          '56749','88468','24235','18170','53081',
                          '69619','20954','78814','84809','20208',
                          '13632','89684','13902','30083','47801',
                          '25251','40924','83380','34744','46041',
                          '17932','43267','84856','20717','73012',
                          '29561','14947','81935','71376','69799',
                          '63636','76470','76370','71817','80710',
                          '72497','35847','60140','65580','87902',
                          '53299','90241','67490','53775','27525',
                          '96810','36565','51464','84071','63741',
                          '92678','54190','26692','83570','88397',
                          '71416','73025','58786','29445','65629',
                          '40970','24489','15005','83758','52930',
                          '26854','31116','42968','49939','96587',
                          '99864','39535','79490','22934','87102',
                          '23174','86428','16772','63317','10940',
                          '46316','36918','53916','93719','46901',
                          '88238','10327','12145','57881','54270',
                          '54924','11285','96707','55379','52202',
                          '17860','20689','24301','63584','79813',
                          '39192','44853','41379','76471','76011',
                          '94115','20481','92295','67453','73653',
                          '24206','57099','64109','34708','32164',
                          '45871','99077','14668','26469','48439',
                          '36786','17797','26165','87349','21614',
                          '12983','92408','50736','49663','33513',
                          '30480','64643','45738','45521','12870',
                          '23811','32556','20872','14572','86505',
                          '47809','36970','40609','40937','56811',
                          '59375','62420','25277','11615','29993',
                          '76631','46914','83256','94360','65619',
                          '32539','70682','90698','24634','59217',
                          '23238','82610','22445','43225','42119',
                          '79404','42757','30166','85341','25564',
                          '70163','88179','59603','74283','13005',
                          '46417','31211','87864','88106','66742',
                          '64514','49076','99253','40908','48842',
                          '11534','21538','75166','86106','47966',
                          '30203','57204','95849','70053','64032',
                          '80537','36288','99008','99958','49815',
                          '22682','72466','30105','44245','61532',
                          '58381','40528','61530','10030','29349',
                          '18200','67275','60475','86903','88559',
                          '30573','24655','53143','21323','86157',
                          '36261','92513','90452','82151','75248',
                          '20514','10616','89862','38205','16536',
                          '37025','71207','27292','36498','41189',
                          '69532','95490','67264','81336','53488',
                          '62083','74434','70607','42465','36415',
                          '99930','65463','85897','82569','14314',
                          '66127','36307','38581','82719','33103',
                          '11767','29923','81765','94669','35609',
                          '77980','96425','10916','92101','69856',
                          '79714','17402','52912','64750','84878',
                          '55675','40905','45160','83258')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


