
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '28619','69493','38392','81050','55533','24579',
                          '46100','85151','93319','58285','39653',
                          '60470','60472','56806','71747','17753',
                          '69175','43494','57804','25374','79169',
                          '40990','10861','73253','22254','80414',
                          '21081','21574','54784','19468','28034',
                          '50346','29040','63577','82272','61616',
                          '74074','93639','30912','65958','63887',
                          '60201','63314','93996','93928','69906',
                          '89836','97610','20891','76448','72451',
                          '83110','43242','89993','17119','21561',
                          '82564','30761','92272','20806','38747',
                          '66436','94818','61958','91608','74981',
                          '45743','73163','55625','24010','59214',
                          '73448','25045','36043','19683','60429',
                          '96982','69082','79143','12282','35120',
                          '49353','75224','81547','50774','42332',
                          '95971','32764','97406','16789','48059',
                          '59748','61751','35677','57107','94729',
                          '62479','93938','78198','64559','18886',
                          '50943','84365','19782','69014','63278',
                          '92898','48042','15857','44251','83519',
                          '67292','72816','82496','33724','58613',
                          '41176','77536','20404','15251','70052',
                          '69655','69191','39354','55056','97703',
                          '33675','71733','76766','11460','39574',
                          '97117','56334','43186','75417','39626',
                          '67649','63968','67664','65796','58405',
                          '92117','41224','32744','44141','62038',
                          '83847','48850','58676','57658','74841',
                          '92996','98133','88124','97801','79084',
                          '30629','46431','53788','22959','85033',
                          '10459','92694','69710','15695','54317',
                          '23954','39603','52095','36401','46019',
                          '45225','19012','20640','97130','89375',
                          '19420','22053','94108','45557','44648',
                          '93216','69330','57574','18133','92623',
                          '25679','62518','39657','90791','34727',
                          '76173','91404','12496','23454','45974',
                          '96942','36897','44805','98297','81899',
                          '49974','38297','72535','31252','97707',
                          '36531','62286','29989','54086','71778',
                          '28293','19654','11776','43359','82742',
                          '96189','26598','57921','23906','38203',
                          '15231','40709','23823','92173','60477',
                          '49821','75961','29653','74445','14919',
                          '87243','12384','65184','65572','10940',
                          '14865','13876','65137','62126','48658',
                          '68923','55367','63750','49154','43430',
                          '17636','30477','80842','98257','86335',
                          '88666','74902','64082','74745','80173',
                          '47722','46474','23126','95684','99845',
                          '30694','75840','76660','78258','50927',
                          '89219','99220','16374','41314','63071',
                          '51739','74060','49747','41454','10359',
                          '34308','20781','98664','77750','48146',
                          '59377','72178','79387','42420','67051',
                          '70869','25704','18306','52959','66511',
                          '45492','80668','31376','75758','42653',
                          '18003','24001','63757','31100','32237',
                          '36546','48201','45459','29725','71822',
                          '61523','96945','21828','92126','91522',
                          '16765','94298','38457','14688','41797',
                          '14319','59038','79629','90264','70672',
                          '90863','54886','39860','39648','77538',
                          '85961','88311','96033','35468','30609',
                          '54149','80232','85618','18830','58263',
                          '99052','66074','61902','40936','21641',
                          '32101','11128','13894','25253','64551',
                          '90772','82091','28093','42973','71872',
                          '70870','74064','49303','13984','67666',
                          '67617','42608','17061','69943','46379',
                          '88049','35186','30406','46540','84165',
                          '96463','78081','78057','70139','89963',
                          '60001','96669','13377','99682','13618',
                          '52822','65888','46547','93430','33782',
                          '85006','90237','36684','75500','57254',
                          '95923','78885','24703','77604','93131',
                          '95331','91627','89152','67005','75178',
                          '45747','44348','61273','13915')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


