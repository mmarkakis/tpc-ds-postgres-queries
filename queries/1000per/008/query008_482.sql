
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '81471','76677','19664','50908','14162','92001',
                          '77695','59846','54057','46569','52727',
                          '10338','53044','11325','57912','28528',
                          '27624','67124','76644','99277','61286',
                          '71088','21657','28234','59172','11124',
                          '47993','14901','74343','19563','78261',
                          '18583','78011','35812','40743','13581',
                          '76753','61114','37107','56974','60120',
                          '35977','22158','43411','35141','74066',
                          '14385','30949','18603','59005','75851',
                          '29972','73110','47628','54412','65752',
                          '90569','48244','76396','19385','11229',
                          '87788','42666','81232','83304','21833',
                          '45120','58376','51074','71275','51054',
                          '34685','62043','89314','38813','24414',
                          '66541','65733','68846','22310','36946',
                          '38581','50569','50149','41236','34759',
                          '75069','96668','79657','40799','92588',
                          '93042','16007','84527','96206','21718',
                          '73205','63357','43035','61055','62058',
                          '98195','28481','29322','29440','33460',
                          '98350','37649','94044','64652','81301',
                          '95058','43637','46370','79470','26439',
                          '96657','18952','52754','83825','62279',
                          '90564','97013','54642','63823','36813',
                          '93886','18194','67602','60340','19663',
                          '23451','29178','85245','10795','17404',
                          '99067','52375','39970','15168','18086',
                          '91219','37974','76525','31438','50465',
                          '44903','27519','32217','30761','28220',
                          '60875','99733','38590','84848','96823',
                          '17286','40527','90674','32660','52973',
                          '25670','10917','33787','72372','95718',
                          '57139','46621','87437','13900','59538',
                          '21852','70643','40309','34374','57228',
                          '57837','94593','81405','75054','93253',
                          '47466','81685','76540','87420','76241',
                          '88907','31390','92172','15659','53049',
                          '20940','79634','26404','65719','14589',
                          '48082','74103','59338','86527','20313',
                          '72157','37719','96944','25306','84905',
                          '12091','53861','59202','32512','32291',
                          '76942','26280','77258','64133','40389',
                          '10729','62507','97560','37702','32081',
                          '41029','40986','36342','93535','81707',
                          '41057','18691','45075','24698','95608',
                          '38835','20903','94969','92380','85023',
                          '14611','65284','73046','22126','12260',
                          '40668','77480','82441','71884','28301',
                          '16729','21701','47757','65014','51196',
                          '73108','91349','21359','58369','70850',
                          '27280','30349','79606','95134','48868',
                          '70329','33701','89613','92337','60937',
                          '58697','75189','28812','35728','36491',
                          '57584','82395','18469','39371','11834',
                          '80330','84890','67751','98578','45256',
                          '59716','75815','97570','93812','69251',
                          '56984','32249','27517','28579','71225',
                          '53769','57766','68373','86688','60929',
                          '17748','53181','52550','59243','79746',
                          '62890','89043','41999','12140','80652',
                          '49585','49821','48909','66620','99777',
                          '20417','90077','42572','78682','12927',
                          '10827','17704','36791','68526','17125',
                          '54988','86822','18187','65559','60260',
                          '57242','24878','10607','22369','87242',
                          '32138','87459','28732','76149','24759',
                          '66921','96164','66897','50803','32785',
                          '27529','18193','58400','30721','30380',
                          '23111','35800','46622','48457','77177',
                          '24970','85209','55631','23888','87429',
                          '21177','90974','99869','15627','60864',
                          '98107','99603','19780','96176','82268',
                          '95371','28591','69857','93690','91460',
                          '81228','28103','70033','87673','96502',
                          '38392','27569','60351','66724','36859',
                          '40624','25800','70662','71016','87763',
                          '49903','86408','12479','47198','98066',
                          '22465','81364','15824','73696','34944',
                          '85970','27085','92801','40960')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


