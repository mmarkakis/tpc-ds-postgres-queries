
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '33602','62373','95701','21561','94721','68285',
                          '12919','92885','86597','66548','34573',
                          '33301','76209','74045','74843','95887',
                          '48838','52074','75264','37253','76895',
                          '32393','51044','30523','80712','26646',
                          '89473','87051','18026','82462','89136',
                          '51102','54983','27092','35934','23554',
                          '67908','13321','88562','14932','63620',
                          '49569','83112','89210','68427','30377',
                          '40358','20099','90682','60273','69771',
                          '32195','34855','60935','90108','97989',
                          '50673','57910','69359','30015','91131',
                          '68475','50613','87293','25187','94803',
                          '58660','64036','36446','16251','18005',
                          '39070','13974','44570','39401','50903',
                          '81275','21326','77871','35080','36095',
                          '85647','18111','30481','91032','24528',
                          '39572','46664','43257','94717','84130',
                          '22953','22418','75436','93799','52659',
                          '52507','52412','68233','48918','84871',
                          '30916','46222','80346','43300','79811',
                          '53776','85751','35786','62896','92147',
                          '78100','99389','48160','33592','66853',
                          '38145','41240','82926','60416','33061',
                          '27732','46295','12262','89993','36171',
                          '99113','13058','77561','95156','79296',
                          '15691','23077','94880','85105','81583',
                          '41979','42483','70706','21189','39487',
                          '11922','43979','73476','76743','89117',
                          '64864','93428','70951','29503','42579',
                          '94638','43474','21075','52718','35981',
                          '22194','35108','68143','64559','70406',
                          '77820','31836','30041','96089','80077',
                          '15856','22083','66482','85162','94718',
                          '51596','13123','98405','44360','53235',
                          '83309','87334','43633','88804','42833',
                          '82453','66363','42273','90052','43677',
                          '10794','77446','25316','16583','88204',
                          '70761','72718','72544','11363','47086',
                          '22044','42227','96354','88071','63429',
                          '64762','11604','40232','69824','37510',
                          '40799','64201','90181','59223','61349',
                          '73214','67548','34256','25473','93561',
                          '49991','17534','33230','96378','85332',
                          '38517','29086','59531','79946','26030',
                          '78390','40512','90268','81988','64756',
                          '90761','18721','53439','49708','32875',
                          '65489','89639','93565','48296','92646',
                          '66801','13156','15530','73239','35505',
                          '18488','98132','39893','49615','46190',
                          '28432','59858','60776','28521','75238',
                          '59825','51671','53935','32597','47143',
                          '25838','38827','19581','49972','85715',
                          '74562','93167','79809','62212','67686',
                          '43215','22049','19083','53890','40635',
                          '46217','19664','93009','85006','44011',
                          '72774','16997','20462','11965','85241',
                          '12939','87373','70094','97895','91785',
                          '26007','39617','12683','69183','54884',
                          '69404','82565','87302','25960','61871',
                          '99111','81150','32507','50359','49480',
                          '35680','60675','30320','68512','73425',
                          '33461','45840','19603','79005','30434',
                          '93289','59466','43369','65797','34478',
                          '55732','52426','17601','39626','80536',
                          '13939','79033','58101','40365','63826',
                          '62374','45582','33181','32041','68644',
                          '46192','51509','97916','49107','31287',
                          '37338','27858','88677','52552','46002',
                          '62246','67895','75431','55464','60825',
                          '37694','55425','45741','33320','92004',
                          '85702','87082','56787','22099','58201',
                          '91910','26945','12593','67831','11533',
                          '54781','17498','68337','26144','99826',
                          '94914','30093','16684','71783','31835',
                          '77754','23373','85123','19769','29147',
                          '20148','75701','31952','55554','67845',
                          '96694','43734','75774','52478','52814',
                          '41828','93376','18920','72542','18942',
                          '64854','77001','28795','59789')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


