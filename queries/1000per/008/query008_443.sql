
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '14527','15647','40759','50215','20299','33435',
                          '34747','31231','83027','31489','88710',
                          '39649','16219','57682','84360','64141',
                          '17512','10422','57708','10494','83872',
                          '84743','34191','35452','40062','69581',
                          '87246','60310','49563','26040','61573',
                          '30437','76053','46529','30346','62699',
                          '96823','79471','62313','82698','76659',
                          '97370','16546','91961','71279','15097',
                          '92473','34345','89230','65491','68482',
                          '26058','21951','52950','44210','39012',
                          '91815','63208','31328','98948','83394',
                          '30779','71275','37336','22672','94892',
                          '72234','29949','80919','65010','72751',
                          '54173','65739','18671','20300','21800',
                          '44744','34026','82679','15651','93519',
                          '40529','50506','51359','63314','55574',
                          '76007','85078','94103','79416','67493',
                          '14679','18326','90881','22412','44763',
                          '26149','43739','60097','46945','24010',
                          '79879','72929','46873','11743','39089',
                          '30141','87764','22745','94019','36256',
                          '88515','17905','87598','70777','16915',
                          '89142','45477','21625','79754','21128',
                          '85382','53410','27305','77470','70689',
                          '52396','49683','29331','99797','71361',
                          '59036','98433','51744','93401','99187',
                          '92734','40592','25259','38879','53233',
                          '11566','62840','78610','45953','50832',
                          '83083','90145','60525','83243','36821',
                          '75931','20756','99998','62211','45458',
                          '44637','70904','65237','14001','59198',
                          '42899','84865','52230','37304','22177',
                          '83502','54563','63543','41016','32685',
                          '20401','50759','68460','55730','92461',
                          '54120','72202','72930','70764','39736',
                          '12762','63309','72688','66680','39017',
                          '99924','92732','40627','54299','71531',
                          '30896','64161','71173','70010','36476',
                          '90811','43965','14575','90645','38023',
                          '41670','14558','58949','43239','56085',
                          '18808','76640','20031','25701','49587',
                          '90962','62569','83892','74600','22500',
                          '13120','40545','58291','18797','98224',
                          '52149','41834','26479','34171','47881',
                          '56000','70280','87785','25742','40273',
                          '44076','86194','65656','13086','39931',
                          '82429','12791','88394','63883','16408',
                          '49663','78383','79019','17245','53122',
                          '80739','61668','32682','96732','23336',
                          '33791','32087','97159','82583','12051',
                          '33519','58636','23077','84139','92492',
                          '21864','29460','13533','93130','41537',
                          '94046','85439','86568','66518','62042',
                          '21968','39179','21563','53420','84372',
                          '67903','50107','12457','90339','87558',
                          '31548','10673','53466','73033','84330',
                          '29440','88764','88037','89340','71121',
                          '51589','53421','18630','79578','88561',
                          '45910','35520','43887','15663','44065',
                          '45491','40748','26062','85472','98063',
                          '55668','89763','57871','11209','96380',
                          '98812','64785','92200','88509','11515',
                          '17439','96838','84216','20811','71890',
                          '89735','76026','37484','70763','37128',
                          '61364','34826','11014','56088','55114',
                          '96266','19683','78334','21086','55613',
                          '67604','51664','26296','86999','58355',
                          '71604','40263','91401','90206','77506',
                          '33453','94748','70636','52550','38372',
                          '13402','64728','66295','13771','62591',
                          '84808','86196','21814','50116','83211',
                          '73433','80019','39908','52516','28569',
                          '50406','55987','58434','88873','50213',
                          '68431','23157','24134','79387','89050',
                          '44565','27727','85475','41975','23607',
                          '89093','65561','14505','22725','23069',
                          '61539','41065','52644','52715','83876',
                          '57299','60101','18162','28917','84740',
                          '81375','56860','11316','77643')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


