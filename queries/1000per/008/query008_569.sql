
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '15411','82291','10081','68619','84223','95914',
                          '41588','76879','45841','28637','45953',
                          '79155','95102','59094','49685','59162',
                          '69702','37915','73323','83080','91098',
                          '72379','54930','37865','53178','95727',
                          '72652','52236','86201','58320','21776',
                          '10934','57727','54907','17909','58760',
                          '79709','25931','17712','68959','70984',
                          '17625','27099','38862','84779','15054',
                          '75571','16473','29224','80347','70741',
                          '60448','54335','16971','64086','69261',
                          '75040','70515','15901','93199','84140',
                          '54613','98227','20728','41705','38849',
                          '69684','59531','21321','46944','45609',
                          '13706','84111','22051','60766','23769',
                          '48494','44340','52529','30549','31592',
                          '61609','70498','38982','95247','67090',
                          '58113','57750','19061','42530','84108',
                          '60144','51992','19267','29529','99501',
                          '91383','77084','42212','92444','93953',
                          '32745','11290','84097','70159','85292',
                          '79203','21803','46882','31918','52007',
                          '59495','80870','71120','36814','84620',
                          '19290','62269','98280','86153','10878',
                          '90319','99766','53787','22178','40582',
                          '74793','88671','27652','23160','47160',
                          '43161','71729','78539','47023','32106',
                          '97162','30725','91447','45849','21878',
                          '75078','24034','81514','80149','29459',
                          '99405','55109','22828','34822','60081',
                          '78818','12355','78557','31825','84850',
                          '26571','52031','88594','75799','25314',
                          '55912','43263','82003','59403','49472',
                          '37048','13277','20702','61493','51119',
                          '52580','58534','68657','34881','28591',
                          '66633','22299','40087','88756','39089',
                          '78823','52448','81562','44719','20664',
                          '13946','86687','68248','52820','61089',
                          '73186','10120','40395','74277','31625',
                          '69104','17342','23743','44384','71741',
                          '13524','32606','39045','34493','10445',
                          '35971','81117','46493','42988','37567',
                          '45136','74060','78769','47855','76699',
                          '39297','75162','95069','18762','76499',
                          '64249','30402','90893','52924','16622',
                          '17900','25989','72807','77212','50354',
                          '83335','47306','74189','87723','57668',
                          '20495','45657','80774','36049','53370',
                          '57463','96748','78736','89292','70292',
                          '87731','93924','81194','31772','46973',
                          '84167','14318','55325','72375','14458',
                          '72295','78174','82232','26092','39946',
                          '77974','23635','71409','28604','39863',
                          '33839','63170','90294','13865','78244',
                          '48700','48192','68854','25666','63842',
                          '45508','40440','52376','48304','28641',
                          '32309','16645','41859','81228','63131',
                          '65986','68561','48765','38324','38792',
                          '86320','86001','30614','95353','37936',
                          '39463','50812','50805','37348','39122',
                          '43421','66335','26117','98253','77400',
                          '77796','14750','81096','33420','61966',
                          '65369','13066','78815','27917','34998',
                          '36316','84404','55786','31337','37325',
                          '41023','28224','65784','32984','15327',
                          '30028','44053','78862','91105','20839',
                          '54055','44219','75728','43775','27403',
                          '63267','45980','91542','91027','22776',
                          '66716','97164','20988','37768','98779',
                          '76958','97148','43848','32450','11508',
                          '98713','87381','86920','83343','11614',
                          '97349','16695','46753','62596','19415',
                          '43459','22337','63355','70167','77545',
                          '48894','70927','10043','70187','28167',
                          '68400','77727','26725','60033','11731',
                          '78393','61768','85753','20570','33700',
                          '64558','41812','88505','27357','48838',
                          '40623','51719','76474','27165','35370',
                          '77463','57605','61391','59141','72038',
                          '23077','29605','43152','70112')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


