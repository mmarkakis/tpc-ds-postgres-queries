
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '18294','62431','87621','59880','86450','32291',
                          '28742','23480','77996','70797','92281',
                          '21667','19838','63037','78321','99851',
                          '11128','69588','23102','97479','74044',
                          '59451','61978','88586','38272','67435',
                          '12977','36203','22154','59508','30638',
                          '15780','71954','26137','72877','89624',
                          '82665','39827','74174','24530','70595',
                          '81124','42689','47520','89591','65593',
                          '12459','39753','49737','95124','82007',
                          '18906','27288','95100','97145','57637',
                          '84596','16747','96072','64145','66294',
                          '84701','47934','52544','68004','35902',
                          '15393','57431','63436','57378','66167',
                          '88545','27424','51815','73046','57957',
                          '82980','14032','80189','23986','84393',
                          '53559','93306','57590','16253','72002',
                          '70606','78695','62796','19267','61670',
                          '38788','60695','53673','10919','49915',
                          '15369','34359','19433','96685','74199',
                          '40579','91406','37725','80959','99234',
                          '53298','48045','45194','32262','73008',
                          '89059','99174','89745','18437','49271',
                          '60980','88383','97262','62599','13935',
                          '89983','31130','14067','48595','89264',
                          '84683','99619','61137','36739','57400',
                          '15613','57900','90257','39730','87823',
                          '97211','71653','86024','89228','87540',
                          '68033','63618','78686','75193','22874',
                          '24404','12816','26061','73078','63143',
                          '33597','56945','74885','80051','97703',
                          '95080','16270','51471','72464','62963',
                          '39227','68196','65023','40342','51635',
                          '98152','80759','46224','78566','59570',
                          '83214','96216','96572','57192','71996',
                          '23661','94285','99072','31007','68912',
                          '95651','62122','17944','48399','26523',
                          '62153','24380','42385','54432','79482',
                          '27598','82663','81724','14802','91105',
                          '66544','37696','73520','95932','32375',
                          '50456','13224','31658','85830','95949',
                          '23788','94640','10734','25918','11585',
                          '18579','80941','11043','86534','29701',
                          '91182','50143','53716','10403','58221',
                          '23401','87296','22106','56972','98006',
                          '13473','90360','14358','77700','86163',
                          '96279','32127','44526','76627','58407',
                          '25519','52669','31753','19137','49058',
                          '93884','18755','18578','98290','96019',
                          '43329','19689','38329','13138','61647',
                          '71209','34099','91205','62575','25739',
                          '56385','79431','98934','30977','11048',
                          '89954','49594','87936','17684','69807',
                          '13204','15277','24719','24436','36330',
                          '57833','17019','90263','25469','81815',
                          '49696','33700','56955','71115','68700',
                          '84974','34439','69783','63431','70419',
                          '69511','19983','27545','22237','88321',
                          '26097','39856','40584','98753','88515',
                          '85227','63353','94410','74852','50532',
                          '31800','80439','62447','81850','95331',
                          '79705','12622','94606','27776','28180',
                          '31122','73629','72231','70089','42293',
                          '13215','24931','72532','57909','64643',
                          '75887','37685','71877','62144','54378',
                          '82779','19020','84365','14750','55073',
                          '69582','51530','73720','34224','30105',
                          '65778','88876','28486','55129','81685',
                          '12640','76564','57548','77422','79381',
                          '76652','68805','20589','66958','53825',
                          '45752','49848','46581','15975','99565',
                          '35425','36167','11160','47084','34714',
                          '99840','93685','12457','86238','11535',
                          '16144','38757','15758','56893','69221',
                          '36059','39667','56678','48392','33838',
                          '82248','26948','96373','20869','75760',
                          '95753','43761','44864','53146','60242',
                          '72949','79956','96650','57565','93827',
                          '41857','37129','52631','65634','75040',
                          '63811','77305','13223','26182')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


