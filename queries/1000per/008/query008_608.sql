
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '28492','66293','69210','97284','20625','17963',
                          '91970','83418','76739','90777','44898',
                          '94729','26224','48154','21983','77427',
                          '32788','81913','59891','97681','97565',
                          '71946','14671','78766','41055','26059',
                          '72721','50575','36515','80587','50590',
                          '45915','95052','92451','28947','40784',
                          '88234','56482','61804','67045','88890',
                          '32582','52589','80707','48642','23453',
                          '24576','62170','90171','15458','23204',
                          '97510','31892','90290','48948','34615',
                          '21478','60978','35136','75101','76609',
                          '51255','17364','33900','86049','31260',
                          '49939','21634','58788','96746','24544',
                          '82091','15791','24952','67936','80283',
                          '28991','24060','95692','64037','12104',
                          '68123','46807','44352','55605','10079',
                          '30866','88918','67994','46810','40570',
                          '19666','81142','35723','37736','68832',
                          '94241','24079','59664','65521','24912',
                          '86175','19928','65470','16001','92375',
                          '12271','24449','50953','30421','90172',
                          '92810','50585','48229','78940','39683',
                          '20164','34527','85560','49783','91988',
                          '84656','14412','63289','94199','16643',
                          '93205','50958','67158','22963','57258',
                          '58497','87393','81578','81763','60489',
                          '33682','73671','64407','70848','83877',
                          '32738','69615','86027','13593','39324',
                          '52226','73697','68799','46964','85235',
                          '58682','98608','86058','56631','40155',
                          '10313','66540','81883','57311','20494',
                          '22248','63973','45435','13277','29321',
                          '87219','34830','20181','80829','95734',
                          '94471','65864','91116','38064','66725',
                          '20648','39086','92962','63757','54916',
                          '12035','34542','63519','51436','82618',
                          '87233','91746','65892','90135','77853',
                          '58219','92160','55309','53396','25956',
                          '12009','85323','21286','31597','13839',
                          '57249','85680','99951','90643','17706',
                          '76092','34364','27580','15529','40751',
                          '33016','37393','82155','74856','54236',
                          '41973','55942','98317','16041','84710',
                          '64207','38565','86417','94446','19258',
                          '60889','73337','26648','20285','95058',
                          '70635','14460','48800','43099','51763',
                          '97798','53484','76412','76241','88504',
                          '52268','34833','86176','44721','47162',
                          '45225','63838','28762','44939','22742',
                          '12432','31198','11609','36606','81195',
                          '25841','55507','84985','36702','53299',
                          '51135','99065','59334','47549','83916',
                          '16084','17826','34384','81162','32512',
                          '55597','25886','27946','38201','62424',
                          '41597','13165','28823','50560','19629',
                          '63763','59579','30667','74986','11932',
                          '28665','39408','86281','64280','28468',
                          '43808','32489','55532','89232','69920',
                          '53032','60449','47613','14641','77065',
                          '89887','83126','17053','64533','94442',
                          '21055','33541','78903','19873','24299',
                          '18223','77270','57211','57866','88116',
                          '95976','85763','68986','36422','25146',
                          '47008','88465','61879','77948','56877',
                          '31427','88959','97918','63613','76820',
                          '65332','70990','84590','34404','82854',
                          '44554','83410','69724','58082','39769',
                          '84711','42580','51490','24092','79726',
                          '99887','57302','62446','57949','15888',
                          '80170','92441','37786','51435','37943',
                          '84519','41779','26537','81842','88637',
                          '85975','50229','25668','40456','31650',
                          '97015','92274','17267','74121','93743',
                          '66780','96934','79482','43442','49697',
                          '92134','70331','92830','43162','43589',
                          '71593','54787','68021','67263','81008',
                          '19585','26361','95423','86343','58078',
                          '60355','96785','10798','47338','37447',
                          '60130','30964','61213','50192')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


