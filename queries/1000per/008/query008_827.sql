
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '63207','72689','52129','62033','92690','26602',
                          '49212','45341','87864','81348','10399',
                          '81275','14032','17074','14573','70583',
                          '18695','44495','40826','49466','57111',
                          '69774','73630','77325','12445','30564',
                          '91596','20149','99834','67135','58861',
                          '62112','29158','14902','80004','73833',
                          '35744','22624','53035','68235','72675',
                          '22088','85677','17192','27619','66942',
                          '22602','36215','87286','77997','71246',
                          '41274','68224','21691','27493','13389',
                          '96828','57342','19155','80317','85355',
                          '88940','67274','51636','13939','56717',
                          '80475','11829','15500','60060','80121',
                          '85810','72965','52856','53669','33675',
                          '91623','92253','83856','51454','28408',
                          '89864','99826','85091','49835','15539',
                          '91211','12570','59381','75989','21150',
                          '72140','96782','64688','29526','78873',
                          '77667','16751','43433','97730','54895',
                          '52217','79715','37679','55809','32734',
                          '55628','41058','43780','87945','18174',
                          '25984','94073','18660','81898','64197',
                          '70968','15716','52578','12276','43696',
                          '73019','91612','27925','13361','31904',
                          '69538','57886','85895','72888','63038',
                          '16566','45794','74232','52118','55313',
                          '29735','67761','95509','20451','96072',
                          '81603','31367','94023','27145','95308',
                          '23679','98678','10796','16839','97690',
                          '78759','35862','13561','17238','35952',
                          '18185','22369','36936','95463','31041',
                          '83190','85704','30857','24077','22665',
                          '82013','39669','74255','89662','46205',
                          '72584','23007','69347','12694','87620',
                          '67120','85377','28653','40511','38005',
                          '13292','77854','59260','88569','83205',
                          '90443','23563','94137','33600','39440',
                          '58520','82809','29030','12370','85887',
                          '48246','50211','77171','24187','81328',
                          '17956','14817','68665','61534','95683',
                          '60595','97008','40319','96842','17690',
                          '81455','79785','46311','14760','11446',
                          '71226','97358','92140','72393','60023',
                          '22391','41056','26317','19685','53850',
                          '43517','68441','61881','42297','20835',
                          '14818','92065','91296','67300','89900',
                          '51722','58288','36444','79799','84419',
                          '90987','82245','69159','90670','72945',
                          '32067','34523','44783','56683','93351',
                          '62668','40793','96657','81768','15342',
                          '34098','54862','27844','84853','83057',
                          '16059','52418','78637','38462','76253',
                          '98160','86504','19742','54937','67877',
                          '82258','98813','23597','14126','69628',
                          '18210','86724','31680','52236','70238',
                          '51856','77992','38867','44062','16512',
                          '82761','28666','56149','32616','98887',
                          '19819','81334','86997','43995','16407',
                          '35584','23541','97498','40725','78280',
                          '76240','18103','14576','15265','22791',
                          '98152','95864','38690','80829','29509',
                          '49337','13343','26220','91867','15669',
                          '87055','91853','83375','82410','54764',
                          '19991','23576','86565','68206','81762',
                          '98364','90948','81163','75857','32764',
                          '63996','18719','78324','55907','81191',
                          '38522','20585','21780','41150','13127',
                          '36925','96710','89399','39342','54321',
                          '59440','97424','80151','86712','60521',
                          '29754','44306','81673','18589','95105',
                          '29993','43084','38044','11419','93728',
                          '88360','67094','96714','50561','68437',
                          '65554','26116','23208','68291','65800',
                          '42227','14787','94336','30651','44915',
                          '98396','39311','14995','17437','76539',
                          '37271','11976','55215','37914','21696',
                          '86193','82955','43693','20284','98965',
                          '84971','50338','82521','80757','51341',
                          '25388','34005','36675','66419')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


