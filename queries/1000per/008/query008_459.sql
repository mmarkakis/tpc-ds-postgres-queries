
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '94534','45033','72832','90727','65505','89862',
                          '78199','41878','49043','44013','17586',
                          '94113','52222','32911','17267','58937',
                          '17301','17555','89194','26401','99332',
                          '97457','33653','34967','27989','62764',
                          '81777','58693','21022','73554','35791',
                          '52963','12507','16391','77140','93430',
                          '78432','75909','65442','67367','19902',
                          '35317','11209','82038','70829','60916',
                          '28669','60156','14381','98610','91948',
                          '37179','94038','57582','34864','15780',
                          '85845','84429','52233','76440','84536',
                          '24181','59674','62150','43428','93657',
                          '89109','49516','81418','83967','52860',
                          '45131','39862','31637','63058','20764',
                          '39510','12527','20873','86962','37600',
                          '92121','66922','54619','12793','86222',
                          '86902','64448','15546','18251','28601',
                          '33368','24084','11883','10708','25885',
                          '88486','52998','17963','64349','11858',
                          '19611','61189','91473','91957','48173',
                          '59846','47912','62019','88810','71476',
                          '62825','68775','82525','49285','60090',
                          '32883','76667','11653','79126','34810',
                          '51939','82762','82679','74875','68752',
                          '68793','93187','31249','23370','86521',
                          '44333','52606','18015','12156','73994',
                          '79765','39647','78389','88724','44166',
                          '50071','45787','81753','80127','31581',
                          '16664','27868','77397','71202','16658',
                          '72714','30013','31568','14025','21225',
                          '58854','49446','89477','38240','22746',
                          '16301','32712','55445','29535','34673',
                          '43177','62652','73516','79006','88827',
                          '58744','61664','98609','81771','70251',
                          '95526','66489','51221','43986','40961',
                          '58580','99970','75138','26627','56759',
                          '60704','44722','25569','16316','39681',
                          '78410','61076','78478','80987','17565',
                          '33089','53150','77649','27121','32816',
                          '30217','17157','28650','51100','79673',
                          '68938','35449','19643','16401','60099',
                          '63347','87749','33856','84653','22140',
                          '62974','35719','29540','46196','52610',
                          '92263','21410','77752','38841','84148',
                          '87283','40007','75289','60125','58004',
                          '47182','20878','45195','34174','29900',
                          '67475','79141','35146','10544','80535',
                          '99207','32851','42657','95702','16457',
                          '77223','68694','55742','42293','84736',
                          '35520','12092','23942','89624','73909',
                          '70580','23692','47877','59805','67616',
                          '49286','80351','22522','30419','46211',
                          '58066','31558','21200','99388','98501',
                          '87869','76228','75579','48203','52134',
                          '40449','18757','28179','43905','35882',
                          '84670','52904','62404','35437','21027',
                          '60935','91869','60457','38269','13559',
                          '87820','63400','44606','43999','31199',
                          '94796','22107','68472','83923','74109',
                          '88715','40437','43063','48246','64920',
                          '35088','13721','59193','79245','75730',
                          '51242','15965','47836','36333','42815',
                          '93126','71588','28706','61367','84134',
                          '66693','88226','49347','73106','61934',
                          '92636','49333','96993','89206','14039',
                          '33121','96490','13900','99765','39628',
                          '73621','10288','80758','60699','99783',
                          '36785','67517','16997','39234','94660',
                          '38414','27771','37824','27525','32537',
                          '11662','11103','26283','47364','52432',
                          '94596','73187','81059','62691','57969',
                          '25213','22393','65747','35815','95735',
                          '89859','75609','36892','14527','91761',
                          '97773','60948','98661','31318','81889',
                          '59519','71933','47554','39867','29667',
                          '21646','32326','56058','37720','25965',
                          '77682','61512','55704','32632','54045',
                          '36688','65863','20647','63141','54197',
                          '36865','20451','48059','56786')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


