
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '46397','47335','87887','15658','29855','76357',
                          '90791','74097','92027','48863','97886',
                          '61767','69662','83087','20554','90863',
                          '12146','84516','92527','68186','61551',
                          '99074','48128','24906','36374','21565',
                          '35272','38449','25466','54905','46524',
                          '44282','64623','85268','77278','19866',
                          '36103','48588','18722','54694','51331',
                          '24861','41537','58220','25448','70448',
                          '38967','70285','44864','68483','78518',
                          '71533','90696','82291','32662','56285',
                          '73226','42677','96162','19829','93826',
                          '83439','33433','57555','85823','17765',
                          '55850','67179','97178','13096','56694',
                          '34750','59349','30727','23217','48335',
                          '74796','92696','85952','64972','77436',
                          '41709','96202','39797','85064','66425',
                          '12949','41652','21956','40022','15946',
                          '51832','49794','96926','80551','79209',
                          '91165','88437','61264','39374','71051',
                          '55199','11640','60512','49692','74956',
                          '61620','66308','42918','99198','19591',
                          '63002','12824','95116','82204','59744',
                          '23191','72516','52117','44854','59952',
                          '44003','23402','14392','23408','42900',
                          '71549','16440','24044','81045','38189',
                          '98332','90809','85486','86381','37244',
                          '34610','56680','42484','39333','38088',
                          '64797','10094','58686','72859','49447',
                          '74972','90871','27213','55012','11346',
                          '18763','80390','92589','68925','88156',
                          '66561','43723','21953','29134','47074',
                          '42692','17734','10546','51112','88283',
                          '50168','38463','14001','10672','21449',
                          '59966','37844','94727','66315','22623',
                          '82146','55312','27980','77315','82853',
                          '73310','35317','46000','15168','85329',
                          '98172','92439','84842','77762','75386',
                          '42570','41727','55950','30621','69050',
                          '76071','93185','91319','80038','71700',
                          '85720','23808','61055','89007','64864',
                          '32188','71150','69171','35688','17334',
                          '98367','53852','93643','26014','26928',
                          '61633','76530','10782','86216','99479',
                          '66749','52194','60031','97970','73688',
                          '95953','79186','41825','42515','79475',
                          '24778','78122','30132','44645','87192',
                          '88627','78748','38808','27440','97810',
                          '94016','32021','10785','35548','13806',
                          '99611','59971','21280','85666','94842',
                          '68150','91381','20271','43775','72748',
                          '67368','18703','14214','88408','27906',
                          '73606','73918','31370','78485','56006',
                          '25369','39393','38769','12734','29065',
                          '97438','89915','15860','97901','87880',
                          '44175','91150','89240','65746','91682',
                          '95371','10242','58281','38365','34905',
                          '92189','94167','63641','26834','86892',
                          '50474','21843','98936','32840','96165',
                          '12446','56272','10368','82745','66537',
                          '29052','16008','33673','94887','28884',
                          '44103','63569','86469','11347','21334',
                          '67662','52377','24504','35938','32567',
                          '27566','78199','10091','97834','96837',
                          '57102','59741','49272','32955','17180',
                          '91654','67984','67045','89772','58266',
                          '18880','76047','50109','95585','88455',
                          '37088','21245','17642','81040','69499',
                          '64269','89117','51550','87863','28474',
                          '71918','49644','85781','33293','69335',
                          '47666','17456','15985','64660','92052',
                          '64246','77780','29480','47407','17480',
                          '47912','42683','49221','27577','29948',
                          '33904','96317','64450','98053','70467',
                          '49606','42784','15233','66927','92239',
                          '66719','72681','32071','68955','86497',
                          '10924','89083','18866','21854','65116',
                          '38068','35928','67834','74721','14110',
                          '73719','76227','42688','60051','43186',
                          '85846','41061','78433','41755')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


