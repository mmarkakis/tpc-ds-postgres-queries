
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '34058','55634','99343','35157','63452','36583',
                          '82815','69262','77362','79763','66134',
                          '12712','96243','11737','24026','79680',
                          '58328','86134','42521','33801','75150',
                          '60728','32751','34385','57266','47507',
                          '40939','40246','63497','78043','97787',
                          '27747','78994','80900','64211','70023',
                          '24763','40676','31387','42769','90554',
                          '66138','87212','98678','90732','65117',
                          '89517','32686','29770','61329','88135',
                          '79615','91562','64581','45492','67066',
                          '40361','68040','27097','38037','84324',
                          '20548','45263','20980','63953','38943',
                          '23110','53446','74108','34323','96311',
                          '88955','65457','14380','23161','35576',
                          '86573','99508','37136','21553','13317',
                          '84438','21906','88706','24541','89973',
                          '87606','85510','64586','45731','71553',
                          '84345','22202','25461','97540','17826',
                          '88425','81240','87075','67959','54274',
                          '78374','84202','46677','14212','54444',
                          '61848','46608','19352','65479','48620',
                          '63023','83204','71874','52396','31591',
                          '26242','60493','79718','56601','15513',
                          '88042','20377','53227','46593','86995',
                          '83638','86125','67827','13047','86128',
                          '56958','64825','28287','11798','27074',
                          '47980','31665','29424','38698','24667',
                          '75730','25065','75271','37210','93478',
                          '75883','91950','95997','16871','72180',
                          '47321','35107','82164','86771','85313',
                          '52821','87181','96768','38722','98611',
                          '93609','16172','17978','92750','28634',
                          '90297','78208','55201','67207','45055',
                          '99223','71833','96556','65904','12326',
                          '82131','72645','79302','30689','71769',
                          '13645','91153','72291','70813','23592',
                          '20504','44506','99758','14562','32679',
                          '32286','21617','68222','94548','90878',
                          '23620','86598','98305','28522','92269',
                          '11007','29460','75193','69775','83958',
                          '84677','59586','37378','44793','41083',
                          '56809','75549','38700','86511','38886',
                          '18430','16568','29135','99382','73897',
                          '71756','49597','21054','18271','15909',
                          '83198','94687','12795','29255','53669',
                          '19451','45934','77150','49117','40867',
                          '42699','71780','23930','80504','14023',
                          '67539','21092','15897','20631','61393',
                          '66571','67726','37421','93893','32545',
                          '54474','41712','80539','89394','70697',
                          '29902','66350','98701','48179','91064',
                          '37143','79845','41112','56354','99489',
                          '81294','54060','35387','23913','75161',
                          '53615','46710','65123','96610','31037',
                          '78919','91485','23177','48579','98981',
                          '82808','51677','16578','92361','94524',
                          '59009','87339','88571','19114','10622',
                          '88540','59496','86861','10869','80435',
                          '23291','82486','35220','25893','44796',
                          '21360','96239','68965','47997','11810',
                          '15017','33027','63061','47498','31184',
                          '82488','63896','67468','29367','26433',
                          '70239','77397','68554','25959','50361',
                          '12555','21319','25963','13363','27365',
                          '64633','17021','66003','74845','54536',
                          '63478','36218','56975','22298','51279',
                          '42827','53568','78754','22998','71496',
                          '33806','47745','22907','27274','91784',
                          '21701','69512','57009','43741','61096',
                          '46714','90348','10671','60160','74206',
                          '50554','73673','84607','38099','11294',
                          '27485','73668','62877','23542','65575',
                          '72457','97416','15602','49718','90592',
                          '28099','17787','89699','87094','66871',
                          '21944','12755','68573','16462','90634',
                          '62088','19785','78519','23664','41790',
                          '34293','63739','91961','31916','99257',
                          '74020','36083','50042','49532','79151',
                          '35340','15656','39331','57581')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


