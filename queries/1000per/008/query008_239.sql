
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '75357','36388','27274','19502','42525','35966',
                          '47470','46775','12529','86948','59668',
                          '51336','64040','95481','22102','94669',
                          '24211','99583','58445','80427','74168',
                          '72932','61482','83468','68158','77519',
                          '53067','72375','93875','73181','46056',
                          '95199','64777','58116','19337','21279',
                          '24347','52931','43018','91149','25390',
                          '77167','66520','90514','82929','65483',
                          '11000','44675','62149','13476','87041',
                          '26786','56154','47974','18634','15477',
                          '96859','75000','33713','31688','92856',
                          '77830','10573','21245','72475','71824',
                          '14957','47738','76137','80726','57586',
                          '12385','29541','98115','23241','57469',
                          '61230','14493','87776','85466','24129',
                          '92425','94142','23061','14321','46371',
                          '31582','54601','93654','60847','52304',
                          '89495','11612','90338','96127','56623',
                          '21625','10698','79190','80292','67011',
                          '54025','10590','34601','80679','29704',
                          '82868','15235','29609','76820','96348',
                          '27315','55217','33059','79794','83268',
                          '12240','67866','51971','63572','82650',
                          '98561','92575','73828','35048','82193',
                          '45671','57740','93114','94341','38131',
                          '24555','23128','37597','38228','46379',
                          '86316','27338','82116','98817','14997',
                          '39180','62197','79780','51157','53180',
                          '93465','97781','30159','27341','43088',
                          '50754','51549','97193','59620','76682',
                          '32163','11825','72501','58191','89017',
                          '62018','23290','54811','29798','83510',
                          '16996','58415','93121','18310','80242',
                          '53985','37533','13200','39562','70247',
                          '20244','68029','97738','61361','90894',
                          '55559','57332','70768','66761','86381',
                          '21236','23449','28309','89953','81465',
                          '25315','87395','60692','14583','39037',
                          '47696','70909','38478','92096','83333',
                          '52927','27520','37285','52691','26146',
                          '68802','13050','86829','29775','82133',
                          '91225','36900','36320','27648','42273',
                          '37578','12236','86679','77920','80133',
                          '57497','73366','52439','51723','29927',
                          '38313','38093','39407','74021','72394',
                          '40237','89103','48314','72608','86067',
                          '36194','46832','30432','93621','41473',
                          '36920','49210','73007','86427','99449',
                          '66260','34694','27608','15099','44298',
                          '17364','26541','21591','67214','63074',
                          '67942','38498','80748','28385','35103',
                          '27110','28670','68866','34570','79247',
                          '66525','90366','49743','96141','53652',
                          '34284','58920','70771','95091','89317',
                          '68540','41262','53864','93265','55791',
                          '35012','87850','85256','44201','59103',
                          '90329','64124','31387','41346','91889',
                          '20602','20926','66232','33728','53447',
                          '18545','74529','92801','25290','93963',
                          '60691','87787','89638','33692','54236',
                          '88623','52738','40426','96518','39102',
                          '95489','36204','67188','53844','72486',
                          '23533','89133','86967','61758','84345',
                          '38762','62795','25394','86861','32896',
                          '93317','26553','23084','18413','22128',
                          '51872','16303','71991','96760','87772',
                          '19546','52299','43684','51598','52245',
                          '48360','72942','96209','54984','10888',
                          '70207','41831','30576','73522','25345',
                          '40619','62979','96532','18558','56730',
                          '25171','49088','46500','31224','26527',
                          '77080','78295','99734','92942','16928',
                          '75674','17378','74062','31527','25920',
                          '53214','35043','85447','99906','52085',
                          '49791','34928','74891','60756','37065',
                          '98206','68589','88012','36428','99132',
                          '81782','87269','24569','18893','20106',
                          '40433','78814','66976','93157','78808',
                          '54771','70647','35940','82941')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


