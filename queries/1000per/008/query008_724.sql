
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '52847','30740','55165','23820','47113','63194',
                          '18984','53539','45325','57294','80210',
                          '44519','77387','69775','55378','51002',
                          '60328','88713','44322','61851','14568',
                          '67411','43006','36830','22295','18200',
                          '81889','70298','89649','90708','21858',
                          '27661','85994','56671','43944','98685',
                          '80635','84987','53026','85511','10175',
                          '44572','40472','35891','45133','11712',
                          '46187','27924','48141','85260','73213',
                          '85433','83434','74234','86869','48842',
                          '44713','20780','97757','89575','50847',
                          '10596','54287','65186','13628','84560',
                          '32766','50597','19216','73745','66642',
                          '26561','98945','85006','31258','49432',
                          '28207','51564','14217','44501','35713',
                          '69131','25038','84024','21292','13922',
                          '92674','47253','97264','49641','81104',
                          '42170','87479','32166','12634','68960',
                          '16931','97147','46159','96604','73091',
                          '15838','27626','29986','39455','87592',
                          '25746','56054','16134','55280','58792',
                          '28567','68111','50104','75918','27167',
                          '87965','83073','66430','77129','91857',
                          '88287','31582','12225','80422','66498',
                          '43395','62931','42324','10625','99380',
                          '68777','47681','23504','64435','36191',
                          '82390','39780','51332','56213','80587',
                          '88379','17215','66749','44317','48889',
                          '91834','18600','64903','65169','59070',
                          '47245','80077','57469','58082','64803',
                          '51891','76070','17708','49094','72125',
                          '21195','96036','48178','86519','11559',
                          '74007','26386','32674','17479','56465',
                          '77304','28800','52203','89905','51129',
                          '20257','29644','62644','55688','65898',
                          '65710','30561','44590','81914','88477',
                          '48354','98224','99011','73851','66613',
                          '60273','64209','80282','76093','30444',
                          '30164','18174','81408','65187','10095',
                          '46462','55140','53436','50871','24350',
                          '59669','82869','75684','89197','62069',
                          '68082','29034','40526','93626','76455',
                          '29875','32649','50040','30207','74153',
                          '16107','80545','39042','29824','22659',
                          '34486','64094','42248','97601','61481',
                          '83031','20241','17446','96657','50750',
                          '16721','71278','51037','98502','71080',
                          '37557','41863','87762','83694','63764',
                          '99714','44220','93528','55350','14132',
                          '85216','23988','52724','51759','55424',
                          '26051','40877','58076','61301','38818',
                          '24334','99141','62395','63004','46460',
                          '86945','60248','44023','57536','34986',
                          '55152','68262','51164','72536','36853',
                          '32935','87357','79767','64162','51543',
                          '61328','72357','38316','67314','76588',
                          '66985','78060','74544','97093','45770',
                          '53733','58714','11817','99258','56475',
                          '45696','61151','89169','77749','19422',
                          '96531','80640','98176','83121','91812',
                          '92620','49528','87693','16406','50822',
                          '13616','58216','36206','99186','52741',
                          '52759','46679','39901','61277','70169',
                          '56754','84846','21554','75944','98796',
                          '37031','22274','52121','42774','20328',
                          '50131','84678','24159','46362','79523',
                          '44363','47310','16847','99406','87173',
                          '11055','86688','75274','59039','40720',
                          '12864','21223','79294','99261','93657',
                          '61147','20212','34823','30639','79425',
                          '67042','20541','87514','42293','30342',
                          '62173','58540','62751','25719','54854',
                          '51904','33879','72303','54144','65779',
                          '94740','52411','24022','97669','58668',
                          '84108','48440','46593','10903','17375',
                          '28948','25014','90780','29761','25775',
                          '32242','79339','93318','35734','45108',
                          '72732','58828','44431','52075','24835',
                          '69987','24778','74499','26331')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


