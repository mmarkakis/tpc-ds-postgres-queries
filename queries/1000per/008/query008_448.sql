
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '63937','39071','12544','93144','44386','30761',
                          '62685','39151','10987','22741','12384',
                          '42496','77492','51794','86754','82110',
                          '71587','26468','35334','48181','48888',
                          '40966','79140','75511','39070','82008',
                          '76783','75284','16985','38529','12585',
                          '67113','28025','20781','57740','28854',
                          '92383','36278','27532','73078','21813',
                          '83582','96004','21651','65680','12553',
                          '68084','69382','82061','73261','66426',
                          '78482','86032','83893','63161','98554',
                          '31974','48957','14258','54747','81518',
                          '38579','12477','69455','75451','77364',
                          '86271','16538','59350','28928','77250',
                          '41143','89438','52285','67040','47488',
                          '46106','32060','64532','39687','88179',
                          '25603','80394','22499','40693','28851',
                          '81451','84321','52483','58051','44233',
                          '78976','96183','78546','44241','98753',
                          '56784','32700','48281','41387','64039',
                          '47712','56994','95935','76944','57183',
                          '74909','50433','99561','40934','13826',
                          '62604','70109','68932','65610','37379',
                          '94347','18912','87616','10657','90880',
                          '36546','32493','86921','99544','30658',
                          '97932','26056','89633','66173','57022',
                          '83369','90896','40165','47618','50019',
                          '54503','98689','30712','50479','50977',
                          '95000','12875','95847','99167','52303',
                          '96478','80099','29889','74464','57875',
                          '36799','25761','80026','54989','31372',
                          '48307','42348','71829','29803','28478',
                          '33876','49465','34254','52536','66252',
                          '39162','20870','54976','11590','25591',
                          '79741','60092','93154','53272','31999',
                          '44111','40702','79532','22760','67203',
                          '72613','53264','63913','59897','85288',
                          '18192','97191','75328','78586','80753',
                          '77656','26493','99044','64592','13240',
                          '34807','86673','73411','74120','93293',
                          '12897','85867','16475','50747','33233',
                          '79921','79135','88891','90642','99793',
                          '10675','43525','76260','47631','27428',
                          '75723','33003','13667','50893','39377',
                          '88950','60974','79168','73705','48118',
                          '41570','85243','89403','91838','30912',
                          '19468','18397','15447','43128','30753',
                          '16715','80464','58430','20512','63964',
                          '99987','39748','77251','57219','85570',
                          '78534','36266','68958','23241','40802',
                          '15988','36205','35667','27344','12114',
                          '11388','51519','59732','40540','22500',
                          '88854','66481','13600','25928','93890',
                          '70334','62600','74437','36787','18494',
                          '94820','97985','84237','24373','10501',
                          '98860','15583','90462','64616','58230',
                          '18390','37937','57560','61169','33854',
                          '59938','81799','82229','72416','12852',
                          '54925','48152','94170','65304','56697',
                          '84044','70535','96883','34995','58178',
                          '46727','92564','68382','86721','69861',
                          '72753','52825','75164','76149','86090',
                          '50054','76778','90371','28084','91791',
                          '23306','53501','98846','64260','58914',
                          '86397','72351','40536','57823','89068',
                          '90878','17913','29239','93014','60500',
                          '11135','74716','80231','87519','50179',
                          '78225','96232','50551','70213','39124',
                          '45724','17133','53798','33327','86693',
                          '96899','14722','19334','61341','20087',
                          '75678','90694','34601','94119','54940',
                          '11030','20121','63951','83468','13514',
                          '25427','33705','82959','31666','39459',
                          '23508','25905','96769','63510','33077',
                          '96067','25881','54270','23151','96672',
                          '61766','29364','73156','55776','35652',
                          '98467','93832','92110','60766','64371',
                          '41931','71985','88033','67816','93132',
                          '61452','86699','40654','58451','43891',
                          '90458','25088','13429','68429')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


