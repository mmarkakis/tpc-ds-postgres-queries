
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '37199','16058','81214','38692','87404','16542',
                          '73252','30034','47425','55953','16245',
                          '60460','17897','49966','67375','69907',
                          '35558','26613','43983','98464','87709',
                          '61529','77027','99688','87218','96239',
                          '35698','93305','43852','10405','45457',
                          '74616','14893','68623','52458','88286',
                          '58646','63314','62267','97054','57090',
                          '79722','69114','44076','81815','34977',
                          '33581','67541','46928','97341','80272',
                          '55130','40882','43164','80386','53373',
                          '15194','33965','71881','65015','12327',
                          '25646','49893','25300','33807','26183',
                          '46537','30389','82472','84798','95374',
                          '83283','28828','81834','22775','42520',
                          '25112','22964','73463','88236','86756',
                          '13170','95681','74385','90905','49938',
                          '48487','54891','58472','66087','38619',
                          '52904','38553','28923','16140','29548',
                          '57749','10187','67403','35697','84759',
                          '57352','47550','77234','95336','59753',
                          '93386','77527','11081','21025','29713',
                          '91024','27916','55180','82624','25337',
                          '37805','42222','82102','70375','19155',
                          '17937','92895','34503','72299','88082',
                          '53504','45966','16645','71681','57185',
                          '63863','37647','40442','97540','48664',
                          '66207','17373','34460','10478','39569',
                          '15479','51849','97264','24936','56296',
                          '25094','76584','48650','85941','40755',
                          '78177','90150','53135','59981','77766',
                          '25980','35394','27745','34222','41729',
                          '42333','33855','11562','12370','86193',
                          '78185','37520','88899','73393','98721',
                          '46509','73027','80989','64741','20445',
                          '90939','93052','49099','17030','81277',
                          '71695','77730','98854','33432','80829',
                          '65052','33828','95650','38119','98145',
                          '70588','42694','17981','22890','64483',
                          '48850','85458','23597','89951','83699',
                          '16451','86305','35050','47412','83074',
                          '64004','73244','48618','22813','18076',
                          '27867','98208','46362','40055','16129',
                          '95018','70645','34772','78549','18732',
                          '51697','57501','62508','63994','45375',
                          '25537','73540','81946','10868','88088',
                          '70972','38130','89516','91013','62510',
                          '36921','85202','44969','30916','52548',
                          '70867','45938','43681','94873','42420',
                          '68357','38749','56438','97294','15735',
                          '64805','27097','23637','47102','69324',
                          '36804','78586','36684','90144','16516',
                          '93546','95456','80952','10248','73100',
                          '36449','99970','16335','85454','83129',
                          '60305','98929','59222','11248','13621',
                          '60750','88314','98793','90732','60453',
                          '65789','99423','17498','53579','55001',
                          '56927','76236','86857','28473','34697',
                          '18049','84659','41794','59761','54402',
                          '33943','51329','40953','11666','75923',
                          '78516','37700','43701','94329','51868',
                          '18070','28890','76335','48822','75435',
                          '32468','52045','26898','28740','93421',
                          '43990','13849','62373','53758','62659',
                          '62829','14507','94401','72848','29777',
                          '81964','41756','12636','59874','82680',
                          '23251','56237','60738','42459','88607',
                          '14121','78792','99178','57452','27439',
                          '17110','49227','68627','61548','19164',
                          '82638','95611','71122','28425','71992',
                          '72042','64584','26324','67880','56658',
                          '76766','20745','16821','93547','62263',
                          '12284','82979','21907','20063','30795',
                          '26127','10556','22277','13178','15456',
                          '73908','32917','33908','87622','36872',
                          '73080','27681','58193','66585','88566',
                          '66174','45541','68562','18389','24239',
                          '99048','79398','18588','17066','21415',
                          '70362','17772','33387','54288','15204',
                          '90891','81065','87159','18837')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


