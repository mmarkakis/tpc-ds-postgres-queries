
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '20012','18540','34012','68889','66762','52495',
                          '23405','17535','27784','54912','17439',
                          '40834','33480','58176','94068','37429',
                          '84386','38841','45978','83432','75595',
                          '69151','95396','49435','77575','18718',
                          '86507','39207','73181','96889','88271',
                          '35132','25856','33320','90524','97510',
                          '12063','88311','59022','51212','43256',
                          '47771','12295','11284','62532','21230',
                          '48660','66469','81878','95938','70799',
                          '86231','30127','46878','83675','60903',
                          '56248','47427','34052','19596','99661',
                          '18920','79381','22784','70009','27795',
                          '12256','55372','28669','75142','86467',
                          '92236','22704','23076','30933','24146',
                          '19867','97081','72383','46745','28048',
                          '76588','49702','67711','37443','64629',
                          '57234','41242','96622','81478','28739',
                          '10185','33563','54447','63403','41718',
                          '10886','84382','19853','15152','84770',
                          '69532','87812','93986','27969','62880',
                          '66565','39237','35576','61924','37934',
                          '87315','31057','73474','44223','51293',
                          '72708','81809','97552','60176','16909',
                          '89409','40441','69917','42300','60211',
                          '97656','22120','52210','69939','97445',
                          '90416','92744','27366','30161','79506',
                          '63797','11787','92123','83303','39558',
                          '87802','83175','53053','12178','13956',
                          '93041','29072','95823','98799','33621',
                          '45231','89553','74385','79139','44096',
                          '83225','34070','93779','33730','48004',
                          '37186','34821','88540','68708','42210',
                          '82299','43551','28012','80548','17595',
                          '79759','70098','62126','64831','84740',
                          '83978','28001','19874','37265','92460',
                          '49024','88770','15364','50537','31867',
                          '34593','95123','57808','62366','26984',
                          '99082','32155','72106','44694','28928',
                          '79650','46696','21077','78262','73364',
                          '89858','81526','95473','10946','37696',
                          '61929','49197','49695','40886','37205',
                          '50250','94948','63823','34215','90425',
                          '71022','53417','71452','81350','36033',
                          '33830','14027','69606','58555','88033',
                          '33055','54519','84663','89866','46468',
                          '11296','19010','53517','61477','97366',
                          '72326','40126','48721','76882','37374',
                          '54314','71132','65103','11738','70789',
                          '25339','76949','32918','75125','73951',
                          '53754','20358','79628','83289','52883',
                          '15320','56507','14863','57620','13343',
                          '85843','99128','21584','55893','57598',
                          '45112','93413','12137','89258','52570',
                          '67899','37104','90208','92658','64474',
                          '29305','82048','10490','17531','13094',
                          '11250','59369','73154','28625','97241',
                          '30957','82943','62538','73273','40311',
                          '43568','93866','13543','40731','72975',
                          '70383','38807','77845','96966','73069',
                          '87592','12055','83237','67488','34903',
                          '68715','66006','91523','84377','31394',
                          '64654','17433','67408','27171','86295',
                          '49252','82450','24663','64128','46609',
                          '64752','22990','41742','83038','44468',
                          '97845','96766','78484','19690','81418',
                          '47902','26153','75689','75214','62807',
                          '76504','53147','55709','64468','56299',
                          '87410','85044','41846','26451','89973',
                          '18647','82289','86590','66374','49398',
                          '92059','76363','72108','14578','75304',
                          '47562','97976','41634','27666','56513',
                          '95524','14507','20633','49391','88524',
                          '74009','10593','79683','27223','18787',
                          '68903','77758','17303','33354','63877',
                          '72844','18217','22105','10595','80377',
                          '15634','56002','95860','76183','53979',
                          '79724','55280','20654','60410','42305',
                          '73635','29841','93241','42599','82578',
                          '71813','40402','55667','21145')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


