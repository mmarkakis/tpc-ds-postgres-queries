
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '50265','57402','33376','94079','22411','99823',
                          '14150','22855','79012','41678','40365',
                          '26297','80701','33742','86976','10170',
                          '33265','94935','98650','67768','33833',
                          '22292','30896','64944','74908','95670',
                          '38322','38955','28921','85707','49103',
                          '40558','39260','34081','77417','83039',
                          '63858','90991','88772','45786','63503',
                          '19234','88598','10772','75036','56157',
                          '19156','68820','50462','57020','10637',
                          '39684','50187','69400','98872','56289',
                          '78398','79978','65848','56283','10181',
                          '95369','30831','49990','46835','12651',
                          '13128','19894','25870','55183','80915',
                          '10678','89620','73896','97015','70741',
                          '21280','49606','63450','63754','31146',
                          '74746','36965','81143','18258','22526',
                          '76407','53913','63336','44538','60752',
                          '96130','75639','45720','44956','55700',
                          '88631','32261','62017','70825','20902',
                          '43911','10530','82863','29025','73157',
                          '95301','49707','85850','37035','65598',
                          '70685','13992','14383','53369','78223',
                          '59725','60089','81402','56899','41696',
                          '21246','22836','20304','58887','83069',
                          '51700','80474','37660','36051','21740',
                          '90004','18939','30492','56980','42041',
                          '31427','36361','68041','35854','54359',
                          '79286','22402','35445','36635','64879',
                          '99856','18337','14043','30626','80151',
                          '71672','94645','47827','57019','69914',
                          '42918','89193','38472','70133','84000',
                          '70220','38961','92984','55210','87068',
                          '39521','83615','92868','16210','56849',
                          '15162','59748','60823','87596','45730',
                          '99947','55647','60770','55579','53748',
                          '63874','57425','24483','58999','67656',
                          '41874','54273','31666','26686','66662',
                          '23699','75668','69135','61288','31940',
                          '93496','65460','41839','52946','78971',
                          '35034','79266','74065','12807','64216',
                          '32609','95313','95585','44714','74408',
                          '37490','81807','64907','37513','50700',
                          '63557','60967','12888','34639','16170',
                          '15820','27857','18869','31286','61072',
                          '48958','25394','19065','42863','35605',
                          '65788','30527','74885','16660','31762',
                          '44803','27690','51948','56340','52435',
                          '17595','10070','81089','63731','57784',
                          '65023','47524','96516','71970','75432',
                          '11485','68487','68221','60097','40749',
                          '25105','42592','90513','48338','21692',
                          '48682','14987','38199','43243','31576',
                          '47903','93645','60329','41873','61696',
                          '59245','95485','41331','46952','92172',
                          '74700','59014','11287','55610','40129',
                          '14366','80496','59100','77497','28140',
                          '53433','78860','61622','48181','83700',
                          '26727','71219','43358','80642','92983',
                          '43795','69834','58429','14837','31173',
                          '56521','92704','20974','46037','63803',
                          '90687','90207','23011','80613','89061',
                          '30083','45700','76714','43159','91993',
                          '64310','28878','37057','72080','87832',
                          '15058','48620','22699','89029','94769',
                          '67340','13195','45476','31594','49704',
                          '89675','59484','37020','62850','86168',
                          '46377','37285','26162','15040','28004',
                          '34917','38750','90722','38164','77106',
                          '19780','70008','76898','66092','74073',
                          '75867','74438','31928','70755','63247',
                          '51067','37805','34555','11229','29384',
                          '19775','40579','85590','16552','49960',
                          '42115','72671','72368','19858','96109',
                          '41749','96700','63432','93048','34896',
                          '84163','52100','42928','42312','20192',
                          '61825','80215','67543','44963','89220',
                          '87837','40265','86076','53395','36628',
                          '28067','30986','15376','60841','24989',
                          '99538','53975','95295','40859')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


