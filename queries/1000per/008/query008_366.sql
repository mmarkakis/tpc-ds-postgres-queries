
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '16142','43144','78174','77847','26845','23862',
                          '81763','90241','77238','50608','95838',
                          '26995','44933','49048','64320','12874',
                          '93426','92888','71916','60943','21585',
                          '60964','39772','91304','89211','98096',
                          '63618','21931','52205','74634','25711',
                          '43376','36162','30609','57222','88024',
                          '84951','43771','15796','46392','17370',
                          '17676','95241','18859','54751','90792',
                          '25997','98259','51983','29381','98358',
                          '12368','21959','71070','62960','21848',
                          '27123','93025','49508','49447','96695',
                          '80184','26420','75004','79281','21008',
                          '41008','49722','62336','42851','40861',
                          '50663','54492','69329','81781','54674',
                          '43354','26257','89612','37130','91697',
                          '59048','27435','99487','17897','32480',
                          '18884','22262','52289','70362','94030',
                          '25126','92052','33941','14181','35551',
                          '48632','70100','19650','65613','75817',
                          '51658','75232','60238','98136','81709',
                          '35304','71464','35535','44067','98617',
                          '93756','19184','91949','69381','12375',
                          '31921','17475','97124','56575','63810',
                          '15082','97707','29996','61521','41306',
                          '15296','34618','53973','54455','74856',
                          '46311','65304','11802','35310','90852',
                          '45589','32524','84671','92507','98249',
                          '13284','26967','78256','53754','95643',
                          '21180','45491','89953','48952','49401',
                          '56540','89165','67043','11809','72660',
                          '47438','46920','58276','88602','98072',
                          '70970','79442','62146','13232','67711',
                          '18118','71038','11151','33295','24575',
                          '10218','98154','14315','25620','76837',
                          '66211','22197','92400','99797','21803',
                          '24724','60991','39634','43109','48319',
                          '21784','90131','91316','67007','25684',
                          '58659','14400','88096','17644','11193',
                          '80185','73548','43526','43096','59766',
                          '39395','40852','93138','32684','74398',
                          '56743','46087','28055','24410','63065',
                          '46145','27795','95372','32088','79184',
                          '47478','99245','93108','56003','26815',
                          '88708','18469','37819','72363','93680',
                          '30277','49117','33229','31117','36014',
                          '19890','65745','48966','69524','41677',
                          '43252','77256','55479','42616','90409',
                          '19369','48605','62016','61683','84993',
                          '67646','97091','20162','49385','55881',
                          '12189','99252','63645','56364','50228',
                          '40040','81747','14683','36276','60052',
                          '97898','51011','62773','64360','27967',
                          '12963','19965','81176','70146','77807',
                          '19150','56594','24389','81165','44002',
                          '11309','82569','58891','18985','34694',
                          '34678','46040','97382','14504','12866',
                          '58478','68530','26027','58299','61129',
                          '29896','92814','85569','25240','85863',
                          '79463','43435','92654','30922','34319',
                          '63688','74714','11101','20407','47526',
                          '69863','23188','61590','65312','84661',
                          '16668','93254','82621','67862','16413',
                          '15372','53826','61798','78842','33037',
                          '57336','80701','73834','39679','70487',
                          '49458','45075','15651','51009','84923',
                          '30070','24092','79711','52780','78322',
                          '78212','14404','79209','44382','70351',
                          '89222','77929','91972','88691','38007',
                          '33340','55312','51424','18780','27594',
                          '11061','82837','67924','52803','42192',
                          '26093','48444','58726','59693','32170',
                          '13928','92684','38279','27931','73898',
                          '83084','81464','20990','97951','39128',
                          '66698','28695','48841','70593','33523',
                          '80451','50279','65157','73994','70246',
                          '31715','51910','45710','92262','31790',
                          '48872','14714','59884','91708','33009',
                          '71101','94562','41206','37695','20421',
                          '22121','71659','56560','76501')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


