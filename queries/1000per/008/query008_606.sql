
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '68472','31957','32391','59967','53962','36333',
                          '41194','55101','53441','54109','46958',
                          '28671','43970','62789','48252','94985',
                          '19266','17535','49965','63213','31076',
                          '86292','96387','94706','16422','58096',
                          '88832','85207','89471','94741','36410',
                          '34638','39425','71505','41235','89554',
                          '52816','11445','95480','65412','69218',
                          '99830','72479','24559','88750','86696',
                          '98864','37980','40144','56263','30099',
                          '60991','90423','44435','76659','48224',
                          '24613','79822','45362','61073','28009',
                          '76137','62087','41702','66797','97253',
                          '18887','41407','41364','50263','22675',
                          '82626','73112','25591','30682','97665',
                          '49586','32322','88163','81759','42623',
                          '77853','45429','76832','17754','90138',
                          '41824','35272','72952','71206','89030',
                          '55036','23921','50356','50508','50009',
                          '65350','14717','70884','78500','33649',
                          '30002','15621','78809','63197','72551',
                          '44448','93202','55977','43157','92707',
                          '96430','91315','40829','36202','28647',
                          '54786','39471','33181','21255','77575',
                          '78212','74767','97508','17222','96667',
                          '85499','89166','97070','73207','38865',
                          '74796','36156','66318','72518','37740',
                          '93173','60634','72177','11690','18305',
                          '80465','61399','79239','51700','85465',
                          '64440','32652','46399','63011','61473',
                          '68461','17275','65130','77620','28915',
                          '96381','75085','69619','50119','38048',
                          '14490','69366','24513','64030','91504',
                          '23840','95609','10086','42230','87179',
                          '50661','30416','82868','67442','90131',
                          '41975','90142','61312','18803','97247',
                          '36732','32182','45480','20445','60672',
                          '42987','36727','17224','90702','64435',
                          '84585','82087','39602','43638','78436',
                          '33706','95563','26810','79061','77658',
                          '18529','66886','73638','54483','93018',
                          '16036','24439','92941','27541','48493',
                          '92997','16024','65671','78690','18984',
                          '79194','83956','42511','75806','74583',
                          '35344','39732','22395','67233','51490',
                          '88044','42678','69964','18259','95733',
                          '86436','16654','82063','33064','98459',
                          '24832','88602','38767','26530','41115',
                          '40080','39064','43641','40832','18847',
                          '40467','56505','46318','61800','88753',
                          '15198','96565','60137','80837','32778',
                          '80239','75358','46400','13429','46108',
                          '95712','27266','11745','10796','63980',
                          '28854','39874','89065','18110','28950',
                          '60954','32174','96881','43516','65782',
                          '40148','95832','61865','63333','66008',
                          '80565','23908','73771','79677','59028',
                          '40353','12687','62478','53917','36481',
                          '67097','44006','64872','25148','95069',
                          '32118','75864','11659','94986','17150',
                          '31396','27727','48167','25354','57853',
                          '81488','38704','34820','45031','50120',
                          '14750','68614','16124','47773','82537',
                          '21993','52694','65302','56453','78009',
                          '57019','84788','71705','31478','79843',
                          '22565','23410','12341','79525','60398',
                          '72304','67717','77682','79331','87182',
                          '25046','58667','29035','77473','68681',
                          '95396','22280','14891','32915','88631',
                          '99046','66346','43659','47242','25551',
                          '78832','86249','51236','97198','63837',
                          '94360','93128','46888','23776','39654',
                          '73282','52430','22413','92024','53301',
                          '62276','87907','40411','72318','39056',
                          '70263','44647','29696','52820','77711',
                          '51879','39185','98883','88596','36789',
                          '20761','28683','96709','66504','91582',
                          '35911','12065','28269','28341','90932',
                          '85368','26599','26890','72539','18138',
                          '25152','81064','74898','96608')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


