
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '33930','70134','19580','94504','65591','32438',
                          '94688','78185','60827','31593','62265',
                          '31241','26092','46551','93676','40703',
                          '79132','59488','32941','25720','52538',
                          '49552','17252','41694','91821','97022',
                          '10216','56194','38109','93578','81503',
                          '80062','67806','30007','38536','44328',
                          '20764','54497','33473','25981','57217',
                          '89781','98851','74918','17183','58653',
                          '12546','87018','14328','26977','88342',
                          '33468','28065','75621','73236','29152',
                          '15853','91120','78334','40264','40056',
                          '13020','15138','30233','29462','77972',
                          '23674','13147','90908','84461','49657',
                          '20889','23808','14201','83475','45412',
                          '68203','37262','52837','18361','61134',
                          '26496','57676','68104','62383','18643',
                          '18452','38557','41885','18986','98680',
                          '49711','96410','92321','93183','94109',
                          '62773','83809','43301','93314','17376',
                          '59661','28393','63079','29293','27833',
                          '68157','29795','24523','21145','53913',
                          '49789','31246','90732','32185','97929',
                          '40917','47234','95952','64949','49252',
                          '79035','98764','81304','72380','12670',
                          '24405','22477','62000','15658','19084',
                          '84626','80844','21629','21987','65360',
                          '68028','79791','85149','65848','12256',
                          '25450','71189','29091','54501','57875',
                          '12444','79553','46950','40545','52865',
                          '24702','50026','35387','24582','37986',
                          '93477','55552','82341','21037','77308',
                          '85615','89475','47686','19852','97802',
                          '52676','55153','58871','41532','52700',
                          '83995','10629','69706','97976','91876',
                          '34166','97071','98955','53735','17073',
                          '27839','34252','41606','73210','35038',
                          '84142','31980','85151','15675','18163',
                          '86517','68587','68480','63594','58901',
                          '86384','21885','70444','15927','19668',
                          '50376','64242','88830','70858','16748',
                          '99338','10051','41541','51537','33053',
                          '47325','28354','88701','13880','94584',
                          '28917','28272','62475','91505','51893',
                          '57935','25911','11554','78333','49224',
                          '44000','75084','97492','37326','84960',
                          '75397','71731','39205','79869','77393',
                          '23661','52690','50542','76794','87793',
                          '38667','14233','10221','27986','68998',
                          '78709','41968','78302','34248','31747',
                          '23876','86888','24115','49301','56895',
                          '19174','92442','33656','84311','65517',
                          '19642','69286','70810','48134','53952',
                          '62076','68400','67052','79928','45469',
                          '85147','62916','74454','54661','66418',
                          '62905','58029','84472','27984','35212',
                          '81391','71285','36005','92138','80764',
                          '65632','17672','34023','98493','48428',
                          '16190','42587','92642','19317','58616',
                          '42513','42916','42243','84072','22650',
                          '12568','85111','88483','11478','68453',
                          '64021','82406','32885','59467','98802',
                          '64539','36012','33327','21059','53637',
                          '63015','46361','48153','60482','55433',
                          '29012','66830','24211','59413','39108',
                          '88307','10573','74077','19221','39534',
                          '74990','66323','27698','79885','83429',
                          '78721','86203','96053','71725','97861',
                          '34378','35312','53490','81643','81374',
                          '58634','41151','17138','29826','68885',
                          '43147','94526','44113','49027','46006',
                          '53619','97728','30705','81624','91732',
                          '91809','97097','66284','49144','13791',
                          '99544','28262','69358','91496','86795',
                          '48340','40617','92453','51468','60193',
                          '21654','22222','16580','13784','77560',
                          '38215','50507','44227','93940','70144',
                          '16777','19557','42075','44022','20620',
                          '83025','17871','55339','49689','88445',
                          '73142','57593','70551','63445')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


