
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '85484','84475','72699','79891','23778','75664',
                          '93855','68071','73560','52340','48511',
                          '61273','90340','89846','56659','15506',
                          '85365','11076','70510','57697','10230',
                          '25870','73214','83665','33679','97307',
                          '82264','12212','25912','10053','96936',
                          '15282','76572','35172','27841','58404',
                          '54538','55881','27359','93212','28319',
                          '83050','89139','76113','96384','89965',
                          '90634','90959','96123','94986','32207',
                          '61085','95259','45705','13743','76316',
                          '61057','37783','52083','41770','35539',
                          '32654','32555','22143','29634','69038',
                          '93043','60194','51509','28745','63129',
                          '89621','82768','36394','16033','21530',
                          '68359','80953','77088','44084','29652',
                          '79361','96133','55337','93186','33169',
                          '86323','66004','62085','44812','68448',
                          '61774','70654','41992','78673','75245',
                          '37840','16524','60439','94927','48654',
                          '34951','87836','28412','62650','87465',
                          '84323','42553','45547','34381','46821',
                          '45797','72161','56402','63875','79148',
                          '82664','82771','15766','19360','20276',
                          '57657','64762','26585','66780','98610',
                          '61255','26351','54979','26794','61615',
                          '96346','90506','61441','67098','99164',
                          '64360','48908','72837','40152','69981',
                          '81512','88104','20784','70002','40556',
                          '14468','88394','35634','59816','84563',
                          '90570','27513','65203','68297','28709',
                          '43784','86429','48256','45516','10020',
                          '67862','12647','97157','88070','98616',
                          '99876','48009','20929','89997','57263',
                          '95211','99016','50031','31102','55958',
                          '55156','45545','95156','69925','24485',
                          '21890','11765','65029','46515','63865',
                          '40059','27684','79739','43499','41960',
                          '72884','15875','76028','23735','94162',
                          '48090','72713','70779','55996','46935',
                          '11964','43603','28531','33958','59092',
                          '57506','81861','34561','27837','61328',
                          '22471','34927','77233','11630','29801',
                          '48546','27772','99477','13706','75045',
                          '29145','18018','36603','18470','77463',
                          '72820','42599','71609','44797','28563',
                          '36699','91066','71814','23183','61625',
                          '49595','11072','71053','74567','76638',
                          '49194','15398','91260','72883','10326',
                          '47150','38123','32662','45253','92267',
                          '34074','95737','62079','40458','26529',
                          '51029','78382','71420','90239','42050',
                          '73020','99631','88741','82683','40650',
                          '44157','53438','42588','29824','57714',
                          '94682','61011','98697','16042','24716',
                          '40610','87308','83869','24354','37349',
                          '12611','48895','33674','58082','10919',
                          '84661','44541','98420','60084','55874',
                          '94189','85552','91240','45996','99863',
                          '97342','65609','65431','99096','19561',
                          '31720','60378','36235','78601','73296',
                          '34209','33687','59203','43979','76032',
                          '47949','22279','95282','44739','90566',
                          '41205','15158','58539','76771','49288',
                          '79345','67147','33000','54120','36020',
                          '10615','65488','47189','30988','23356',
                          '19015','40939','19379','16022','99685',
                          '45822','90042','97955','75447','27969',
                          '20605','92097','89382','66475','86693',
                          '23242','27495','41244','13329','34490',
                          '52908','14870','59909','77432','47866',
                          '62260','38945','50071','73762','26644',
                          '13989','83005','28168','62784','86284',
                          '61083','72220','66694','29090','92113',
                          '89303','87100','89562','99172','20343',
                          '69671','76735','94889','73187','67267',
                          '87133','96170','29913','89635','76396',
                          '76559','90649','85795','99262','50117',
                          '10619','54812','52438','77459','74248',
                          '72553','31190','69329','42119')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


