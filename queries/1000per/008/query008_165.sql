
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '82655','15526','15737','86682','17436','95614',
                          '11253','97675','96608','20100','69803',
                          '21953','89282','19946','33290','34610',
                          '87554','64698','21087','51490','25290',
                          '45922','70006','73740','28264','72606',
                          '46185','51728','35947','70725','10320',
                          '85815','61239','44559','59001','81506',
                          '46954','36805','34263','81403','61996',
                          '13744','41493','79145','62099','27301',
                          '86132','27122','96923','22879','41261',
                          '72940','21091','95908','34093','47345',
                          '95862','23108','40416','78317','80764',
                          '95222','68089','43539','54648','12585',
                          '48118','12811','52542','76999','73903',
                          '35438','19108','96156','81591','73105',
                          '96063','78514','30104','30413','48959',
                          '18357','92028','74676','98883','57103',
                          '47113','73086','85270','87399','42339',
                          '36209','37986','92485','55708','23664',
                          '94764','42376','18453','87370','71978',
                          '77252','58849','90587','61989','65179',
                          '30429','73162','35472','84679','57518',
                          '84866','17505','42394','95715','32814',
                          '83946','87701','59881','84551','67129',
                          '34539','94937','98640','38596','30670',
                          '43637','88718','45662','82354','74773',
                          '31620','52726','33071','54652','71970',
                          '85483','90458','71988','18099','56612',
                          '94692','63474','28934','69629','79295',
                          '43338','44643','91021','62256','41297',
                          '91671','21586','56384','74081','11683',
                          '33250','82068','53676','91105','38672',
                          '44515','23718','68432','81388','26619',
                          '21722','57087','60979','10821','28555',
                          '42417','28792','67117','82979','82868',
                          '18948','34612','43809','98101','65264',
                          '69691','50810','83451','67427','67278',
                          '19405','11821','57946','95288','22060',
                          '70324','35035','69502','42771','63741',
                          '63711','58889','33165','34464','55324',
                          '99760','15611','55736','94483','35305',
                          '86021','49579','75804','63328','48419',
                          '86614','51641','49206','81392','99043',
                          '45725','21262','75375','34858','11843',
                          '59386','18391','94020','24195','95657',
                          '47286','79939','16321','66906','96580',
                          '88065','49754','42414','77913','34225',
                          '42101','68843','17373','77859','72962',
                          '14566','34152','36618','21661','96476',
                          '99214','95459','13356','62378','90418',
                          '60008','38037','37388','91097','34105',
                          '33030','46324','46412','89798','93419',
                          '57189','46603','11552','98500','95525',
                          '73706','76330','13506','26562','96258',
                          '90596','87514','89708','56491','50659',
                          '70868','32708','57622','17458','42238',
                          '39468','26391','92947','39562','15078',
                          '31468','82189','89560','49896','63942',
                          '14221','45105','70234','14960','64270',
                          '17583','30318','81741','38707','15218',
                          '85199','25307','48161','45100','68760',
                          '71931','16758','60550','54209','31195',
                          '80268','45028','88169','13562','14380',
                          '59825','66412','10773','39191','13919',
                          '79967','62813','21337','50922','60495',
                          '27459','42333','82038','15002','72817',
                          '90523','37321','52757','14321','36584',
                          '32956','32406','21402','60538','53423',
                          '70974','33453','96003','72174','17058',
                          '70264','66481','20305','47235','16729',
                          '88217','20611','40226','37703','18120',
                          '96696','60893','54857','34909','73187',
                          '89000','72989','87736','43390','82676',
                          '30305','80541','21156','50954','65747',
                          '11817','10447','79638','92372','29480',
                          '64219','84444','10575','46426','91103',
                          '68756','75079','54187','65973','19371',
                          '32051','71717','69531','30885','21414',
                          '66895','46633','45957','61348','37258',
                          '10327','80587','97418','61698')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


