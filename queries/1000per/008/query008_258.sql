
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '71568','78943','30769','23781','43910','38269',
                          '36836','67061','95785','22171','92419',
                          '20725','84285','11563','47981','86436',
                          '37254','23691','17170','37067','53662',
                          '56929','39156','14954','24113','51328',
                          '68335','37201','89951','98904','54126',
                          '66831','14036','24925','64110','28713',
                          '85141','56019','86426','95624','10081',
                          '64163','16907','28562','90819','13349',
                          '39983','20789','94112','73321','40475',
                          '28095','52892','21331','58878','63106',
                          '44727','17064','73077','26539','73734',
                          '89475','69350','29389','85049','81313',
                          '37609','78197','41868','48134','83876',
                          '50120','38990','13901','60445','33832',
                          '71214','79279','53937','38578','70715',
                          '24478','16176','46295','61011','28846',
                          '44738','30799','44946','46375','42298',
                          '84113','94909','21088','88220','24257',
                          '14069','60189','58018','37418','43664',
                          '92893','95610','21095','73890','74615',
                          '28613','82078','39067','98359','55618',
                          '69776','26982','11425','32675','12864',
                          '88867','74767','63229','39192','18740',
                          '13215','33793','40595','46787','43287',
                          '58584','21063','66618','13791','41039',
                          '72020','20774','53458','41630','59599',
                          '47058','64174','50360','38897','61768',
                          '77997','83361','21652','68300','59601',
                          '58822','45452','83109','18310','21031',
                          '34537','17635','94800','91587','96043',
                          '70787','69023','49181','45118','66407',
                          '18770','26646','61553','75115','25717',
                          '42348','26797','18134','27117','25533',
                          '25233','16443','94675','85891','99452',
                          '12392','10529','88885','97040','33289',
                          '96916','53805','21696','62818','94170',
                          '45195','83501','70985','37749','70206',
                          '86930','61172','18623','78259','23233',
                          '86607','53893','70326','18033','81560',
                          '82118','26808','44933','18267','30902',
                          '29011','51319','20009','35890','90060',
                          '68328','40966','71873','35350','52326',
                          '34200','18406','44534','95640','25049',
                          '58414','43255','73154','44266','37398',
                          '77725','60706','90461','93817','24877',
                          '11358','96255','47528','23492','67185',
                          '49559','28648','25826','48082','37342',
                          '37543','85789','81422','75479','42463',
                          '96190','88593','34528','89920','13160',
                          '82416','62007','75139','46872','28994',
                          '46583','55862','75259','92752','71163',
                          '53554','54676','94513','57715','60243',
                          '75792','81467','31502','77905','95594',
                          '11864','86513','41269','53009','67516',
                          '15089','59817','34321','66176','65838',
                          '37684','97028','85324','20427','69735',
                          '35251','69997','32053','39483','34875',
                          '25794','82970','52487','76595','95758',
                          '43012','55595','74670','85074','78747',
                          '92162','69860','41069','99224','10165',
                          '79910','54389','95794','73151','93841',
                          '91185','48205','24397','68096','37204',
                          '70432','45969','84287','61016','69819',
                          '17159','89034','15167','16875','70048',
                          '45711','86257','10659','73886','30774',
                          '39002','20193','77423','14310','94764',
                          '18867','38710','19055','37270','12830',
                          '76154','38963','75559','30674','28232',
                          '50060','76161','35862','23886','29752',
                          '71925','66669','85394','75846','98168',
                          '94028','14790','74031','11050','48890',
                          '53877','49650','98047','28669','58215',
                          '22483','25640','96055','16365','95481',
                          '76491','94273','94369','20919','20933',
                          '11526','48078','14669','86563','17734',
                          '78914','39237','70588','25278','11111',
                          '17919','13698','24036','69719','75072',
                          '15184','83981','33803','87229','12248',
                          '70786','11571','58067','38172')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


