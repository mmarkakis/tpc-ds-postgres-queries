
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '40801','27117','21548','99701','64048','80689',
                          '23911','15025','58806','75668','99484',
                          '96512','91656','84421','56200','50138',
                          '37660','58939','24278','29183','92567',
                          '81894','45041','64998','20929','82182',
                          '22598','54680','34595','88097','25324',
                          '49466','68800','16175','82432','68145',
                          '70798','81884','32287','92838','27508',
                          '38429','43538','69788','92814','93082',
                          '80819','11143','89375','48709','68130',
                          '36316','53580','89866','95515','19015',
                          '45119','92803','52538','73623','80260',
                          '14677','71187','72498','55032','99494',
                          '15287','42099','34791','49703','68232',
                          '86820','22418','48357','13399','67545',
                          '11204','12232','13601','14872','32318',
                          '36409','75590','40305','95102','56911',
                          '13938','99902','21686','62171','87136',
                          '32577','97043','13110','54450','16895',
                          '97608','65818','27421','93707','72808',
                          '35055','63937','77028','34154','57372',
                          '61731','39795','10842','22335','47119',
                          '43502','71157','94937','23373','57019',
                          '64712','16073','61397','83107','30081',
                          '55066','15639','53124','60327','97974',
                          '25800','89100','23360','50123','61117',
                          '28384','89101','25554','32542','72731',
                          '26986','78765','28066','80374','31211',
                          '84030','21145','97474','61070','78711',
                          '63646','22306','70974','20803','56778',
                          '83906','10682','72208','21757','48263',
                          '22209','51832','76242','76294','95863',
                          '87364','90996','33367','59493','63388',
                          '17863','52650','62762','73636','81424',
                          '31083','87188','58455','85678','19343',
                          '26313','62435','54612','55381','58968',
                          '25024','58264','48261','21087','13325',
                          '29348','33968','38685','79022','28120',
                          '75562','26342','82670','56153','24936',
                          '42565','59887','51498','69524','29190',
                          '92015','36925','86710','33266','72349',
                          '72934','90156','75870','94321','70189',
                          '84592','29821','74091','25763','19862',
                          '65815','75893','57654','56399','60597',
                          '92314','70770','99696','35226','59941',
                          '78440','22682','39117','87294','46612',
                          '96047','89829','99990','45235','64520',
                          '47000','89070','74583','76096','21217',
                          '18205','74060','21413','43101','91266',
                          '97143','55698','71938','50106','82044',
                          '95931','38990','43224','90369','23792',
                          '89813','95508','12642','47824','98829',
                          '25342','56571','28478','24504','67058',
                          '99765','85464','75203','78131','95531',
                          '41236','88539','45719','64980','30391',
                          '15739','36805','95993','93286','16062',
                          '87946','48033','18346','54571','82833',
                          '17525','88850','69719','59770','34803',
                          '34378','86193','32954','94661','24376',
                          '37788','19180','46994','43876','46887',
                          '71402','26745','21767','54961','43683',
                          '13848','97707','34149','99955','90654',
                          '13665','86738','92553','48943','25383',
                          '93657','50340','33582','81210','57647',
                          '23102','87669','16462','47629','88391',
                          '86768','27103','49113','63373','36554',
                          '55772','37542','39595','51435','87822',
                          '61792','25224','71278','71802','30928',
                          '23904','84000','12959','89457','79990',
                          '24833','90913','18849','24472','34606',
                          '29181','26737','16332','68414','43762',
                          '43980','91095','47847','11222','62871',
                          '32519','42526','13519','37151','25445',
                          '77748','39225','38116','44574','99874',
                          '46652','43873','28902','38285','64523',
                          '31653','61274','82109','11826','90773',
                          '82145','35601','13927','12494','60161',
                          '70212','36465','81057','55952','43753',
                          '74861','57342','96613','42007','24421',
                          '56854','75131','71728','52801')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


