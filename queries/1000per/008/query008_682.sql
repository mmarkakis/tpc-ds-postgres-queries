
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '75479','48866','68613','88960','74346','74063',
                          '24239','61056','57231','48302','53979',
                          '95803','77575','41941','34430','33366',
                          '68433','30130','23695','67082','71694',
                          '82117','21986','33399','81637','62965',
                          '11118','60586','63523','26713','78609',
                          '41155','85731','31571','45966','35481',
                          '82609','46216','19933','33257','41301',
                          '82954','29523','74080','81462','56106',
                          '87716','32558','50282','34608','20644',
                          '46507','42558','11628','29757','88181',
                          '80132','80682','97687','96473','89062',
                          '14664','96772','44378','26702','26423',
                          '34989','13804','58907','45958','37522',
                          '96497','69454','40222','76751','53681',
                          '85995','85194','30018','70243','16086',
                          '64083','84778','93077','38382','25877',
                          '63745','71822','65816','11214','21702',
                          '35713','27647','78672','34050','34416',
                          '49737','15464','90944','97224','34370',
                          '37145','52433','70913','72162','21984',
                          '37109','62723','73125','93744','33292',
                          '52291','64434','53134','81382','48412',
                          '64885','13946','56342','96601','50973',
                          '53829','89795','36120','61430','65364',
                          '49625','93863','71002','61934','98535',
                          '38179','27365','84873','87782','44352',
                          '77637','86950','43921','78032','69176',
                          '68244','98344','15060','33724','54053',
                          '89713','50263','69006','85997','46564',
                          '67431','66153','60146','87499','65522',
                          '94559','68601','56864','87535','61656',
                          '52211','24129','98792','73475','95146',
                          '28606','23421','51213','80251','88061',
                          '30419','55882','51997','86375','60590',
                          '36817','86318','29803','71327','28650',
                          '90136','22552','52533','62542','63371',
                          '82800','55875','54644','78691','36878',
                          '74764','21237','19511','99431','56071',
                          '18581','66546','58144','29087','99501',
                          '96304','27123','90541','99382','69228',
                          '47133','46082','10517','81900','85315',
                          '81598','36996','75386','14968','79173',
                          '25372','94640','75694','48973','71637',
                          '58795','80977','77397','23382','49587',
                          '43475','28069','26448','23323','41801',
                          '94923','50168','23402','55289','67844',
                          '76033','33584','40725','72496','22539',
                          '17720','25852','81609','63286','17929',
                          '48738','79541','79559','39448','38275',
                          '38939','45111','33924','31990','74082',
                          '76098','68404','97442','82112','61871',
                          '39483','73769','67340','98835','56858',
                          '82007','29234','89324','82809','52642',
                          '42329','40525','64791','66211','55708',
                          '83773','30353','20730','72420','63213',
                          '29874','29608','12621','79558','44834',
                          '25290','95649','16235','61247','42483',
                          '34185','82699','12693','55527','85921',
                          '16036','36439','54345','41346','78226',
                          '97689','33036','86329','79602','30110',
                          '69351','28166','35254','89278','23682',
                          '98291','50429','46852','34503','61482',
                          '23278','69874','48828','84535','52990',
                          '12633','37267','13800','64131','40017',
                          '17127','57389','65030','41113','14113',
                          '71318','22751','87594','47935','16935',
                          '42504','78811','60761','79198','91497',
                          '51900','67395','14757','93616','92370',
                          '81816','47386','62848','65189','33886',
                          '24108','10698','36463','66956','72118',
                          '52803','76496','43926','67953','81535',
                          '50237','42013','85362','23016','88710',
                          '22689','14622','22837','11698','29958',
                          '45826','71466','23977','70401','38439',
                          '91068','28660','27959','91942','41812',
                          '25166','42582','95157','42846','29546',
                          '31707','71141','90304','92897','17167',
                          '91782','15925','36902','21278','71362',
                          '89652','10300','44614','95956')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


