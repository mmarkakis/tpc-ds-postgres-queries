
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '13850','43420','54154','52041','10741','97903',
                          '45196','19257','77078','36674','36679',
                          '34564','87315','93273','29344','61643',
                          '57762','40373','90045','42658','15574',
                          '95396','40902','63541','32131','75133',
                          '97524','83888','73920','43848','90808',
                          '89299','28240','38425','37937','69809',
                          '36102','61651','75335','89367','47232',
                          '24846','79618','31952','33456','75355',
                          '53605','40805','89450','54745','31896',
                          '26094','89261','52516','54037','21796',
                          '19765','90905','39898','96941','13022',
                          '60659','51319','70231','71709','71245',
                          '61233','34974','60264','57527','79370',
                          '24749','59583','72197','92697','44626',
                          '56555','50456','86192','32632','44096',
                          '18420','82780','28296','99806','33076',
                          '65086','89542','70390','88820','90441',
                          '81613','84155','93204','87860','27180',
                          '40671','72312','20794','65117','38081',
                          '68043','95318','95699','77200','65812',
                          '87156','89477','62522','69199','52755',
                          '99082','87602','75528','22271','60046',
                          '57251','70337','72657','89773','54504',
                          '13434','36281','18229','40238','63365',
                          '93932','75522','13599','28971','17995',
                          '89122','18019','82679','26998','13703',
                          '57503','80861','51918','51230','91453',
                          '63493','33838','66490','53131','62327',
                          '68611','73688','72580','76698','53155',
                          '90973','25316','38849','94596','68587',
                          '85593','71931','59673','23488','18530',
                          '25760','78892','28496','92888','79662',
                          '47936','11371','34441','84070','99403',
                          '11600','78323','74071','55990','88294',
                          '43438','96275','46337','74875','63638',
                          '94315','93150','93338','66388','15189',
                          '45090','44494','23729','13373','75933',
                          '53124','58611','89246','65077','52581',
                          '52281','41191','72706','65126','24394',
                          '82245','92024','33671','51810','72896',
                          '14422','82027','18468','27265','94359',
                          '68493','74759','28950','68162','69214',
                          '42885','12623','92184','21193','57128',
                          '20550','27064','23841','62099','54445',
                          '22460','83548','62646','33480','11541',
                          '56522','36982','89213','66711','78155',
                          '13085','27450','37040','68939','46755',
                          '21832','83107','82461','45424','52408',
                          '62989','52156','56669','69403','11496',
                          '90891','54862','44074','98966','80634',
                          '87388','68821','26275','99061','75345',
                          '55247','94925','39322','18961','46493',
                          '97040','87162','88253','61212','12454',
                          '47787','85287','77743','58363','38630',
                          '53394','49550','99248','37774','68965',
                          '94326','62375','99272','96052','13701',
                          '22554','79428','39277','38102','44363',
                          '63208','99854','46088','99259','74695',
                          '34103','17986','19722','61183','76358',
                          '12226','24006','40885','60925','43891',
                          '25203','23308','86328','12596','83461',
                          '82524','86943','21219','35141','85226',
                          '16908','56233','88285','81047','43499',
                          '46535','22531','60411','92533','85867',
                          '26704','82566','82842','52698','92062',
                          '38246','94792','43419','89411','12132',
                          '97085','81194','57611','69117','89091',
                          '76300','48201','48869','45313','86944',
                          '55297','25330','75779','96746','93485',
                          '38779','23290','61745','56584','30232',
                          '15810','79022','59590','92893','41459',
                          '51842','78341','24420','43752','42864',
                          '68364','62345','29053','95287','46274',
                          '67151','66397','12306','30893','13012',
                          '63794','77058','78519','13890','83022',
                          '52963','60793','34439','58604','34187',
                          '17397','60103','99344','87982','49296',
                          '45229','84003','15836','92368','12558',
                          '29676','60273','12547','59880')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


