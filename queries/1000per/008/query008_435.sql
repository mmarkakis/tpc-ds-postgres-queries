
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '27681','72583','56960','88604','17820','70297',
                          '62257','60446','68660','21191','26087',
                          '78990','93616','55211','12475','94531',
                          '10676','46054','64885','64879','33632',
                          '72068','38491','74682','76534','55851',
                          '13555','62670','94978','87299','35845',
                          '64794','53228','78574','76177','96387',
                          '95628','18870','17313','38789','21544',
                          '43995','10413','84271','71751','48360',
                          '15363','99642','17331','96061','10721',
                          '50047','35126','38199','56570','81350',
                          '37729','11579','93756','39781','73505',
                          '37224','71992','36988','94936','50512',
                          '72424','33199','73376','85412','10683',
                          '73417','95119','29171','24704','41692',
                          '52111','15518','20387','33844','65828',
                          '47979','59497','22233','66181','37309',
                          '29814','75586','52789','78795','75367',
                          '71431','51542','11999','57697','67909',
                          '52196','64934','45540','23624','72562',
                          '67193','43796','39085','24815','50934',
                          '44739','63677','38439','68746','27703',
                          '40456','76523','80858','39687','71198',
                          '78544','26742','22693','84199','94876',
                          '13261','34890','35208','35485','92766',
                          '12774','86734','15769','73753','16939',
                          '53045','51808','20872','51477','57840',
                          '23353','41778','57740','90998','93286',
                          '32033','26098','99708','20535','51281',
                          '37040','43969','41583','69157','39542',
                          '28534','92262','62332','82483','72776',
                          '64882','33535','45311','54823','89377',
                          '93400','33768','44537','45422','43032',
                          '67446','63032','23149','28322','33069',
                          '73544','54686','49619','37140','25199',
                          '75514','71734','52222','11593','18481',
                          '21311','72520','68092','92359','58469',
                          '60290','26170','34603','47522','40805',
                          '22040','97792','19782','23387','54647',
                          '80230','23997','55498','78351','36397',
                          '14918','80833','48513','86191','72419',
                          '13219','76118','37519','98508','99519',
                          '82318','23874','13949','52194','97688',
                          '51366','92715','13316','55077','66729',
                          '12811','58732','48451','80186','38995',
                          '41795','72886','51038','39816','79578',
                          '10389','69386','18940','52424','73105',
                          '97264','59025','10153','73232','81782',
                          '88575','23101','38646','72486','87163',
                          '15510','87004','97339','99536','62143',
                          '32582','94499','16400','38353','51645',
                          '46429','82981','76149','94642','31911',
                          '67284','36762','25711','50502','66954',
                          '81871','30063','35407','81018','56996',
                          '12452','69951','78455','76543','49531',
                          '96676','82037','53833','85980','37275',
                          '95089','90906','41434','16645','62993',
                          '49395','28444','67037','65098','61897',
                          '74272','61208','48369','97487','58474',
                          '88555','82105','45767','84152','87154',
                          '59128','69336','31391','96400','15937',
                          '81056','87560','69618','79997','75520',
                          '46022','81127','18952','13748','25728',
                          '40039','68938','82769','17694','22090',
                          '94706','27278','97447','48544','15675',
                          '29832','32237','55768','44975','55597',
                          '75528','46908','75635','71184','91278',
                          '65256','39473','74883','42458','62238',
                          '69554','18319','95400','34385','78819',
                          '95053','15498','66666','69053','93955',
                          '69045','57228','49882','24982','50483',
                          '35500','12747','90699','94266','67288',
                          '87983','39212','21733','65260','73640',
                          '81391','96688','76865','38009','18500',
                          '97866','97211','18730','23263','83105',
                          '87573','56609','73935','42721','35739',
                          '58544','72494','29346','16509','52682',
                          '84699','26420','34237','52454','70448',
                          '75247','73457','71899','87514','91306',
                          '54531','22317','33016','16152')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


