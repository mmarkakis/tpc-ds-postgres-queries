
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '23248','45771','77512','84991','72337','86359',
                          '82900','83120','57548','38654','78476',
                          '89388','33116','60306','29714','24421',
                          '70936','18860','20452','48060','24949',
                          '98631','41561','15400','67183','39947',
                          '81227','72152','22969','51852','99776',
                          '95328','71430','87831','89614','22486',
                          '43359','87463','68381','97225','17204',
                          '28967','13445','81240','38011','44869',
                          '10005','77138','73486','88424','39539',
                          '52029','46336','91693','72214','80980',
                          '91451','67741','68749','38794','85022',
                          '18919','99335','95187','60662','84227',
                          '88549','27105','89342','78178','81481',
                          '78027','15129','62518','52753','20699',
                          '42480','73415','92507','73144','36949',
                          '95904','85495','91880','26725','58962',
                          '55812','54059','94810','25201','85172',
                          '22725','68597','35900','14010','95196',
                          '39708','27891','39051','40130','17353',
                          '18741','55978','74182','85299','88503',
                          '70204','60461','89412','88022','30589',
                          '56303','38606','58207','26289','47952',
                          '37625','20527','11418','21648','74773',
                          '44994','26529','14305','71097','76802',
                          '73635','67601','23173','78084','33465',
                          '77155','85949','10510','57723','95372',
                          '59129','27454','58391','63820','21695',
                          '22482','74197','55672','46855','77274',
                          '25103','66550','93415','95812','54150',
                          '36924','50398','99558','83886','19384',
                          '34593','73089','17450','45591','98214',
                          '21454','43040','37277','92211','35416',
                          '81026','72198','34869','98006','76977',
                          '27778','49838','38797','64038','97115',
                          '29293','17505','92762','96748','39680',
                          '19120','77442','59593','89299','75626',
                          '73224','15833','12696','29940','77769',
                          '62676','69781','98831','78403','31925',
                          '85377','77276','37692','55680','53231',
                          '49859','23952','79185','62385','32523',
                          '40508','82986','22796','39093','97517',
                          '47121','28865','57861','64462','74080',
                          '92916','97766','98842','88172','88900',
                          '90924','84311','55152','98737','48478',
                          '34669','44929','27142','57386','74049',
                          '80706','78940','98114','12745','24199',
                          '83119','31461','91669','16423','59507',
                          '69098','51681','58473','15126','11388',
                          '36605','79494','66390','49414','89822',
                          '81929','64013','93529','23264','36065',
                          '98115','38436','34141','24347','48794',
                          '62711','21379','84015','74211','55105',
                          '91166','52416','54594','45055','68857',
                          '95806','25236','58905','11190','31168',
                          '15628','14654','32675','80643','54448',
                          '87232','73428','90416','35436','94518',
                          '51913','80181','83991','65089','76402',
                          '27428','54579','21541','71871','22658',
                          '61577','60966','18668','95569','90777',
                          '32289','64299','16710','56201','79370',
                          '35580','37327','99961','64539','66515',
                          '77712','89620','74722','64784','39980',
                          '75473','46416','53198','54813','38307',
                          '10457','92207','97540','71618','38908',
                          '44046','87166','64573','40551','39723',
                          '71498','90626','92937','42980','30009',
                          '90644','22475','85371','83283','50248',
                          '33321','52982','75723','86809','22457',
                          '52562','27384','52266','56590','13719',
                          '87625','71678','47711','26398','85133',
                          '90044','59845','85940','63966','58927',
                          '31870','21718','10272','26204','13819',
                          '57940','19676','79882','19027','58650',
                          '12273','98181','43891','12934','15725',
                          '69960','71811','46085','93947','78860',
                          '83130','92749','78309','42883','44437',
                          '95626','69367','91831','78185','57686',
                          '25126','81319','97840','84377','74208',
                          '71825','40969','30952','21077')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


