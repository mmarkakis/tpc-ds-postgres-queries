
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '46120','23985','68371','29279','90695','85931',
                          '63726','25212','21022','42401','10531',
                          '31634','19100','59328','75163','86869',
                          '42525','42422','84730','26078','36071',
                          '19639','50147','66217','58370','11689',
                          '75778','25869','14753','39617','10811',
                          '72987','39834','27958','68716','84438',
                          '24553','18733','28420','50740','89023',
                          '66326','24185','74870','53923','36018',
                          '44315','72744','61444','85493','12867',
                          '38861','36356','19276','98043','29579',
                          '76344','76805','95452','76447','72950',
                          '75545','59146','95897','62827','24211',
                          '45566','83956','11059','48012','20153',
                          '50981','41755','21473','71048','29515',
                          '63982','78075','88573','58680','67804',
                          '79987','48587','80280','81114','18576',
                          '98792','28621','87233','85403','83990',
                          '72627','53601','93748','29812','96293',
                          '56595','21194','44649','98413','44504',
                          '42314','45712','66080','11031','82898',
                          '95332','73947','84390','71728','82283',
                          '68239','36077','63083','11553','27162',
                          '78663','10649','34228','31520','70613',
                          '78377','52346','27860','46399','78644',
                          '33406','35106','28928','44792','59205',
                          '75147','35655','65758','93672','52904',
                          '80382','51329','83088','23926','18021',
                          '19179','34553','26930','43513','85665',
                          '81269','86414','45362','65753','56905',
                          '82386','31523','76077','40703','14456',
                          '65697','54680','39422','75943','97617',
                          '68062','13310','32273','77948','25076',
                          '30130','57321','87759','29750','78862',
                          '40671','31421','79480','50434','79125',
                          '82232','35397','53580','45579','65845',
                          '58642','97060','75520','80764','16415',
                          '67806','14112','74175','74284','43361',
                          '36034','85141','61159','33124','89115',
                          '18697','94956','11297','55872','63023',
                          '20671','45030','48307','44048','63371',
                          '33118','80982','68861','76496','48013',
                          '98727','76669','87332','16936','95796',
                          '60449','94661','90858','36464','40220',
                          '77283','40166','94078','19716','30870',
                          '75584','67087','15643','76353','63142',
                          '58855','44701','77253','28601','55351',
                          '93914','52023','36177','83506','74785',
                          '57089','16312','88799','31682','86317',
                          '83522','37934','30822','56872','80659',
                          '92543','32557','69762','29578','59709',
                          '77873','82622','51195','56953','77849',
                          '67508','58896','73706','34677','53169',
                          '15510','69366','68925','29584','42340',
                          '17560','76780','79618','17007','66816',
                          '11690','88451','32266','19129','28251',
                          '36155','40462','12111','26012','81992',
                          '17834','61635','40039','45254','10503',
                          '58659','85703','65345','84381','69809',
                          '52013','98979','20831','80559','33231',
                          '35425','93551','20937','66761','21002',
                          '15811','14424','24191','95950','55135',
                          '43039','70388','44653','69746','72932',
                          '56361','20941','23041','32968','14790',
                          '44555','74542','56827','40727','52560',
                          '64456','21738','43236','98927','53844',
                          '63792','12827','14539','61237','79081',
                          '80284','36421','64142','11979','26339',
                          '79123','30774','41004','90561','74885',
                          '76863','95071','42381','27300','96529',
                          '23255','81829','71747','52064','32116',
                          '86107','44915','55575','73435','89216',
                          '56172','19401','27163','40349','22727',
                          '20134','10615','41399','39622','75122',
                          '53625','21259','88158','40628','26689',
                          '71259','16059','73109','12932','63882',
                          '45709','89595','48186','15669','83728',
                          '51135','14186','15885','12110','90571',
                          '85053','94090','46420','59079','75437',
                          '50029','30085','68691','76026')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


