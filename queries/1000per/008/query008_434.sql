
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '58600','50901','99147','34518','96505','89179',
                          '25364','11857','98693','54408','65798',
                          '85930','69193','64922','97478','80993',
                          '20869','90032','90387','15456','84024',
                          '30504','57727','41455','10489','64685',
                          '20872','58172','83134','77333','23149',
                          '78666','43644','62319','28576','68145',
                          '69778','95722','41192','97327','22494',
                          '10667','94538','72445','78872','26705',
                          '19911','54802','37581','50907','46731',
                          '92512','74677','40154','64115','39726',
                          '64096','97926','20404','85858','63578',
                          '16874','12718','23989','12067','25231',
                          '10709','94287','27038','35443','35036',
                          '68758','86187','13835','50219','60666',
                          '71527','64168','31291','91680','69600',
                          '67009','14551','53735','13379','85378',
                          '53772','89217','21655','24064','87026',
                          '54117','92223','90080','19035','92720',
                          '38692','53059','86302','32245','74639',
                          '69219','48862','81628','54712','33541',
                          '60018','30679','96876','43986','26654',
                          '40200','91477','95132','14942','49353',
                          '32083','17304','33597','24919','14567',
                          '76342','31434','36288','31758','15968',
                          '31475','69533','99438','51903','82419',
                          '25358','70704','55294','17418','73169',
                          '86832','25428','23682','81494','45279',
                          '53167','52319','48304','80800','93473',
                          '10022','28907','12337','34814','30124',
                          '93513','34270','67882','53272','23178',
                          '25560','78721','89018','69754','85965',
                          '90463','85311','17831','38128','97690',
                          '75007','49430','16914','88859','42993',
                          '77292','44248','66376','23004','95419',
                          '80043','79741','31819','45572','85766',
                          '48359','11806','47844','14367','67493',
                          '93761','31179','27182','73825','12254',
                          '49468','73973','20693','54054','12518',
                          '44161','91322','14188','12988','68115',
                          '60947','39682','22127','53926','88339',
                          '28255','67899','26883','11664','98123',
                          '20492','35648','69374','60959','55520',
                          '59039','51066','80880','18606','87279',
                          '48004','31938','40413','57428','82883',
                          '90752','72650','18671','35959','31507',
                          '85805','95067','73505','25063','56984',
                          '51412','32739','69672','66273','66534',
                          '37150','71620','32403','95367','52323',
                          '74450','26869','57477','84584','24145',
                          '34866','75694','70551','87937','46685',
                          '96877','85310','25535','29533','51592',
                          '99709','83346','61295','33246','88318',
                          '97953','47365','29275','67539','88377',
                          '36153','64642','87505','48006','46892',
                          '14266','95156','71236','34310','83285',
                          '26854','23092','64753','35631','41570',
                          '11211','38322','65252','83997','37570',
                          '94187','30930','93214','58062','24180',
                          '34204','72658','54460','44193','87864',
                          '68370','66413','21397','66343','65579',
                          '64407','15236','44099','59669','16662',
                          '16129','97462','60950','63757','43024',
                          '56765','43236','16710','21444','15242',
                          '91787','21099','75418','20414','46160',
                          '84193','42822','90010','22710','79652',
                          '14279','23782','71018','98979','92268',
                          '15878','43315','85439','75917','42249',
                          '72354','55991','61764','25168','39153',
                          '66526','76056','17122','65107','39338',
                          '56280','25859','89081','99501','39888',
                          '89990','24384','87485','14681','26438',
                          '46461','92095','61493','82858','73597',
                          '79135','96833','88169','31105','75844',
                          '15104','29870','21539','21586','51557',
                          '71831','22980','16843','33869','33697',
                          '94081','15505','70109','82993','98540',
                          '64035','67410','29883','44272','67304',
                          '43288','77592','17896','91169','54068',
                          '56782','77001','30860','11748')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


