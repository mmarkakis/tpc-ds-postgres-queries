
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '19477','16634','25303','58723','91486','48706',
                          '11901','54639','12756','71543','55237',
                          '46849','11211','57713','35682','47308',
                          '64842','65655','87744','69572','99467',
                          '99513','13354','56059','95893','46634',
                          '47547','74820','72677','16777','90594',
                          '79463','98184','69803','15167','68386',
                          '23993','39949','41287','10532','72674',
                          '88597','72334','60120','63397','43448',
                          '92656','49973','83071','43018','99394',
                          '89682','74828','77490','56144','99433',
                          '35761','89167','63792','27782','46941',
                          '34767','98570','26408','91003','28136',
                          '54864','36368','72515','82620','17805',
                          '40806','47300','83715','95824','70502',
                          '25486','47640','74078','31249','62586',
                          '75948','65157','40682','69047','36319',
                          '61683','69508','79759','48371','25841',
                          '77092','52562','83506','41893','28795',
                          '49943','60165','63720','61986','80159',
                          '70770','11090','51221','65352','70343',
                          '69239','67383','79159','33461','47563',
                          '12618','22030','80729','21718','89967',
                          '62824','55535','73005','25358','49110',
                          '49252','64992','63671','39622','58268',
                          '90531','28056','65924','69363','83232',
                          '33924','19680','12886','69711','97451',
                          '54570','35466','25421','76187','32549',
                          '98999','71699','16721','12701','44525',
                          '61543','98928','46587','75437','22768',
                          '96958','89855','90517','25704','18251',
                          '52510','34093','83624','58684','27338',
                          '75224','82321','85813','95261','76597',
                          '54763','39641','20614','53321','16958',
                          '67898','48052','76510','95692','95271',
                          '82700','91051','91516','84762','76040',
                          '67374','64406','20648','64756','88125',
                          '26355','38417','15346','50428','95333',
                          '31449','84402','71645','33826','14029',
                          '49442','91503','82699','60818','16339',
                          '73815','48777','79890','92158','20104',
                          '82162','52934','74932','84980','85700',
                          '73840','18179','69111','97562','93422',
                          '35014','54411','92667','19248','74221',
                          '76377','31573','27914','53489','15033',
                          '10436','72001','78835','26187','10147',
                          '80989','42568','28770','63746','49203',
                          '38078','21806','30324','54212','71241',
                          '65649','90539','58433','87171','67702',
                          '22313','63343','63875','83489','22792',
                          '88153','90689','10424','90855','14695',
                          '66560','25656','88737','89745','13284',
                          '24237','64658','17327','84024','18239',
                          '18333','25475','61004','38007','21386',
                          '96701','79941','43520','85496','60485',
                          '74034','17245','50641','96213','23372',
                          '28957','72411','66929','40885','73452',
                          '91496','55558','64241','40155','25498',
                          '78136','35341','25439','17142','82138',
                          '96765','15454','83462','39280','75489',
                          '45182','82656','12570','35692','94802',
                          '85583','90963','87050','31696','94387',
                          '45372','59297','24050','79424','96211',
                          '83866','93679','19462','29927','10252',
                          '38446','21838','81966','17835','10817',
                          '90110','77796','97632','26197','31387',
                          '66164','54021','78159','97930','47712',
                          '20766','41194','41917','37463','96850',
                          '31274','72445','28719','59904','62258',
                          '91133','97413','59831','64077','51494',
                          '15368','27272','45525','47201','65938',
                          '92279','77216','22472','14117','28156',
                          '40479','96265','30406','31350','17505',
                          '36431','48065','85718','49038','73119',
                          '98457','57091','94129','41637','79847',
                          '23426','40746','37094','76841','30609',
                          '39764','78103','62852','34892','78485',
                          '87388','33212','76755','54463','92840',
                          '38520','35385','31247','51696','51239',
                          '91605','40765','62725','34223')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


