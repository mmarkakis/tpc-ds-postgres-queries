
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '47789','47970','50013','88167','92598','43730',
                          '10758','30755','40915','29607','95770',
                          '53292','96095','46587','33174','33741',
                          '74569','95830','97565','12434','50682',
                          '92377','91055','19067','30490','32095',
                          '32779','80769','86731','60179','55909',
                          '44604','46790','49337','31182','86289',
                          '58997','59843','73867','11076','60697',
                          '98192','30398','53573','25043','21796',
                          '14646','87973','65947','30936','51947',
                          '82898','68784','32115','52382','14854',
                          '78819','20154','48498','15848','26979',
                          '34103','24810','90699','71736','31665',
                          '57232','97464','17045','65752','15244',
                          '38226','74639','21506','10198','20795',
                          '75501','80623','26111','34825','62545',
                          '37939','34522','47794','63630','27219',
                          '66180','11610','84958','21053','95018',
                          '77225','91011','57901','66360','28341',
                          '12556','29336','50303','15559','11414',
                          '59282','12853','32704','20480','42329',
                          '87890','98351','30472','93883','11072',
                          '67331','78017','45691','39543','15415',
                          '82864','46527','35718','40443','52222',
                          '81755','14452','13393','38731','40927',
                          '57449','27293','20600','94633','36130',
                          '71554','21117','97377','44580','13851',
                          '78820','28076','17756','69403','88379',
                          '19071','37790','89796','25038','88269',
                          '25176','43240','33433','78912','52188',
                          '21864','79398','63278','54132','14328',
                          '71186','86587','96345','63972','49698',
                          '50801','68710','56427','96288','49485',
                          '35786','78521','48993','27881','82579',
                          '34808','55614','38925','93692','15531',
                          '13228','84623','26095','59726','49385',
                          '38726','94495','85614','70070','11309',
                          '60217','99947','20922','43602','79807',
                          '23665','10518','80251','76644','73948',
                          '35483','50363','36873','13450','91894',
                          '61139','42579','75061','85706','92305',
                          '27563','38644','71604','38382','34806',
                          '96220','35396','97168','20172','96176',
                          '41093','71543','91774','32110','58183',
                          '42830','57323','60681','63140','88690',
                          '55262','44927','38302','69004','52983',
                          '40684','34067','18835','89546','40464',
                          '82243','89932','24147','85363','42032',
                          '31544','21312','76643','76648','51188',
                          '92591','22879','43910','45723','88730',
                          '86303','18133','13477','34641','16051',
                          '47495','40651','87106','22190','90715',
                          '12074','38603','24486','91142','21003',
                          '50022','36939','63930','14095','47211',
                          '37463','34192','96103','72119','24411',
                          '51216','52291','49924','99225','75605',
                          '30287','13337','85216','84805','78984',
                          '15845','17634','53836','13303','68671',
                          '21821','93413','58518','94167','81067',
                          '53471','72525','76124','89283','25905',
                          '49233','84174','63463','54040','85731',
                          '82440','97995','65083','36020','91098',
                          '66529','67209','64341','15438','84559',
                          '48221','91248','81433','98855','26064',
                          '30213','18262','83509','80976','30787',
                          '11170','89471','57978','63451','67320',
                          '27341','81845','34851','63448','68801',
                          '91993','58437','42683','30476','68308',
                          '99214','64771','88354','83538','17550',
                          '92808','79359','73883','59607','12632',
                          '41851','18429','53793','90287','59007',
                          '82940','11734','57127','77360','86672',
                          '22328','42051','14602','59685','17966',
                          '21050','55985','66217','34312','10183',
                          '37786','92626','62708','87209','53605',
                          '11308','12988','89247','26435','53129',
                          '88174','71411','12165','57781','38723',
                          '72161','55201','55650','25054','55416',
                          '13137','77923','93897','37439','44398',
                          '24724','47786','35252','53416')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


