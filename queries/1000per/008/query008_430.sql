
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '71778','61491','23241','18345','54009','69247',
                          '91531','61907','99598','62117','42706',
                          '90753','74952','65455','68665','72570',
                          '51594','21036','23354','69947','92735',
                          '29187','32564','66842','37647','79961',
                          '24691','59962','70056','82256','91014',
                          '90047','52091','60156','15877','68661',
                          '54625','32184','19561','13551','30557',
                          '51293','61121','93270','58930','31046',
                          '25209','53600','23947','83096','69317',
                          '58116','75162','16749','11661','26780',
                          '60558','55687','22238','25747','77992',
                          '78329','31192','16278','59001','38767',
                          '77204','72950','69355','27740','27715',
                          '70492','16605','83433','98381','54081',
                          '23406','94632','10686','61950','98058',
                          '90763','65285','72448','74543','87066',
                          '13125','86921','70115','25451','63176',
                          '82094','63268','22086','74905','95498',
                          '33136','61471','71354','89982','15243',
                          '62336','23210','59961','91200','67647',
                          '78201','77514','98209','63360','90830',
                          '20529','17966','90547','45525','16535',
                          '62926','14920','23084','30495','27489',
                          '50991','63399','17769','76798','69737',
                          '78244','52848','93817','50862','92372',
                          '61094','55338','63270','28221','24669',
                          '46270','55156','31935','74732','67825',
                          '81808','69558','86985','78800','23522',
                          '49949','78677','88718','95220','69482',
                          '34058','66388','60078','38732','50326',
                          '59223','95457','10119','79830','58583',
                          '64514','79756','73154','12241','88971',
                          '66005','54032','55300','14207','17335',
                          '42545','86816','76456','96826','43498',
                          '63708','30599','82257','22749','56767',
                          '77645','94304','86520','89536','10918',
                          '11615','13295','35924','92392','71292',
                          '24571','40332','78028','70185','85748',
                          '19607','14460','10725','34668','69143',
                          '54458','36439','68923','67744','73908',
                          '35978','94178','62017','79196','73065',
                          '38893','27630','97282','40252','23401',
                          '23641','51023','87717','72283','61434',
                          '72389','46189','45807','18889','50439',
                          '40162','93984','19299','73393','71720',
                          '17921','17443','41047','43154','32537',
                          '12574','48425','98511','25971','99588',
                          '69841','57918','51392','63830','70045',
                          '89666','12974','70898','90081','12805',
                          '74525','66305','18608','18165','26571',
                          '38687','14369','84050','50556','14522',
                          '96973','35875','82061','24007','71918',
                          '46864','75687','27534','50715','90904',
                          '57820','50743','39599','15226','11421',
                          '58082','32951','74301','92732','53603',
                          '46306','37253','43490','85191','35206',
                          '27659','38750','25189','37904','52446',
                          '28613','76136','96093','64958','39635',
                          '55337','53289','49439','55264','10850',
                          '55352','94942','66884','42266','45019',
                          '44671','64212','89547','12268','26565',
                          '65534','45573','44296','83399','93284',
                          '89854','59791','25602','32080','88159',
                          '58732','55223','48366','20300','99911',
                          '55232','60565','55642','80638','35302',
                          '57658','41800','52838','83128','15534',
                          '55670','12169','31204','77527','49416',
                          '73837','61050','51079','38754','50531',
                          '78230','41081','63140','25329','27766',
                          '89186','72039','32539','84148','27705',
                          '58628','59697','90293','14968','55413',
                          '49014','62016','81078','95599','51536',
                          '84071','91100','14458','82266','36987',
                          '86201','38794','82213','51360','99889',
                          '28262','98040','16816','37092','86076',
                          '94829','98056','79960','91747','87384',
                          '90333','97455','40037','46872','14111',
                          '72842','42585','18815','58493','46440',
                          '28026','12660','73295','40722')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


