
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '29755','57300','47322','78900','90745','85519',
                          '67997','61082','50559','17965','71463',
                          '90594','10362','52341','76346','27875',
                          '87373','36179','33869','76770','51449',
                          '24812','75176','37808','96365','82490',
                          '19846','79343','30454','59124','90147',
                          '82196','65700','92181','62389','78317',
                          '64332','93709','12481','52133','52623',
                          '67314','13981','19061','99694','36453',
                          '26886','92563','52722','76564','54324',
                          '80935','64113','36883','15366','68459',
                          '55050','61974','14594','25119','47774',
                          '37821','59789','80766','88325','50882',
                          '77086','19505','34262','47940','63577',
                          '17542','36055','67229','72938','53469',
                          '52270','79096','86608','58816','85420',
                          '20380','80825','34566','17140','61116',
                          '20084','33411','64821','55014','37859',
                          '21102','40833','81388','22370','44454',
                          '20883','32983','41707','57120','27180',
                          '22182','46570','94133','30247','92668',
                          '10635','95889','91451','26221','15514',
                          '34656','61908','30629','67202','82572',
                          '11074','10973','46433','51929','50820',
                          '35118','24859','78582','35739','37783',
                          '22546','76819','78833','40911','69071',
                          '61500','10791','25662','43830','43447',
                          '50017','68891','93247','29801','61306',
                          '13116','84229','38213','49103','88938',
                          '54731','55917','30402','55712','51669',
                          '37984','10620','17878','55138','38749',
                          '53797','58875','89444','86741','40084',
                          '17585','58105','26297','46171','54871',
                          '90336','27510','79952','41482','51114',
                          '43167','72866','32518','23861','41014',
                          '26291','94231','47042','50734','65326',
                          '35834','77353','80760','15114','21881',
                          '93504','29449','53982','36931','41690',
                          '12806','61000','59487','46361','56897',
                          '17688','32918','63440','79086','49268',
                          '76071','22159','63740','25980','90922',
                          '32896','58262','27415','82656','36556',
                          '40264','14745','49770','17256','39401',
                          '75478','95843','80171','86766','61368',
                          '38858','82013','64471','82375','17717',
                          '91869','56142','63707','25996','13396',
                          '33368','45178','71984','52581','73799',
                          '24361','92571','61055','17090','59715',
                          '51145','90787','59471','91459','85481',
                          '95631','33486','42662','26351','42965',
                          '20090','88681','56363','94296','99811',
                          '16052','18510','55363','76787','40008',
                          '38387','10190','41587','84393','54046',
                          '73816','28135','30994','64527','36520',
                          '87515','25814','42141','46835','10015',
                          '36772','46552','66341','48493','36865',
                          '10752','60653','56317','52758','20121',
                          '64740','74038','32014','48091','93227',
                          '81223','76066','29332','25095','17014',
                          '63372','85600','51939','16753','86345',
                          '95758','37252','27352','65839','66868',
                          '18545','36975','55633','43616','37766',
                          '61175','25366','60510','75000','97736',
                          '67082','10971','91416','47697','96039',
                          '54352','16208','65761','63215','48771',
                          '11081','36978','94570','90589','87224',
                          '78091','80674','48507','80160','72329',
                          '32941','47870','30686','79773','22563',
                          '64695','88792','80651','55407','15283',
                          '43159','79414','54950','13182','64001',
                          '66718','72279','48611','14624','49124',
                          '88032','39289','40188','27461','53993',
                          '78963','51299','14070','45762','80979',
                          '58843','50397','75364','13185','49614',
                          '62318','74112','57953','81376','27349',
                          '16348','46721','77376','35750','28666',
                          '15535','81742','35692','20495','67418',
                          '78749','42763','39626','98740','10915',
                          '87570','13293','13685','17242','70656',
                          '20875','38925','27239','90080')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


