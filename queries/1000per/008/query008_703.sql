
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '61428','22582','60952','39164','96070','14316',
                          '41979','56549','24291','64341','44753',
                          '76169','33320','15529','72397','78836',
                          '13398','76006','61047','45679','26845',
                          '12134','37190','88400','53426','78975',
                          '24301','20832','82872','23864','56270',
                          '86735','96733','15162','98649','27831',
                          '59397','29558','54224','91222','17733',
                          '57749','43346','83211','66500','60435',
                          '91728','81707','62877','26823','90467',
                          '81607','14056','90994','16826','72919',
                          '81826','60516','50382','42982','47420',
                          '17218','62563','22048','67272','68748',
                          '30200','29547','24264','35648','88096',
                          '12536','19007','20194','74432','17494',
                          '73398','79737','70150','17669','59357',
                          '64864','72095','64507','17830','13545',
                          '48845','23578','65307','20477','28094',
                          '88562','43845','79690','10762','33586',
                          '92068','94880','10882','42256','62302',
                          '11758','96829','79746','15999','74358',
                          '25439','47069','26204','56958','40757',
                          '94504','94734','63385','93016','84250',
                          '40477','84874','13729','57959','15886',
                          '34953','43466','80264','97443','54210',
                          '74789','69415','68104','48933','33336',
                          '98640','25082','52688','17935','93716',
                          '32054','86295','51687','97609','77330',
                          '39920','89079','18248','36975','14924',
                          '42288','33702','24665','85694','56454',
                          '72033','31248','38603','69233','89672',
                          '83925','36577','37158','31115','53799',
                          '28569','69513','68235','24831','28968',
                          '13103','42165','74601','74274','34110',
                          '76272','91449','14321','43603','18867',
                          '11341','54314','99008','69149','10924',
                          '70583','58920','75260','33591','44984',
                          '39001','26693','77901','63353','71953',
                          '82861','37585','72301','67167','73733',
                          '42920','77869','62128','84105','90328',
                          '72230','96361','37671','91679','86160',
                          '71471','39900','57568','50576','82278',
                          '94978','28208','98105','58459','86015',
                          '84672','19023','73589','36317','34470',
                          '74985','16144','72032','78964','24861',
                          '55369','89641','64405','81472','23733',
                          '55002','19713','12757','54853','35095',
                          '68527','10046','90348','44596','68772',
                          '25287','89879','26633','26012','14103',
                          '29954','42785','92402','16287','54597',
                          '94563','79621','16108','66548','54081',
                          '31681','86983','67642','11826','27899',
                          '62099','34267','62307','40428','19635',
                          '73357','86944','66248','20929','42060',
                          '54124','95593','47357','74796','25533',
                          '72538','21073','67098','87926','74123',
                          '44639','45550','87091','13886','40255',
                          '76441','26557','13418','33643','24422',
                          '75979','54945','22943','14810','54287',
                          '52584','26745','56521','80480','29640',
                          '85079','12236','10717','98669','16894',
                          '14322','82244','46956','45097','59149',
                          '17864','19540','34176','50823','72105',
                          '40539','77067','18535','94493','29175',
                          '23395','52306','84523','28222','35895',
                          '54858','10959','84192','63661','86078',
                          '48388','49308','78801','11631','72853',
                          '15432','85608','11761','11942','12006',
                          '29599','30116','11074','59204','72235',
                          '71819','10701','97928','67013','59096',
                          '30747','32723','91107','42140','43946',
                          '67990','25038','94971','79348','96920',
                          '92909','79908','68767','17448','98870',
                          '67041','35524','70114','54426','57455',
                          '61956','51228','20244','71618','16767',
                          '59312','64694','26233','52079','45907',
                          '88530','94600','79355','11614','33480',
                          '60959','63060','82147','47298','91045',
                          '79506','79265','16572','68912','57220',
                          '11291','88704','35697','54198')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


