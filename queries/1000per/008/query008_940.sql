
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '52550','55137','76544','38923','56452','24580',
                          '69560','97443','18167','50207','16226',
                          '80033','16322','90050','48285','48648',
                          '40929','64988','32454','97348','90447',
                          '86405','89014','10581','44173','75738',
                          '79918','80036','45965','93832','15842',
                          '44846','35229','98525','21850','50304',
                          '84275','67562','63468','25009','64083',
                          '36501','23445','46463','50877','50499',
                          '88005','98978','19211','36306','22244',
                          '78040','73567','82902','87005','62281',
                          '70459','87008','38302','37149','23864',
                          '59659','34589','57588','26301','48407',
                          '99222','26799','43035','17857','50922',
                          '45405','85377','67349','46992','12625',
                          '26032','85540','36805','31689','15313',
                          '95701','55636','49208','65358','32898',
                          '30622','80603','99436','47712','19743',
                          '81196','60653','85294','91662','99781',
                          '52790','84945','20109','26202','45844',
                          '73793','89067','54041','63265','12575',
                          '77926','63682','99374','66309','78239',
                          '18887','59424','67789','58430','57467',
                          '53071','41255','42751','86049','18615',
                          '87641','86571','58902','14687','65145',
                          '99827','31039','51244','18427','73266',
                          '56680','57612','12629','95452','39071',
                          '79185','10203','38765','23317','47165',
                          '71826','24897','44689','40626','91767',
                          '26548','95031','86118','41356','60241',
                          '34608','72555','73897','75083','87920',
                          '29348','33580','58535','45744','95256',
                          '87762','87540','64928','24560','12058',
                          '97352','96164','37291','88530','64417',
                          '27793','51040','59385','62395','82381',
                          '92891','56033','73935','12349','41651',
                          '91096','52835','85790','10421','21506',
                          '14881','69610','74186','26288','77874',
                          '86457','11366','28949','27830','19528',
                          '36376','87523','67062','41171','98472',
                          '15021','65457','15120','55875','86107',
                          '60288','83885','90174','97876','77565',
                          '62438','12445','20607','19362','86220',
                          '75828','92635','95424','74513','75969',
                          '60701','72745','20046','57725','97417',
                          '62242','15680','70170','94830','51006',
                          '22485','67820','73071','33582','24834',
                          '53495','28127','52040','52023','23316',
                          '10437','13065','30628','50569','90360',
                          '50523','54144','27258','53203','50777',
                          '33929','43651','74678','21323','91913',
                          '51591','91808','48692','45017','58441',
                          '59164','87596','82369','60056','93834',
                          '57165','29139','63583','34999','92098',
                          '21215','96115','86331','78419','98521',
                          '89282','12004','87160','79355','61413',
                          '46840','58006','73382','21079','36656',
                          '93617','59817','41473','29448','12315',
                          '15324','18253','90221','24458','63978',
                          '26977','88849','60843','64591','89706',
                          '43541','47709','11773','13078','39659',
                          '55448','62253','81666','42362','37739',
                          '45506','54194','15944','91196','99964',
                          '45273','36022','75987','38019','30015',
                          '59069','24915','81664','10630','87262',
                          '91671','82123','74819','41755','58617',
                          '18414','62147','15187','45937','60522',
                          '93427','76049','56850','85461','54466',
                          '56430','22469','35010','49033','76705',
                          '59558','50509','13342','23184','23637',
                          '64318','32598','20737','47538','41070',
                          '19650','22211','75792','28643','98884',
                          '95191','94701','80850','15237','93410',
                          '32988','30456','63728','33112','97999',
                          '92155','83327','90754','53981','15189',
                          '48001','95225','17440','57638','51575',
                          '30957','54956','69369','41000','27471',
                          '38355','63055','33516','46343','54876',
                          '76281','87688','75849','95333','47006',
                          '41011','79497','79384','85589')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


