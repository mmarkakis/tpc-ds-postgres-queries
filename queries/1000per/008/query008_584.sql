
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '88524','42941','84813','88464','88455','37308',
                          '86555','59346','51452','13787','40302',
                          '60553','11926','97612','65525','26053',
                          '63561','78542','67012','55119','41432',
                          '58178','76174','10877','17131','70401',
                          '43148','12368','11177','45078','34559',
                          '13959','36622','22589','49114','27964',
                          '81513','91638','55032','46429','39253',
                          '85371','30562','70838','52636','29346',
                          '98026','85516','61562','51487','88519',
                          '92832','73128','90054','32246','80874',
                          '75406','82310','14247','59816','85180',
                          '16671','68891','20192','38333','45804',
                          '46342','19729','47263','77231','61965',
                          '21040','87974','23092','49583','76462',
                          '70110','23140','43800','43919','76828',
                          '83297','89992','69193','17832','70273',
                          '12992','33476','73052','58424','96925',
                          '55306','48871','73898','69024','66738',
                          '92645','54549','17629','50301','70664',
                          '49294','88110','28042','30196','75496',
                          '79162','25410','15577','12609','75691',
                          '59013','80450','95501','83953','19381',
                          '27151','61414','77741','99480','34882',
                          '67483','19249','42030','29429','53261',
                          '50434','14984','33523','77979','63785',
                          '12315','67823','49794','58939','12589',
                          '96852','57944','14145','23364','76772',
                          '63668','98534','52552','56390','59623',
                          '27246','21028','29160','82426','64973',
                          '23781','42436','14096','89456','50854',
                          '79058','87449','63241','23553','29042',
                          '41075','76486','59537','27565','24734',
                          '65936','81071','81107','47063','53249',
                          '69989','92365','31946','26222','58097',
                          '10785','61533','70446','18716','54386',
                          '42283','88624','28357','53982','67444',
                          '56228','30651','32578','48223','39669',
                          '95916','68889','92945','47636','14027',
                          '32727','91542','76427','34002','58274',
                          '11366','96001','64599','17803','12795',
                          '28340','96116','27378','91546','60865',
                          '78582','79314','61209','47304','98246',
                          '92456','67418','33075','85906','13837',
                          '47072','97690','93672','21083','84249',
                          '88949','52387','88018','54459','75971',
                          '55538','25750','56893','48007','52899',
                          '61505','59204','69417','42991','34858',
                          '91802','67000','49149','39181','17719',
                          '92482','77416','23164','35491','48799',
                          '19866','93025','96167','76207','61339',
                          '44758','20322','15585','93138','43969',
                          '27148','48383','62189','38998','38646',
                          '48621','35672','20126','19679','51546',
                          '25031','77550','62824','26684','96483',
                          '87415','10939','95068','27173','12376',
                          '35538','21982','92942','82499','29373',
                          '64818','39762','80286','55496','19686',
                          '24611','75796','90462','13994','71070',
                          '17279','49233','72574','55925','40387',
                          '53705','24661','89830','29811','68028',
                          '37992','48946','26646','81073','39703',
                          '66359','82458','74784','60221','80481',
                          '84644','27780','64667','70088','61001',
                          '33644','15310','59601','54874','62675',
                          '71006','42313','29885','93330','79036',
                          '87600','89029','35680','42891','85832',
                          '44687','72004','55265','85114','68475',
                          '20622','72310','81952','43797','56358',
                          '34484','70936','73016','92309','33928',
                          '25347','78485','17890','65815','56896',
                          '85208','41772','77810','96098','77740',
                          '16482','60999','74206','48147','34003',
                          '10930','35662','63122','84997','33414',
                          '58570','92517','90505','29157','94840',
                          '76983','18327','44118','72677','76971',
                          '58206','58278','12638','17644','92861',
                          '98647','41740','49405','61121','67436',
                          '80650','91726','47383','37849','39472',
                          '56343','98665','49689','62432')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


