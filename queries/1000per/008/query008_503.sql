
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '22455','24047','66500','64448','65948','25897',
                          '12557','96596','12227','74366','57811',
                          '72831','50798','78915','83055','36885',
                          '36942','93680','97859','72399','91936',
                          '77425','30607','19500','62356','87604',
                          '75405','19678','25811','28611','18833',
                          '80658','94485','44778','85074','71536',
                          '12266','14142','73820','69983','48013',
                          '34376','39254','94811','56596','76168',
                          '86912','88295','38755','12284','30342',
                          '42100','62445','69287','63173','83704',
                          '12018','34689','79420','57994','35095',
                          '71589','70646','80591','70951','66156',
                          '86199','63474','66116','91472','24457',
                          '54973','85100','79043','22066','74149',
                          '85747','28105','46257','29296','87108',
                          '58703','12803','93004','86852','81904',
                          '51087','25931','61163','24028','61601',
                          '31895','53632','73859','17474','42153',
                          '18718','64372','76837','15907','74973',
                          '48221','55610','15835','70217','60863',
                          '10228','72487','36934','89367','99629',
                          '76692','44946','54063','28327','86132',
                          '15442','94238','60196','51092','97309',
                          '26092','98079','80228','88301','53825',
                          '17048','63453','22528','88452','50307',
                          '71250','72983','87934','70967','69514',
                          '82480','12785','10632','91495','28637',
                          '83760','52891','72019','93764','53963',
                          '84390','72753','36252','15121','16060',
                          '13159','38402','75865','98267','26639',
                          '43111','13544','26211','21747','27949',
                          '93727','58162','99437','23859','85406',
                          '91996','25644','53970','42140','22548',
                          '63873','48932','12767','24759','74839',
                          '92273','50113','74165','15478','45594',
                          '38804','76623','32728','33218','33155',
                          '65524','60506','85226','25667','86436',
                          '19614','86800','20885','17423','25634',
                          '84185','84649','47348','74073','24030',
                          '37713','98979','32270','40424','34043',
                          '72292','71811','97795','54776','91507',
                          '41310','51339','46883','25385','69970',
                          '98942','72155','63189','92325','50266',
                          '66675','63716','94121','55491','31236',
                          '93974','81430','55507','51880','64621',
                          '15015','15623','73462','62598','22047',
                          '17621','93479','90013','86352','73861',
                          '21653','77832','39966','83769','62623',
                          '50161','67441','93189','93275','45898',
                          '34895','13972','81349','69661','19830',
                          '29136','93734','60874','16756','33804',
                          '94970','73920','27430','82633','46645',
                          '31213','51693','62374','50065','38069',
                          '52332','66020','95682','95177','62703',
                          '62402','83967','44511','49640','55363',
                          '86612','55735','14054','11661','26665',
                          '41524','37940','62652','22046','13693',
                          '94757','62501','96764','60656','20968',
                          '78276','67515','62400','36352','39064',
                          '17385','21773','99323','27977','83763',
                          '12856','87653','98586','69070','67410',
                          '53148','36949','53570','64632','85252',
                          '32848','51658','95020','53532','32793',
                          '78475','23379','21585','81031','12880',
                          '77055','48590','99296','89340','49543',
                          '31423','21517','93365','22266','39798',
                          '93042','82487','33720','10054','26533',
                          '79037','75510','56792','29208','43347',
                          '70900','19610','66992','63475','41568',
                          '13505','20519','31991','76963','41876',
                          '89343','86410','80965','55779','79528',
                          '84830','39835','67289','97116','92584',
                          '30420','49528','59673','10330','49171',
                          '28288','98471','32312','91634','78385',
                          '19929','33793','94138','19560','78397',
                          '25538','69475','81304','53640','50350',
                          '39565','46947','27303','82838','76754',
                          '73985','78208','29423','90673','96293',
                          '33717','90883','58952','47132')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


