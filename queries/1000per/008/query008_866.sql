
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '75658','80318','85980','85074','34559','80602',
                          '20532','37728','73575','41427','16049',
                          '79556','80542','34776','87426','27249',
                          '13047','35572','97991','88480','45696',
                          '53381','55280','22767','65798','39348',
                          '17777','35961','77951','53933','93033',
                          '80253','52622','53145','62837','19616',
                          '81987','13127','78640','27775','67168',
                          '43826','19696','91546','40391','75225',
                          '48656','74292','64252','96747','50557',
                          '81117','37742','56792','19798','52785',
                          '41439','64886','61974','77084','93144',
                          '59241','20192','36620','42411','56874',
                          '93558','53313','12840','28598','33239',
                          '47659','99579','87204','63319','77876',
                          '25595','50929','72202','69485','53259',
                          '69536','13837','46031','86790','15661',
                          '69295','11254','87898','51744','41762',
                          '58775','23570','38018','98171','62537',
                          '24203','98349','70995','54864','63742',
                          '18027','12969','96036','58339','66177',
                          '74127','45475','29835','54532','55422',
                          '65657','95029','81305','17892','39052',
                          '86220','90558','45776','63595','32095',
                          '62347','47597','88968','38356','78403',
                          '96069','46367','52490','15973','92946',
                          '82126','76470','30896','91797','54124',
                          '13234','85810','73139','55800','57686',
                          '44354','19240','57380','61246','63606',
                          '61368','29181','44537','37295','62870',
                          '64642','90212','28504','53479','73666',
                          '68842','30363','10947','12286','33926',
                          '18420','45636','45111','90215','80572',
                          '91495','93306','21648','29799','69599',
                          '34243','70341','20630','45181','86384',
                          '48554','71499','61678','34912','85871',
                          '23980','30717','88821','11793','25370',
                          '79869','95817','79328','41349','11100',
                          '34740','27503','10052','55165','30494',
                          '49332','69583','23926','16730','59603',
                          '62840','69782','43963','31333','59814',
                          '15647','42838','44023','79216','59546',
                          '91722','44371','11750','22542','74814',
                          '41647','77010','53542','22981','89835',
                          '26114','75471','44905','88727','27284',
                          '98571','28269','53263','65556','32806',
                          '39189','99691','95595','82994','32087',
                          '40677','15758','42500','48722','25567',
                          '59983','64250','87416','44179','68942',
                          '85312','14659','59888','16380','89306',
                          '93804','99752','31557','96163','58107',
                          '23952','95298','63689','91966','62359',
                          '27935','54157','73417','61942','57262',
                          '15755','60812','54285','30609','31301',
                          '55963','98017','43755','23694','91417',
                          '88692','87525','75174','41410','45925',
                          '25160','38353','29904','61924','34127',
                          '83125','17656','90554','81410','94318',
                          '83055','41581','32521','83010','97533',
                          '82593','79537','71481','69721','76626',
                          '97043','34963','74760','21319','13340',
                          '75173','39732','55395','59795','53746',
                          '20907','31242','41322','59966','94600',
                          '46703','91475','35518','26589','94598',
                          '92080','99091','75230','70027','96861',
                          '25832','56800','64717','94150','81233',
                          '98097','21014','20172','18179','29291',
                          '20577','39116','66870','75799','82242',
                          '41483','45379','11424','30267','29285',
                          '12687','84050','53720','60513','69413',
                          '13166','16140','18488','77151','24555',
                          '54739','85027','24110','84096','66723',
                          '64484','12181','48762','22451','14004',
                          '63084','43766','84703','96989','93934',
                          '58506','14281','24368','73194','36543',
                          '61579','95090','68404','12761','76188',
                          '20892','10843','66188','59731','92034',
                          '22643','54894','78522','48604','51992',
                          '32573','60797','23203','23587','16194',
                          '50551','86784','38790','43540')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


