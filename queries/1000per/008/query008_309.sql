
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '15598','38623','21364','13897','89812','17598',
                          '35873','30123','21068','38120','77816',
                          '85539','41887','66899','48789','20203',
                          '55394','92459','19458','55232','16800',
                          '55648','55116','28074','93948','54171',
                          '45491','41850','61494','10133','16129',
                          '94234','36102','46173','95697','28562',
                          '75185','57899','55063','51091','98565',
                          '60856','93307','32872','19632','16418',
                          '91817','78839','75770','68939','43053',
                          '73674','83909','74523','79974','95247',
                          '56399','15402','74641','71069','48114',
                          '33676','13109','14713','79053','72386',
                          '54696','95962','35367','98442','98175',
                          '29820','34817','78239','93699','99136',
                          '16331','38607','26615','50786','78386',
                          '22232','85254','20041','73271','58381',
                          '11518','76413','77227','48696','68611',
                          '50249','29438','34176','99447','35138',
                          '37463','29151','62259','73846','97027',
                          '31212','59193','43183','60053','84055',
                          '89346','92996','31062','35167','33354',
                          '85806','97196','35352','79452','47416',
                          '77988','80633','33998','29224','41150',
                          '63389','24901','50977','88392','63309',
                          '58673','12566','73667','81944','62707',
                          '88083','64623','16070','47335','76050',
                          '72179','83142','18581','32371','42255',
                          '93319','28806','98939','94287','37141',
                          '39043','87171','86889','75420','68765',
                          '66589','30616','57499','41739','81669',
                          '86459','70486','71618','71398','19869',
                          '26950','81013','96129','53892','19354',
                          '19498','33382','70366','41716','22381',
                          '22713','51291','31842','54221','82508',
                          '44653','25434','80775','56080','46396',
                          '63611','80846','50042','43667','22933',
                          '70230','97375','29748','48162','48498',
                          '97883','45129','22323','44309','54729',
                          '32895','23676','92430','73692','64194',
                          '20169','78409','54440','31265','83104',
                          '28227','80837','66290','15731','44852',
                          '80678','84109','93687','10811','70383',
                          '61483','55254','49911','36329','68880',
                          '44813','75854','59473','11611','77949',
                          '68474','83814','62300','11706','88886',
                          '69752','96164','82349','91577','14528',
                          '75930','10113','67330','32450','38692',
                          '42665','26346','44716','36476','82522',
                          '50486','42973','34863','96879','98480',
                          '25036','91208','27622','52714','81637',
                          '19613','36378','52564','93652','50165',
                          '29288','98228','61304','42913','12235',
                          '41239','45043','40955','82801','55364',
                          '48130','81775','59216','47552','25168',
                          '79252','50151','15149','79174','15790',
                          '99831','91051','94247','55582','13680',
                          '21624','79261','84444','64971','61095',
                          '80923','76628','25478','38810','20336',
                          '46196','55651','47154','23738','61012',
                          '94947','89066','51609','82033','16189',
                          '23237','75266','41485','45731','18571',
                          '89535','18182','41242','39501','13641',
                          '93642','52051','96593','35753','56789',
                          '88065','95194','92863','96479','70042',
                          '33114','77602','76783','78673','98621',
                          '75678','73319','59835','12440','93445',
                          '23771','72575','12927','13597','87079',
                          '23608','51972','78642','14181','88736',
                          '83184','49068','34821','76237','59546',
                          '53199','61103','88735','23531','54313',
                          '97104','66873','48510','35371','27962',
                          '76595','59200','64839','58714','59612',
                          '58163','61089','32562','38808','52493',
                          '22406','83237','94327','20262','48782',
                          '26608','45984','32832','96611','90337',
                          '54520','52649','13495','72827','38472',
                          '17028','33883','67407','91995','15100',
                          '35426','71913','85425','76496','86616',
                          '66107','58454','94116','55614')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


