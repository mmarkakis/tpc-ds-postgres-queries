
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '90728','24841','11584','77030','64814','79600',
                          '88502','59401','98374','94804','24534',
                          '13967','19599','60569','72749','66474',
                          '66607','29860','96415','17823','37350',
                          '71271','83860','53814','26511','19024',
                          '84450','75644','15072','31984','18563',
                          '82435','61334','86622','36187','17940',
                          '20639','71998','31737','24763','89321',
                          '88496','58357','44672','12842','16144',
                          '28870','54494','70256','25281','76536',
                          '44263','92709','11397','99326','34855',
                          '62659','53123','62730','45550','25432',
                          '38222','80431','39384','30015','10927',
                          '61587','79171','84560','53850','25196',
                          '30100','85220','45541','45896','43636',
                          '56921','55970','32519','40353','26641',
                          '42247','83494','24022','97742','14173',
                          '86507','36050','63834','29807','21977',
                          '55322','46221','37735','85652','21560',
                          '73827','74867','36711','54374','79604',
                          '28434','88656','64686','29457','92245',
                          '45371','51478','71973','21455','82850',
                          '98721','89955','43460','92275','37478',
                          '41388','96860','77416','75137','55418',
                          '20098','82586','11548','24240','51328',
                          '42354','38714','59160','61462','49368',
                          '19524','46702','93663','42810','17884',
                          '34728','74569','29780','49498','43731',
                          '55918','70282','93100','40656','21562',
                          '40032','17663','89146','32423','38365',
                          '65358','99153','49016','48771','81923',
                          '24707','27980','93651','65479','23998',
                          '42092','37261','61998','42448','82075',
                          '15285','58991','94114','92235','91514',
                          '93339','57918','19935','11999','84748',
                          '53619','90851','15697','87844','25590',
                          '69989','60833','55646','18793','26397',
                          '13316','49600','89354','11061','25214',
                          '43750','66400','34989','50499','23860',
                          '97299','66264','45847','77287','24045',
                          '67718','37990','58472','35717','68144',
                          '83671','85506','81324','13019','85793',
                          '90159','50031','58356','99203','78133',
                          '82508','31612','47849','34358','47522',
                          '16151','13179','69881','66022','33409',
                          '85474','19786','42638','81217','49889',
                          '92209','23594','12465','49032','83074',
                          '25546','27789','12115','31900','64566',
                          '72549','12375','97877','22003','50277',
                          '86848','25166','62538','55912','42249',
                          '26319','81437','39532','35626','55605',
                          '20982','78350','37947','98690','79964',
                          '92926','97898','71517','84276','57485',
                          '55135','55419','98578','43252','20632',
                          '56313','60619','13796','21867','26220',
                          '66305','38304','51050','49915','22596',
                          '49403','22015','39234','26266','81150',
                          '94791','93549','38223','36656','73946',
                          '95587','67676','68539','51857','50316',
                          '59214','54192','80214','43634','38910',
                          '42543','25160','84932','27094','31639',
                          '37717','43052','35101','64120','47634',
                          '51769','67987','40615','35876','36148',
                          '50051','32038','74404','89007','36051',
                          '99454','72312','29901','24489','83930',
                          '86462','95213','14621','20187','85943',
                          '25683','50694','87353','90671','77948',
                          '93838','86746','47316','70776','10224',
                          '64232','26254','72804','78075','95020',
                          '16867','73887','26249','52024','58339',
                          '50944','98418','68544','99704','29471',
                          '78277','66061','78260','93565','41412',
                          '31139','74338','86461','18867','60935',
                          '18685','98005','42059','55873','81968',
                          '13998','66549','10241','41117','34309',
                          '23554','12962','50605','34949','49138',
                          '70529','27078','98356','60688','59306',
                          '88810','63012','53062','87460','63487',
                          '14060','56826','39137','89378','31543',
                          '20390','69716','75243','77879')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


