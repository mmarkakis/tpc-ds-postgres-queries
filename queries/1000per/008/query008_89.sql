
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '45676','52049','62522','51809','19394','35960',
                          '17104','42677','65485','70759','57827',
                          '26722','99872','72309','77071','78075',
                          '82005','47911','99546','69490','85723',
                          '41804','45883','60538','56312','42048',
                          '96378','41165','60073','92889','18528',
                          '29252','27040','34886','85131','92505',
                          '94469','44718','91492','54961','53409',
                          '38539','69818','32757','48075','67125',
                          '24425','72941','43688','39285','46951',
                          '84890','57810','14195','84507','88548',
                          '38503','95281','45135','32219','37813',
                          '69544','11360','76271','47006','17913',
                          '20643','89606','86628','20660','83731',
                          '33170','87342','45761','58309','23720',
                          '42324','97794','86819','78266','86657',
                          '77695','35044','58599','61368','62903',
                          '46074','51943','55938','28028','46237',
                          '93855','53807','48780','70247','44898',
                          '75283','15953','27168','58031','57568',
                          '34010','99576','98282','37585','31873',
                          '20299','48013','39221','51651','72353',
                          '54039','55865','80821','30308','18085',
                          '83602','19859','91239','62673','40385',
                          '37084','74541','74909','55397','80826',
                          '32978','37406','68471','93252','97083',
                          '83522','39817','14435','26433','37689',
                          '63316','50435','85466','38273','74062',
                          '26896','20864','61691','20866','66795',
                          '85946','26191','33663','66121','64781',
                          '78576','97998','51219','79779','67951',
                          '12338','66737','89121','15892','15408',
                          '41921','81225','33374','55287','98521',
                          '41700','14619','52659','71593','52915',
                          '97768','59568','39656','34696','67317',
                          '61873','97988','88293','83453','86866',
                          '19905','18417','40059','34239','22772',
                          '28495','20700','70784','41822','93160',
                          '98407','82980','64173','59249','43434',
                          '37777','39363','17689','37151','95365',
                          '30605','45748','56982','25131','42847',
                          '82660','76717','69552','75428','61376',
                          '44884','30862','31485','70310','50769',
                          '41189','80417','59875','63778','69485',
                          '22915','25416','54226','24034','89535',
                          '93935','54096','43583','72773','52918',
                          '68804','66421','34674','61387','17808',
                          '89622','21067','84748','88977','97775',
                          '93248','97167','59494','59085','84870',
                          '41088','93214','16785','50018','45119',
                          '27358','42443','14674','91969','44271',
                          '57356','86935','53348','68297','54161',
                          '56774','66326','16302','93143','46006',
                          '95739','46197','78265','98599','11573',
                          '88744','74565','67837','96204','13807',
                          '26570','59122','96275','12375','77425',
                          '84881','91796','94150','11871','73929',
                          '80090','48464','98518','45680','28188',
                          '77803','51431','66207','83828','79809',
                          '77155','75596','94471','15392','65571',
                          '21922','18198','46354','12366','44819',
                          '61392','82225','12346','17079','64812',
                          '59158','87178','71677','31407','17897',
                          '76911','60776','21439','20044','48326',
                          '90671','66015','85830','93894','21669',
                          '76210','55408','73790','35015','46223',
                          '43721','90495','76327','80700','35573',
                          '56107','24805','13433','90591','36264',
                          '93995','57500','35738','57162','69615',
                          '51173','80729','96376','52908','38691',
                          '36436','15878','50279','74018','44737',
                          '48069','38321','41364','40428','40521',
                          '10487','70533','37478','77195','93405',
                          '77724','76391','89298','23865','37303',
                          '92179','93659','10438','83537','25111',
                          '38366','41438','73907','63062','52856',
                          '16199','12914','46608','91956','39618',
                          '46760','79108','15258','70958','97046',
                          '89835','47377','80153','72607','12204',
                          '90628','88489','72531','20394')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


