
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '47071','47311','17499','20641','97991','98535',
                          '53629','44002','28944','22217','37494',
                          '26817','21548','97375','71436','95126',
                          '52261','97086','63101','43517','56732',
                          '31911','53734','20258','41865','56551',
                          '66190','24919','34079','29920','80523',
                          '44410','56687','51007','40112','85487',
                          '14003','41669','97892','24088','38436',
                          '14135','45639','65800','64513','30291',
                          '67287','43464','75174','69041','76605',
                          '40759','78545','13435','49859','39392',
                          '45643','36634','93836','42580','26176',
                          '19121','19534','19541','71513','97967',
                          '64802','63785','54959','69737','60557',
                          '15976','33959','38103','15875','23643',
                          '98643','31264','52363','15446','10191',
                          '79576','49000','45114','49957','49649',
                          '97297','51852','55467','21813','23403',
                          '98846','49933','75584','44574','20759',
                          '68786','98562','74077','80136','82145',
                          '18776','18151','65477','71173','22407',
                          '70370','91447','37513','93487','72871',
                          '17682','53107','16368','39376','83782',
                          '92869','83304','28537','95234','21050',
                          '86932','87327','11457','26287','79301',
                          '20880','62161','42956','96609','63576',
                          '90752','20566','67103','27171','42425',
                          '73825','56775','99903','16997','67223',
                          '22108','17142','22454','94518','27712',
                          '28383','50729','99824','22704','80894',
                          '96347','48181','44356','40098','89164',
                          '92132','25759','98443','85536','69054',
                          '40422','35152','48013','83218','61496',
                          '55403','68660','67212','56059','87301',
                          '96846','48964','19448','41064','22879',
                          '51707','52321','83495','92969','48239',
                          '53771','39668','26222','74582','74082',
                          '87187','98214','26945','53858','20919',
                          '14827','24245','99428','71638','72084',
                          '30273','35619','92144','68980','66583',
                          '39568','99379','59521','25342','40543',
                          '99205','13519','34057','58570','54573',
                          '15530','16246','34999','84538','46165',
                          '17140','25288','29905','76675','86378',
                          '96162','87527','72477','79483','20048',
                          '49713','60518','10464','77129','25623',
                          '13449','70726','66315','38177','81929',
                          '95105','48483','27309','22161','61663',
                          '86974','50388','86726','77520','66528',
                          '50177','27041','11791','52529','51199',
                          '94737','41077','46440','83017','11757',
                          '56148','33195','36667','95558','44012',
                          '90739','99525','33181','67491','78314',
                          '19052','37323','61668','95462','75708',
                          '92643','64291','90839','88641','45791',
                          '46009','69870','62300','76102','48455',
                          '20862','57009','92265','95544','79175',
                          '59629','52277','95435','55187','70457',
                          '71809','63590','82245','15952','12987',
                          '73530','45428','41817','40296','75658',
                          '13196','50616','38259','71221','34722',
                          '92069','82507','27526','65213','91662',
                          '60108','44427','15435','40010','73623',
                          '67940','21960','68033','59001','84544',
                          '25710','48785','99635','25734','17708',
                          '56181','91634','31575','95000','81281',
                          '74810','58479','98323','18300','86671',
                          '66637','83216','10793','17764','75391',
                          '79169','60227','58910','21782','89742',
                          '36752','10589','99351','83524','77198',
                          '49638','49082','17852','16351','69695',
                          '93141','88805','96395','77287','38231',
                          '58998','95508','18036','82690','83250',
                          '88266','11415','59827','16685','86039',
                          '58780','41009','69742','73730','77042',
                          '48292','83172','82561','68338','82969',
                          '33377','71712','21944','45265','63376',
                          '21761','52610','75072','50951','28989',
                          '86205','86935','87687','45635','85645',
                          '53639','25847','75981','13709')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


