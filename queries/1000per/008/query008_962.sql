
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '84460','79164','73421','14977','23954','55953',
                          '98754','72200','80999','96004','45425',
                          '84027','38216','66382','62992','79155',
                          '90635','55398','59219','92039','53211',
                          '89346','80795','97625','99667','95841',
                          '87102','98624','10590','71051','89210',
                          '57340','27872','53358','51309','82914',
                          '28355','59673','49067','46957','82974',
                          '21542','15997','50551','42495','55949',
                          '93798','26849','66271','80977','91899',
                          '88534','37415','70914','24439','41435',
                          '36251','26418','19926','30127','77175',
                          '29040','59863','65649','48357','51688',
                          '95318','54469','32373','22633','37923',
                          '27613','65293','46558','77247','77158',
                          '46161','48638','33053','34554','52092',
                          '55117','51257','61338','26247','44057',
                          '28070','51368','15761','73870','48982',
                          '87603','11376','14428','86962','90190',
                          '15495','37242','17575','71814','98809',
                          '55924','43227','86750','84805','50418',
                          '39631','99877','41230','93152','58365',
                          '18529','70493','58136','95817','53654',
                          '28411','92801','25492','87306','63606',
                          '47917','19733','22792','60115','94864',
                          '69655','81351','17143','72477','82456',
                          '50920','42461','36592','90749','34493',
                          '17110','32582','39805','89411','33559',
                          '14815','76779','65349','27342','52520',
                          '68501','29788','73245','40080','10921',
                          '69814','49316','75068','42544','59443',
                          '51752','81974','50364','96979','78483',
                          '21202','82154','11732','96112','35717',
                          '81159','30305','66154','92956','91725',
                          '25118','27354','95507','37697','33454',
                          '67620','35102','16617','81524','34429',
                          '71692','44175','10565','44133','43333',
                          '29747','56934','46299','12851','94542',
                          '57791','92694','50196','61087','53300',
                          '44982','76711','13641','57995','23547',
                          '92752','18336','39521','73390','57956',
                          '71821','50682','85105','70601','55525',
                          '14807','73357','39898','39615','77878',
                          '89291','87919','38570','82738','99574',
                          '75744','66449','14904','40270','14555',
                          '79820','98793','81075','25690','34705',
                          '23240','66671','75811','81985','90785',
                          '25505','17832','11461','76382','58080',
                          '11696','61007','25789','36928','52295',
                          '27785','35025','89998','15980','26760',
                          '42967','48547','64532','50510','43716',
                          '48222','91170','84573','98976','33004',
                          '64580','42624','27326','87918','88191',
                          '94427','36603','38367','35586','48565',
                          '13392','75855','71654','56241','86729',
                          '76294','31006','57488','41574','21547',
                          '54832','96957','48876','54421','94215',
                          '29746','63457','38127','26617','93845',
                          '63610','36153','32645','10959','97734',
                          '22528','33259','92804','18130','51620',
                          '86426','40608','12539','90372','43967',
                          '52274','34309','84751','77107','86894',
                          '17131','29431','36820','95753','65558',
                          '82046','32533','20435','29391','31834',
                          '13565','98361','75873','39336','92074',
                          '71010','73732','78490','70858','23175',
                          '37064','92434','80721','78052','22127',
                          '30609','29521','40022','66571','63630',
                          '48845','81140','93565','68974','74873',
                          '41142','17020','86967','73306','63330',
                          '42460','84845','67800','29260','31097',
                          '87486','42205','22728','42971','73003',
                          '39479','88171','38120','83362','23464',
                          '30124','62835','62185','86069','74479',
                          '29595','51238','96106','42166','78491',
                          '41698','46207','87833','63341','20850',
                          '13918','83107','28600','10470','90853',
                          '87249','38581','68919','77102','52454',
                          '48862','62029','32320','48986','82704',
                          '36616','64891','88696','62077')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


