
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '61861','88678','26556','90790','97430','62367',
                          '77150','15731','46393','12265','81401',
                          '12623','75272','11869','39237','48096',
                          '16047','36139','80814','37015','18925',
                          '57362','18245','80622','47886','11599',
                          '51314','22052','70230','20413','39457',
                          '82276','51992','53236','78457','81229',
                          '31262','76401','58755','16354','59900',
                          '61218','24184','37125','58875','19279',
                          '58377','85433','54918','50793','60381',
                          '46482','37890','91845','58293','16567',
                          '67130','40285','15051','44646','90534',
                          '70086','22658','75761','62375','57548',
                          '77071','85412','26928','70268','76995',
                          '98995','27501','48075','95448','53706',
                          '99815','73353','10594','73522','50639',
                          '42794','16063','82821','27673','72274',
                          '25211','91446','64745','82294','17773',
                          '62950','14194','26882','88560','33624',
                          '30698','18171','67955','66433','99277',
                          '32821','75867','79661','48470','46469',
                          '12295','13670','15057','35930','77365',
                          '42136','15231','65688','38636','11211',
                          '87414','34996','84703','39615','21783',
                          '57532','84962','61397','57319','23125',
                          '10153','70450','34125','31260','59974',
                          '83557','57846','29123','45357','45827',
                          '66795','85588','14807','15300','89409',
                          '48196','30158','92652','96316','99180',
                          '12812','87853','41053','35565','18585',
                          '86508','34322','21971','64955','79916',
                          '82692','15501','79594','18929','86279',
                          '75374','68992','66678','99924','28124',
                          '56502','72747','32720','58393','36398',
                          '25143','25968','72627','36262','43775',
                          '51012','59761','83477','58841','81804',
                          '51425','35728','57959','27396','83756',
                          '49025','92346','92612','48435','24888',
                          '76588','44696','52260','49039','88126',
                          '65437','83582','24541','32481','87691',
                          '52148','83320','96345','83704','27756',
                          '24597','68378','29307','72059','89343',
                          '97420','44998','32493','38649','87998',
                          '17962','93858','78769','92399','59996',
                          '82019','25618','44590','45393','27029',
                          '41110','82896','54825','85939','36871',
                          '48377','24269','96361','69978','99491',
                          '66893','96692','80070','79179','91481',
                          '77875','69982','84215','12763','36901',
                          '57286','74400','39339','49171','99390',
                          '45596','16438','74351','99583','10533',
                          '60682','28756','47832','34741','13184',
                          '25667','32221','98914','35703','72513',
                          '77443','89250','94993','10752','43425',
                          '29167','86833','49681','59526','50965',
                          '15681','72307','32730','88412','18549',
                          '46098','24384','81397','71441','37513',
                          '25351','90847','90478','97250','15543',
                          '61322','89062','61090','12567','37295',
                          '62290','91871','26480','79236','20418',
                          '90487','62583','59129','12233','39351',
                          '82601','56661','46011','93289','31490',
                          '19312','69772','59957','97033','70557',
                          '93499','88883','64574','88302','56357',
                          '97835','86173','88903','18875','98819',
                          '50686','95168','31547','77792','68683',
                          '19720','16087','30139','68308','81995',
                          '28267','81780','94235','22941','38893',
                          '82817','70111','27358','57717','86388',
                          '52079','59742','22721','60710','40186',
                          '24244','44045','62657','18164','22562',
                          '38574','94569','95410','71185','87470',
                          '33455','57566','96513','19858','89000',
                          '88696','99301','54794','46216','69010',
                          '77571','81142','59186','23800','21973',
                          '60269','49046','94899','66580','85821',
                          '36066','50317','45510','67534','19187',
                          '10981','95471','23680','44027','58846',
                          '39287','34825','34771','27160','84733',
                          '81656','52232','85742','62949')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


