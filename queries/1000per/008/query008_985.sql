
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '40020','47063','86554','94934','81135','74769',
                          '37051','30817','26388','34658','92136',
                          '95856','36361','15288','35086','29781',
                          '24929','19592','65797','63293','42115',
                          '36402','93896','33749','73626','44915',
                          '41924','54749','54539','18927','33199',
                          '86170','62226','85546','48735','90545',
                          '56611','65323','65917','64409','13975',
                          '20205','33493','19001','88262','67052',
                          '60436','85905','66670','32254','81262',
                          '14308','42250','18238','61168','95611',
                          '72941','69769','53985','53795','68831',
                          '90027','58077','18299','16405','52080',
                          '23534','76667','38515','97084','94794',
                          '57400','14423','39265','49920','88942',
                          '64901','19609','82561','86665','51218',
                          '68390','23207','25657','10586','87813',
                          '44857','25387','29775','99612','49689',
                          '22883','86970','29449','99969','95928',
                          '71718','94134','50248','94179','68176',
                          '17401','77765','13556','41375','15213',
                          '82759','50985','71577','48025','40403',
                          '21794','92645','16071','37768','92104',
                          '21015','28656','91419','10177','87448',
                          '50946','13635','18487','52140','30459',
                          '31686','22319','21872','83334','86678',
                          '41010','54662','19854','90373','67789',
                          '98911','62563','33832','83403','26468',
                          '33623','37060','37808','28637','88105',
                          '20391','11594','33032','30780','53309',
                          '26920','82522','35930','83013','33361',
                          '36005','76872','59582','13680','94468',
                          '95817','98763','65829','55570','76828',
                          '90296','84671','23253','76533','52511',
                          '61462','93106','30201','43212','27140',
                          '52349','28304','43794','63466','21589',
                          '53895','49568','82814','26320','60591',
                          '56689','32906','12855','63701','73570',
                          '77010','53716','39159','24775','51777',
                          '82553','91078','15535','28969','89749',
                          '35295','31154','55619','57370','11553',
                          '87721','47258','34240','26216','92782',
                          '26714','50804','14140','75105','49908',
                          '10380','45259','96737','98161','95310',
                          '96335','70869','49377','16335','93769',
                          '14632','96721','24568','24179','34330',
                          '75520','78539','86069','52367','67408',
                          '73073','96064','67918','25500','92595',
                          '67804','11527','92406','92765','19672',
                          '25140','41274','15000','67420','37087',
                          '18564','46492','15611','54255','76198',
                          '64513','59749','37847','56164','34865',
                          '95185','65762','39269','99943','75443',
                          '98878','52864','29735','20516','37523',
                          '44240','21671','88562','16362','51435',
                          '28433','57884','76723','20062','70841',
                          '75127','52187','84231','78451','38777',
                          '99976','86468','57149','26945','61920',
                          '67063','38162','67422','60366','63247',
                          '16342','34601','31636','26439','58032',
                          '96527','86159','95081','94969','39678',
                          '20513','82841','97168','82621','96591',
                          '44876','26901','18620','66923','19407',
                          '60342','60147','50798','46609','51183',
                          '66502','34169','53887','72116','44733',
                          '24993','81280','18851','18171','67858',
                          '32933','89479','76919','90195','75824',
                          '72246','41450','46188','57140','30683',
                          '89149','85019','44693','72642','57703',
                          '45573','68921','82120','43485','92213',
                          '74198','43484','87226','27196','85661',
                          '35232','47143','90477','93732','25891',
                          '83480','40816','20443','43334','70710',
                          '51174','13888','62010','17845','40799',
                          '56629','56990','75162','32716','98190',
                          '72687','47898','95242','31669','97774',
                          '88820','63135','11917','53810','73907',
                          '68699','40530','41593','90505','96909',
                          '60786','78095','45004','90228','10961',
                          '90023','70601','68819','47762')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


