
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '16156','47498','19972','92123','49589','71266',
                          '48510','30782','84871','62580','74349',
                          '99293','18518','51399','46062','24688',
                          '86508','53928','56786','52593','41449',
                          '84671','60320','63452','70976','86853',
                          '93433','60947','19218','19597','68162',
                          '74444','36518','39969','16315','37938',
                          '32888','66610','69568','15363','42795',
                          '69366','19383','94665','78620','68587',
                          '46113','23070','39883','89015','65509',
                          '29655','81234','25913','72449','81544',
                          '23377','62039','77209','19675','75836',
                          '40297','97786','66237','69549','74195',
                          '70298','54105','20991','97839','18130',
                          '34520','40201','15668','19191','80871',
                          '86003','71437','91020','14941','28436',
                          '36572','58625','82755','23105','22767',
                          '83123','29674','92200','28905','10341',
                          '38219','24317','27705','78402','14841',
                          '48446','18334','52467','37775','20514',
                          '41664','50796','30022','29724','84728',
                          '82203','12736','34470','88767','92301',
                          '82771','71291','84300','82251','37291',
                          '72017','75769','61435','15833','66665',
                          '39059','39473','71912','68318','10799',
                          '65947','63409','13578','42177','13779',
                          '90549','78720','15238','90689','18652',
                          '55179','83611','32936','21333','90623',
                          '13208','29308','79461','48204','81407',
                          '55001','82442','72233','35120','81597',
                          '98086','12168','26785','76555','78172',
                          '46697','29322','39383','67141','19546',
                          '24690','30539','40204','50348','94422',
                          '40445','79442','67404','49981','99464',
                          '31272','75061','88755','96750','96950',
                          '21964','39468','20683','99971','89067',
                          '80473','46114','57319','61000','65514',
                          '17219','46633','21298','76196','89794',
                          '53744','51944','13196','63891','31028',
                          '36733','55969','10863','49900','80907',
                          '50270','48092','72200','36257','95865',
                          '68303','11449','13521','56160','56458',
                          '69855','47516','53752','46072','19325',
                          '17264','94061','62390','67167','33894',
                          '80549','43176','87509','60534','92872',
                          '74099','16165','63181','34033','29461',
                          '16506','30052','93766','48689','45424',
                          '40429','65390','21220','59745','73766',
                          '46213','40434','47489','39525','82860',
                          '88225','94570','40907','90444','48088',
                          '98435','38539','43865','58803','97452',
                          '13776','21715','64960','22381','66727',
                          '29542','60862','42141','94661','23542',
                          '34220','79259','52390','51834','38363',
                          '35499','89238','61156','27287','28486',
                          '21178','42695','91413','16489','88411',
                          '63267','15960','62038','29721','92649',
                          '87685','44575','33298','81196','90491',
                          '74301','97698','13654','14164','57147',
                          '96528','53818','36606','88282','65323',
                          '81049','84271','61227','26822','64275',
                          '76930','56119','18174','24269','63941',
                          '61272','47899','47697','54301','64109',
                          '58569','32374','68569','61658','16602',
                          '47855','56415','17460','85242','51464',
                          '62376','13927','51048','75845','16812',
                          '44696','36180','53223','88247','78642',
                          '20378','65127','78255','80071','68902',
                          '25486','80431','30790','14698','23993',
                          '82816','37977','58513','17562','52503',
                          '92947','61303','65450','64029','75933',
                          '71766','79913','81155','96372','77543',
                          '16407','36981','67185','54995','73229',
                          '96925','72090','59735','20897','81286',
                          '75695','37371','58151','58594','11088',
                          '84709','40356','29534','26452','41007',
                          '57022','54434','48393','17599','33438',
                          '39100','72443','51348','80210','50846',
                          '32800','99998','49864','91904','96884',
                          '66455','44535','44013','19110')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


