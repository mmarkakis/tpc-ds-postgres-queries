
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '94279','79892','42987','56401','93695','33029',
                          '85390','81461','86659','53407','67868',
                          '11568','92028','59286','74886','64298',
                          '13618','23955','20722','80846','62793',
                          '90608','15908','94433','63428','32447',
                          '49762','36904','84278','25893','62655',
                          '75605','27733','95877','46092','99553',
                          '87013','13017','70993','62936','36500',
                          '95761','22282','46867','32398','58534',
                          '58286','89340','22208','56595','13809',
                          '98203','45069','63453','37036','92561',
                          '63926','63655','51918','53763','51307',
                          '93460','81348','62516','77443','27692',
                          '16411','89157','56512','32457','81118',
                          '79182','75690','43081','74239','83015',
                          '33513','69900','59817','43637','24629',
                          '28066','28147','44158','31263','14081',
                          '76075','84470','12279','24378','76963',
                          '52177','29338','76413','88350','88071',
                          '62779','43163','15348','76022','73293',
                          '36585','48806','89460','17009','46194',
                          '54023','99076','52198','18313','32257',
                          '78802','23125','70893','45909','17362',
                          '89896','99068','54472','21757','76385',
                          '37349','29304','20391','32538','29443',
                          '51694','22985','73864','20466','43654',
                          '83825','51824','75645','47912','48628',
                          '96297','73194','94580','66450','13703',
                          '11931','71077','91298','19510','78428',
                          '17212','61059','89555','17302','81803',
                          '85533','79615','62473','48162','75849',
                          '95217','91931','85681','86861','31432',
                          '25961','84977','79834','55944','23231',
                          '37471','42018','29011','93677','55530',
                          '22955','22734','61909','35281','88042',
                          '46264','85727','18396','69180','88111',
                          '21729','78477','25060','22554','95244',
                          '55511','37856','22758','27951','78314',
                          '10083','29342','36931','14741','64798',
                          '68068','40245','44033','98829','75622',
                          '46573','57046','29243','57808','54085',
                          '29325','77206','56080','51483','59845',
                          '19115','15941','21813','68234','21274',
                          '40785','40592','27068','69463','65749',
                          '88522','32328','40060','26673','59393',
                          '13726','84272','67370','82723','11286',
                          '55706','39627','71824','82810','97748',
                          '25937','60715','61121','30053','97923',
                          '43428','55435','15259','45372','49559',
                          '46260','66374','58027','69971','80700',
                          '19933','21920','13929','34254','21073',
                          '25014','76505','26263','39313','56203',
                          '88297','49686','18586','70253','16011',
                          '25101','19062','50725','25502','77419',
                          '16643','33864','85086','34328','74775',
                          '17826','88892','77661','65650','89483',
                          '15273','61819','22064','81667','52594',
                          '22762','53079','94322','89446','78450',
                          '28309','10308','59348','38650','37540',
                          '88050','87143','84676','41841','95881',
                          '64634','76380','67703','64399','62743',
                          '39090','91297','83743','16439','53748',
                          '41040','33371','76326','65426','39820',
                          '49703','64523','25246','87565','45808',
                          '51292','32762','86862','60127','19493',
                          '84338','31994','50394','35738','11303',
                          '30492','65567','86269','38997','53392',
                          '50767','25880','29309','60885','70254',
                          '65322','78935','71019','82889','14102',
                          '39795','33375','92413','37814','31738',
                          '44323','45359','38935','58552','86196',
                          '28530','67487','34242','13466','94051',
                          '59940','70110','68781','56291','79314',
                          '20330','99890','28084','25866','83440',
                          '65475','90275','75005','18218','18564',
                          '55288','95239','46262','17290','40906',
                          '92085','38064','47803','66515','28820',
                          '11128','39531','42031','33676','74525',
                          '87139','64421','84132','53401','59905',
                          '99441','98783','84544','51772')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


