
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '19491','22871','75074','79770','47666','79192',
                          '30631','23969','21869','39050','73420',
                          '40630','34981','62725','35289','65613',
                          '13509','16126','99462','68197','72130',
                          '87431','35918','51492','30113','39962',
                          '26304','10362','16801','29857','90173',
                          '72549','70405','16106','61869','88535',
                          '26019','86411','52574','48428','88949',
                          '31910','37065','15684','44541','53483',
                          '91416','21828','97265','39165','70041',
                          '11424','68613','17641','59716','83357',
                          '44590','76063','67319','36036','95232',
                          '35971','25340','15547','38100','27492',
                          '71475','73145','28968','70934','71555',
                          '59668','13376','77942','63960','22780',
                          '29815','92615','38893','58239','19981',
                          '25838','50770','82545','62924','91397',
                          '61632','97973','71052','73330','79204',
                          '86683','46903','98447','99660','49775',
                          '71803','53703','13009','20324','42605',
                          '69912','41624','43499','93003','10990',
                          '96107','12103','66889','99960','12886',
                          '83551','97258','99039','57612','86111',
                          '67517','94794','51445','89440','37501',
                          '49208','67953','39606','71227','24154',
                          '57488','23495','88824','54536','38563',
                          '68403','80551','98834','44475','36180',
                          '76293','35701','27209','36095','57598',
                          '13693','85358','35598','22673','22797',
                          '28755','18749','21340','32274','29092',
                          '74945','83966','85096','15828','64099',
                          '46386','25553','79356','45332','40492',
                          '11888','52569','13558','65839','32411',
                          '79504','38807','76135','51286','65836',
                          '91561','73607','25866','39096','19340',
                          '93733','12837','37004','95783','32587',
                          '71198','53569','94052','12633','89561',
                          '32582','67492','80427','51720','16950',
                          '79136','14335','63183','62010','24689',
                          '30437','37994','78020','32498','74768',
                          '87971','90211','90306','45294','59095',
                          '22662','36971','78511','31655','19567',
                          '87487','80011','17807','18132','96080',
                          '41032','71531','61053','46431','35295',
                          '18339','69031','34303','66174','96186',
                          '41682','82256','58596','54973','20675',
                          '42852','52349','82738','59357','99275',
                          '43283','28063','13092','64937','54309',
                          '87466','53623','87785','19043','59442',
                          '38461','45713','21107','70915','59058',
                          '27607','40607','10677','81166','49648',
                          '62472','50534','40699','67469','84164',
                          '84537','86046','94368','71005','88555',
                          '30986','18626','20246','63982','46867',
                          '25460','57367','13572','99700','43453',
                          '39214','39865','16707','92341','54877',
                          '26326','84684','97419','82134','95688',
                          '74248','92237','58545','36633','77512',
                          '84499','43923','53711','56971','25042',
                          '96637','58580','73398','91236','60645',
                          '34510','52891','53015','98128','12259',
                          '75115','84414','32340','52249','53117',
                          '63826','64626','71706','44728','23664',
                          '48669','92521','49433','48315','24037',
                          '91689','79525','21635','28245','60378',
                          '89665','75567','93537','54747','63916',
                          '40342','55463','51297','72515','36945',
                          '71800','73514','60483','71561','48645',
                          '99710','84844','93462','91498','59997',
                          '36752','97986','39368','45837','88250',
                          '14005','60320','56570','12788','47616',
                          '17037','24030','60365','15564','16910',
                          '99255','54157','65166','27393','82427',
                          '25238','84066','26900','38142','49715',
                          '38000','34500','92264','96643','78096',
                          '22479','14141','18691','68919','71778',
                          '56508','57820','64045','66041','74988',
                          '77994','58417','44947','51593','88507',
                          '88685','31953','23293','39074','49233',
                          '83700','67272','65473','25044')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


