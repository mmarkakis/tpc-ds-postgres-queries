
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '48562','40178','18513','28717','42655','58088',
                          '32333','35962','39516','24866','25754',
                          '35173','27234','32090','75009','26827',
                          '66355','34200','70214','37019','14499',
                          '91046','99240','44177','65220','29889',
                          '85323','35332','29408','31130','27804',
                          '70653','64703','76122','38501','64366',
                          '18567','94591','29834','24860','33464',
                          '84724','44962','92080','86799','30013',
                          '33357','93613','71725','61888','64035',
                          '21354','38682','14332','22308','10768',
                          '47818','79587','26814','97568','70705',
                          '90958','21852','38697','29602','66205',
                          '95983','64993','56841','46417','63192',
                          '60721','76304','81870','44299','21330',
                          '33133','84865','47588','27385','40368',
                          '85489','38654','61291','30125','49319',
                          '25793','32203','86964','34439','82290',
                          '39201','85378','40690','10491','86245',
                          '89663','51840','25944','18173','19627',
                          '29391','27852','93541','55922','86224',
                          '46872','60057','42395','49219','51719',
                          '98415','96212','96079','13615','41199',
                          '31349','85800','86038','89853','76172',
                          '35342','64254','16838','67110','52728',
                          '60674','32863','58633','89050','38374',
                          '13175','64349','16248','22212','23872',
                          '52264','76151','46296','41111','60911',
                          '65339','35886','68994','18012','13779',
                          '57674','76074','89208','46219','96869',
                          '35253','44947','64595','66232','19772',
                          '66269','10727','28903','68169','32309',
                          '92238','42241','99866','46598','41632',
                          '72995','90314','14781','96136','82541',
                          '71410','48153','12010','25390','70469',
                          '78268','85383','76467','42034','99055',
                          '70886','41213','63735','68819','16963',
                          '11660','85711','37354','36738','51213',
                          '62490','12220','55889','18223','55614',
                          '47854','61694','93536','75662','71493',
                          '96438','58191','65405','55548','41897',
                          '64020','38949','52653','65029','12227',
                          '20201','29037','41788','66069','70141',
                          '61971','30756','20192','70062','61239',
                          '43612','80742','99355','46712','93684',
                          '46542','17987','95025','20998','92498',
                          '34400','51422','10409','74062','59371',
                          '45729','77580','93042','51817','27593',
                          '47727','16330','22087','23605','80566',
                          '84551','28926','89187','35305','97089',
                          '74872','59571','15451','77910','80964',
                          '63059','15824','53896','55136','85240',
                          '12195','76302','42480','45918','73195',
                          '87433','96595','20613','44405','69438',
                          '56418','88074','51133','77306','17521',
                          '50906','95922','99736','87587','60275',
                          '37245','98974','60621','91033','25623',
                          '66506','17641','33385','78526','23365',
                          '30782','94697','38346','48581','80235',
                          '41133','68818','42582','82224','23001',
                          '31138','96416','30511','25130','77461',
                          '20953','60947','89570','47115','22500',
                          '84309','89344','81337','19359','19533',
                          '34336','62114','76472','64747','75261',
                          '44498','48336','81427','68530','27721',
                          '25150','85494','73199','33375','15706',
                          '13306','79433','40175','88501','55617',
                          '82064','25978','82624','26460','91104',
                          '13509','26933','60625','72948','28900',
                          '43131','87965','70432','27794','42634',
                          '11675','56607','49808','94759','83205',
                          '21548','78631','40319','89366','16983',
                          '11115','38257','10837','72123','71257',
                          '59740','74106','45332','74861','62506',
                          '99294','29519','40773','44811','79049',
                          '29824','99972','10469','88683','36029',
                          '29483','75852','95985','16920','37963',
                          '86228','48381','17969','97596','92508',
                          '45776','78333','25328','49344','19196',
                          '14583','71358','52832','51754')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


