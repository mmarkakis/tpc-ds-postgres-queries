
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '32034','79227','17170','16040','40891','27831',
                          '67623','61565','69599','53503','20023',
                          '75831','64964','43692','87581','47827',
                          '34074','51353','88586','98210','89892',
                          '66082','74137','42543','40145','24709',
                          '24791','19495','51889','47497','20542',
                          '85970','26697','95873','60366','87328',
                          '46286','77137','90010','31214','70603',
                          '63755','19817','27698','70121','82192',
                          '79376','81773','37391','54527','27045',
                          '71923','93425','53492','48614','11467',
                          '88100','56156','49300','26027','17473',
                          '42387','53500','65981','92952','40844',
                          '79017','45039','47539','29366','11310',
                          '60936','27773','75427','63495','14765',
                          '93718','94354','55563','74325','58151',
                          '42266','79409','68936','62819','53621',
                          '64445','36071','48389','44254','25159',
                          '61347','94065','65975','28350','48573',
                          '88897','73460','52402','86649','81302',
                          '65491','12059','31223','44063','19482',
                          '54002','39114','95826','40846','39770',
                          '66766','89489','50229','61833','99476',
                          '93862','44879','83336','35841','99983',
                          '57062','40861','66028','57961','44414',
                          '26292','84584','60992','23749','45249',
                          '97740','74097','25203','43278','78633',
                          '80536','44638','41565','15927','56719',
                          '25511','62201','20442','68477','38375',
                          '92305','15724','42408','45036','24515',
                          '14746','60026','43061','90391','58081',
                          '22177','90505','74828','50729','30954',
                          '42063','83144','54139','14028','86621',
                          '25655','67113','14993','17119','58213',
                          '74914','24469','84912','49355','18004',
                          '14967','27509','13987','22434','36022',
                          '43817','77378','56633','79127','27408',
                          '32832','94925','62231','25300','28795',
                          '34277','66807','80190','16506','86144',
                          '68448','70571','57666','21925','22748',
                          '44756','70979','73065','61265','65842',
                          '83952','84896','28952','65256','84748',
                          '33849','11437','99580','90072','33830',
                          '95728','69005','98328','63739','28673',
                          '94984','47734','13067','83316','75197',
                          '82570','39536','17842','33599','34988',
                          '35036','47842','61906','99945','55312',
                          '72035','68962','16760','62861','59314',
                          '81003','87011','33672','65544','63068',
                          '89958','96341','37251','60546','53167',
                          '52755','90793','63506','29065','13072',
                          '70832','39089','63358','16179','40954',
                          '55145','99434','36379','28044','27424',
                          '40484','13356','18475','80145','43610',
                          '21017','78374','31070','33137','52618',
                          '52106','39661','49516','97881','62733',
                          '45137','52912','69067','89634','15078',
                          '77967','70355','31359','18496','14333',
                          '88740','73361','76176','46974','18612',
                          '78410','95729','46113','85668','35488',
                          '60548','86014','67857','93879','38817',
                          '94425','63222','55686','11102','93131',
                          '46043','44224','34068','30868','17772',
                          '14220','92540','91975','89610','35729',
                          '85352','71191','66184','87866','13446',
                          '90874','80268','68396','99112','74946',
                          '78349','75526','68655','31494','16026',
                          '79649','81554','81739','90600','22375',
                          '47241','56892','97716','44610','62129',
                          '82873','20201','54073','74524','47947',
                          '49833','56052','60400','77857','94054',
                          '73588','77652','73857','80419','92526',
                          '45409','71656','56908','32445','12564',
                          '98861','62739','36080','57891','83900',
                          '47614','90350','19400','44836','53548',
                          '84736','50971','97874','21165','48787',
                          '79068','48695','48045','28037','43164',
                          '61635','81296','84052','71605','88081',
                          '31568','35576','57337','62175','94589',
                          '48663','58959','63158','62845')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


