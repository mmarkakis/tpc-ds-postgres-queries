
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '50602','69691','71740','79912','69134','65438',
                          '13346','45088','92740','97453','72676',
                          '82841','33309','96575','12266','49208',
                          '35961','18772','17718','41890','64685',
                          '44751','38471','51527','19539','90159',
                          '50930','84564','18947','99874','26726',
                          '18704','64304','39848','23845','85674',
                          '18572','53039','14206','54337','80148',
                          '50458','22942','24699','22592','53850',
                          '12291','74526','74559','27013','51571',
                          '54964','92909','79985','10355','24522',
                          '38450','36101','55496','22736','80977',
                          '69740','29133','13875','53176','29506',
                          '87585','44249','12256','42654','30051',
                          '53827','59446','86946','79360','74719',
                          '24474','14850','43235','26353','49474',
                          '84739','25110','26779','88578','61494',
                          '44268','27981','80803','86473','87859',
                          '22326','33602','69390','51511','89948',
                          '37492','65994','85048','55263','63855',
                          '75720','57274','98461','50354','40783',
                          '28369','20721','23412','40544','22412',
                          '44981','23952','84659','42507','20992',
                          '38601','13372','68343','60664','27801',
                          '85689','75346','14364','33729','35585',
                          '50292','78568','75655','38081','89438',
                          '64340','86524','67137','94462','93236',
                          '54006','57802','96628','15565','80628',
                          '18630','37322','20384','91058','76097',
                          '25272','78360','97084','31311','95770',
                          '98401','89862','52579','11370','33499',
                          '32179','84452','22267','10848','54445',
                          '85626','28848','72965','16132','23162',
                          '54640','77232','41552','73540','41580',
                          '90718','95606','33899','73113','16679',
                          '34540','70518','24291','59519','84451',
                          '95784','79187','83828','55444','68032',
                          '92093','84285','25201','12138','90506',
                          '20934','80070','64666','19884','12044',
                          '51272','54280','15858','50187','53459',
                          '58157','74440','92425','45474','15978',
                          '66082','84173','58001','74382','64459',
                          '69883','83484','17838','59228','65589',
                          '83516','12141','30004','84901','65155',
                          '81393','59944','37071','37858','51749',
                          '14531','12730','51678','94407','29368',
                          '26484','93169','50615','41303','22830',
                          '95391','22657','53423','27996','57235',
                          '55592','38184','96298','33528','65212',
                          '54915','16501','65372','95991','77080',
                          '91823','91051','79742','38409','75932',
                          '84009','79701','29137','97689','74988',
                          '80037','79188','93842','99140','70057',
                          '71117','31077','96837','86083','85268',
                          '49269','14187','44272','12020','30873',
                          '94999','53408','15881','73554','61807',
                          '79769','74163','32612','34086','51231',
                          '99358','23043','61072','57191','62352',
                          '77362','46101','67079','39859','22838',
                          '60195','69258','80394','50804','26682',
                          '43582','99753','77500','60000','31960',
                          '59811','57151','40022','71663','98584',
                          '24122','94784','89479','33301','99994',
                          '96083','31423','47551','23595','99735',
                          '61299','31116','78430','46773','21427',
                          '75347','73104','73780','56021','93024',
                          '14756','68328','63959','69758','23846',
                          '22576','55625','35204','65979','81017',
                          '36541','36817','20787','55141','32083',
                          '98179','19183','88652','21181','83061',
                          '79380','68330','80181','48725','24055',
                          '16508','76027','86581','60133','77475',
                          '13925','53441','53058','54238','90160',
                          '60196','63379','19133','29356','30162',
                          '42364','75429','53344','51114','34831',
                          '48059','47838','49568','36459','77054',
                          '31238','67912','24794','10591','38259',
                          '15228','13204','13186','41455','25919',
                          '55546','25601','92812','21190','84010',
                          '81461','86585','86159','90407')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


