
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '83489','38150','81522','15120','58171','36782',
                          '40567','45996','54456','54042','36537',
                          '44935','68786','13822','67432','33873',
                          '43508','58613','43567','29737','21449',
                          '71174','90036','96436','67951','13263',
                          '41313','68434','62036','84660','89253',
                          '89686','11326','45527','81256','95088',
                          '47296','10855','46099','89545','78604',
                          '25902','99523','27574','14108','14923',
                          '21121','64314','63531','63074','93095',
                          '66745','19878','70345','67860','78039',
                          '51041','89491','86164','95664','14665',
                          '60502','40512','38059','60350','55245',
                          '18519','47661','64886','80198','66666',
                          '84733','55580','19971','22348','16454',
                          '82193','16634','52954','41935','45425',
                          '27220','37302','81290','34513','23443',
                          '44923','83543','63271','89729','60560',
                          '48718','86486','90262','48042','85596',
                          '55416','45565','23488','66690','78881',
                          '49821','36173','89482','87554','41755',
                          '65744','12834','85733','21537','85193',
                          '38420','64348','19824','24865','31135',
                          '21875','60399','78126','43419','38383',
                          '42382','84860','62251','89676','25109',
                          '60577','15983','27363','27653','56828',
                          '17688','69929','76636','39854','64045',
                          '51854','41997','86920','52913','47033',
                          '66937','27335','13778','76333','14736',
                          '66215','11663','35064','64511','40931',
                          '13943','25586','71950','13801','42499',
                          '78053','88868','63169','99281','22944',
                          '32755','42353','95129','85924','93305',
                          '21988','74595','98478','17457','83389',
                          '19648','53653','52980','12811','71549',
                          '24842','27957','94054','28402','90869',
                          '57230','89443','97872','52957','25346',
                          '72102','77332','95573','75595','69960',
                          '21149','96904','14085','71274','49114',
                          '72316','27356','57237','10856','57742',
                          '66209','94001','78754','26684','55311',
                          '72764','35550','86791','80311','67757',
                          '84628','41126','13103','96543','91598',
                          '43448','12902','95987','84661','94087',
                          '53856','66213','21015','50705','56775',
                          '77904','33680','66770','46547','54774',
                          '60044','93948','12966','68822','84679',
                          '79728','49495','24349','33850','61000',
                          '52398','54112','58117','73841','49579',
                          '67524','24185','73392','73416','94523',
                          '49866','27960','59821','41417','95453',
                          '26646','58894','43678','64930','94075',
                          '13336','56044','44311','89573','89110',
                          '30236','26911','90369','56089','99923',
                          '54053','12502','96481','63313','68285',
                          '95391','49679','78462','45804','72927',
                          '38448','44682','19671','49690','19559',
                          '45081','78750','97758','42831','78129',
                          '78707','35604','73503','39485','82707',
                          '20155','20575','12248','90361','37847',
                          '87358','34635','54858','44283','58895',
                          '78662','12987','91746','62909','55131',
                          '94723','43397','82335','85353','23344',
                          '79708','99190','31690','24039','13388',
                          '32073','86722','40277','41151','51123',
                          '50908','75063','22010','11976','28826',
                          '37293','61285','63252','38446','62053',
                          '25995','68021','87289','98920','78946',
                          '70792','49668','42684','52227','65472',
                          '50843','67771','73302','20249','68817',
                          '25949','75756','67612','44933','29133',
                          '46494','98084','99406','74649','19478',
                          '33815','60038','94727','65315','47643',
                          '30640','48038','15907','84970','64779',
                          '91095','75934','27830','39600','33691',
                          '88942','12477','27871','80640','56138',
                          '69744','27641','51767','43902','88694',
                          '92673','38187','23831','38458','96520',
                          '52941','85437','17872','93065','18978',
                          '90938','17119','84360','73507')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


