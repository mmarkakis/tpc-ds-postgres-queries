
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '25009','10668','34088','15083','88191','99494',
                          '23418','77062','53908','85410','86752',
                          '20194','64419','13416','54840','76158',
                          '58871','56999','97949','91407','93229',
                          '17520','85070','82130','14752','32534',
                          '51425','11788','74041','21124','28560',
                          '53404','54319','88952','31748','53965',
                          '40563','81377','58603','85482','32714',
                          '15980','10160','74903','52281','69568',
                          '59366','44819','40696','39326','12882',
                          '85664','92191','48507','67673','33676',
                          '45791','66301','37802','55437','92480',
                          '42809','64019','76147','40632','73888',
                          '63606','69300','30337','41339','23309',
                          '80364','68448','38105','97069','41964',
                          '64804','43283','15702','94497','40983',
                          '77771','37113','44525','92269','76878',
                          '81089','96054','92735','15756','17946',
                          '69292','93281','75278','45785','10086',
                          '79281','46410','88929','50887','17024',
                          '37191','52677','37361','66269','17474',
                          '19446','14745','44646','36853','39392',
                          '63892','48234','48716','61227','22375',
                          '18791','31870','43840','21767','12615',
                          '10572','25726','71091','83347','67056',
                          '33809','70755','43175','19015','98132',
                          '83811','46689','95094','84741','20086',
                          '26013','43456','92465','36171','23719',
                          '72893','19537','12004','98140','35474',
                          '12174','68827','15565','76976','26309',
                          '98960','28106','91916','25229','97230',
                          '62993','17689','67374','62740','59863',
                          '58165','25395','35609','50265','37740',
                          '11066','42545','62862','32057','63182',
                          '77449','53281','38218','11089','42904',
                          '14314','28273','71695','58058','86577',
                          '41492','39055','13216','15551','86668',
                          '41409','73880','81178','35587','23491',
                          '84616','93353','63215','68632','89067',
                          '20935','40110','79851','42744','56031',
                          '63845','83350','67435','36485','96137',
                          '41848','50673','91159','59945','62188',
                          '92350','77459','51948','92762','97824',
                          '94565','47257','99615','51068','64843',
                          '91844','26650','63180','27982','14822',
                          '95231','50760','85897','91123','49997',
                          '70743','69167','89716','77569','13744',
                          '71501','59414','94340','73082','51397',
                          '33268','27590','28155','31983','46853',
                          '53732','57736','49303','98900','74822',
                          '41451','50004','52358','55769','90804',
                          '66723','34722','24815','30919','11366',
                          '67914','51367','40570','38617','90094',
                          '43384','88571','46671','62140','79005',
                          '50071','74373','45119','29850','97423',
                          '20998','72782','71662','90247','19074',
                          '94437','16081','10327','41018','31764',
                          '76183','32741','53719','49363','78854',
                          '13679','32307','34060','61841','21530',
                          '37038','25966','34495','34686','57655',
                          '83323','88484','38838','83730','66527',
                          '96162','48938','20483','41152','42599',
                          '13919','11481','62267','78074','95866',
                          '43356','29164','63321','12366','21667',
                          '99511','51071','92210','45324','94609',
                          '49722','82210','97276','95439','19187',
                          '30823','33771','37539','28788','47819',
                          '82342','86263','48323','24016','14803',
                          '75780','53903','27658','67544','81884',
                          '48835','51834','49517','35733','75915',
                          '13042','23563','85390','59813','96456',
                          '88861','65654','32736','36302','67719',
                          '79709','93625','61356','52628','39251',
                          '29239','91614','53491','71619','54186',
                          '52038','43250','23857','58447','73658',
                          '11502','59029','53009','74498','48593',
                          '74064','47080','89455','76698','89416',
                          '44058','10923','95438','26901','98503',
                          '98030','37018','23570','43407','49672',
                          '95373','47815','41055','60912')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


