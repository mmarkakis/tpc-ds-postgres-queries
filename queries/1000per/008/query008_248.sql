
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '91744','31184','71033','42361','93218','66384',
                          '93363','58877','13152','44925','18270',
                          '66700','73693','58933','61944','20659',
                          '23019','51064','85910','97050','50451',
                          '40295','73546','11365','39004','17988',
                          '97538','35896','90451','68110','97191',
                          '60037','21069','28689','42552','74360',
                          '11755','81755','92959','43535','38261',
                          '31086','64870','20399','46232','94455',
                          '13951','23797','36980','70591','75298',
                          '19135','26267','37846','87258','27245',
                          '38154','36576','30132','39038','54948',
                          '55236','56718','35992','39500','57515',
                          '15972','60008','54577','54873','47735',
                          '66501','54742','42910','90931','24345',
                          '62996','95180','83542','83386','10248',
                          '83482','62378','65944','99852','50388',
                          '48511','37430','28248','34805','57289',
                          '41821','10800','51506','30326','32995',
                          '78397','70805','50102','97874','42995',
                          '93317','60665','36682','16481','53134',
                          '14563','11567','11428','30162','88951',
                          '69302','45693','54715','35303','96875',
                          '78845','37186','76855','52318','17499',
                          '23013','27530','87778','34316','57669',
                          '49260','96608','89167','85512','22458',
                          '23276','74700','98445','97553','76593',
                          '71106','72367','96279','72569','49526',
                          '47807','66925','65333','19349','58404',
                          '32501','18542','46077','10932','15890',
                          '71925','43149','24153','35800','22599',
                          '17122','16613','79049','45691','51703',
                          '20855','30022','74614','21432','68233',
                          '32688','72240','66034','41230','25041',
                          '57784','83744','75427','79203','41126',
                          '98837','25728','42975','58224','56396',
                          '54123','67907','22555','56719','45626',
                          '86096','65092','62203','27266','31317',
                          '25501','51583','62415','12776','55370',
                          '70160','14193','90272','75374','10306',
                          '57131','14561','42935','87762','86091',
                          '44755','33069','37541','67525','22632',
                          '95337','11491','52467','71476','31992',
                          '47270','95078','96140','69437','80260',
                          '26444','70546','38575','87824','42042',
                          '20024','12113','98027','81823','20568',
                          '44538','81484','53976','24918','86288',
                          '50500','30796','58988','28326','56581',
                          '68081','93078','23697','74953','64974',
                          '37815','72100','52544','10718','39573',
                          '79046','41020','52857','64269','55342',
                          '33731','19623','41526','88011','38046',
                          '89175','77392','11691','77646','99470',
                          '65479','11492','64488','46698','59855',
                          '95782','45449','55740','52804','58517',
                          '51736','69217','85036','40931','77969',
                          '79222','25367','79368','79441','42912',
                          '96976','47656','27392','89118','50200',
                          '23868','40038','84528','78941','15266',
                          '91650','38671','58589','39350','99760',
                          '56883','10588','34982','23809','73517',
                          '62599','86691','85181','94795','36525',
                          '18458','62012','24355','26589','31348',
                          '82935','23589','28777','36955','11965',
                          '82175','76637','80569','97878','12918',
                          '77208','73316','90911','37888','54243',
                          '87450','14965','45650','90505','50885',
                          '29849','26787','37312','85122','90018',
                          '96420','91717','99295','15756','77180',
                          '96925','51465','99005','26773','42035',
                          '36307','38172','48776','85142','38252',
                          '51742','83090','57227','30832','23821',
                          '38489','23293','75876','46933','75794',
                          '38886','94844','86362','49567','73475',
                          '32569','78607','28474','74977','57072',
                          '97728','25765','39992','76859','13061',
                          '14860','24316','95380','11487','76587',
                          '40992','84370','18771','66389','21425',
                          '30102','67099','67393','83585','78738',
                          '84229','72584','95433','97328')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


