
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '88649','22284','27817','94142','21784','53462',
                          '22393','69066','96887','65665','51848',
                          '93299','19955','15393','33172','65606',
                          '90418','54732','68390','96633','39814',
                          '96508','98968','85467','20007','16777',
                          '70753','44354','41497','71296','64043',
                          '55014','78614','10982','24076','92744',
                          '96780','37426','10626','25848','53175',
                          '43257','82608','15900','86650','88128',
                          '42275','36592','45031','18527','40354',
                          '24206','73990','58943','76219','69327',
                          '25590','40825','84535','46663','39564',
                          '63131','79873','28366','67353','22265',
                          '94906','97869','94238','80308','83598',
                          '99940','98248','40742','93033','84686',
                          '41285','72727','11324','73145','59161',
                          '10348','63714','40252','82268','21549',
                          '26451','32694','65982','25545','65042',
                          '39295','59694','96566','26899','68656',
                          '12879','44342','58158','75573','41025',
                          '58907','98206','68948','41006','10060',
                          '69046','86945','30270','91234','48602',
                          '95100','53932','88935','95195','26092',
                          '45382','65310','12049','14012','29366',
                          '81304','26593','97348','54277','78406',
                          '74108','18236','39034','51621','25690',
                          '36118','57687','75694','69107','61317',
                          '85229','45101','59149','82891','62781',
                          '86361','57620','94956','17934','47774',
                          '70343','40807','22090','94683','32305',
                          '17740','13353','49494','36423','37102',
                          '78139','83695','14236','86814','36824',
                          '33327','26352','73915','30376','69525',
                          '19689','46411','19062','58605','86285',
                          '37349','52064','28079','18930','19380',
                          '41447','57630','25871','68988','98565',
                          '96475','74109','49789','40188','49509',
                          '19766','37956','28950','65653','75817',
                          '97438','79632','86515','55444','97608',
                          '81964','43497','97320','86325','45262',
                          '95649','61868','23250','74173','16107',
                          '45001','96658','38499','25100','83728',
                          '30370','57730','87688','26419','96298',
                          '29418','62053','50377','14419','51723',
                          '25672','57632','36137','44057','20090',
                          '48933','95818','26666','21582','82307',
                          '84039','51371','60341','18395','23353',
                          '26006','87763','39222','23319','28496',
                          '58140','30266','12468','15163','89305',
                          '70659','73411','79448','93917','77843',
                          '17780','96418','70546','93223','72272',
                          '37263','52943','79102','19355','48507',
                          '35470','71300','62663','40568','74378',
                          '25812','88791','26297','66625','43702',
                          '92879','25121','31381','63294','84661',
                          '20718','29174','87886','19663','78945',
                          '51929','44161','81449','55119','32956',
                          '78562','73436','39652','21261','99759',
                          '64036','86956','11499','31657','77510',
                          '57728','96520','38945','28509','42340',
                          '38135','88637','88323','82345','73500',
                          '35124','10399','13175','66590','26314',
                          '88341','40686','10536','32437','76727',
                          '19351','11980','79264','98485','74572',
                          '34540','38642','44286','33461','88186',
                          '26964','44279','40776','46443','10004',
                          '86289','41793','63418','87826','90460',
                          '31341','76926','59948','68650','37230',
                          '71799','28920','84611','83276','12150',
                          '17897','97185','31024','64159','44497',
                          '87863','46449','23364','26170','66943',
                          '58315','53362','48766','97971','45182',
                          '82145','47113','54029','37569','95594',
                          '41168','94686','35504','59766','79205',
                          '86947','70329','60467','42246','68079',
                          '61804','62960','49736','48200','45881',
                          '93877','93118','84011','11808','65122',
                          '76769','50081','70606','12048','85982',
                          '76498','72184','37173','70021','77316',
                          '31276','10523','19136','33740')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


