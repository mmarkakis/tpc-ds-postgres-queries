
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '56377','91386','42975','39621','88264','88228',
                          '60364','68485','84546','98001','60779',
                          '81015','21170','97676','94586','91558',
                          '51031','22846','42010','25383','86441',
                          '75853','51183','48377','76240','98271',
                          '38760','54609','90704','41993','25115',
                          '18774','95407','43415','23166','82651',
                          '89309','30105','88280','72218','15038',
                          '21469','73867','24370','12623','31266',
                          '95976','99929','79384','97392','62495',
                          '81786','58701','97462','80280','51278',
                          '51237','35084','22038','28484','75726',
                          '23559','55440','27934','62453','67100',
                          '38024','84164','76004','72127','68912',
                          '12165','78027','40854','32357','85946',
                          '24199','25560','12835','45427','10040',
                          '71034','56968','20977','88928','93718',
                          '81360','76294','28213','97733','98908',
                          '25508','48052','35150','80039','40724',
                          '87890','26275','56709','84039','92111',
                          '43367','84317','35802','85573','46497',
                          '30008','15913','90898','72090','46271',
                          '16052','75543','68325','17189','33056',
                          '95894','28691','16069','48161','79075',
                          '27452','52448','96482','48801','93013',
                          '62666','58733','28145','31798','39329',
                          '10731','86240','59634','14986','40593',
                          '29336','17302','94974','91507','84406',
                          '75667','85723','81210','67320','42583',
                          '79707','20081','29574','24955','58285',
                          '63693','37849','26986','83158','26665',
                          '92164','68674','14582','41780','96622',
                          '29448','46759','26750','30374','19744',
                          '89434','55462','60566','75883','48934',
                          '75493','63115','26276','34020','94552',
                          '50864','75430','83123','78324','15050',
                          '61350','82078','35924','89099','89652',
                          '78095','14002','38417','64687','39387',
                          '70240','68879','21361','86502','33983',
                          '54159','13528','74891','23873','33935',
                          '70846','73214','38015','85621','27656',
                          '92262','30988','14227','58615','99380',
                          '61483','20980','78083','69288','93922',
                          '89624','51741','43281','88698','50188',
                          '27309','13194','29871','19573','49444',
                          '30604','33309','84949','12589','51710',
                          '25790','61800','15235','46937','70336',
                          '63298','16875','35673','55251','58436',
                          '79439','61004','51991','26581','96445',
                          '39251','63325','32145','75730','25733',
                          '17075','19240','42350','12380','85540',
                          '22053','62184','27280','46436','54079',
                          '56564','61068','36094','20868','55919',
                          '76701','96623','59272','89570','21628',
                          '62159','71051','14084','33257','44233',
                          '70430','11479','53882','98722','70560',
                          '39179','96702','28157','62457','71746',
                          '30114','39905','92027','11945','98743',
                          '66136','83761','93168','20360','90571',
                          '21613','82454','28926','16197','12084',
                          '67802','92725','65626','54885','65509',
                          '94643','35879','68036','88291','44366',
                          '75998','59386','60653','96795','19599',
                          '64384','76685','32517','90980','89451',
                          '11720','93134','11966','67180','49131',
                          '55044','49146','65519','57677','70917',
                          '49273','89171','33248','54161','54135',
                          '51400','32263','60916','86614','20635',
                          '64177','73239','45822','19460','46338',
                          '32944','51002','35319','60123','23047',
                          '36449','93151','92822','43527','93691',
                          '53436','96424','17243','64559','21028',
                          '78359','37863','99520','60865','75743',
                          '39320','38440','85281','16373','59907',
                          '16858','50822','24480','51797','92743',
                          '16712','18923','62410','96475','50042',
                          '48986','99590','83551','22326','85252',
                          '51020','64001','55617','74251','23610',
                          '12929','63352','35524','13521','32858',
                          '17291','50399','94219','82300')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


