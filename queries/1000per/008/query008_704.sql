
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '23368','79496','72257','69877','44215','70890',
                          '68155','48169','52702','39758','56238',
                          '96116','73976','64086','65486','80995',
                          '96843','29555','55110','79070','80266',
                          '46818','45822','12170','38892','42074',
                          '14666','54899','88609','21125','47437',
                          '52734','26266','28021','46725','96007',
                          '36901','99921','14209','34544','55229',
                          '19373','82315','77587','26367','40960',
                          '84884','72393','45207','78174','77499',
                          '45567','52581','56764','46753','65907',
                          '64676','67052','80770','42830','94944',
                          '89025','33916','46233','39721','63078',
                          '87374','36333','84214','37146','45881',
                          '28749','71483','45030','48984','68447',
                          '98840','11304','26786','53630','63475',
                          '16426','10474','96632','64701','49284',
                          '73985','48392','64245','61356','82356',
                          '36887','73847','98555','42110','97633',
                          '11228','28656','84524','16598','69216',
                          '87423','13642','43492','23601','23412',
                          '94666','88047','19994','59155','29648',
                          '38726','19983','24893','41059','95822',
                          '99090','65320','82237','39852','68622',
                          '52642','85488','96376','92549','69835',
                          '77353','47542','47133','10127','23032',
                          '93101','37243','82321','61716','77442',
                          '85066','33793','49446','78011','40878',
                          '38693','84056','50342','92256','30298',
                          '81371','67363','81622','97805','16054',
                          '28036','10823','60370','24933','53505',
                          '42337','81223','91195','17397','59885',
                          '46308','83351','34861','55006','50858',
                          '10247','42152','39729','74413','83138',
                          '53248','56181','22153','59046','52790',
                          '16568','76097','27793','73417','18658',
                          '18012','36208','42366','80811','53637',
                          '33575','98510','22370','57182','73196',
                          '96529','89853','43012','74240','43048',
                          '22816','26144','62109','60358','51645',
                          '17885','65230','25227','55925','58887',
                          '97656','79819','78737','41470','23375',
                          '40048','24337','16418','77823','35448',
                          '26695','79299','21904','41508','25819',
                          '38905','74975','32498','16288','90509',
                          '42756','99112','64306','52690','54204',
                          '80539','37185','27317','80599','70757',
                          '51201','48576','21272','30310','76214',
                          '67361','47470','52514','94674','82250',
                          '26148','77432','60993','16250','65342',
                          '58110','11551','98894','22476','95900',
                          '63662','82925','71376','90123','70740',
                          '44594','37996','54434','85534','89647',
                          '74251','70390','95876','66957','91691',
                          '90725','62642','71970','40431','13988',
                          '34968','35874','13417','54113','55429',
                          '74851','38050','31823','16453','80868',
                          '71967','27649','11269','33199','96950',
                          '81513','94504','68705','82833','34997',
                          '50962','97482','75528','44531','99305',
                          '93387','46739','16433','87587','73191',
                          '10972','38247','96525','99745','97150',
                          '38330','47891','52835','53934','24385',
                          '38254','33136','82320','60201','66424',
                          '88650','16018','62902','97982','71284',
                          '82806','98743','55309','73776','89550',
                          '14108','30880','86131','35252','92061',
                          '30709','97170','56936','65743','34405',
                          '83813','79396','75708','23372','85282',
                          '30667','71156','37234','17466','91538',
                          '93301','39579','78200','54389','28347',
                          '45647','99567','37207','10948','21990',
                          '38891','47736','54976','72785','13310',
                          '41974','44589','25455','98052','66479',
                          '11820','94170','64962','90319','90535',
                          '36032','30427','39490','20704','13790',
                          '54084','48902','17616','46408','24053',
                          '42600','47525','82970','13658','31124',
                          '75848','47092','56487','36634','49356',
                          '91635','78114','26423','46914')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


