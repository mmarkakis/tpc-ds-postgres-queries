
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '63627','28890','35005','87247','76485','57189',
                          '71459','24525','98941','96820','58027',
                          '17009','20933','24385','84261','26402',
                          '53646','83064','15892','55344','97182',
                          '11369','50136','66720','13498','85978',
                          '33185','16440','76700','95923','11756',
                          '73379','73636','39635','31074','97566',
                          '63915','40477','95609','40602','75513',
                          '81088','37004','97058','28423','32651',
                          '79393','19453','69748','29486','77246',
                          '61565','53994','77700','37352','90842',
                          '20221','89938','94678','50004','72127',
                          '81607','83974','33272','81239','22316',
                          '51997','10056','64109','50925','10145',
                          '62429','94676','18942','78235','41172',
                          '63003','39880','67654','49848','61102',
                          '42039','24358','95152','44122','19531',
                          '26283','38614','17349','73083','75140',
                          '94983','48254','81179','97866','34079',
                          '97387','18219','57888','93192','86987',
                          '29614','31739','44903','37403','51039',
                          '40423','90429','44005','33343','97818',
                          '86708','87022','51907','83814','73702',
                          '89603','82413','23249','15301','38463',
                          '95613','50160','98052','95590','58496',
                          '45910','62129','64658','81017','98111',
                          '80346','53920','21954','63271','81642',
                          '88068','94347','90558','81348','83483',
                          '35606','33478','58220','99523','65480',
                          '98825','72966','46565','61155','81893',
                          '17396','77074','97506','62193','72489',
                          '73171','15016','39093','95293','35191',
                          '43193','54500','64367','48583','56528',
                          '27853','19261','58694','52636','17943',
                          '89153','74548','61127','16708','96861',
                          '91451','41517','11359','80141','23376',
                          '87110','78769','90624','37842','29149',
                          '49355','41032','71164','92167','87934',
                          '73541','65520','17603','94661','49023',
                          '21276','63997','50044','95850','77354',
                          '56184','33200','80567','11407','73520',
                          '11983','85824','77450','89329','61554',
                          '34103','45427','77651','58894','73022',
                          '33942','37347','93656','29168','90160',
                          '98232','74160','36766','63202','84806',
                          '54400','18008','94941','17589','70362',
                          '86228','75468','27144','80858','35882',
                          '77897','91287','58664','66962','15270',
                          '30639','75411','19982','94771','31556',
                          '43544','37609','41432','52974','33527',
                          '28328','28027','32711','65539','11824',
                          '32762','66164','24744','95308','27765',
                          '64217','31963','13341','13591','38430',
                          '79108','21161','80707','30831','84455',
                          '27755','12936','16981','50377','53933',
                          '27827','30039','14050','62342','70178',
                          '65823','18422','47454','69482','54653',
                          '72965','21367','57159','56122','32521',
                          '50075','19784','99353','83525','61151',
                          '27571','20949','85853','21953','69340',
                          '70026','70884','34155','67949','68708',
                          '44130','62910','19283','56047','88459',
                          '54167','28874','92960','80801','80980',
                          '71405','63908','54085','84777','29915',
                          '46001','29403','89665','89623','11163',
                          '38342','42281','73792','77827','91525',
                          '93416','59239','32712','44041','46102',
                          '71861','63860','49473','30364','17430',
                          '59280','62598','22632','31786','38724',
                          '26270','53111','94734','27526','32983',
                          '30525','15054','45515','91924','27961',
                          '48441','27848','35973','49579','74002',
                          '10665','69531','23919','39246','50099',
                          '69944','10219','10396','93490','89447',
                          '80864','21023','97274','91793','54954',
                          '46318','12722','49162','99378','67961',
                          '57231','44893','36741','91028','89333',
                          '21699','87013','28446','97957','62707',
                          '14998','68323','22798','39863','82630',
                          '82641','53233','78170','34515')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


