
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '94078','60153','35796','95711','49107','44514',
                          '50113','27065','52389','47216','89092',
                          '73311','99775','73338','81195','83263',
                          '33154','82776','71593','46668','97043',
                          '54751','22659','44516','62589','59551',
                          '25056','59237','38707','72881','18998',
                          '95305','17065','70739','54855','45994',
                          '36868','79047','25021','96276','95923',
                          '36617','34447','80422','51092','27930',
                          '11876','67977','70992','90675','89514',
                          '54865','66918','33116','51452','86581',
                          '68063','14758','45080','36680','22875',
                          '43747','18479','69087','93754','54432',
                          '49410','19898','22333','70461','55200',
                          '31697','37744','51691','31422','16462',
                          '85368','16872','84995','41553','19961',
                          '97379','33320','82619','17907','45775',
                          '97553','25464','75373','99233','89816',
                          '62054','90430','39027','22507','43420',
                          '55101','46563','96461','79797','49806',
                          '81617','58027','66667','24900','83936',
                          '17203','95833','53950','54402','57566',
                          '75497','69089','39939','28538','73759',
                          '69591','92954','30966','40604','22508',
                          '94297','57946','65606','35146','14618',
                          '26740','60770','36194','88346','75161',
                          '78442','22028','78859','39372','69457',
                          '24691','82446','14069','34617','76371',
                          '10925','75999','84194','97108','91580',
                          '76703','13135','57986','40164','10352',
                          '59789','27244','73425','54732','49571',
                          '63798','77789','41771','73960','90919',
                          '78688','59916','68229','21653','56958',
                          '39292','63985','33443','21051','51879',
                          '38630','29029','81588','67135','20638',
                          '82091','55021','61407','68961','76730',
                          '87350','74218','87180','95309','91861',
                          '26706','78003','83367','23278','48445',
                          '37828','29720','85221','59761','15351',
                          '80009','37391','14029','75875','61317',
                          '67791','19203','74083','67620','26493',
                          '92928','68065','68102','79704','37610',
                          '65985','51385','90907','76983','70703',
                          '84487','88553','13926','98940','41966',
                          '14320','79430','60798','56561','96631',
                          '62318','73361','34716','84551','22056',
                          '25719','55009','46644','34991','59875',
                          '72204','23840','78104','42470','54138',
                          '60540','61250','13226','41175','99050',
                          '54018','23273','93827','70590','85531',
                          '21762','17963','64330','63717','94704',
                          '72030','34873','95944','60410','42099',
                          '38791','91408','81164','99319','70382',
                          '65462','91585','97588','95427','44572',
                          '81870','55585','60506','18238','17615',
                          '44701','18359','33219','60601','82936',
                          '31437','71939','64262','21641','37176',
                          '72885','98401','20083','38953','20496',
                          '51663','11236','53543','31432','96704',
                          '82190','90887','33607','46223','46600',
                          '62808','32652','52923','56327','53503',
                          '22968','48714','43811','92432','81518',
                          '14706','76314','75613','99439','23721',
                          '93504','88125','92004','23509','81814',
                          '20311','67680','38847','63835','72855',
                          '87126','89815','30039','28080','48898',
                          '66917','16187','62725','36641','85770',
                          '56886','20997','95368','28661','40570',
                          '19897','59160','53321','66923','31770',
                          '84536','35540','20398','65838','45149',
                          '18278','60106','77098','56545','64521',
                          '57287','63852','22862','46694','36283',
                          '76656','38576','13054','75963','83278',
                          '75879','26831','97956','22154','56193',
                          '43278','48806','25822','44743','22184',
                          '99217','20812','81691','75233','94736',
                          '49101','67067','63432','74422','19289',
                          '79220','65854','10731','48903','65450',
                          '86093','73066','49260','15265','82577',
                          '66950','84593','17179','19523')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


