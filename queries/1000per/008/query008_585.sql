
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '13333','97548','51748','63429','24993','31998',
                          '92701','77017','92197','50100','47142',
                          '26816','25198','47230','54683','11638',
                          '73587','53142','80429','29883','91632',
                          '44816','21844','92366','11134','91866',
                          '78541','97910','21451','92523','45580',
                          '52898','29604','52995','17077','69824',
                          '15081','18044','56145','57744','60265',
                          '59117','17661','54456','29175','52620',
                          '20484','83442','55956','28422','58179',
                          '70632','93220','26414','28156','19558',
                          '80800','53628','40136','85107','42774',
                          '17623','44854','43337','25749','28240',
                          '73502','52754','47291','74967','91962',
                          '99748','46214','12519','34272','16334',
                          '79092','17228','43720','12982','55112',
                          '31219','20374','72339','28335','92709',
                          '11748','48105','25751','55368','72184',
                          '24340','58722','32118','21292','13718',
                          '62605','63253','36827','78441','23322',
                          '21426','10729','32844','57360','27911',
                          '17041','12279','17605','17155','63769',
                          '30384','52599','66488','43172','82978',
                          '64875','79072','48679','83953','16375',
                          '14494','49868','91571','34759','15554',
                          '26144','84309','64831','89705','20437',
                          '65971','26084','46375','52364','83593',
                          '29388','30005','40941','18339','89014',
                          '57757','78412','41409','77916','52237',
                          '24983','76132','94131','36391','44195',
                          '64092','81262','72428','76943','28642',
                          '10984','89895','54242','80085','31331',
                          '51641','43461','15631','55304','27678',
                          '93619','55869','75220','36603','55281',
                          '27049','27148','63198','45634','98307',
                          '85071','73756','53445','79627','15728',
                          '43844','92355','88546','24839','40741',
                          '73109','73116','90778','93865','83711',
                          '61248','89770','47822','32393','17671',
                          '66371','78201','71456','65123','79201',
                          '23873','41730','93978','90377','92837',
                          '77316','59781','36620','40049','15173',
                          '59980','47568','74798','27436','30343',
                          '35216','81349','18247','78398','61163',
                          '76796','11824','80894','61744','69885',
                          '26215','40063','36647','23768','20678',
                          '47135','68960','46817','26112','76258',
                          '45681','20912','77001','54129','36942',
                          '60106','24391','93740','70665','98321',
                          '25330','91835','25364','44720','81897',
                          '88874','36228','34489','31881','77467',
                          '24836','23716','86354','41454','59797',
                          '74620','37449','18032','68469','26421',
                          '28853','23882','66862','91157','24590',
                          '59939','57480','94223','78432','12815',
                          '18808','51700','20143','35615','62353',
                          '79669','28132','54010','17878','39880',
                          '67252','11469','63407','11039','29663',
                          '33126','20675','65256','56627','48533',
                          '78707','73162','74602','68171','93673',
                          '20303','21086','40403','71923','32744',
                          '33714','44152','83143','88465','43766',
                          '92115','14251','19807','62808','16510',
                          '58436','76620','36036','88470','64965',
                          '45124','26956','99649','22827','94154',
                          '17814','29441','45447','98283','27088',
                          '75302','77179','17805','96122','82942',
                          '17612','84260','87892','43351','14154',
                          '76721','98140','69718','53255','46607',
                          '53241','24667','13138','14095','53358',
                          '55878','15944','55145','50779','44116',
                          '25304','93864','22165','29586','15904',
                          '97200','70328','78044','52430','74677',
                          '48764','43207','21230','21290','14495',
                          '69746','33476','33902','41230','85871',
                          '33923','37790','68077','57974','69212',
                          '53207','49834','69301','47957','64727',
                          '97203','75998','69400','80839','34036',
                          '92467','96016','16489','74352','33174',
                          '53271','87468','49801','83717')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


