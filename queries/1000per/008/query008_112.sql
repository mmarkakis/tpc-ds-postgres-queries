
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '36301','63670','51420','68505','68386','17859',
                          '92407','12896','73376','93737','19748',
                          '44097','14005','28468','43791','93736',
                          '66625','43075','92200','85366','98599',
                          '87025','56690','41352','29234','93582',
                          '80218','43372','84084','84045','36039',
                          '21475','83865','56759','28390','58181',
                          '16508','58251','29805','73818','84051',
                          '84279','77378','10753','83554','95074',
                          '47872','71775','39600','49144','82418',
                          '79445','95907','34064','71346','65637',
                          '72190','86200','24157','85130','69762',
                          '12646','76129','38469','45151','58359',
                          '46004','94538','80252','22096','95581',
                          '25530','95791','64374','63639','90922',
                          '30589','54183','92884','28086','60849',
                          '85719','78856','26229','15436','95445',
                          '59204','39289','26266','27839','39568',
                          '44092','50055','94661','11902','79503',
                          '73638','18955','15759','40527','15367',
                          '11210','71919','92546','72614','74075',
                          '73014','84584','74144','25242','70986',
                          '32579','54281','47666','87345','96142',
                          '77933','85806','49898','92880','34521',
                          '56027','15067','33627','45723','71915',
                          '83067','60882','19083','71226','43091',
                          '63235','76874','71414','49701','40941',
                          '96641','97487','50786','21697','43331',
                          '26341','38453','79666','44132','54252',
                          '17679','90115','55829','61662','66492',
                          '63225','57703','69447','48386','58187',
                          '59953','23312','34956','95004','61968',
                          '74904','79911','68928','62776','90463',
                          '69670','90240','83144','52907','35389',
                          '37773','11862','77263','21755','53695',
                          '90557','35137','14162','90822','30186',
                          '72606','19421','18853','78521','66423',
                          '34445','22007','73029','83875','67039',
                          '80072','14996','37128','17655','42383',
                          '52010','98286','83396','66310','88108',
                          '96876','22022','85206','28692','17322',
                          '74863','53003','58837','51421','29507',
                          '68285','39919','61180','50342','49016',
                          '11250','78732','83187','45995','64696',
                          '82182','51858','70113','90615','46420',
                          '66540','83174','58756','59031','84848',
                          '29146','84136','64342','56464','44814',
                          '83696','10176','49123','21175','43621',
                          '68603','96221','79304','56632','29976',
                          '94585','41649','60449','11588','71408',
                          '87133','13713','53270','11240','17622',
                          '98970','94892','78924','48069','20292',
                          '73841','90027','22141','31612','34076',
                          '39836','25711','27907','79328','61404',
                          '40711','77063','89703','44732','88921',
                          '34335','11624','62882','76907','13424',
                          '60047','77514','89253','75564','79689',
                          '52800','90433','69535','41348','21185',
                          '29747','90868','43009','74874','61061',
                          '17515','28623','99501','54066','53198',
                          '62099','15801','84190','14941','86014',
                          '42257','23294','16456','70302','70280',
                          '50536','87713','74796','39501','80128',
                          '69544','14179','18234','21109','40620',
                          '22292','84790','55572','49045','22067',
                          '38785','49628','31845','29839','82399',
                          '50358','84243','92179','10142','77776',
                          '76465','95163','69531','28389','34177',
                          '96095','34390','36787','44242','15549',
                          '10498','67753','81445','47685','72569',
                          '84266','88025','94118','24772','88665',
                          '25511','78179','34967','71041','39162',
                          '29784','77891','34924','68761','66266',
                          '47039','91197','52256','98242','52721',
                          '64480','70022','48691','20436','86980',
                          '21666','35485','31069','91941','73792',
                          '57018','17414','22418','71925','81156',
                          '59838','50613','69041','98734','24753',
                          '50143','63686','22964','91316','11570',
                          '64532','65247','19125','27108')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


