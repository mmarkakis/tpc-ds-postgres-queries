
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '68896','99692','87904','63572','96466','67936',
                          '38393','30641','37631','12267','67994',
                          '52450','21512','10820','89983','45591',
                          '63285','62593','20533','56953','93782',
                          '31070','95013','36239','17363','34855',
                          '54743','38741','77612','14337','48934',
                          '72639','23670','45996','16197','41364',
                          '43994','10688','46554','73897','36430',
                          '51750','35811','36131','12806','24774',
                          '27745','64018','97281','56403','12454',
                          '42557','13969','63582','15006','54433',
                          '16701','66973','31083','93903','48608',
                          '37554','81849','47224','34871','52405',
                          '92940','93447','84027','93771','87215',
                          '16520','63633','65942','73737','29039',
                          '22068','73035','96901','49078','76257',
                          '79950','22572','21183','23203','62571',
                          '48770','66185','68908','25012','23947',
                          '36949','59611','55754','75378','84194',
                          '59238','85936','63322','21142','94914',
                          '49664','31558','31299','80165','28836',
                          '27304','79726','88223','75823','47802',
                          '93000','22495','90456','72958','80253',
                          '27108','58839','13235','74549','80411',
                          '89839','73798','15709','80778','55814',
                          '92139','47226','95200','65578','46319',
                          '95690','32553','72028','73565','75341',
                          '77244','51713','22423','58133','47040',
                          '68290','61358','20852','27061','87982',
                          '55398','29390','13901','81120','66658',
                          '70942','61263','69694','47917','99413',
                          '23061','73664','46662','10638','31363',
                          '21211','84271','43833','28305','56030',
                          '25020','47351','92993','95884','63076',
                          '66540','75137','79601','17247','64666',
                          '52730','23780','76397','83048','44437',
                          '17535','56737','71202','66944','69760',
                          '51788','90800','40559','58276','71642',
                          '80600','36308','71276','54553','36254',
                          '90966','82323','38775','25672','46354',
                          '79622','71164','76249','85024','13591',
                          '31863','99479','16447','49833','63375',
                          '17741','61018','80512','58071','60721',
                          '62712','46664','11339','38137','97044',
                          '97610','28612','61620','73734','89233',
                          '44592','61786','79800','82469','82943',
                          '47236','78418','98973','99261','53733',
                          '70017','56240','67550','42200','64470',
                          '16229','85951','27723','48587','88936',
                          '12245','66363','97788','16299','30915',
                          '79336','96406','79562','82902','93109',
                          '68576','27057','50336','44765','75783',
                          '18310','21192','73607','28578','19670',
                          '16746','87535','15951','30490','75215',
                          '55497','93763','94525','21858','78223',
                          '83761','50575','79939','95985','13038',
                          '70593','86388','18549','99741','19587',
                          '66110','30428','95486','47296','46938',
                          '15360','48656','82678','62081','71892',
                          '87843','61424','47388','73738','73119',
                          '64093','69631','55536','58101','52652',
                          '61256','92065','23927','88712','54770',
                          '10797','25221','95103','73709','78360',
                          '67933','93642','25847','52607','66509',
                          '45252','32169','17884','53620','58064',
                          '29956','62425','11488','79137','26025',
                          '34071','11283','58151','61104','57358',
                          '81798','14274','59932','23752','60913',
                          '21730','19750','14210','11239','69593',
                          '49492','64161','37781','36323','14722',
                          '62607','23485','47087','84297','63174',
                          '19619','27779','92244','26577','93191',
                          '50119','83954','67666','31499','64523',
                          '62154','92393','93792','11222','40454',
                          '29848','69040','35148','45506','84374',
                          '59331','81684','88892','44642','79095',
                          '73054','69326','82568','11209','23978',
                          '47691','73947','48013','52335','96565',
                          '35978','78611','63241','74181','78713',
                          '91373','10980','41554','88502')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


