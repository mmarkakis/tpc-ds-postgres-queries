
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '63274','49350','78654','67739','65202','86308',
                          '59649','45767','60691','25226','47673',
                          '55733','99268','14123','83375','61753',
                          '61625','20554','97062','57259','10761',
                          '13733','26926','88540','11054','75843',
                          '31850','56343','62514','62422','17067',
                          '69019','32449','41720','63116','64524',
                          '87102','50283','54458','77108','56938',
                          '32234','85340','91161','65810','25885',
                          '90769','64908','71371','86858','99689',
                          '20319','49512','35183','14164','66042',
                          '82633','43019','60570','79253','22603',
                          '67506','47004','72763','75222','32438',
                          '48747','26391','45330','18920','39902',
                          '46947','92790','43148','36774','42231',
                          '57366','22333','45760','19527','31829',
                          '43603','88620','79081','30431','38315',
                          '38020','45501','43754','20204','73605',
                          '78707','87900','76088','62333','20958',
                          '33482','93977','92911','12264','25170',
                          '16672','32818','70771','83776','90449',
                          '98072','23103','85700','22822','17541',
                          '11581','38726','21759','13465','57108',
                          '40518','38848','21026','98186','54758',
                          '26859','18113','12277','35880','54347',
                          '11227','17145','82401','91183','41044',
                          '82072','88364','43338','81006','50771',
                          '31411','97402','68228','32529','83322',
                          '29888','15198','79227','15960','58574',
                          '59090','59558','66278','11675','11426',
                          '55129','74492','23107','72478','25391',
                          '27460','25753','46167','42084','75955',
                          '61406','79426','29819','29606','58104',
                          '31937','99626','15776','54409','54230',
                          '22065','18130','39726','49371','49880',
                          '69329','83985','27215','64627','83006',
                          '37872','29652','70807','94403','78854',
                          '17950','61393','58251','32971','73849',
                          '49409','43223','63191','87329','40587',
                          '12912','93879','97507','22631','28973',
                          '87848','35153','90319','60656','93261',
                          '71240','48556','52019','55164','45135',
                          '12370','80404','22314','83263','22966',
                          '89585','90872','20968','59656','90903',
                          '64047','59124','85041','93010','36524',
                          '91298','78663','19956','70976','77963',
                          '17951','35983','54613','96658','53119',
                          '77693','54565','93726','61602','45983',
                          '51489','56574','70874','93250','14327',
                          '33756','13735','78363','39996','34072',
                          '79423','87684','51147','32537','10490',
                          '47176','56202','91363','83906','82180',
                          '23917','27146','51985','39413','21288',
                          '59048','62938','41655','85836','25356',
                          '14985','79699','72076','54701','77946',
                          '82027','88934','26112','54602','67241',
                          '84138','46324','25221','28375','72650',
                          '24706','27090','80699','48967','38116',
                          '40554','99212','17787','63608','93273',
                          '41152','23759','69897','96292','14307',
                          '69463','19735','89727','76782','76851',
                          '27299','11400','37718','80533','59977',
                          '63917','79830','70731','40738','46441',
                          '15763','11131','57900','53196','12493',
                          '59360','54656','56311','10842','19082',
                          '96175','41668','15300','10821','54132',
                          '98373','89097','21340','22874','71465',
                          '43573','10962','83526','73201','86762',
                          '84591','94758','16484','66531','53343',
                          '37474','87422','50925','14791','18088',
                          '90716','41835','98091','74666','73596',
                          '51208','68971','81657','82702','20702',
                          '41065','85374','70143','72922','37829',
                          '19022','64208','63468','19475','57365',
                          '33455','64933','90600','89659','69981',
                          '86346','80312','81080','63993','73700',
                          '53065','75579','80225','41997','81398',
                          '91928','82418','16413','90224','12439',
                          '58849','76419','53289','79547','71842',
                          '97372','98800','99599','92280')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


