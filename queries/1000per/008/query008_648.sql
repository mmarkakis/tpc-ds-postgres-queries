
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '43815','75386','91396','40209','56176','97515',
                          '25023','21594','34559','10514','89884',
                          '77296','86784','53180','56124','98541',
                          '73584','90481','34343','16341','48594',
                          '57144','76625','26924','67489','28209',
                          '86992','84320','90195','41966','30028',
                          '96639','33749','58086','15082','25621',
                          '41864','36136','79799','95946','84739',
                          '84461','18483','44358','29962','32582',
                          '16640','64580','60254','92828','64616',
                          '91400','85338','74992','22471','23135',
                          '85837','31132','32042','46921','43881',
                          '67034','11241','65122','61253','83191',
                          '26108','69837','89568','91212','37868',
                          '83244','32558','53577','76115','73547',
                          '30663','63725','47646','24347','36570',
                          '26086','42339','46850','41587','36104',
                          '78458','61212','66017','72416','56557',
                          '40023','95547','55760','72123','76056',
                          '19385','89373','98151','32542','90508',
                          '49070','96757','53386','23989','96620',
                          '11324','74818','38454','32510','65014',
                          '84580','99979','62015','77137','20373',
                          '85833','45367','18102','10677','51798',
                          '31552','95687','44167','38582','64621',
                          '72376','31212','47964','47763','89716',
                          '22419','94067','12111','67011','25186',
                          '20177','88859','80478','91774','62882',
                          '23464','15162','27469','98307','29285',
                          '80260','13083','34807','35071','75544',
                          '74462','22709','90087','24998','50051',
                          '40293','14464','67073','92418','89587',
                          '19849','28393','99063','19321','93454',
                          '63231','98609','49201','81037','91136',
                          '77746','63175','34126','55483','62016',
                          '77218','16205','80665','81988','14795',
                          '78432','41956','29131','50821','27954',
                          '98063','15462','23376','21947','98458',
                          '34717','94332','69938','85481','62183',
                          '66638','88955','51422','43339','87182',
                          '98060','53873','55188','23615','53466',
                          '31680','31105','44321','82355','96202',
                          '12090','14703','50830','92137','24824',
                          '74827','88040','53215','31564','46766',
                          '22412','95606','23456','21626','13115',
                          '30692','56595','91441','45258','69529',
                          '31974','65920','41325','39972','17249',
                          '39388','23196','86015','73215','78011',
                          '60159','33313','50228','32560','25693',
                          '47802','95330','43781','80577','75541',
                          '79348','38310','96249','70825','61040',
                          '93372','52576','28378','51491','27550',
                          '49974','14054','30471','62039','37193',
                          '71606','53959','90847','84057','54788',
                          '57517','17406','58793','85453','25112',
                          '39604','82142','50034','38835','99214',
                          '74351','51039','10703','31300','60340',
                          '94712','77830','42432','31551','33621',
                          '28709','50616','20351','35834','89950',
                          '47234','94961','15910','29074','49371',
                          '71151','12455','46142','67038','80058',
                          '52108','31441','84940','95265','77820',
                          '87301','26534','39822','21627','99967',
                          '31467','82270','76890','46976','12811',
                          '44577','59823','51952','58769','15717',
                          '90522','38069','12106','58982','11472',
                          '24078','92868','72128','63377','45018',
                          '29543','96599','71521','56085','60206',
                          '69738','74263','44035','23219','85958',
                          '28801','36453','83791','84129','10698',
                          '33808','50260','30834','24084','61702',
                          '10531','36387','51528','66722','48928',
                          '59775','89597','65674','61635','28119',
                          '80625','94167','60522','86521','40281',
                          '51601','75250','36523','36895','14527',
                          '61580','26384','60112','71993','12716',
                          '83580','10761','58446','22677','35662',
                          '84554','29059','44598','60914','62668',
                          '57840','54953','29254','96412','62842',
                          '22285','60701','78964','94689')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


