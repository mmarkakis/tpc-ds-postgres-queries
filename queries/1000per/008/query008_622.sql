
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '31173','63620','64879','88692','30349','57209',
                          '12760','13794','62594','87154','19368',
                          '52288','88204','27165','40394','49331',
                          '99858','41002','75197','98445','11408',
                          '90710','45397','69240','91860','30631',
                          '96336','32711','83295','47514','99242',
                          '90714','93918','37935','17159','35394',
                          '44673','88849','58344','92152','15317',
                          '61109','47717','75806','25491','40004',
                          '68626','18624','54289','61211','61951',
                          '86885','34015','37742','93356','94090',
                          '61265','63153','53926','31544','77668',
                          '80392','48843','38869','70555','81090',
                          '47181','79196','59409','97229','19330',
                          '37164','21646','92069','71544','49750',
                          '40312','14882','25111','17696','71924',
                          '32069','21283','13716','50871','83967',
                          '73186','55136','95117','62406','10279',
                          '90605','67477','29493','86670','82759',
                          '76072','26209','61156','49214','31839',
                          '51149','70396','77689','29832','87832',
                          '87152','53357','53737','48241','87430',
                          '74703','73047','59726','86045','18760',
                          '88500','66655','80927','44404','10535',
                          '37782','95795','52938','72172','65148',
                          '94429','34132','67426','21195','12499',
                          '31809','15529','73837','14407','60517',
                          '93658','66850','62874','44416','95168',
                          '72452','22244','15808','13060','60565',
                          '55783','97370','24882','62580','98531',
                          '53245','81673','69436','44712','83980',
                          '76440','91020','74217','79999','88400',
                          '33217','40358','81861','76382','42980',
                          '18402','91144','76402','31656','21012',
                          '20264','44051','57015','62338','70212',
                          '28953','49325','17453','69742','94819',
                          '78698','87741','86582','32746','34144',
                          '96859','63718','26035','23360','70343',
                          '24681','28966','81282','59122','87709',
                          '13255','52971','68456','93411','87685',
                          '52463','18220','35076','56623','84614',
                          '85043','41760','45051','42201','19810',
                          '62207','99608','70045','77981','69075',
                          '22739','39172','68710','36158','45408',
                          '23753','13705','53688','96671','65118',
                          '64287','64928','91263','65133','26281',
                          '62559','94278','94995','35771','55876',
                          '39177','13102','72564','69809','28566',
                          '11245','54829','66085','77442','95760',
                          '81613','51151','66706','36147','47518',
                          '70485','93381','41397','12671','24570',
                          '29825','57928','94848','80061','67463',
                          '42745','35604','45774','50306','38881',
                          '16690','87754','43876','28842','80623',
                          '96485','76398','80093','81893','62637',
                          '94619','99646','82087','19160','70734',
                          '68050','27860','51509','45462','26486',
                          '59181','22518','37656','97480','50471',
                          '37231','96193','30652','74119','24455',
                          '25987','52000','63462','16376','94627',
                          '50826','88490','12057','66516','48621',
                          '65606','69578','69617','20442','37937',
                          '43858','47772','49801','71303','43830',
                          '66605','59041','64050','70612','29728',
                          '39006','46850','93778','71195','53104',
                          '69393','58749','50452','82230','79556',
                          '56152','93677','17920','13207','63755',
                          '24248','70264','49983','18832','87076',
                          '35210','43813','60430','75945','55572',
                          '50744','18895','40105','54551','90039',
                          '53147','47083','63064','72479','59490',
                          '60975','44192','34919','20809','78684',
                          '85424','16706','79077','51178','31604',
                          '85878','12408','13153','45353','79367',
                          '34153','58976','22387','74925','89339',
                          '85289','85756','57402','25556','22056',
                          '25154','10745','79257','14699','18612',
                          '27278','44111','53447','48385','80309',
                          '84548','13857','34906','85963','78774',
                          '24608','38183','96003','39726')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


