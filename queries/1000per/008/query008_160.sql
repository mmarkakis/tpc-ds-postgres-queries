
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '19467','51682','98527','33189','91108','67296',
                          '25527','63975','28833','64044','90230',
                          '45780','74929','99037','33209','68287',
                          '61143','30226','50045','76219','58773',
                          '18197','55208','73126','12313','79471',
                          '65692','47037','80681','61250','48341',
                          '25541','81669','88148','92637','61732',
                          '26847','28925','68983','63026','97796',
                          '91061','61132','22634','24914','91526',
                          '56046','39690','24709','99878','67119',
                          '50575','15799','31688','85154','46767',
                          '63906','52610','25626','41292','83453',
                          '47723','14278','63374','64159','94180',
                          '19249','64628','54926','72981','47236',
                          '93454','86675','31151','28987','64157',
                          '19836','15732','33731','71533','42328',
                          '43321','92728','17540','50416','38638',
                          '36818','47828','16840','49116','98774',
                          '73185','57104','89045','86508','39132',
                          '42633','89955','81608','53350','36605',
                          '44641','78175','37104','81292','72340',
                          '21115','11971','45326','97065','68187',
                          '37377','86108','88277','25936','42241',
                          '38546','66383','98760','93833','18252',
                          '97397','15013','12363','35414','98385',
                          '65841','73210','19937','70497','33551',
                          '73813','37598','18547','43014','90885',
                          '62315','36916','94029','32506','76531',
                          '39735','16714','85260','77466','54834',
                          '48432','78154','84098','43768','61633',
                          '55558','48994','62151','73349','91458',
                          '45836','47705','57300','22805','78329',
                          '61837','65481','86566','34551','65654',
                          '48899','32435','46092','29644','15382',
                          '97330','57686','32228','19866','96938',
                          '10544','96391','23062','38843','45238',
                          '29015','25548','57002','59166','69126',
                          '20602','66247','34645','85292','86841',
                          '53869','41407','44351','91583','72893',
                          '27934','23963','85132','88851','80001',
                          '81634','58611','64914','18561','95274',
                          '81463','45698','50924','67284','77001',
                          '86237','83845','17635','85875','40620',
                          '12483','83079','47267','99095','68875',
                          '93658','15847','98918','21960','67013',
                          '52980','70805','58638','38556','57648',
                          '84136','43397','74603','83067','87089',
                          '94507','49956','77690','26748','54751',
                          '18034','33056','84273','56080','90029',
                          '46261','48896','11177','91010','62551',
                          '20727','96382','96429','73933','52255',
                          '46335','97249','79998','56732','85277',
                          '25340','92917','61075','45142','93797',
                          '42712','82309','36728','89371','19377',
                          '87967','23138','34525','28046','16391',
                          '33274','43212','62009','50088','48704',
                          '74595','19543','81644','86897','93834',
                          '79440','98508','54424','40485','90976',
                          '79782','37443','21071','16729','42688',
                          '94353','21865','17428','82782','52893',
                          '70590','42654','51157','15672','96782',
                          '90587','69060','97814','74288','13767',
                          '60886','77924','59191','50083','33060',
                          '40895','56443','61680','28713','79594',
                          '63886','94502','12598','23977','10631',
                          '88263','98956','35813','30411','85425',
                          '51250','42915','90871','66451','98943',
                          '66731','99824','55274','68269','24079',
                          '64738','54402','39797','97512','95664',
                          '60213','41349','49215','49639','21148',
                          '23508','69736','18818','19439','16183',
                          '58456','35516','55621','72857','90204',
                          '59863','78535','19181','18140','98397',
                          '22578','99250','23877','19869','58675',
                          '51580','91345','46990','16683','55840',
                          '82220','14237','50653','98977','22239',
                          '42235','68598','90062','71322','77429',
                          '98335','25917','70631','59095','54343',
                          '28784','61361','16424','32364','31873',
                          '37301','89284','95003','38223')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


