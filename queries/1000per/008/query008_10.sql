
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '11967','50753','31853','43636','46408','66484',
                          '37430','48281','62224','34846','48043',
                          '26919','12065','55469','11906','18006',
                          '92437','24612','30362','32936','95274',
                          '50736','34495','80319','44752','75561',
                          '63231','49156','38515','63908','78615',
                          '33750','60063','97996','90127','17852',
                          '57464','98312','74373','68290','66917',
                          '72624','76548','82154','85079','46516',
                          '47522','26999','53513','35459','84405',
                          '63167','18143','39322','76550','46069',
                          '33408','91019','23449','12860','86536',
                          '81077','42627','99133','85432','91674',
                          '77451','88747','50803','59869','31522',
                          '62679','75115','31269','83525','86629',
                          '31037','42665','53764','18195','49313',
                          '28547','21511','82761','50777','56598',
                          '12359','55580','67592','30610','13470',
                          '63045','13405','37336','54820','64372',
                          '73890','38878','28618','97292','46205',
                          '65805','10979','16303','83872','28594',
                          '26145','19274','29759','21339','93794',
                          '45477','28775','59342','49865','20278',
                          '35228','89935','92889','22772','77651',
                          '13202','87176','24350','39623','80624',
                          '70845','47861','86450','28792','96217',
                          '98717','65068','86257','25779','82124',
                          '82906','74677','70070','48100','67797',
                          '98511','94635','90134','31208','18540',
                          '97815','15765','26521','25293','92693',
                          '53786','39150','76795','20618','16735',
                          '19622','49120','61595','58494','35023',
                          '33998','32924','89401','79885','47244',
                          '22429','67681','86625','95482','59767',
                          '68594','57018','18199','31251','63871',
                          '59260','55432','95019','22803','88253',
                          '80770','43946','95018','88406','57026',
                          '61070','26416','37251','64752','41981',
                          '12991','26704','24657','71934','48130',
                          '23468','43321','23679','98355','59008',
                          '43078','98813','61896','30615','60213',
                          '53040','23572','20774','95908','62954',
                          '31539','77179','24543','14686','98543',
                          '14147','70075','49413','78151','81618',
                          '30697','84301','58150','64387','19294',
                          '22082','55714','45284','61193','35152',
                          '95577','87688','69811','83068','36905',
                          '86380','51003','72693','60678','23032',
                          '22996','59053','60228','34079','92347',
                          '12358','89458','22241','51682','55456',
                          '67687','96315','10740','45474','14001',
                          '26668','84537','46376','89269','11256',
                          '51663','38443','15106','68930','68798',
                          '86947','59785','19503','78618','88503',
                          '75687','74806','95521','27429','52553',
                          '41829','40369','51321','47795','24521',
                          '22271','21270','79750','31963','94106',
                          '69201','13197','54477','80427','68168',
                          '94117','81367','45893','45201','31844',
                          '15487','79672','73290','53189','67829',
                          '86025','41951','69233','23962','19780',
                          '85914','63408','98886','20501','94856',
                          '88690','12783','48347','77381','79848',
                          '55102','11536','86443','83354','21253',
                          '50186','99680','11044','42022','24980',
                          '88030','46443','12268','46064','69805',
                          '95238','13917','77547','50608','95828',
                          '58044','83527','43111','78552','62875',
                          '11993','10213','24101','97340','53937',
                          '82480','99190','71296','74625','82818',
                          '39527','30470','85289','93308','12061',
                          '91041','48585','13122','42083','86399',
                          '92650','21264','78111','96048','93186',
                          '39936','53819','84188','28654','68791',
                          '71056','33167','23810','34490','33568',
                          '79556','56181','55091','23057','11103',
                          '18202','30207','52126','60336','46879',
                          '94484','44334','70449','30552','15453',
                          '89228','10797','32604','15528','69884',
                          '52695','37452','25699','38813')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


