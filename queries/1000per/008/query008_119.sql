
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '70467','99018','32208','65114','46125','80554',
                          '16615','59450','61034','98229','35991',
                          '14690','29326','53702','43053','27330',
                          '26890','81902','25797','22447','99942',
                          '10900','59055','32954','85621','53578',
                          '27745','45100','74429','17336','43781',
                          '92686','85586','44042','78594','60942',
                          '69213','45520','23848','93628','12451',
                          '69978','21589','15069','98431','70130',
                          '17474','38644','34298','80344','43757',
                          '88141','46695','97536','39001','69189',
                          '31416','66881','25959','15070','74972',
                          '91051','40907','24813','73992','87339',
                          '90000','98109','62030','32422','26662',
                          '94730','64862','83941','78781','54344',
                          '10794','45983','20619','88217','87991',
                          '97123','92187','51380','95809','96652',
                          '77487','12685','44307','73944','89597',
                          '86602','88075','73402','56577','32891',
                          '18691','98236','88625','79614','29921',
                          '82796','29416','15290','47479','27933',
                          '38829','12179','47665','14202','81589',
                          '14581','68225','82023','79356','35580',
                          '91236','64505','91754','75882','67921',
                          '50015','71678','43910','80489','53271',
                          '74062','32289','96278','70432','96762',
                          '55366','56669','35019','97715','53914',
                          '14722','37546','47771','17437','35760',
                          '33056','47637','38645','66205','97933',
                          '63475','87207','46002','20078','43266',
                          '72800','18950','11391','96871','18960',
                          '51991','12361','38899','24942','38548',
                          '56014','70397','66608','62208','99279',
                          '97796','51440','77479','52035','94629',
                          '94012','98640','94116','89174','28956',
                          '44620','81387','69147','23473','21877',
                          '78661','62763','87746','47751','11037',
                          '97006','50768','86503','63750','41527',
                          '77132','97204','33722','97847','54565',
                          '60799','59808','91627','32563','38537',
                          '35117','31687','66952','70338','49058',
                          '65842','32245','80197','11788','25809',
                          '74770','82601','20481','67709','62228',
                          '57142','97545','29249','52251','38847',
                          '86279','64386','13290','54916','56467',
                          '81887','40378','18054','36470','95264',
                          '78356','75550','59736','38880','42268',
                          '56683','57250','69423','58916','25103',
                          '15602','69992','62470','41536','72537',
                          '56352','67078','40496','87951','95000',
                          '41044','74575','88355','52511','30792',
                          '14445','47289','17634','48643','52093',
                          '44416','92655','49411','37413','89420',
                          '98516','69564','99834','34891','22412',
                          '99235','81509','71173','37049','43737',
                          '54616','25628','48184','75162','71670',
                          '21898','21374','68906','28147','15097',
                          '56468','23038','41668','31015','19553',
                          '64607','99470','86723','60600','33188',
                          '52873','19573','25800','95146','63099',
                          '33525','21370','25580','10059','25744',
                          '73576','55787','41041','55761','57713',
                          '52179','86760','11989','59168','39420',
                          '58931','44491','55238','28166','42793',
                          '19775','94237','28968','28797','60493',
                          '36391','61808','98385','28402','60753',
                          '64741','38232','52917','43098','39301',
                          '49904','65387','75180','26107','23840',
                          '53480','91516','87914','51803','61171',
                          '36444','81823','88965','75717','42021',
                          '71293','27453','67608','49704','71339',
                          '26936','43721','68904','94206','13219',
                          '74640','99593','49775','71586','78052',
                          '83586','27965','63374','95215','43713',
                          '12311','93889','26477','80078','28010',
                          '45217','64171','50358','91305','22568',
                          '97676','86402','99009','21167','72162',
                          '53400','36771','20250','11474','69354',
                          '20789','13527','50413','15729','22000',
                          '11728','72474','33221','73228')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


