
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '91167','82564','48540','84512','96253','96481',
                          '78875','50684','75916','48693','93227',
                          '15989','67128','30851','32422','51438',
                          '50885','10929','68316','80125','59396',
                          '79882','26798','10754','80747','83373',
                          '47106','15664','86242','24501','49587',
                          '35063','60211','85734','75046','11252',
                          '84158','60674','10591','10113','36207',
                          '16624','94156','16271','64831','48032',
                          '90018','44479','65351','81564','74570',
                          '38689','32211','34012','11096','71913',
                          '86791','98536','95191','88267','62006',
                          '10295','79200','53315','96106','62914',
                          '45583','61861','82931','50865','32091',
                          '59827','61710','28549','71614','24705',
                          '21023','33622','29523','15823','36708',
                          '76167','91969','73107','72773','51236',
                          '56459','52531','77236','98894','35397',
                          '56155','86031','37491','66681','27083',
                          '34788','29206','60183','61643','90636',
                          '71653','70767','47741','74444','18944',
                          '17001','51048','83414','20288','18116',
                          '20166','79092','30660','65328','32617',
                          '11694','85738','43695','19739','15665',
                          '53595','72007','37390','23647','56208',
                          '30920','35954','65056','52003','46625',
                          '79454','29088','24120','65115','46277',
                          '41832','66418','50197','46244','32111',
                          '86376','95853','46254','33256','63467',
                          '20880','87058','94130','45642','60136',
                          '58145','71130','38221','38402','61847',
                          '19091','40685','75212','69689','19444',
                          '14754','32951','57299','67394','60191',
                          '44514','99153','52958','78821','92991',
                          '59797','12160','84618','71225','52599',
                          '50637','11355','68077','24707','27863',
                          '45264','78228','52972','19440','30237',
                          '52142','12302','46198','60485','59668',
                          '59199','29377','65257','58250','67323',
                          '60903','74246','41500','23637','60552',
                          '96568','70104','51252','55197','92540',
                          '47088','27417','67929','63944','78890',
                          '58974','68867','80440','85012','50314',
                          '84866','81868','96206','52137','31393',
                          '90514','70642','72180','49446','24911',
                          '21141','68542','85953','73778','21323',
                          '49272','63175','37195','38845','86015',
                          '77714','80919','59745','42531','42890',
                          '49772','96751','34450','90368','10610',
                          '45202','79320','65709','60698','88527',
                          '49204','10997','27242','91303','10404',
                          '58566','75442','21894','11934','45964',
                          '66839','69894','85839','94841','50431',
                          '13502','19804','79999','35896','41984',
                          '73464','76773','72388','50049','32167',
                          '70582','83693','73002','85820','61039',
                          '34497','50910','13736','15411','74051',
                          '28785','79739','60588','66042','62336',
                          '40576','89330','32632','92440','88451',
                          '12361','25408','71796','97653','95174',
                          '40017','19439','67691','43201','43644',
                          '99195','39709','70074','93991','59055',
                          '33404','78582','93653','49866','35731',
                          '82728','22787','67794','23175','72989',
                          '99286','75562','57149','18094','28770',
                          '24617','80921','77582','46730','99104',
                          '18541','35507','11112','93579','50504',
                          '29365','23974','19451','88904','19120',
                          '92107','88937','91738','65264','15911',
                          '34397','26948','69034','52005','60533',
                          '28037','63460','92465','40418','38926',
                          '45643','68517','99741','31122','37003',
                          '63297','92048','50745','89296','56523',
                          '50264','33519','86489','76168','54131',
                          '71613','68292','73770','44044','22994',
                          '79748','69065','90919','57208','98450',
                          '77072','86512','52356','60825','58146',
                          '57143','29207','49612','89286','89804',
                          '23666','17220','50665','19830','60907',
                          '95040','41539','73537','88463')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


