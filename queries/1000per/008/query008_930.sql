
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '40725','78316','43684','58666','14769','27507',
                          '58404','93427','92727','50816','73131',
                          '36012','42775','55647','23307','71770',
                          '98149','21137','42153','84810','79133',
                          '40765','53758','88666','28938','46836',
                          '77674','39526','44210','17497','65002',
                          '11947','93196','48320','24649','50156',
                          '85214','86449','66334','65119','78632',
                          '14605','15788','16161','80759','59392',
                          '59574','74429','69944','46845','76649',
                          '41978','50031','50547','81159','36142',
                          '89506','22026','39622','82249','18232',
                          '51237','37490','48161','59945','38810',
                          '91762','83891','49099','52113','45079',
                          '28054','92062','52433','11357','25480',
                          '93889','10994','88050','48332','79177',
                          '83766','41020','96833','54691','92323',
                          '61534','60691','86795','86499','79366',
                          '66190','98425','89216','35343','67422',
                          '48147','66264','58083','11940','27284',
                          '49295','39181','34629','28413','11015',
                          '61217','50643','30221','54898','66114',
                          '95655','14225','60833','55501','10099',
                          '17127','39170','95569','68492','86266',
                          '56694','22152','10107','45450','74039',
                          '96316','14954','61717','72855','49066',
                          '93485','62424','93875','71802','66883',
                          '38570','56686','21922','78277','42198',
                          '96430','55498','61450','17960','18806',
                          '58000','71115','32873','50071','85767',
                          '87037','33514','19818','98466','88059',
                          '18150','39708','28448','74223','69850',
                          '48893','32676','34865','79114','86180',
                          '46951','69266','39010','64229','22723',
                          '33016','10189','68960','62201','37919',
                          '59996','88810','52042','85537','32671',
                          '95519','61611','26715','74522','11656',
                          '69089','25925','26514','32892','48083',
                          '24709','86343','73190','62654','53800',
                          '97120','68899','82799','62245','87825',
                          '42444','68571','78348','54361','15549',
                          '23535','11633','60143','36156','83014',
                          '26804','83291','99642','58272','72549',
                          '19953','33356','74118','68857','92052',
                          '27275','56068','94270','72668','97399',
                          '98876','78731','95065','85891','20658',
                          '34887','43942','81461','26063','94090',
                          '33935','61690','62397','92918','57819',
                          '12990','46857','31755','37316','85946',
                          '33205','68336','48640','64263','41807',
                          '18443','16654','91131','85136','54630',
                          '15284','83795','11570','75786','88337',
                          '26938','90840','17115','30423','75737',
                          '76600','43986','66603','38763','11395',
                          '94803','31993','33727','36256','85988',
                          '26416','50578','87136','58803','86492',
                          '81729','17840','95505','81862','96069',
                          '79728','40046','15893','49130','44157',
                          '47967','88156','30890','15781','28806',
                          '65359','39798','57695','25042','40805',
                          '32638','52486','31485','39515','68612',
                          '29223','41884','90320','44183','84483',
                          '51182','43922','47337','75231','18136',
                          '97630','92315','54976','19089','72387',
                          '38931','66849','89597','88396','34221',
                          '65007','24237','31618','25292','30281',
                          '71602','19756','29185','76784','96355',
                          '24783','47942','22525','90942','63405',
                          '87929','84741','99239','65089','81086',
                          '71256','61171','91085','98333','58499',
                          '32437','99004','80690','18842','38457',
                          '93625','46854','69125','11595','68303',
                          '90641','31521','33847','97203','34519',
                          '63570','31021','58561','45939','58302',
                          '86824','41633','41299','80798','59085',
                          '59991','65047','94645','25696','60225',
                          '74279','58599','38806','57203','72757',
                          '69137','45551','84307','45834','79899',
                          '59073','26150','86728','81636','35281',
                          '83541','38805','15869','28656')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


