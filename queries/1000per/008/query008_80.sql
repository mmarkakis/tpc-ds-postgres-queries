
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '99113','74250','49426','85591','86318','14443',
                          '86299','25992','25928','80393','45134',
                          '18856','31367','54580','70260','78309',
                          '44886','96899','61581','59303','12317',
                          '49705','46948','73317','92967','53202',
                          '88171','35503','32789','97116','42369',
                          '31004','23747','82124','49533','31077',
                          '18021','68756','61054','71016','64756',
                          '96562','52763','92076','25278','87897',
                          '57085','87966','78409','77821','92990',
                          '37898','86507','25583','29818','25406',
                          '66456','29095','76867','50147','18032',
                          '16088','13556','19783','31976','40625',
                          '41713','79908','97067','28417','12516',
                          '27737','43010','49139','66846','45808',
                          '89796','16184','83467','63387','83322',
                          '53173','99778','70426','76890','16259',
                          '44716','88157','47054','46423','47517',
                          '49997','29304','62126','48856','29349',
                          '69547','31129','58504','97072','71304',
                          '85715','46023','72547','99998','12707',
                          '84271','30659','87990','46755','73832',
                          '22754','26545','63132','37949','49853',
                          '97360','95815','94005','59513','84503',
                          '23651','30645','14100','41598','47822',
                          '17519','46665','59962','56583','33028',
                          '39425','99626','14610','60654','71538',
                          '24828','94830','45979','67770','12822',
                          '74011','80736','51312','28947','97348',
                          '50124','66828','26079','47033','44775',
                          '74200','53916','46621','95826','51020',
                          '50321','65834','68395','39784','26075',
                          '13676','84980','33864','51136','30544',
                          '81983','20450','31849','47602','12675',
                          '28419','77626','14666','75350','58522',
                          '32675','25370','87996','79390','61320',
                          '86371','42128','76779','12261','15538',
                          '34308','27562','76411','41872','81074',
                          '12561','49279','48416','97253','17113',
                          '12909','20457','50632','58184','99398',
                          '52679','28230','95312','15541','48184',
                          '63671','97706','88471','91122','74275',
                          '10672','78599','56223','13226','37561',
                          '64446','79216','67518','70296','90763',
                          '37921','35089','78585','97870','22760',
                          '82025','27508','79551','57406','47450',
                          '50760','39031','90659','25808','36927',
                          '10163','20783','19674','98410','66001',
                          '59652','77560','87595','31639','87686',
                          '90918','27943','25096','94560','41135',
                          '80208','85941','18496','42278','10526',
                          '39003','85770','42789','54968','45361',
                          '39110','40985','25014','42277','40659',
                          '65839','64658','10883','24683','43931',
                          '93087','14930','82177','86340','49718',
                          '86798','17280','73352','73629','30951',
                          '11477','36326','35572','96405','87216',
                          '56390','90324','70097','46354','51566',
                          '62296','77886','41991','28604','69908',
                          '27242','82632','77538','86946','39251',
                          '66754','49496','53825','83703','57408',
                          '69621','10886','96039','75046','92226',
                          '66802','75547','35039','69691','90136',
                          '74101','78607','73621','15266','52501',
                          '23607','24925','31973','84675','41093',
                          '42757','80517','68555','48131','74785',
                          '43617','65357','29620','68820','66652',
                          '92128','97651','26095','80228','91358',
                          '16880','87423','68379','55253','97730',
                          '60532','84900','56822','51254','31642',
                          '34965','88422','37174','80443','26370',
                          '95606','11568','27597','85220','20103',
                          '91366','91556','12744','56811','83338',
                          '23339','68725','29209','28653','27368',
                          '94040','43928','83119','18851','89407',
                          '36985','20859','96212','46812','44236',
                          '98720','11693','13181','83330','77351',
                          '13629','64939','27397','71426','84209',
                          '28478','15268','93845','15284','64819',
                          '80268','24508','44903','83976')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


