
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '11008','84978','21421','81627','91111','33564',
                          '28727','95520','69744','13357','43568',
                          '48876','86021','50020','71586','77746',
                          '33050','84579','57854','16061','87254',
                          '62358','12664','35965','61195','46404',
                          '62772','72393','21822','15248','23479',
                          '89365','48120','65928','44652','22517',
                          '83270','29098','72236','38791','88628',
                          '61805','72557','68584','94330','63448',
                          '57704','90495','57360','78925','91863',
                          '37552','86279','58363','56740','16346',
                          '28305','52091','93692','97731','15961',
                          '42493','86163','74400','88782','86887',
                          '30693','43989','35435','35101','88892',
                          '66710','51399','68421','86643','27113',
                          '33721','55534','93522','22706','82697',
                          '86858','68677','51348','88515','45874',
                          '47358','51384','43135','46131','39277',
                          '29093','40005','18928','84603','71918',
                          '95925','90894','64827','25169','42323',
                          '89511','82760','32811','93256','18347',
                          '69163','21518','52982','71092','76842',
                          '95459','34887','17830','97431','18961',
                          '48928','66109','31917','68776','93941',
                          '77983','37769','94911','25975','27126',
                          '31487','77592','42292','81667','48168',
                          '15151','86432','13096','67468','56391',
                          '98735','84043','24247','45952','90317',
                          '81964','21026','49855','93433','84392',
                          '65730','46985','66466','41203','84347',
                          '99293','99446','97386','23889','34016',
                          '51606','45064','72412','89498','76411',
                          '45950','54905','13289','16023','42733',
                          '80130','12993','76532','95589','38002',
                          '34933','70442','25386','90164','11658',
                          '49748','70757','95625','25686','87908',
                          '24453','94124','43602','98638','90341',
                          '72683','38486','77428','96780','26514',
                          '95301','81268','30947','54341','47069',
                          '54212','50131','53943','47153','70131',
                          '26674','43004','80338','12791','77211',
                          '11459','58860','54051','52434','67043',
                          '20952','63388','12253','64579','41528',
                          '14256','47004','83189','45124','56087',
                          '70669','34383','92652','10739','69106',
                          '23817','69018','76932','54790','97440',
                          '99643','83406','77005','18759','48367',
                          '98325','90513','31345','82356','64413',
                          '34507','22635','39554','45404','97033',
                          '63196','11671','27920','94504','24359',
                          '62350','93384','45805','12097','29785',
                          '17737','20068','37752','73980','84612',
                          '36794','26852','15505','81837','33450',
                          '23459','95221','33467','14467','89439',
                          '42606','17766','24877','23496','37821',
                          '56563','92648','90247','66184','13099',
                          '68549','69774','82657','59226','95038',
                          '37784','84638','88133','76954','68845',
                          '63148','98772','40654','64620','60257',
                          '82649','13491','84720','33226','10093',
                          '43972','64237','96360','22200','91573',
                          '32342','47466','76005','26169','51962',
                          '63768','24066','35338','61913','94864',
                          '94896','10111','63392','45973','85643',
                          '33504','60923','10724','67012','65782',
                          '40774','17097','85495','65305','26844',
                          '62594','11948','67075','97929','92813',
                          '59059','66381','33347','46389','21000',
                          '38315','19095','50966','38183','58013',
                          '60219','44526','47156','22767','19764',
                          '73688','54947','26883','53734','73103',
                          '22213','32907','33835','60689','34872',
                          '45790','20769','59346','63020','85923',
                          '11701','66205','79946','54298','38702',
                          '54570','56895','51428','86853','79248',
                          '29754','50515','34724','15575','29316',
                          '84863','36483','60739','86918','62237',
                          '89681','17129','34447','20366','73112',
                          '23154','44860','85095','40920','85407',
                          '86645','54897','27349','10152')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


