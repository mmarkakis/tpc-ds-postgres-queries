
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '96321','12196','26409','74136','79528','23560',
                          '44123','81713','25303','29031','64885',
                          '60540','79102','12207','35088','48155',
                          '91260','84017','49906','15450','91719',
                          '13169','41375','37004','44428','77492',
                          '41577','25257','76332','80873','99617',
                          '61630','81940','48647','71792','56303',
                          '39153','18165','36204','26833','43312',
                          '99697','79230','92178','41497','38485',
                          '75240','82479','19621','38602','38763',
                          '61242','65797','77509','33814','58192',
                          '58739','64594','82318','66650','35255',
                          '68521','37073','70957','44415','56045',
                          '32492','64086','20360','24390','21003',
                          '50481','80547','87213','30097','75007',
                          '55412','63149','88141','77415','48798',
                          '18079','99570','59220','66971','23242',
                          '47275','38792','95626','18676','93049',
                          '54420','55669','85809','85170','84475',
                          '51154','54438','74508','58623','71804',
                          '63750','52726','48581','98215','89620',
                          '29453','26301','52653','31543','60867',
                          '18086','72237','30678','65654','20653',
                          '12979','42052','39251','81543','65356',
                          '34441','87462','44169','49869','41717',
                          '98124','65122','27978','89052','51335',
                          '41115','41048','46862','49077','72050',
                          '87648','94792','84740','17599','70159',
                          '38436','91168','57029','97061','65563',
                          '48039','52218','57139','50692','81107',
                          '62710','88485','66722','28109','43415',
                          '54257','30343','95053','14934','45701',
                          '97952','83833','87478','57800','32900',
                          '11798','87442','18307','94058','36149',
                          '52190','11946','91124','47884','24481',
                          '59692','41469','76005','11052','31732',
                          '98167','20713','98330','27154','29196',
                          '43107','36269','48623','28868','28199',
                          '36564','33690','58047','56637','18874',
                          '31575','89207','80302','79235','84003',
                          '59157','46498','68066','94148','11941',
                          '28459','47457','29433','65711','83508',
                          '61351','58527','12137','62471','29648',
                          '25431','15029','59074','94233','28291',
                          '87198','69579','66648','34009','12513',
                          '67218','83536','32920','52026','38607',
                          '83561','19659','75041','53634','45828',
                          '60280','72412','51672','44345','41238',
                          '63384','66714','93968','98121','83374',
                          '70833','69948','73306','68872','25557',
                          '99393','86985','70415','85768','87522',
                          '88872','49270','38358','69155','18356',
                          '82797','74768','45753','43873','93440',
                          '72737','30439','83145','27881','40846',
                          '37692','43351','17506','73495','58183',
                          '57888','46064','61764','96844','98836',
                          '99216','36096','64675','49383','46767',
                          '75653','44241','72191','52011','66677',
                          '12300','16579','78925','69388','82140',
                          '63930','34087','28133','62509','84109',
                          '51234','52886','78216','71636','86295',
                          '64629','95147','83256','37510','75665',
                          '86023','14627','59435','25694','45999',
                          '22955','61902','72299','18981','52769',
                          '81079','60126','53481','25515','35533',
                          '51133','93247','63730','75756','65959',
                          '20878','40822','41946','62024','14891',
                          '61644','27914','20525','68287','50295',
                          '88102','49747','69857','19132','62847',
                          '37647','94425','58057','44561','85770',
                          '49405','99343','85563','26624','27204',
                          '66339','69055','35097','25809','26171',
                          '63670','15912','67600','47559','68260',
                          '86119','68002','98513','99732','25964',
                          '28973','16730','68665','64907','93794',
                          '34439','47015','48201','71906','44509',
                          '27676','89486','27980','31424','93616',
                          '45046','88026','76874','17133','27814',
                          '43319','32496','66498','11356','51741',
                          '89538','39111','45197','99584')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


