
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '56919','80601','72774','90647','19271','65642',
                          '79460','32369','85227','14582','52052',
                          '39696','43863','94944','19246','67369',
                          '14888','58066','59548','41157','15025',
                          '39480','95643','57065','84808','20032',
                          '17594','60125','61590','41551','43817',
                          '90751','65887','27815','31089','64413',
                          '99318','30460','70719','37163','80540',
                          '44179','45871','64105','67082','64932',
                          '77478','58330','91004','37488','85970',
                          '72643','42256','67772','78221','50021',
                          '28594','24175','94721','45277','68578',
                          '96996','82352','61921','80639','68295',
                          '26218','35994','12597','63357','41089',
                          '12264','38496','76703','66925','76016',
                          '44061','71375','50299','14086','36121',
                          '95355','49746','81451','88820','45782',
                          '59728','14351','49447','54718','54419',
                          '65666','75048','22348','94767','85658',
                          '71971','37755','64510','24368','42989',
                          '35045','29971','46447','38925','70829',
                          '66751','46931','47770','71090','12972',
                          '71288','46037','66419','92259','98874',
                          '80498','81157','34451','39319','10167',
                          '74468','73583','53021','79748','46518',
                          '70775','75931','78771','24682','64507',
                          '22438','60602','19559','45989','63114',
                          '98081','32262','31835','21258','48910',
                          '85293','71477','47484','11384','50875',
                          '25296','85857','26249','58742','11228',
                          '42327','34465','16903','31657','26504',
                          '78236','38565','82951','53386','15394',
                          '68535','38984','56858','72244','25498',
                          '94631','52767','12133','12606','92355',
                          '74184','16510','61084','14473','48824',
                          '53262','21525','45259','43259','18139',
                          '10452','36486','23696','24649','24133',
                          '70359','85151','77249','11362','82492',
                          '46481','76470','85977','24206','55012',
                          '66193','82786','84158','61737','75098',
                          '69071','44922','41644','79633','36631',
                          '51374','95180','43233','28376','17275',
                          '67102','32011','22697','20228','95402',
                          '32127','27139','16227','94363','35464',
                          '34316','88421','38039','94282','93343',
                          '34580','39922','70210','13637','27776',
                          '51754','11442','84425','20630','11426',
                          '71302','84888','71995','56288','66733',
                          '14728','47682','43402','13436','49188',
                          '75037','40291','28119','38425','47331',
                          '73522','98985','22769','37495','14094',
                          '33487','79530','61693','27662','38292',
                          '81642','79547','99900','98421','96571',
                          '87063','75502','20614','36334','62263',
                          '19955','23400','52341','97380','57127',
                          '13803','70435','85712','59407','73052',
                          '14853','93077','24181','49660','16246',
                          '95669','77070','15022','85786','10599',
                          '29110','80035','38873','30511','15472',
                          '20684','87945','32626','35771','42538',
                          '97797','84375','71605','57106','20925',
                          '21707','57853','52399','99309','92042',
                          '42816','21270','61709','35388','61712',
                          '18185','12217','39043','83005','16228',
                          '20627','14063','90397','67893','12656',
                          '61736','18342','20389','61893','83356',
                          '85962','99831','85907','57582','74025',
                          '60860','30243','99814','69056','33385',
                          '70550','68496','16030','13739','19690',
                          '16130','18902','79396','40287','73363',
                          '28113','16378','10016','49003','35124',
                          '54626','49547','88855','25690','79151',
                          '67588','39371','70475','14955','86599',
                          '56198','76194','62167','41559','55275',
                          '29776','45360','92659','14816','22776',
                          '63490','60418','68401','78149','63010',
                          '16306','92351','42223','85271','23482',
                          '53864','29801','34230','62704','70966',
                          '98350','94719','76328','82524','41284',
                          '11075','70012','94768','78587')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


