
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '80318','92168','94293','59664','71086','86985',
                          '94004','12754','27391','58048','36150',
                          '52609','89635','84150','53844','90186',
                          '89071','88681','33690','17692','75300',
                          '84938','10347','19074','58381','79346',
                          '69026','69285','94289','82176','74935',
                          '90052','46991','73273','21389','64341',
                          '12313','15611','57265','13201','12318',
                          '81202','73597','66069','20265','19768',
                          '32312','97728','76606','51377','16066',
                          '39279','69454','31132','38972','83842',
                          '92752','46930','22431','34885','56271',
                          '20586','56634','86507','15832','43595',
                          '80424','29608','74718','32225','13061',
                          '97941','97127','22608','27306','84739',
                          '79460','68220','75879','16610','45333',
                          '96359','69883','74251','43857','94731',
                          '11165','23619','32569','10838','45504',
                          '61232','32220','33529','50180','51463',
                          '13278','89456','13579','78766','76805',
                          '93432','85916','34638','69545','83426',
                          '44962','60555','74226','87797','32388',
                          '63223','54494','34989','73892','61844',
                          '83168','39306','14958','60909','47984',
                          '43326','99366','76148','53145','82738',
                          '32633','10478','85081','49979','59777',
                          '34313','80253','56701','40106','80757',
                          '40153','37288','27220','94444','89290',
                          '55826','86977','48233','33070','18945',
                          '31049','83307','53420','89317','75025',
                          '45924','65089','57505','58551','17628',
                          '87650','71576','43017','55523','27779',
                          '66642','87024','90428','28861','73571',
                          '26438','89729','97670','23886','20334',
                          '98136','85758','81315','34251','14143',
                          '42435','14007','84896','69364','83741',
                          '94261','87576','69633','54836','60709',
                          '20436','10063','27513','48346','85593',
                          '75079','73244','20284','24550','24408',
                          '87906','24076','44373','64713','66833',
                          '74779','45265','56106','33712','67600',
                          '93643','71029','51625','82035','82672',
                          '85233','98704','82596','71121','54600',
                          '25138','98232','21718','54172','68104',
                          '85624','98489','62643','71480','91258',
                          '17062','97906','82133','64843','94828',
                          '68323','61666','40059','13060','87811',
                          '51484','95350','92025','54826','52558',
                          '74689','80633','32067','44807','30255',
                          '55769','93925','79165','35413','67058',
                          '37619','56808','97830','16052','10164',
                          '68223','19335','73798','15919','64349',
                          '36013','60990','27831','47011','58265',
                          '40494','81617','59828','86032','44464',
                          '59768','87090','43222','80676','79372',
                          '36929','35388','76162','47259','52915',
                          '66956','36362','88422','78448','89253',
                          '85988','59434','13311','77574','99209',
                          '13439','61127','78412','95027','51844',
                          '41805','33324','87619','32296','89268',
                          '20615','59627','46905','10959','49842',
                          '21406','24653','65330','62320','45161',
                          '15501','13905','87453','94166','33132',
                          '48720','20446','55787','52421','97226',
                          '57796','78133','30177','24080','50269',
                          '53265','37514','40125','89200','31931',
                          '23508','74195','11765','43303','84165',
                          '29304','37630','82575','36871','55688',
                          '21485','10303','18131','50042','51393',
                          '71101','56290','49043','76666','69219',
                          '46289','40352','97612','10995','61990',
                          '68984','11287','25579','93121','95950',
                          '96817','62306','58542','34756','20571',
                          '71393','77048','90892','42583','97781',
                          '87959','43653','45193','47873','15317',
                          '63477','55026','97417','89808','99022',
                          '53622','13593','81286','21933','76097',
                          '28641','23150','37752','49064','73987',
                          '77003','23010','61476','35307','48714',
                          '49509','66075','84960','73362')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


