
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '69342','69172','83146','26123','14906','73275',
                          '18594','49121','57408','78641','74529',
                          '54083','55288','98980','63538','24337',
                          '31854','44768','62883','47123','50677',
                          '67855','81452','70747','47329','19844',
                          '31746','44275','19299','58706','54767',
                          '35810','88061','80749','53183','64057',
                          '10257','35391','76423','79568','54689',
                          '58791','34807','99586','28207','98677',
                          '29674','89322','83223','95338','78350',
                          '61179','46395','96644','78517','82738',
                          '30057','63342','63082','13130','14215',
                          '47611','60163','58623','33362','76715',
                          '51485','86510','99012','31523','53458',
                          '93222','24734','10698','22027','60488',
                          '35041','11432','22110','42814','47905',
                          '46620','85912','70421','27164','25770',
                          '55207','82801','96059','69408','49712',
                          '40263','68998','31112','77633','96793',
                          '84809','75507','58496','86919','64040',
                          '67642','80537','50715','66156','72919',
                          '89356','84665','10207','78173','60008',
                          '74578','13775','74890','59041','14428',
                          '81443','70161','66008','48163','75619',
                          '72603','86575','65718','51273','63346',
                          '45278','54526','53527','41064','47174',
                          '20263','99620','37172','66319','80009',
                          '87035','30088','58397','24807','12103',
                          '27924','50982','66391','50177','22046',
                          '61639','15199','64702','81494','84144',
                          '81045','30845','72055','59013','81087',
                          '52977','62012','65775','11547','44591',
                          '57706','58602','46771','67107','45072',
                          '23941','18223','81032','36612','66463',
                          '98032','60921','79725','63758','70078',
                          '32465','50239','69230','40736','68339',
                          '56218','34278','27041','95255','67138',
                          '14180','61883','57571','26854','57476',
                          '22371','24192','20537','27058','10786',
                          '94584','23565','96287','36620','37929',
                          '41905','68915','97772','44987','74309',
                          '69925','25804','78549','42231','12314',
                          '44120','75928','47973','16316','61304',
                          '58098','27880','16107','79552','17829',
                          '36998','95870','89843','76388','94747',
                          '85676','96379','54157','58119','99688',
                          '36968','21656','26162','27474','50563',
                          '99221','61824','44372','42072','50385',
                          '42406','92620','63653','24461','99148',
                          '41910','33314','50417','99583','81645',
                          '31665','84047','17125','68481','20244',
                          '95266','51790','40170','23074','76175',
                          '47128','92236','54061','33333','93076',
                          '15687','38114','43660','57233','12131',
                          '48652','10323','32037','18596','11134',
                          '42129','52324','63678','53275','72183',
                          '14769','54506','93226','53295','80331',
                          '67327','81054','31413','86877','48845',
                          '26147','29454','13298','14610','51757',
                          '28027','50263','33440','91173','62266',
                          '86429','63089','58166','53510','45873',
                          '82966','32852','59655','42292','31366',
                          '61400','80071','89002','19663','30167',
                          '87481','14395','11795','32399','98621',
                          '86225','83137','68625','18449','86176',
                          '30428','15408','98336','32992','36278',
                          '54065','21981','20771','38963','20119',
                          '43901','59596','41289','18605','10214',
                          '47615','69125','72788','54623','75016',
                          '22922','86058','84405','20867','10231',
                          '76949','26269','58839','61800','77695',
                          '59864','90349','45022','89512','32096',
                          '77259','58730','19797','35540','53935',
                          '71591','69773','99372','14340','49996',
                          '80042','13819','10863','41355','33419',
                          '34509','38160','34152','11031','55409',
                          '92744','50438','38522','66051','36636',
                          '83051','29959','34043','11384','47097',
                          '46047','73034','32071','95018','66075',
                          '96905','67954','83667','68219')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


