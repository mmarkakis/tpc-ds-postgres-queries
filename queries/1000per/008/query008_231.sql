
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '54836','44318','28536','86140','88467','55784',
                          '96475','16547','61021','31576','19303',
                          '96154','14503','31697','26120','83514',
                          '25941','54485','10687','41693','21426',
                          '28469','56600','58028','41082','64448',
                          '42293','12119','30322','28590','65580',
                          '88858','48468','68105','95546','89051',
                          '75822','78469','23527','42900','76552',
                          '87449','94899','21204','34989','39994',
                          '37032','15404','92769','24402','12938',
                          '48591','14672','79041','50469','30652',
                          '72332','50244','30621','85761','11675',
                          '13972','81364','62512','67779','82970',
                          '87527','27550','55654','96677','94697',
                          '44171','76508','82466','51885','73357',
                          '67190','43522','24717','30974','64233',
                          '71047','17579','16882','89959','64193',
                          '20307','77107','15450','73808','60696',
                          '34196','19964','17710','14380','62319',
                          '81601','14962','48093','75275','80814',
                          '66479','81716','85467','99906','80050',
                          '31060','44853','97714','57014','17581',
                          '24921','98147','64943','95995','51820',
                          '87257','37771','54809','39806','13515',
                          '12051','78627','47924','10685','92827',
                          '11631','13099','13092','86515','12279',
                          '65228','49517','37839','76709','49670',
                          '41065','88715','27536','12586','25704',
                          '85484','76969','34908','57044','20436',
                          '10971','64001','71726','75166','51360',
                          '75577','49973','29578','43851','68998',
                          '56967','68085','60823','10462','78051',
                          '94584','82415','74972','14435','63916',
                          '73720','94165','69890','18414','48696',
                          '68139','68142','87772','83102','50422',
                          '13843','34439','15791','45749','45827',
                          '16253','91487','17829','41429','60423',
                          '27310','75219','99857','92823','40880',
                          '10118','31126','18990','92148','30649',
                          '99100','78549','66100','63266','57881',
                          '36793','62654','91309','11774','37982',
                          '40670','14800','45370','31529','66001',
                          '45411','74830','62416','25292','36171',
                          '25076','64699','99561','68691','64944',
                          '40717','89903','73693','57239','30844',
                          '97395','28396','71425','87509','21600',
                          '83597','64643','26501','60819','36283',
                          '69085','57785','56812','65356','19681',
                          '32465','92985','29316','48476','13985',
                          '55924','22376','89611','16313','75661',
                          '91579','59248','75416','88526','92096',
                          '16204','38336','95533','77681','57424',
                          '78678','59794','51539','30069','96307',
                          '76747','59761','66585','76197','50681',
                          '58140','53571','15551','60833','18901',
                          '94771','21006','98150','36412','82184',
                          '61342','63254','25739','64337','44660',
                          '84069','81045','59481','99929','86700',
                          '73003','25863','90826','27091','46649',
                          '69954','60045','83164','29451','82241',
                          '98112','13407','38091','14173','37804',
                          '83127','26529','55108','56760','80368',
                          '52552','27248','12678','32979','52571',
                          '28217','63609','72965','73336','78276',
                          '31990','71356','38476','95849','53355',
                          '95512','34305','72359','68245','66063',
                          '72167','93283','44747','88321','16419',
                          '37256','25348','90284','30673','48898',
                          '52039','30403','81819','35450','86213',
                          '81988','32244','71394','66677','69965',
                          '85280','17258','15830','52342','55271',
                          '22916','35461','63665','42272','42160',
                          '52299','35204','87863','73283','66460',
                          '24764','67903','27501','68925','23533',
                          '73796','41633','21314','67050','80914',
                          '51645','71903','78417','12719','80341',
                          '75269','88192','37694','41920','12812',
                          '19069','27606','29251','91012','12844',
                          '31671','97010','85690','57770','10986',
                          '66515','74778','58270','97852')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


