
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '35868','64041','96960','11815','73315','24341',
                          '62028','94158','11649','45088','73356',
                          '57932','42535','58933','86998','83920',
                          '71390','83071','91656','38063','31533',
                          '12174','69096','92670','17821','64394',
                          '12032','63034','64677','74643','71324',
                          '77083','52161','13331','90222','33361',
                          '97215','89502','39692','56145','78162',
                          '65396','61740','23605','61944','24235',
                          '43942','47843','61807','66810','12919',
                          '23663','99771','44237','83408','28831',
                          '90415','69111','91946','75279','70882',
                          '80692','93797','15011','86619','59313',
                          '72366','12261','80322','65917','78256',
                          '13318','53260','33041','10697','56861',
                          '92576','10524','19790','71503','51364',
                          '73569','33717','20040','18475','56839',
                          '86587','37121','35564','32194','50891',
                          '81477','38448','85231','84568','55896',
                          '72252','53045','96346','61688','38091',
                          '80337','74695','25110','41939','12552',
                          '62849','53025','54575','45041','81061',
                          '95287','42033','28217','72533','73412',
                          '73661','52671','93350','65280','34608',
                          '55445','66325','30650','43512','61252',
                          '31944','27379','83069','22160','49348',
                          '64092','26866','81241','14422','38534',
                          '48985','25212','16482','70614','13761',
                          '98286','39215','13267','52019','29685',
                          '75150','22697','98932','80354','98966',
                          '91522','92903','72778','78933','17980',
                          '84145','13777','73440','30857','48211',
                          '63268','94453','74122','73731','89546',
                          '64610','73604','30351','55127','63961',
                          '70218','89986','22252','16948','90946',
                          '82431','17588','32370','12195','49318',
                          '50909','78067','44040','61165','85282',
                          '83062','49161','87024','77563','48278',
                          '57124','55205','63457','26089','28687',
                          '65331','13393','45849','26509','84949',
                          '29186','37793','51843','38758','29473',
                          '43774','95272','95591','45548','10249',
                          '56732','12742','97106','37423','34511',
                          '27188','40964','73727','21807','72668',
                          '85695','70927','64940','11288','13925',
                          '38713','67490','15921','14537','56962',
                          '46640','66091','28242','94809','91325',
                          '37201','44662','22486','81951','94659',
                          '63821','50400','49939','20220','11855',
                          '60945','64170','32310','61907','88039',
                          '77236','35231','56508','54447','79055',
                          '15534','82351','38402','97649','28616',
                          '50861','90423','68022','58678','77238',
                          '80504','68575','74085','26714','46726',
                          '84123','10868','32733','60597','21817',
                          '80722','99100','91215','62902','73457',
                          '80635','90851','56560','55448','17945',
                          '60785','59586','45725','42346','83028',
                          '55055','24458','56337','31269','33538',
                          '93921','18127','93696','64278','53950',
                          '89019','18401','30052','81691','33728',
                          '61140','90521','51308','20853','82084',
                          '82423','50745','58013','59521','57510',
                          '28936','67666','60954','18712','32229',
                          '39218','87156','68028','84113','29653',
                          '41440','96481','91804','98224','24233',
                          '83652','30383','55842','15191','17173',
                          '96688','93167','48010','15510','89425',
                          '27848','89127','43857','65839','49747',
                          '99104','79333','56645','67704','95838',
                          '61232','11580','81116','67927','66281',
                          '99118','99805','41051','36107','55719',
                          '65040','69511','87875','72341','87695',
                          '54596','47156','89271','21652','58867',
                          '37238','64937','72528','31137','84286',
                          '65543','60415','19706','23968','88411',
                          '28832','49331','61791','18143','24031',
                          '88220','46523','28533','64013','41796',
                          '96661','65154','93596','92733','17006',
                          '62480','24162','85261','55337')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


