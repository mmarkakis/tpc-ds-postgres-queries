
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '68611','62227','26933','54593','60651','37594',
                          '45705','98885','21834','94923','32934',
                          '23498','24660','74701','84285','17964',
                          '91887','23370','89687','37838','14817',
                          '41919','58910','35166','96520','65683',
                          '35291','36423','12668','22849','22581',
                          '37767','97026','88244','72728','42951',
                          '30116','69875','43304','71711','23426',
                          '79193','87187','95486','98966','77806',
                          '58192','66086','81788','45083','68812',
                          '97148','72839','52814','11262','78840',
                          '19900','82926','32720','35488','22684',
                          '49530','50422','40040','14694','39345',
                          '30790','82002','97788','89111','97442',
                          '77449','37124','18070','30030','89190',
                          '49045','71472','14196','65531','24444',
                          '19872','20502','84982','89515','50743',
                          '71707','71431','37221','20132','59175',
                          '65295','61031','76170','78991','82382',
                          '37704','21361','72330','21934','88526',
                          '45145','61715','52981','25612','45285',
                          '77310','46852','89130','26037','48434',
                          '81647','18952','87335','71777','16824',
                          '65652','25792','22404','73523','61796',
                          '69382','84602','81116','42502','37542',
                          '53078','75836','87864','94250','82186',
                          '93696','97981','53151','60811','37749',
                          '10637','21796','93064','90363','32146',
                          '97952','96822','52634','62046','19451',
                          '36664','46327','66377','87237','64379',
                          '24131','11973','65566','86743','85280',
                          '47409','57595','15758','99339','38169',
                          '50219','19007','77485','27905','68643',
                          '17950','24218','73306','56494','12857',
                          '58131','88710','55961','73777','88415',
                          '92638','18322','16082','49291','71749',
                          '13644','22368','28941','67759','48772',
                          '48103','52358','47008','41156','26990',
                          '54772','52693','44214','62077','96750',
                          '11611','39591','53768','30109','44229',
                          '26298','36421','25072','70389','95253',
                          '39012','34386','86785','98743','35233',
                          '93509','78471','43500','81684','39042',
                          '95134','40966','28169','29304','68201',
                          '92079','56588','93243','70666','94034',
                          '23225','57510','77227','80197','55077',
                          '26379','50584','69129','75245','27943',
                          '51943','88189','98247','11345','79969',
                          '52539','94192','92229','64261','29356',
                          '16291','19400','92215','98357','86447',
                          '21195','30395','25351','13482','69116',
                          '41667','50728','65881','20191','26284',
                          '74117','90373','42706','28763','83075',
                          '42431','61578','69372','61027','85643',
                          '60016','65414','28793','86013','81577',
                          '26962','75024','16206','92997','16511',
                          '11521','59605','79365','96688','28729',
                          '77709','47799','40686','55978','93005',
                          '40376','89946','92142','42069','51557',
                          '33763','97100','96047','80755','94623',
                          '48884','53643','15825','59511','22523',
                          '73096','26141','78466','86916','18422',
                          '29845','34328','59508','37015','30348',
                          '87751','81928','62500','43327','27507',
                          '93322','53896','52798','44463','34439',
                          '66269','11820','86134','64603','84305',
                          '34568','43051','80600','18738','97380',
                          '94308','49201','95231','87654','66817',
                          '42418','58834','34705','29987','98365',
                          '22083','23361','96804','64488','52909',
                          '70654','92216','54495','17735','30777',
                          '37598','89038','56723','50045','46549',
                          '88419','90989','50963','54325','98802',
                          '64443','55582','72593','68005','18648',
                          '59804','38072','65653','32858','30463',
                          '84810','36646','57764','17810','34320',
                          '41674','54185','50673','59651','95609',
                          '61287','20817','29667','47121','33061',
                          '76110','35797','96935','93935','19690',
                          '14649','46687','40858','80061')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


