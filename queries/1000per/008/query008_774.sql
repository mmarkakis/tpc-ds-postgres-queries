
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '57993','86415','43430','94562','98109','21847',
                          '67041','96083','33120','26272','36836',
                          '28022','51323','60972','77767','21578',
                          '18969','74282','81759','27263','63438',
                          '59795','45232','71486','45905','57217',
                          '48242','39380','54997','49982','12137',
                          '99008','80462','20949','20802','23181',
                          '79612','54908','50202','94709','88399',
                          '32485','74624','99145','49976','66189',
                          '50519','71246','51325','35533','43684',
                          '90090','46695','74730','88130','61195',
                          '93847','26456','48731','11555','49343',
                          '41052','35407','80031','47451','36266',
                          '38226','94067','90366','66385','50515',
                          '22055','28250','82029','12485','63240',
                          '20331','91727','86792','86350','34507',
                          '40298','76308','28209','46562','82112',
                          '67822','81521','29749','75306','79126',
                          '68520','46684','95289','63099','36100',
                          '73281','27694','33054','77752','86434',
                          '95238','39444','85498','49388','28745',
                          '68530','79135','53373','72284','49308',
                          '32506','87067','59349','25415','83938',
                          '32488','78004','51833','27770','24262',
                          '77964','51129','47484','68821','58267',
                          '35096','17863','93366','77660','26064',
                          '49466','72075','86741','80592','88583',
                          '63248','26240','65930','98715','38675',
                          '87574','31023','44787','83075','69297',
                          '24581','62879','41893','31882','59575',
                          '85516','94742','73080','35926','19945',
                          '46481','95066','84036','48942','13811',
                          '15162','25420','22269','53827','21788',
                          '39414','98064','46601','98321','33132',
                          '37522','32009','50145','25253','23087',
                          '24184','13574','79931','72728','59102',
                          '30374','38634','94935','71390','42308',
                          '52847','41841','88358','80506','32388',
                          '67070','97585','30381','41601','84660',
                          '57740','40882','11807','60539','39634',
                          '54898','66304','57135','46716','75834',
                          '84080','42652','70562','46972','87554',
                          '15537','90619','56853','56232','45921',
                          '57016','22374','67143','97141','78773',
                          '47356','65764','12827','93254','48140',
                          '12590','44848','67316','88125','80646',
                          '22078','71622','91048','74376','68085',
                          '84043','16973','76076','79335','85463',
                          '50618','71089','16576','77292','76219',
                          '88857','43866','73464','75429','19710',
                          '53318','67889','41156','91757','64602',
                          '45695','47651','50696','13420','21970',
                          '81383','10415','73100','51522','45726',
                          '52303','87348','10605','64426','74219',
                          '47200','36228','52029','75837','23689',
                          '90400','73572','93929','28751','39707',
                          '27355','88230','36070','55131','88321',
                          '70008','81104','44490','40418','82428',
                          '38394','20978','34613','79210','14144',
                          '89054','46644','64230','33654','34662',
                          '70489','86025','86605','80350','37848',
                          '92635','65974','98753','21692','80546',
                          '75174','16919','31472','95047','71926',
                          '11055','49865','24983','16217','98168',
                          '30483','25133','20513','47221','62459',
                          '22062','31018','33878','82136','48723',
                          '40435','78661','89576','46949','40450',
                          '18697','26706','71905','95242','93051',
                          '56046','64036','26605','76180','89973',
                          '95825','20676','34202','49641','48849',
                          '14798','36007','12494','71496','83000',
                          '57662','77537','25986','36987','87599',
                          '58179','47498','12372','83837','21161',
                          '62531','56955','38399','73186','48510',
                          '46782','32767','13819','15392','47864',
                          '23820','73679','39471','80554','94484',
                          '78810','66081','96659','44132','49538',
                          '72489','48131','53932','58726','15072',
                          '84888','65956','17758','89651','19888',
                          '15045','41536','95880','89569')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


