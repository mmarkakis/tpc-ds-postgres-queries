
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '94636','67869','65397','56982','35522','40690',
                          '94138','60030','40056','44683','13888',
                          '34431','17826','61042','27842','63000',
                          '75445','11919','22346','14027','67003',
                          '73802','93391','92093','69364','38518',
                          '42282','22915','37597','86499','39078',
                          '61611','10524','57764','38140','77849',
                          '95747','23607','92915','88601','24380',
                          '36815','31987','47974','49562','14289',
                          '23280','94369','19466','96867','72276',
                          '35915','16092','50688','87743','76646',
                          '43248','43214','98012','98837','60338',
                          '55128','41501','39947','32801','45589',
                          '72098','18661','49598','79884','98660',
                          '42119','71439','38051','29661','36399',
                          '76231','74570','77001','64717','50765',
                          '54746','84765','51597','47895','29841',
                          '27009','12066','92246','39019','68206',
                          '18282','58892','74163','74947','81542',
                          '43886','66887','21998','88191','11631',
                          '13547','11978','64163','66267','26524',
                          '65127','45170','79353','62048','88544',
                          '12972','19721','86792','27469','89275',
                          '77294','35160','57706','66116','21112',
                          '97696','81225','26393','28805','10232',
                          '30161','31629','78292','18004','87118',
                          '40068','56441','54771','88575','51082',
                          '53946','91427','76547','37370','64649',
                          '72311','61097','16115','64194','26428',
                          '90536','44124','22178','87976','50803',
                          '29839','82685','93776','56645','71700',
                          '48242','78108','62910','54452','11633',
                          '46790','76206','48058','89216','45070',
                          '99429','87507','70390','88303','75460',
                          '33608','76500','86761','51062','24570',
                          '73753','99790','58075','31890','24571',
                          '73415','26700','15260','61725','10444',
                          '40632','42784','40253','66840','37914',
                          '66180','29716','40049','40810','71730',
                          '40652','89384','91143','59743','37121',
                          '99733','29358','50713','92611','56128',
                          '32769','26381','89517','89415','53595',
                          '66143','74425','45940','58744','77494',
                          '70416','38552','56739','58542','59209',
                          '56800','48978','98517','30379','47271',
                          '40715','60290','31744','63243','20225',
                          '65716','48449','42860','48149','28579',
                          '33764','25337','28360','88892','19176',
                          '98442','81155','54490','66319','40435',
                          '49230','56831','26548','51712','25991',
                          '19639','74056','46373','61453','78331',
                          '36032','86257','60351','94603','29822',
                          '62814','33396','32458','20402','97150',
                          '85450','36420','69106','59861','79586',
                          '66440','82347','54966','12280','60264',
                          '45224','51578','28178','12609','49846',
                          '25632','56025','89996','73474','67346',
                          '11607','88524','94393','68419','30436',
                          '60300','68707','12464','81865','68774',
                          '78242','10309','85711','10805','42249',
                          '81484','20449','48265','90014','24110',
                          '43518','20916','91698','50550','50151',
                          '50919','60592','62983','23470','19970',
                          '93191','87839','53943','68326','23077',
                          '70832','22376','52500','42439','39693',
                          '19496','71923','55190','95656','21819',
                          '71148','65024','78466','77472','79137',
                          '70096','24189','71366','32200','31702',
                          '88545','23547','37140','89225','45768',
                          '94371','70732','83672','12861','10600',
                          '33175','13864','28419','92050','80880',
                          '55890','25470','18389','31107','68764',
                          '14283','94096','40616','39811','71929',
                          '48808','44488','99824','91005','95795',
                          '27747','68289','15440','47478','52611',
                          '49259','33170','41954','59247','92358',
                          '46157','16612','81178','15858','23667',
                          '18210','43120','62103','35310','79700',
                          '43804','48207','54703','89563','14471',
                          '49966','80845','82942','11965')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


