
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '50669','24059','64190','48586','24671','77380',
                          '64860','58257','42710','68668','37329',
                          '48950','17820','11878','55085','18117',
                          '82005','65669','39916','72244','57087',
                          '71564','27666','27387','58479','50949',
                          '61290','68082','70987','78812','44204',
                          '89427','54626','82752','62667','48757',
                          '66069','81172','16981','91403','14477',
                          '24852','16909','22965','43469','32743',
                          '27776','35895','74325','28547','28377',
                          '21042','88731','49292','24848','64854',
                          '98140','54334','72881','77459','77801',
                          '71997','78233','33593','93905','15357',
                          '85034','64491','96791','43579','26875',
                          '47651','49453','29407','46594','37371',
                          '82070','33496','36447','39799','50216',
                          '89738','77286','99200','37179','68948',
                          '83314','20885','31679','92269','14362',
                          '91419','44712','38787','40148','46014',
                          '45406','83783','75809','74549','13138',
                          '63514','28870','11367','81404','80093',
                          '15981','43412','35764','10989','57782',
                          '13039','76367','24427','43975','62036',
                          '40674','49029','51235','22747','54997',
                          '72944','76635','44852','42300','82907',
                          '57144','72870','73938','61448','72373',
                          '55579','80698','31673','65112','14224',
                          '71691','63888','58978','23721','67710',
                          '18472','12177','90631','79520','50369',
                          '14270','49109','26934','89143','69236',
                          '53777','84729','28328','91869','86196',
                          '20739','36274','57236','20512','97957',
                          '97941','22960','83843','90415','43961',
                          '85110','42500','50385','69584','27479',
                          '21371','91502','76271','77228','14746',
                          '28136','78063','22330','13884','93187',
                          '51905','60986','34248','14220','14408',
                          '90007','73282','31655','43394','34998',
                          '94160','22133','75952','60205','10742',
                          '33927','40494','12433','82956','84049',
                          '83550','57617','26138','45541','28231',
                          '93998','62122','30064','29521','45849',
                          '47963','59491','84052','28478','60440',
                          '40718','88437','57701','54058','99409',
                          '11103','11236','37117','57048','89045',
                          '14767','59935','63849','73783','71780',
                          '17258','94780','35149','89837','11313',
                          '97610','51397','39344','34928','64531',
                          '63989','93413','45747','63231','38217',
                          '68954','75725','41492','78141','19186',
                          '29306','51764','75074','78503','31273',
                          '50053','40176','28827','41516','99140',
                          '49212','42974','85231','69369','76545',
                          '44590','64846','27905','98076','10451',
                          '86029','97625','70441','60602','69808',
                          '90752','39009','75394','68282','13582',
                          '78458','94469','71030','16827','44477',
                          '83649','66364','25683','28869','57168',
                          '63570','97521','48162','55366','72685',
                          '11667','66939','96783','29183','23578',
                          '81820','63951','45557','39421','29992',
                          '18916','37327','17515','67250','89633',
                          '20640','19941','49684','34748','54790',
                          '77385','45035','69570','57934','74276',
                          '53965','49052','96277','21871','62146',
                          '29627','17336','75201','88828','87506',
                          '74359','26797','74569','94952','16862',
                          '99629','72246','52726','37255','50895',
                          '36357','46737','44760','73890','34894',
                          '23822','87395','26426','89063','77584',
                          '58460','72239','30287','90300','17180',
                          '37161','28413','16392','65470','67303',
                          '21208','60364','12455','82625','80889',
                          '44288','90021','41793','24869','32541',
                          '19533','14776','77184','96889','33387',
                          '52580','84004','24598','20796','57109',
                          '15305','95478','62072','81901','23287',
                          '17321','84144','20989','19347','42826',
                          '64172','84730','94675','11915','55713',
                          '16080','73058','87341','41083')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


