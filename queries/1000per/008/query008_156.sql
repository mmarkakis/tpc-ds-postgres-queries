
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '59593','52292','19093','11352','34378','37239',
                          '80778','82151','90144','62201','50655',
                          '50805','10847','42787','56793','73429',
                          '33523','43856','39198','65018','82184',
                          '44858','97472','39810','83245','30920',
                          '53563','11068','72736','13450','36269',
                          '95839','21074','63906','85251','13064',
                          '93333','49258','42036','94201','89849',
                          '40270','24834','49615','19012','31071',
                          '20985','45663','40803','92284','92299',
                          '92754','62639','11173','60891','38502',
                          '33294','95914','15211','81233','21959',
                          '42833','62317','26555','54172','89763',
                          '26811','37415','18276','97594','82624',
                          '71834','81146','65074','85050','38774',
                          '90906','96917','47162','83848','13954',
                          '34724','14338','23232','36157','88090',
                          '34934','75313','31165','33552','91367',
                          '54196','87661','30029','31910','18378',
                          '12562','25014','53188','11197','66732',
                          '80602','37022','21917','72610','72843',
                          '40667','93942','16220','27469','78842',
                          '21210','58822','27677','51405','55275',
                          '24013','24729','24725','22676','28261',
                          '12107','85596','48481','47420','73486',
                          '11860','85182','53769','67537','94244',
                          '54502','11624','30111','27839','95842',
                          '83633','19660','37561','90218','23526',
                          '95250','57864','42177','30905','51352',
                          '54896','72107','20852','88410','24635',
                          '95685','64156','64599','12421','73722',
                          '84973','87702','55250','86174','70331',
                          '49503','13546','25533','58876','65602',
                          '98176','38636','79278','47090','77574',
                          '38428','89351','61087','60813','33434',
                          '77377','39721','91177','26380','74946',
                          '71795','68363','65360','49375','76394',
                          '29320','87753','31823','86611','52631',
                          '96623','36893','57015','26262','20738',
                          '15537','55364','63438','13475','71018',
                          '90761','45257','75156','26517','81078',
                          '87458','41458','33275','58291','63000',
                          '87273','49199','53219','56603','58711',
                          '90891','40781','31743','37641','14602',
                          '44379','74414','80210','66048','29011',
                          '66194','38828','48995','94015','28922',
                          '19177','94147','74265','60861','90025',
                          '82475','14302','54290','94918','83044',
                          '65194','64917','76181','14945','72841',
                          '58956','61774','17592','50802','74699',
                          '77057','55322','16856','13034','40810',
                          '52608','98952','44063','63214','18601',
                          '74850','60177','97572','94097','52243',
                          '39612','82525','75128','27136','17806',
                          '17975','10020','77203','40969','93084',
                          '30051','87555','71455','58376','87530',
                          '80953','42185','22295','18111','13947',
                          '34999','13939','27489','83872','10098',
                          '67231','79668','82326','81495','99008',
                          '98058','13263','35625','90273','38212',
                          '67885','40186','99529','45131','92738',
                          '54359','19233','20485','75294','15998',
                          '33422','85825','77941','88769','30817',
                          '69913','73058','89347','28766','89864',
                          '61626','74082','26446','79265','25146',
                          '65034','28398','71253','96656','69111',
                          '46829','73752','45239','72104','31917',
                          '67509','37384','70205','41315','37639',
                          '99502','54041','99826','70175','58875',
                          '86232','40000','82368','95952','40497',
                          '49118','33831','12395','61475','46055',
                          '81818','60725','34099','60640','12393',
                          '30655','34623','85423','68747','69250',
                          '44912','23136','87500','78042','14636',
                          '75283','39559','14740','16267','76303',
                          '83375','71896','51778','87834','66182',
                          '27330','56473','55141','57756','35218',
                          '96141','37665','80227','44585','85031',
                          '99947','10115','76185','22662','90499',
                          '79356','20378','57785','22347')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


