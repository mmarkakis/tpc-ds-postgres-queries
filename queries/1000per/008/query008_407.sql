
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '98434','90510','57509','25444','42025','50781',
                          '61307','44692','78867','62062','23249',
                          '76598','11501','42857','14633','69461',
                          '15361','39703','13354','47394','98009',
                          '68711','62008','32566','64157','87944',
                          '90586','84321','98291','96695','85240',
                          '42360','27697','98857','89811','30002',
                          '36734','75799','73823','43359','92586',
                          '61867','82177','59932','44147','71226',
                          '45429','41269','88599','14940','10002',
                          '41331','68489','52745','78162','57854',
                          '59426','30071','30575','45307','47756',
                          '37922','71510','77594','97825','17600',
                          '13495','31448','81295','49752','68005',
                          '39053','98076','47759','83096','92406',
                          '18760','15580','89473','16117','35587',
                          '57522','20624','58121','81040','16196',
                          '28828','42050','55926','90909','61796',
                          '55591','52941','98001','78687','37927',
                          '78168','85335','30866','18886','53950',
                          '88998','85779','70533','41027','28327',
                          '19454','32769','42068','70440','13790',
                          '10013','62169','34342','81828','77126',
                          '78371','27409','28306','40368','53224',
                          '58247','87222','92623','26354','47503',
                          '67640','55389','62631','79939','48426',
                          '66011','12612','17095','66212','80802',
                          '94929','11436','71146','76525','35315',
                          '37254','21242','54448','87490','39990',
                          '23925','68649','49633','92145','26691',
                          '36880','41157','18651','73977','17019',
                          '30717','47820','77696','36180','19892',
                          '13676','19812','73702','92366','57203',
                          '38132','86608','10853','82209','40225',
                          '67202','92649','21227','43470','12940',
                          '39764','88405','10762','92650','95146',
                          '59605','35983','76793','55217','94519',
                          '81191','86020','26194','70625','80374',
                          '76492','63689','74664','42100','54690',
                          '85892','66772','48143','62487','47144',
                          '34876','25249','68510','66795','52151',
                          '95853','40097','98634','68375','82990',
                          '63697','60320','10337','61418','40724',
                          '48593','18943','10459','57303','65529',
                          '55957','72573','44973','34702','98301',
                          '91222','11357','17489','81672','79241',
                          '82462','45771','18143','94729','10312',
                          '74927','89826','52627','12021','35874',
                          '52033','93753','96273','96010','84666',
                          '43875','88878','24242','20169','80981',
                          '57959','94979','52161','26538','76025',
                          '99671','23728','20613','10930','21040',
                          '12530','75157','19171','72584','95310',
                          '69361','87933','91221','62729','39345',
                          '63038','90322','64208','56205','92047',
                          '17421','40853','95556','57550','72427',
                          '47531','45305','89223','22263','22754',
                          '44527','54364','78449','46255','40719',
                          '57957','47567','61266','47704','51032',
                          '71040','28885','21866','28764','71496',
                          '30800','20079','80166','13431','73974',
                          '81819','70687','27219','15779','75757',
                          '99597','88379','32842','13365','78665',
                          '25979','68072','38160','27818','59253',
                          '43481','57411','13002','31746','70380',
                          '81073','50137','85902','90795','47272',
                          '65805','97219','79086','78810','15790',
                          '93715','82105','31642','76452','56652',
                          '14691','73479','41475','68966','54945',
                          '10903','13103','40529','71253','56949',
                          '23965','95260','82551','26736','19181',
                          '25990','25429','86180','52611','37727',
                          '14986','31182','89894','13276','97198',
                          '34672','20647','64522','72504','90840',
                          '37022','64327','85879','13177','37120',
                          '15384','70130','20033','89672','29370',
                          '83447','77979','70587','48696','54002',
                          '46429','39524','25740','11579','82688',
                          '60258','94339','39287','52089','35453',
                          '78757','89495','78004','19758')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


