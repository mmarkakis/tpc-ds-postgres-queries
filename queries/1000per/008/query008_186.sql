
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '59178','64476','40063','64421','81812','20609',
                          '81881','47467','22609','51797','61294',
                          '81695','10816','95895','98692','37499',
                          '33760','64021','99067','60245','46095',
                          '81801','90053','98439','83384','22992',
                          '45975','76939','77561','19192','43469',
                          '62703','77381','64214','44931','42376',
                          '40256','14311','60384','92878','54136',
                          '80330','21693','85141','57482','31794',
                          '72120','39231','76634','86442','20763',
                          '61475','78194','69958','98747','70388',
                          '62410','16872','57558','74513','17170',
                          '41134','57583','26591','65082','46954',
                          '58960','71184','20741','89513','68132',
                          '64357','55971','23392','98526','86623',
                          '25683','30480','20454','60719','88506',
                          '70719','80156','74286','56091','50098',
                          '59053','51121','23720','51290','94039',
                          '23647','43266','64723','35167','91613',
                          '13299','48568','29355','57252','86586',
                          '34894','43427','24362','83626','49030',
                          '44700','11457','24656','95760','43267',
                          '47995','34232','29166','64227','62605',
                          '13538','29178','74654','32472','69832',
                          '64493','80389','23950','52691','96725',
                          '17811','63673','37136','66760','91704',
                          '44791','74055','79791','63252','40672',
                          '68706','79867','10129','79356','12094',
                          '61741','34045','77952','88962','45556',
                          '72736','86049','14001','32388','42067',
                          '88124','30744','38188','16411','99643',
                          '22112','93523','50320','77545','20063',
                          '46102','13846','53316','79962','29902',
                          '69215','75862','67308','35473','96752',
                          '10140','49542','66661','25476','31625',
                          '34662','46444','58789','31190','54466',
                          '32770','29257','59866','20248','19294',
                          '57874','21290','25358','91527','56878',
                          '19696','59345','28483','12144','28500',
                          '18084','72344','59779','86973','58143',
                          '32567','26231','70302','79964','89400',
                          '36720','43343','62184','51474','29667',
                          '15453','21131','46434','90640','97253',
                          '55482','16910','14036','97901','71246',
                          '58890','64945','74326','85868','86150',
                          '36510','79966','26167','79359','45992',
                          '23027','56093','93458','46317','60135',
                          '36348','71647','97022','54456','35004',
                          '16458','44701','26654','95213','53721',
                          '57459','38501','52084','18599','93576',
                          '67232','40131','57398','19335','92699',
                          '47001','79382','73662','97503','13020',
                          '36784','93183','46826','85784','19844',
                          '69336','82032','67709','46934','71067',
                          '43239','12299','36698','58247','40082',
                          '27170','80841','26635','77571','31162',
                          '57768','44152','40173','36625','39377',
                          '16136','56209','23092','57515','11083',
                          '41628','39088','86296','21024','27896',
                          '20033','35575','77726','35102','66062',
                          '35227','74361','83095','90306','53761',
                          '18370','15600','89495','89068','34226',
                          '44275','49027','44158','82288','13073',
                          '28739','15477','46282','75167','60081',
                          '89223','28180','29948','46170','47634',
                          '41130','51907','50651','32212','84182',
                          '55796','84001','45889','88856','12872',
                          '57384','39629','16167','72576','86138',
                          '53117','54232','72981','33101','64328',
                          '47743','31130','38877','29035','33401',
                          '58021','61456','99583','81648','58720',
                          '68236','55347','94414','83725','85545',
                          '19332','42937','57318','78281','14413',
                          '94850','33201','71731','96791','35394',
                          '92767','13435','61748','25264','43685',
                          '18985','14718','75074','43863','63093',
                          '86191','86359','15879','51643','58560',
                          '46154','90901','26496','46273','81321',
                          '22473','74682','52480','12262','83429',
                          '67878','32206','40850','37198')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


