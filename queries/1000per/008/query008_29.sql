
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '37464','53493','74036','26524','25709','37152',
                          '34595','64263','95335','59571','90196',
                          '55908','36136','66725','70736','71462',
                          '27592','39696','30837','76151','58905',
                          '68818','14660','88756','77057','54318',
                          '70396','22289','38094','78715','72152',
                          '15164','97905','74281','11492','57546',
                          '28304','83052','24544','34690','22738',
                          '30741','28324','85976','70368','67819',
                          '88185','21060','96720','69754','63722',
                          '48456','44367','50399','38724','80303',
                          '52651','24966','24811','53243','50017',
                          '81515','91802','53573','59421','90723',
                          '22588','86032','77428','61659','37411',
                          '55093','48366','88149','63357','30043',
                          '83138','62275','22367','97581','89510',
                          '99109','65957','62934','68244','77424',
                          '93088','48023','43380','43812','48600',
                          '31904','51412','75905','13828','34210',
                          '46416','96315','29998','80242','18513',
                          '85600','35432','83319','34169','28875',
                          '50571','71258','70264','58095','47006',
                          '61860','60562','58370','64713','65886',
                          '84634','99647','73891','26550','81152',
                          '17203','91526','69562','66779','84783',
                          '75921','75988','25603','84709','75579',
                          '51021','35910','94990','80465','75907',
                          '17510','76238','27468','87531','14122',
                          '44151','67845','81421','43189','69836',
                          '31880','86627','12599','63488','28204',
                          '47026','40773','98999','22287','93375',
                          '20013','18893','50393','74492','41461',
                          '45286','70353','71943','39025','35008',
                          '16502','50692','50972','46974','66705',
                          '89986','67729','40146','80584','57191',
                          '49296','34128','41890','32107','73993',
                          '28563','56216','69950','97080','58022',
                          '20985','77262','84815','48572','84259',
                          '42826','98276','33255','39973','57861',
                          '55784','36999','70597','16838','13975',
                          '26071','87308','68172','92108','80869',
                          '10480','97869','22806','83534','81806',
                          '19877','78182','93399','17838','62805',
                          '46183','51514','29671','73428','31958',
                          '13954','95394','83200','25085','48007',
                          '79515','84750','31805','98755','61883',
                          '74870','77048','64368','12042','85598',
                          '61270','91774','81400','11740','83244',
                          '98989','82645','67569','70611','83900',
                          '10074','74378','24749','10766','54284',
                          '24105','81170','44406','59614','87231',
                          '95555','64810','46956','13026','46298',
                          '91601','45121','36507','41034','56065',
                          '43087','42287','14305','73196','20627',
                          '86116','84958','94641','57273','17274',
                          '84761','81028','79727','37069','98800',
                          '73964','63628','70830','36104','41573',
                          '47310','78403','71517','63308','79058',
                          '90406','87886','84363','17460','95814',
                          '78921','62218','69528','59503','54086',
                          '23859','48015','40904','63942','11774',
                          '16810','33225','64387','69837','69956',
                          '64336','38727','91182','22363','77290',
                          '14383','61741','43510','72117','50991',
                          '12093','91498','99904','55249','53726',
                          '53585','74296','29326','15286','29442',
                          '80186','15707','64651','66143','93883',
                          '64377','49699','98245','59982','73996',
                          '83755','90081','22433','46239','73912',
                          '25873','12861','64331','92549','95307',
                          '68045','56146','52660','14512','84834',
                          '99362','19661','19560','69757','52721',
                          '96061','24018','96134','75557','18708',
                          '44273','39139','84049','56298','14291',
                          '41488','74278','93053','18792','66229',
                          '69407','42280','77536','42528','65029',
                          '92325','42450','73985','70739','75475',
                          '74504','43652','36052','71432','18500',
                          '79455','60011','57613','25287','81921',
                          '79534','80084','12034','37223')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


