
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '79793','17499','65480','17733','25954','66893',
                          '89998','61354','86694','70157','24733',
                          '75584','83937','18815','27302','96745',
                          '61982','67378','70366','10030','97742',
                          '94630','24217','10670','50030','60041',
                          '19462','65174','17101','58774','71631',
                          '55220','96071','51620','11384','45279',
                          '28593','11752','85622','98792','81929',
                          '80011','48155','50208','21948','36599',
                          '75279','13159','80891','64814','39922',
                          '56945','85532','34018','32733','81308',
                          '29590','67644','96388','66815','43995',
                          '98950','38113','61922','30613','14822',
                          '54623','37278','25775','63564','25291',
                          '20089','90585','82029','93985','18541',
                          '67972','98396','43363','90532','93096',
                          '25316','73755','14642','82913','13076',
                          '38948','95432','58027','25005','13213',
                          '97997','62331','20595','82918','34156',
                          '77005','27374','70035','18249','81255',
                          '86329','43272','87107','14866','85719',
                          '89931','81057','95211','34903','99479',
                          '74147','72083','16053','73944','33403',
                          '74439','49057','43008','26907','16134',
                          '53265','64904','79645','44957','65626',
                          '24846','12815','82313','20610','47089',
                          '24891','13871','88837','59371','63456',
                          '69795','54274','19068','58416','41569',
                          '25789','62193','28556','13753','52300',
                          '81222','43061','90616','41197','38032',
                          '88930','34706','23400','66305','19782',
                          '18448','21127','23133','58333','66085',
                          '15526','70215','28404','57382','24377',
                          '31976','44828','32904','82757','73770',
                          '92545','26575','65715','31754','12117',
                          '77849','89907','30741','96216','47324',
                          '39376','78928','25742','16344','33745',
                          '95430','57394','99152','56236','50727',
                          '53404','50900','70085','66043','61871',
                          '20242','26284','61505','67529','34514',
                          '91040','85788','91357','96694','33719',
                          '29926','73206','46845','41254','68299',
                          '11116','87514','48483','45649','77454',
                          '65668','90248','54692','20877','48897',
                          '35244','89738','11512','45495','56191',
                          '29903','83252','81601','50652','68270',
                          '82647','43902','21907','93929','57186',
                          '14434','47748','35981','26423','81214',
                          '26538','26408','83794','46871','22287',
                          '44217','69300','75893','78371','72145',
                          '96055','80363','82052','30721','61263',
                          '75700','26128','98735','76714','89129',
                          '93025','87415','92049','42759','43094',
                          '95370','59701','69754','87375','84582',
                          '15750','72240','56701','59542','38537',
                          '95879','98139','80987','88814','17497',
                          '32028','28544','33861','27276','32731',
                          '59368','81059','47280','65024','72316',
                          '61789','36182','79127','14704','50267',
                          '24241','67289','59477','54643','58922',
                          '50142','87233','84307','58452','52200',
                          '96350','77650','17336','13222','85977',
                          '23127','49318','23591','61726','89955',
                          '43113','60278','85828','64543','62280',
                          '69353','73954','52336','16358','43465',
                          '73163','27522','55400','30696','66569',
                          '46894','94823','64177','30592','53758',
                          '71004','56375','74661','79198','99988',
                          '64759','90890','15611','75856','43307',
                          '50874','88542','28266','84607','72402',
                          '38277','50767','76400','74635','93433',
                          '46862','37454','89860','77819','28991',
                          '56775','49885','19997','12380','84382',
                          '38950','44801','81976','22983','34324',
                          '34056','34519','46924','38457','41767',
                          '15959','91668','12365','65883','62030',
                          '61730','74110','60547','92748','64117',
                          '38414','92934','68212','72120','97255',
                          '90715','78115','75260','39329','27704',
                          '67347','84975','68346','14445')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


