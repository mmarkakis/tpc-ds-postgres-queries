
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '15649','97176','11360','24494','95632','70829',
                          '13920','20200','71516','43566','64761',
                          '14371','53335','39963','35318','86348',
                          '69458','25752','38869','45374','84336',
                          '56953','46991','43630','13511','62831',
                          '18652','60853','61079','22429','70700',
                          '94674','36533','86246','45046','75688',
                          '87524','42949','15199','11458','62631',
                          '19163','25215','38302','77584','57121',
                          '77920','35077','20124','41697','42012',
                          '80974','34191','72215','40589','98087',
                          '60714','32206','45649','77868','91274',
                          '50134','10194','63169','48654','13691',
                          '56763','50550','11863','90278','74108',
                          '77386','65216','19678','14873','79800',
                          '70639','96537','95880','14642','78622',
                          '49704','87013','74044','65119','45127',
                          '41477','43403','80431','30916','45101',
                          '20266','35688','23097','40317','92254',
                          '46593','51307','67598','35427','21637',
                          '54133','95472','43230','60681','26367',
                          '96563','46070','49787','31523','38503',
                          '59099','63600','87308','26194','62098',
                          '49512','92542','45800','52600','94197',
                          '69741','21041','16703','62300','18307',
                          '27973','74633','88169','16625','37777',
                          '31628','54479','13057','22995','82447',
                          '60985','11425','87516','89804','70889',
                          '27175','94215','95471','94619','24322',
                          '47102','76579','11880','42729','17087',
                          '56261','80423','99752','50486','12143',
                          '11171','67932','79840','95301','92265',
                          '66338','91731','86557','50821','92884',
                          '38075','68951','35468','60592','72759',
                          '90361','84040','35063','47344','80501',
                          '98040','52919','85872','43919','51079',
                          '98329','29393','79122','72427','36702',
                          '24159','31016','98824','32545','85510',
                          '29492','96659','29763','31063','37533',
                          '63797','37369','66140','91245','58016',
                          '32788','49214','28211','89512','77950',
                          '28147','76974','38547','61447','22275',
                          '62125','32551','45994','14586','14100',
                          '42707','13565','29162','20957','34311',
                          '60299','41933','88106','17152','77062',
                          '71739','22227','96166','26383','89033',
                          '24221','14853','33951','47050','19103',
                          '69581','43820','18618','87654','58992',
                          '40373','91682','84541','74140','16555',
                          '20380','59341','19033','89178','53282',
                          '36260','62550','62025','94519','98393',
                          '43612','61451','46663','47520','37806',
                          '43418','70016','72504','88593','28437',
                          '73828','39659','15774','33551','26000',
                          '58506','17779','83210','58170','35925',
                          '64047','87926','52017','10473','47957',
                          '27050','90439','70545','81391','94703',
                          '32465','33114','83491','84583','82495',
                          '70071','88087','29557','89594','69039',
                          '77336','92848','92344','77266','32173',
                          '55542','95320','24332','13227','30839',
                          '46895','56687','10967','74162','11645',
                          '72462','87782','71803','21003','75424',
                          '33182','35552','46114','10639','76229',
                          '40375','43378','86016','27721','79311',
                          '98727','41952','39383','40967','35765',
                          '84366','31986','30304','42764','86670',
                          '43923','64577','14049','98434','13403',
                          '24805','70147','56387','78555','88271',
                          '95464','92040','82860','93850','45363',
                          '24257','67949','23664','12018','50458',
                          '81813','74815','77209','90540','15519',
                          '18714','38489','78960','78483','14855',
                          '25410','89318','34245','72407','37184',
                          '95451','60775','53607','25725','25574',
                          '79734','69066','82972','45655','64265',
                          '54047','85323','53842','71367','11320',
                          '73201','79231','93945','69444','96619',
                          '43755','33788','90027','37267','53417',
                          '71664','75380','31243','14280')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


