
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '51276','73540','18648','58477','21695','59086',
                          '32002','87096','63817','95182','66449',
                          '10784','80926','13595','99453','94815',
                          '85828','94667','12706','39684','33831',
                          '14633','10010','64147','97838','66240',
                          '89113','74563','51982','99847','16049',
                          '46405','19962','82531','52259','54473',
                          '80877','79559','90492','29027','26809',
                          '17497','28776','84485','32074','88498',
                          '92952','16442','91522','56943','72184',
                          '54456','23821','40137','95582','47742',
                          '99298','28747','40550','21002','64211',
                          '46259','67685','44876','18205','31289',
                          '56711','85169','72265','17973','12889',
                          '48532','29166','10937','75687','10816',
                          '39641','63426','62998','60282','11130',
                          '90610','36285','27660','50661','11736',
                          '31515','35638','85108','96487','10903',
                          '27884','33376','25489','92406','73450',
                          '91291','62067','40787','88093','31929',
                          '12469','15791','29329','12456','47412',
                          '33637','98838','61244','48458','18640',
                          '89202','91658','64190','61520','32336',
                          '42713','14878','94958','65486','62927',
                          '75029','81057','52723','37031','16946',
                          '94188','44666','34358','79668','46942',
                          '90992','17982','78379','78980','30500',
                          '30536','87256','93413','95842','23169',
                          '47132','48721','21164','39957','89902',
                          '14072','76011','19456','33288','42146',
                          '60400','85624','45810','15403','96349',
                          '29501','31358','79784','38495','66904',
                          '73461','72543','43763','56300','42219',
                          '15254','49984','20002','42777','21420',
                          '30035','33008','97972','97650','77815',
                          '50591','94143','88956','86080','88677',
                          '79178','20352','52012','85518','33253',
                          '72974','92312','78364','15482','53823',
                          '73088','51418','18741','71399','51405',
                          '71055','77958','69953','50474','76854',
                          '12761','39344','62622','32014','91215',
                          '98484','26202','59802','60971','26531',
                          '10591','45736','67604','68382','69121',
                          '28959','81268','66344','92274','93031',
                          '44933','82657','60514','53302','13985',
                          '39581','12199','72426','92371','31067',
                          '19469','11242','89110','60901','69319',
                          '86313','38091','84212','98390','64378',
                          '86915','74655','38413','95456','36552',
                          '64835','63359','47253','91442','82777',
                          '56922','75391','90519','97121','15908',
                          '71238','73871','63428','13696','26678',
                          '62543','35716','41740','75412','31317',
                          '76208','87803','50606','97457','90227',
                          '86429','14008','13632','32949','27062',
                          '48537','60175','85844','73001','73937',
                          '27160','11037','22628','19373','28135',
                          '13540','46559','19238','76622','48742',
                          '55565','19201','72214','31624','75088',
                          '97400','46128','53219','28929','61539',
                          '79751','14375','54294','65341','10126',
                          '22490','31095','97540','53016','53509',
                          '83222','42631','59810','36944','87731',
                          '79553','41017','15473','31836','94304',
                          '81610','68856','45298','26929','52823',
                          '18124','42908','70198','40656','23296',
                          '35942','22524','61942','65765','77513',
                          '13364','89700','61021','18377','78421',
                          '64849','70850','48759','25775','80484',
                          '99920','29510','88085','89631','31406',
                          '92114','48447','79765','50882','59252',
                          '38282','57340','15848','36006','51604',
                          '60497','52285','56464','70100','92591',
                          '58074','16651','71416','54046','80521',
                          '88357','29064','64148','44791','14618',
                          '74395','45211','14374','12405','48754',
                          '87996','53045','94913','52493','21340',
                          '97936','30633','11957','52984','79492',
                          '16930','95020','12926','44383','52444',
                          '20376','45664','56137','84613')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


