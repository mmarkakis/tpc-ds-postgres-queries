
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '58266','16618','17386','69979','20569','24693',
                          '14929','80047','61150','55533','66079',
                          '63428','27232','37465','51410','79823',
                          '20619','80794','97228','58225','72840',
                          '77524','22775','66980','74406','61816',
                          '88100','51611','59997','21137','41552',
                          '15281','48579','76474','99194','43276',
                          '54821','65641','71485','19662','80880',
                          '50781','81754','50533','13417','18622',
                          '98694','66476','97836','53670','94657',
                          '84705','19921','35783','86394','80937',
                          '88561','51428','27703','15796','45756',
                          '47552','57696','22674','99112','21107',
                          '12780','57343','38308','69783','17430',
                          '40979','68516','42934','99225','72318',
                          '29947','49332','91266','85844','91593',
                          '49700','80812','32309','69998','98444',
                          '16430','95241','26224','16367','15087',
                          '23232','40414','83136','42813','78367',
                          '35207','51209','52710','80105','90629',
                          '73730','59284','12927','62320','53520',
                          '82927','91245','34197','66850','89911',
                          '12408','46966','88675','99165','30657',
                          '23161','26803','70446','84878','39635',
                          '98943','67768','38491','29445','14231',
                          '91968','59753','62183','62368','94761',
                          '92661','25879','90092','47658','29203',
                          '67605','88871','46709','29490','83551',
                          '41574','76641','57643','49636','89546',
                          '98697','96665','96594','91781','96485',
                          '65868','57372','19245','92565','88079',
                          '95461','48379','65730','26160','92998',
                          '43398','61116','92858','83837','81311',
                          '32257','87074','58108','90403','59409',
                          '14266','40641','75919','12818','86910',
                          '83359','14083','90146','66898','28022',
                          '34839','83805','51200','35526','88900',
                          '79399','36345','23208','56691','99991',
                          '73861','64602','12418','24664','92292',
                          '98660','59195','61262','77810','30411',
                          '99117','97767','32300','18297','42422',
                          '31210','99930','92492','77266','81382',
                          '18153','11132','11859','93292','28922',
                          '80788','58688','75165','85984','57396',
                          '35578','98313','23285','56658','43468',
                          '15212','47278','64798','45414','98121',
                          '89226','85590','41678','46200','86454',
                          '97885','88476','54443','82293','72690',
                          '23929','14439','90850','70904','68406',
                          '73047','27426','40619','83395','63230',
                          '48329','84235','63500','33166','18552',
                          '88918','52582','49942','75318','26622',
                          '25339','26935','22490','23087','86479',
                          '90256','60866','12498','89176','81090',
                          '35690','28309','83851','50982','72033',
                          '82709','68498','96369','89561','64860',
                          '34630','91566','42038','94399','99593',
                          '10321','99295','23096','93017','96850',
                          '46290','45339','71846','66726','76710',
                          '23659','56813','95108','45008','96119',
                          '63894','37754','69453','27242','70444',
                          '55355','57133','93545','73390','66800',
                          '97186','70218','89904','81738','93004',
                          '58829','94269','80537','64671','50574',
                          '67559','65297','92355','91984','98097',
                          '94731','36046','82657','79253','18415',
                          '15718','69391','74127','69848','89700',
                          '23904','31051','81293','75293','27547',
                          '19089','20171','63234','48139','88633',
                          '49266','14966','81636','69230','97918',
                          '69486','79043','25993','89861','61792',
                          '46785','20565','13175','48525','47498',
                          '75131','97713','42870','86093','52244',
                          '87772','63532','67029','39187','44634',
                          '53493','74533','65241','62092','10073',
                          '16268','65602','51787','29589','44547',
                          '59244','90761','29537','23849','24358',
                          '35516','24417','45835','65615','68024',
                          '14410','14316','85911','92255','24081',
                          '72229','88969','75628','92136')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


