
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '34895','68419','24395','10575','51768','67024',
                          '50348','34724','76975','61712','62234',
                          '58887','71741','19800','64004','28539',
                          '67482','13808','97884','30412','35322',
                          '12635','94475','34079','25095','37419',
                          '60321','81321','83937','54647','77253',
                          '87825','86129','70956','23010','58339',
                          '58246','98631','85152','47382','86786',
                          '23469','88783','64328','54964','33191',
                          '22357','37559','77134','95727','74641',
                          '33489','45183','70370','79362','87678',
                          '47779','22777','17654','43230','76644',
                          '15146','98221','17045','49361','12962',
                          '65491','55487','84587','75731','96640',
                          '29749','27548','83856','92503','18145',
                          '41679','29960','67906','99594','10667',
                          '91219','40860','28366','19578','30097',
                          '69939','40468','92185','58750','84475',
                          '82834','87834','33231','97625','59434',
                          '34936','69036','19422','36151','93954',
                          '58761','53469','26012','54536','37929',
                          '99390','62932','63787','57909','76196',
                          '19396','57482','61385','70400','96811',
                          '93613','52747','24034','47137','79530',
                          '73570','27033','70246','19589','39948',
                          '52936','35026','82846','18940','74158',
                          '66330','20770','23366','73221','67275',
                          '37660','91885','63449','57708','16723',
                          '76928','55295','93315','37862','42033',
                          '26162','21902','81304','72970','65932',
                          '22505','51893','25085','17900','86677',
                          '19019','98266','18151','36880','58502',
                          '35923','21166','21241','58846','11854',
                          '51137','53693','47701','28016','27954',
                          '13225','47442','11894','95764','82450',
                          '97580','23830','39386','81599','80187',
                          '75168','79194','41170','72462','31943',
                          '18203','61352','35854','34800','92477',
                          '35164','91393','83556','79739','45088',
                          '46813','98769','78348','89502','46244',
                          '15925','21114','12476','44711','79696',
                          '52202','45014','65112','18152','60501',
                          '64268','30975','33251','82321','60735',
                          '63211','26203','36109','68290','13395',
                          '33323','99149','16482','45455','10313',
                          '94423','17565','24392','80434','40634',
                          '66314','44142','35672','73559','57472',
                          '35575','85358','39835','66721','28612',
                          '71553','41528','52685','21491','69329',
                          '12766','98604','93800','49525','56664',
                          '78219','39959','70150','70328','86083',
                          '39763','74694','70572','74624','79737',
                          '70522','99883','11572','24993','81554',
                          '88938','27392','66599','97121','54710',
                          '41416','50273','85799','57051','16046',
                          '68439','22320','70735','17763','13870',
                          '58834','92955','47263','83755','73756',
                          '90031','31897','68718','56232','32840',
                          '19927','63176','25917','47832','57878',
                          '25391','19579','74176','63880','19642',
                          '79477','44841','58740','60337','82360',
                          '46699','84568','71048','88164','53983',
                          '26503','15553','96176','66191','76000',
                          '73334','37924','11530','92134','14488',
                          '81908','90559','83935','27645','62567',
                          '26403','39355','63107','87250','68352',
                          '86218','98793','37325','97183','29163',
                          '45029','48501','16536','43700','46529',
                          '83320','86702','35397','57434','41569',
                          '14874','10359','53291','24498','35251',
                          '94226','58072','85160','41733','22398',
                          '16330','33090','16358','62315','81823',
                          '11358','56394','87757','98877','42593',
                          '99103','45912','37530','90609','52335',
                          '17999','98008','89982','14929','48603',
                          '18856','57163','25977','94290','79296',
                          '69471','54654','96771','28714','14616',
                          '42178','88533','70832','22264','96584',
                          '10053','86885','64534','65615','70202',
                          '63576','71665','93283','28571')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


