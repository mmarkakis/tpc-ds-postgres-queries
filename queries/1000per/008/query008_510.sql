
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '56740','58379','66262','42005','29390','45503',
                          '11729','93277','28807','29264','31343',
                          '92051','13746','19252','29717','50341',
                          '59520','23553','64768','53324','60041',
                          '10179','12897','34490','44136','50038',
                          '74625','50763','58610','59191','52261',
                          '28418','80703','65067','68323','46010',
                          '94530','44122','60773','48990','67448',
                          '18447','30415','47105','71714','18374',
                          '82953','66232','56318','71731','88244',
                          '34991','96456','46897','50487','33484',
                          '82745','86282','53822','35116','78607',
                          '55225','55558','33791','94607','77214',
                          '41381','20453','15493','75656','72571',
                          '67234','11831','44858','87013','98634',
                          '29932','52094','23527','44107','19857',
                          '36337','80452','76652','62968','90037',
                          '99676','84059','58321','17441','82418',
                          '78735','27897','21067','27465','71977',
                          '21174','75258','58261','24615','88292',
                          '88130','75503','94845','52637','10976',
                          '31033','40156','79656','35926','24513',
                          '44921','71859','29043','92049','64626',
                          '53273','28841','61163','78102','95773',
                          '66934','36367','49672','28048','19125',
                          '26279','50287','16254','72830','35541',
                          '34364','31963','16866','83903','97982',
                          '32544','35612','99597','20002','81827',
                          '59012','87481','62332','78605','74609',
                          '10823','93360','28851','15065','20411',
                          '47249','51512','16238','28004','73169',
                          '86492','76477','73321','10126','34277',
                          '93813','80269','76866','96363','36979',
                          '43850','18521','15746','94935','65548',
                          '16043','42818','15565','49269','31587',
                          '16468','35547','21534','62227','33482',
                          '95562','52908','86777','37586','79663',
                          '93086','68263','74879','43144','14166',
                          '32558','70429','98611','39323','35908',
                          '29884','87125','93798','21725','74586',
                          '29783','33932','90143','99113','28006',
                          '57902','25502','34543','54226','42677',
                          '80475','15765','70195','80177','63094',
                          '89362','19624','29552','39334','54104',
                          '89386','44857','64871','30065','65243',
                          '89729','98635','61430','86572','87122',
                          '84695','24995','46524','14645','80818',
                          '61287','45777','96868','50968','45886',
                          '81999','47068','49569','17014','84792',
                          '91081','59817','61002','92502','93251',
                          '66454','86910','29187','17218','10715',
                          '60145','10875','84582','98507','54099',
                          '31475','64832','62484','41033','92913',
                          '94895','31421','89061','79988','52452',
                          '87880','79444','93802','28735','50213',
                          '98988','71825','10042','55465','32429',
                          '19380','73175','13780','79789','69389',
                          '55003','53178','18511','57239','21116',
                          '17508','22321','69499','53810','25326',
                          '83370','55025','50512','51621','28751',
                          '71167','26199','24073','17595','81962',
                          '56643','72926','68319','45374','87938',
                          '28767','29143','47435','99718','14027',
                          '44194','13048','60497','75835','61940',
                          '49991','63951','31226','45408','85033',
                          '83923','16403','11953','51068','80232',
                          '63373','34329','94268','23251','58190',
                          '69606','70331','49814','39907','30590',
                          '15398','38754','44445','53994','67788',
                          '32631','89267','37392','12676','18778',
                          '38766','65653','75167','88428','48935',
                          '86620','58815','71581','49821','54278',
                          '58297','27619','94872','71449','61266',
                          '96666','64633','59363','88737','60302',
                          '19645','99612','95603','55631','24543',
                          '15667','33170','55268','47490','43009',
                          '73198','19341','86478','30181','70432',
                          '11380','17206','92483','24673','66638',
                          '64219','32314','96994','70813','86512',
                          '39581','47896','57989','64448')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


