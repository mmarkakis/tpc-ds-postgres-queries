
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '17675','90247','14058','80662','83435','64862',
                          '54679','92233','64046','49294','17980',
                          '36951','28164','17488','92752','53765',
                          '75708','97188','40938','45909','79149',
                          '51442','11465','32184','59485','49634',
                          '64371','72674','80904','95301','83181',
                          '70340','84205','52365','53716','89406',
                          '49637','13935','50214','64184','41329',
                          '71758','65114','86986','13396','95549',
                          '21706','58560','37154','76461','16299',
                          '79985','24858','34215','89439','58056',
                          '36743','55975','21911','79365','86137',
                          '55820','72315','17957','97779','57871',
                          '99912','64574','14234','32213','37544',
                          '91972','90435','79430','90528','31369',
                          '24586','89466','84594','23023','22680',
                          '20147','82532','41232','84417','85920',
                          '87698','51083','81321','77661','70086',
                          '67242','16263','12908','22550','96328',
                          '23732','92072','81183','86775','78391',
                          '93634','40425','56124','62469','39213',
                          '35738','14206','77193','74102','36557',
                          '87525','20010','41655','16021','96685',
                          '85724','63000','19675','38029','33676',
                          '73201','57487','45394','76667','46620',
                          '33767','89308','99205','60879','44696',
                          '83521','96520','73313','43902','61960',
                          '55547','41050','90467','53654','39917',
                          '60635','52938','99458','81888','75130',
                          '95757','89754','22148','87894','20442',
                          '75047','98194','58543','88057','82962',
                          '11766','82916','71256','86288','58370',
                          '46665','13748','37747','81404','66968',
                          '53252','42260','73884','87992','95980',
                          '13532','99688','77598','89207','22069',
                          '83094','70586','17766','84970','19530',
                          '43390','97192','52282','26558','78988',
                          '13660','23642','27249','28111','96158',
                          '31601','89049','36319','12221','68395',
                          '43419','59668','11385','27036','92168',
                          '50110','10517','64018','93317','60859',
                          '69224','64754','66683','28757','19802',
                          '65457','24100','20032','10150','98216',
                          '39448','80867','16009','70372','91220',
                          '28877','69895','16774','79865','27503',
                          '94722','18218','35054','66081','90450',
                          '71556','62031','42918','11247','89356',
                          '13868','96746','12231','26516','12070',
                          '78466','83231','52399','34847','31473',
                          '60737','24365','66170','61840','14877',
                          '65766','78907','84079','90739','23051',
                          '30639','87302','81802','32992','48611',
                          '78756','32591','19779','62978','54878',
                          '29169','79587','73487','20674','80473',
                          '91643','47326','14400','19666','26929',
                          '12590','27722','55835','78512','83809',
                          '15871','50265','85354','80295','65122',
                          '21494','92691','80789','68431','36357',
                          '49348','44594','76195','22294','73516',
                          '94464','58549','82430','64889','73116',
                          '68734','71521','33506','93235','53843',
                          '63051','64679','99832','36239','36273',
                          '51664','94604','38810','51143','10303',
                          '63007','92213','64966','50137','75527',
                          '42211','71907','90722','92972','32437',
                          '86477','67494','36911','29422','61894',
                          '13594','53149','20194','61422','87811',
                          '69700','17142','46679','31642','48725',
                          '78805','87076','32096','93506','54419',
                          '57142','42718','92508','49428','35618',
                          '82738','51702','92087','37134','19469',
                          '49987','59053','74872','44425','22598',
                          '51330','54207','90691','79890','10397',
                          '10797','69548','30034','72196','69551',
                          '82950','44604','90334','19462','29059',
                          '65113','60798','93042','93351','43996',
                          '20051','20619','65349','61916','12372',
                          '49208','98460','43876','31114','68784',
                          '18439','63361','94144','25286','81268',
                          '54653','20352','46438','77655')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


