
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '98646','90328','59715','96142','71795','28818',
                          '24397','32403','24064','24812','21293',
                          '32573','48967','32078','62478','15009',
                          '45754','98930','31497','88184','15480',
                          '61388','66221','37975','18144','46219',
                          '65631','24618','19921','93132','87152',
                          '43184','50602','41765','30157','24469',
                          '44042','98899','11323','23025','21190',
                          '37699','94072','77779','67751','93871',
                          '61568','84966','67825','31237','98841',
                          '20288','84638','68015','43124','77815',
                          '33490','15993','84941','36481','39836',
                          '54024','69748','31879','38434','48126',
                          '55535','79919','99635','49870','34652',
                          '33502','29543','15485','92610','39985',
                          '89359','48290','76251','50389','29470',
                          '47811','29297','75914','89263','28606',
                          '63589','26022','51941','47154','74481',
                          '67003','62840','94000','21536','85479',
                          '89711','39681','91852','48147','60449',
                          '21201','62597','10425','69002','74008',
                          '30572','56474','15922','72756','81273',
                          '40647','41721','82384','20858','43584',
                          '75513','16706','15880','19079','50711',
                          '60115','47013','84388','19028','36967',
                          '74120','94923','82685','69403','79639',
                          '33823','17406','42542','57359','78149',
                          '16623','46178','39031','67183','80383',
                          '82307','90235','54457','34484','99042',
                          '51384','33788','67918','15575','34185',
                          '18048','99892','37775','99562','22396',
                          '84312','95063','25595','74505','26600',
                          '22513','32788','77345','57561','39971',
                          '42867','86420','99399','96236','62494',
                          '72919','86855','39307','43923','54658',
                          '72123','45995','12193','56275','75656',
                          '87363','37423','28387','26628','73408',
                          '57234','24675','28858','91194','91569',
                          '61874','31174','10746','41241','19969',
                          '10354','15710','75812','64556','86273',
                          '98773','48804','45552','75292','99849',
                          '55147','99088','46704','36462','45741',
                          '72442','46067','89246','23871','56318',
                          '59625','17556','97280','69605','26404',
                          '77704','19757','62538','48013','85364',
                          '65620','87785','13467','13407','31089',
                          '35825','45293','40525','67083','16928',
                          '36684','41936','40933','53403','48531',
                          '65297','76833','91856','88798','68897',
                          '64911','67013','60263','55748','26811',
                          '48012','62481','56708','22757','40480',
                          '34143','16699','32931','24531','67950',
                          '13008','90681','73166','43539','12152',
                          '86548','96761','22064','22783','86693',
                          '49210','49223','30685','54333','48668',
                          '35288','61011','12147','75075','46463',
                          '31629','47121','43741','73770','93155',
                          '92230','40051','32757','84427','83096',
                          '59694','93667','19280','75412','23346',
                          '95647','62343','52509','24973','54676',
                          '73298','51377','35871','29119','72486',
                          '47156','56425','76496','24394','90508',
                          '60540','28364','53430','42041','71874',
                          '30008','99639','36552','71413','13030',
                          '95755','72795','47497','74049','37477',
                          '68725','84930','34066','23070','98120',
                          '47415','74058','40256','18293','27466',
                          '45413','48666','46127','57196','56018',
                          '61886','26495','60338','39401','85441',
                          '84807','45118','29468','70101','21245',
                          '23021','64159','83130','45512','70360',
                          '36387','44305','55310','15981','45124',
                          '63128','21849','48278','90202','12679',
                          '10662','12924','22665','94537','50438',
                          '58174','11117','54266','56314','99569',
                          '39679','90359','58897','89732','35975',
                          '40113','94536','77936','37750','74990',
                          '39260','67704','46525','84797','41776',
                          '34581','90727','97312','59371','22761',
                          '32703','45996','54137','37133')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


