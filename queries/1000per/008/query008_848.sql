
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '28064','71025','65325','72372','50953','53995',
                          '33062','93540','61495','21839','34771',
                          '62351','36149','27424','73570','15776',
                          '20462','82776','24671','68620','85639',
                          '63772','69964','73010','59059','32891',
                          '20731','11462','35785','89461','71082',
                          '31541','40396','58801','78783','58117',
                          '75406','29369','97589','49415','48280',
                          '63539','35964','82008','30135','73725',
                          '28576','80092','33031','23917','18530',
                          '10385','26504','19207','49724','73188',
                          '80845','30529','64225','71385','61100',
                          '28650','26635','65706','32156','45595',
                          '60907','33690','67608','87701','58925',
                          '62427','39767','42962','19778','48228',
                          '65769','37062','46007','13240','81981',
                          '99725','34018','17578','14301','32934',
                          '45412','40835','13233','92920','83064',
                          '18622','25037','49323','77169','81782',
                          '58762','26308','21509','14653','91052',
                          '25219','83681','91645','48296','53805',
                          '10761','94380','72215','30062','81098',
                          '31528','68722','31153','73628','17535',
                          '67928','41777','28658','11157','30941',
                          '21027','75558','59638','86715','58376',
                          '60880','45325','70677','25008','93274',
                          '22102','80505','23651','13068','95047',
                          '55354','81504','82998','14834','54605',
                          '23199','49566','80635','90709','72508',
                          '20387','83990','90225','92933','94176',
                          '29229','74120','70467','11295','10909',
                          '12952','68170','42119','42747','21681',
                          '61998','32067','89778','27587','56017',
                          '91848','67789','80660','31068','39096',
                          '73163','24780','63496','74588','44158',
                          '77796','91614','83800','31894','21077',
                          '10003','95576','88675','33018','96493',
                          '18237','50980','36386','43645','28329',
                          '79989','65558','12954','40868','30058',
                          '94518','30719','66098','82202','64280',
                          '61364','79153','32197','36428','53880',
                          '95455','25969','42358','57317','74212',
                          '21942','99199','23963','56604','79390',
                          '63377','28856','17042','21351','71509',
                          '55274','36869','89319','14995','65222',
                          '87462','88765','98223','50295','49588',
                          '77306','70224','20356','35848','22718',
                          '70809','88948','40803','95707','67002',
                          '33856','49597','84581','20385','25108',
                          '68813','77081','12540','72917','66898',
                          '58952','89517','85807','93466','49568',
                          '90188','13620','37861','67339','24567',
                          '88164','69866','20545','47802','92172',
                          '85009','99604','27491','55606','46704',
                          '56818','62348','25626','11396','68784',
                          '14551','26979','59173','34847','97774',
                          '52786','15858','98853','10321','50041',
                          '12886','34367','85720','22302','93628',
                          '99906','91510','79160','33219','74165',
                          '42205','28011','71641','59229','13655',
                          '42065','36492','54989','21791','88752',
                          '95786','75939','64332','97649','66653',
                          '78876','62575','72470','21388','42297',
                          '54917','41650','83531','43429','31062',
                          '85341','65513','10777','67312','71868',
                          '65758','25999','87578','27653','56478',
                          '84238','27341','10566','26974','13319',
                          '98856','18358','48399','94697','26596',
                          '15682','48739','46402','18908','71304',
                          '63915','89411','99428','31795','79624',
                          '11338','61627','34679','90811','16127',
                          '87359','28392','72863','87941','63804',
                          '69089','78709','27634','99857','78836',
                          '72746','24106','71744','90887','45823',
                          '17145','63204','67671','38942','40434',
                          '96104','76829','54537','11212','16864',
                          '13378','80011','25638','38003','62837',
                          '53951','91236','91365','48258','60020',
                          '37421','72292','14448','82213','69969',
                          '36828','59540','47947','59337')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


