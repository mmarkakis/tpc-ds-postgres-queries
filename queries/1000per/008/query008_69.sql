
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '25217','40172','17782','92382','53467','97173',
                          '23830','72152','80233','71954','81510',
                          '60932','27857','41288','36948','14508',
                          '75544','84633','82422','56020','17210',
                          '18471','56061','44687','88309','68960',
                          '87582','28254','86984','99198','57609',
                          '48757','23822','87032','84651','19161',
                          '41024','56778','97459','72133','86376',
                          '66287','38280','11132','10841','76677',
                          '62520','93694','47594','57912','17966',
                          '53868','57829','17390','61615','50306',
                          '30403','52013','70029','90692','77687',
                          '78725','87384','33097','27562','30900',
                          '95205','56371','54501','39531','49726',
                          '14533','23042','10364','26638','91323',
                          '96337','11802','97109','46666','76327',
                          '51772','61996','46224','13961','14580',
                          '77756','30990','45258','51126','59244',
                          '53673','39395','99290','67940','37685',
                          '26291','68169','95774','21503','68452',
                          '37342','31116','91506','85161','52639',
                          '94919','71332','95145','92752','13050',
                          '39244','68420','98649','67040','87480',
                          '52780','71944','50687','45924','39061',
                          '15303','22096','10929','81072','79547',
                          '21898','97914','47674','50896','52162',
                          '75827','40910','98443','73610','40805',
                          '86706','42811','61630','98819','84479',
                          '43017','83730','99094','71186','30460',
                          '12030','94635','13836','26876','15284',
                          '32274','58339','45741','99326','33241',
                          '77208','94927','78691','45350','43336',
                          '43921','28972','86262','65972','70019',
                          '41573','37527','21426','35940','10905',
                          '15965','36104','19539','54227','43323',
                          '73909','42880','55272','11136','87311',
                          '14856','81293','26325','42863','13924',
                          '87988','61664','59274','13734','31965',
                          '61583','71885','82433','66438','93746',
                          '83459','74616','11709','25614','94937',
                          '28448','73905','91570','16440','70723',
                          '72795','63050','19673','64900','45660',
                          '49495','78089','53069','89631','72388',
                          '29797','56282','24188','89818','78948',
                          '51656','49802','65944','47817','24168',
                          '55405','17488','90964','58504','43773',
                          '57264','61513','78234','83759','69186',
                          '63558','67351','23200','28646','29678',
                          '57740','41544','43758','53499','51721',
                          '89072','71631','63003','28139','32190',
                          '73294','36398','81396','10979','10555',
                          '53759','55510','54743','41487','51996',
                          '20805','29223','25815','75527','96067',
                          '91129','75552','92501','54688','69357',
                          '94957','80868','54207','95338','52657',
                          '16512','42299','34612','67731','33125',
                          '30407','39743','16381','79154','76013',
                          '41018','44435','35462','84897','41985',
                          '62343','73531','24394','98092','56406',
                          '19495','94438','59347','49218','38693',
                          '26433','18284','94887','55044','77419',
                          '59948','47880','24937','61736','15724',
                          '64043','75155','29814','36065','29667',
                          '78914','82288','86551','17686','41650',
                          '83200','71915','89790','29988','30275',
                          '68676','56492','28554','18609','62115',
                          '40849','95799','56774','26113','48712',
                          '26662','16452','56610','67135','93931',
                          '15198','43553','14870','72049','48655',
                          '21694','59089','71515','11586','33989',
                          '49033','10768','48002','37154','61707',
                          '23964','86325','21275','22578','99675',
                          '97600','29389','11532','62983','12005',
                          '77028','50893','39246','71175','50324',
                          '75233','41751','16526','23286','46459',
                          '40227','32041','16693','36367','42124',
                          '29670','78716','88446','63790','89160',
                          '75235','33180','63010','77151','58690',
                          '39088','58358','96498','31089','39144',
                          '12608','92966','66986','31386')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


