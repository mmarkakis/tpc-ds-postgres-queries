
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '53004','69635','38699','24494','16270','39381',
                          '78480','20182','13980','67862','24782',
                          '42614','88868','32984','72189','96785',
                          '82078','52940','30274','90581','90892',
                          '15582','90896','77041','87411','43842',
                          '43826','15222','70314','67823','69220',
                          '59992','56006','29260','11105','81279',
                          '30714','83549','38768','92460','44894',
                          '18214','76553','94138','94027','51123',
                          '25129','37697','95741','42233','26926',
                          '14397','27923','46428','84370','89006',
                          '54139','89062','51522','71511','26708',
                          '32254','53637','40983','14212','35404',
                          '45458','70065','55471','55863','94848',
                          '90413','87573','38781','51037','66542',
                          '94690','33779','85260','20300','54965',
                          '90058','21344','55930','30691','48546',
                          '64397','17089','51268','33130','80824',
                          '48490','92347','13990','10497','53544',
                          '63374','66255','29804','87526','75211',
                          '67994','14167','82591','39680','38243',
                          '13956','24875','91187','43126','66873',
                          '80593','76760','98915','16346','45393',
                          '60178','84838','97674','79771','87011',
                          '29240','28188','48629','96244','82332',
                          '40735','25293','35904','75442','16760',
                          '27405','68759','21156','68656','36260',
                          '28304','36283','20522','87349','58868',
                          '30088','96988','22723','12126','15374',
                          '98620','59041','11606','91733','62836',
                          '22490','80083','64168','84881','75069',
                          '15855','95300','54802','16020','44580',
                          '50383','87679','32696','20371','33489',
                          '88605','71438','65121','58100','66095',
                          '99802','22883','60389','76329','61183',
                          '14322','78898','88146','85579','96623',
                          '69973','78046','33967','45433','72095',
                          '81063','92137','63102','72683','94938',
                          '81084','80705','49323','60892','57748',
                          '47020','33511','64141','63379','53874',
                          '21413','37840','67883','85738','46359',
                          '26459','86524','28727','90479','84520',
                          '34472','39213','12796','80314','70719',
                          '19694','74544','77385','38744','39036',
                          '27209','54933','80811','79361','53962',
                          '36071','54350','56131','19949','63575',
                          '43600','80078','56574','81185','65735',
                          '58482','87684','18748','25797','65584',
                          '89211','11729','49897','60018','74788',
                          '41395','31050','60419','59974','95784',
                          '83685','79413','41228','72785','64739',
                          '93044','38229','71099','33608','62333',
                          '73658','37748','67345','57293','75988',
                          '57333','31300','65399','70313','48209',
                          '95828','98512','28376','35767','27839',
                          '91815','51845','40527','59063','29217',
                          '39487','20043','35170','39401','66668',
                          '93331','19711','87382','25496','74938',
                          '50301','83388','75006','72107','86931',
                          '23083','89993','72214','89455','96956',
                          '67977','65402','68963','80077','73402',
                          '37274','61044','95037','35867','86727',
                          '20356','41222','83410','87749','78737',
                          '77501','45233','47384','45278','61420',
                          '54926','38154','88574','47715','24511',
                          '61881','39235','16137','28124','19660',
                          '58298','49933','70031','55129','19356',
                          '73780','94512','93382','75833','88604',
                          '89477','43329','52118','71778','14622',
                          '61103','39343','69756','67089','38319',
                          '69336','52056','56640','34204','52090',
                          '15100','79530','84740','54112','58171',
                          '96979','85576','62451','81332','34710',
                          '78689','52853','20262','36607','19155',
                          '54379','61104','48724','92718','97731',
                          '38795','23148','20165','40576','18021',
                          '19922','57255','53558','49916','96358',
                          '95529','42112','53272','76043','53175',
                          '11442','27929','98273','46693','63310',
                          '95017','86859','33768','56821')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


