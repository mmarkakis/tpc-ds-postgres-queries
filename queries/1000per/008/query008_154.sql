
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '12103','13722','10621','37622','38267','80339',
                          '98624','56157','89676','67653','75576',
                          '53193','62530','21606','24832','65626',
                          '73927','88255','93110','43172','64848',
                          '79021','69814','10426','79850','11161',
                          '44624','10327','82263','55202','89048',
                          '14215','49130','39394','45975','44762',
                          '94508','33583','18873','76202','45137',
                          '66740','26626','54585','69125','23539',
                          '75958','43448','19410','99109','68038',
                          '63392','21524','95762','13933','81539',
                          '78394','39188','30910','55571','22283',
                          '51710','82387','70761','80620','65507',
                          '13097','75638','67620','82508','46989',
                          '53131','15850','88748','79335','71878',
                          '17736','86668','49173','22403','56623',
                          '90076','88520','65264','22146','84457',
                          '48935','63442','41645','86266','79731',
                          '19580','30749','60493','61838','56925',
                          '27142','84622','45103','10936','17447',
                          '52598','44954','70798','45229','52874',
                          '44028','68295','40160','89841','43857',
                          '18302','68456','75986','16309','79334',
                          '51656','67016','94530','12142','57859',
                          '94217','85971','59452','84769','39009',
                          '49947','52618','33857','21256','63446',
                          '54889','67006','52564','90473','68844',
                          '77877','36531','43670','88543','21599',
                          '26218','49623','99235','29574','65205',
                          '58912','55497','30614','33442','49767',
                          '47128','71082','60067','79340','38580',
                          '87520','91420','57842','62042','50608',
                          '94517','68684','21698','73675','64508',
                          '49228','96074','11707','61074','88944',
                          '17334','29369','27105','71970','82434',
                          '68758','56337','16246','47190','87386',
                          '37721','62383','43437','71856','35032',
                          '16902','58666','98043','90201','76313',
                          '55189','97884','49179','48170','26364',
                          '79796','23066','41193','96575','85222',
                          '17848','68842','60808','56868','32859',
                          '33498','15871','35777','54269','19032',
                          '54695','82498','34019','89796','97072',
                          '97947','28352','21705','91096','16984',
                          '88243','21373','44006','87117','64072',
                          '90619','19845','99504','29920','18941',
                          '95963','75467','93484','24935','71295',
                          '38942','52510','73783','25908','41730',
                          '85819','21518','94195','68232','96160',
                          '84957','38873','47299','52030','98379',
                          '77482','30457','25018','64089','12392',
                          '51577','75106','86776','96222','95754',
                          '58718','16926','16069','62300','64501',
                          '48431','48454','34366','58488','64816',
                          '10961','10909','69572','30761','62314',
                          '14878','22541','77326','45258','62090',
                          '35716','69537','38552','56564','46411',
                          '44718','55459','30357','92907','19909',
                          '27380','87674','53685','89509','41401',
                          '47487','95316','48182','88073','52212',
                          '88426','25663','82750','85228','27727',
                          '62477','53003','76413','70435','97127',
                          '40474','19373','70760','91305','22035',
                          '97648','79217','71292','78989','22126',
                          '84340','36162','78262','62135','23893',
                          '87197','60784','56330','61334','82834',
                          '31874','27818','14408','94743','34738',
                          '36264','79829','38370','70613','37114',
                          '97235','31715','74166','15660','75327',
                          '78312','93011','13013','69347','84743',
                          '63217','22195','91351','90440','71796',
                          '27625','14105','18260','29047','11742',
                          '40056','19409','12955','96583','98074',
                          '72887','10739','79222','64144','30821',
                          '43019','93921','66428','10501','23142',
                          '32536','30121','54734','95486','66391',
                          '38717','66884','36867','41351','47603',
                          '48611','28700','62587','28987','13091',
                          '43497','83810','84582','89298','18863',
                          '90851','29451','46721','21015')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


