
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '10999','46363','95310','13932','83245','51504',
                          '87196','18372','89851','77506','92192',
                          '58900','35853','90552','46177','90790',
                          '24730','79089','49349','47153','33804',
                          '73970','15332','53904','56841','25082',
                          '48715','16436','36947','86062','11890',
                          '54173','95934','68374','67217','19760',
                          '88824','19723','40114','34924','69421',
                          '55432','10730','69637','48591','77331',
                          '78296','25805','77836','46455','49835',
                          '66042','24346','13625','60697','86924',
                          '79665','14472','32020','76260','55924',
                          '54415','94774','40533','63398','54066',
                          '41528','26992','97182','70815','51935',
                          '76419','72150','75042','70011','33553',
                          '99754','67893','11894','60939','35019',
                          '36075','12641','29358','68728','67840',
                          '20360','24893','39845','90687','22455',
                          '66451','43376','14847','82380','57088',
                          '81870','14620','50626','46528','32660',
                          '50340','59837','24639','48899','11743',
                          '18936','24023','33462','42907','54904',
                          '79605','49458','69541','20955','95965',
                          '56705','33250','78644','80937','12280',
                          '61486','44309','60056','80642','65181',
                          '92726','37005','65112','48678','82712',
                          '97274','14643','16620','85010','55917',
                          '99975','39127','13733','59581','26029',
                          '61831','66082','81585','38433','77733',
                          '16463','57961','25552','57443','75858',
                          '41918','55314','79857','97802','48398',
                          '66556','74402','81716','59639','36620',
                          '40478','87697','56897','75335','83253',
                          '87317','72052','46818','69707','47122',
                          '76397','11340','36767','39348','82279',
                          '94140','93118','34012','25988','69725',
                          '16571','96853','25681','29609','59101',
                          '95323','84542','63642','73192','64963',
                          '19130','33358','97804','43099','87533',
                          '99386','65583','45183','15482','95485',
                          '62675','80105','28964','70431','70370',
                          '78968','26963','96268','20128','35479',
                          '90446','66412','81411','27041','68422',
                          '38513','44572','59428','82617','26552',
                          '33326','14234','79666','26167','92825',
                          '44710','81665','75122','32421','77712',
                          '76864','53696','53169','80338','35039',
                          '89953','79590','71714','70393','30582',
                          '88828','56267','81436','27790','79287',
                          '51441','81269','90594','26490','75559',
                          '40337','15886','63247','99089','90730',
                          '40796','41347','49648','25287','19779',
                          '78814','25516','71553','21055','59504',
                          '57277','66450','80114','79238','49462',
                          '85077','66307','18550','58104','66865',
                          '22431','34400','40209','25883','41904',
                          '46481','80694','81485','38008','38575',
                          '34369','68751','43801','24483','26258',
                          '70270','14413','33467','81700','80407',
                          '53668','21536','65661','96044','63786',
                          '80706','39703','48681','75232','10339',
                          '11402','49744','16665','74986','20857',
                          '78360','93963','61456','57605','77019',
                          '33418','81571','29666','21298','61019',
                          '54383','62736','70419','34920','88268',
                          '77179','16255','33563','94798','93599',
                          '63224','73263','76874','45016','90933',
                          '25807','57360','64316','27978','53279',
                          '19116','68306','54497','71855','95588',
                          '61322','51804','13570','88636','64530',
                          '88261','38226','67886','65195','78908',
                          '20091','88842','76001','61217','63882',
                          '55696','83003','11943','42468','76033',
                          '33055','44889','78858','88710','33510',
                          '71255','49890','79791','72592','44935',
                          '28829','45384','60062','20388','19423',
                          '79168','29119','72503','80582','36848',
                          '62529','13489','61014','78645','25560',
                          '69942','75231','26300','48556','79474',
                          '60318','89264','23806','42817')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


