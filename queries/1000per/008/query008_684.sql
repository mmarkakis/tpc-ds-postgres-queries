
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '37878','30883','78335','43642','14044','94754',
                          '32000','30198','77660','87128','37354',
                          '26124','15260','15802','19696','62669',
                          '48759','17427','97154','17171','28416',
                          '45520','72604','65366','20936','86426',
                          '75424','36167','22189','54471','38931',
                          '80889','84697','78929','81160','75632',
                          '62834','54214','38274','82523','15781',
                          '72562','42740','79520','90386','71277',
                          '10673','74283','78994','21738','71011',
                          '78476','18302','36765','57060','54831',
                          '36865','14657','86675','23203','61522',
                          '26903','29538','85693','95348','75317',
                          '48754','77788','40809','58235','84042',
                          '94327','46514','35500','90719','90237',
                          '43241','64932','12363','11250','90511',
                          '49453','41694','91695','51516','20228',
                          '72476','21471','24255','41848','28333',
                          '70653','11943','67948','97317','92900',
                          '46819','64724','25344','16132','43681',
                          '73808','24656','12953','53449','57917',
                          '53523','36715','62420','23694','76874',
                          '69982','70488','53104','86753','18564',
                          '52812','39363','83504','54494','21051',
                          '13265','87220','68443','57962','52822',
                          '69544','66729','58936','66320','27811',
                          '39620','27630','99180','25220','50733',
                          '29223','39891','97682','81168','44680',
                          '72715','61157','69564','14689','48215',
                          '37293','80849','26851','19216','30965',
                          '99998','65339','81799','67968','87095',
                          '71275','16250','38517','27112','65216',
                          '62216','84961','28152','34786','14811',
                          '29968','99579','79382','84662','47523',
                          '78419','14120','93391','68605','98435',
                          '52153','65557','81967','83807','15552',
                          '51598','98754','53961','26915','11568',
                          '97803','18600','62352','30210','72007',
                          '14528','49545','52053','25699','93919',
                          '14116','15257','48150','15739','45293',
                          '72874','47195','10383','92715','42217',
                          '34556','22490','47177','48882','79212',
                          '48656','82542','45203','64484','83266',
                          '62329','63425','61851','24375','43958',
                          '14505','34389','28451','13507','65062',
                          '98838','75525','97562','23404','92601',
                          '79963','66621','30599','18547','76918',
                          '29906','83439','13859','52512','24826',
                          '17009','42990','14891','84404','77432',
                          '20897','72390','38160','99046','54632',
                          '81725','50398','72801','28816','17981',
                          '55500','28786','73421','62614','80827',
                          '54143','48534','72527','24226','64705',
                          '96096','62404','38970','82599','91062',
                          '32541','74610','52882','56216','51555',
                          '42094','58450','39058','18944','49710',
                          '45818','63651','69713','25424','81259',
                          '42522','87808','96727','19359','98252',
                          '63350','26298','54433','51609','54717',
                          '98105','50310','24680','33409','78817',
                          '13116','72298','79759','12099','10446',
                          '27175','64634','49178','36621','82378',
                          '24785','68533','62840','26182','47733',
                          '66080','28545','58367','75568','65789',
                          '90842','74376','38882','73147','41445',
                          '99121','68599','26861','50921','30283',
                          '46450','99849','23638','79838','14336',
                          '91052','23061','95041','44085','97408',
                          '12627','16070','38559','60515','48265',
                          '84695','15675','99043','65068','87531',
                          '26619','78773','33955','93133','83658',
                          '47221','78644','84218','89055','12777',
                          '12753','19316','72770','92737','28246',
                          '74901','11709','19436','51399','32704',
                          '84480','93668','59563','40251','87049',
                          '24402','41737','61355','39428','88514',
                          '10188','95508','27563','79711','73387',
                          '43597','77608','43135','74551','87716',
                          '49086','91225','45548','10879','13658',
                          '40596','63239','44328','41764')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


