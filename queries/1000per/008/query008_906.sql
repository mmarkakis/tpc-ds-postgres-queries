
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '23736','13229','73160','30715','84565','24293',
                          '70266','48998','18145','39619','96838',
                          '25484','40299','36429','43810','29683',
                          '62652','87263','39846','22245','17883',
                          '92811','96703','43303','96013','12266',
                          '81369','82683','22676','24389','35854',
                          '44793','96299','78694','40987','21997',
                          '36509','64845','90957','66225','39542',
                          '43174','81469','65999','54103','37603',
                          '45783','87181','63013','57320','26992',
                          '22451','25185','46775','92102','97000',
                          '45379','49964','18956','46527','14873',
                          '83922','59610','38473','69206','88015',
                          '12431','72422','36775','35179','51674',
                          '62653','90034','87824','43927','96739',
                          '41586','79105','83662','51688','97701',
                          '37897','13199','93547','76435','38970',
                          '77518','96778','91908','48877','50103',
                          '36694','21768','55631','68342','25232',
                          '52128','43409','85828','59282','56338',
                          '81931','65512','62436','37307','70209',
                          '45513','51654','81170','47993','21456',
                          '49959','39206','87848','83711','25037',
                          '52955','32511','93788','63349','50582',
                          '27796','54528','45579','91439','65886',
                          '24597','63403','68093','37120','98446',
                          '25265','71613','48677','83225','26211',
                          '41772','90219','19814','94523','64164',
                          '99140','22318','64353','75309','66495',
                          '32477','51425','58066','67264','87579',
                          '66592','56102','53972','15887','60729',
                          '57259','62288','39641','74946','15139',
                          '65817','71411','40648','32480','59589',
                          '15565','38906','71774','68622','77293',
                          '43660','52531','92468','17514','59267',
                          '72350','58246','63929','99814','57541',
                          '70739','26082','79405','97013','10799',
                          '84049','12877','29771','26863','88496',
                          '74898','49910','84201','90415','29297',
                          '25453','99739','23910','38902','54327',
                          '86868','78610','15781','96263','93464',
                          '63549','49614','52710','28866','59933',
                          '89099','63706','85902','59334','70478',
                          '15038','25946','38238','34858','54030',
                          '82269','22873','95751','89965','82971',
                          '36250','29883','35043','98896','56261',
                          '15637','86102','96347','40194','31004',
                          '83540','89293','94525','70141','61102',
                          '94181','57853','25960','40737','55890',
                          '28494','74580','33051','37924','93553',
                          '76165','74965','70973','75513','60256',
                          '57379','49581','87491','54288','88925',
                          '12344','22001','19832','28456','69716',
                          '60071','72340','94164','82353','43506',
                          '59447','37797','20086','12325','25701',
                          '27889','46221','30473','41182','30367',
                          '72460','50875','75539','65468','86490',
                          '89708','25118','98488','44542','91410',
                          '73184','15160','97833','80789','43958',
                          '80972','86391','26227','94195','84444',
                          '45421','46136','67092','57658','77716',
                          '87291','58766','51307','95573','38642',
                          '54853','52663','11270','64198','99992',
                          '74670','36796','94467','96908','21719',
                          '64759','22023','24304','87463','82107',
                          '21586','43417','99733','19503','30734',
                          '37785','59602','64726','12254','60880',
                          '76317','31347','14533','15730','37184',
                          '27497','67481','65767','27713','32003',
                          '50581','44336','66464','98812','40521',
                          '71432','32905','28655','12832','31694',
                          '39393','32743','17498','78670','40615',
                          '10639','46314','92681','79646','34597',
                          '66386','83648','97795','24191','18420',
                          '23387','37261','43814','77750','83416',
                          '67276','62801','40348','74798','54074',
                          '96637','96159','19430','45516','86330',
                          '32076','26794','68351','60113','55069',
                          '76602','17559','22374','76466','54609',
                          '84924','99779','89637','17134')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


