
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '62223','28325','49674','32651','72355','20250',
                          '68255','81587','37217','40549','69334',
                          '93986','22261','69736','11266','79663',
                          '64802','13459','40854','44493','12753',
                          '10133','78752','58226','33417','95174',
                          '34173','63031','23199','91584','20049',
                          '54252','43035','68095','10212','60918',
                          '45649','14036','27713','19398','36442',
                          '86978','80189','30414','16041','59047',
                          '65354','32011','57230','56838','27948',
                          '41411','42555','71812','34079','39344',
                          '84387','54339','64594','11086','72007',
                          '98634','27056','60795','61161','24672',
                          '36789','26606','51157','29243','61004',
                          '47860','40482','72404','45870','64776',
                          '43169','44663','73994','81687','26821',
                          '61412','84422','66489','62959','71147',
                          '45533','23239','84611','54289','32744',
                          '16735','84524','48519','35745','60745',
                          '42643','26123','98186','33559','78094',
                          '92182','93578','15321','83235','27895',
                          '46198','68207','45828','24491','91380',
                          '88534','99153','79234','14342','12322',
                          '50896','54304','75108','47421','55401',
                          '24702','37384','81393','56547','66146',
                          '58965','27640','58383','66726','17737',
                          '42865','49962','32575','19654','46032',
                          '23178','19807','76127','10655','88869',
                          '80564','85312','10630','11349','22721',
                          '95325','18157','95636','71215','38897',
                          '36457','10936','22294','64356','40615',
                          '15793','45137','37300','46323','69143',
                          '63616','43005','29535','98038','68450',
                          '99674','80617','22716','57868','15066',
                          '39766','24101','59275','64079','14927',
                          '87199','13734','44070','21233','98797',
                          '93884','93159','31453','21756','18414',
                          '68009','87007','59654','41384','53814',
                          '20673','21651','98465','55810','82700',
                          '88749','22572','97071','39087','28834',
                          '23255','61623','25615','77460','55918',
                          '53776','92382','83050','64523','85313',
                          '14323','75495','55640','97743','41065',
                          '90767','63158','13017','17190','93687',
                          '92110','42282','86199','92326','62219',
                          '86358','36551','11968','34848','83658',
                          '16270','34431','86559','63353','68727',
                          '58621','10605','77249','13667','90067',
                          '26094','64422','76980','44299','30169',
                          '30016','54284','73356','45821','38302',
                          '74317','99364','36032','32662','39698',
                          '76081','55723','80616','36105','99407',
                          '84199','18975','71092','92707','51027',
                          '66852','26675','79263','11250','88081',
                          '37947','49310','77021','35455','60709',
                          '55845','57461','71866','36954','50155',
                          '97517','96709','20462','86194','38124',
                          '34048','12366','90298','84215','42908',
                          '53998','18572','42688','49937','31924',
                          '34265','34156','89871','63264','13506',
                          '12834','33943','85429','28783','26499',
                          '95496','58460','42427','38137','75525',
                          '29687','90977','73207','93949','83850',
                          '71063','71194','98841','18594','47122',
                          '64720','55415','17872','88183','66948',
                          '91874','48262','98582','18488','65696',
                          '28214','72173','79937','35658','58655',
                          '93930','29839','49124','33814','19037',
                          '27487','49639','12011','65617','26764',
                          '19462','84597','45387','69006','69886',
                          '87382','60454','66396','83232','73288',
                          '20790','30730','20092','63551','81677',
                          '13896','65239','33630','96368','38410',
                          '33549','36223','86781','51661','59843',
                          '60535','55104','94204','30247','43973',
                          '17394','76791','73324','57636','31337',
                          '82465','90788','64471','50639','61580',
                          '88627','30406','69680','37639','48581',
                          '87115','96884','32827','87174','87832',
                          '31327','90740','92630','98886')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


