
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '40902','23075','92370','50772','39711','74826',
                          '59795','17681','25419','74956','90241',
                          '29244','23555','23287','43991','17076',
                          '68631','59042','38053','10678','48270',
                          '90909','53642','30921','82307','34104',
                          '38189','82405','75631','84761','43279',
                          '36277','73793','49755','10197','72904',
                          '63594','93047','92937','71912','27633',
                          '35689','35061','55444','79922','38824',
                          '89704','98485','51917','16601','38383',
                          '61990','54773','21117','70699','33458',
                          '35778','66420','90625','95295','92308',
                          '81465','84881','82848','67257','36016',
                          '56823','72003','56892','78706','44980',
                          '96652','71998','70010','76073','46094',
                          '35724','62036','72688','16102','62874',
                          '24039','50058','87911','54677','71272',
                          '64810','94160','29962','67137','29958',
                          '44765','99289','55586','39204','82222',
                          '74382','21494','77909','19362','16006',
                          '63913','88759','17506','61319','81758',
                          '43487','14266','87267','20913','21853',
                          '88837','30488','17302','86210','50757',
                          '50761','94938','96209','25345','71957',
                          '78608','48416','19914','89329','46330',
                          '13613','12593','57043','59774','77632',
                          '36453','25119','76209','34776','85052',
                          '30377','24305','89482','25053','28870',
                          '14500','46941','89262','63447','29644',
                          '90600','53958','49636','21408','40189',
                          '70322','59062','46588','66570','59236',
                          '52512','75647','58171','95016','52988',
                          '62664','22620','77148','47716','16057',
                          '72655','55552','46188','52175','76555',
                          '60317','14513','97572','94029','65500',
                          '26635','54852','66647','71899','16673',
                          '40597','27613','43768','37524','11541',
                          '64993','34086','63138','38160','69834',
                          '85544','96155','38276','10267','84725',
                          '47646','43620','50227','54208','73179',
                          '11929','30210','51006','68023','64941',
                          '78714','62906','94461','55639','67925',
                          '80634','87453','70886','79798','68794',
                          '30656','37850','11162','12641','24149',
                          '49457','95720','68669','12957','75071',
                          '20716','96880','21201','42995','41506',
                          '54344','12634','23138','73215','29765',
                          '35226','29412','38667','54082','24153',
                          '69871','62241','85701','68866','63582',
                          '48209','44775','88280','82029','14531',
                          '19684','35531','89929','84035','94151',
                          '37553','11526','58419','75866','95595',
                          '32925','62960','31063','88180','71769',
                          '96662','97829','80871','63060','48692',
                          '17401','16199','88078','39969','79321',
                          '27265','22165','42461','35672','98699',
                          '76286','37134','85574','45592','58592',
                          '76093','22627','61179','94273','32341',
                          '35461','32845','86645','39736','18333',
                          '85750','11125','74034','80164','67950',
                          '21481','30306','95650','84309','88130',
                          '36749','87431','38701','76967','75522',
                          '32397','18904','46845','61746','16217',
                          '89570','78238','80040','61246','71892',
                          '47764','75362','61299','46639','45718',
                          '87172','64116','79575','22001','58073',
                          '91798','57144','71276','90058','85594',
                          '16927','11341','72070','10528','86450',
                          '50780','93040','24877','62376','29848',
                          '46148','15229','92240','90584','28233',
                          '17385','33114','31016','77465','89338',
                          '67336','50127','88706','39107','76271',
                          '90116','72971','93974','48748','78623',
                          '26615','51980','31730','90507','84906',
                          '48619','16322','51564','10034','72501',
                          '77810','96586','73803','29032','83144',
                          '75248','33060','85252','61749','18943',
                          '96125','86176','96977','71666','80620',
                          '52579','20847','35787','45163','92869',
                          '46239','21854','82229','12043')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


