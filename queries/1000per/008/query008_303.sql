
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '61275','27814','65971','23911','35021','99243',
                          '18812','42328','27107','48169','13110',
                          '81018','67502','79378','81393','63878',
                          '46414','51358','26962','65637','23212',
                          '37756','10310','89165','17524','37368',
                          '53041','73875','94783','13023','56128',
                          '67856','39645','32780','70109','58910',
                          '25793','31165','24896','42840','54349',
                          '22993','29791','87492','32511','47145',
                          '61966','85401','19402','70533','38817',
                          '88104','71130','12082','16269','22923',
                          '45601','27174','69841','36574','61880',
                          '79360','96223','68026','95528','91048',
                          '96308','83213','55802','99643','27079',
                          '51537','69544','30807','69100','11402',
                          '68836','37400','25770','28910','20096',
                          '54398','32148','66416','62264','70513',
                          '44298','39732','89412','82631','19634',
                          '99595','22007','91781','72874','73953',
                          '37377','92317','56719','60207','45929',
                          '94534','83112','31125','35242','81347',
                          '46032','85421','47010','72435','90293',
                          '95472','31103','91790','54049','46558',
                          '57607','14075','45432','17438','84822',
                          '78287','71343','21492','58142','14935',
                          '28283','60736','55317','68481','70314',
                          '42969','75615','80664','56027','79609',
                          '70848','69976','67243','16779','91078',
                          '84959','61879','22406','42976','65591',
                          '81378','94844','83191','88346','59248',
                          '22188','45582','67228','96671','38231',
                          '53849','47095','43161','82724','50515',
                          '63656','48942','88437','78181','60018',
                          '44267','37855','32491','87349','40756',
                          '63765','67926','86562','36879','51255',
                          '63670','49996','86015','88545','49625',
                          '98858','22847','84777','13651','27048',
                          '10458','82489','29305','19174','80652',
                          '63266','65412','36587','16860','95544',
                          '43843','70651','17763','51733','42508',
                          '62702','87727','74913','89684','84585',
                          '98709','99779','71522','27416','70137',
                          '99463','36116','15860','25657','74763',
                          '10367','95845','16350','30000','63270',
                          '47723','37507','34884','89414','35367',
                          '64978','25510','66722','52049','71762',
                          '82380','93869','83952','80053','92009',
                          '46872','87807','92105','63808','10563',
                          '75512','39542','20200','80334','53404',
                          '69539','35624','24036','40892','52773',
                          '59866','54092','47893','37032','92723',
                          '65801','62037','32558','16496','73625',
                          '29918','98780','73085','85351','71299',
                          '14882','56867','11670','25921','41725',
                          '21239','56752','10543','37222','90544',
                          '18511','61709','69565','23232','16345',
                          '14277','83988','68375','18930','74750',
                          '61760','42441','11769','53781','50780',
                          '49070','32138','68722','35132','56810',
                          '96918','87829','70027','27423','43128',
                          '63027','16061','48147','47796','17264',
                          '56727','80952','63730','58124','43170',
                          '44377','87113','93815','96217','79446',
                          '94218','17475','15646','29478','25191',
                          '67435','77429','67693','86340','17019',
                          '92859','61758','80948','68225','47842',
                          '11226','36994','74018','43293','54499',
                          '60294','64331','99365','81337','78978',
                          '82893','42261','68132','22494','15128',
                          '22612','41693','28374','67749','86984',
                          '78727','94484','23702','42563','16082',
                          '77926','66535','12228','36846','18061',
                          '14913','99931','99255','55357','63079',
                          '45117','65780','62038','67509','81990',
                          '41976','14474','93220','27104','66724',
                          '28010','71434','48457','44358','86085',
                          '96284','33253','22778','97160','33495',
                          '22524','15571','60740','13737','14973',
                          '64911','89097','98685','75205','57687',
                          '74727','15586','12960','37307')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


