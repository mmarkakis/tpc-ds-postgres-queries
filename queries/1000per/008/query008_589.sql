
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '46619','63105','95234','93168','59095','43250',
                          '27286','33722','13739','46721','10105',
                          '68420','31011','21267','31491','96428',
                          '63623','23009','98959','82311','88601',
                          '26844','49539','88560','10854','52477',
                          '82519','23975','91186','28321','31729',
                          '50398','26545','78390','32787','81265',
                          '20463','10793','99807','96395','23163',
                          '71003','41595','97172','58795','32611',
                          '70209','35732','89860','88653','98410',
                          '49355','45307','47468','59543','92793',
                          '65127','92514','25120','54095','59756',
                          '87377','65824','98758','10760','55832',
                          '43966','23714','25265','16783','58366',
                          '70582','16658','33750','49169','77950',
                          '66887','72681','48702','21845','80433',
                          '63078','74673','61873','15368','10848',
                          '97196','49231','56585','48269','38888',
                          '69508','53518','37785','34108','43914',
                          '51668','60912','41759','58754','28517',
                          '88122','63377','69299','54357','34075',
                          '16147','31901','13515','27439','78158',
                          '98549','78199','49066','54783','64172',
                          '35250','77227','13439','63596','78354',
                          '79349','89507','99597','13976','65787',
                          '92286','16846','28143','96403','15247',
                          '78312','23204','81584','52494','74484',
                          '80185','78294','58490','42601','33484',
                          '31315','14901','85778','20937','72052',
                          '57872','53146','76508','90103','78041',
                          '20732','18034','68080','42225','30834',
                          '87923','40280','16207','35284','74515',
                          '41035','15419','31712','42968','49525',
                          '12572','50731','18796','57108','66315',
                          '53567','18879','80401','92108','44090',
                          '23386','58396','49964','32252','19565',
                          '38765','79988','38880','83291','63940',
                          '92143','10118','13666','89548','42910',
                          '41742','16828','71803','63666','14717',
                          '60265','90490','95631','64367','22513',
                          '96808','27007','47266','27976','61613',
                          '47786','87161','27667','97663','68644',
                          '92583','80438','82659','53134','37598',
                          '76190','90148','18524','14870','75504',
                          '60669','64780','38123','98102','19175',
                          '55288','90380','13735','85138','42269',
                          '93978','58178','39211','38841','35157',
                          '26090','26735','56067','85865','58438',
                          '50632','38022','91890','66513','15033',
                          '31601','27736','90427','47920','70378',
                          '70687','30230','37639','89247','46977',
                          '74035','45906','42010','46202','48367',
                          '56758','64333','15761','13523','13595',
                          '50510','83917','63733','40380','31127',
                          '54649','80016','59959','90129','92504',
                          '37035','76585','53647','49250','31019',
                          '21032','14725','59652','34529','78191',
                          '38757','95352','70642','77145','99686',
                          '29954','89856','49059','97414','17277',
                          '77613','84430','79775','51939','16359',
                          '86544','94367','78908','42252','20969',
                          '45834','92625','47626','58222','16223',
                          '62007','91118','49486','64499','54766',
                          '74196','69724','71606','65282','30520',
                          '61104','77098','84130','14512','67833',
                          '76825','24308','47908','68697','90185',
                          '42491','85145','17943','55071','20772',
                          '86873','91523','58757','17332','74145',
                          '56807','71698','56972','16477','68833',
                          '39856','52683','66827','84270','17558',
                          '48336','43479','20954','77313','36500',
                          '74704','28431','55155','46372','32921',
                          '54278','99073','77966','51573','70346',
                          '45770','16460','93955','60156','99061',
                          '31190','14379','17328','79146','38550',
                          '36799','41008','15923','10644','14220',
                          '35783','22599','86924','89622','38985',
                          '16558','35017','76577','22973','41046',
                          '88292','12932','43868','91253','63792',
                          '88450','86820','39878','20351')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


