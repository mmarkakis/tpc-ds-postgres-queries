
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '84866','93843','15967','67455','31289','42656',
                          '35705','64668','99373','58009','48392',
                          '91374','80889','83137','84409','31185',
                          '38677','19654','45758','57485','96443',
                          '49973','92736','59480','84633','22913',
                          '18042','83861','33751','90309','97106',
                          '46561','68873','62362','40280','49687',
                          '13874','45853','35162','23211','60735',
                          '70112','62522','72726','30244','29546',
                          '94757','40067','34266','31170','98831',
                          '88368','11108','21467','41513','20513',
                          '55581','98728','82587','86216','51233',
                          '16081','33778','10810','13265','19468',
                          '81377','95223','60376','26156','95604',
                          '82047','76307','67349','88006','17742',
                          '99952','34954','18663','96411','75871',
                          '13660','41134','49323','45840','76479',
                          '12694','82497','72634','21052','38109',
                          '26743','88557','10628','93082','72120',
                          '27263','78037','46410','52864','98141',
                          '29119','27804','51527','88936','60842',
                          '98453','19446','85656','10876','40551',
                          '25557','63291','77651','55487','40310',
                          '62117','74082','10382','67490','66643',
                          '54121','48680','89499','40473','83846',
                          '75667','70535','17385','89588','71791',
                          '49449','39362','68679','21347','13657',
                          '56146','62717','60541','23372','41424',
                          '13049','75774','37443','11324','51847',
                          '93047','78867','36024','69810','60955',
                          '57863','69854','16573','35313','56650',
                          '23208','79217','38389','53023','31750',
                          '99978','10121','89895','23760','72995',
                          '39001','49534','51114','47532','99268',
                          '48875','29029','48712','69964','92227',
                          '26898','15048','79178','62785','63739',
                          '66792','46367','70313','72753','83780',
                          '12403','68780','42311','70917','40501',
                          '57027','24642','96741','40441','36227',
                          '87558','11738','94002','94787','35894',
                          '17505','20493','31554','10962','77788',
                          '58528','63792','73191','57116','55190',
                          '19358','89199','53455','53222','86711',
                          '91579','94884','99137','10819','16476',
                          '23273','56097','33632','39873','11329',
                          '57770','44139','45706','82643','18420',
                          '17854','97301','97100','17695','37941',
                          '93100','29668','85904','36647','49388',
                          '60084','95109','80134','94390','73063',
                          '47426','32780','26374','16657','74349',
                          '28991','49343','74801','48948','28588',
                          '96940','28571','60346','98338','33569',
                          '11594','66020','91690','57415','85576',
                          '10627','16168','19976','79703','84325',
                          '96171','59602','15029','37788','62744',
                          '40188','86116','32239','17632','76386',
                          '60445','70740','86190','68063','35804',
                          '24896','80869','12050','56854','33836',
                          '19143','38231','80503','55225','56080',
                          '49393','69050','74743','81156','76552',
                          '15277','83661','48551','22953','20874',
                          '77276','19783','82054','69277','39697',
                          '74472','29894','49273','92690','59648',
                          '10748','34707','24247','66246','11757',
                          '16859','73839','75387','62081','82273',
                          '26938','59848','86187','56755','50171',
                          '41076','69055','20640','38900','17757',
                          '12211','83056','81790','39009','66610',
                          '59998','14158','25658','95789','22869',
                          '97736','44966','89144','45649','70893',
                          '98009','85114','47234','77019','24060',
                          '51968','41876','34750','48142','70950',
                          '88468','11142','26750','72757','92489',
                          '88884','87802','50019','75444','11363',
                          '23507','10473','29607','52744','42441',
                          '95068','80179','87647','52972','60253',
                          '49758','44675','60443','34063','26105',
                          '74337','11325','74607','31587','98899',
                          '10582','54712','15888','96955','20309',
                          '15720','13986','56686','41893')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


