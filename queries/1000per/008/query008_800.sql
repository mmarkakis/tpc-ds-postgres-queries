
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '55562','33805','41445','90540','25466','66364',
                          '16674','93043','41255','38665','68744',
                          '29761','55688','72232','38335','13357',
                          '25518','70928','38458','41972','93573',
                          '31387','64060','74524','60973','79630',
                          '62061','76358','93220','92491','73106',
                          '66687','96891','22991','51333','20165',
                          '89196','14509','49578','45093','40152',
                          '12727','64140','49775','84190','55540',
                          '46771','34443','96910','78939','50381',
                          '67201','16031','71038','96539','82305',
                          '62272','84254','28431','97043','82212',
                          '24489','93026','96508','48492','49623',
                          '22899','87186','38752','93351','81755',
                          '91194','60087','69345','92265','14513',
                          '79679','81112','60096','71196','15050',
                          '25829','82167','66245','48276','68079',
                          '26863','15613','80274','96448','13178',
                          '15228','32370','56933','47927','75830',
                          '79228','15738','32308','71880','30895',
                          '10756','29930','72897','36983','29486',
                          '13084','47344','64012','72061','76859',
                          '45022','53021','87971','74048','85286',
                          '47936','84962','36969','68117','53164',
                          '64093','26591','83469','41262','70811',
                          '62487','52254','47723','71003','72759',
                          '60041','92467','49670','61081','41066',
                          '58547','16731','91590','35811','77481',
                          '70608','55166','99385','49126','12853',
                          '86823','46197','64772','27232','95308',
                          '98846','85953','46010','90172','90816',
                          '69155','57412','51677','38220','42318',
                          '47623','30423','95991','32132','60610',
                          '21929','80234','27771','74438','31511',
                          '88818','25769','55575','82348','67805',
                          '97631','70809','48873','31759','31650',
                          '54621','38677','67067','77300','25194',
                          '99559','68165','69304','66991','21489',
                          '60373','17736','20742','42652','21434',
                          '75045','30447','38381','95739','14289',
                          '47687','17124','80644','28127','68277',
                          '33866','47171','35006','35912','45258',
                          '32809','85753','89260','39355','62056',
                          '41613','13366','68891','96259','67010',
                          '18132','99144','79071','18525','35487',
                          '58585','80803','77146','37538','63907',
                          '62178','33809','43679','25637','39512',
                          '38603','10722','56434','98922','45207',
                          '97131','11194','10574','35753','14919',
                          '75010','20918','12820','35699','88699',
                          '89930','23250','69094','36049','27934',
                          '81203','92218','24958','84014','72863',
                          '20024','57551','69081','54172','62866',
                          '18385','31144','16852','27873','41386',
                          '43426','53542','50077','42730','31180',
                          '88092','25475','71243','17207','43400',
                          '10311','57262','88448','14949','40653',
                          '18982','37023','92415','20168','94933',
                          '87406','54809','53034','98451','16798',
                          '70709','64701','70626','49909','43003',
                          '83165','11658','74127','24671','21298',
                          '63165','18144','88217','64234','43187',
                          '47637','38443','28742','85467','16465',
                          '77003','30774','70164','14462','86429',
                          '58459','94882','91302','41258','38708',
                          '18171','46238','53304','84466','63188',
                          '44335','17084','87190','31699','50237',
                          '29439','21679','60887','35503','13054',
                          '56340','85038','88754','31372','53966',
                          '54901','27544','61449','22396','95250',
                          '71109','82163','44945','50624','78605',
                          '78667','38580','28179','33139','36026',
                          '61083','46422','14853','62595','49605',
                          '78969','47234','32850','67046','76596',
                          '82223','85154','27043','66742','64009',
                          '23005','16692','97797','97629','99132',
                          '62078','34418','72538','16819','54405',
                          '21136','39004','63798','14643','95410',
                          '34016','60561','55445','16472','91532',
                          '43674','70647','52454','59622')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


