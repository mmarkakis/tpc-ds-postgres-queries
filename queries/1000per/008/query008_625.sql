
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '15130','38248','61251','19463','73888','24766',
                          '41376','68659','99549','26611','30494',
                          '58016','64761','46606','58884','18862',
                          '89008','18345','24606','70090','69106',
                          '77484','87757','88022','45697','40717',
                          '55594','61362','90899','96781','86051',
                          '34064','36034','68129','44599','14151',
                          '43258','26845','10692','48379','94443',
                          '96101','31340','61404','80151','80096',
                          '62890','89080','23472','87301','10354',
                          '27889','88807','83939','97611','66071',
                          '34730','38587','79342','92123','72667',
                          '14658','41711','30990','67547','49307',
                          '40716','29549','79496','43153','43184',
                          '66704','95041','67220','84738','35140',
                          '47335','84191','44535','27294','23516',
                          '79419','26008','48234','92882','53496',
                          '21006','79003','66256','34749','71390',
                          '10523','31815','52104','72462','12332',
                          '60074','58003','91278','14406','36942',
                          '71990','41414','32087','29694','85611',
                          '76891','57841','92680','24183','99537',
                          '28795','48629','99778','53060','89625',
                          '65485','15562','36751','54355','84031',
                          '67528','40807','52125','58932','53748',
                          '14002','90575','77075','30257','27991',
                          '79053','38454','23936','76587','27855',
                          '81967','51822','59473','62313','93077',
                          '57488','28256','28457','43832','10132',
                          '39302','73357','44536','30616','85887',
                          '77643','41090','27280','42696','39446',
                          '14435','11426','50088','16812','10660',
                          '99387','42771','18037','46774','16103',
                          '97742','54773','51063','41787','99465',
                          '55716','52827','71966','68819','93722',
                          '70572','73309','74441','68960','55120',
                          '67306','35805','95711','61829','32513',
                          '41367','47979','29754','66063','37364',
                          '88127','95183','92017','42701','98219',
                          '68306','22827','34767','19777','67881',
                          '40391','11290','68264','56926','85224',
                          '26755','93544','34325','95510','77754',
                          '34070','85367','78119','38710','23748',
                          '73668','32521','16206','47044','75055',
                          '53032','32316','24178','59467','25107',
                          '88861','13472','77222','71950','27776',
                          '58398','85045','23843','95540','34281',
                          '23527','95096','58526','65396','63071',
                          '42076','69898','81611','67982','59633',
                          '13810','29687','64781','63781','48771',
                          '89231','19635','26433','34779','95668',
                          '21277','67916','23399','15054','21903',
                          '61322','98682','10785','91662','98773',
                          '89596','17477','55852','83512','91665',
                          '43944','77771','33867','36309','22106',
                          '81097','74748','60262','85999','74519',
                          '36273','83254','10371','58513','63906',
                          '55263','68716','85200','60502','66605',
                          '11769','58304','98169','92134','42555',
                          '94742','95199','82584','43820','35810',
                          '10434','69734','99322','64208','27082',
                          '72642','61142','11965','65708','80627',
                          '38745','13057','97522','57884','89413',
                          '62702','66111','41216','83731','87458',
                          '36323','61616','78237','25736','78476',
                          '79526','22418','74205','81283','41871',
                          '50872','15299','80970','75963','69350',
                          '22353','48100','38554','29047','55016',
                          '43441','52962','73381','71754','34678',
                          '13333','20767','62824','75428','16869',
                          '78195','84133','84353','91280','14370',
                          '28535','21808','20395','22803','33808',
                          '99466','45778','82473','56845','54725',
                          '50189','81232','80445','48190','46601',
                          '77342','45120','46731','77171','82697',
                          '23147','12354','21030','61706','57693',
                          '93717','74318','47242','33477','29647',
                          '88233','85590','95210','85749','63615',
                          '18831','29528','14964','98697','77208',
                          '20386','60980','44948','52486')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


