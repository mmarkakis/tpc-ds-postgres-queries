
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '55498','76974','56475','35011','61028','46257',
                          '60371','42967','28508','83698','26925',
                          '24475','69756','99493','40250','56666',
                          '77513','29251','88156','77092','14858',
                          '37891','14546','42117','75480','28804',
                          '74897','87113','50936','87485','93478',
                          '26339','22044','51775','34259','17960',
                          '90563','22126','74198','46208','91267',
                          '56554','40477','94028','64290','62799',
                          '94534','29960','74838','20321','43082',
                          '74048','37328','38665','85883','95479',
                          '15167','88417','18879','63766','78878',
                          '60756','80040','49072','18068','68568',
                          '90236','36802','51233','84006','98329',
                          '72125','18373','38635','24138','49881',
                          '52270','11275','41568','79399','87732',
                          '59708','96633','66449','28375','55054',
                          '35883','64226','12994','69958','32742',
                          '33615','34326','74230','78859','99974',
                          '90435','33993','14799','96641','70442',
                          '88012','81694','51737','96194','13760',
                          '65555','47443','60023','69819','69966',
                          '94375','99666','14756','20282','15588',
                          '47628','70656','97131','80172','18073',
                          '73511','35876','55092','44267','37887',
                          '20343','70029','61553','97468','80773',
                          '60424','42914','55117','15687','71224',
                          '71769','88255','77388','27700','20595',
                          '63419','33386','69596','76418','62363',
                          '90239','60892','65122','15120','20635',
                          '21978','47714','55877','24958','76758',
                          '29335','94379','23063','36972','45443',
                          '34380','68733','69187','84480','11059',
                          '43207','39533','46110','64478','20845',
                          '86311','92906','57244','61467','34690',
                          '38211','68089','95228','27290','55194',
                          '73529','15901','99834','14024','23160',
                          '99939','84375','92053','83908','21447',
                          '80214','10696','33004','38993','72698',
                          '17667','57934','60260','99427','57158',
                          '77185','41379','23555','43344','70881',
                          '48168','96588','89939','50404','43190',
                          '81978','95186','89897','58417','50651',
                          '44031','14050','87011','49179','85632',
                          '56348','76565','91078','72389','48248',
                          '23291','10332','73344','28336','46717',
                          '42834','97377','23064','61910','82642',
                          '88520','45961','74405','69028','79930',
                          '35905','68853','74225','82542','21535',
                          '36268','81891','40733','65870','94110',
                          '22052','21158','55599','88113','51310',
                          '34224','43016','34073','44695','81319',
                          '80850','17754','11414','11816','73666',
                          '20084','22354','28143','72295','56727',
                          '61524','40286','79155','16512','70483',
                          '10736','35649','46515','27610','77021',
                          '47640','39628','67330','94506','18891',
                          '19808','64886','50020','92376','71870',
                          '86209','49808','12110','71689','74194',
                          '89396','38059','11075','99370','93436',
                          '59203','11394','62434','62123','69043',
                          '25044','88653','25150','61149','49445',
                          '68968','46501','63204','20841','87632',
                          '98779','59532','81818','30741','14994',
                          '72561','99278','17259','75030','56491',
                          '57698','18577','71369','22259','77636',
                          '75898','12156','51039','71777','54275',
                          '14903','52950','11222','58954','56292',
                          '25136','75015','43290','29217','27010',
                          '63533','27281','43755','12183','41730',
                          '12000','38855','10636','55879','10457',
                          '97558','48183','97921','99693','49925',
                          '29694','87711','60280','37023','35541',
                          '84589','52651','52592','11107','44070',
                          '27272','93533','74757','24959','93325',
                          '68928','52960','75583','22351','80871',
                          '83170','38357','82962','34708','41253',
                          '15035','43596','46095','80617','53778',
                          '82195','90829','98818','17746','11485',
                          '37699','33543','30692','46394')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


