
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '54342','28564','53131','62497','56049','80329',
                          '49421','99567','89759','28693','14569',
                          '46067','98276','87305','13637','18406',
                          '63244','12518','58742','26474','45916',
                          '20401','45181','91938','91359','90741',
                          '83098','83987','11191','19688','89162',
                          '90689','68164','73572','62283','35307',
                          '12996','88665','69257','91838','36650',
                          '66945','56743','57833','46065','66385',
                          '58314','60235','58498','80904','92757',
                          '50327','49134','30991','27198','95486',
                          '82744','94677','70108','59134','11947',
                          '40038','77904','42842','35559','46456',
                          '66543','10686','29858','67143','36581',
                          '95931','56029','46872','73328','24231',
                          '49295','42372','19592','53717','83964',
                          '64546','63723','12836','11592','22706',
                          '46968','14497','95139','31978','13272',
                          '26904','78011','58753','83266','14589',
                          '94032','27678','82072','67809','42272',
                          '12640','40987','77204','56456','38763',
                          '96196','69529','40721','85145','62786',
                          '36817','67984','96310','51006','74452',
                          '92051','65462','86780','80250','88459',
                          '69681','59108','47864','98656','64735',
                          '36842','63357','17772','87750','64626',
                          '39990','53388','55139','41550','60920',
                          '28283','23360','49580','57142','85996',
                          '70719','85351','22598','66289','86541',
                          '27330','25274','78508','90312','40091',
                          '22730','21527','25139','74727','40069',
                          '84615','48933','72056','17581','77546',
                          '63155','42464','24129','89267','69278',
                          '45213','97294','26264','52697','40334',
                          '55006','99442','32764','91381','73801',
                          '27741','23985','83596','15317','80847',
                          '10541','56125','70963','46638','34300',
                          '11498','73124','54740','53080','19512',
                          '85934','33602','95571','90799','31308',
                          '87706','15775','98362','74234','64300',
                          '11458','89942','49578','70045','42870',
                          '78085','86119','27876','78030','17585',
                          '48417','44248','29714','41306','29610',
                          '27879','91497','67286','81036','15653',
                          '46600','87969','84500','44555','51969',
                          '23305','99475','20821','75050','84733',
                          '79698','13368','56714','44791','34666',
                          '87665','17983','54184','28510','92585',
                          '34307','31271','74493','44573','56041',
                          '11600','93325','99671','65273','11126',
                          '49924','25589','73518','23864','68174',
                          '71847','70523','75876','67396','43211',
                          '55931','56864','56583','26399','96557',
                          '33732','50974','79350','84285','80471',
                          '98256','87209','20421','74688','59961',
                          '12709','34946','47176','93632','24251',
                          '50443','17209','52445','81381','75355',
                          '33365','73688','18714','15377','40129',
                          '59950','94783','87114','13323','64940',
                          '59320','67719','26772','99057','74074',
                          '87080','94250','15657','64143','16639',
                          '88728','16080','42065','95660','31925',
                          '45292','51767','55530','71547','34172',
                          '35980','22320','89914','92193','22971',
                          '32384','87416','59508','50066','79457',
                          '63931','59162','42433','77529','52592',
                          '79462','53028','46394','50312','67270',
                          '21181','76921','69630','94382','53203',
                          '74247','81845','39550','79091','18142',
                          '38094','67501','15503','40089','39792',
                          '94632','38778','44448','52843','48888',
                          '92396','41417','49715','71261','20357',
                          '56887','60567','40741','40889','56738',
                          '56096','87588','27836','13191','18247',
                          '15428','13785','73875','32013','14934',
                          '92687','26924','86662','41837','79792',
                          '32224','88431','91823','41390','99404',
                          '42288','68361','22334','78039','17931',
                          '57919','68185','98786','60677','22700',
                          '20500','98146','18275','79337')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


