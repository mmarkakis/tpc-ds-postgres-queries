
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '88380','13462','71795','16418','98006','92415',
                          '62466','99055','94818','95322','45938',
                          '86912','94595','23490','85346','65836',
                          '65129','67365','31350','33203','42923',
                          '24824','28235','77653','12379','28462',
                          '97649','49048','87134','10694','81736',
                          '61068','87658','91235','84212','90183',
                          '34488','98221','59389','91161','45839',
                          '47884','37492','73663','17289','62876',
                          '31783','69521','48035','80834','64867',
                          '92466','69333','68984','23470','68964',
                          '79141','67044','22046','47090','63666',
                          '11602','83035','32908','46543','89985',
                          '36236','50169','66073','53851','46197',
                          '76403','49007','10603','75477','18029',
                          '23255','57312','58536','44164','81443',
                          '10072','99002','23864','28688','49362',
                          '33944','59687','66272','75513','96837',
                          '56132','65688','79107','48293','64859',
                          '51361','17536','27962','10504','28779',
                          '45777','85494','96009','62048','55567',
                          '66054','24421','25449','35198','21857',
                          '18088','82074','76597','19223','54674',
                          '68707','11089','19063','52850','93479',
                          '70874','29327','36925','77461','19939',
                          '66702','45005','85770','73230','90224',
                          '62516','70815','47650','21051','53324',
                          '23900','38697','19444','60746','14312',
                          '96866','70889','90862','15973','17048',
                          '52671','24303','45875','47757','11520',
                          '51982','59689','67140','15269','13917',
                          '76203','27997','91780','75821','91283',
                          '99148','13386','52693','81343','70384',
                          '89851','13666','52461','22684','17013',
                          '39905','37915','76642','62327','81844',
                          '21240','94982','11532','97911','62740',
                          '82198','94487','83345','66007','79386',
                          '68935','35934','79790','91276','61261',
                          '58068','43105','79596','41010','83942',
                          '99541','35322','68161','55126','69981',
                          '59483','27292','69473','16382','21374',
                          '37302','76222','16529','22812','54417',
                          '49045','32788','96479','55074','63743',
                          '10907','52519','56366','91430','88901',
                          '34295','53829','77813','10476','35184',
                          '58080','86440','22335','48509','27354',
                          '69912','28964','27118','74810','19728',
                          '85437','74282','96540','74153','63360',
                          '22270','35599','75258','40244','92152',
                          '42645','38695','26093','50132','92300',
                          '40681','72446','85771','91085','49449',
                          '55226','64857','46960','46573','85051',
                          '92431','68762','33758','46328','53247',
                          '11208','91669','25632','89757','85234',
                          '33406','69469','47534','14870','97287',
                          '49482','88002','14687','93357','81928',
                          '16435','74435','18213','45200','83807',
                          '82950','42029','83123','17758','62572',
                          '46238','18433','68852','92108','48455',
                          '44748','19701','89076','94724','68758',
                          '73949','56676','38385','86431','80980',
                          '53289','24793','74758','31019','26912',
                          '83430','42165','88121','97688','93567',
                          '15451','44652','83346','72108','54530',
                          '79010','84342','80089','46917','51089',
                          '23076','56882','93002','40488','99120',
                          '40776','71853','93682','52790','71527',
                          '44062','96345','21591','44101','88372',
                          '46060','30607','31963','55597','73162',
                          '71354','93022','37400','53458','33151',
                          '60256','71442','89607','74883','63926',
                          '85262','74029','45082','50121','75448',
                          '69195','90900','89541','87070','44688',
                          '63394','21585','71468','74734','54615',
                          '93895','34712','21216','25124','18764',
                          '48690','71663','39180','40585','46611',
                          '16439','53805','57935','97446','48465',
                          '97999','26012','66321','37343','64072',
                          '77544','38405','53590','94304','11288',
                          '48757','34186','46014','81461')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


