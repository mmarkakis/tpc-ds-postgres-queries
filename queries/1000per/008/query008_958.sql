
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '62922','14575','88784','98030','13280','47228',
                          '92358','10187','53914','52927','70938',
                          '76324','44859','49551','56758','33553',
                          '10344','45143','30248','57886','12570',
                          '75403','69222','27543','31853','28421',
                          '32893','60960','11759','79438','25326',
                          '32305','29893','17104','41874','84955',
                          '50062','91236','90275','41217','30729',
                          '31919','87647','21901','43635','45403',
                          '55030','89745','92815','95641','60145',
                          '69025','17815','97604','10528','60990',
                          '15366','20181','58985','64873','96021',
                          '19097','13177','18980','11591','10538',
                          '65582','61731','34484','84172','65893',
                          '17910','65738','50161','88671','17764',
                          '95243','23681','96697','33508','76672',
                          '26073','71198','50638','20761','13538',
                          '64240','29233','70425','19518','42050',
                          '26503','89066','37520','83704','98995',
                          '27306','79834','22434','62859','92887',
                          '53439','52359','82535','36738','17055',
                          '97292','93502','52259','29031','41388',
                          '67990','39743','28661','34604','55991',
                          '34171','93475','90253','35911','87490',
                          '14061','15770','42963','80664','85962',
                          '90555','42485','43353','16775','81816',
                          '22075','16308','94654','13555','61350',
                          '81048','23325','35611','62902','52444',
                          '83281','48546','81962','30390','79447',
                          '40029','55390','61711','71853','62059',
                          '14556','41130','54004','47114','27625',
                          '97917','76589','82044','14673','26782',
                          '39825','48126','91428','69607','98273',
                          '45965','69392','29535','11753','42076',
                          '89007','58488','33011','66212','54072',
                          '21957','69635','27252','74943','28922',
                          '22056','75463','69638','78519','53920',
                          '19262','71635','36838','69211','56516',
                          '22266','61728','46490','30951','56387',
                          '65302','40551','37612','78893','82836',
                          '61233','76015','69771','84147','97007',
                          '79233','49736','51746','11164','69419',
                          '33832','59657','40633','73644','54457',
                          '20520','51955','87475','64515','85938',
                          '44671','61137','21955','23850','72789',
                          '46295','26975','69046','90318','87629',
                          '60511','82293','25948','58113','20567',
                          '81710','76154','70085','34721','15073',
                          '64355','68750','15916','38264','66881',
                          '67628','73989','66839','27481','10520',
                          '77721','84474','21300','85536','41510',
                          '22653','40443','44261','68798','29113',
                          '12162','12288','20151','55724','43425',
                          '95289','40797','71485','23753','28692',
                          '34990','20683','47037','28783','74252',
                          '90138','90117','16848','79071','47802',
                          '20688','40915','18875','29886','83183',
                          '64186','15481','58050','63603','17592',
                          '73017','98731','85387','48253','13889',
                          '25925','13632','66661','85758','97075',
                          '70521','84922','66083','84502','34232',
                          '40279','25280','57026','45990','74737',
                          '30440','78052','76831','34688','50379',
                          '74482','78969','82822','35670','30571',
                          '57271','15745','52844','86892','12931',
                          '28271','39720','54640','14021','40278',
                          '79308','12941','73421','13993','59449',
                          '46761','43674','68245','61670','88754',
                          '46974','95361','15827','33535','78892',
                          '28986','68927','48433','53479','72447',
                          '42030','77681','22007','15978','26471',
                          '91131','76474','57537','80071','30019',
                          '15149','79348','23118','85760','70554',
                          '61135','46730','92449','13789','87875',
                          '17564','46752','51680','44936','49108',
                          '44298','92505','73392','64512','28613',
                          '49415','69103','24612','79862','39185',
                          '27923','27346','64376','43207','25537',
                          '83533','24213','87710','72100','57399',
                          '23154','77814','37911','57205')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


