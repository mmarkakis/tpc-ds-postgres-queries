
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '79563','73689','90148','32075','35291','79298',
                          '55242','35170','13999','55462','39815',
                          '84548','94774','24936','68115','19647',
                          '95446','38782','39407','91506','70498',
                          '75122','54875','83598','69862','49173',
                          '43123','22716','22159','88637','16645',
                          '38425','36946','88383','25173','19564',
                          '29313','27040','15259','69065','28080',
                          '28405','35213','20835','60462','92017',
                          '98429','44455','67544','72512','15493',
                          '98035','41312','68663','38148','74632',
                          '68138','93958','95109','62523','74823',
                          '19652','82724','88357','47750','73959',
                          '51032','52114','38403','69522','27975',
                          '16710','62949','37925','65715','19076',
                          '72303','24026','74206','35101','61453',
                          '13064','25590','89306','85662','93400',
                          '50696','46825','89087','45548','79508',
                          '71804','25701','73122','78554','82706',
                          '29652','24230','94252','43672','37045',
                          '29186','74410','50470','89159','44640',
                          '13746','74732','33261','88151','61811',
                          '48260','19871','32192','88330','14720',
                          '87688','46272','33219','26407','94959',
                          '48398','52200','89803','94458','93373',
                          '55394','31223','23085','87903','31127',
                          '15665','85362','60022','16921','48361',
                          '29056','62572','13429','75313','97448',
                          '36372','85099','58653','38310','93006',
                          '97401','72153','42725','85610','70442',
                          '76867','82929','26007','31368','14448',
                          '94512','25566','26370','88249','97759',
                          '61371','70065','98176','52889','90195',
                          '82974','89562','23340','81921','43278',
                          '68885','83113','87372','30340','88519',
                          '66936','24706','86642','87110','40129',
                          '31443','89232','73703','61741','15962',
                          '97365','33446','31974','79181','39888',
                          '37275','69041','66191','84747','27093',
                          '25441','99495','37702','55878','91407',
                          '34705','90285','29305','34374','30390',
                          '82002','42000','83123','43205','62096',
                          '92466','68038','40477','70490','41177',
                          '35108','15312','22999','96513','96742',
                          '92644','42369','84298','22942','66507',
                          '85635','75225','59158','61679','58942',
                          '32048','87163','23447','91377','39929',
                          '64896','43600','47816','23538','35030',
                          '53423','23488','89480','47052','16575',
                          '46194','54854','71743','22509','23199',
                          '80262','21192','69148','27507','49574',
                          '12126','88098','83594','21676','31759',
                          '80811','49273','20652','40333','98413',
                          '66379','83110','95295','38983','51310',
                          '45229','27484','79804','67277','14337',
                          '86224','98813','42465','28183','52918',
                          '20328','29656','95883','11232','42056',
                          '22008','29647','39714','89877','41417',
                          '68584','32832','42715','72537','87697',
                          '34909','75648','45991','61992','86676',
                          '23382','27775','91163','61377','21552',
                          '98727','51157','19044','19487','81376',
                          '73690','95899','72099','20797','87238',
                          '68310','16404','83934','23392','55246',
                          '26871','89508','24962','15671','32259',
                          '71173','93227','82781','17619','60256',
                          '12043','29169','40688','63608','19409',
                          '84042','29074','36502','17910','20007',
                          '50866','42301','73867','24604','17315',
                          '13390','41444','63235','71517','85346',
                          '62624','52798','10914','37644','14879',
                          '60601','65553','32696','79866','71904',
                          '74750','68458','80381','44763','98721',
                          '57435','18153','87742','64186','60798',
                          '22516','11971','31494','79085','19112',
                          '33559','63615','19527','80603','21658',
                          '62546','12441','84784','74761','14709',
                          '80577','91637','91175','14390','48516',
                          '89141','31733','61499','80253','10362',
                          '93370','65818','62222','75296')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


