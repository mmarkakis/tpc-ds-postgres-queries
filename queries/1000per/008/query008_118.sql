
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '53776','89882','83738','63603','43997','84725',
                          '11722','91006','74890','67294','37404',
                          '48990','71578','47297','87308','18302',
                          '94088','70614','64980','66978','26812',
                          '80616','90256','39085','64603','47139',
                          '95636','85848','71780','82983','27263',
                          '29095','98524','13509','56751','22954',
                          '62689','26286','70770','29372','64787',
                          '30858','91508','45898','62636','91982',
                          '27212','71100','10415','31111','20455',
                          '73766','15882','16584','21075','23442',
                          '52697','72479','81159','17760','50469',
                          '61702','69219','55216','51149','64871',
                          '59656','39023','43291','24484','27005',
                          '73975','10091','67847','23654','73596',
                          '66355','66416','97961','59552','17278',
                          '44557','66430','96229','81241','93074',
                          '56338','66867','69305','30074','95996',
                          '19478','39147','43733','20013','22762',
                          '28619','46240','90183','87416','49696',
                          '56254','73943','80933','43007','17907',
                          '26929','32315','94158','20241','57280',
                          '29214','31523','71493','13980','53180',
                          '93671','98620','83852','83238','81063',
                          '42671','13733','48110','83856','22110',
                          '52999','62151','81428','59926','22475',
                          '53233','65673','11412','40293','42224',
                          '86020','11851','55808','49806','84246',
                          '33564','92321','58812','54902','94007',
                          '16694','23400','18220','71599','58905',
                          '82385','45598','91983','23738','83037',
                          '51470','74281','96808','14850','97172',
                          '80739','50700','71222','79642','38113',
                          '78280','37694','30532','89649','53829',
                          '34196','36092','64430','56410','38979',
                          '92037','26737','73313','22663','18511',
                          '42300','70356','48753','60874','58724',
                          '62107','15454','85713','89387','81671',
                          '58663','29650','19320','46389','97442',
                          '70083','32965','93038','33772','37187',
                          '71881','33612','11581','88785','37800',
                          '22282','94917','86444','65448','57855',
                          '48824','92791','42662','77248','23048',
                          '97754','16071','96748','54954','12187',
                          '91702','42598','39019','77812','58275',
                          '87598','78073','45391','85617','19254',
                          '47398','19211','84127','32189','49409',
                          '47670','59629','66214','98109','73741',
                          '40922','13786','94247','53440','71497',
                          '65994','61244','67418','49005','95941',
                          '20935','56557','73940','20530','38136',
                          '30973','34678','83682','46730','90730',
                          '67377','23625','54335','83159','24859',
                          '59521','74334','93220','84983','46765',
                          '66305','26451','98120','45799','98672',
                          '26365','99985','21004','74455','19747',
                          '99485','37228','72712','25371','34389',
                          '25866','95785','23244','89509','52658',
                          '91074','61092','55414','21803','17522',
                          '15414','86652','97369','40632','75837',
                          '52174','79215','87765','86482','80556',
                          '88210','29972','96014','77598','82396',
                          '69726','40176','20417','29418','92837',
                          '53155','12685','10952','18907','10881',
                          '58182','30507','60478','45048','86514',
                          '35359','22727','71609','50353','52299',
                          '63665','19503','55263','58157','40596',
                          '45874','43615','26642','85448','22455',
                          '39557','77167','35983','94089','37017',
                          '27556','77918','79358','59872','69202',
                          '29486','56205','61004','63135','86483',
                          '41986','93757','17815','98720','49478',
                          '99409','37597','26554','52873','52949',
                          '62862','82998','74982','47077','27241',
                          '72871','92362','17271','54452','83071',
                          '86271','46298','91528','41286','10364',
                          '61502','41632','95357','71856','60017',
                          '82581','71131','64493','97054','11146',
                          '29096','57966','86928','44750','54478',
                          '90340','85191','36223','83269')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


