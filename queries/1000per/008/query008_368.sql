
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '16878','95966','63352','39620','20809','33764',
                          '22544','36953','70564','69898','13451',
                          '77386','90816','84132','24966','46302',
                          '21700','22009','28985','36353','58159',
                          '24401','77139','31225','48286','22026',
                          '41291','20169','85058','15835','47173',
                          '38448','38421','79654','35420','30490',
                          '45170','97825','76515','82075','86846',
                          '24023','20803','85254','36469','62916',
                          '93637','46652','35919','85884','75584',
                          '84151','36270','53896','18796','78927',
                          '20623','95231','30105','36660','25763',
                          '94529','38230','82719','65217','10066',
                          '20304','32050','40887','25562','81483',
                          '34602','32840','98945','32453','22305',
                          '12974','42394','70346','88093','81656',
                          '95695','23118','44133','38844','94968',
                          '15873','35973','28792','76942','63244',
                          '19259','35864','84490','67691','40874',
                          '94002','99210','10817','31932','52975',
                          '95379','34754','29743','76596','20802',
                          '34581','37311','52632','49562','38074',
                          '80792','46778','48194','56697','10004',
                          '69558','85835','72528','24315','89979',
                          '86159','48235','54880','39277','43741',
                          '46916','82895','88731','52390','61280',
                          '42489','49226','59485','63676','38291',
                          '48211','22696','65864','37950','79775',
                          '65172','79220','20184','18976','25718',
                          '72944','79919','70750','39701','71051',
                          '52250','99851','92743','87683','48477',
                          '41590','79714','94320','66018','33471',
                          '54114','76854','84355','97410','78823',
                          '47746','92885','35890','43958','88813',
                          '63843','55709','87596','97635','63455',
                          '83420','52482','22745','84761','25500',
                          '24719','14188','32201','74331','92338',
                          '66723','26192','42240','37377','24079',
                          '44154','78694','54785','22187','51780',
                          '20170','76823','68013','87396','59169',
                          '44512','89407','97796','39308','96660',
                          '20442','45345','56786','90356','54652',
                          '95419','29888','68893','66230','42774',
                          '81555','33102','82611','42484','73566',
                          '52625','11583','16819','91796','75697',
                          '74568','16395','97096','74279','71731',
                          '68913','85008','94572','85250','30489',
                          '87448','21387','19172','24603','74183',
                          '47596','63831','13064','68974','95115',
                          '46367','53030','46414','50692','37948',
                          '38672','80388','88164','59751','12388',
                          '28668','64620','73048','87213','16879',
                          '88969','72557','98318','13555','40762',
                          '64750','15551','57495','98033','41013',
                          '47789','18048','79278','77059','81914',
                          '61254','32329','88982','77207','26789',
                          '22066','93569','59030','90132','23557',
                          '57895','33032','70992','46847','81591',
                          '23154','17016','54848','66504','99648',
                          '32500','65596','96119','86383','31425',
                          '52697','99707','16818','89239','93080',
                          '81044','70175','30560','68741','52584',
                          '12554','66707','56954','25399','31161',
                          '29188','85056','54335','58097','97347',
                          '99269','90197','62917','50859','14616',
                          '76495','41772','70966','44453','77631',
                          '18580','70291','70133','52576','53272',
                          '26614','50099','71513','48219','95946',
                          '40211','12967','64341','43537','29620',
                          '59329','89122','48663','61833','96454',
                          '42194','53283','58694','75893','84695',
                          '15778','53426','12155','19810','72696',
                          '19130','41461','27058','31325','96517',
                          '26037','10026','35764','97284','79488',
                          '50563','37732','51319','69028','23577',
                          '58606','84319','42970','40626','92160',
                          '48581','22121','98929','29710','23929',
                          '93463','59851','12792','78521','32357',
                          '26523','97641','21023','21046','47217',
                          '65369','47374','60394','48292')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


