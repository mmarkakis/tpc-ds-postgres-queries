
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '87554','92776','78969','98718','46550','94574',
                          '58162','29673','48843','82492','43114',
                          '76003','25655','66306','79338','44277',
                          '51026','49246','93954','90896','26834',
                          '83795','44676','23596','18922','35864',
                          '53811','57262','26568','20053','93514',
                          '78237','87277','65800','77884','97660',
                          '80519','91397','19470','29990','59508',
                          '88178','32421','46534','15944','93867',
                          '20593','75594','70680','83539','37709',
                          '74619','35883','17964','70574','34181',
                          '18042','85791','83851','37259','61549',
                          '58523','30622','74916','47223','25512',
                          '54940','83470','56242','58078','12637',
                          '11491','54035','53218','92386','80415',
                          '74406','35824','64976','32829','75360',
                          '96915','95751','38401','35143','31051',
                          '93227','61673','34263','22569','50205',
                          '44531','36986','55607','61744','13199',
                          '99310','72685','90835','10432','65138',
                          '77775','94001','64801','94598','42005',
                          '33274','13131','40372','32801','44569',
                          '34570','75668','28240','41845','21351',
                          '26684','43217','51587','87527','92011',
                          '82583','44307','72887','43390','81426',
                          '76946','93388','70056','66188','49710',
                          '75583','17002','78838','63228','62202',
                          '95685','98109','38038','40328','41056',
                          '77402','48879','18414','65587','58438',
                          '49863','39128','91516','57406','13291',
                          '47188','26903','37622','70824','93406',
                          '78382','94088','46836','87853','91691',
                          '96485','77539','94899','28241','39276',
                          '95234','30186','77828','17221','24935',
                          '49470','44486','50540','96385','49744',
                          '41572','49413','77754','94762','10180',
                          '91787','66415','40035','20794','44064',
                          '91917','85373','28267','34911','63887',
                          '32355','87476','33039','76088','75877',
                          '29480','88566','88513','45825','65816',
                          '12790','76753','62530','68490','17276',
                          '98036','93010','56763','46758','75757',
                          '91743','19257','85460','25049','99774',
                          '54347','63494','23725','49492','72127',
                          '81036','39176','76953','63643','48051',
                          '87801','19430','19655','52968','98443',
                          '88546','67593','16253','72022','25122',
                          '86140','97711','11765','21131','78704',
                          '94673','63004','41114','13386','74589',
                          '71166','82229','83917','27794','47841',
                          '17906','93509','60596','86578','12102',
                          '41591','54103','35646','62334','59356',
                          '55504','35850','78708','51082','99876',
                          '34090','77052','77244','63321','69145',
                          '70115','60384','13214','13720','85803',
                          '43835','92155','54737','29505','80580',
                          '17314','39689','80048','52153','66648',
                          '78992','45697','40942','49174','67294',
                          '62124','45161','28489','18184','83526',
                          '72550','15583','15229','21599','68737',
                          '81484','98989','52473','78257','96980',
                          '45609','60431','15281','86034','91601',
                          '22519','52284','80947','10901','59295',
                          '58904','69645','96066','77249','79878',
                          '78808','69972','20222','37063','81886',
                          '16316','16482','29129','64315','89130',
                          '88792','38202','99479','41869','13234',
                          '18609','56620','88982','71226','35478',
                          '92352','64415','75193','21910','16541',
                          '76993','71743','96080','93072','27839',
                          '79792','57775','81517','92713','20688',
                          '70970','95649','21998','76979','92931',
                          '50648','14863','78464','23911','27441',
                          '71986','51803','68863','88359','66161',
                          '17528','83176','46046','15331','29396',
                          '67672','77615','75962','15361','28504',
                          '99296','48839','97714','83976','62940',
                          '67970','64840','18363','15394','33843',
                          '13878','48444','62901','24250','36958',
                          '15649','97763','37535','70127')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


