
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '18597','66220','39786','63985','62912','88904',
                          '33595','62966','59682','98756','41835',
                          '99923','49405','27053','10503','57083',
                          '97406','29484','32674','80256','22791',
                          '63920','70720','94815','30193','53219',
                          '22817','34743','76470','62934','56886',
                          '41245','71293','67419','90874','91285',
                          '65956','14201','66546','54741','68633',
                          '33526','92801','89191','85442','66548',
                          '57097','63925','26052','75141','12657',
                          '61611','29997','21246','99947','78524',
                          '89590','43598','50184','68188','43324',
                          '11163','55120','19967','12046','28032',
                          '27000','38019','30080','39971','65126',
                          '21289','26560','66712','19778','85763',
                          '31278','79472','10930','66677','88059',
                          '10240','50614','26781','35389','45895',
                          '19846','31197','72521','81052','20504',
                          '50784','61854','13234','85450','27705',
                          '42006','96806','12835','13209','94212',
                          '53529','97200','81449','88486','93716',
                          '14746','18381','98838','77060','99753',
                          '74366','62668','97093','35350','80181',
                          '33999','26532','29674','52344','48571',
                          '15489','37111','32763','59199','94532',
                          '62472','88909','10986','76783','47972',
                          '76339','40983','78372','76956','63707',
                          '74903','16665','39890','61259','23472',
                          '51755','15209','85470','25703','67418',
                          '26510','15883','45651','79940','29884',
                          '30842','33872','26246','65460','13994',
                          '78457','81555','84305','92635','98528',
                          '16174','56613','77799','65336','88380',
                          '69109','43294','45134','74039','20211',
                          '55264','66691','58090','18089','37922',
                          '70448','68506','83697','47218','68965',
                          '48166','42279','76293','30578','65822',
                          '15366','83389','89848','69606','17366',
                          '81672','16953','70250','43498','76368',
                          '72373','70799','43266','59458','97195',
                          '33053','85883','81755','71040','88818',
                          '52812','15094','34885','45817','96785',
                          '85426','31248','36326','45947','35157',
                          '62613','57442','78569','58166','61024',
                          '59164','79326','62565','62411','10723',
                          '24433','54654','78475','34927','31198',
                          '99848','53885','58710','93387','41805',
                          '68884','36862','17298','49336','59190',
                          '56618','66619','22501','38591','44182',
                          '23785','73817','62623','60853','37161',
                          '11564','91331','20712','85336','94185',
                          '81428','34548','78655','17801','97516',
                          '64385','82048','93871','45171','29729',
                          '50756','26966','41090','40365','56573',
                          '81514','71692','61033','92146','30137',
                          '34094','93200','25804','72861','43267',
                          '52974','80114','30860','65466','54020',
                          '83047','54053','95066','71696','55638',
                          '27861','68694','31214','82807','49646',
                          '46396','38209','91288','41315','91374',
                          '18939','78310','36663','21951','51098',
                          '47288','67251','45164','43799','36484',
                          '82094','69465','99050','73320','79450',
                          '65182','99411','43993','51998','81571',
                          '66720','93436','27942','21560','26030',
                          '92528','66540','48204','11383','74616',
                          '45930','96797','47708','92406','74149',
                          '59086','77629','59287','11848','28459',
                          '75702','42999','58798','13498','44386',
                          '17119','69206','35273','49306','53778',
                          '94589','91180','26591','43877','40949',
                          '24940','69073','24256','81483','83580',
                          '81060','97038','98471','97617','33893',
                          '66831','18366','49773','41993','80323',
                          '31876','20043','97476','81063','94547',
                          '50574','15142','82580','69199','80704',
                          '67070','71114','88851','38070','67605',
                          '27905','59117','64177','63685','97824',
                          '71677','83717','90158','64552','10703',
                          '29475','82285','84983','13380')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


