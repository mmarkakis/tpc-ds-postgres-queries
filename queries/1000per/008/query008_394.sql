
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '20002','60113','87527','50030','69940','21554',
                          '31382','89954','62073','96799','98769',
                          '71230','78036','63582','81041','81227',
                          '40156','80125','78679','26573','92329',
                          '23012','70429','67939','45767','88840',
                          '29920','91881','94825','88425','14897',
                          '50685','90327','24861','30422','93218',
                          '72221','57890','79853','40790','25732',
                          '29026','61327','24814','54179','66903',
                          '90746','34033','63616','84126','64643',
                          '41041','43801','37181','10385','62316',
                          '13131','89134','83877','27279','16460',
                          '47881','12120','72281','42363','83707',
                          '90323','92612','33959','17691','92739',
                          '64323','90540','26582','98418','34353',
                          '88068','62374','85069','53555','19546',
                          '46401','41561','35228','88636','85111',
                          '40576','37938','38908','22889','38884',
                          '56031','78387','87480','32325','50475',
                          '28544','31361','33289','48102','12884',
                          '28332','67894','19523','74746','84819',
                          '83656','39749','94699','50981','78261',
                          '48504','85073','56844','29205','55694',
                          '49997','41128','88060','87544','70863',
                          '39083','83148','39851','67582','43020',
                          '72206','77342','15398','16222','55968',
                          '82486','98653','87675','82464','31691',
                          '86248','89774','84600','70217','91807',
                          '18425','99740','74482','62600','75243',
                          '65506','31784','37128','55456','88387',
                          '55135','63023','21534','22514','55404',
                          '48876','46033','19153','59472','71086',
                          '60264','58549','20452','89348','78004',
                          '38751','57943','48799','57642','63016',
                          '66783','93999','94312','44290','91674',
                          '94493','90520','18652','22274','37619',
                          '93046','19842','69860','78320','57984',
                          '99323','27883','91063','27498','42690',
                          '59596','21461','16559','32694','15636',
                          '48049','39640','67373','50877','27566',
                          '58102','40871','47983','63769','14171',
                          '69493','86759','23007','67776','13433',
                          '56580','14260','21610','41380','76678',
                          '32679','53129','12032','89439','98469',
                          '32149','90385','22935','55495','41054',
                          '24025','35072','16512','98712','32289',
                          '67209','26049','10074','86999','32451',
                          '42611','20322','60985','67303','46986',
                          '55807','58927','84133','23603','15624',
                          '57453','57964','15314','31679','59074',
                          '83128','62504','27634','81711','21877',
                          '60894','90240','80471','25705','37991',
                          '95004','91594','68519','85277','41613',
                          '72009','68921','41187','36518','67458',
                          '91646','87484','16108','26347','52834',
                          '67307','24727','84215','50849','16176',
                          '71203','46303','90737','95814','23742',
                          '68142','68279','97260','67087','78727',
                          '50003','98255','61280','48906','14701',
                          '25737','60063','63889','33266','72858',
                          '92382','86089','16696','77267','13205',
                          '84006','13206','43821','37173','49462',
                          '49601','58355','55940','37053','38304',
                          '39235','61014','19641','95913','45076',
                          '14356','87260','49835','85926','35281',
                          '21313','21294','38498','77283','91650',
                          '36867','23300','79552','42511','74852',
                          '13538','47183','49395','79386','98684',
                          '22704','49542','34833','56066','63673',
                          '68654','14450','72050','17125','98119',
                          '23760','97120','82070','83793','81135',
                          '40260','77326','69593','60032','65618',
                          '19841','18317','67959','50902','44447',
                          '38051','59516','32620','54756','99194',
                          '53388','64166','51940','86300','35522',
                          '80430','45747','72027','14138','37773',
                          '19879','86142','32414','65899','68020',
                          '53144','67095','43185','37565','73257',
                          '63735','59810','64839','92418','69162',
                          '72417','95577','41207','50541')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


