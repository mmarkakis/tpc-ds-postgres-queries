
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '25668','13870','95539','64997','67111','17240',
                          '57984','69998','92307','34339','24859',
                          '94457','85387','43454','25059','98030',
                          '22075','36993','24828','51166','31835',
                          '13520','88672','28372','91515','71923',
                          '98893','49619','44686','75115','74468',
                          '55214','58816','19316','82188','76271',
                          '55045','42990','13665','18762','25322',
                          '68283','58977','88084','41132','98930',
                          '12128','56740','79620','96583','45908',
                          '63304','73714','35674','81744','68434',
                          '73788','50035','24108','67919','35407',
                          '87351','77338','70074','33254','21924',
                          '70513','82599','28242','22062','71813',
                          '46561','90568','17268','71121','70522',
                          '49470','60499','40757','75305','33567',
                          '24464','82578','28859','55985','93235',
                          '74472','27885','95996','95188','84256',
                          '42135','89423','47725','45101','77897',
                          '63995','88659','97098','28978','29262',
                          '53454','54528','83690','23509','32104',
                          '13750','75780','75273','61943','21916',
                          '26686','16535','91593','65902','40424',
                          '83582','90232','13424','80515','95620',
                          '15353','43273','62364','27211','64570',
                          '34177','62662','46291','95124','84366',
                          '66600','76962','68470','62858','42599',
                          '96688','76644','60751','79428','86520',
                          '33735','69332','75483','81198','89977',
                          '14686','28713','49757','99842','84134',
                          '64453','14530','82091','98000','78993',
                          '18084','76630','92518','65223','81449',
                          '25031','89056','32867','73972','85544',
                          '19432','17167','13370','74512','13149',
                          '44966','86289','77387','21156','55665',
                          '63109','55392','61892','26044','98593',
                          '49550','51699','21854','94291','87033',
                          '75664','99394','61568','92248','35497',
                          '25630','92633','12690','11387','65485',
                          '86320','28268','93455','80331','49463',
                          '35200','59182','94476','86103','84879',
                          '91508','57257','46604','97748','79916',
                          '44431','55649','48915','74873','14746',
                          '77963','72352','67107','42791','94660',
                          '92888','66471','55366','52158','24158',
                          '91191','95654','59588','66810','39540',
                          '49724','25118','19292','74517','71484',
                          '65766','10949','53563','92202','58585',
                          '52220','81641','56611','66329','82826',
                          '94067','63707','66454','16576','33022',
                          '95185','25876','11480','85467','93977',
                          '69385','76212','35222','93829','32005',
                          '76349','60862','97934','88087','84331',
                          '72600','38252','61653','80339','72084',
                          '96023','21114','72950','70983','60179',
                          '51781','67061','71465','55995','25792',
                          '51569','37729','14141','53608','13933',
                          '77948','10509','72235','21486','87415',
                          '79938','58584','40210','42287','30023',
                          '88308','74049','71029','90906','98954',
                          '64297','94512','33725','17583','64577',
                          '22893','51545','30561','82214','19513',
                          '65215','56919','48641','71290','78712',
                          '97124','93674','36562','11065','97062',
                          '12079','45604','93504','32426','99087',
                          '36001','14728','54150','68333','95477',
                          '50948','86789','17787','92763','16112',
                          '87161','51291','17132','74108','62480',
                          '34016','91722','80918','64950','35338',
                          '35576','75874','40976','77686','12414',
                          '24964','53291','70236','45734','91006',
                          '83495','82655','77154','55483','97203',
                          '45311','20790','96258','51406','12501',
                          '61762','39981','42024','89813','93472',
                          '60332','46092','17434','63778','55299',
                          '33845','77524','92627','20397','65444',
                          '13975','36643','24313','29577','22412',
                          '15542','24959','27572','19908','41947',
                          '95370','39199','20460','78003','12507',
                          '74095','80354','39155','91533')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


