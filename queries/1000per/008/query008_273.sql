
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '16706','28907','44997','89593','99414','44292',
                          '65101','73395','99650','99504','99671',
                          '23693','41477','97314','33428','79101',
                          '16018','33723','91072','88493','74189',
                          '81614','54059','93448','51458','90621',
                          '37008','55637','92217','34015','37799',
                          '22694','61769','78393','73402','38054',
                          '16119','50731','64377','40776','96297',
                          '81517','14369','48942','53466','48440',
                          '84902','45028','93392','75657','24010',
                          '36272','14047','97458','73884','82113',
                          '63929','69357','33460','42961','19823',
                          '66222','89905','34588','75085','44033',
                          '87108','41042','94748','12725','56896',
                          '90187','78405','73037','15782','65777',
                          '28059','76822','50122','91932','84425',
                          '30946','83254','43291','60278','63212',
                          '64861','57003','44614','31378','84500',
                          '16899','34634','38575','14207','45653',
                          '44913','24558','32001','58327','22257',
                          '64593','23196','32879','16085','95622',
                          '73581','34352','39069','12268','84026',
                          '17201','73569','61270','86015','79482',
                          '96122','26458','83303','74191','62620',
                          '50266','11572','78597','69171','62240',
                          '24247','90006','52240','20336','32700',
                          '63524','88618','70142','64464','86008',
                          '10681','98101','28587','61037','34014',
                          '94850','46629','33736','85413','97827',
                          '96970','22815','30343','75744','62436',
                          '17098','20270','82269','72809','43137',
                          '92166','33118','69670','91579','75442',
                          '26974','54722','80027','35979','87163',
                          '73006','51136','62005','40267','10240',
                          '32837','96436','97134','89335','69553',
                          '38407','26016','45413','53065','33688',
                          '18236','77575','86293','20789','31277',
                          '52783','30880','82935','50678','11477',
                          '93234','39567','73978','89842','19483',
                          '24752','33307','54739','15430','30518',
                          '34960','81718','58409','55589','34091',
                          '19616','82067','66726','32010','13833',
                          '63419','90311','33961','66713','64263',
                          '59467','19067','49894','94708','21675',
                          '19727','19606','11946','28325','30559',
                          '65387','90121','29685','87178','73448',
                          '13234','16069','36814','66987','85304',
                          '83768','39499','80607','70686','90185',
                          '78683','98807','89858','79940','66159',
                          '99324','86692','84599','78858','22562',
                          '14538','68952','23868','64907','21464',
                          '82869','85749','32686','60144','80000',
                          '34479','41878','18550','23806','92144',
                          '43399','82632','88823','73294','44669',
                          '58777','22193','54104','95924','87526',
                          '13886','31342','71160','80527','50494',
                          '44587','21529','97665','17949','99017',
                          '11153','65988','99757','51361','48791',
                          '27120','32533','12318','65333','67321',
                          '36251','64117','85400','29562','21503',
                          '97906','78024','46490','80531','19311',
                          '73561','76301','74316','50764','53860',
                          '24393','74929','12683','54695','49829',
                          '64817','85508','26544','23523','17960',
                          '91205','67099','46468','10743','15752',
                          '51640','40535','59465','98771','91833',
                          '73464','92139','50904','64018','76976',
                          '96761','57219','35112','70694','22616',
                          '40667','59179','67576','32279','49027',
                          '51568','20022','14084','15802','29532',
                          '40953','56652','79955','41594','14863',
                          '64213','34664','45297','32383','33035',
                          '13630','37692','39157','40905','26424',
                          '68915','54941','16083','42746','36610',
                          '25875','45374','58918','18477','47229',
                          '89691','83154','93919','16125','91942',
                          '83780','95672','25087','34120','78568',
                          '15167','87328','93535','59273','73260',
                          '86061','95414','73045','40974','27007',
                          '75415','16720','39621','81173')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


