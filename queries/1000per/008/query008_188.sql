
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '28905','82736','50270','21058','15733','36440',
                          '27191','30803','63584','19430','65674',
                          '20393','75433','61912','48266','11507',
                          '53404','86896','18536','57524','14002',
                          '80379','63617','89261','67062','36589',
                          '91620','96305','55488','74677','85541',
                          '65695','12135','45098','41994','64786',
                          '39586','31463','84150','31148','12082',
                          '18603','68593','84803','85906','24774',
                          '33860','56352','42370','50293','53080',
                          '49052','44392','79146','41023','44205',
                          '96156','28958','43527','47059','65802',
                          '64801','91684','23118','52362','64721',
                          '40541','19911','44857','85805','84615',
                          '97348','13680','19086','30633','57864',
                          '70816','60053','20475','92389','30530',
                          '17785','61667','71985','72960','24798',
                          '44930','99323','52731','90909','58852',
                          '87395','12416','32723','52710','95164',
                          '51656','67516','48888','95679','74818',
                          '45540','79203','75531','73801','63153',
                          '93949','58358','21403','57651','62690',
                          '31470','60785','32616','57449','51627',
                          '83614','25780','37592','16402','61618',
                          '68083','29311','68236','93652','56964',
                          '18605','97803','14575','66228','54154',
                          '58494','44836','69482','67012','12770',
                          '45381','11335','43788','71794','68176',
                          '28403','43607','92629','35371','82023',
                          '20489','10146','62450','74023','51832',
                          '78910','70225','37507','92873','19786',
                          '89348','88401','79299','83295','96020',
                          '34406','51576','27804','26210','89779',
                          '91444','32917','55842','31538','51127',
                          '77687','19485','70989','88553','32567',
                          '38752','69485','18541','46762','20501',
                          '58900','47909','97500','64178','13383',
                          '14068','77107','30665','21937','12899',
                          '97241','20132','29361','33543','39618',
                          '90622','18824','40312','81214','84040',
                          '87909','37951','95598','88975','13955',
                          '59048','75907','42607','96834','52057',
                          '62913','31267','55924','73442','24100',
                          '35461','14499','91655','42108','92747',
                          '51867','28714','16141','88440','64905',
                          '31513','69051','16236','39388','60297',
                          '52142','41481','29579','83114','80018',
                          '56665','23570','11716','69359','12556',
                          '94371','34992','85554','11171','67001',
                          '80125','57670','34432','69425','29765',
                          '43501','90084','14372','10035','91285',
                          '24956','29493','83675','16140','49681',
                          '65359','38244','91716','33484','50934',
                          '33444','32789','38192','43956','92450',
                          '14375','23206','21890','27672','90938',
                          '85563','54177','91458','22297','20728',
                          '96336','40046','37545','82034','25676',
                          '15391','46843','29745','21604','94821',
                          '60549','72012','85448','73198','42502',
                          '83341','15011','38367','73776','13924',
                          '61290','71698','28069','81582','42559',
                          '53646','14840','59691','49801','83930',
                          '52020','38639','34120','64454','89497',
                          '20144','30653','21545','25887','37363',
                          '94744','93888','52637','12132','19052',
                          '40217','47483','58786','27783','48205',
                          '12658','59375','55913','90624','49249',
                          '60255','26091','30036','14881','64956',
                          '26249','10904','43336','37041','49585',
                          '36749','75086','16974','76836','51618',
                          '82482','34129','80678','27391','78548',
                          '36734','52975','55754','30302','92848',
                          '92275','25657','91114','10872','26429',
                          '47906','19365','18461','54976','11143',
                          '94961','32292','40079','29865','97474',
                          '31824','59104','42314','66495','57157',
                          '77920','37742','92471','97806','53342',
                          '23556','37725','76532','49839','29926',
                          '52827','59316','52664','16178','71679',
                          '19383','54724','77272','39118')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


