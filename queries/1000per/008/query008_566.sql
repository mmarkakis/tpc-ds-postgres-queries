
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '96299','63098','31647','56648','10527','73205',
                          '69992','35392','73747','20741','43915',
                          '96652','94302','20672','93950','30086',
                          '12350','27125','17386','67867','99111',
                          '26199','36563','93726','18609','25842',
                          '99438','63852','81904','24160','52996',
                          '96064','57446','48749','66873','99656',
                          '49357','31185','56631','84432','70346',
                          '68501','88284','82686','50704','12423',
                          '54154','75119','49819','41400','12750',
                          '74973','55580','57520','42081','54419',
                          '49398','90715','89161','91119','20209',
                          '75144','37784','17934','64356','50083',
                          '17201','47181','53654','58531','46949',
                          '74602','68142','81938','21691','47062',
                          '45966','85658','78484','93303','56040',
                          '30900','58183','12023','79887','70746',
                          '54345','83952','78990','81510','70415',
                          '37985','54217','60194','18877','42384',
                          '89866','36091','74659','88568','30372',
                          '43554','35321','10962','61595','14224',
                          '27309','46438','90756','79936','57532',
                          '59303','81974','51336','61772','45134',
                          '37904','57526','57170','89961','69338',
                          '42878','74741','88428','68277','23305',
                          '23059','54773','62894','46681','69862',
                          '38989','54858','22623','57231','68419',
                          '59230','69630','73598','23831','55117',
                          '32578','25763','79797','47636','18094',
                          '88372','78034','84322','98380','50802',
                          '50133','75315','39055','92648','66306',
                          '82038','47695','18885','51488','53985',
                          '49203','47180','17009','81985','21170',
                          '18454','17768','52222','25682','76157',
                          '85566','72158','73822','81077','64864',
                          '49060','45965','33562','33166','86885',
                          '84088','29201','42157','14885','29366',
                          '62674','54512','90685','70735','57829',
                          '37013','43812','84778','35758','99072',
                          '17847','18168','24850','42908','14554',
                          '29323','70988','26375','88721','92609',
                          '15388','97586','41198','92315','47300',
                          '83077','49571','71706','87813','84146',
                          '24103','90377','70505','73852','59431',
                          '73401','67199','96850','35642','57045',
                          '12371','43391','79985','84670','71262',
                          '60238','81500','17976','40402','16425',
                          '16856','10249','22158','76350','78030',
                          '25159','23687','80187','79758','57220',
                          '41816','71229','55431','58780','24578',
                          '44022','84455','55983','61363','94203',
                          '77529','71730','52020','23352','28793',
                          '80019','48544','35325','56462','78189',
                          '50203','84874','88413','38512','28519',
                          '26382','67833','10280','26601','56553',
                          '82059','91842','44655','41189','95673',
                          '12745','62789','94752','59396','21859',
                          '17767','64258','74493','76140','10069',
                          '39830','70457','71699','35156','78706',
                          '58204','52301','91769','68603','89428',
                          '43171','94519','29856','15109','54905',
                          '48406','25873','26927','92063','68274',
                          '61642','79119','20574','67549','99685',
                          '21269','64276','75510','70776','43568',
                          '95446','54278','81991','54382','80063',
                          '63900','46160','41827','48187','22576',
                          '71174','87347','10095','71315','39785',
                          '86294','59151','97822','57632','73850',
                          '50675','15488','28436','55526','37673',
                          '97393','93028','58065','59329','76793',
                          '52216','73457','60246','19857','75446',
                          '37329','89021','89926','21050','11098',
                          '25705','65165','13512','80991','46837',
                          '93961','90692','12298','52459','83936',
                          '74452','55792','52137','47533','28590',
                          '30600','59339','22636','58025','40420',
                          '29986','26879','83201','28263','75637',
                          '28562','23136','42700','69055','21526',
                          '29336','33971','82753','10956','25308',
                          '36982','53831','73607','27545')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


