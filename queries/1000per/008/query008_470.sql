
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '68765','91201','12233','27420','40271','92641',
                          '90102','85083','84991','67014','53548',
                          '76652','55220','52994','50931','10603',
                          '32392','31129','85631','34721','42806',
                          '22467','46411','26365','29441','11347',
                          '96125','27382','92738','76678','36793',
                          '28435','95524','93125','32439','70297',
                          '82213','42272','75479','87699','50554',
                          '97546','64331','60797','37968','61524',
                          '47530','71653','73975','45351','26015',
                          '18395','25939','63421','78412','78470',
                          '24961','37263','76979','81339','61146',
                          '23799','55313','11459','31860','19888',
                          '84774','72444','33344','74261','40218',
                          '36557','30837','53495','15031','35666',
                          '67662','36074','26636','94881','25125',
                          '24017','54542','68370','41061','54309',
                          '16383','18302','42607','12700','86110',
                          '28558','54051','99835','87247','72219',
                          '32418','15175','22153','46236','70058',
                          '12245','30642','62696','37921','44088',
                          '78198','41867','93005','81511','95890',
                          '71308','81489','34266','78120','35089',
                          '89567','80088','88516','37832','75412',
                          '31042','27506','87054','83289','78647',
                          '30480','32829','55568','45896','50758',
                          '71145','72815','58886','88005','45371',
                          '10980','10379','97733','32568','40480',
                          '48679','30489','36071','61656','20218',
                          '37310','88927','83384','52937','59366',
                          '71063','38021','33113','38154','61540',
                          '54735','49360','75709','14250','46930',
                          '38657','12370','76335','33098','94284',
                          '21568','48934','99304','80650','84252',
                          '18716','88787','70624','58610','60972',
                          '46137','44563','86057','45102','68056',
                          '66645','79903','95631','43793','62645',
                          '98162','14500','29053','78420','53534',
                          '26357','67807','61387','45219','43381',
                          '35639','73590','98252','83308','56938',
                          '18998','39075','86781','41402','65581',
                          '76053','24771','19402','54211','45453',
                          '48319','99551','83567','55621','44305',
                          '82823','34343','59412','39674','54419',
                          '99732','96636','40873','57617','88022',
                          '68509','94162','65739','29863','37289',
                          '49027','31849','31739','96228','77984',
                          '35357','70485','97182','56361','22472',
                          '44650','26328','83775','69416','24028',
                          '13020','48088','37035','33165','50235',
                          '79008','71394','84676','57566','60914',
                          '55711','25403','19469','95655','18831',
                          '65403','76902','23426','46595','75665',
                          '26842','68217','76709','69302','38622',
                          '85417','74220','11914','56526','80566',
                          '58452','32570','86284','70656','39214',
                          '40407','59207','75779','87494','70122',
                          '47483','35643','51880','14953','95124',
                          '62090','83764','46671','20649','86654',
                          '63886','19212','49092','76655','81692',
                          '92353','70062','39733','11442','15063',
                          '97205','41257','55008','35531','94687',
                          '14389','69892','37840','95019','97639',
                          '17977','45359','78334','38277','44924',
                          '47597','54710','26105','44792','47138',
                          '62661','40202','87329','20101','21852',
                          '76470','14848','59143','60736','14527',
                          '36028','29633','65844','36742','22443',
                          '20592','84516','75060','83134','60864',
                          '34494','76816','88612','66381','78101',
                          '46457','17282','50402','15262','84388',
                          '16747','92089','73236','41855','97973',
                          '37490','49543','11518','22880','18272',
                          '96823','81503','82831','88768','72520',
                          '92824','47976','96386','32393','20278',
                          '18962','97760','22275','15157','91326',
                          '49887','26873','78475','51710','59914',
                          '93517','86753','98826','82627','83085',
                          '68303','22834','20548','35466','82913',
                          '14910','56541','98441','91748')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


