
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '88383','26219','44584','97404','16025','82042',
                          '92352','17962','99899','97252','80281',
                          '47236','19139','46141','36606','35361',
                          '57015','19502','96316','65479','93220',
                          '21540','13581','35167','42011','36257',
                          '75535','37324','78535','62535','70345',
                          '28455','69424','86738','66728','61567',
                          '72497','91233','88400','17841','26568',
                          '30847','94633','68806','17832','28886',
                          '43328','99520','30976','56869','41124',
                          '40106','63495','95862','80319','58437',
                          '41480','70748','64194','99816','99724',
                          '33953','54788','37657','88085','92438',
                          '45745','94198','21941','54616','77114',
                          '97005','96242','12235','66808','75748',
                          '11168','75385','87826','85771','42981',
                          '67862','34096','27413','45668','51223',
                          '97465','83940','27296','90380','85493',
                          '19058','36557','74009','81205','87983',
                          '48801','95124','58867','90136','59454',
                          '89111','21158','22111','40809','32039',
                          '39531','73840','95709','32549','78010',
                          '27794','32192','28334','91897','87662',
                          '88627','52992','96350','38007','77692',
                          '63929','99705','62059','64821','89788',
                          '75061','76449','47311','39174','77930',
                          '69837','80197','73031','22059','14213',
                          '34379','91130','33262','31836','70974',
                          '97033','40523','85684','67149','96733',
                          '50175','40730','19456','27276','58289',
                          '84856','12733','32368','46854','91363',
                          '20345','41545','65140','70135','32155',
                          '83140','30873','51213','29663','90775',
                          '23612','15790','31551','37466','73301',
                          '92434','21939','51690','45443','88446',
                          '56568','35558','27981','29789','46725',
                          '69840','52997','83434','85160','94301',
                          '29572','77070','56941','32216','17637',
                          '28858','13307','83736','90197','33185',
                          '68314','20849','79277','64850','20529',
                          '72619','11378','28638','26200','14714',
                          '16075','25040','13226','78422','65743',
                          '95710','22836','71990','12118','88232',
                          '69967','21383','69207','15446','32615',
                          '88769','23902','97699','55419','20112',
                          '19972','44770','82951','15406','19061',
                          '72522','97424','72200','39146','54380',
                          '21359','63306','85718','75779','43496',
                          '79389','54782','10635','49222','48427',
                          '72837','12291','60811','17472','44078',
                          '44565','44218','76933','94195','99400',
                          '86900','31153','78996','27678','37286',
                          '22367','94105','39042','57575','29411',
                          '55350','37852','49885','65008','39795',
                          '54727','78971','87240','89880','77406',
                          '48333','17441','84696','15094','39618',
                          '15026','76127','10495','73347','81539',
                          '79896','97979','25745','96463','79621',
                          '53859','39221','26732','76325','49704',
                          '64974','76419','37742','64077','47430',
                          '45572','96499','71738','25010','67719',
                          '82299','49270','29837','90934','98373',
                          '58675','61075','10648','43617','42613',
                          '80551','63311','84389','43800','72984',
                          '60968','40437','90114','56424','10141',
                          '29486','42823','73472','56058','96166',
                          '86405','72768','21987','56483','16175',
                          '93466','84450','23065','49308','43285',
                          '13301','61136','75054','87550','64015',
                          '76641','20489','21719','37318','55068',
                          '64877','20554','89173','56758','56859',
                          '72864','64554','25618','85558','67305',
                          '62844','76117','85900','27978','24833',
                          '71166','85339','43019','85450','73872',
                          '96900','61950','41725','92522','80390',
                          '28490','80677','20149','35915','87130',
                          '76783','86288','36687','73875','61305',
                          '20137','90710','54011','19392','52198',
                          '84175','92030','63267','83275','94593',
                          '82719','50067','99489','12316')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


