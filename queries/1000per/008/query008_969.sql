
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '36732','67853','64300','67375','65236','57610',
                          '15996','98106','89691','45613','46211',
                          '81293','45715','73423','29931','92585',
                          '31336','21119','24062','41069','74532',
                          '32726','51580','14841','80602','82955',
                          '58178','76364','12212','65648','20673',
                          '84696','99355','38938','98364','20602',
                          '72033','52938','84331','66847','65100',
                          '55622','44022','41134','91658','14714',
                          '31932','74039','87493','48885','18144',
                          '31311','12914','17618','14075','26557',
                          '69679','96698','26749','88246','55512',
                          '32072','51952','43765','57067','52989',
                          '67732','17057','46487','76461','20185',
                          '91246','12392','96393','23055','74347',
                          '69160','81161','31395','40828','18741',
                          '54407','74629','56923','65573','99227',
                          '93422','19850','12942','66254','59117',
                          '13010','74801','24498','20846','64959',
                          '83687','32255','88965','84218','14963',
                          '71039','95038','32891','18954','71000',
                          '98228','20320','37849','23490','30257',
                          '68685','43307','92474','82635','63264',
                          '80354','75742','73899','62273','31077',
                          '76514','78588','25249','17105','57570',
                          '50046','97819','61078','86999','45890',
                          '58421','44988','41017','28059','35978',
                          '69133','47171','61992','95867','26677',
                          '28916','23614','75914','56492','91101',
                          '38147','96295','87822','77498','13533',
                          '62217','99930','39644','46650','35074',
                          '87541','29402','94767','45747','39869',
                          '16165','64476','41145','47729','33863',
                          '45654','37201','52335','72116','72877',
                          '34075','45809','24012','44910','20203',
                          '40903','35424','21893','90348','96308',
                          '86577','30045','51690','45487','36769',
                          '35599','12022','28959','66824','31259',
                          '37397','93844','57812','27443','18710',
                          '83292','76564','31760','35078','61637',
                          '18844','51820','54484','31270','44003',
                          '53912','70053','42813','38388','81845',
                          '19703','68019','69330','30986','26715',
                          '52192','48999','96832','56441','47401',
                          '41151','13752','55230','10572','61162',
                          '77825','32297','28749','83680','62433',
                          '34669','67670','46285','32554','37087',
                          '19357','18996','25938','96452','39751',
                          '16417','23281','18452','89529','74691',
                          '22460','17036','35104','70243','80018',
                          '10759','89936','43959','64233','71707',
                          '30984','83264','46209','85389','62816',
                          '47958','42077','72583','51587','70049',
                          '66937','73143','53244','49892','98673',
                          '70254','18247','53848','40167','31205',
                          '32907','38004','57601','42013','51115',
                          '71093','48600','47038','81021','69714',
                          '26082','32668','28403','26713','75345',
                          '19672','12695','77607','89486','33583',
                          '21405','42769','25684','29413','18560',
                          '98607','59241','54504','76675','24108',
                          '81013','87116','86023','71318','85127',
                          '28087','48104','71194','44032','37734',
                          '24556','27648','49759','16303','83771',
                          '19939','32134','22736','85902','83313',
                          '40850','23587','63757','83817','97941',
                          '55716','24208','10015','32145','20435',
                          '12210','14605','81956','67591','81198',
                          '46868','66121','44052','80766','91584',
                          '21497','83561','16319','42554','64955',
                          '50116','23976','93226','19119','66364',
                          '72002','66762','14905','18048','99194',
                          '75819','93903','49012','69259','22757',
                          '71210','25900','62951','11978','27851',
                          '85447','50696','30146','61888','47106',
                          '83578','69072','39299','53405','70835',
                          '38339','48930','17495','88538','29738',
                          '36133','36828','59277','72994','56350',
                          '13908','46753','74307','12705','71192',
                          '82695','60208','98608','78918')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


