
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '39003','22957','46089','26475','24029','10346',
                          '49708','87417','72200','57044','34949',
                          '83415','94559','97537','82605','20436',
                          '75457','22942','25567','36566','92927',
                          '24626','57228','90966','20318','80436',
                          '23853','26647','54529','75411','25598',
                          '34986','49437','22881','76945','16101',
                          '55038','48307','31466','91726','34104',
                          '65125','50078','95679','44289','12862',
                          '83757','41032','24555','70592','83517',
                          '91975','14816','25988','13260','70200',
                          '48519','37926','81347','60602','23129',
                          '78857','78104','44712','38059','83011',
                          '87965','90529','71376','53065','95595',
                          '65934','55859','32634','11206','52030',
                          '91929','27102','42846','83353','48009',
                          '56594','76443','71294','67920','52385',
                          '30778','20529','53355','80949','77496',
                          '50568','61264','31171','82627','55355',
                          '29028','45357','28066','17921','37555',
                          '30274','71912','91700','94839','77343',
                          '16060','90153','12963','63659','98244',
                          '10970','60575','81343','48190','89644',
                          '93265','91331','35756','68833','10730',
                          '51411','17526','59457','39886','12987',
                          '35985','43881','45590','67453','14174',
                          '50260','59772','66620','48031','58320',
                          '19215','37274','66388','70657','11326',
                          '42415','30015','28993','53786','95401',
                          '63784','28533','60376','53041','59349',
                          '83321','58776','39876','47102','89090',
                          '66563','71508','25233','39236','95460',
                          '29115','45716','20044','80944','75213',
                          '51020','45411','11510','27985','90919',
                          '11965','98684','86544','42881','84329',
                          '22386','34698','17846','32061','51192',
                          '69492','52382','90632','13200','55709',
                          '69951','82761','25370','91633','44441',
                          '90373','49280','27062','21077','23342',
                          '75143','70998','57657','23634','58227',
                          '86682','24837','19660','54713','86452',
                          '69574','13137','93047','60914','24636',
                          '52188','51481','39874','95082','92265',
                          '74470','55937','32959','77278','44793',
                          '22594','44797','67091','32657','61838',
                          '85908','56748','87686','88581','98853',
                          '54235','53172','73601','65199','38403',
                          '88930','20052','91252','59924','12996',
                          '27923','68076','75636','68001','40894',
                          '97326','16518','61757','39664','17978',
                          '42185','64511','36916','61941','69877',
                          '53715','74870','54934','54914','52591',
                          '27801','50660','76756','76350','30433',
                          '34163','56539','54597','85898','34009',
                          '69288','31145','45526','61871','67891',
                          '64709','28809','60198','90054','86263',
                          '52749','96775','62118','64856','94300',
                          '70436','10785','17860','29869','67448',
                          '25262','78740','36532','83093','15090',
                          '50113','96114','71999','30062','30467',
                          '72977','87092','66504','28180','60957',
                          '97755','55896','23133','86897','24976',
                          '32065','28163','23271','72827','22972',
                          '59216','37959','54237','41871','61241',
                          '35442','50201','21707','43380','14167',
                          '87003','88640','66900','89383','17436',
                          '68378','48380','28085','28121','82901',
                          '87644','82849','14446','45412','39786',
                          '75327','36979','46722','27605','91581',
                          '27061','59314','82949','80141','25829',
                          '74307','97372','73342','68128','55985',
                          '50497','61843','24563','90412','28235',
                          '68775','96735','73464','29650','77491',
                          '68636','59409','20916','77258','20988',
                          '17312','66839','59939','37052','89979',
                          '93125','82885','18178','53151','29849',
                          '20491','52090','64600','92374','46070',
                          '32497','67673','59829','56685','68230',
                          '58763','48864','33172','21244','24072',
                          '17084','43680','49848','17848')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


