
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '49695','57279','58332','13755','68142','64730',
                          '26446','28855','84550','89257','54105',
                          '67483','86036','25671','43598','99454',
                          '51473','41143','60213','99434','28269',
                          '48257','31017','34138','58392','11230',
                          '60029','61161','65998','96989','71168',
                          '59813','59306','86262','19358','54949',
                          '46086','44964','27057','31744','78686',
                          '16499','21327','59352','84336','99543',
                          '95513','20534','97847','87982','74691',
                          '78591','47178','87019','98486','76676',
                          '34784','24169','92118','35315','79532',
                          '74493','90041','85733','93798','61952',
                          '82364','86868','97902','54757','91888',
                          '20048','57850','43231','24534','60865',
                          '10625','37785','65778','45184','68590',
                          '58900','97623','60695','59227','49354',
                          '63873','80832','58969','92660','96744',
                          '76792','61378','90063','93504','74603',
                          '70516','30084','59245','81687','98287',
                          '39663','91728','41283','65408','26018',
                          '68815','58748','58964','81925','75555',
                          '20128','13595','96805','79921','24379',
                          '75626','61292','96259','57502','97959',
                          '74233','21432','46563','61742','32576',
                          '71554','48177','93654','32166','17424',
                          '36603','72687','49477','98265','94050',
                          '50162','10024','16600','58853','21729',
                          '79386','99582','81640','58155','42668',
                          '28289','46721','10203','49473','25529',
                          '67793','86255','76055','94240','35251',
                          '53769','45495','66159','50318','61860',
                          '19918','49991','14412','87517','93494',
                          '66266','91910','94329','26511','93523',
                          '64701','78671','96876','98352','39118',
                          '19543','33021','60290','32952','14723',
                          '17619','41209','15668','63971','56676',
                          '14248','35750','48459','64038','75223',
                          '39338','65902','44511','75996','51757',
                          '99141','11000','33261','84201','68776',
                          '25632','54037','56003','16897','77052',
                          '19138','44664','18007','44525','60686',
                          '81802','17037','81307','39643','88628',
                          '81931','18992','42992','48963','73970',
                          '98912','23811','49461','57748','54797',
                          '93884','37530','45275','74150','13341',
                          '40928','48364','82659','16893','40646',
                          '76410','49147','41043','52828','99880',
                          '43834','64486','14589','32488','38768',
                          '36145','65145','98885','59510','66000',
                          '69507','83673','88412','90293','10100',
                          '43062','95332','60105','55429','15694',
                          '11001','66876','37254','54409','76498',
                          '58470','94223','67447','54173','56497',
                          '68788','13974','90470','61968','57815',
                          '47792','16726','40951','53032','69882',
                          '65541','67157','26393','26835','36089',
                          '63063','99721','11943','75536','29954',
                          '89978','14660','19746','80716','66758',
                          '71505','43533','10476','42560','17137',
                          '61764','46283','60456','17257','15248',
                          '49142','34869','49128','30722','55572',
                          '51426','98663','58145','84168','29298',
                          '54084','89002','40398','41032','19355',
                          '98520','10058','66129','75431','26212',
                          '38884','54543','91209','98568','68998',
                          '75666','16277','11828','28729','78132',
                          '65639','52350','43779','25197','29730',
                          '33615','52334','76866','51003','37869',
                          '36711','64402','13763','71450','52480',
                          '28649','42559','54151','88190','74871',
                          '67987','57459','45684','38942','78140',
                          '69004','79316','87525','91748','65891',
                          '88441','86742','86983','89624','15768',
                          '39650','56982','74503','35987','97722',
                          '17079','42803','43842','92915','38921',
                          '81601','79867','46694','37848','34513',
                          '35147','63087','79414','58518','76785',
                          '49425','83435','21684','50221','18578',
                          '26556','40990','11104','84404')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


