
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '59053','22027','77336','70316','76773','16397',
                          '40230','39527','26494','33662','38903',
                          '68062','41545','24799','21327','75742',
                          '67051','38906','50571','21825','50382',
                          '73428','31805','19815','19669','46408',
                          '15455','94384','18015','79235','72703',
                          '53810','84362','42769','43939','15129',
                          '47647','96480','60666','55747','30214',
                          '71886','10561','25133','23430','86579',
                          '86213','94526','15097','66925','13807',
                          '37575','82331','60299','83704','86920',
                          '24994','66600','18767','77068','25415',
                          '11480','81501','69759','54524','63496',
                          '74538','21218','86583','55834','26776',
                          '20784','70676','71969','64985','85297',
                          '94356','50630','61644','59147','21700',
                          '51028','39189','14022','22849','51471',
                          '84039','16488','77864','51713','80190',
                          '83079','76459','17393','54922','47133',
                          '39350','55694','71029','65087','72945',
                          '26889','21260','20268','16883','39159',
                          '73532','68286','62790','57353','59567',
                          '11123','77396','44207','22176','47009',
                          '82059','72481','61398','62013','33205',
                          '19877','38633','66656','24276','37830',
                          '95273','68720','72018','57832','38054',
                          '37734','58578','11984','61795','80158',
                          '84081','93452','63179','87667','67185',
                          '79389','16176','29670','54147','10757',
                          '20359','99977','15748','32795','33525',
                          '54945','79360','30324','21746','12426',
                          '91550','15146','26101','23489','83925',
                          '60841','28931','73117','44834','57243',
                          '30667','91504','18463','44901','84107',
                          '52823','38062','86621','66088','14388',
                          '70269','65999','71300','81491','44909',
                          '69202','94905','70402','83713','57478',
                          '55347','59701','26981','37992','35016',
                          '63015','69465','19372','45345','63102',
                          '65918','33727','84624','26123','79987',
                          '14786','36305','82950','33238','14395',
                          '24813','85118','33904','36582','14355',
                          '32018','64663','84769','70263','17362',
                          '71621','87259','44941','92308','26176',
                          '44400','35154','51609','32390','48144',
                          '33433','90408','13612','81198','86629',
                          '18942','24240','98215','39525','28819',
                          '13732','46424','14275','37447','38890',
                          '48446','52725','57134','61100','69499',
                          '54298','45367','91903','19842','20216',
                          '53506','86266','33519','17402','30981',
                          '97849','86455','52642','53880','20902',
                          '60064','67852','47908','66996','32687',
                          '86350','16330','96938','11659','68949',
                          '47897','18782','18367','24080','68140',
                          '91377','47404','25263','78811','14188',
                          '89337','25334','97533','22485','91914',
                          '95527','29997','55446','51236','12648',
                          '56827','44175','46579','92934','16714',
                          '54161','43127','79891','85642','25436',
                          '90721','32247','81438','72962','27730',
                          '70930','70139','24774','67571','75147',
                          '26261','45666','60269','11296','71727',
                          '70548','34893','26468','43827','44260',
                          '95480','30887','66895','10170','50684',
                          '98048','80409','37923','89711','83524',
                          '26987','29256','98872','86242','93894',
                          '81128','81219','85462','53592','95206',
                          '29303','24311','42429','23187','84612',
                          '21724','55851','97959','88523','11773',
                          '75248','75306','10184','52373','68614',
                          '42749','28578','49776','88246','54164',
                          '60652','25744','16689','89270','40090',
                          '29125','58046','96457','52848','23969',
                          '32775','19177','26856','19379','49819',
                          '24078','99454','53493','42323','45796',
                          '29514','87543','14767','57903','66259',
                          '86568','65063','74503','37057','88511',
                          '90166','25375','85756','96165','98762',
                          '97750','29933','58072','83689')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


