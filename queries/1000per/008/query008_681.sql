
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '33933','15698','44686','15551','73245','68290',
                          '12280','86325','14257','68096','11591',
                          '65972','30109','55854','10864','94891',
                          '80595','22539','23427','34625','44813',
                          '17276','26090','33069','24587','53103',
                          '30512','34806','18371','29878','86335',
                          '54030','75069','62473','36355','65490',
                          '33753','72113','44969','38108','62476',
                          '47424','59300','49611','38666','33255',
                          '56104','18996','65283','23455','16172',
                          '38451','52576','80535','36319','79242',
                          '77254','82986','87433','68242','49280',
                          '13461','18574','97439','34314','30420',
                          '51467','49893','62102','62850','30192',
                          '65198','85300','35146','28916','56787',
                          '23258','91633','30776','84341','99393',
                          '79651','70859','86005','69634','68366',
                          '14622','78552','41256','34810','54300',
                          '83382','70379','16386','50428','92870',
                          '84752','67602','53543','45313','19373',
                          '67272','50199','13182','84267','93423',
                          '58813','24652','22195','83557','52786',
                          '84896','66209','82187','30888','26129',
                          '29635','15810','23190','39660','28422',
                          '32919','94311','69172','40523','20265',
                          '55195','26031','83969','51941','92418',
                          '99176','60100','88440','90860','21436',
                          '33128','70416','91458','35546','79409',
                          '50640','10273','10761','10353','53001',
                          '27191','57724','63752','77787','27114',
                          '43578','71339','29304','99915','33708',
                          '83283','47491','85072','98421','16617',
                          '77405','65880','51694','59276','53550',
                          '10047','85605','69843','75038','53551',
                          '66817','33875','10420','86376','72286',
                          '40930','75550','54104','96049','72302',
                          '91076','56609','51044','57148','12664',
                          '48545','79547','27069','32098','32512',
                          '24005','87040','82622','20613','61224',
                          '52287','51858','80335','84360','68293',
                          '21353','35073','19401','13924','51340',
                          '59947','92454','48165','45423','40627',
                          '46964','65901','30373','48042','24530',
                          '79675','32006','57154','24014','72856',
                          '30025','27858','78823','11653','96767',
                          '91590','11699','69072','91406','73045',
                          '74939','18452','98529','81855','99313',
                          '56712','19515','61728','93765','19872',
                          '15088','56260','76878','85460','62347',
                          '16057','13666','32202','53782','10975',
                          '49494','80534','13702','74313','29624',
                          '17633','99868','73189','72750','42038',
                          '35142','98330','89408','72178','32345',
                          '92405','84729','35902','64347','57183',
                          '57862','22163','37213','39125','55711',
                          '82715','99810','18266','57612','69849',
                          '76324','17245','54200','88263','84177',
                          '89562','46575','32574','62608','54236',
                          '21784','31420','30891','14965','51264',
                          '90134','99824','47481','69289','13424',
                          '65487','47951','17921','36775','72218',
                          '18202','24683','32281','91374','18470',
                          '91621','41608','53965','46925','57097',
                          '80415','62691','23862','55726','20573',
                          '79645','10196','59438','95501','80320',
                          '81774','79884','64100','63374','79706',
                          '32068','89342','96408','20860','77764',
                          '75136','30367','66861','78270','30881',
                          '72100','71170','76720','89828','65848',
                          '52338','53057','94915','42250','90304',
                          '21402','29099','76542','57014','39471',
                          '26411','28878','33286','95662','85512',
                          '88261','24604','38469','23891','22962',
                          '49672','18596','37047','76617','43535',
                          '86051','42517','40212','91771','21583',
                          '53928','69791','16720','17119','24060',
                          '25987','45120','29542','82488','56569',
                          '54744','86833','63969','49410','66830',
                          '44026','24737','19448','65291','46265',
                          '50737','77655','45192','12491')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


