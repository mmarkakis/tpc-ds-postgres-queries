
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '19383','39158','46060','40191','84741','22938',
                          '62134','56062','99078','40544','42741',
                          '43827','19095','95421','14023','95474',
                          '17563','79833','64073','85779','95075',
                          '44720','92664','93517','62653','15376',
                          '95868','76448','43656','38116','98480',
                          '70935','81977','18325','59899','98469',
                          '73455','69943','85061','95803','32865',
                          '27644','63802','85178','96135','61769',
                          '13486','63335','43905','26044','97184',
                          '49581','77342','93650','13449','37105',
                          '40553','20851','14087','14162','36612',
                          '28520','99056','13256','76507','76548',
                          '25970','66182','84001','73202','15331',
                          '28726','54459','56352','16971','70471',
                          '75008','23417','38675','76061','95655',
                          '72981','47352','80191','45707','86142',
                          '47482','15736','86380','39023','70349',
                          '51695','86758','66497','59402','36645',
                          '54980','45636','40121','50610','75076',
                          '35098','98613','61686','49279','56481',
                          '98821','19057','99661','68367','30824',
                          '37492','93598','22130','24808','75352',
                          '28364','49965','78630','32407','97934',
                          '88492','28750','57507','72080','81077',
                          '96572','27866','69144','31863','32942',
                          '74966','29794','55725','35228','98068',
                          '75212','63236','13913','60437','93509',
                          '89817','98592','25156','74753','36630',
                          '96751','89288','13380','31304','68405',
                          '23720','63326','36611','93719','61630',
                          '66371','41303','15994','40968','53949',
                          '73900','81428','11316','19835','38934',
                          '76559','25775','66340','98333','77183',
                          '73830','54979','80911','61271','71403',
                          '68319','42603','82866','57888','35779',
                          '77304','31541','89868','76211','38716',
                          '87613','64470','92744','59794','47479',
                          '60195','49351','48623','21112','21337',
                          '10401','89268','96288','16303','70917',
                          '62053','97921','75213','34759','54089',
                          '88771','36094','36118','93849','10944',
                          '89102','66813','28443','75656','62139',
                          '85327','96717','57102','59156','97949',
                          '29664','42372','62951','33266','55974',
                          '82186','60117','38034','84914','94371',
                          '45473','96243','20059','66493','15328',
                          '24018','45629','87995','93209','56882',
                          '49723','18725','16660','46193','30111',
                          '11814','98335','97655','57457','20412',
                          '20706','10247','45783','73277','61746',
                          '39641','16573','81293','17900','27212',
                          '76706','57243','81493','62896','26385',
                          '47943','82895','93331','37401','66524',
                          '35282','77193','18670','50083','23221',
                          '61513','20464','55634','57793','87974',
                          '78636','34803','32783','25148','35903',
                          '60182','48715','17562','23237','71179',
                          '55753','70866','78936','20297','21667',
                          '41808','68931','80370','54441','85545',
                          '94343','92116','87328','60205','88553',
                          '19916','64230','79916','45954','40900',
                          '76435','30307','99453','83515','56242',
                          '39751','92456','41847','56431','82297',
                          '57248','19239','46612','96931','47486',
                          '42897','32825','25091','79201','87601',
                          '18296','17075','81481','91174','35657',
                          '42207','75667','48432','12476','15805',
                          '84026','12955','46195','33463','33482',
                          '23293','21547','42590','37810','48111',
                          '36113','87970','25561','97036','40998',
                          '77945','49343','31008','82913','11328',
                          '11096','31110','50311','60925','36037',
                          '37221','25011','18050','53403','59029',
                          '17555','20835','41434','49384','44399',
                          '46639','27265','29034','99931','91799',
                          '12528','89221','90861','66669','80777',
                          '69692','35326','20512','41911','63589',
                          '65245','45163','85264','90411','89373',
                          '71210','18658','83743','10538')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


