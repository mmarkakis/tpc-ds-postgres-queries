
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '12178','44098','45905','91866','11861','58714',
                          '80701','19298','98981','46025','79336',
                          '99192','50088','43274','43564','50609',
                          '86910','97963','96739','78021','55526',
                          '64548','10385','74075','75488','42299',
                          '23350','91777','67574','38405','23704',
                          '12882','97112','43934','88448','56715',
                          '61567','91888','63645','41183','74680',
                          '82156','33968','32996','25194','32013',
                          '42356','42733','47958','92492','26567',
                          '53912','31420','84170','94983','97617',
                          '53141','24893','65096','18302','60913',
                          '69319','83915','95102','69486','91040',
                          '44069','86083','16754','99429','21764',
                          '18987','62483','94531','49743','75089',
                          '90900','28367','92292','45092','68538',
                          '71201','91860','63785','64238','75272',
                          '70386','38303','76951','71209','22205',
                          '38551','45925','69430','28423','25347',
                          '66364','49173','25557','22857','88563',
                          '24362','16817','99664','74814','95255',
                          '74996','60799','28852','70068','92264',
                          '75336','45973','84626','39173','28849',
                          '88518','77722','66304','90442','42508',
                          '88511','23338','96769','51741','14768',
                          '78668','37207','19625','71503','83090',
                          '55797','68722','42739','55497','74884',
                          '54666','11798','64697','57295','53805',
                          '46857','46796','52341','54779','63548',
                          '75422','98994','91788','67006','88370',
                          '67145','70853','18058','48562','62712',
                          '84708','68890','94463','59485','55080',
                          '61262','29712','48136','31859','62221',
                          '74711','53227','83197','73800','50395',
                          '24883','16213','62828','11312','27984',
                          '50442','33897','89979','52229','19567',
                          '43857','66227','72486','46996','84910',
                          '36764','72906','60106','48506','56394',
                          '67839','45639','29711','59335','63740',
                          '30031','48817','46937','97100','17446',
                          '45942','18689','97145','60878','11602',
                          '39246','79623','41771','76131','46635',
                          '41028','80222','51954','79293','55725',
                          '86173','87554','56914','11943','22539',
                          '15414','35755','74833','78049','69914',
                          '36311','36715','95844','48190','89532',
                          '58000','51305','20783','56539','26263',
                          '83370','86059','57752','36600','53882',
                          '99975','76359','20710','34789','15665',
                          '89473','75700','24689','96858','59562',
                          '30025','39422','21884','19606','76243',
                          '87419','22243','73407','51827','73430',
                          '78434','87152','70492','12481','34229',
                          '46395','30029','86135','11835','38755',
                          '37782','10015','53454','45081','84128',
                          '76840','33656','12375','20639','11674',
                          '34897','70398','44584','53731','44648',
                          '23690','20182','83764','23324','23625',
                          '33010','59201','94249','56677','15691',
                          '17336','99161','24606','62251','40790',
                          '81495','12574','33805','35226','33425',
                          '40280','16483','82137','84340','42621',
                          '22832','37378','66674','36787','79460',
                          '88399','74369','33479','11813','62337',
                          '39305','87888','45345','43957','55024',
                          '20788','31165','47516','27638','31415',
                          '10334','67756','50167','30735','84110',
                          '85682','69489','59101','55464','64331',
                          '51859','40594','69561','57748','96089',
                          '35717','50309','74960','12816','71298',
                          '94027','13105','27654','30429','69531',
                          '32685','56183','63425','63378','57405',
                          '77152','84139','56579','26040','15641',
                          '78598','42171','49254','75305','46323',
                          '28472','13549','71028','81253','44410',
                          '21503','27861','32653','98418','63243',
                          '94731','96805','97826','10363','43576',
                          '64285','72346','41847','68967','22304',
                          '96283','56098','18198','65909','40884',
                          '35255','76841','29270','57445')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


