
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '97872','28682','76117','60922','70203','57410',
                          '66819','23444','54917','47143','56470',
                          '85814','58043','39401','89552','94046',
                          '36855','89777','59380','89287','20950',
                          '84221','15481','56613','27006','31355',
                          '87905','67959','79730','44977','34177',
                          '16879','29371','90068','44438','66671',
                          '13256','89047','69925','54269','39765',
                          '77237','17359','83267','76555','63216',
                          '87195','68049','71669','25013','62702',
                          '85492','43717','46336','37630','71816',
                          '76550','66173','29216','52071','86356',
                          '37857','23357','30183','87364','91039',
                          '90228','96452','35069','68032','28584',
                          '98416','36805','48368','62442','35922',
                          '19724','55443','91230','21435','37604',
                          '36574','12747','61797','22799','63137',
                          '39698','61461','43389','21368','58846',
                          '70608','14155','48345','79728','54412',
                          '17728','41176','67901','19078','10095',
                          '57676','86513','62126','32829','81214',
                          '60461','45715','93190','86244','45952',
                          '27547','77384','88202','38262','23990',
                          '96001','71461','24073','63071','39101',
                          '48147','35779','64802','39012','63907',
                          '19899','78932','38186','53704','84031',
                          '26327','83445','22837','78395','31236',
                          '68645','55564','95261','92967','50780',
                          '73434','94940','31394','57704','64762',
                          '96772','60993','83447','39358','71149',
                          '80060','87433','78221','61769','75112',
                          '67614','57351','49844','58013','87167',
                          '56556','81350','58643','78060','26157',
                          '30582','43064','44098','33154','61796',
                          '25915','56287','55794','74652','89471',
                          '67932','88539','86618','54049','88320',
                          '83555','71181','93446','98796','16474',
                          '22191','32758','27394','26043','17448',
                          '47161','12547','92166','38277','96300',
                          '38322','78407','48189','40110','91037',
                          '51230','24661','58261','61356','17825',
                          '77499','65294','66420','28130','54405',
                          '62364','70895','74623','80031','56320',
                          '90111','21478','62138','87849','51121',
                          '31247','44251','76845','62302','21869',
                          '85576','49440','73584','94676','49578',
                          '60381','87089','22997','58780','17332',
                          '45677','37095','64116','81874','56512',
                          '23689','32190','50100','25779','44519',
                          '15012','78156','82052','87165','90017',
                          '68377','36581','23419','73770','85590',
                          '17553','41109','30805','12440','46644',
                          '59240','94813','82532','15489','61757',
                          '66586','76446','23177','37225','24257',
                          '69231','30514','92133','54010','40615',
                          '25691','77276','19590','91247','62686',
                          '39766','94534','58469','71966','96829',
                          '30697','34276','49857','89305','42381',
                          '98846','34368','85512','23133','82260',
                          '23172','32219','53570','86666','54934',
                          '11602','95116','57332','79794','32022',
                          '91464','41539','85838','89981','51466',
                          '98716','61392','21901','72331','65468',
                          '32976','58694','53499','82070','11600',
                          '87757','34493','32332','75799','71474',
                          '53282','27717','74966','67782','74401',
                          '86836','80688','41796','89658','11044',
                          '76365','92364','96710','27066','44943',
                          '29362','86306','30111','68226','40047',
                          '29914','81735','96463','71832','18691',
                          '11007','67260','56399','40958','21964',
                          '12540','38194','21187','15920','31878',
                          '80007','20482','29701','75724','87052',
                          '66023','45425','34700','50018','16159',
                          '40297','13073','95140','35103','23919',
                          '99255','62609','44557','98145','94944',
                          '79819','49249','56455','97810','32400',
                          '14042','47258','11039','46963','12866',
                          '10613','18729','56343','29871','48437',
                          '62602','13268','83463','59524')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


