
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '11673','83128','60442','62169','96143','84192',
                          '75530','82750','78635','48403','42648',
                          '14451','55402','30455','93237','34764',
                          '27979','23418','28785','27478','28652',
                          '52765','36049','59374','27002','55484',
                          '62655','22828','13906','40361','15371',
                          '79871','18123','94394','66931','64643',
                          '58651','92401','70501','29006','72360',
                          '56915','60196','11512','69428','13463',
                          '94310','90861','21047','17345','96770',
                          '40792','47304','39898','44455','35368',
                          '96532','16025','60378','95596','99046',
                          '18686','93761','27098','91538','68184',
                          '36730','64893','53530','77524','31319',
                          '63003','12294','57309','42685','88732',
                          '93883','54056','34665','42019','84993',
                          '56532','89066','62269','21803','76426',
                          '29212','23593','74296','70054','66312',
                          '18775','61759','78127','98703','54065',
                          '21280','79904','91409','76361','18799',
                          '45521','14261','19215','85931','90565',
                          '10726','16592','66415','53543','71429',
                          '20691','36752','12791','40569','76493',
                          '69172','78205','12957','11125','82731',
                          '96492','29745','86194','38311','71768',
                          '52459','76946','76876','47806','93241',
                          '30889','29608','42002','22331','66159',
                          '12048','40422','75922','92478','89438',
                          '56786','44299','22947','21645','85661',
                          '36818','50557','25757','26634','48320',
                          '59741','64207','15676','76337','52250',
                          '27647','26860','19912','28781','83730',
                          '43965','49881','66010','13521','66092',
                          '53753','67664','77418','31646','24385',
                          '62138','77743','27143','66462','82143',
                          '90179','59179','27971','46196','64457',
                          '45199','12343','34958','38581','62668',
                          '36972','54932','63993','61416','71155',
                          '49444','29229','81864','36224','31726',
                          '27918','62661','16079','40835','91010',
                          '59316','71895','91466','82474','27573',
                          '96080','57730','56871','14183','31453',
                          '68135','43869','45523','91660','13711',
                          '20963','28806','19056','66872','60682',
                          '79415','24485','15015','30429','35349',
                          '58443','24146','90995','34402','34265',
                          '11788','17228','28705','73471','51875',
                          '73495','19154','55966','45781','47094',
                          '87759','90763','36018','81879','49202',
                          '53102','59792','48015','14007','16850',
                          '95848','35028','10708','34452','21856',
                          '40309','34398','70510','98392','94914',
                          '94200','72937','65338','67375','18762',
                          '77209','56386','72021','90269','61877',
                          '91147','57027','32455','91075','71876',
                          '33301','86092','30331','55905','67617',
                          '21539','52032','68667','51457','26697',
                          '77559','90447','98450','82931','57375',
                          '80602','62221','86561','45277','52244',
                          '92342','96894','62027','15807','40472',
                          '73366','76408','32579','91300','71159',
                          '94499','10841','76469','54441','54476',
                          '83914','28738','94934','77667','71792',
                          '74747','71905','38359','52739','12625',
                          '37958','55511','14752','40920','87531',
                          '82325','15864','99524','87580','48687',
                          '96495','96513','77386','82997','10942',
                          '66395','84555','14533','52485','81554',
                          '36371','69069','42557','16546','15221',
                          '79640','69187','29227','96753','94866',
                          '26783','92449','33125','79044','66260',
                          '21244','27883','59692','41966','36403',
                          '74518','51240','50996','64377','21556',
                          '55739','64450','98109','58536','53720',
                          '27151','71930','45313','45617','34097',
                          '17402','28561','89538','51510','55228',
                          '76764','86861','13391','59435','72231',
                          '51259','95975','34113','20283','59140',
                          '41043','30729','62814','77884','26750',
                          '72150','31816','86451','58430')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


