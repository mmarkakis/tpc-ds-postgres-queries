
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '88204','25374','54481','79134','55254','84617',
                          '77837','68413','87470','57926','62677',
                          '59039','79858','15797','25719','75166',
                          '67584','33676','52927','92133','63464',
                          '39539','81704','92976','19909','60805',
                          '37444','63194','90297','32866','25328',
                          '84252','36115','76573','41791','33771',
                          '40781','33398','45118','28987','96427',
                          '25208','50915','78631','71971','99406',
                          '75103','75237','18809','86255','72644',
                          '55083','63487','44868','70711','44083',
                          '22616','56138','44554','56986','66173',
                          '98579','99484','73455','69937','66147',
                          '64784','40201','33108','18316','75152',
                          '10666','77766','31938','19844','91241',
                          '93785','92955','61107','37401','61587',
                          '42890','37594','34277','34964','80400',
                          '23296','72424','80610','69713','17728',
                          '27288','24106','97377','66893','39867',
                          '10229','17943','93713','59021','69400',
                          '73754','20865','40146','26143','70378',
                          '63301','17133','45468','98843','59602',
                          '39180','92934','30080','89862','62012',
                          '79574','71606','31250','42668','93997',
                          '30238','80477','38062','44519','42517',
                          '13148','14288','13502','50325','40370',
                          '58854','46679','39256','65567','65408',
                          '29564','83796','41840','39429','61491',
                          '24995','63738','17192','48965','79175',
                          '63080','73015','78139','75442','65066',
                          '24336','93009','87459','44247','64049',
                          '68850','34834','39159','71732','70577',
                          '29679','46263','44336','10521','36080',
                          '56753','63932','88836','73758','11333',
                          '98363','39398','69489','89131','47762',
                          '89597','54370','57762','66937','45156',
                          '68563','47115','17165','51638','99690',
                          '43708','20884','64663','76395','93990',
                          '58015','48128','19862','96221','95795',
                          '83725','41004','36389','94470','81202',
                          '87633','85016','12196','80121','67193',
                          '58755','36213','62399','26272','65083',
                          '12446','90185','17937','29760','89394',
                          '36757','71467','70426','58107','87297',
                          '60222','58250','38281','95514','44996',
                          '66206','11890','50667','64831','69263',
                          '24100','50807','27465','47612','89338',
                          '61007','17122','77109','59231','13250',
                          '59267','35180','16396','79520','69811',
                          '68752','66229','66434','77934','50994',
                          '62704','35172','82891','94719','22252',
                          '61832','40524','31895','50709','41031',
                          '43333','73003','11806','19448','41944',
                          '35962','18189','85311','22091','88035',
                          '89144','86995','85569','66234','65568',
                          '84282','91982','71482','72365','80951',
                          '77012','82184','73608','59575','69151',
                          '89543','44801','46415','73669','78779',
                          '86631','38212','72763','35837','39553',
                          '94059','54856','89616','27757','77037',
                          '96040','99987','31618','71145','62574',
                          '26597','45661','33326','56825','18557',
                          '89751','25461','55348','46281','47061',
                          '15272','60638','63753','15296','12743',
                          '59110','85015','55623','37830','70027',
                          '45481','41096','65811','56313','18379',
                          '16418','47729','67985','31176','91363',
                          '64101','89007','70033','35245','90484',
                          '47771','36280','49554','20699','69964',
                          '88376','15924','46727','67634','37848',
                          '31721','99060','25044','94155','29716',
                          '90155','80956','23928','23604','81534',
                          '26299','78970','17784','49533','21559',
                          '32875','35044','15059','51747','20815',
                          '44314','34848','57821','10140','19034',
                          '43311','76080','78483','29311','48944',
                          '24852','81903','35416','79936','55029',
                          '38746','73216','52626','99374','44955',
                          '41814','29598','51720','76043','52644',
                          '50963','32314','99671','46201')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


