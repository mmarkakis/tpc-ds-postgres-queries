
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '60220','14240','43837','88932','30527','67303',
                          '77775','81155','62434','40926','40780',
                          '35169','78867','19502','81585','85226',
                          '81541','49418','49391','68008','96890',
                          '93494','37338','22385','96733','39089',
                          '43202','93107','55359','11435','79329',
                          '50423','93674','60209','98821','94594',
                          '30760','42781','65708','70259','37545',
                          '78924','40578','86611','90221','81068',
                          '65480','97765','31897','24635','11458',
                          '45973','30505','63367','19952','77157',
                          '29622','99073','31374','41743','11817',
                          '93913','70629','51765','93484','17520',
                          '93158','50934','16900','46423','63831',
                          '77998','38594','86126','88113','99119',
                          '79163','18414','77267','24990','84976',
                          '28180','80893','72706','32539','44080',
                          '40523','26519','31397','74866','61658',
                          '27458','94654','93052','27017','18564',
                          '12217','10188','95337','66447','59724',
                          '83991','48256','26683','24018','73032',
                          '81712','17995','16429','84799','71641',
                          '38074','48314','13311','37090','13677',
                          '42618','39259','37425','97000','77209',
                          '68701','28890','74507','83760','56590',
                          '98876','89902','89124','64313','31707',
                          '75042','61293','13425','83129','35081',
                          '79205','61025','90065','63782','40294',
                          '36938','29040','52357','68710','49106',
                          '84531','69298','60899','44076','78682',
                          '68900','43636','10349','15467','69372',
                          '32790','70067','19281','85765','33257',
                          '78632','41023','92449','93427','11996',
                          '76605','58939','29587','73891','88883',
                          '86509','64499','53077','39980','50168',
                          '23942','33305','70404','87201','40956',
                          '96310','18220','16610','54836','85841',
                          '20063','44135','97266','60499','28105',
                          '29122','82974','33504','37359','86972',
                          '93848','74800','73704','96379','58916',
                          '18227','54398','89712','14825','50648',
                          '38454','37021','67457','26066','33956',
                          '34145','51442','60761','95995','12037',
                          '88219','67290','46557','36799','98076',
                          '48056','93312','70049','87901','66418',
                          '98698','97398','98763','12942','20703',
                          '47274','55020','59461','20389','22189',
                          '39323','24774','40857','11028','55170',
                          '10883','97497','47566','60932','21236',
                          '55173','21080','48877','62464','17417',
                          '86698','73707','28587','14846','97516',
                          '98883','89041','54051','70621','80705',
                          '73237','53256','32889','33980','74063',
                          '23213','16051','44950','77623','41246',
                          '58304','57801','35322','32834','45896',
                          '40635','80857','19644','97351','34415',
                          '91805','29744','80823','37416','80747',
                          '13429','21159','46939','95645','20647',
                          '17055','70087','40027','27978','61770',
                          '87374','17587','19874','24634','64875',
                          '91930','54314','47532','19109','40341',
                          '52026','99993','42458','21976','10007',
                          '40465','42725','67520','22620','35288',
                          '92611','73157','67727','77313','62397',
                          '86937','58122','21801','35279','74392',
                          '47291','78350','39637','95266','44849',
                          '27494','90565','90893','29053','36064',
                          '83033','83874','35153','21038','58890',
                          '71754','75815','84653','74538','90051',
                          '91343','91663','58370','57326','29199',
                          '85144','51095','76208','98729','38824',
                          '71611','72030','60362','27362','20401',
                          '98689','99167','59296','61342','75659',
                          '64457','73596','63892','89764','29488',
                          '89479','38982','76352','98454','78514',
                          '70891','68381','98041','16095','72313',
                          '16399','93962','16849','26924','99457',
                          '69894','41812','34061','81714','34671',
                          '33291','96913','28968','18193','26224',
                          '31929','55048','15065','65441')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


