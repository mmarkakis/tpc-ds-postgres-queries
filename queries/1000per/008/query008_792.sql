
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '94999','98265','51421','28614','26131','53999',
                          '23197','64145','65128','37112','20333',
                          '85396','95631','71021','48434','35627',
                          '35871','97662','16255','85770','42958',
                          '42803','38256','12578','92766','96282',
                          '19203','24947','44658','59644','61277',
                          '49190','23334','64624','73700','16813',
                          '36701','16121','56291','44933','85000',
                          '72344','82870','75795','67943','68648',
                          '42602','90129','80333','36833','32774',
                          '15719','65167','27124','18143','32428',
                          '11280','70039','70561','90986','25300',
                          '27481','17356','74441','70120','78216',
                          '28314','49642','82807','46339','78280',
                          '80940','99972','99014','69601','10844',
                          '52780','54420','98483','15052','72712',
                          '14838','86025','17306','71789','12725',
                          '39945','74669','72693','61802','26270',
                          '22865','69980','15967','94067','43385',
                          '81054','17793','10794','23544','81756',
                          '10690','73997','10224','96662','59243',
                          '41744','32401','62088','88596','58034',
                          '93048','28362','46871','97320','59356',
                          '16672','76547','95721','12250','87498',
                          '14699','51604','81548','19891','24745',
                          '87104','82564','75840','32822','70544',
                          '57373','84258','94110','84771','94549',
                          '91409','46601','55541','18506','79286',
                          '75682','95447','77546','17293','65706',
                          '94524','86332','27820','78168','13077',
                          '95298','68940','59875','18861','51330',
                          '52599','34234','16419','48721','36153',
                          '38607','48496','54024','61021','36063',
                          '42291','63204','58565','87642','24738',
                          '86199','23447','61209','82563','20633',
                          '32795','59580','71167','94589','59604',
                          '50423','36903','17290','11739','49884',
                          '23235','49285','30022','82417','80110',
                          '96664','66805','75281','96135','52367',
                          '27134','79274','99481','99626','22108',
                          '30477','46550','98316','37193','82295',
                          '90365','62932','26114','88699','42092',
                          '52725','64462','83018','63409','20985',
                          '54823','58792','26657','63863','69740',
                          '16892','81303','46034','78658','44630',
                          '78607','13094','24966','34906','71748',
                          '24106','41356','37306','60138','91895',
                          '13032','21539','75884','56298','39273',
                          '99676','41031','18942','86183','97743',
                          '96955','38542','49897','94140','51665',
                          '73374','35962','51443','82056','39998',
                          '36735','38710','47409','24486','32050',
                          '76945','82672','90980','97793','60135',
                          '95995','91650','77273','20841','30673',
                          '16992','41012','59853','74819','78037',
                          '69747','19477','19085','10642','36374',
                          '71599','20379','80458','88937','40569',
                          '55221','97901','44355','68683','28642',
                          '96854','66354','88562','29086','90172',
                          '86667','21444','75273','81113','12980',
                          '76911','72981','76878','96088','47581',
                          '70057','28878','74347','68063','11995',
                          '63293','49838','14831','53759','81620',
                          '40809','34780','69091','56356','11848',
                          '94036','26980','31855','92180','15142',
                          '41686','87749','71770','48278','50078',
                          '26027','98682','15539','39851','71965',
                          '91873','74692','32482','56619','63762',
                          '15471','63320','43767','75794','27225',
                          '50325','40917','31342','72050','26830',
                          '15794','65291','26524','35685','89087',
                          '53111','82857','13019','53835','28021',
                          '22723','99002','96681','80349','25957',
                          '77443','70318','24073','12211','51255',
                          '36415','37442','82457','49148','68458',
                          '43764','74655','80684','81465','37337',
                          '57464','78645','86064','21473','26515',
                          '41993','39767','52473','88849','28216',
                          '93115','69718','13647','31743','65327',
                          '67919','74137','40657','84892')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


