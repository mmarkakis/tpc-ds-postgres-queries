
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '49570','55548','52454','23343','27588','40103',
                          '65312','92714','96767','28923','25794',
                          '49820','58708','65851','16005','15671',
                          '35442','11182','98434','79559','11535',
                          '49629','99311','82776','88873','51009',
                          '94744','59351','71328','64905','44955',
                          '89506','95069','95643','52170','96817',
                          '70200','43508','13497','75081','96063',
                          '84404','58824','74914','95902','13339',
                          '46272','99183','84907','52508','44539',
                          '24137','25739','38083','24454','70870',
                          '50993','43503','64171','36226','34744',
                          '15704','20332','46513','53866','63488',
                          '47300','19862','98025','54181','30240',
                          '37690','83798','61245','16947','12452',
                          '85460','26226','18407','63418','98753',
                          '99446','68276','12434','82072','64549',
                          '78755','60120','88504','97036','73917',
                          '65368','29646','17723','37192','12097',
                          '70893','23830','11156','80892','70565',
                          '12946','45198','98317','35894','77551',
                          '93185','35521','70091','88521','60183',
                          '12937','34814','48635','79099','72854',
                          '33118','81985','81491','84355','24673',
                          '84566','35450','28418','13204','92549',
                          '91884','58044','55816','54940','66704',
                          '31584','92351','99332','37943','62113',
                          '82791','75235','29334','35033','83114',
                          '26060','72186','94292','16342','11323',
                          '40776','52701','19534','45735','49461',
                          '58506','10770','30659','54367','92040',
                          '88819','11718','59627','74466','95455',
                          '81559','73086','47179','10353','23595',
                          '44677','77531','42837','11574','67342',
                          '86172','78899','60911','83696','88269',
                          '72689','55016','38907','95456','33063',
                          '10877','65652','44685','17240','53342',
                          '96572','56589','96522','33737','48142',
                          '94560','78469','63503','26478','19179',
                          '75590','99766','19633','11615','65752',
                          '64537','43142','98745','24509','35987',
                          '90210','71379','96452','84921','28005',
                          '85304','68351','60974','77008','34120',
                          '59379','21756','86938','63561','27632',
                          '73467','52523','44327','37822','61605',
                          '40554','73949','72173','56792','26266',
                          '45039','77789','11601','16909','86416',
                          '96066','73847','95320','55304','28245',
                          '95495','47904','83587','64878','65809',
                          '95151','69321','65564','41172','33231',
                          '32268','97833','26017','59510','25663',
                          '70689','99427','78866','89651','15865',
                          '37045','27825','47926','29243','84459',
                          '11862','21318','41325','10142','16955',
                          '68910','29025','30768','90490','98628',
                          '69750','73909','87134','45470','74417',
                          '19528','76117','33073','44270','51965',
                          '67303','83717','33955','15294','64917',
                          '62838','11110','79136','46137','94013',
                          '26383','87889','52472','80119','43838',
                          '78263','44993','22286','69823','75535',
                          '50033','34484','37154','93963','24442',
                          '61548','65735','92137','65777','74218',
                          '22988','64399','92908','69596','25679',
                          '50578','44362','78847','78980','89344',
                          '83169','18303','12472','60248','87132',
                          '52566','99251','98579','60037','21737',
                          '78288','39915','93409','27547','84067',
                          '51675','98221','58794','44737','95161',
                          '98218','70331','96473','44222','56808',
                          '74321','20932','54620','53798','76288',
                          '74424','34055','62816','20176','35483',
                          '56570','54040','66207','39233','36541',
                          '65552','26369','97342','40871','86678',
                          '53186','53590','42939','29031','49644',
                          '80894','77682','28541','69359','60838',
                          '15968','67625','87568','35395','12972',
                          '83083','66337','84799','35879','46570',
                          '12198','34466','92101','36756','13582',
                          '53100','95211','41547','31551')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


