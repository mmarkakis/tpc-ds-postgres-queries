
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '21054','86385','97817','65535','96407','38045',
                          '56336','60793','17605','22320','79248',
                          '74787','52904','84425','39728','66030',
                          '16930','77559','72538','92943','99149',
                          '89263','28961','83613','34165','58638',
                          '20640','46638','82150','86916','51798',
                          '54499','65191','39444','96000','63974',
                          '66985','92235','13026','61017','19468',
                          '31378','83324','54622','62540','83726',
                          '60012','57481','69248','48194','69260',
                          '86984','76653','56452','21387','51045',
                          '45506','50971','54246','26829','70885',
                          '88246','61499','22844','29598','88996',
                          '31687','50007','42653','19826','22518',
                          '17609','60553','20994','61132','43484',
                          '78042','66568','35733','96532','48408',
                          '16852','94339','53586','27927','27997',
                          '90857','18202','11345','19905','60774',
                          '48210','86179','43811','65526','41241',
                          '17931','28205','20064','33488','99923',
                          '54202','76624','83329','78050','59977',
                          '11376','40054','73400','51664','83259',
                          '50568','57318','39859','57106','11715',
                          '23272','84476','44003','14975','13858',
                          '81213','90925','76813','25809','19893',
                          '63533','45047','45629','14712','77682',
                          '12920','17313','73215','37983','70348',
                          '23521','97089','12639','70144','59969',
                          '86016','48630','34633','99999','34596',
                          '90965','51639','91469','81345','28051',
                          '32746','84321','69945','97704','15827',
                          '40365','99504','88288','67604','14204',
                          '29846','38368','14622','69656','72367',
                          '31348','43656','21425','36690','90863',
                          '65270','19164','83882','17445','97605',
                          '41370','72751','23129','17463','99612',
                          '54519','17565','87045','92921','22212',
                          '17033','88633','67962','86831','18265',
                          '85152','56028','77380','17955','30467',
                          '17613','26271','29917','24928','51650',
                          '38345','68956','68759','79218','19382',
                          '94428','33503','30794','85617','82881',
                          '77179','62241','34328','10674','64319',
                          '70311','40803','53484','12102','16426',
                          '58659','34157','15556','46976','55315',
                          '89141','86897','66603','38094','42728',
                          '92370','19294','99456','30534','12391',
                          '80191','28320','70089','37947','44466',
                          '90375','10110','11248','30674','23799',
                          '87783','14706','86919','86530','81201',
                          '10407','34135','88237','31040','36740',
                          '95754','90604','62505','59689','74566',
                          '73027','66759','98813','62008','94160',
                          '13457','60884','98473','34148','15675',
                          '98556','50383','64719','97156','64287',
                          '73549','72770','96719','15000','86484',
                          '30503','66197','18029','32371','60443',
                          '16979','44026','42014','81477','44821',
                          '36542','22346','70800','36677','83815',
                          '46632','55085','65968','70528','91859',
                          '20971','19183','92962','56259','43734',
                          '29273','27097','62900','23979','73906',
                          '68376','57971','67454','43772','23030',
                          '21778','31833','38969','74742','36749',
                          '46414','82292','33095','11600','20187',
                          '48549','98670','45805','30065','59184',
                          '98766','66302','23181','91690','54570',
                          '27441','54619','35949','16180','87360',
                          '27708','57099','18728','60161','73061',
                          '26111','23440','14421','79615','55437',
                          '90301','30470','86436','86542','88732',
                          '72505','84311','86694','89805','82359',
                          '80170','78791','45584','13205','89980',
                          '48347','86758','60748','34424','77612',
                          '97706','19681','56531','10092','84184',
                          '86251','25826','98503','12505','60223',
                          '36051','91931','85067','64755','44064',
                          '41586','67598','43476','35584','97160',
                          '80075','17890','73398','88543','99668',
                          '37648','31783','35238','16729')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


