
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '48200','81032','57133','80711','25117','53826',
                          '80424','11309','27830','32092','21120',
                          '39635','40681','82552','38247','53812',
                          '32756','90444','70219','40699','69870',
                          '22586','31779','91061','65152','65972',
                          '93177','12685','64886','36477','40375',
                          '42544','61258','33145','74960','83768',
                          '12632','55096','20928','55098','96765',
                          '11377','96918','99527','59667','35955',
                          '59810','90826','73290','12000','53465',
                          '40374','80092','12426','89307','51529',
                          '90610','39470','13013','70859','53045',
                          '98502','27106','71565','20031','70681',
                          '50654','20472','29549','92793','87793',
                          '70213','98755','64226','12763','95204',
                          '10301','13326','62057','85376','82047',
                          '60034','31481','91557','51665','43094',
                          '13142','41892','79064','98628','13570',
                          '21737','53963','55170','56075','60154',
                          '22648','69392','91561','27061','34929',
                          '91897','39209','82120','40413','10079',
                          '56907','63011','61625','21466','47948',
                          '41095','14020','63482','87842','34377',
                          '79362','48799','83872','29126','15175',
                          '86848','95327','24424','23824','30757',
                          '23685','93309','83370','17059','19713',
                          '51709','49167','51240','57868','19402',
                          '41941','60839','42806','93181','88554',
                          '45831','82234','75104','16263','60231',
                          '65356','97343','74942','25486','58564',
                          '52677','40954','73371','58760','22640',
                          '20757','22129','75508','53388','31285',
                          '90939','34164','21390','72161','57320',
                          '73364','18766','37983','70385','44165',
                          '71560','76696','67757','65711','23699',
                          '75397','36188','65853','12748','12154',
                          '77768','15410','63308','80165','44808',
                          '30742','80242','73379','75518','25384',
                          '13077','61316','61461','31885','96604',
                          '51473','14180','65848','50475','22395',
                          '13052','65493','63538','17294','81025',
                          '52715','14960','99853','57991','79854',
                          '73455','85830','35199','48572','13658',
                          '99566','57906','10877','31822','21706',
                          '67320','37342','50455','31651','73475',
                          '52820','57779','22386','29003','19057',
                          '66953','11995','92163','42109','79597',
                          '43063','47523','17791','89791','79754',
                          '70094','56085','76424','98519','21752',
                          '72828','45552','38246','73921','77366',
                          '86260','19110','10542','48521','26318',
                          '95380','50367','62028','32893','99496',
                          '71433','66790','21434','82324','97547',
                          '28625','87461','86126','78148','72718',
                          '93932','69287','27213','56074','12793',
                          '82951','77977','41999','90021','52136',
                          '67211','53788','76494','40736','73082',
                          '51508','11273','35396','98575','70132',
                          '38960','98069','29006','36168','82961',
                          '18969','78999','37047','94307','83823',
                          '43889','78832','57996','49980','18074',
                          '19921','66895','74336','90793','24530',
                          '67878','22141','43056','86794','81729',
                          '56242','42233','58432','88008','91195',
                          '36554','55596','52488','83192','52520',
                          '84358','12690','62206','93512','20826',
                          '98199','19046','79638','27417','51179',
                          '80532','55062','36258','86458','69368',
                          '25409','45074','75322','90934','18453',
                          '45470','46858','64139','27980','69324',
                          '51323','23414','22466','14402','41983',
                          '95162','81341','52205','16825','78891',
                          '66726','82512','90744','93933','71162',
                          '12164','75621','46326','32876','86430',
                          '41990','41936','70204','18449','97487',
                          '81808','49792','92488','49660','66867',
                          '17194','65140','52449','93973','45767',
                          '41000','73719','84928','71524','19066',
                          '14888','52626','47552','66844','49161',
                          '91237','37024','49775','61247')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


