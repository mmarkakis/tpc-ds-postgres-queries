
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '89519','94392','34875','78767','71626','46451',
                          '19338','35798','12797','96806','51663',
                          '13799','56802','92004','50376','69481',
                          '97659','43592','84124','38039','23776',
                          '38879','14831','84873','13857','81176',
                          '32211','88138','64956','17624','44373',
                          '36449','51620','22430','12296','69780',
                          '42645','55701','45950','27468','29649',
                          '57484','69906','83730','77563','80434',
                          '88424','53119','72189','93877','33821',
                          '85789','69709','44998','96973','14451',
                          '86173','61997','74457','70103','26448',
                          '45826','44150','18240','57278','51935',
                          '14305','91893','47730','27104','72661',
                          '85220','20758','64879','10340','15820',
                          '97818','35068','68850','18689','74506',
                          '13436','46222','51884','58823','87177',
                          '28048','30685','57256','81070','87787',
                          '92555','13940','97314','75610','44843',
                          '11924','43023','79412','93949','11685',
                          '41408','78000','88289','84870','79517',
                          '54550','95499','69935','79416','28590',
                          '11499','13633','56021','99836','42455',
                          '98793','84258','56812','31469','70449',
                          '41150','30291','91906','45274','19195',
                          '42653','71609','49782','16922','45985',
                          '82602','25008','72989','90819','64115',
                          '14367','82179','23465','78548','91335',
                          '62321','89634','93808','30894','65114',
                          '76674','28320','36935','10072','91240',
                          '42750','97237','78159','74245','40607',
                          '34682','51822','29619','60414','40021',
                          '64143','34449','51859','58874','41027',
                          '61442','40873','18058','92358','23923',
                          '44392','70516','52952','19071','92547',
                          '38783','32174','70908','78113','43358',
                          '54136','49334','99445','60932','37418',
                          '13496','59577','12393','10543','13429',
                          '24206','89012','42837','79259','74747',
                          '66830','47300','29364','29992','62606',
                          '23861','76576','82477','99986','27430',
                          '55405','84867','94030','19337','82826',
                          '60523','34345','65455','62943','94953',
                          '15775','20227','55323','64836','38481',
                          '32928','23223','94403','84014','52737',
                          '63369','29798','82705','62349','74412',
                          '10927','32645','59486','37353','82406',
                          '41031','20467','87387','52939','20616',
                          '31969','63612','70238','27825','77629',
                          '30890','47493','82433','31555','96014',
                          '17955','87725','50875','42612','67545',
                          '67554','71018','68116','84800','88642',
                          '84369','13459','56426','79398','52941',
                          '47629','88164','74271','48146','98604',
                          '92195','84286','51453','49077','66156',
                          '75668','60849','63390','45743','40542',
                          '29908','76226','70321','24989','91838',
                          '55087','46614','70358','69289','68810',
                          '26136','20254','93234','72996','97363',
                          '17958','87133','97620','87068','12157',
                          '19993','55945','48573','85754','56439',
                          '36367','11322','21157','17965','55406',
                          '60159','44977','29229','70219','94809',
                          '64204','40122','99779','38867','49643',
                          '95803','84823','26487','57752','39355',
                          '70214','61267','53539','93461','40717',
                          '42397','34877','84210','22401','76256',
                          '95459','98246','21087','53765','20549',
                          '45980','27695','26067','66818','45358',
                          '16439','87446','27280','23686','54744',
                          '53621','85535','24101','59312','40845',
                          '75306','13960','22389','84651','26761',
                          '51855','40705','92010','37717','61822',
                          '44170','52191','99841','70704','22680',
                          '78142','45571','85809','12824','60490',
                          '68908','56159','95895','49690','47574',
                          '79967','14474','83121','23724','87572',
                          '71061','28990','72105','34125','26834',
                          '14148','36967','97865','80892','77296',
                          '94105','77950','34788','65894')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


