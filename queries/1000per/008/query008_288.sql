
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '50783','22285','67305','35664','22642','61550',
                          '42173','40171','12820','46708','77958',
                          '67774','62789','20381','71916','78173',
                          '94132','72099','58267','61215','64871',
                          '18653','97781','95278','92303','52454',
                          '46602','38529','32089','92283','64075',
                          '61009','56727','76131','95917','82424',
                          '41595','28154','81218','35861','55490',
                          '40927','62487','81733','36791','38794',
                          '89760','60024','47917','31513','84617',
                          '63036','43772','42304','13120','80652',
                          '59883','10999','37108','80107','44088',
                          '59461','99590','83870','14636','69755',
                          '96131','52191','33927','48075','54296',
                          '81492','67330','20828','53074','42189',
                          '86783','91581','92681','87371','55021',
                          '25451','90823','92144','54719','11911',
                          '83849','59765','16533','93162','75895',
                          '79219','72788','12956','88444','41080',
                          '11683','95387','12812','18761','72601',
                          '33753','44692','22055','68155','44877',
                          '65416','62692','46884','45889','22219',
                          '85607','13962','34007','32947','67541',
                          '21206','11419','86000','11813','30170',
                          '79875','12929','57933','51658','72440',
                          '75910','41556','96425','16399','59132',
                          '10943','57288','73889','83086','81317',
                          '41620','53308','54599','38024','84806',
                          '61138','60149','20566','57869','44381',
                          '23650','94517','14499','52810','83711',
                          '10100','58605','67920','34998','25011',
                          '22268','16417','94505','97327','82208',
                          '41221','95695','70836','18791','94665',
                          '83258','57015','28788','93959','78816',
                          '44244','83769','42605','27962','54120',
                          '35608','74581','55307','74242','16729',
                          '45990','98482','67306','11106','57921',
                          '18134','24092','10647','60238','70315',
                          '88666','97444','78293','15780','17011',
                          '55487','72949','59768','47643','38165',
                          '58806','94921','33518','63992','65462',
                          '72952','67386','87053','55279','86300',
                          '64960','31420','34689','38430','28198',
                          '91959','57118','85143','12531','43071',
                          '72976','80596','44297','51861','87063',
                          '19401','45232','98747','99089','56174',
                          '56852','46676','52765','40779','61561',
                          '12067','24170','61835','69456','32140',
                          '15722','26774','79838','63118','87302',
                          '53475','92603','60025','62771','89560',
                          '47758','12626','90194','58234','32356',
                          '42536','94080','26246','50373','14506',
                          '87461','54011','69504','86919','94390',
                          '66698','49659','65795','58565','47022',
                          '33642','94014','58872','20173','49489',
                          '67637','81536','26996','75130','51736',
                          '45787','71972','62403','74139','55885',
                          '98056','23786','29456','31697','51455',
                          '98911','93138','96115','70912','95531',
                          '36082','42814','58714','16203','44194',
                          '64181','56719','58330','87688','44195',
                          '46278','14753','29165','85540','95775',
                          '69377','77599','76359','47629','56496',
                          '34068','93756','66742','57225','84774',
                          '95200','62461','30247','75622','70493',
                          '64253','61360','65931','36189','30099',
                          '33105','82772','42139','54040','72300',
                          '44076','21749','35101','32785','79040',
                          '19854','93398','45585','35969','49910',
                          '51115','14238','34538','27132','33620',
                          '93139','64876','14586','88625','88588',
                          '26999','67856','74203','22986','84329',
                          '51438','33482','34083','85310','39591',
                          '69548','77754','63402','79338','80399',
                          '32515','24325','53943','99348','22157',
                          '28681','40961','29560','86827','38735',
                          '38646','55062','27127','16694','82038',
                          '89172','32173','61039','48441','58142',
                          '23279','75190','83397','62211','26221',
                          '93355','48417','90087','34924')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


