
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '33168','31271','41138','26781','55937','85043',
                          '17711','60158','74193','39102','27259',
                          '42691','27023','99005','83889','88204',
                          '68303','25130','19308','32389','61870',
                          '25530','63148','15277','52962','54669',
                          '95073','98265','58295','26020','81551',
                          '29915','96899','73530','37413','85104',
                          '30158','78491','25707','74608','84933',
                          '40273','88127','26100','86233','99767',
                          '78660','39641','11092','13624','93220',
                          '32640','75970','25258','23723','33138',
                          '26294','94325','90002','24730','75747',
                          '31564','21815','88145','63955','59574',
                          '85800','45108','60766','85772','24823',
                          '15565','11007','67074','93867','19366',
                          '62167','28646','34710','37077','27472',
                          '75156','19461','44448','79604','13793',
                          '80524','12842','71965','90970','92881',
                          '22063','43705','74054','41991','45537',
                          '43875','54889','34796','79614','32414',
                          '84890','11689','16520','11649','24680',
                          '58531','40523','44989','90724','43960',
                          '53948','87235','58773','65081','25320',
                          '60986','17303','74206','79995','23899',
                          '38658','24724','89254','53586','80251',
                          '50637','45030','47538','77316','98778',
                          '46675','75359','50097','22876','26785',
                          '69899','30011','44727','82117','56119',
                          '76592','61655','97862','94612','48431',
                          '63481','95552','65453','50363','19231',
                          '84498','69177','71915','34357','72814',
                          '44311','63577','45477','26840','73259',
                          '63366','13998','96905','17704','48189',
                          '83821','26104','89710','82839','26345',
                          '11320','67782','96474','97292','92243',
                          '85910','71601','74989','21700','62825',
                          '87047','71918','99154','67909','77414',
                          '32533','34725','84082','95558','20505',
                          '16584','53903','44637','13561','70347',
                          '76789','97403','53872','82761','63462',
                          '84200','62622','73899','36399','99361',
                          '76999','99650','33609','13414','89910',
                          '25335','14344','76155','82138','97315',
                          '87616','34092','60956','98398','44716',
                          '96182','85802','69587','96716','16400',
                          '51754','70335','42235','47039','25392',
                          '65162','65070','28029','32642','14601',
                          '78732','97538','45289','97893','74758',
                          '87495','20367','30195','50896','72527',
                          '67108','36967','39083','84798','73661',
                          '47366','16153','42911','56927','63142',
                          '73841','27650','14714','40783','31838',
                          '17364','49509','21275','65485','94731',
                          '28279','88783','41928','14880','77146',
                          '84768','95989','30940','11407','16356',
                          '67565','45805','44072','89733','18703',
                          '64192','39815','85500','66852','82266',
                          '64598','97465','84734','78517','31745',
                          '17508','26825','95804','83213','84568',
                          '24996','30208','31285','71604','61883',
                          '23730','22354','75635','51431','97254',
                          '81341','55086','52766','62626','18804',
                          '85602','84308','55375','21997','22198',
                          '59307','62234','12915','27249','48811',
                          '85967','27945','41144','79659','71284',
                          '15991','10130','62649','53727','75810',
                          '37525','61228','42416','77930','12623',
                          '39141','42964','50289','59280','14602',
                          '81965','65340','60187','97760','70831',
                          '17267','48167','85097','34429','81875',
                          '62728','29032','77302','80245','11396',
                          '40545','96784','72695','33690','92832',
                          '11866','42219','69104','76696','10619',
                          '17647','25471','53438','43070','82496',
                          '86657','37962','89424','28741','63880',
                          '64078','72700','80125','97611','93278',
                          '53352','13710','35688','72699','37056',
                          '40371','98118','62863','35393','63609',
                          '95770','42748','86086','39352','33413',
                          '80764','43619','88401','37523')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


