
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '33415','50481','83084','30463','19221','92376',
                          '72522','73059','44540','42365','33478',
                          '15294','13572','71134','85401','46132',
                          '15712','81136','31546','28141','34259',
                          '44773','60485','98342','10839','48544',
                          '40687','70750','37104','81049','66740',
                          '40231','18210','43227','33534','26770',
                          '90291','25403','73911','27539','77445',
                          '29665','31142','30695','62858','36735',
                          '52410','98447','94718','81855','55567',
                          '73163','78426','85260','74761','84486',
                          '49504','77462','97026','65219','77635',
                          '98164','64183','63619','77648','34001',
                          '51622','92804','19126','89678','20007',
                          '42503','37720','99314','40969','75553',
                          '60204','70594','17780','12588','22630',
                          '27115','79682','77819','37239','16659',
                          '40821','40318','29317','43544','38910',
                          '88513','42765','90913','43443','29573',
                          '63244','71956','99882','26898','70935',
                          '82570','52620','72540','50083','10058',
                          '34741','28003','38727','76202','41523',
                          '33765','89974','78491','60906','12840',
                          '13037','55949','32243','90565','22208',
                          '56362','90119','57467','15015','91946',
                          '62091','46483','99675','23501','91802',
                          '48864','58740','60226','77572','90515',
                          '37575','28578','83244','61927','48058',
                          '87328','88647','26625','89045','76664',
                          '95943','45746','78767','30441','17007',
                          '25736','45517','35507','30532','14885',
                          '21651','18153','58503','17273','86436',
                          '34044','70251','26940','41189','57148',
                          '51410','35566','80974','97066','51683',
                          '49729','53968','72058','24635','51718',
                          '39482','18819','78363','94880','66890',
                          '85695','19692','85498','60803','51424',
                          '53942','14751','10198','88065','53710',
                          '37335','47687','48960','43523','19344',
                          '31098','51906','16140','20695','69458',
                          '45584','23765','78466','34568','28601',
                          '83041','21308','67799','18185','32568',
                          '28493','13633','56302','71539','82837',
                          '33791','53282','96102','72619','16915',
                          '81660','35784','81373','73237','30822',
                          '69866','70987','58671','98333','42705',
                          '68192','78683','43736','15576','58762',
                          '32760','14442','18408','10659','19827',
                          '73152','13819','69806','58310','34343',
                          '93884','41546','25282','28793','69428',
                          '59263','13421','46299','30303','45338',
                          '17479','31777','16482','82501','75103',
                          '65828','44571','35012','79309','26485',
                          '78992','19601','53752','45611','25217',
                          '85153','12001','66942','42389','15723',
                          '46756','37769','58176','68390','29305',
                          '32660','66985','92850','47403','75929',
                          '97540','92159','97598','79600','80910',
                          '31248','36580','50591','36509','26689',
                          '54545','12581','48575','75488','53879',
                          '75055','13088','24946','35082','76127',
                          '92354','36664','80353','76023','35379',
                          '34336','17334','96474','32573','38600',
                          '89964','25828','48961','48934','60309',
                          '15089','19991','84579','96350','56611',
                          '69249','27203','83127','45123','94007',
                          '41621','41535','61497','92896','71162',
                          '18368','37568','85901','46036','25147',
                          '72992','51309','45601','67246','57545',
                          '82732','40320','30186','22498','41164',
                          '14422','21954','18013','77938','18960',
                          '33615','28586','58638','22903','39806',
                          '76344','26250','17251','88919','49481',
                          '87263','84401','73782','56190','50153',
                          '28770','99346','31448','60390','61526',
                          '28371','90312','11536','78444','53571',
                          '57263','62977','43022','62957','29660',
                          '24998','53118','36439','71259','89651',
                          '70837','38797','34779','15768','87448',
                          '12788','16682','71246','10359')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


