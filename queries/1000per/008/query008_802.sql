
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '74535','94094','84658','84461','45691','99495',
                          '52403','75676','28923','51664','46074',
                          '37805','58389','63376','44761','78628',
                          '73708','61220','86352','69149','50790',
                          '54475','68661','45376','83363','10328',
                          '96385','86068','60064','46791','17413',
                          '72700','27949','74935','63427','58759',
                          '42508','97498','40948','30308','68673',
                          '33357','13826','32926','32525','11398',
                          '75552','52624','24083','67262','40394',
                          '38336','65416','38453','58458','55102',
                          '82537','41084','96699','86689','34625',
                          '91550','12014','27782','78883','75106',
                          '60993','93817','54518','25612','84839',
                          '89484','36845','67735','57917','22330',
                          '52556','82176','65178','67963','40240',
                          '94978','13830','41873','71057','41612',
                          '70544','22758','99158','21512','42842',
                          '99761','19465','84443','97619','74749',
                          '68249','62566','49828','37021','14909',
                          '75465','32697','10951','82184','68335',
                          '44640','31827','39455','73584','36583',
                          '68440','68145','48650','67991','83346',
                          '73534','76856','35858','70697','84769',
                          '74841','37108','38461','13130','35739',
                          '99240','11646','94622','81439','60273',
                          '16245','31035','13605','44658','84475',
                          '31717','49373','90672','66021','24757',
                          '80132','12624','99467','81070','66481',
                          '86381','22470','84491','88179','71760',
                          '13721','87240','20482','30883','80189',
                          '48457','61880','16252','20628','59262',
                          '41433','63247','80528','44008','93984',
                          '96738','55628','74283','76170','27774',
                          '77341','70932','98474','88260','96723',
                          '48275','42979','85873','15461','78888',
                          '88135','62262','91909','94738','63616',
                          '31803','91104','32994','74454','47254',
                          '87566','42204','11752','36879','82355',
                          '73412','54193','49226','25136','31715',
                          '65951','37214','94620','32353','24940',
                          '55226','74623','68468','63239','90086',
                          '77456','55067','75680','13583','75467',
                          '83582','63889','38531','95932','81545',
                          '58170','90838','59546','40830','60377',
                          '16093','73961','80291','19254','91941',
                          '41051','53023','47417','71106','57808',
                          '82575','85545','16041','61998','64077',
                          '99154','57414','50863','80353','50341',
                          '45248','66793','51921','26102','50468',
                          '20789','17949','32141','85819','85876',
                          '12294','43760','22523','82926','34698',
                          '99006','71190','16613','71815','36846',
                          '86447','98083','75216','79579','52990',
                          '11253','86708','11055','90423','27282',
                          '63540','42150','72128','34992','58981',
                          '95238','80881','37034','28141','91817',
                          '75201','50205','24598','31287','28229',
                          '15061','51509','28246','13400','49588',
                          '53847','30546','83902','40790','38967',
                          '37392','33323','45912','31281','95774',
                          '49932','12620','84096','63177','48096',
                          '57353','22158','37641','60207','60790',
                          '70073','10802','65787','56021','90481',
                          '52088','53649','15760','45957','17315',
                          '59432','38101','15082','94985','35754',
                          '59372','23719','28602','51139','87122',
                          '14822','31977','38707','35396','24914',
                          '76632','45047','33122','30016','86929',
                          '86993','63852','33280','26251','46841',
                          '79036','29959','89964','84696','34177',
                          '22157','49738','75897','18822','87092',
                          '69740','22493','50990','94001','11326',
                          '12998','72695','28676','94599','34374',
                          '21468','93370','95057','51336','64365',
                          '91734','61595','45703','26114','51415',
                          '50522','88489','46978','76630','57391',
                          '33891','81918','64261','99373','37415',
                          '37464','66193','69454','29158','65643',
                          '24255','57296','34508','59315')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


