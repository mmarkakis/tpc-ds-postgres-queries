
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '58288','98669','69935','23922','18782','54258',
                          '51634','84288','84615','51861','17747',
                          '63233','53634','55872','64019','21481',
                          '54695','84565','86777','25914','12368',
                          '16029','18424','82227','92193','63631',
                          '70900','43774','46489','19439','39329',
                          '67663','30594','73345','63388','83772',
                          '44754','25952','74821','97744','16549',
                          '32067','59395','86517','70617','58397',
                          '63069','31112','71217','35462','96712',
                          '85245','79625','31296','56150','34774',
                          '20579','67685','65888','53638','41465',
                          '50864','41085','29378','44130','20219',
                          '35726','29264','52990','49768','68805',
                          '98868','88891','52175','66621','95171',
                          '99964','34791','98736','14985','49635',
                          '71648','38116','70017','58477','13196',
                          '97844','49952','41832','45937','61175',
                          '60193','62424','41094','87560','18373',
                          '10462','62378','52432','24491','17229',
                          '25622','23444','73683','91988','61115',
                          '31165','64584','11818','49942','94519',
                          '19526','16932','13909','61701','64767',
                          '34906','84773','56549','67587','55456',
                          '79076','41286','56644','76957','56391',
                          '52633','14608','37637','92713','92157',
                          '44261','28748','41665','96035','27999',
                          '91965','10176','48358','31730','55165',
                          '35621','63333','43653','53875','66750',
                          '46650','94757','91951','83594','88911',
                          '23152','74410','94587','61340','72805',
                          '72584','66378','34135','14214','44471',
                          '23933','97878','48133','46507','27030',
                          '40955','71309','99722','32200','20801',
                          '68328','65468','99915','24661','84188',
                          '22850','18115','63550','82840','35283',
                          '92860','59148','40426','19548','18023',
                          '50662','29523','41057','90104','10243',
                          '13084','78376','74117','26016','12673',
                          '71933','53113','21097','79105','26488',
                          '76930','99165','94878','77305','14036',
                          '84219','74009','85985','98632','19357',
                          '14934','81821','73386','77829','31768',
                          '89674','97331','83649','27284','21782',
                          '11310','75843','89256','80466','17417',
                          '92344','61301','84530','26670','89536',
                          '97660','78518','64942','10878','53006',
                          '90280','98652','21547','52888','49040',
                          '24762','13431','63315','90893','67890',
                          '13362','61686','15241','69681','66416',
                          '55136','88681','83895','67898','33471',
                          '69562','56386','50703','24745','30745',
                          '10031','72694','16496','79270','61026',
                          '76780','90486','90663','33748','91730',
                          '11321','89877','96185','11680','12837',
                          '46127','58549','41054','49357','95950',
                          '50504','14438','35291','87988','57749',
                          '57180','68086','85277','65712','71242',
                          '38646','25287','76281','54511','11994',
                          '13980','36917','26074','82466','33256',
                          '88216','49744','31264','34449','86661',
                          '93927','89532','54747','45423','48240',
                          '90141','78829','99518','78465','84122',
                          '33076','42460','88032','70773','91459',
                          '87872','79617','37033','46454','78926',
                          '99674','48402','11728','65428','21936',
                          '98373','44167','16659','38386','59032',
                          '99655','74660','12178','98128','53465',
                          '52517','36657','96973','53091','63525',
                          '92445','99507','55236','14190','55724',
                          '72140','56263','60850','39554','85118',
                          '34069','21075','67323','78058','39034',
                          '59610','85585','24594','91871','17926',
                          '27585','84480','76419','40040','56949',
                          '26794','59662','96659','89020','50932',
                          '41748','13344','90128','69488','71558',
                          '43201','18160','86164','46631','76228',
                          '33609','51443','28978','30808','66617',
                          '69363','13021','64242','71635','59484',
                          '32715','89731','25103','64907')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


