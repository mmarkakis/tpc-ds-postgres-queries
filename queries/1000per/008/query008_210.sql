
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '25374','28702','56811','48649','12337','30281',
                          '59709','95104','13013','11339','93961',
                          '43974','45793','72703','19146','19779',
                          '82992','73122','17756','52103','78547',
                          '30750','43888','31909','14844','10414',
                          '40756','75111','67729','94279','72384',
                          '54425','31023','71210','86082','74345',
                          '46820','80109','79379','67062','28701',
                          '17567','95051','92069','86255','73417',
                          '92097','52896','57671','89320','80632',
                          '65172','14545','75297','27725','89464',
                          '78207','52787','48648','61723','70266',
                          '51818','59361','22625','24548','53418',
                          '60551','68463','24442','32233','67755',
                          '37696','32043','56507','33674','61518',
                          '30275','63528','93035','52207','43283',
                          '81256','14731','88991','83856','14756',
                          '75016','41707','55749','20338','75460',
                          '43651','45278','43737','32010','19163',
                          '15934','49825','67877','40790','56359',
                          '74378','86532','25449','33230','99430',
                          '83743','94568','66861','42568','96956',
                          '78808','64758','57980','89572','75685',
                          '78882','85119','48957','19760','85544',
                          '79482','75848','81275','13733','20502',
                          '41008','45865','93384','56513','66970',
                          '85316','28819','76143','83279','65505',
                          '27537','72547','61249','71349','13599',
                          '79222','45704','66058','33418','47295',
                          '85603','64914','66062','65415','15055',
                          '68808','78432','98260','11690','62982',
                          '29960','12803','67754','63340','65474',
                          '32621','36801','93071','78687','85648',
                          '23971','84999','12375','14384','45668',
                          '59518','49618','56753','88941','99355',
                          '50847','80090','52305','52145','41071',
                          '20001','24270','20238','40371','20921',
                          '31844','40864','15990','59034','80573',
                          '79832','26168','85091','94826','15180',
                          '33870','26740','12861','56403','10068',
                          '48279','73486','34747','47009','82824',
                          '25668','19573','72531','58878','15400',
                          '35850','83747','94851','68824','86238',
                          '71109','30659','12205','53401','53910',
                          '77325','87401','60753','78596','27504',
                          '11345','69712','83223','97515','47955',
                          '39661','83241','84077','63282','38818',
                          '19546','64545','79710','44418','67339',
                          '70204','71222','46406','73805','61490',
                          '81502','90731','92418','51238','81899',
                          '72945','51684','79034','71863','22118',
                          '15924','27776','41546','93541','58600',
                          '12334','92405','73818','83919','80462',
                          '63684','15674','74051','54826','85919',
                          '31140','14871','94675','32193','12131',
                          '63925','62405','46814','28422','22989',
                          '91122','34751','91741','28007','26801',
                          '71611','53697','92599','43358','76035',
                          '41678','43785','95205','45810','93805',
                          '76033','87593','82803','34470','99231',
                          '62703','97940','37928','37868','73203',
                          '24826','66309','87120','15263','64797',
                          '39375','71956','87734','77052','48223',
                          '38758','74449','58203','85743','29067',
                          '38703','85555','66781','12225','11987',
                          '71523','64158','98777','86748','78289',
                          '34797','48387','60082','15957','49547',
                          '94937','88541','27914','78646','23036',
                          '47019','25362','83383','30359','79897',
                          '98400','89231','24908','38764','63714',
                          '48638','25563','88511','27828','42393',
                          '99673','78241','22872','31428','13021',
                          '96924','53566','77578','60338','60291',
                          '69232','81577','25784','60620','40788',
                          '78362','34391','45367','26613','15737',
                          '73893','97971','99013','20858','90314',
                          '70415','67314','20720','74576','84711',
                          '69254','25576','29139','40090','79376',
                          '78703','48812','14007','40597','36264',
                          '32477','32417','20577','31467')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


