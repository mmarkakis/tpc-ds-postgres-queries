
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '86126','31662','70143','39125','83082','75208',
                          '55742','33444','50320','21076','75057',
                          '42122','43912','10921','72795','85110',
                          '65182','25906','75685','99212','99261',
                          '54032','54252','74525','23217','55963',
                          '81357','88969','71900','39927','62952',
                          '20576','56399','37870','13549','48899',
                          '57450','35944','26387','76392','39886',
                          '83550','57396','35653','59315','78582',
                          '64768','20571','74766','41056','64322',
                          '70814','92639','46567','43692','60524',
                          '58286','72266','69051','90057','44305',
                          '97209','71959','63303','81281','82285',
                          '68868','88359','24251','45956','63000',
                          '99532','92409','83495','38500','99747',
                          '84231','94287','76680','38866','66267',
                          '11429','85964','15019','83992','64228',
                          '11791','11290','50228','15473','20301',
                          '26478','89060','96668','84065','20653',
                          '74197','38997','81513','49574','33870',
                          '85937','38202','36106','52761','37721',
                          '71131','97686','44711','62784','57963',
                          '28927','47913','31354','21116','64145',
                          '62749','83269','67726','37469','44462',
                          '32873','89779','53928','18269','96783',
                          '19082','58216','60403','78038','41513',
                          '66600','73098','30838','85233','11839',
                          '53252','60708','59047','17693','41168',
                          '61943','96420','31584','58250','25003',
                          '11306','43462','45642','80286','53406',
                          '35477','88948','33366','63694','57866',
                          '16271','55483','82581','63444','44054',
                          '84725','17021','16912','74031','99978',
                          '25667','86642','57147','87448','94617',
                          '88912','23518','27896','88834','92584',
                          '71666','37091','43271','26395','96945',
                          '60861','74995','11441','20666','91412',
                          '31469','12452','14006','42461','62640',
                          '52279','26859','96820','85599','86833',
                          '47899','28014','52380','58920','53216',
                          '73195','19570','68289','16815','99248',
                          '52127','96944','39706','34212','90931',
                          '81450','28156','28452','41106','55388',
                          '37452','57695','34771','85923','29997',
                          '42655','12489','95057','14351','65591',
                          '56190','96809','63080','99000','13842',
                          '94275','23725','53359','55985','65714',
                          '77059','23102','18461','77979','24767',
                          '26293','11329','43119','34656','62023',
                          '74429','21447','25539','47264','91569',
                          '98304','93151','17361','17952','44814',
                          '84896','21574','39036','12010','43743',
                          '52794','24607','50004','27791','77344',
                          '46316','55514','60226','20887','82546',
                          '55372','44860','22042','31493','98778',
                          '70580','93751','55707','96093','15707',
                          '85702','57291','26599','42384','62508',
                          '28175','88188','31936','41516','20898',
                          '68769','50131','15962','45861','50262',
                          '78592','34793','41961','42922','44573',
                          '83281','64764','11615','44537','59210',
                          '84849','22951','53180','57059','84555',
                          '36035','49996','37828','70434','22432',
                          '29758','27430','44043','87225','43852',
                          '10589','58299','15581','35803','13240',
                          '56830','59283','32808','97039','55753',
                          '48414','15749','56708','80236','26934',
                          '19051','59962','49823','28336','33135',
                          '70678','89457','38117','43170','98258',
                          '59484','58896','37618','71769','90101',
                          '39703','67517','74444','43870','18531',
                          '48860','45591','94645','57820','78970',
                          '35275','66096','13996','39038','69224',
                          '43670','51227','39301','88633','90486',
                          '61853','77956','82492','16549','83311',
                          '76254','68807','41892','83442','73536',
                          '99280','35218','62982','27987','48179',
                          '93989','36077','59530','23807','54574',
                          '84356','56625','79539','46568','14978',
                          '82406','28706','67902','86462')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


