
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '64581','95562','60689','94161','13861','34477',
                          '10947','21390','42893','12792','92530',
                          '20488','81745','48540','16042','27911',
                          '91830','10345','45203','16884','54784',
                          '98217','65388','56570','39102','78169',
                          '32216','47820','80766','26287','54622',
                          '59865','81989','82940','46708','48909',
                          '21930','33067','25479','13910','92518',
                          '25346','82571','25113','76597','96428',
                          '75236','50560','31247','23584','76362',
                          '50844','80837','32896','34702','76464',
                          '81212','89968','29464','25182','31923',
                          '91339','83520','49175','17247','80478',
                          '39465','34604','49698','14950','53740',
                          '24418','44668','85610','12969','17645',
                          '64789','77738','57988','54945','41310',
                          '70492','80910','49855','34154','33937',
                          '97332','89473','70845','36482','35964',
                          '97358','26407','63285','39342','63856',
                          '71556','53202','84023','64769','49592',
                          '33683','13063','97588','57316','10729',
                          '30347','57616','15456','68566','33500',
                          '98097','87392','72060','37008','22419',
                          '28085','23101','74801','55305','77259',
                          '45191','33004','55250','66488','87884',
                          '57015','68477','73549','53700','52336',
                          '16939','86815','86087','13644','23120',
                          '82730','33181','23432','63600','45808',
                          '23425','37575','60774','74894','88828',
                          '65923','84859','77563','76760','40763',
                          '83574','91581','68000','91621','79264',
                          '47239','96678','95960','57663','16480',
                          '94773','26843','77509','17228','16933',
                          '44723','61294','59275','22956','94238',
                          '71343','30498','66349','72642','58679',
                          '94338','27271','43967','35309','65294',
                          '22308','69854','76606','58011','56286',
                          '23953','83688','25820','30593','35843',
                          '15483','15407','21213','66105','96015',
                          '56389','57590','34024','46140','13836',
                          '38574','36141','88182','46760','46109',
                          '40099','32627','34920','66222','64079',
                          '70701','50604','19746','98873','64310',
                          '20663','56521','20735','85147','74612',
                          '30200','51416','37787','80570','12357',
                          '12984','65962','98815','60838','96830',
                          '96440','10622','15485','39488','91464',
                          '30725','79954','94589','43478','65188',
                          '89140','13845','98386','15369','68336',
                          '90868','72556','12614','80811','83133',
                          '69028','82507','79454','62192','91269',
                          '27721','45893','61425','88645','11862',
                          '67231','44034','60077','38496','69022',
                          '97327','73291','82878','94124','29884',
                          '98980','37150','97446','47718','85827',
                          '42203','53712','24783','26658','78315',
                          '88965','80256','53405','97251','79248',
                          '84320','39353','24963','22139','78535',
                          '49695','41177','44367','40565','76806',
                          '42502','63529','86787','68453','16721',
                          '89934','11838','30537','50393','33330',
                          '77697','60009','78838','33261','24045',
                          '55902','80670','51299','45555','39115',
                          '18575','46994','86920','50186','23065',
                          '34473','54001','42627','90784','96583',
                          '47042','62132','10450','70143','49211',
                          '69239','62385','95998','63590','81554',
                          '29605','24755','37773','57454','20489',
                          '86867','71151','75279','52669','25984',
                          '56298','45531','51095','45790','44515',
                          '46443','83290','61907','37174','63581',
                          '59724','95260','14008','15042','42383',
                          '64883','60645','34291','83783','11711',
                          '22515','12018','64757','64454','93785',
                          '41051','87825','85916','19793','12158',
                          '72153','58980','32347','13289','57730',
                          '10563','70280','43888','41821','68089',
                          '70861','49169','71930','60772','23699',
                          '75738','78691','30729','15720','26008',
                          '39088','60733','71551','21527')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


