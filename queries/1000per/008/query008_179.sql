
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '56620','14229','13981','30284','82600','29641',
                          '57465','88525','37634','42890','73846',
                          '55221','94360','94029','43890','32380',
                          '33035','70987','17766','45184','50121',
                          '37475','61714','34464','85192','24427',
                          '23030','64335','53018','35757','76196',
                          '17018','93198','91627','80965','86504',
                          '98432','80302','52188','39500','71856',
                          '33766','97898','26604','34095','19455',
                          '69132','21402','22424','52503','41749',
                          '74265','71791','31533','72808','72119',
                          '27143','95767','51510','51828','64324',
                          '82276','23729','56965','12402','98759',
                          '94712','84111','46428','41272','45488',
                          '58090','72656','24955','35815','57741',
                          '79340','21839','37084','98210','92159',
                          '26907','55722','29049','10009','65244',
                          '95636','47821','61627','85950','96071',
                          '95986','12322','14938','10928','27585',
                          '94641','74410','21189','92723','19152',
                          '76111','49388','82277','60544','44023',
                          '79270','26110','11845','94447','63274',
                          '71440','41841','10120','79958','29184',
                          '35959','83907','56482','42225','32537',
                          '74890','13991','11532','63942','69134',
                          '94656','62223','12678','18863','74703',
                          '67048','59591','67370','13190','64561',
                          '70199','73197','41905','71385','32433',
                          '54841','49545','46647','75086','51625',
                          '44457','34198','48058','93914','64222',
                          '10633','10702','79087','93225','52380',
                          '93770','47936','62211','75275','51317',
                          '80602','18819','29555','27403','72062',
                          '26279','18658','76439','91958','73021',
                          '44733','44838','78518','45538','72718',
                          '68279','33421','41114','91218','87600',
                          '24764','36769','61133','32350','34259',
                          '97014','57914','23718','52247','31080',
                          '43269','70136','99307','76248','46180',
                          '61935','82999','28226','13276','15554',
                          '66952','85568','85423','94006','38124',
                          '32365','25726','31582','16388','94975',
                          '97289','17823','81328','36274','25539',
                          '81691','42605','70311','81930','88435',
                          '93064','21778','16582','95351','11038',
                          '86670','44980','86201','63770','10497',
                          '24569','35704','10368','74809','42610',
                          '18036','26460','17045','86698','17504',
                          '42974','98525','61350','75300','22601',
                          '53965','24823','35628','13772','98595',
                          '87350','10308','80000','21788','86684',
                          '14353','42824','40451','52616','65347',
                          '78753','45906','10167','43446','31269',
                          '56442','17964','82426','33539','37309',
                          '11764','66318','69358','62772','93571',
                          '35781','79999','80338','32730','40858',
                          '46211','91890','14394','19932','48228',
                          '47537','42326','97256','85389','58631',
                          '46503','83092','33756','62571','10537',
                          '21686','93586','94533','26145','79053',
                          '21969','14085','48008','25417','44823',
                          '77235','40029','35326','71790','78479',
                          '73211','68330','57656','20522','65813',
                          '50611','33307','95644','80546','23651',
                          '52217','18977','22157','64226','81315',
                          '95763','68409','19925','48800','49089',
                          '70163','89780','28804','55837','58533',
                          '87571','16628','69855','16003','30839',
                          '69911','97713','49811','56619','85659',
                          '90562','89491','24447','72614','98418',
                          '18649','70280','71194','51264','97916',
                          '13171','21297','18830','99018','20248',
                          '15925','80040','21512','14458','71700',
                          '44319','40635','13240','69892','87393',
                          '19999','62927','48150','23915','45922',
                          '38047','53986','98250','44671','13988',
                          '59530','99851','38340','16509','65603',
                          '76335','85619','44555','77193','24635',
                          '10876','63407','10590','51978','47217',
                          '22600','91685','60426','70611')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


