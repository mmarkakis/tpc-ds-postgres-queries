
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '40593','76237','78698','69325','28250','87996',
                          '50395','23876','52784','56629','36899',
                          '40478','56277','10710','27854','75823',
                          '43857','92474','20267','64853','77510',
                          '69801','71441','39015','19389','22071',
                          '16605','30106','70882','48011','27912',
                          '75039','83740','46543','99098','49854',
                          '46368','32479','41391','19900','98192',
                          '42688','20055','37397','86057','91464',
                          '99737','20467','24316','49914','87977',
                          '46463','88208','20424','55917','81034',
                          '95111','60821','29478','86408','91672',
                          '76029','14124','56433','20703','88226',
                          '86096','52421','59364','28552','30553',
                          '22212','66530','84415','23548','45659',
                          '36272','68774','46151','51211','24796',
                          '83882','50975','80717','21303','56276',
                          '46837','51187','77782','10400','57110',
                          '23035','95117','14410','26623','14802',
                          '45365','54324','38859','77178','62883',
                          '63426','17804','26167','84182','52048',
                          '91764','54013','78323','27169','93922',
                          '19317','34902','70889','69368','34207',
                          '15671','63174','64121','15787','34136',
                          '37231','14640','82808','92904','86360',
                          '97339','17152','53591','80946','76948',
                          '64136','62418','18137','13757','43353',
                          '89247','51402','18578','50681','31752',
                          '64849','12959','89166','24959','21003',
                          '63530','94479','92445','32476','87737',
                          '22462','18825','11074','87830','39378',
                          '67397','91646','76121','21015','18631',
                          '77691','73167','61878','65335','69511',
                          '48717','30729','42747','42560','28351',
                          '68909','16534','93972','44209','30076',
                          '66809','76509','68035','33841','53280',
                          '24701','80450','45654','17275','15681',
                          '38728','14245','59026','66706','10990',
                          '67969','40702','41740','66131','61851',
                          '83386','19223','48635','60551','43717',
                          '98947','92444','17092','36748','52663',
                          '99204','62713','67381','10121','62027',
                          '81655','78810','43787','75652','29349',
                          '92297','60498','74341','18513','35592',
                          '38085','58472','40827','81328','63068',
                          '69998','78516','35633','33439','44208',
                          '24921','94995','58620','33214','85913',
                          '93798','75096','47068','55171','38910',
                          '35105','51719','74601','98790','96060',
                          '92685','51871','18395','19914','24258',
                          '38132','96157','14782','39825','19371',
                          '85026','37801','86668','86351','15940',
                          '37918','49340','82413','60587','53234',
                          '85016','74368','36894','49596','14320',
                          '53039','51354','69847','19911','73219',
                          '42655','71558','58045','93773','21407',
                          '49358','97878','44992','56468','61312',
                          '15633','28851','99948','48708','98737',
                          '85028','16133','16301','10299','66103',
                          '13692','36104','38044','64497','48450',
                          '91537','46024','71940','73444','15574',
                          '37086','74909','73742','95102','80222',
                          '17191','73365','53630','12115','39401',
                          '55499','91328','93030','70008','39376',
                          '97418','64541','16351','59185','48144',
                          '24598','78315','27840','34321','55476',
                          '42012','38239','34040','82875','75190',
                          '70863','41458','18348','15622','70171',
                          '11739','91812','11238','67277','10730',
                          '56099','18771','68606','30981','74262',
                          '74680','12617','51203','18274','80250',
                          '18661','42480','72352','40042','64795',
                          '57980','50111','71382','44190','99350',
                          '71598','30567','45548','89411','31630',
                          '14358','37747','18824','65478','55889',
                          '57650','37594','13917','10525','81757',
                          '72871','16092','23024','84922','72419',
                          '24392','10833','29954','85154','23830',
                          '11192','23884','41820','43592','91921',
                          '11755','75264','82699','64530')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


