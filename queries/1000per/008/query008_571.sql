
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '33359','33099','50644','39034','64741','96697',
                          '66885','92884','93786','73011','46342',
                          '23803','67174','10219','47505','17096',
                          '75900','11761','20711','35471','73749',
                          '60917','42656','36230','83827','51419',
                          '67564','66329','92742','22810','45095',
                          '64801','87305','36993','82087','22294',
                          '39863','33674','41637','34755','86019',
                          '73148','14919','78269','40778','26261',
                          '60308','33871','34463','48567','88370',
                          '55930','78292','78274','93684','65275',
                          '14795','77022','37327','61919','55364',
                          '39910','11866','59124','55656','66594',
                          '34294','91672','16413','63561','78340',
                          '94857','86795','10012','16209','57819',
                          '80303','32662','69004','81739','79182',
                          '84095','14030','25727','13428','64509',
                          '35919','70267','10345','56108','56013',
                          '40433','88500','40386','98686','59867',
                          '71829','94875','75377','73472','89906',
                          '12559','96207','62238','66187','18108',
                          '12773','26597','50019','87124','87522',
                          '38759','77262','72433','52987','77589',
                          '68898','71964','91755','77104','41601',
                          '90983','57104','73392','15721','31791',
                          '29934','25044','40680','81105','38032',
                          '46725','50604','42187','90403','98642',
                          '67272','57129','40126','31131','44483',
                          '33549','46840','91096','15645','73949',
                          '91611','58918','10517','36264','13163',
                          '76806','46643','17856','94879','31972',
                          '46164','15708','44384','37326','15400',
                          '29598','57473','52665','45761','22423',
                          '94645','96885','77647','81302','90810',
                          '64626','35733','82304','82869','23860',
                          '68226','22920','63191','18927','20148',
                          '22389','11290','43169','54585','76545',
                          '30244','72742','94521','18465','41311',
                          '24103','76184','41677','42177','75126',
                          '16724','59365','92806','51257','25882',
                          '24021','75259','63638','29522','13841',
                          '18314','96613','61384','16647','86082',
                          '42971','16218','53447','81333','18533',
                          '97702','97407','19403','87614','84003',
                          '44049','16624','15239','36929','30638',
                          '47291','99277','74134','41297','90479',
                          '22072','66757','63792','14660','71030',
                          '42959','34498','96814','13068','99346',
                          '31971','83500','10897','10499','97869',
                          '23651','49992','80323','85036','23439',
                          '19075','13593','50872','77072','69975',
                          '62016','73087','76658','59098','41350',
                          '57837','12560','70492','14186','38710',
                          '39494','22616','91010','15115','60846',
                          '26276','71488','17342','72862','71493',
                          '97079','47727','39154','17248','30579',
                          '53745','51580','30179','11997','67722',
                          '61096','78809','28348','24393','69339',
                          '80165','38509','93630','64284','40046',
                          '17944','87567','63688','38023','88486',
                          '62586','99059','26199','60357','59343',
                          '96543','14930','31210','40213','76126',
                          '63864','75390','11588','64224','23850',
                          '24463','94968','78008','69182','16711',
                          '42324','53713','43280','53414','77625',
                          '64868','38198','23363','46368','53350',
                          '19868','14488','25978','19473','79655',
                          '99168','93199','45815','96147','88316',
                          '23760','57296','88623','80164','80831',
                          '34225','49503','64519','42974','10295',
                          '96347','74931','39382','98002','96125',
                          '46372','36248','99585','12061','99458',
                          '43132','35932','59866','35002','73939',
                          '98950','53565','98145','73663','72913',
                          '71359','67731','47366','67931','21207',
                          '36776','20490','22429','92619','99665',
                          '10329','32471','51734','28139','49617',
                          '70896','41984','63580','51089','29481',
                          '63758','72814','25204','65619','25101',
                          '46295','65778','92078','32033')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


