
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '87872','73115','21000','18483','30577','90482',
                          '87650','34724','58718','54023','16117',
                          '47445','20468','19094','58193','33327',
                          '40383','70409','35642','20101','19012',
                          '19525','25714','93825','63581','37688',
                          '37035','58495','64088','86458','16865',
                          '34004','72575','56496','67158','69886',
                          '10430','91895','23085','74571','74224',
                          '14278','32802','21184','33335','39897',
                          '46762','89348','57012','13807','31033',
                          '76083','75623','64647','70051','82402',
                          '83943','13694','69506','70374','45872',
                          '31142','19169','53812','46484','40194',
                          '37262','11505','46916','97802','81852',
                          '17960','39443','73916','21660','14549',
                          '94995','31687','21402','54083','22108',
                          '85674','70885','30427','48212','71656',
                          '54149','20385','44737','96564','67668',
                          '12253','61279','29740','97446','36126',
                          '70756','95281','11864','45759','92287',
                          '13702','50268','56674','69089','25113',
                          '37722','69224','95330','29250','11709',
                          '81477','41843','23494','24100','57448',
                          '39319','74838','44269','61170','79522',
                          '81026','81063','52686','59035','15388',
                          '11398','52704','93500','56844','51855',
                          '13671','69128','71294','59573','49812',
                          '66856','51930','73333','54844','45362',
                          '99583','74372','37574','78515','46285',
                          '51419','50603','59450','31387','44551',
                          '99507','86860','18060','77513','90459',
                          '61973','66296','34228','35143','64454',
                          '21210','81672','96313','15344','80035',
                          '45778','78378','93266','25084','80336',
                          '74375','19189','31284','34411','52250',
                          '39538','96430','70429','76571','36910',
                          '80720','64122','16794','78989','99820',
                          '56158','27281','54204','35701','81420',
                          '92009','88264','93460','10425','99189',
                          '37857','99448','25809','90189','57956',
                          '49692','42653','42275','17439','15045',
                          '11937','38047','74533','72426','74988',
                          '53301','74414','34522','43624','46580',
                          '40608','94137','53038','24730','82798',
                          '81006','76893','33440','75174','68698',
                          '57734','43037','41811','37967','91835',
                          '25885','51677','75781','23296','28910',
                          '55288','84868','93337','86815','64792',
                          '49159','47278','97119','39549','90838',
                          '24711','98853','38036','39335','71425',
                          '65165','86265','93931','21836','34532',
                          '89256','48807','94213','51675','93900',
                          '86925','46374','60652','58587','26793',
                          '28512','38501','68728','11573','60948',
                          '35471','15602','61884','12632','17458',
                          '30089','32192','25538','57867','75103',
                          '76808','25803','79208','66866','85005',
                          '17564','76736','33413','49734','81112',
                          '94711','19379','83828','72831','53753',
                          '19037','12836','91985','78412','90545',
                          '98151','66670','78311','55146','71629',
                          '36275','68974','86205','36291','21778',
                          '70606','71326','96280','67825','27227',
                          '64719','86392','40831','72618','15343',
                          '46064','81460','95660','89453','36748',
                          '55131','21269','60342','92157','67114',
                          '44530','70617','47978','12449','30029',
                          '39179','46570','85418','15641','78308',
                          '25063','55875','58525','85646','18905',
                          '97940','13145','12032','89998','77490',
                          '41683','47939','20022','80779','56249',
                          '35414','52924','82875','21159','69372',
                          '31385','47550','90805','29694','67586',
                          '74695','19816','74436','57691','18513',
                          '23661','28036','28842','84627','13598',
                          '72210','60850','35665','13152','23733',
                          '20887','28611','11761','62709','90621',
                          '73027','39605','45541','16320','13126',
                          '27282','81604','75263','47417','23125',
                          '48605','16454','99277','50392')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


