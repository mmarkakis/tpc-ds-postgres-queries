
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '14032','13511','70425','36036','66971','12290',
                          '81687','45338','14076','73511','68103',
                          '41561','97410','57882','22181','51159',
                          '12899','49016','20111','68023','21468',
                          '33720','87274','20112','85588','82021',
                          '27511','54298','52160','77961','12399',
                          '11684','70451','55893','58472','10061',
                          '80221','75906','91984','89388','39513',
                          '92807','65961','51674','60922','13032',
                          '66097','50807','39861','78404','61991',
                          '75250','99969','39097','76312','73912',
                          '26359','53927','99145','62955','26608',
                          '59658','56917','69941','88963','11305',
                          '39811','60437','55693','63068','53563',
                          '22055','75344','41757','57161','48354',
                          '30235','27831','52615','42881','12081',
                          '71739','60744','53382','99612','99761',
                          '62220','65475','90547','68986','23785',
                          '48202','59553','82117','54587','24457',
                          '12962','83205','70548','31928','94299',
                          '33935','97460','28061','50883','28228',
                          '34065','96505','76876','18646','76044',
                          '78251','26435','98973','79007','76222',
                          '21495','87961','78359','99767','75463',
                          '80152','79930','32658','15669','58813',
                          '52332','84984','57421','21938','26623',
                          '10340','64979','87669','83715','42877',
                          '39341','60271','65349','40004','72718',
                          '35687','18281','57203','89475','24574',
                          '41796','87175','72205','66491','15103',
                          '86015','39188','35438','76449','60041',
                          '47172','94516','53371','55998','44559',
                          '59222','40708','94180','70302','32052',
                          '44050','29217','27781','56729','49502',
                          '46234','44638','85522','99042','11810',
                          '55082','56502','15465','62776','86845',
                          '64366','75187','72153','26971','22356',
                          '22042','38113','70241','29988','32823',
                          '90113','85990','24187','91365','95260',
                          '13546','81618','41536','29720','41822',
                          '89744','76211','29884','97789','27829',
                          '14173','85107','83148','37487','33918',
                          '68033','96325','20941','34434','51744',
                          '96075','15197','33468','30333','45458',
                          '17801','27641','60001','53771','54614',
                          '15350','39649','60987','54620','15650',
                          '71017','87503','97762','93698','57780',
                          '79611','79466','43508','76802','79941',
                          '21997','55837','19822','46697','26200',
                          '52954','20938','41565','27531','52480',
                          '15579','74540','89762','34798','16103',
                          '56936','31489','98966','27081','10610',
                          '43688','81084','27788','93716','20572',
                          '72863','57946','22139','39871','22562',
                          '97593','76275','34684','13000','18935',
                          '50316','58982','18857','51733','42102',
                          '75126','45237','88319','96034','97984',
                          '48055','98446','24758','96257','72986',
                          '65819','63235','59801','30826','12450',
                          '30711','69639','73538','78413','94348',
                          '60177','60978','70399','57031','95547',
                          '24866','37089','85038','15529','95360',
                          '51646','51206','96966','62656','96998',
                          '21558','68866','60519','25489','89903',
                          '26252','25877','16138','32397','71104',
                          '75612','10986','17557','71444','65665',
                          '87980','20061','52239','29991','71066',
                          '72684','17258','32380','35154','96720',
                          '96027','94003','37610','23858','55930',
                          '69883','92947','56342','76764','73913',
                          '56265','46082','19385','65399','92310',
                          '22640','45807','19065','27692','68487',
                          '82193','35837','48803','70537','74670',
                          '32666','88399','92960','27589','26584',
                          '54010','25709','51079','99153','74389',
                          '95442','16556','15825','89075','73112',
                          '33733','20872','38152','98857','11645',
                          '86334','83960','41350','17876','77497',
                          '26862','34015','19232','65711','23995',
                          '86092','89957','61692','54260')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


