
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '21833','65018','16003','24799','94386','62644',
                          '64273','90123','73377','19051','62035',
                          '63093','47535','20619','43458','81135',
                          '98350','34874','17750','33983','65195',
                          '63784','37984','31150','48418','54235',
                          '73555','33602','50597','17679','32384',
                          '14073','78312','70861','81826','34699',
                          '61968','11886','26991','42204','79007',
                          '91349','32898','75898','79277','54403',
                          '81062','72381','86048','49951','35134',
                          '31314','65791','55963','66380','47757',
                          '37575','84249','37733','75265','65047',
                          '65701','51885','99102','14155','14031',
                          '23095','80239','82581','46437','73659',
                          '94057','27421','37842','77456','49635',
                          '21581','97743','52726','55937','23711',
                          '77305','45521','88617','56034','45798',
                          '29278','94739','44813','90784','29241',
                          '47258','57162','25071','95139','51273',
                          '94542','56335','36970','85400','54703',
                          '36536','36991','35243','81160','15776',
                          '12562','10772','71785','98883','38514',
                          '32916','26295','12282','86559','81245',
                          '47280','17461','34301','88674','84831',
                          '92766','71313','48065','63512','94708',
                          '92102','73134','79273','24711','44306',
                          '24986','68452','31459','14611','57269',
                          '46538','65538','51865','15875','42478',
                          '42380','74026','35234','45645','42455',
                          '33038','44653','62954','51697','15042',
                          '34144','51111','55098','61428','41720',
                          '35155','51603','73506','74994','29576',
                          '70480','58451','45914','79142','86730',
                          '95407','85456','33531','27883','43259',
                          '98527','19695','35489','65948','82030',
                          '73769','25624','70200','15564','96903',
                          '39500','18862','91350','22665','33368',
                          '90662','76184','61492','24606','37035',
                          '70676','95822','58265','22763','43964',
                          '11391','14522','37580','52292','15123',
                          '71004','94748','82203','16484','44909',
                          '84164','99112','24327','75337','71042',
                          '69488','99758','75597','69288','93141',
                          '61404','55982','68037','72385','35386',
                          '87048','84273','20141','25100','94995',
                          '84258','44872','48265','92620','35716',
                          '34989','83098','53636','38706','42837',
                          '27108','29507','19189','16864','44018',
                          '34031','40636','74062','13205','17506',
                          '43752','17472','20806','28564','44078',
                          '29486','31427','77840','91520','19975',
                          '65074','44114','13603','27359','25055',
                          '73977','73096','14703','66503','59644',
                          '62450','61138','42887','81659','34894',
                          '49531','33355','94094','76194','85488',
                          '93516','45977','91398','14562','42134',
                          '97175','35248','56135','78355','49838',
                          '63460','84376','68173','47042','33974',
                          '54378','74425','11652','93838','59090',
                          '74537','33567','17431','28190','52449',
                          '93951','84154','87671','39542','25760',
                          '47990','92140','52667','75155','96617',
                          '46653','33039','81912','89517','83300',
                          '24415','48770','19141','52310','63362',
                          '95970','73162','69575','80008','14884',
                          '30213','39274','73102','97862','24550',
                          '61252','58882','45173','34374','69965',
                          '73469','23856','58592','40851','79743',
                          '38667','43566','26013','54377','27061',
                          '73533','76241','17361','46382','65070',
                          '80349','53660','68167','25360','32083',
                          '77073','73246','97222','64491','87678',
                          '98220','38008','76278','34265','96405',
                          '50882','44400','68587','39471','25302',
                          '29895','54594','54919','52836','93519',
                          '59201','82285','66796','64782','77979',
                          '36478','98233','67093','67087','94576',
                          '23381','44827','68214','80428','86082',
                          '91871','32719','32032','74924','26220',
                          '46146','75273','40540','47889')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


