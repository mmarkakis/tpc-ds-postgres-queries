
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '82512','73796','33462','84082','66875','26974',
                          '43788','95018','59132','20598','99365',
                          '28812','29898','99619','25475','40476',
                          '17655','23030','35551','55309','88901',
                          '53751','75510','37865','36972','92806',
                          '13995','99117','50607','45813','90992',
                          '55383','89196','57751','58802','46386',
                          '66468','45347','90661','46282','56531',
                          '68768','61531','57887','19595','46279',
                          '15648','31380','55891','54754','73270',
                          '62537','68912','10375','70988','61328',
                          '33008','27524','91984','60916','60486',
                          '52978','15319','77193','61489','41366',
                          '45955','88295','36789','24738','12181',
                          '74193','67613','93242','33293','42310',
                          '79527','32759','17836','34888','15845',
                          '24962','26629','97373','21996','77608',
                          '79847','67526','79406','93976','45460',
                          '78778','95682','73105','10330','38711',
                          '20053','77842','92818','60538','48365',
                          '88057','95123','69932','83039','63698',
                          '83275','31971','30457','56127','75218',
                          '52857','15091','29073','23486','24120',
                          '14580','98393','54320','64330','43692',
                          '48538','61499','59022','94975','38897',
                          '36695','71933','91708','40849','82849',
                          '51008','86829','28443','57792','56529',
                          '15900','73406','27933','10719','14961',
                          '69178','54379','14342','88847','38167',
                          '55021','78996','34452','18760','56635',
                          '38608','20590','41773','80718','53357',
                          '88157','60360','20159','86715','90097',
                          '48979','16607','94427','98272','14028',
                          '65196','55320','45146','54788','32086',
                          '53970','91936','67877','71555','74031',
                          '60208','13490','71279','29831','12059',
                          '70528','14751','59871','73705','23872',
                          '30129','22555','79793','30444','88489',
                          '49703','17730','67619','25168','42471',
                          '63643','82787','26444','39385','36039',
                          '41085','88175','52975','32135','13637',
                          '90689','77112','34662','29455','78284',
                          '67729','33260','48630','98186','71701',
                          '25571','60211','14356','30214','11361',
                          '24574','42426','10687','34414','45641',
                          '39655','81272','49440','27649','42479',
                          '83318','94415','36383','69247','92216',
                          '61030','51229','80659','52955','80104',
                          '28364','96900','44610','89294','12644',
                          '57650','57835','22645','71782','87516',
                          '41281','98743','88117','42448','94528',
                          '75136','44438','33189','42818','28447',
                          '61097','42060','86453','86357','13267',
                          '81631','95382','73422','18579','94767',
                          '77286','84385','22714','49292','91789',
                          '65088','49538','75421','55363','43166',
                          '12321','42087','39220','30328','75682',
                          '69282','18753','62502','72979','81313',
                          '22510','99551','65834','97414','85106',
                          '99744','68410','63090','49168','88905',
                          '23744','65724','31695','72473','31290',
                          '45531','28541','90068','33204','29653',
                          '33170','33007','54176','91239','21115',
                          '17057','78376','40327','14881','62330',
                          '74733','23737','92895','74201','79294',
                          '10498','23843','15360','29074','70051',
                          '55730','79941','61358','25021','93084',
                          '79044','52903','24902','51428','40974',
                          '47557','80354','14027','97819','90277',
                          '69953','81476','83879','72379','21637',
                          '54070','29832','46651','73929','56385',
                          '96017','46047','54544','38022','70911',
                          '39216','47523','53076','53571','60290',
                          '43065','72051','44416','82254','63841',
                          '21401','17118','25064','53525','55168',
                          '55470','56409','65859','67141','77861',
                          '36604','21045','32420','48328','60298',
                          '66296','64244','44645','75373','38396',
                          '87169','38085','42414','47875','60099',
                          '45865','42093','10160','42508')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


