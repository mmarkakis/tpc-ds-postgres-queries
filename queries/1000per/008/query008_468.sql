
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '47264','65339','66261','23899','48055','33741',
                          '30354','69644','65173','24191','31419',
                          '76302','71502','88290','70049','37406',
                          '73839','47033','17952','91870','21549',
                          '43278','50044','53652','97278','70927',
                          '71367','69335','15864','53888','95568',
                          '90127','23577','18069','77395','16333',
                          '63967','63403','67446','35879','14285',
                          '92281','17008','56234','20502','26039',
                          '80747','34904','57571','74722','81559',
                          '60753','16443','19780','10895','68446',
                          '49177','68169','49230','93511','17262',
                          '66028','50818','83929','14192','99633',
                          '22036','20788','27426','70921','66877',
                          '43397','22215','46448','24420','71619',
                          '23249','95422','34725','59427','35801',
                          '77574','52435','76952','82120','28132',
                          '49280','50727','46608','44025','86985',
                          '99637','58936','78926','77392','72873',
                          '29651','60476','65834','38662','48362',
                          '77182','35819','43836','38355','15032',
                          '14087','69356','98639','81127','15710',
                          '26444','53412','28602','64628','38161',
                          '82955','99673','81924','63110','42314',
                          '16710','54538','72436','36823','10318',
                          '40193','24511','34002','15686','25576',
                          '67762','46517','80140','76064','20154',
                          '15943','66618','76409','95224','89784',
                          '41708','97046','45491','65558','24174',
                          '15458','52022','75494','39098','82570',
                          '41194','87034','21366','16451','49453',
                          '68748','55599','12749','54821','39664',
                          '51802','50109','74326','74477','64337',
                          '29397','67949','56394','86635','55827',
                          '60252','94615','37328','54113','38322',
                          '64257','50257','57310','66919','41950',
                          '20044','30147','50986','27930','25187',
                          '16186','21165','65739','12099','34007',
                          '69822','47899','39510','67330','39285',
                          '73250','27541','15513','93486','39554',
                          '65707','96119','94180','12436','42890',
                          '38679','89468','20172','44276','73286',
                          '95094','85027','14221','67159','46267',
                          '57018','58497','67803','19349','46676',
                          '49209','33413','97563','11023','87958',
                          '80725','20198','30377','25567','89717',
                          '92958','36362','48215','68844','44401',
                          '32463','24726','87989','22936','97800',
                          '49146','46728','88546','70857','48135',
                          '55649','32034','78238','43667','83451',
                          '84384','96419','81711','25584','18764',
                          '23879','76370','84694','22751','70453',
                          '54324','80392','13822','87584','38542',
                          '98810','28412','60078','93797','13007',
                          '65843','82753','40860','33912','66567',
                          '94810','78943','61456','39137','70640',
                          '85904','10823','71983','67210','58471',
                          '82856','56265','40936','48810','17450',
                          '28017','54890','52606','33677','43601',
                          '52522','16997','41179','57835','10712',
                          '53091','73861','30414','21246','82604',
                          '14236','16149','55744','10995','20847',
                          '99478','95375','68108','47933','98105',
                          '64001','92634','29685','94882','19615',
                          '11768','50377','42977','11786','26382',
                          '68579','76656','74179','84497','32910',
                          '43576','83522','14423','22554','13989',
                          '99392','88872','68397','77755','69705',
                          '17343','35998','66101','81516','86146',
                          '16947','41826','41517','48989','87097',
                          '65543','38148','10689','27059','14770',
                          '92519','38155','23637','38048','67160',
                          '66998','84229','46256','76811','77865',
                          '37706','94104','93966','60362','67259',
                          '98102','83561','16434','76851','88134',
                          '60011','64437','75346','51543','63771',
                          '34434','33057','92941','85756','24961',
                          '20587','90163','56178','25572','29637',
                          '89212','13690','74582','14781','45737',
                          '16713','84986','22018','72137')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


