
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '54791','71860','34276','86531','71184','87375',
                          '58138','43346','78796','62844','81728',
                          '47178','99908','26658','87425','33030',
                          '76845','96347','65735','26319','68571',
                          '10252','46610','36455','34262','44322',
                          '74820','37307','50901','75478','64408',
                          '26052','81669','24724','35498','23629',
                          '14949','26387','64720','69324','97842',
                          '17782','83163','87023','15298','76698',
                          '63520','32015','30857','94795','72037',
                          '88760','85362','59686','80186','31999',
                          '19605','35602','65813','63241','50735',
                          '40344','95291','72887','34823','12082',
                          '10854','75175','60765','31003','91564',
                          '32411','97720','41503','60937','99050',
                          '84156','35625','28056','45707','11172',
                          '69938','18332','83241','21702','27532',
                          '42381','78798','18432','93173','24856',
                          '28647','89784','52085','90041','27954',
                          '82257','67582','92826','62719','29428',
                          '79347','91480','56441','69401','63186',
                          '25650','31040','64193','56323','29022',
                          '17048','12400','31461','55408','80820',
                          '50285','74378','16397','70076','22286',
                          '80105','49698','34364','73496','39517',
                          '27622','77638','94499','39874','75158',
                          '21167','46962','94988','19355','16729',
                          '85335','72654','65122','24626','60268',
                          '79702','78528','53735','94447','50390',
                          '73724','79542','17693','37244','46990',
                          '81359','33788','91789','58686','73075',
                          '59036','27737','43330','81793','40744',
                          '85823','26849','44022','50947','97099',
                          '99839','21688','22026','44194','17117',
                          '99681','22731','65667','48124','19390',
                          '92617','27487','79028','48698','91158',
                          '64373','91232','18140','19961','55942',
                          '93670','36312','38752','39088','42025',
                          '97955','50198','83761','89723','25368',
                          '65389','56931','93897','50202','10868',
                          '60182','71079','37317','50805','65887',
                          '23253','38034','17618','40713','18975',
                          '57125','97477','90192','65311','98977',
                          '60273','85117','79720','16221','20613',
                          '45971','71374','90441','44034','50302',
                          '40304','80766','72934','76892','94417',
                          '41420','85942','54300','66750','53611',
                          '52482','78023','90238','10001','41201',
                          '33961','45024','88920','29821','74008',
                          '24669','85555','11612','81853','97679',
                          '66281','22619','88210','63090','16124',
                          '98371','22854','84210','19108','52588',
                          '57849','10689','11052','74203','51255',
                          '67403','86832','12355','63941','33359',
                          '53859','73927','23583','40175','88838',
                          '75795','71430','11297','48873','55438',
                          '43289','64381','26244','80574','98704',
                          '38148','72921','53694','66133','21944',
                          '16604','80908','70879','37662','80115',
                          '31871','88690','15393','45658','68663',
                          '36472','17573','90158','41549','63201',
                          '75879','79817','70153','74337','19480',
                          '55327','24305','61342','87599','55457',
                          '75356','58681','54103','51954','29514',
                          '16420','80110','21664','48036','20177',
                          '33053','26630','92601','29903','75396',
                          '64436','82704','99921','48174','42382',
                          '28658','71272','56621','83447','46066',
                          '19415','98360','44761','11400','55455',
                          '64397','68430','38902','51054','84899',
                          '54722','70929','75434','20827','30582',
                          '78152','90932','18021','68550','36973',
                          '75135','16154','80093','92412','56019',
                          '17588','29786','95627','90442','67168',
                          '64530','29764','55847','85327','13496',
                          '49952','96242','59452','32693','94986',
                          '40418','78389','32617','52320','66128',
                          '66509','30861','76115','54159','55245',
                          '80195','43010','86804','43944','92131',
                          '75586','46915','91079','19198')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


