
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '71951','32719','20802','40209','44914','69393',
                          '24979','49500','79870','43184','48640',
                          '71787','94064','57383','49816','62456',
                          '62628','56166','46867','83445','27556',
                          '84528','64153','77929','36673','38770',
                          '50117','56377','80268','21435','38066',
                          '78783','92298','43342','94407','69852',
                          '68141','21554','75785','41730','70429',
                          '23147','53706','87322','54908','46392',
                          '41220','36545','67793','45426','24806',
                          '15474','20233','67315','87121','33127',
                          '14210','39188','53553','77885','75134',
                          '79798','81696','88665','46777','26127',
                          '88993','44500','89691','13543','13144',
                          '21922','26552','32988','23218','43286',
                          '64382','13142','27294','72155','38780',
                          '18881','23028','18921','23612','96843',
                          '53424','76087','67753','95443','41742',
                          '59741','84672','52326','35593','88509',
                          '31355','73672','41556','48081','91023',
                          '11920','34164','62896','79889','70016',
                          '74940','63822','89084','44728','15872',
                          '93764','84309','54117','19036','92526',
                          '88614','36485','58180','92267','15959',
                          '36794','92530','65705','50883','59719',
                          '98117','26560','54369','91875','95151',
                          '56928','56487','15293','70085','80560',
                          '26042','88755','84082','18338','31681',
                          '98089','67576','68187','61238','60653',
                          '38632','87019','76304','60461','62664',
                          '53372','72360','72283','22366','12464',
                          '84685','22273','13951','18861','95033',
                          '78331','52276','82586','96388','16525',
                          '87068','69359','19111','47740','65419',
                          '59223','42909','48095','70492','63431',
                          '83368','95204','66009','42785','54881',
                          '77704','40500','48043','26631','98382',
                          '58422','76999','36972','38198','32712',
                          '87804','65691','50378','48182','48399',
                          '80120','13191','70149','84289','40403',
                          '40768','67214','52517','94599','90988',
                          '42500','78075','71698','55077','57748',
                          '42414','66296','89304','50792','89572',
                          '86342','94937','59770','63033','29589',
                          '94015','77856','90596','35897','29500',
                          '46014','61216','55684','52858','87025',
                          '14636','60252','22105','25804','31231',
                          '81885','71020','26585','76368','44394',
                          '30467','66603','39856','35037','71242',
                          '17806','12143','28005','57353','63104',
                          '16511','32484','69442','43225','92538',
                          '67788','28999','34253','82552','92596',
                          '51279','81926','28711','85806','35934',
                          '54336','60294','74761','44494','27313',
                          '75671','20040','82930','84127','14824',
                          '36203','18917','65177','47426','26452',
                          '22553','79139','14201','82131','22784',
                          '33222','41925','12724','69003','48897',
                          '37235','55488','18401','83088','77846',
                          '25346','85961','51958','65690','81550',
                          '23184','15296','85022','44559','66620',
                          '21167','93528','20288','60044','51661',
                          '28742','26015','25266','12445','34766',
                          '34779','34690','38196','44975','19906',
                          '82831','52662','82102','97267','58219',
                          '93662','89779','27922','58087','15094',
                          '96299','54676','97580','33886','93224',
                          '24947','58511','73791','67376','77016',
                          '48805','36646','83427','28750','70065',
                          '78877','10894','72694','85258','65016',
                          '71893','68119','23882','69000','94633',
                          '37250','91894','75150','91883','84995',
                          '55965','10803','13248','69233','71154',
                          '22154','94315','33126','89762','71609',
                          '39726','72798','71586','98385','11415',
                          '27011','72061','22645','12231','52655',
                          '88518','10375','64854','95721','20474',
                          '99203','42123','71555','13508','75807',
                          '82865','80793','75475','55731','14464',
                          '57806','62080','93963','41145')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


