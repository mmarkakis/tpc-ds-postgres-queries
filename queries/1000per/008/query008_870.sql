
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '46956','13223','74620','15139','17684','63126',
                          '94224','36193','78119','29133','36835',
                          '94579','98156','84109','45649','60013',
                          '42476','37941','90485','89102','96036',
                          '91433','80161','11706','73115','46051',
                          '79302','12474','89216','38703','62994',
                          '27031','73851','30794','99133','46268',
                          '99974','38523','82039','15786','26958',
                          '77087','63800','82657','65228','76616',
                          '49568','95902','69188','34317','65307',
                          '33256','56753','29355','44554','79715',
                          '80120','90033','50467','89364','59711',
                          '29215','30027','82504','58234','78622',
                          '62191','30969','64770','41023','52575',
                          '72631','43005','41917','82378','75983',
                          '87695','90782','95969','17515','21211',
                          '98494','31331','92496','26637','24790',
                          '35061','43340','31268','18836','47119',
                          '58032','98284','40072','54740','49775',
                          '74501','70874','55916','40737','55342',
                          '68482','43333','37880','35215','30894',
                          '55754','99699','94718','51516','60829',
                          '63014','34986','13485','53984','95678',
                          '45186','12557','21824','27469','36563',
                          '85221','64817','12153','94025','50485',
                          '29030','66505','44450','10933','56314',
                          '51168','71186','21251','22868','90545',
                          '32814','79693','28183','53562','86753',
                          '17867','84527','34997','96611','79860',
                          '15904','23790','95666','69457','35764',
                          '57173','91300','88545','19191','62404',
                          '95931','40587','60066','85491','26405',
                          '36508','84585','50626','72085','79600',
                          '32910','94313','52768','41522','58580',
                          '76459','50661','62126','90652','78262',
                          '72707','60408','87326','36764','81846',
                          '50082','96498','28590','92671','64783',
                          '67402','19001','99030','12861','39875',
                          '96569','54636','81430','11077','64508',
                          '89952','98123','94379','14272','20651',
                          '17760','48297','17378','32903','59331',
                          '22329','35490','63792','50445','80357',
                          '86719','91580','86829','31238','41409',
                          '22463','43055','71078','72012','52967',
                          '56985','47753','66164','43168','74942',
                          '70229','69889','80002','71723','78264',
                          '17933','52243','18676','30236','72204',
                          '84729','39167','79627','52172','76140',
                          '72716','14327','72187','44353','10767',
                          '88166','24169','48749','78942','69179',
                          '16364','87923','48841','61387','24025',
                          '65449','37892','62027','25692','23691',
                          '17651','68755','15258','89439','80793',
                          '92859','92277','10953','16819','36881',
                          '60617','89891','63243','64166','16868',
                          '19147','89964','59163','50780','26769',
                          '70130','98693','67288','17175','34749',
                          '68096','45465','52624','38359','48967',
                          '94314','69466','66854','78450','76936',
                          '79089','47660','50994','87556','20125',
                          '35573','81466','71074','39811','39651',
                          '67044','43130','24837','26802','78160',
                          '86126','26544','81864','64920','44939',
                          '72690','59643','55774','61499','28707',
                          '55084','57865','36175','77891','74522',
                          '11811','92398','50773','35108','49390',
                          '41729','22652','81329','29289','64466',
                          '15019','92152','29596','62178','48754',
                          '33334','15627','98314','46418','99565',
                          '82110','68257','42803','93903','93144',
                          '66899','56397','90340','33513','94780',
                          '97217','34880','84790','33959','62748',
                          '43447','78939','15865','95752','21636',
                          '27373','80274','37669','80692','20053',
                          '16978','33450','79500','53886','38164',
                          '92102','23556','41876','44753','82449',
                          '96086','73628','91247','61634','67009',
                          '41228','15242','55965','14715','91814',
                          '28338','78058','42743','17174','57982',
                          '87827','44170','51611','42486')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


