
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '78572','87703','83072','48697','85245','50224',
                          '73758','95022','71034','52052','63271',
                          '51151','91557','19081','91188','30795',
                          '24694','25499','83515','70749','20329',
                          '63807','11649','74273','95940','57360',
                          '81550','12527','48673','46959','58685',
                          '94416','74676','26420','17142','32308',
                          '51813','74244','86762','72811','57071',
                          '65980','56705','76068','97277','53545',
                          '25482','96348','54359','83718','89043',
                          '44389','84613','23559','89124','94118',
                          '95273','39128','71741','37179','84634',
                          '63005','32491','14743','27020','96503',
                          '33206','81075','93713','95160','80340',
                          '13333','15074','97702','43327','30768',
                          '46522','56474','84658','65371','90980',
                          '54853','28167','37369','22315','65026',
                          '13088','55036','96477','98620','79111',
                          '54839','14395','77052','14671','75418',
                          '10228','86174','32687','83857','54988',
                          '71822','37120','42288','14120','18902',
                          '95942','33353','26536','48874','96562',
                          '45746','50959','29297','59352','58867',
                          '24853','16110','77974','38449','87621',
                          '68608','45546','25654','42981','31504',
                          '79218','85251','32252','19567','36587',
                          '83130','91921','90467','52786','63369',
                          '29528','53393','46039','40138','34938',
                          '99214','61581','20269','60575','51846',
                          '61214','62577','62265','89805','47239',
                          '87411','79990','49505','92608','92178',
                          '66323','14257','60477','80914','13668',
                          '33295','66055','98021','51542','99085',
                          '94039','89748','11384','71610','36166',
                          '19115','93753','87120','46848','51008',
                          '72419','21410','56782','65248','49242',
                          '21934','28329','95372','95285','23190',
                          '73856','93061','58469','88783','58112',
                          '96595','67886','15895','24325','83805',
                          '85237','36909','81924','28656','77488',
                          '65077','78709','20318','92097','75123',
                          '78959','11176','79259','45836','84484',
                          '45389','61068','46565','81651','16068',
                          '87613','88806','72035','12505','76226',
                          '93186','39561','55901','68796','69839',
                          '48369','84265','63702','11124','10156',
                          '55718','20723','66468','94895','83118',
                          '48323','55942','10082','64858','49557',
                          '69784','40169','77962','63266','78394',
                          '80039','43337','92149','92935','51199',
                          '37601','62376','66428','45073','83364',
                          '68210','84997','25031','24701','62069',
                          '50867','43150','52465','42153','89403',
                          '19180','76297','33583','80875','79591',
                          '78081','15096','33371','55726','17039',
                          '39616','17777','72428','69396','70952',
                          '78577','60710','83881','87344','77412',
                          '19240','27022','77738','72239','47768',
                          '36473','38015','22014','81513','43926',
                          '31141','44952','86028','89848','58792',
                          '94506','39955','59109','41981','24255',
                          '92014','43209','43927','30187','74785',
                          '57106','36740','85219','75155','93280',
                          '24540','19632','25225','42273','27281',
                          '77660','64681','46207','52676','34144',
                          '68730','44825','60540','45180','84202',
                          '21260','16551','56868','91371','45440',
                          '22431','40245','93661','80265','45725',
                          '67509','54606','83584','25128','28128',
                          '81861','26287','41735','11186','63664',
                          '45590','74979','52866','11524','65919',
                          '17569','21344','66811','11427','45997',
                          '93811','25648','42773','67956','33300',
                          '16655','85602','81388','98303','71706',
                          '41747','46713','13933','24881','66896',
                          '60909','63539','97886','74220','39502',
                          '31841','19730','95589','88647','71980',
                          '31065','77124','34935','97799','29529',
                          '35835','15222','10253','74587','46586',
                          '86080','22332','38017','62679')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


