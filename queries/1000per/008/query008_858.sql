
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '42332','60956','14644','40139','22202','70587',
                          '40196','75099','13514','17460','64095',
                          '35671','22935','40328','66017','80148',
                          '99882','20970','51196','57082','54408',
                          '38414','19899','28859','22514','13243',
                          '90081','84766','60407','68344','14112',
                          '44215','34133','45106','54817','26914',
                          '96464','47092','16897','52396','91171',
                          '33908','88589','93524','95789','44383',
                          '48258','43976','54759','60089','98424',
                          '54085','44463','94676','45352','39793',
                          '19369','48980','91247','82384','66711',
                          '76177','28948','61251','99258','99426',
                          '94428','53653','17697','89767','15191',
                          '41053','84797','50248','26120','32543',
                          '42170','28582','65272','32761','14273',
                          '55568','96803','14233','44001','92020',
                          '37100','95345','25240','12570','35448',
                          '50311','39141','12904','69438','65365',
                          '52173','23357','52244','73327','60999',
                          '88677','18538','70584','84607','14599',
                          '20059','34754','86695','35620','66988',
                          '32411','97648','60396','37804','37689',
                          '34280','86144','30310','74398','75140',
                          '52387','88673','13251','38470','23831',
                          '61376','63782','29843','24042','24982',
                          '39217','80194','61579','98001','41825',
                          '78504','62159','72786','27875','72009',
                          '84100','25844','57341','86127','17035',
                          '63051','78355','26036','32074','61121',
                          '78663','76633','70730','11608','51976',
                          '27711','17273','25481','73929','19166',
                          '71036','86488','95707','84458','31860',
                          '61218','98773','89850','34949','39042',
                          '40080','70995','32655','38219','14653',
                          '55084','65145','60913','25665','75727',
                          '82823','42786','88783','57311','89380',
                          '70876','68062','41095','60183','13597',
                          '96283','61043','75579','54964','19303',
                          '57738','31941','67970','75122','35743',
                          '80156','26266','72387','89052','94622',
                          '43941','43889','81340','35880','98893',
                          '31695','36871','20598','95436','48873',
                          '91279','30456','89334','15217','77739',
                          '61732','73013','30235','76894','37819',
                          '21142','76744','59529','80741','61847',
                          '48372','86992','33156','25918','20560',
                          '18122','25357','47431','85183','78522',
                          '58893','97463','83623','56945','66639',
                          '40576','11380','67450','18950','95893',
                          '13829','46211','11969','28524','80981',
                          '80899','86639','90025','67859','39745',
                          '78396','18593','35863','41800','11457',
                          '59894','83575','49174','67863','42732',
                          '52895','31494','24576','74134','78679',
                          '50832','76610','53748','81547','31910',
                          '17342','15702','37674','80737','90255',
                          '65861','14183','96144','16399','60623',
                          '52052','38252','28693','28381','88910',
                          '81618','39561','92509','88928','32388',
                          '47181','17324','78066','27196','15402',
                          '81425','17790','59931','49326','70342',
                          '19005','83871','94870','89013','31365',
                          '71987','18284','24898','25507','60040',
                          '13244','86626','84413','88423','25692',
                          '15210','80311','47160','65441','32103',
                          '16459','22510','25483','56864','29142',
                          '82584','13113','41126','69851','96994',
                          '23822','96255','75815','89907','99859',
                          '19141','55971','51235','19356','41003',
                          '93063','30231','94635','59762','38980',
                          '71651','97922','93405','84706','83521',
                          '78708','97519','34580','13933','86975',
                          '24736','36812','35178','78410','12802',
                          '85540','96784','89802','55128','18511',
                          '47728','77755','69625','79026','39649',
                          '60719','74321','91657','31799','74598',
                          '59611','85147','58450','65849','39261',
                          '10683','59162','27460','13737','94638',
                          '38324','86550','70356','55781')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


