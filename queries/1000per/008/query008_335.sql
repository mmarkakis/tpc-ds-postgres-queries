
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '59341','48309','19184','11572','79468','64444',
                          '31846','19550','98932','94447','90861',
                          '39322','27153','81561','17243','67768',
                          '22044','15592','68187','55665','32133',
                          '14681','32700','93102','40679','77144',
                          '99495','86134','96911','75913','45690',
                          '50353','53960','67217','31754','21588',
                          '49219','79527','86111','42880','20981',
                          '44984','59455','33858','91554','19124',
                          '20176','11221','69274','28775','90541',
                          '61967','72045','46444','59104','65466',
                          '55350','74963','21476','10640','97909',
                          '32361','34819','61745','46800','69992',
                          '37635','59617','75637','59676','87202',
                          '72706','73357','30228','21474','33100',
                          '42145','54722','91769','60267','83727',
                          '29562','87528','99792','71768','91396',
                          '94284','17689','13228','66203','16030',
                          '61616','15961','67117','96260','60527',
                          '32345','37291','47191','53583','26493',
                          '32956','44063','49461','25401','73126',
                          '16817','99390','96135','15248','82557',
                          '38053','72138','95189','70919','56894',
                          '71628','18261','63436','34998','98827',
                          '16910','25844','55727','21048','39130',
                          '13899','57835','16807','97964','39835',
                          '18065','68095','39775','39378','68976',
                          '63098','18151','56385','76403','93165',
                          '10578','93178','36217','94784','86202',
                          '35828','57845','56424','77138','76644',
                          '22115','98470','29575','19828','60955',
                          '90412','57922','92873','97054','75059',
                          '95167','33890','23638','44316','74252',
                          '37057','67795','50795','95251','19707',
                          '43191','38908','35205','10770','77594',
                          '11529','41760','94754','69164','92065',
                          '12737','56406','38985','53225','95319',
                          '16303','73031','44898','62163','11394',
                          '76419','85088','71409','69138','15834',
                          '80312','55615','94631','62260','28958',
                          '45323','66125','63862','20713','34007',
                          '90850','76201','38964','64231','71511',
                          '96929','12918','13882','36400','19053',
                          '20468','55602','47362','22242','41428',
                          '86211','52743','71241','33077','84330',
                          '68404','64299','68368','58858','76743',
                          '95403','72341','47462','10113','12550',
                          '87402','13512','46520','79928','35294',
                          '33647','49959','77666','80156','99309',
                          '68113','56251','42539','64479','49986',
                          '64535','37234','92301','87316','16617',
                          '87916','56120','45871','38520','65301',
                          '26931','47780','47106','71816','49631',
                          '76485','83221','23907','80363','28091',
                          '62954','20599','74443','60922','92245',
                          '22371','40931','19489','34060','68514',
                          '71861','47769','61322','11938','86512',
                          '81177','37876','63581','83231','23771',
                          '30109','30339','67705','21098','89955',
                          '88546','53918','12262','62005','96559',
                          '54599','38894','82239','21225','32301',
                          '19413','63522','61927','46945','82208',
                          '59923','17102','78707','56431','24340',
                          '40106','38433','40875','88140','74977',
                          '63809','11973','60451','40926','23814',
                          '79039','64173','26117','28550','26295',
                          '33305','86763','43231','15920','52917',
                          '41506','14522','70918','18025','54259',
                          '13209','83563','42434','19790','33717',
                          '42409','81071','44427','58611','64703',
                          '29286','34286','21461','32578','52104',
                          '34107','98350','12594','95535','63082',
                          '56413','69983','46931','91082','47130',
                          '86455','85157','76578','85588','31156',
                          '81491','97370','50228','92280','75030',
                          '68144','26770','86488','62340','29502',
                          '15137','82150','55098','20940','15050',
                          '91628','51735','95429','84573','87081',
                          '17655','18648','84780','35340','55275',
                          '55191','44657','75521','40392')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


