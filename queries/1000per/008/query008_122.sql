
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '33643','91496','22775','20436','56784','99111',
                          '33911','73479','18438','72023','32194',
                          '20604','72333','57282','89196','84505',
                          '45228','71662','33690','14783','58975',
                          '60225','26293','53493','72632','76548',
                          '59761','25970','42669','28265','95096',
                          '94102','25086','39652','82834','17978',
                          '98438','17336','98306','12180','43057',
                          '79221','96664','25108','70762','42523',
                          '75419','54148','90320','19040','30143',
                          '99042','65534','45237','39294','29146',
                          '64886','70365','50615','71328','74600',
                          '56236','56967','67344','79194','77580',
                          '49299','58665','57142','25384','32300',
                          '18452','93808','72927','98062','30882',
                          '18147','10148','80390','41122','95555',
                          '31969','77988','60830','56857','43886',
                          '73974','30333','30444','56406','30339',
                          '68710','13698','65189','17406','22907',
                          '82466','76599','20695','26450','19254',
                          '23723','42705','36096','35667','74382',
                          '76283','33786','73847','30046','86878',
                          '44319','18238','75173','49135','50530',
                          '58334','60233','20567','43152','57603',
                          '28331','53224','83131','31196','96688',
                          '72681','98037','31932','53103','68777',
                          '37629','11989','87350','47372','19632',
                          '14807','11074','20300','69336','64487',
                          '14127','60364','87158','14198','15126',
                          '72516','83585','88539','67893','12327',
                          '16878','86155','21821','48532','99051',
                          '24968','74011','40913','95346','81585',
                          '79645','73193','11056','74172','59846',
                          '13725','46908','64366','70835','35396',
                          '32860','36894','35759','59336','25126',
                          '50237','87883','44382','44837','48113',
                          '90666','37884','91281','82460','51319',
                          '35101','61499','81435','76861','85919',
                          '71435','55251','17418','57226','33928',
                          '42083','20403','82290','35612','78686',
                          '83885','94958','16632','14982','44414',
                          '22283','17517','98664','46509','26634',
                          '35948','59437','26061','67987','59956',
                          '96612','53085','24924','55770','76097',
                          '52830','96004','77697','48341','65580',
                          '42650','72357','92743','88976','29390',
                          '48680','34482','46187','15442','97099',
                          '57705','45673','85021','19207','70352',
                          '25367','39723','98127','78683','61871',
                          '20004','70935','59033','90031','59896',
                          '81831','80377','28067','75203','21505',
                          '73170','65274','93937','57134','75563',
                          '55404','43987','79914','82389','31884',
                          '38364','59794','69751','16836','36138',
                          '94932','69138','99962','35092','43132',
                          '52049','17626','82044','64072','48506',
                          '94184','77042','26118','31953','69270',
                          '79038','78112','65798','52899','75727',
                          '20226','11991','31472','54127','57288',
                          '74799','36194','43376','83970','54990',
                          '28299','32905','85026','15642','59558',
                          '69535','67336','52853','94066','71438',
                          '24500','25914','75211','39639','15401',
                          '85460','69856','92874','25614','54206',
                          '70345','57922','99518','71378','21377',
                          '31499','88774','47719','96020','41772',
                          '89942','97367','93953','19391','44747',
                          '43066','35936','40055','49938','99625',
                          '14344','45074','47465','99865','50158',
                          '87330','61024','81672','13688','19236',
                          '53652','11976','40929','12572','64373',
                          '71276','72939','31120','63181','72073',
                          '48771','10192','21489','73992','72360',
                          '72062','13196','91389','61312','80803',
                          '71549','11370','28846','57001','85770',
                          '69055','16493','53587','70308','99222',
                          '60052','99100','58878','20174','56524',
                          '72748','87264','62240','71060','76014',
                          '53250','71641','90574','34468','52164',
                          '96556','56006','88647','42291')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


