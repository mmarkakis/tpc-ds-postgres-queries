
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '84717','44016','89941','19345','50950','23366',
                          '27912','51465','85316','49103','96747',
                          '84974','16556','50905','20745','11569',
                          '96269','38605','74470','90448','71526',
                          '27230','72559','55999','14133','74834',
                          '50458','85987','51315','89294','80972',
                          '98692','85529','24436','82687','99776',
                          '20136','60524','91513','36905','44420',
                          '33221','60241','37420','85842','99686',
                          '10436','90806','52824','86165','68464',
                          '37778','10811','73076','28072','30446',
                          '34795','31261','77604','39177','90709',
                          '24540','49264','14394','44109','64591',
                          '19379','42503','41422','64446','38817',
                          '47813','47710','29639','96043','33343',
                          '55655','93618','55468','83376','80771',
                          '76199','19272','49440','86317','36933',
                          '33032','35004','31183','89522','55686',
                          '39986','51428','71694','10544','70263',
                          '88043','71175','52707','67783','98217',
                          '20063','86234','65345','57433','76920',
                          '22160','48674','20984','37639','95164',
                          '69061','59741','62824','77048','15503',
                          '80361','15755','74524','72368','49281',
                          '18074','36842','42578','69847','61498',
                          '53698','94654','54068','46818','96576',
                          '93800','55941','32876','82259','26864',
                          '91175','43936','18267','85673','70004',
                          '14208','19256','10186','81232','92543',
                          '52588','75645','20130','63923','37242',
                          '68006','31552','97218','50404','36428',
                          '73858','70140','70604','59408','54087',
                          '70306','70289','93670','67633','24568',
                          '21490','53407','56619','98292','82382',
                          '57020','93660','36060','37272','38036',
                          '92854','98343','79623','71882','91037',
                          '76083','23167','44567','61128','45277',
                          '16480','33502','92585','11917','32707',
                          '13647','48386','67866','66086','93475',
                          '49168','64886','99738','38097','60955',
                          '66468','56839','46194','64099','52918',
                          '27503','14114','46901','24265','85989',
                          '50508','78776','30103','48320','33980',
                          '97145','45361','93138','79029','49099',
                          '62753','93548','71420','89769','43153',
                          '37029','55883','74291','75605','55029',
                          '19191','62589','92732','67475','75033',
                          '17498','56659','10237','31913','58698',
                          '31742','64885','82168','25520','24445',
                          '17666','33228','96281','49560','89346',
                          '85143','24394','96410','83027','35551',
                          '56980','34167','79674','98913','69509',
                          '50487','20782','46770','44114','15687',
                          '24816','19688','58911','97303','77916',
                          '60214','45575','54835','86550','38685',
                          '76604','80488','71125','57340','57370',
                          '61984','49608','83743','92222','64102',
                          '33151','45816','12377','40532','64558',
                          '58298','38225','59705','96967','37508',
                          '76409','27474','21670','75692','66173',
                          '65940','67745','15429','16872','95635',
                          '12027','73213','28131','29402','32510',
                          '38728','45533','67499','19509','89853',
                          '97845','86901','62343','77514','82010',
                          '71770','50172','53558','21381','62780',
                          '44919','85259','55133','10408','97966',
                          '82323','31487','58351','35745','81939',
                          '43467','88209','58209','39666','51587',
                          '81444','92186','29895','84733','11032',
                          '27646','49428','97399','95010','35875',
                          '67718','61104','56352','27420','67784',
                          '52961','79375','94186','67544','72452',
                          '12230','88894','60555','62270','49885',
                          '62928','13701','24463','41109','49927',
                          '21069','12311','90652','82610','35469',
                          '33777','22535','92000','58078','53037',
                          '17990','14116','64994','73778','27071',
                          '61511','19771','67762','43211','83948',
                          '84412','51237','64197','27386','70114',
                          '26287','39943','13639','63295')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


