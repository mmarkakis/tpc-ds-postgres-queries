
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '42099','26227','69208','93012','52865','16896',
                          '35706','43003','78489','75581','48110',
                          '96291','65453','49099','46210','56886',
                          '84421','58819','24554','25685','88666',
                          '97959','51780','88107','92995','12248',
                          '88673','72667','96675','66888','43595',
                          '24177','94170','13291','94417','68485',
                          '33493','33072','48577','53063','60604',
                          '80061','42697','71952','21383','30475',
                          '47373','18520','73552','69661','67264',
                          '70304','13245','16423','90538','11384',
                          '89131','66857','71920','55190','34117',
                          '28902','37766','15089','66609','63860',
                          '87118','25347','31317','18330','69654',
                          '41930','38361','45991','96511','25738',
                          '77480','45888','74710','24221','81394',
                          '42106','37873','25493','95966','74110',
                          '72037','75232','97369','79747','87098',
                          '88068','51656','44598','13375','36731',
                          '25755','17273','86704','24514','73954',
                          '29749','34001','52338','20894','39173',
                          '57159','66482','74025','76497','50720',
                          '22649','86610','26612','26477','85027',
                          '34097','87519','24252','42426','44637',
                          '19554','10222','67581','30193','36993',
                          '99861','96413','30495','85291','49521',
                          '87280','95792','96556','38987','42449',
                          '94840','48578','94168','21911','87346',
                          '75794','95461','12806','89548','23472',
                          '43894','43757','77430','11163','87293',
                          '44747','25623','17383','62296','22220',
                          '12623','61294','98441','68842','72002',
                          '35641','49701','57748','83435','91251',
                          '25667','60777','19792','36411','92969',
                          '80149','96543','30222','48988','16891',
                          '33067','53285','24517','87440','93809',
                          '63500','26770','80709','89872','17136',
                          '21553','18205','16146','41324','48256',
                          '19721','31664','80193','86235','27347',
                          '15256','69807','99440','20544','24099',
                          '59537','71695','74201','30839','63571',
                          '22122','33686','58250','40005','54151',
                          '71391','77222','64082','35274','89195',
                          '77669','21704','46575','78149','18943',
                          '16837','56937','43100','94139','76300',
                          '62921','53003','26860','73876','33317',
                          '49096','57865','82126','50782','72486',
                          '74863','65176','52506','58072','42442',
                          '29569','54200','44763','40594','96661',
                          '42663','59605','27358','39422','91550',
                          '78719','13946','19513','67962','70801',
                          '12460','89013','12778','65096','42195',
                          '84945','13851','48120','52273','36873',
                          '26278','59641','23378','90796','77445',
                          '31493','21960','71028','66447','82146',
                          '99070','19035','50299','21650','53277',
                          '57917','45793','40376','13536','40045',
                          '64533','53903','72906','38829','60802',
                          '60149','20400','71181','70400','94053',
                          '69078','61413','22974','48569','80216',
                          '71729','12341','13949','50918','96336',
                          '93954','13744','81077','15461','58725',
                          '18318','12528','59043','42865','82077',
                          '12256','53658','67735','42685','79599',
                          '81512','79285','55551','79271','36422',
                          '54882','82248','29080','85206','84615',
                          '37370','99766','41281','88873','56578',
                          '33799','90865','49868','52812','52869',
                          '49272','43176','64382','17053','82387',
                          '11360','85109','11039','58259','21762',
                          '17954','30020','42669','59198','47948',
                          '85454','88242','29287','84433','62060',
                          '12188','78151','55972','82984','97546',
                          '82054','57519','77125','83802','87298',
                          '59929','24832','76772','49694','37650',
                          '53842','67124','31551','95186','70658',
                          '26422','95182','99415','70486','86449',
                          '17576','61395','53237','65017','97237',
                          '31723','79475','70873','40834','99035',
                          '23682','25137','95412','59225')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


