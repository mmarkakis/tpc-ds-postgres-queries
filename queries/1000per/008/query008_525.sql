
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '98967','48424','58632','55613','37229','71026',
                          '10793','42697','33197','70297','45354',
                          '41602','65391','79267','60024','86165',
                          '44191','81521','36766','42906','57345',
                          '94543','47339','81051','59133','48969',
                          '83885','35644','63777','74092','12488',
                          '59596','87287','46596','36081','30950',
                          '48548','31218','25618','21743','53856',
                          '52736','99115','95792','86505','60907',
                          '14496','78405','92789','77819','94417',
                          '28851','47520','13898','83679','73664',
                          '59610','20839','12781','11853','66208',
                          '65564','51521','11290','35954','20307',
                          '54097','94866','86978','13829','87201',
                          '18802','38064','41306','84939','35123',
                          '41778','19090','92635','69814','70434',
                          '16729','46800','63874','83233','66329',
                          '22156','81101','90937','66673','14318',
                          '85073','23903','80276','48246','85028',
                          '53067','63577','28155','60234','14127',
                          '51430','74143','84124','29214','15041',
                          '34874','83295','90055','32087','52094',
                          '19351','77068','63002','39857','18550',
                          '57168','60218','81575','90815','97974',
                          '30036','79308','57305','97629','21624',
                          '89056','75004','67833','10443','56271',
                          '73135','36357','59004','44527','57407',
                          '19585','18614','75624','77954','52991',
                          '71996','98012','58305','78029','68873',
                          '87192','70152','59169','21356','33341',
                          '22669','77527','66227','94087','29875',
                          '30727','89572','95142','39195','50282',
                          '56625','34712','62440','79616','78290',
                          '86283','63799','11826','35058','65323',
                          '70023','82216','16086','74127','49167',
                          '23004','66496','40717','93831','68860',
                          '37863','25485','40283','96672','30329',
                          '26398','98714','80308','78533','12135',
                          '43128','56954','41417','68302','23321',
                          '38837','62458','36355','30889','16666',
                          '54413','42700','91224','90425','57223',
                          '93173','36701','97646','95181','36338',
                          '24561','90816','79733','90056','47030',
                          '71327','46507','65368','76440','48307',
                          '90420','11865','24340','56244','56324',
                          '80250','32939','84191','99434','29602',
                          '29972','99508','47586','10160','52847',
                          '52977','81576','96582','27933','68381',
                          '63227','43298','60298','61488','17127',
                          '51467','42690','78563','85371','10962',
                          '94597','11845','28557','87366','23694',
                          '89160','96371','44367','61607','54466',
                          '15882','91461','45021','65683','25404',
                          '17395','48919','47783','68325','93780',
                          '50156','95677','95172','61557','37146',
                          '30742','69042','73156','47377','94613',
                          '79780','26310','86110','21292','31907',
                          '45160','71230','85860','58301','58683',
                          '14706','75830','50106','38184','46076',
                          '85721','83088','43932','49903','16647',
                          '58428','58722','72178','62554','95034',
                          '47842','47966','54192','84227','38367',
                          '45817','11017','41895','36522','76838',
                          '59527','83176','27179','41642','32009',
                          '53925','41715','11935','64539','95066',
                          '73560','37649','54212','24601','63970',
                          '89810','10666','21370','77337','46607',
                          '47984','68980','13104','23201','54187',
                          '16341','95539','17414','32950','87308',
                          '51914','65737','21827','12909','82716',
                          '64537','79667','23631','61929','72397',
                          '24984','99227','31212','45962','84381',
                          '96089','31364','80195','77013','50443',
                          '64241','19701','71315','13237','74052',
                          '49570','74736','61619','49751','91704',
                          '51801','77545','71930','47893','59143',
                          '60965','30366','67490','29188','58458',
                          '68104','48053','44977','24608','71320',
                          '40967','60663','80626','14982','54653',
                          '30709','64121','70802','88872')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


