
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '68037','19830','65975','82771','77426','38147',
                          '78832','40110','33454','31538','44265',
                          '56998','76257','72894','57717','35043',
                          '37908','63677','85345','81205','73715',
                          '58908','98355','86973','58757','20339',
                          '60560','19066','96823','26933','23988',
                          '60727','81845','51012','41908','21786',
                          '37720','45932','35952','62829','24131',
                          '30738','23007','88316','49198','45366',
                          '88577','29963','17727','82956','31898',
                          '58601','44416','15526','68496','31004',
                          '55692','65061','97022','53217','76256',
                          '88042','52628','86623','35110','55165',
                          '34234','90304','83930','97031','26401',
                          '90949','96248','24407','20247','48799',
                          '71744','93576','86243','53411','98903',
                          '26975','69057','41605','96030','72642',
                          '74762','12898','76024','78395','96475',
                          '85400','43822','13304','51561','23026',
                          '40122','53428','24283','74500','94603',
                          '54661','73258','73652','21919','58176',
                          '71670','90812','28635','74625','56991',
                          '62989','41982','87799','51853','94512',
                          '87929','10669','73300','92788','94258',
                          '48117','51157','37408','49413','47107',
                          '11572','25383','27636','90037','41800',
                          '72888','98411','19523','12516','19939',
                          '19226','66022','32428','74128','64948',
                          '55699','99056','73800','95097','93597',
                          '27960','59730','58269','62325','77985',
                          '20365','32045','18877','40942','74301',
                          '24618','90409','53415','18981','80896',
                          '20155','25554','54403','38342','26399',
                          '57620','71311','97945','82065','78672',
                          '38040','38001','88250','78006','90863',
                          '13204','67598','88081','36284','82634',
                          '20178','15230','46750','37539','99788',
                          '63245','84685','78441','15011','56778',
                          '79692','18224','51485','58195','83842',
                          '94407','56528','59556','32846','70235',
                          '82631','51434','87524','77151','61864',
                          '35926','24533','14422','61301','67547',
                          '93062','97927','19192','98470','92236',
                          '55352','10163','51761','34822','15920',
                          '56366','88739','87732','53896','61168',
                          '17541','74555','73877','21541','50376',
                          '90919','70568','21268','32021','72192',
                          '31256','78393','13373','68744','66317',
                          '50366','64429','34801','84212','52889',
                          '61905','81634','28067','14334','55146',
                          '84445','11992','65501','80767','68898',
                          '33626','67457','34488','15070','31163',
                          '20229','35061','54540','42052','95774',
                          '92764','45952','94398','46367','79945',
                          '32496','63453','16326','47305','41178',
                          '37655','78572','95162','26065','52381',
                          '27990','63250','58535','74393','85315',
                          '60659','72977','28842','44378','66407',
                          '29624','84185','70747','35601','25010',
                          '79436','52484','17585','76370','85426',
                          '98893','41226','74224','70878','59417',
                          '50721','20700','97916','77275','67027',
                          '20514','19264','71032','56334','48338',
                          '30330','44044','80227','10589','55734',
                          '88160','28471','70631','29381','69705',
                          '77785','93674','45948','19382','32010',
                          '10665','32388','64051','21016','10473',
                          '54224','21841','93862','62785','94105',
                          '10144','79670','12755','12704','21275',
                          '90478','49945','46015','25127','51529',
                          '25496','55315','70384','51812','63528',
                          '56006','83264','16380','33855','16821',
                          '31594','68760','34237','53332','38992',
                          '85501','73790','28136','83724','20828',
                          '45236','42155','76082','16558','17062',
                          '21662','62094','36187','43916','57114',
                          '26858','39594','55757','40522','67336',
                          '32757','81190','61545','84728','67292',
                          '80453','31681','42512','62672','17441',
                          '91316','81695','57088','89992')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


