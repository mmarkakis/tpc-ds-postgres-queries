
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '92617','49944','63881','80173','66099','46265',
                          '71460','87489','84531','61339','36966',
                          '62033','64981','63565','16326','27503',
                          '87482','88224','67294','36938','96166',
                          '76309','20146','62708','34571','29903',
                          '43286','34940','54814','25975','72320',
                          '28241','92292','13627','41811','96829',
                          '95618','64042','75409','41123','90327',
                          '10175','99302','72240','99223','23985',
                          '91584','10508','91786','63476','98635',
                          '92855','53818','51584','95270','54579',
                          '75689','29228','96617','19168','76010',
                          '34914','85493','82831','78586','76576',
                          '78803','92343','95172','72470','88058',
                          '20865','10300','67538','24874','97523',
                          '79568','72778','73966','14035','51310',
                          '65463','95429','36436','28045','85717',
                          '95930','84173','74941','23047','54121',
                          '90152','13744','85454','14907','37196',
                          '48530','63605','11083','34818','71050',
                          '86596','67106','40833','45735','53498',
                          '32747','70299','39084','79321','86718',
                          '53883','29841','84873','19908','26482',
                          '74613','70966','36539','26721','76964',
                          '77174','60284','24677','39274','87422',
                          '56312','85409','44635','79372','25829',
                          '66458','41979','47572','44607','59092',
                          '83164','18797','68716','82924','58528',
                          '74433','91051','55399','78159','69465',
                          '41630','43461','42417','91192','75720',
                          '81498','48739','58461','22833','45000',
                          '27116','26543','84499','74031','48909',
                          '11087','89230','30102','73921','31678',
                          '86885','20024','25131','82556','10055',
                          '30138','84363','66144','95417','19610',
                          '47915','40102','33495','17502','52830',
                          '53521','28007','41987','78473','20754',
                          '24083','68354','12320','22671','24587',
                          '10095','91327','93848','41286','44651',
                          '12641','70339','50281','79696','41544',
                          '30694','14988','76032','96979','42659',
                          '73090','75215','22466','76122','14545',
                          '55709','76927','92574','55644','34222',
                          '54234','47512','19745','68682','57827',
                          '97418','48556','97417','48224','17113',
                          '86805','95733','29240','42175','26576',
                          '40882','96914','57322','81260','35979',
                          '74919','45794','78898','45120','78421',
                          '84960','12498','68433','80456','86986',
                          '46082','75045','52734','29056','18098',
                          '56972','45462','91231','51914','11091',
                          '64913','57315','88694','18802','85860',
                          '35363','58983','36069','39676','95835',
                          '80490','19357','41466','19386','93453',
                          '33868','60124','58414','19967','97797',
                          '42121','18978','43597','17170','54535',
                          '27382','86881','89051','43363','74256',
                          '23529','69726','72431','14234','99131',
                          '81734','66747','20467','83137','94433',
                          '68214','42213','14768','67701','41243',
                          '97278','67385','84120','10739','47991',
                          '81038','13655','67757','96491','87653',
                          '99031','30433','19522','71271','96775',
                          '21431','28680','77396','58395','24348',
                          '56625','48113','78763','58250','61864',
                          '78795','49605','81303','27449','96083',
                          '29478','82049','39175','42920','18337',
                          '43323','57673','99122','54885','77478',
                          '12001','31294','11697','50883','21541',
                          '10437','79914','97332','56112','44841',
                          '52033','71294','90751','60039','73190',
                          '28932','57124','96210','28319','71778',
                          '42448','93041','58125','98609','92088',
                          '37351','45859','32065','31296','44606',
                          '80886','82061','44523','47824','33026',
                          '60132','41875','37561','16972','21764',
                          '47931','87819','12726','78458','54281',
                          '23803','87146','87091','35457','65912',
                          '94027','29660','88280','60316','30769',
                          '72480','19820','40606','66221')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


