
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '19554','72855','77747','16208','61152','41017',
                          '26891','37377','38540','39967','97778',
                          '85319','82992','29392','76171','31201',
                          '44338','43420','71420','66027','49937',
                          '48792','62293','26279','70323','70348',
                          '26493','13549','23827','77875','84917',
                          '76195','91011','53396','71621','91119',
                          '57865','57341','71526','45446','30570',
                          '98844','94413','97454','54452','65418',
                          '23348','80923','29471','48666','70777',
                          '88338','37772','89211','89361','76363',
                          '91308','49424','94745','23790','64777',
                          '93025','62053','68527','76591','83130',
                          '19381','99837','41636','94314','64647',
                          '57985','59762','60022','13768','22234',
                          '81658','89289','63032','34431','53060',
                          '70875','79162','10412','50390','45664',
                          '18640','52272','96838','50408','17136',
                          '31131','58919','46441','96624','90989',
                          '77886','78107','19266','39992','67495',
                          '82719','81509','92825','75455','44462',
                          '16981','24533','26144','95917','44459',
                          '12272','94538','77639','57378','98862',
                          '72215','98648','59203','92950','18496',
                          '32916','58516','20035','77130','86939',
                          '47691','95656','38213','73226','28117',
                          '34237','81331','18952','62349','68803',
                          '64634','57589','22032','38010','48187',
                          '68439','10938','76619','24074','88259',
                          '48613','53180','59106','21123','44365',
                          '30781','30574','86349','50406','20342',
                          '79642','66130','69320','93495','47554',
                          '24532','23130','47710','39899','97985',
                          '87788','58007','83419','30259','18001',
                          '50615','13770','85585','67409','56555',
                          '84919','14244','70058','71209','64364',
                          '17696','80302','50279','55226','55876',
                          '51693','37989','91781','80819','15036',
                          '85560','38255','22892','90636','69326',
                          '36271','86818','95448','88241','17246',
                          '53187','58463','96544','52197','80768',
                          '84499','39891','39573','94535','56797',
                          '73362','10456','83607','74175','75416',
                          '45621','79118','73739','29060','88682',
                          '24751','45832','14122','13182','16041',
                          '32634','53595','88829','45004','88632',
                          '71520','87995','94732','12201','27747',
                          '14162','73113','43978','14534','17915',
                          '57924','72803','80776','58601','92231',
                          '67942','67197','36631','77106','51120',
                          '36648','41115','12261','45003','18399',
                          '35981','24122','50934','82557','89530',
                          '87966','90907','80163','17716','88608',
                          '22213','78421','51741','72729','98950',
                          '35053','39206','92887','34882','13115',
                          '50533','37751','15268','84611','81901',
                          '47505','15262','28822','66683','14561',
                          '59244','57030','13281','86492','76621',
                          '88966','35125','27504','14910','30340',
                          '80309','19665','12811','54126','23861',
                          '13214','41930','40426','69758','47103',
                          '40295','73088','66775','66297','88226',
                          '90387','90663','64020','14761','29092',
                          '79871','75198','99238','71573','64598',
                          '15725','26062','22629','55448','17431',
                          '47515','10711','44206','37277','70286',
                          '94393','11077','50830','26283','65623',
                          '59993','18482','99541','18540','21382',
                          '10652','58030','97894','42094','83242',
                          '97281','28354','46065','10340','87500',
                          '63109','15878','12405','25968','38734',
                          '69967','95413','55795','96917','19226',
                          '98281','30139','14307','90690','41734',
                          '94455','22891','94961','66137','87915',
                          '47865','89926','99639','24578','76992',
                          '82797','79006','20963','32418','17811',
                          '39650','63418','70368','43730','50297',
                          '57247','87328','91859','31320','88681',
                          '55947','30862','42652','85354','99863',
                          '32377','25783','25583','65139')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


