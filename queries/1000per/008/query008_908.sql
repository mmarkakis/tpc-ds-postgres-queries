
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '59834','36695','30047','77068','83625','69083',
                          '26709','23103','17493','90625','37733',
                          '39401','51596','62968','18682','92671',
                          '95054','71918','89257','91120','69340',
                          '72490','34106','83097','59803','72032',
                          '97342','38933','58252','25447','12381',
                          '77218','19488','96589','45141','43105',
                          '97947','18236','20425','61534','95192',
                          '87017','37504','69112','86771','87706',
                          '24672','45738','44354','88292','24951',
                          '75496','70688','69286','24837','56421',
                          '21745','26628','69802','61225','37253',
                          '55175','40953','49269','68261','89382',
                          '64848','61029','17314','66365','78129',
                          '60585','19974','57863','55735','41580',
                          '88925','60438','96669','13931','74761',
                          '97658','34037','19713','49824','59475',
                          '54441','48888','21563','92860','37818',
                          '13266','89022','56337','42070','88433',
                          '42484','79006','33469','38704','43755',
                          '64407','27719','46639','65746','32600',
                          '81867','84377','26418','86100','99282',
                          '67068','26945','29948','75782','67432',
                          '35686','46077','39501','33742','63276',
                          '67134','90177','59655','52781','66448',
                          '71349','29732','10412','45457','83355',
                          '14019','16483','21432','94139','54517',
                          '50860','99029','87154','53135','54943',
                          '19904','72988','96411','28077','94711',
                          '83315','12593','61624','16516','20031',
                          '19034','51702','93875','40644','64472',
                          '65092','39265','10485','38428','28356',
                          '68966','51489','74503','34689','78781',
                          '20423','15170','18588','15609','14273',
                          '37883','47951','14654','45606','93416',
                          '96246','60071','28223','76203','51774',
                          '87180','52845','86055','16926','50302',
                          '66560','22106','18678','65966','76851',
                          '47559','32974','45464','37856','23654',
                          '29792','52406','19595','85811','44509',
                          '63573','43303','53770','82575','99514',
                          '56030','75400','30700','36163','32900',
                          '61846','44651','43302','88500','44780',
                          '11933','85825','79391','13967','49262',
                          '64900','14489','77598','49500','81467',
                          '85578','14026','35965','50381','13891',
                          '20618','28170','43272','19416','17706',
                          '74450','15734','61883','69557','34998',
                          '54453','16752','72763','86348','38637',
                          '86370','74547','21481','76482','77509',
                          '96468','76331','12675','35069','77038',
                          '95104','86610','95994','60805','63067',
                          '49917','82796','46859','48994','35321',
                          '72934','26445','39090','48981','60059',
                          '26198','46631','14751','19681','69434',
                          '26035','19782','77842','74759','16205',
                          '53012','51740','16112','55630','40917',
                          '30363','38256','38140','71049','86653',
                          '56110','15100','32376','63008','53022',
                          '85305','44554','30612','87130','77142',
                          '60938','40646','57650','14039','75636',
                          '99664','36020','60284','43393','59764',
                          '11401','64140','43577','48560','85235',
                          '67115','68518','66841','49408','48368',
                          '98285','95043','90715','53175','37657',
                          '33865','46955','57035','40787','18967',
                          '56448','13461','81347','67955','49816',
                          '98432','73899','69669','13715','52285',
                          '94521','48238','32479','40557','40867',
                          '90696','76950','33959','46756','37228',
                          '36339','35545','45013','85023','94784',
                          '65647','44051','75187','36526','40174',
                          '92482','83300','89027','15586','90416',
                          '22097','26132','78296','12649','65570',
                          '94731','62390','39158','64212','97109',
                          '91192','42825','26473','64432','38265',
                          '56148','24175','14835','82779','90562',
                          '70649','53912','89068','20453','21776',
                          '84442','92024','45550','63852','73775',
                          '71249','57687','97775','57969')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


