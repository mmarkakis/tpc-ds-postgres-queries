
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '31763','61465','74340','26280','40819','11138',
                          '14559','26796','35793','46120','51932',
                          '51532','68157','97047','93691','55655',
                          '64425','74883','20885','64961','70928',
                          '67962','62544','10473','25166','40671',
                          '87874','37470','48765','13611','31183',
                          '72778','81269','77804','35843','69318',
                          '71848','87615','74357','70778','86931',
                          '46967','63074','11605','53681','73624',
                          '60036','35743','17170','32720','84281',
                          '77716','63764','12699','92731','35543',
                          '30288','29574','34252','82261','85757',
                          '24040','77363','88674','10128','98164',
                          '97957','67376','67958','76271','18361',
                          '25534','62851','87635','58668','54682',
                          '90291','35524','55149','27817','82635',
                          '49671','26741','56849','39271','40783',
                          '18215','79667','33787','92640','63292',
                          '56301','76709','71318','77922','51097',
                          '17745','86569','51649','41411','40847',
                          '78806','10878','92357','93162','73244',
                          '95891','27571','50739','72580','53512',
                          '26972','83947','96682','98253','66529',
                          '35565','96968','13796','36410','85055',
                          '90677','89336','28831','41327','86518',
                          '24151','12371','46086','60832','84342',
                          '41908','43898','13000','54124','72950',
                          '88713','88911','87234','87872','12953',
                          '18315','11827','10189','41743','19501',
                          '96183','44072','61811','81318','95060',
                          '89966','15994','83124','25557','80894',
                          '85774','62093','71051','70274','30590',
                          '46618','39514','77712','41480','56652',
                          '66001','82842','25749','63249','92821',
                          '81126','46016','86586','75772','25219',
                          '83159','97200','93452','90547','44107',
                          '50029','24818','40386','74584','19464',
                          '87171','40325','98031','35285','68364',
                          '33609','49366','55244','17020','45463',
                          '57425','59015','66631','97752','92544',
                          '61205','69471','25122','77215','87687',
                          '75188','46356','29636','66693','31068',
                          '66581','71614','99519','43878','67040',
                          '42379','91350','33322','79715','90165',
                          '38820','41271','20449','69603','87240',
                          '90953','83985','74721','89185','75050',
                          '16662','64459','62194','90825','83518',
                          '45210','51377','36128','60879','50888',
                          '22078','67263','85795','87728','60723',
                          '66883','34779','35564','28940','40874',
                          '96596','69012','82555','10127','81030',
                          '38070','39866','45859','89662','37348',
                          '87932','39521','32963','83938','34822',
                          '41794','19374','10149','70181','99521',
                          '44754','48766','45254','38219','36719',
                          '56357','49804','12621','11088','71937',
                          '44482','78210','50993','69730','41293',
                          '76184','20223','98145','86302','65496',
                          '68096','51808','66424','76992','65185',
                          '87590','92299','67854','94467','59112',
                          '70992','26256','81144','95146','42414',
                          '21280','37454','59841','75909','68069',
                          '21981','79161','87270','69683','75498',
                          '43235','14828','66184','66398','95462',
                          '61020','73947','29118','70857','26783',
                          '55040','74555','96113','64920','46712',
                          '28943','11894','17195','39637','83557',
                          '88529','88473','15244','30840','44945',
                          '58860','89416','13633','30285','76953',
                          '56238','13299','26790','22344','66029',
                          '25989','32152','71707','40427','73185',
                          '47210','76290','58410','33674','40538',
                          '30965','66983','46410','64231','89212',
                          '92971','16271','63716','56682','59477',
                          '74420','41298','86781','28555','49752',
                          '58995','29975','64443','51365','12547',
                          '50754','30634','13966','32708','42739',
                          '28067','71556','48601','58606','61355',
                          '82395','62168','88390','48839','83075',
                          '77126','40086','63333','49938')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


