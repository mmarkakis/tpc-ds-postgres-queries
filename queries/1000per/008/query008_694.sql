
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '98540','11941','34426','21535','50694','53017',
                          '93167','70205','11301','73413','86464',
                          '53871','45615','75139','72993','17712',
                          '72156','82250','24141','86835','98526',
                          '34765','56160','58368','59885','94646',
                          '44581','36123','24829','77667','72999',
                          '20618','32720','37839','80240','15794',
                          '46397','48980','33590','95868','29306',
                          '19827','29510','19296','37807','69131',
                          '42391','10499','13918','56242','24402',
                          '72595','84469','89893','27766','96248',
                          '61322','24132','47791','13636','14947',
                          '74065','43572','90853','71816','40817',
                          '72449','11711','68475','97575','93783',
                          '55026','81408','65876','25573','92089',
                          '64703','43096','71083','79002','20076',
                          '32862','74871','71393','94559','96321',
                          '96219','50524','88311','13489','17052',
                          '88563','14728','62735','57601','32345',
                          '45517','45248','55175','91768','57016',
                          '42824','74654','10964','59818','43770',
                          '97903','81313','40967','66424','46194',
                          '31255','94395','81505','73561','79468',
                          '46964','67161','58364','65012','53149',
                          '51738','84782','42060','48818','50532',
                          '30949','18890','42164','53967','45765',
                          '15434','77148','56637','87763','32021',
                          '80840','42648','43768','68580','86858',
                          '60005','95348','17923','49562','46489',
                          '88214','87009','45994','95390','21671',
                          '29606','23975','43475','78939','10292',
                          '17562','34442','69603','86938','89804',
                          '19171','84660','61196','90656','14810',
                          '57045','76963','31418','79772','71471',
                          '62742','63323','73737','73979','35880',
                          '77900','60249','97172','39583','99836',
                          '87664','37423','32459','41636','92502',
                          '60230','24494','38538','56894','63206',
                          '26443','40179','55271','46749','88599',
                          '62341','55147','39681','40335','33881',
                          '85601','47617','48877','50401','27775',
                          '34386','52886','35430','56170','24468',
                          '51689','56285','94960','89530','29696',
                          '35732','95073','33381','80574','17877',
                          '50067','48075','54876','57814','41978',
                          '44618','92276','16707','32563','36095',
                          '25379','99797','42334','36777','42408',
                          '28393','63527','48899','27519','78374',
                          '64434','56017','53551','21674','97316',
                          '74226','27058','83234','89402','85137',
                          '69652','15579','77125','69309','88944',
                          '73972','78493','98119','18522','69478',
                          '73356','48425','15410','95922','72079',
                          '49167','40681','46994','37040','95117',
                          '32051','36578','58820','30974','30084',
                          '70878','72544','51397','77865','38267',
                          '27107','14031','53630','56585','59456',
                          '41005','79200','70033','89106','32957',
                          '68656','13126','76685','42359','16777',
                          '89853','24279','50648','94097','60237',
                          '55964','12115','10865','97939','30438',
                          '80928','15852','27434','72317','49450',
                          '98858','84466','69694','75453','12612',
                          '49241','12091','47084','21521','56495',
                          '94322','42909','74213','24162','83730',
                          '27869','82787','50227','42360','92409',
                          '75807','15037','63029','71032','33832',
                          '47442','72790','89711','17056','48134',
                          '46501','67351','49826','35966','37238',
                          '71801','89671','82580','83065','91813',
                          '68058','93660','47822','97007','11276',
                          '43413','16610','85046','15392','76370',
                          '55963','91400','25495','24805','93605',
                          '35778','44564','99025','73515','17397',
                          '54543','77498','81441','70930','60435',
                          '83037','86094','41725','11449','57129',
                          '56092','44475','64342','44812','85228',
                          '61946','20131','15266','33863','66633',
                          '72143','92704','97065','45846','95046',
                          '22104','69295','58108','55862')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


