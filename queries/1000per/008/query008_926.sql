
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '74751','31242','57593','23577','24126','70554',
                          '31985','39806','21845','25942','62670',
                          '25026','11756','18241','19944','35863',
                          '98273','84501','99332','46825','54823',
                          '68934','51310','73106','36315','60589',
                          '41461','58444','70023','88626','74674',
                          '47235','30339','89650','86136','11995',
                          '20784','85902','45623','36858','79168',
                          '66718','52631','64860','29338','97438',
                          '33168','95951','89496','26911','63368',
                          '84841','49101','83928','50657','95159',
                          '23443','21478','24695','77067','17948',
                          '15522','26347','87323','89567','61962',
                          '48081','24909','57724','11155','60273',
                          '44230','13729','13829','28135','31799',
                          '82444','97153','36928','75390','30143',
                          '98426','24472','98352','78589','54238',
                          '21205','69979','31666','40378','89827',
                          '97223','52310','98638','62442','98512',
                          '31126','51523','21159','95683','38772',
                          '43920','56558','58742','67754','45937',
                          '91791','81496','63401','48530','73629',
                          '79408','81672','53834','77302','33906',
                          '71713','57751','93663','50347','89397',
                          '21107','44979','11175','26189','17824',
                          '45530','17529','69689','11703','33401',
                          '38298','89078','20572','53216','72734',
                          '33851','29925','65549','67189','25053',
                          '82453','23208','68000','30933','52289',
                          '93100','24304','81684','15803','51496',
                          '41553','66198','27918','39734','80227',
                          '66835','38530','74270','53121','33256',
                          '36250','18729','19868','65857','89437',
                          '30670','63258','36731','71293','52703',
                          '88489','83821','38490','58975','24902',
                          '85746','25478','14868','98098','13342',
                          '66085','37731','90947','98767','17254',
                          '14259','60853','81034','13698','40876',
                          '71739','32405','35988','77794','20636',
                          '84850','92432','97022','93294','26275',
                          '77024','20796','35942','99223','44807',
                          '80455','70690','69819','56789','92940',
                          '10979','56673','32260','82546','19912',
                          '51079','85235','41812','46380','80392',
                          '51268','86187','30922','37170','47641',
                          '64405','30572','36395','54411','17637',
                          '13720','17841','23612','90587','86587',
                          '85043','15101','97714','15350','64854',
                          '49081','47053','87871','66532','98921',
                          '92804','89053','69116','31181','17558',
                          '78762','26919','16279','45911','69922',
                          '81061','21226','22311','85828','81477',
                          '42760','78427','59233','34319','89663',
                          '73723','96809','34543','16647','40715',
                          '77888','30193','92883','51552','41965',
                          '72177','28791','81320','91595','59148',
                          '12083','11887','28872','20010','23572',
                          '46952','12463','73575','45093','61149',
                          '76056','72970','30818','34323','50583',
                          '68418','87686','42844','94469','83611',
                          '19614','71775','20641','62803','87024',
                          '50018','85748','47408','24093','89547',
                          '52829','58155','40607','71971','98463',
                          '92989','40212','94027','97851','72370',
                          '93451','44705','47456','99510','49748',
                          '63650','52315','48192','30692','56624',
                          '35127','63731','89431','59830','42051',
                          '48402','17054','86306','53913','41062',
                          '60626','51209','48403','36391','20338',
                          '15336','12302','70870','47469','52793',
                          '59001','37163','96012','22203','78217',
                          '61337','42475','26285','25583','73596',
                          '27649','94171','68208','96057','30937',
                          '10782','95067','61329','33209','10305',
                          '65682','62994','60607','57631','10901',
                          '39189','43494','93827','71847','88696',
                          '85761','12412','40450','12954','40714',
                          '52048','86151','88130','53467','12724',
                          '61251','89500','68305','16034','53361',
                          '35725','92766','22492','61648')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


