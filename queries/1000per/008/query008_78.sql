
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '45657','51615','27014','67551','41401','45000',
                          '16495','18385','36586','24351','31135',
                          '45050','85888','85628','27528','55002',
                          '86191','62094','75043','64886','46503',
                          '11156','25891','91228','41094','74145',
                          '12608','11867','85266','57828','95368',
                          '41906','15823','51666','41908','13439',
                          '81589','40322','60758','74483','29748',
                          '61452','89902','60546','57170','88223',
                          '50969','88370','93184','48321','58725',
                          '56404','17541','94088','19375','50052',
                          '76961','76339','96221','20410','20793',
                          '20586','88648','70372','12480','45644',
                          '52910','60956','23543','69191','55397',
                          '80952','40434','52286','43864','76714',
                          '62415','16177','14469','17565','70749',
                          '27317','41383','20325','37642','42969',
                          '21197','18181','15514','45534','75335',
                          '64441','31014','77874','96264','23285',
                          '71019','35859','23759','67713','17127',
                          '47549','23755','31577','17161','69969',
                          '31375','13875','30869','34160','90295',
                          '52051','31446','23555','12621','79823',
                          '72673','48671','81528','60746','38106',
                          '95837','40790','39821','52478','48879',
                          '44436','24268','65757','69510','16134',
                          '32636','97497','95555','77025','18994',
                          '29112','79552','54210','68109','94880',
                          '50911','58760','48654','97712','62805',
                          '73076','85147','21631','38033','25849',
                          '25020','93865','27333','15829','92303',
                          '86622','68919','32008','65161','14184',
                          '46642','54598','45545','73363','88988',
                          '33775','74810','87174','71259','65377',
                          '83496','72456','66667','79176','72124',
                          '26821','56568','46884','71665','99204',
                          '30029','68769','47385','85043','22607',
                          '95043','30229','50467','83447','54805',
                          '69459','92575','51432','75646','34958',
                          '78351','16719','43701','54437','76154',
                          '72560','24120','38557','55424','98896',
                          '89287','59762','93172','63539','67318',
                          '39779','90530','67635','75683','34779',
                          '29120','26917','28772','13707','29140',
                          '23001','34938','50312','35834','23008',
                          '22438','91797','32047','80881','34183',
                          '54054','83829','63883','17939','62398',
                          '38674','96253','21080','35790','74994',
                          '64228','10735','63891','76983','90260',
                          '76537','43696','75792','53935','43986',
                          '32544','78060','36907','18806','22889',
                          '34579','40501','53258','75019','19119',
                          '21243','14620','22349','22207','65733',
                          '83788','11632','41585','87455','78651',
                          '61305','31850','23176','94079','74726',
                          '54997','82023','15028','15652','54321',
                          '26679','61286','30696','73531','33989',
                          '85373','40624','45439','90479','47161',
                          '47353','91126','66808','21270','57284',
                          '80094','19864','56480','75347','85848',
                          '33930','18400','33763','53105','53817',
                          '66620','68975','91962','20620','44946',
                          '67789','18073','17304','10199','31689',
                          '21708','87835','94254','66087','29397',
                          '84057','36978','43524','61941','16899',
                          '89513','88243','19827','31619','82755',
                          '66404','43853','55428','23424','52003',
                          '75918','76297','97126','48497','16315',
                          '31706','65446','31808','79677','12682',
                          '22289','47093','38490','37224','62476',
                          '63881','35826','52825','43361','27314',
                          '15863','22304','25669','89083','82955',
                          '90167','99188','44964','65052','76693',
                          '69119','86766','52332','60478','29307',
                          '29885','65997','95170','55672','73579',
                          '64830','61657','42421','36552','46448',
                          '74697','87987','40327','43652','90452',
                          '48903','71807','25727','91059','77958',
                          '61061','92838','44415','94004','95654',
                          '61548','61521','19485','53182')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


