
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '74413','91536','68272','66088','80817','84031',
                          '65645','30479','41801','85316','32535',
                          '50020','58281','22402','50390','27785',
                          '46213','24465','97535','71461','46382',
                          '45845','80224','64282','49612','25857',
                          '73134','14474','28795','47807','78474',
                          '33788','99692','41497','21310','11608',
                          '63166','86217','26399','15764','90936',
                          '11306','40848','83671','59855','99183',
                          '39765','14305','61007','14395','96343',
                          '52743','46376','58157','76341','34306',
                          '62912','95384','23181','48825','65546',
                          '52191','44749','14111','67119','64993',
                          '55039','36363','23220','98415','26958',
                          '49677','93345','58664','74162','13220',
                          '22612','72366','87905','36244','83377',
                          '65578','39045','85102','69609','35578',
                          '74692','64026','94683','54508','18248',
                          '19400','61043','80272','66153','97459',
                          '79818','53006','95048','40732','72726',
                          '72003','31605','78408','38382','73373',
                          '56433','45432','56264','33470','84369',
                          '94574','80567','27370','70791','66964',
                          '40957','74654','62062','29961','97396',
                          '89318','50190','48100','27177','64294',
                          '31705','40655','85448','34771','99341',
                          '30471','45199','15536','24236','78535',
                          '50381','96806','58803','60490','24569',
                          '89370','19629','95146','24574','23304',
                          '92995','50490','26686','88746','84614',
                          '54991','65931','36849','89113','48847',
                          '58577','66396','71794','29995','60380',
                          '11030','47444','90096','66161','90897',
                          '73972','87931','66907','17631','92077',
                          '61876','87622','44826','76909','92223',
                          '83125','55779','65783','64247','85423',
                          '32776','58035','69632','71223','85487',
                          '64666','29610','80549','13690','23454',
                          '52130','62958','23858','21165','55819',
                          '33063','32250','73863','89012','74831',
                          '11117','40441','63924','73790','41884',
                          '14275','11831','46196','65424','90949',
                          '80808','97243','73237','10664','43310',
                          '24726','37076','20244','14588','12869',
                          '83775','55570','38758','44902','57994',
                          '15666','86109','47004','98446','36811',
                          '22215','20084','41557','23188','26943',
                          '26085','12337','49213','41154','85781',
                          '49986','59994','80342','41437','79207',
                          '74917','71313','45989','39831','24769',
                          '45100','63994','27226','41217','50564',
                          '15677','60106','58754','70225','97908',
                          '73491','42037','44904','52430','59406',
                          '16820','25284','66213','35344','45706',
                          '97044','28418','55948','75859','90630',
                          '28837','82463','23908','42831','20337',
                          '45455','30733','79895','66637','33441',
                          '31795','63571','24715','68560','96206',
                          '85629','41713','97472','45255','60683',
                          '76766','91036','23138','76963','89924',
                          '83436','18480','15182','93032','36449',
                          '75558','95167','91688','33754','27137',
                          '95293','13783','65979','41196','57622',
                          '83663','65990','72958','94571','24411',
                          '98816','44781','75187','41191','71876',
                          '96051','41211','51661','50827','41593',
                          '11954','21570','41472','84282','45437',
                          '87274','37022','41019','98243','62573',
                          '20250','48950','82520','71458','43475',
                          '72104','59613','21676','69057','48025',
                          '93703','59660','95699','21468','71166',
                          '31420','19247','88421','97902','75799',
                          '63870','93942','33315','65473','55479',
                          '15013','50087','10038','32203','44225',
                          '41605','21945','13901','20463','92546',
                          '51212','22191','81352','91544','78201',
                          '65144','45029','90815','50061','81892',
                          '20890','39558','84491','10998','76862',
                          '18235','37097','43933','24567','38106',
                          '49449','59979','77882','54742')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


