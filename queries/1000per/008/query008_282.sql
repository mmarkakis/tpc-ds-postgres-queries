
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '62665','86704','94969','59030','15493','23631',
                          '10200','46777','96876','63892','86778',
                          '66137','53830','94108','47860','54083',
                          '37301','84281','80962','54504','91407',
                          '87994','50909','27716','81840','52338',
                          '32355','48543','44134','46057','72654',
                          '76392','73935','67083','48445','62323',
                          '30787','21237','67192','77490','87187',
                          '87484','23554','59640','53131','70951',
                          '24101','50919','35968','38459','28370',
                          '88603','69314','56835','72018','71612',
                          '85935','73750','96940','73582','74227',
                          '57896','53712','16733','88008','62324',
                          '49262','14531','64577','68875','94420',
                          '65541','45945','33020','70836','64672',
                          '14102','56490','64386','77874','81567',
                          '24546','21760','32474','85347','62482',
                          '64095','29366','99909','28944','68293',
                          '22034','79274','20910','80530','28007',
                          '42658','57687','26003','72669','97226',
                          '74399','92177','92737','49468','14601',
                          '70851','71050','24267','88263','24772',
                          '20163','15440','42081','60986','96376',
                          '50631','55258','99414','36297','40674',
                          '74107','74832','47418','56822','17604',
                          '38800','80115','83802','12829','83256',
                          '65597','13772','12354','33226','15597',
                          '84251','66295','10367','37199','38694',
                          '72055','95201','64961','93443','56248',
                          '41802','47020','79758','97067','51026',
                          '36298','56047','74645','36945','43445',
                          '49117','51365','18188','76305','97292',
                          '45717','73081','38320','21038','72771',
                          '18657','85577','58327','75071','56877',
                          '60979','68908','72582','76537','63978',
                          '46694','87773','97580','59090','34961',
                          '99090','83577','33224','90359','85707',
                          '57470','80496','46662','98549','73353',
                          '79958','57273','90125','32533','97181',
                          '18376','92674','70279','23878','51452',
                          '95653','53655','59435','65698','62629',
                          '41870','79507','25972','49341','23443',
                          '48582','26895','84912','13520','12113',
                          '85733','74271','63847','29199','37595',
                          '73086','26424','86091','49019','63100',
                          '41209','86638','78394','22134','56053',
                          '49084','14499','84010','28085','82919',
                          '67343','26090','97022','94974','97547',
                          '91770','85220','22334','59749','92336',
                          '43750','15679','70139','12242','73067',
                          '24489','19554','35122','79175','14042',
                          '84264','76482','35205','45485','97957',
                          '89442','19854','34869','84442','77526',
                          '23202','69766','87084','96039','84168',
                          '43109','29774','14266','22037','15492',
                          '46179','78445','55819','10403','72436',
                          '72961','47531','86966','32891','72089',
                          '16859','20752','36016','46892','74115',
                          '81039','91414','36336','40303','35029',
                          '62495','79978','43211','79189','79800',
                          '92822','64409','54198','68840','59792',
                          '50458','65500','29458','54070','46450',
                          '51240','81226','94906','54878','29745',
                          '92604','86322','27830','72759','25275',
                          '95505','90351','89208','49505','17319',
                          '72935','65660','47185','93465','42306',
                          '59970','56888','34517','47626','74187',
                          '57081','71135','59775','81777','32159',
                          '82910','90003','87609','72785','21820',
                          '57873','60808','87502','54449','13641',
                          '91615','45615','82515','97464','66921',
                          '97227','22897','56697','37189','89663',
                          '81568','28811','18276','37451','60494',
                          '68369','96405','95813','49815','37266',
                          '46206','79429','68976','64432','81874',
                          '73870','47526','76959','39990','30492',
                          '82972','18309','32565','87700','83319',
                          '39154','52953','92894','29075','22180',
                          '66070','14743','29650','46300','87875',
                          '87592','24613','48277','17552')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


