
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '27135','63778','59722','82962','68961','15147',
                          '86643','70560','98709','10138','19065',
                          '82241','31652','59442','35765','40289',
                          '67234','10136','83402','92445','44736',
                          '51860','60283','85530','69657','92623',
                          '24846','70111','61987','11991','87202',
                          '42360','48756','65796','96860','13408',
                          '89938','83813','43884','84859','69622',
                          '90008','33842','30279','36352','78565',
                          '63159','92597','81848','26100','13374',
                          '79644','22693','73123','49697','58315',
                          '69825','49186','29784','47196','22185',
                          '21183','43840','81670','28584','81103',
                          '22871','21745','66536','94495','20645',
                          '16263','46973','62603','83138','10639',
                          '34371','88120','27493','68846','59548',
                          '36751','27124','45136','68405','83906',
                          '31929','44970','53021','54408','68248',
                          '94718','73149','28845','37720','86571',
                          '99398','78507','80646','12991','85859',
                          '39758','85781','68894','32005','16408',
                          '27825','64795','86468','76704','71252',
                          '50288','69789','58790','28422','66879',
                          '20197','25697','71830','23531','72604',
                          '68881','48214','29628','37092','72954',
                          '72644','36210','78186','35171','19287',
                          '60208','34333','51654','62146','77872',
                          '71049','78903','79563','18103','98828',
                          '65743','74578','62379','30441','24837',
                          '45145','23800','27528','32177','30650',
                          '66920','67812','61470','15394','69315',
                          '99534','48775','73792','94928','35825',
                          '84419','51106','54087','95399','31173',
                          '44724','13843','27741','19586','56448',
                          '56401','65612','23329','19812','87528',
                          '44523','94242','60971','89395','58603',
                          '53787','35040','83273','55086','29651',
                          '33709','29039','80747','37521','53743',
                          '14740','15970','92473','45209','66929',
                          '18069','22484','66808','46861','62909',
                          '56145','36408','86095','55545','53253',
                          '35148','76098','61774','61537','49808',
                          '86241','64792','68292','22166','32719',
                          '32824','83244','84622','64449','33835',
                          '40863','77513','19094','86118','18989',
                          '29995','19413','69414','86670','72701',
                          '82838','27826','10967','96611','35295',
                          '75256','64951','86766','48641','90690',
                          '99782','52316','75585','34840','67665',
                          '42950','43121','67125','80895','64529',
                          '74059','51382','19361','95113','99531',
                          '65575','86595','38018','95217','77782',
                          '61251','34589','30325','73397','68919',
                          '73432','90441','47292','63223','52992',
                          '43075','55697','75630','79252','69356',
                          '29168','88094','12144','59852','11244',
                          '48412','84782','57496','68514','36381',
                          '58204','42871','95747','96952','57845',
                          '81691','42852','37621','47745','27256',
                          '18837','55042','92696','91229','48649',
                          '96987','16804','71116','87420','32770',
                          '65100','51180','41844','85386','66676',
                          '37027','64348','15680','86035','34062',
                          '69786','18870','78787','28415','26127',
                          '70164','76830','51658','33741','24814',
                          '81004','96468','21445','90420','88275',
                          '11636','43345','43200','83019','37295',
                          '35483','45008','34093','64616','20783',
                          '76868','66001','13934','34845','34360',
                          '45416','39677','36304','90778','18558',
                          '51333','33494','34246','52433','96565',
                          '47977','96246','87343','91944','17633',
                          '59871','45468','90680','66388','36632',
                          '83608','90967','81471','77078','42845',
                          '41125','87514','96942','41614','30560',
                          '23370','65276','74423','51444','80008',
                          '43316','85372','34235','88770','99245',
                          '86356','76420','29153','64981','58618',
                          '66638','47075','26465','96263','87644',
                          '67412','82830','43970','32013')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


