
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '48992','11000','56502','91622','88786','14311',
                          '28612','90408','57268','91790','43931',
                          '36333','54423','82181','15784','58830',
                          '78087','37830','21084','37743','78069',
                          '13208','22648','45941','79427','67049',
                          '17648','57262','33945','10534','48752',
                          '64822','21449','74041','16140','33001',
                          '12423','73050','33228','12802','20956',
                          '52845','90088','13019','58237','25500',
                          '90927','47689','52453','16080','32466',
                          '56229','76772','34315','25714','21930',
                          '97150','33858','39857','84581','97456',
                          '43165','78732','92652','64039','88118',
                          '11783','84796','81750','67489','21952',
                          '29387','34743','69262','11462','92780',
                          '35211','92364','71584','68972','48415',
                          '62848','27919','22041','24283','68393',
                          '21109','81031','24989','74851','39708',
                          '51119','69340','44385','83454','44525',
                          '24579','77158','11977','12282','60591',
                          '53789','49118','98179','75425','78033',
                          '40883','28945','14637','83230','13750',
                          '20835','76961','89567','25995','16385',
                          '11901','39829','15261','49847','78267',
                          '53895','92138','50857','89005','25833',
                          '48468','56576','60442','69725','90224',
                          '67978','98120','81575','49650','60796',
                          '26672','70694','40443','40087','88900',
                          '15418','54512','15271','22335','62301',
                          '54869','25245','74083','27232','77682',
                          '81687','45811','24745','34907','14897',
                          '27945','14873','83993','63925','91628',
                          '75975','48726','43620','70247','51529',
                          '49879','26655','15260','99313','75923',
                          '98078','14339','61621','44449','36282',
                          '25674','62555','88705','16005','36696',
                          '20404','22005','19489','92306','27107',
                          '76697','96980','18447','51258','38807',
                          '58296','33895','49821','44902','95507',
                          '26214','11862','80970','49738','77760',
                          '61151','26757','37180','19600','74618',
                          '34964','64720','61343','39181','34057',
                          '22072','72353','91687','66366','21636',
                          '71362','10570','22547','24904','93965',
                          '98698','86711','38404','54387','29560',
                          '20068','44530','32654','47480','15749',
                          '76494','43710','87599','54507','23693',
                          '86427','39035','20109','80048','33779',
                          '72046','61314','27089','68516','91442',
                          '88689','36415','63267','37362','70586',
                          '96223','79821','14241','90234','75276',
                          '12022','80314','28106','27931','15345',
                          '19931','27063','15528','64226','55374',
                          '12401','92596','92876','31716','93079',
                          '86094','50933','65708','80754','58866',
                          '11229','91986','93631','23670','19560',
                          '50598','27721','74927','59843','56906',
                          '20319','53901','94788','89837','13191',
                          '75813','82784','21914','88657','94250',
                          '41148','99741','24561','54497','92353',
                          '26148','64060','74655','46333','31722',
                          '18492','63875','92050','53500','15465',
                          '41037','13041','25379','14793','53692',
                          '28182','96440','48487','53591','78929',
                          '78375','76827','29366','97145','96447',
                          '56625','47072','68378','27373','60243',
                          '29398','56886','25175','97023','72377',
                          '42996','20325','58451','97638','16553',
                          '16589','27480','10429','42860','47085',
                          '84067','23427','34338','77120','82338',
                          '50710','90142','31203','67859','82198',
                          '34270','52276','24681','88985','45425',
                          '96754','97401','26175','54001','64230',
                          '66258','97984','41731','31223','84357',
                          '63153','63356','70178','54167','45610',
                          '99148','33298','21883','35175','16440',
                          '72623','25765','92053','81065','40225',
                          '74953','23224','72844','81384','66441',
                          '17124','48197','87944','82596','44276',
                          '19444','99024','21537','27700')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;


